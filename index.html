<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 10, revision: 2, date: new Date("December 15, 2024"), extensions: {}};

//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2012

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.

" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> YS_Extension - a reusable non-linear personal web notebook </title>
<style id="styleArea" type="text/css">
#saveTest, #messageArea, #copyright, #storeArea, #shadowArea {
	display: none;
}
#javascriptWarning {
	text-align: center;
	padding: 1em;
	font-weight: bold;
	background-color: #dd1100;
	color: #fff;
}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>

</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="GettingStarted">
<pre>When getting started, you may want to:
* Set your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;
* Change the page [[title|SiteTitle]] (now "&lt;&lt;tiddler SiteTitle&gt;&gt;") and [[subtitle|SiteSubtitle]] (now "&lt;&lt;tiddler SiteSubtitle&gt;&gt;"); they also set the browser tab title
* Create a tiddler where your content "starts"
** Use the button on the sidebar or [[link|My first tiddler]] it here, follow the link, edit, and click "done"
** It will be shown in the Timeline (usually on the right), but you may want to link it in the MainMenu (usually on the left)
** and/or make it open when the ~TiddlyWiki is opened by editing the list of [[DefaultTiddlers]] (separate links with spaces or linebreaks)
* Save your ~TiddlyWiki
** Although "download saving" works in any browser, it may be not that convenient, so you'll probably want to use [[a dedicated saver|https://classic.tiddlywiki.com/#%5B%5BSetting up saving%5D%5D]]
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' role='banner'&gt;
  &lt;div class='headerShadow'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
  &lt;div class='headerForeground'&gt;
    &lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
    &lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' role='navigation' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
  &lt;div id='sidebarOptions' role='navigation' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
  &lt;div id='sidebarTabs' role='complementary' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea' role='main'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1, h2, h3, h4, h5, h6 { color: [[ColorPalette::SecondaryDark]]; }
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.txtOptionInput {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {
	background: -moz-linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
	background: linear-gradient(to bottom, [[ColorPalette::PrimaryLight]], [[ColorPalette::PrimaryMid]]);
}
.header a:hover {background:transparent;}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected {
	color:[[ColorPalette::Foreground]];
	background:[[ColorPalette::Background]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard { background:[[ColorPalette::PrimaryPale]]; }
.wizard__title    { color:[[ColorPalette::PrimaryDark]]; border:none; }
.wizard__subtitle { color:[[ColorPalette::Foreground]]; border:none; }
.wizardStep { background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]]; }
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizardFooter .status a { color: [[ColorPalette::PrimaryPale]]; }
.wizard .button {
	color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryDark]];
}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {
	color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];
}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]]; }
.messageToolbar__button { color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none; }
.messageToolbar__button_withIcon { background:inherit; }
.messageToolbar__button_withIcon:active { background:inherit; border:none; }
.tw-icon line { stroke: [[ColorPalette::TertiaryDark]]; }
.messageToolbar__button:hover .tw-icon line { stroke: [[ColorPalette::Foreground]]; }

.popup {
	background: [[ColorPalette::Background]];
	color: [[ColorPalette::TertiaryDark]];
	box-shadow: 1px 2px 5px [[ColorPalette::TertiaryMid]];
}
.popup li a, .popup li a:visited, .popup li a:hover, .popup li a:active {
	color:[[ColorPalette::Foreground]]; border: none;
}
.popup li a:hover { background:[[ColorPalette::SecondaryLight]]; }
.popup li a:active { background:[[ColorPalette::SecondaryPale]]; }
.popup li.disabled { color:[[ColorPalette::TertiaryMid]]; }
.popupHighlight {color:[[ColorPalette::Foreground]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged { background: [[ColorPalette::Background]]; border: 2px solid [[ColorPalette::TertiaryPale]]; }
.selected .tagging, .selected .tagged { border: 2px solid [[ColorPalette::TertiaryLight]]; }
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button { border:none; }

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation { background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.twtable { background: [[ColorPalette::Background]]; }
.viewer th, .viewer thead td, .twtable th, .twtable thead td { background: [[ColorPalette::SecondaryMid]]; color: [[ColorPalette::Background]]; }
.viewer td, .viewer tr, .twtable td, .twtable tr { border: 1px solid [[ColorPalette::TertiaryLight]]; }
.twtable caption { color: [[ColorPalette::TertiaryMid]]; }

.viewer pre {background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:alpha(opacity=60);}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
body { font-size:.75em; font-family:arial,helvetica,sans-serif; margin:0; padding:0; }

* html .tiddler {height:1%;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em; border-width: 1px; }

#contentWrapper .chkOptionInput {border:0;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}


a {text-decoration:none;}

.externalLink {text-decoration:underline;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
#mainMenu .tiddlyLinkNonExisting,
#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}


.header {position:relative;}
.headerShadow {position:relative; padding:3em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:3em 0 1em 1em; left:0; top:0;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}
#sidebarTabs li:not(:last-child) { margin-bottom: 0.3em; }
#sidebarTabs ul:not(:last-child) { margin-bottom: 0.5em; }

.wizard { padding:0.1em 2em 0; }
.wizard__title    { font-size:2em; }
.wizard__subtitle { font-size:1.2em; }
.wizard__title, .wizard__subtitle { font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em; }
.wizardStep { padding:1em; }
.wizardFooter { padding: 0.8em 0; }
.wizardFooter .status { display: inline-block; line-height: 1.5; padding: 0.3em 1em; }
.wizardFooter .button { margin:0.5em 0 0; font-size:1.2em; padding:0.2em 0.5em; }

#messageArea { position:fixed; top:2em; right:0; margin:0.5em; padding:0.7em 1em; z-index:2000; }
.messageToolbar { text-align:right; padding:0.2em 0; }
.messageToolbar__button { text-decoration:underline; }
.messageToolbar__button_withIcon { display: inline-block; }
.tw-icon { height: 1em; width: 1em; } /* width for IE */
.tw-icon line { stroke-width: 1; stroke-linecap: round; }
.messageArea__text:not(:last-child) { margin-bottom: 0.3em; }
.messageArea__text a { text-decoration:underline; }

.popup {position:absolute; z-index:300; font-size:.9em; padding:0.3em 0; list-style:none; margin:0;}
.popup .popupMessage, .popup li.disabled, .popup li a { padding: 0.3em 0.7em; }
.popup li a {display:block; font-weight:normal; cursor:pointer;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {display: inline-block; white-space: nowrap; position: relative; bottom: -0.7px; margin: 0 0.25em 0 0; padding:0.2em;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler { padding: 1em; }

.title { font-size: 1.6em; font-weight: bold; }
.subtitle { font-size: 1.1em; }

.missing .viewer, .missing .title { font-style: italic; }
.missing .subtitle { display: none; }

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagged li, .tagging li { margin: 0.3em 0; }
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation { padding: 0.5em 0.8em; margin: 0.5em 1px; }

.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable { border-collapse: collapse; margin: 0.8em 0; }
.viewer th, .viewer td, .viewer tr, .viewer caption, .twtable th, .twtable td, .twtable tr, .twtable caption { padding: 0.2em 0.4em; }
.twtable caption { font-size: 0.9em; }
table.listView { margin: 0.8em 1.0em; }
table.listView th, table.listView td, table.listView tr { text-align: left; }
.listView &gt; thead { position: sticky; top: 0; }

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer pre {padding:0.5em; overflow:auto;}
pre, code { font-family: monospace, monospace; font-size: 1em; }
.viewer pre, .viewer code { line-height: 1.4em; }

.editor {font-size:1.1em; line-height:1.4em;}
.editor input, .editor textarea { display: block; width: 100%; box-sizing: border-box; font: inherit; padding: 0.1em 0.4em; }
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0; padding-bottom:0;}

.fieldsetFix {border:0; padding:0; margin:1px 0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding: 0.3em 0.5em; display: inline-block;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel { display:none; z-index:100; position:absolute; width:90%; margin:0 5%; }
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
  #mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea { display: none !important; }
  #displayArea { margin: 1em 1em 0em; }
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>

</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="Brython_Example_HelloBrython" creator="YourName" modifier="YourName" created="202507191942" tags="demo RunScriptPlugin" changecount="1">
<pre>from browser import alert
alert(&quot;ok&quot;)</pre>
</div>
<div title="CloudData" creator="YourName" modifier="YourName" created="202507191936" tags="innerTW5Plugin demo d3" changecount="1">
<pre>{&quot;title&quot;:&quot;CloudData&quot;,&quot;type&quot;:&quot;application/json&quot;,&quot;text&quot;:&quot;[\n\t{\&quot;text\&quot;: \&quot;Tokyo/Yokohama\&quot;, \&quot;size\&quot;: 33.200},\n\t{\&quot;text\&quot;: \&quot;New York Metro\&quot;, \&quot;size\&quot;: 17.800},\n\t{\&quot;text\&quot;: \&quot;Sao Paulo\&quot;, \&quot;size\&quot;: 17.700},\n\t{\&quot;text\&quot;: \&quot;Seoul/Incheon\&quot;, \&quot;size\&quot;: 17.500},\n\t{\&quot;text\&quot;: \&quot;Mexico City\&quot;, \&quot;size\&quot;: 17.400},\n\t{\&quot;text\&quot;: \&quot;Osaka/Kobe/Kyoto\&quot;, \&quot;size\&quot;: 16.425},\n\t{\&quot;text\&quot;: \&quot;Manila\&quot;, \&quot;size\&quot;: 14.750},\n\t{\&quot;text\&quot;: \&quot;Mumbai\&quot;, \&quot;size\&quot;: 14.350},\n\t{\&quot;text\&quot;: \&quot;Delhi\&quot;, \&quot;size\&quot;: 14.300},\n\t{\&quot;text\&quot;: \&quot;Jakarta\&quot;, \&quot;size\&quot;: 14.250},\n\t{\&quot;text\&quot;: \&quot;Lagos\&quot;, \&quot;size\&quot;: 13.400},\n\t{\&quot;text\&quot;: \&quot;Kolkata\&quot;, \&quot;size\&quot;: 12.700},\n\t{\&quot;text\&quot;: \&quot;Cairo\&quot;, \&quot;size\&quot;: 12.200},\n\t{\&quot;text\&quot;: \&quot;Los Angeles\&quot;, \&quot;size\&quot;: 11.789},\n\t{\&quot;text\&quot;: \&quot;Buenos Aires\&quot;, \&quot;size\&quot;: 11.200},\n\t{\&quot;text\&quot;: \&quot;Rio de Janeiro\&quot;, \&quot;size\&quot;: 10.800},\n\t{\&quot;text\&quot;: \&quot;Moscow\&quot;, \&quot;size\&quot;: 10.500},\n\t{\&quot;text\&quot;: \&quot;Shanghai\&quot;, \&quot;size\&quot;: 10.000},\n\t{\&quot;text\&quot;: \&quot;Karachi\&quot;, \&quot;size\&quot;: 9.800},\n\t{\&quot;text\&quot;: \&quot;Paris\&quot;, \&quot;size\&quot;: 9.645},\n\t{\&quot;text\&quot;: \&quot;Istanbul\&quot;, \&quot;size\&quot;: 9.000},\n\t{\&quot;text\&quot;: \&quot;Nagoya\&quot;, \&quot;size\&quot;: 9.000},\n\t{\&quot;text\&quot;: \&quot;Beijing\&quot;, \&quot;size\&quot;: 8.614},\n\t{\&quot;text\&quot;: \&quot;Chicago\&quot;, \&quot;size\&quot;: 8.308},\n\t{\&quot;text\&quot;: \&quot;London\&quot;, \&quot;size\&quot;: 8.278},\n\t{\&quot;text\&quot;: \&quot;Shenzhen\&quot;, \&quot;size\&quot;: 8.000},\n\t{\&quot;text\&quot;: \&quot;Essen/Dusseldorf\&quot;, \&quot;size\&quot;: 7.350},\n\t{\&quot;text\&quot;: \&quot;Tehran\&quot;, \&quot;size\&quot;: 7.250},\n\t{\&quot;text\&quot;: \&quot;Bogota\&quot;, \&quot;size\&quot;: 7.000},\n\t{\&quot;text\&quot;: \&quot;Lima\&quot;, \&quot;size\&quot;: 7.000},\n\t{\&quot;text\&quot;: \&quot;Bangkok\&quot;, \&quot;size\&quot;: 6.500},\n\t{\&quot;text\&quot;: \&quot;Johannesburg/East Rand\&quot;, \&quot;size\&quot;: 6.000},\n\t{\&quot;text\&quot;: \&quot;Chennai\&quot;, \&quot;size\&quot;: 5.950},\n\t{\&quot;text\&quot;: \&quot;Taipei\&quot;, \&quot;size\&quot;: 5.700},\n\t{\&quot;text\&quot;: \&quot;Baghdad\&quot;, \&quot;size\&quot;: 5.500},\n\t{\&quot;text\&quot;: \&quot;Santiago\&quot;, \&quot;size\&quot;: 5.425},\n\t{\&quot;text\&quot;: \&quot;Bangalore\&quot;, \&quot;size\&quot;: 5.400},\n\t{\&quot;text\&quot;: \&quot;Hyderabad\&quot;, \&quot;size\&quot;: 5.300},\n\t{\&quot;text\&quot;: \&quot;St Petersburg\&quot;, \&quot;size\&quot;: 5.300}\n]\n&quot;}
</pre>
</div>
<div title="D3" creator="YourName" modifier="YourName" created="202507191937" tags="innerTW5Plugin demo d3" changecount="1">
<pre>{&quot;title&quot;:&quot;$:/plugins/tiddlywiki/d3&quot;,&quot;name&quot;:&quot;D3&quot;,&quot;description&quot;:&quot;D3 data visualisation demo&quot;,&quot;list&quot;:&quot;readme&quot;,&quot;stability&quot;:&quot;STABILITY_0_DEPRECATED&quot;,&quot;version&quot;:&quot;5.3.6&quot;,&quot;plugin-type&quot;:&quot;plugin&quot;,&quot;dependents&quot;:&quot;&quot;,&quot;type&quot;:&quot;application/json&quot;,&quot;text&quot;:&quot;{\&quot;tiddlers\&quot;:{\&quot;$:/plugins/tiddlywiki/d3/barwidget.js\&quot;:{\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/barwidget.js\&quot;,\&quot;text\&quot;:\&quot;/*\\\\\\ntitle: $:/plugins/tiddlywiki/d3/barwidget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nA widget for displaying stacked or grouped bar charts. Derived from http://bl.ocks.org/mbostock/3943967\\n\\n\\\\*/\\n(function(){\\n\\n/*jslint node: true, browser: true */\\n/*global $tw: false */\\n\\\&quot;use strict\\\&quot;;\\n\\nvar Widget = require(\\\&quot;$:/core/modules/widgets/widget.js\\\&quot;).widget,\\n\\td3 = require(\\\&quot;$:/plugins/tiddlywiki/d3/d3.js\\\&quot;).d3;\\n\\nvar BarWidget = function(parseTreeNode,options) {\\n\\tthis.initialise(parseTreeNode,options);\\n};\\n\\n/*\\nInherit from the base widget class\\n*/\\nBarWidget.prototype = new Widget();\\n\\n/*\\nRender this widget into the DOM\\n*/\\nBarWidget.prototype.render = function(parent,nextSibling) {\\n\\t// Save the parent dom node\\n\\tthis.parentDomNode = parent;\\n\\t// Compute our attributes\\n\\tthis.computeAttributes();\\n\\t// Execute our logic\\n\\tthis.execute();\\n\\t// Create the chart\\n\\tvar chart = this.createChart(parent,nextSibling);\\n\\tthis.updateChart = chart.updateChart;\\n\\tif(this.updateChart) {\\n\\t\\tthis.updateChart();\\n\\t}\\n\\t// Insert the chart into the DOM and render any children\\n\\tparent.insertBefore(chart.domNode,nextSibling);\\n\\tthis.domNodes.push(chart.domNode);\\n};\\n\\nBarWidget.prototype.createChart = function(parent,nextSibling) {\\n\\t// Get the data we're plotting\\n\\tvar data = this.wiki.getTiddlerData(this.barData),\\n\\t\\tn,m,stack,layers;\\n\\tif(data) {\\n\\t\\tn = data.layers;\\n\\t\\tm = data.samples;\\n\\t\\tlayers = data.data;\\n\\t} else { // Use randomly generated data if we don't have any\\n\\t\\tn = 4; // number of layers\\n\\t\\tm = 58; // number of samples per layer\\n\\t\\tstack = d3.layout.stack();\\n\\t\\tlayers = stack(d3.range(n).map(function() { return bumpLayer(m, 0.1); }));\\n\\t}\\n\\t// Calculate the maximum data values\\n\\tvar yGroupMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y; }); }),\\n\\t\\tyStackMax = d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); });\\n\\t// Calculate margins and width and height\\n\\tvar margin = {top: 40, right: 10, bottom: 20, left: 10},\\n\\t\\twidth = 960 - margin.left - margin.right,\\n\\t\\theight = 500 - margin.top - margin.bottom;\\n\\t// x-scale\\n\\tvar x = d3.scale.ordinal()\\n\\t\\t.domain(d3.range(m))\\n\\t\\t.rangeRoundBands([0, width], 0.08);\\n\\t// y-scale\\n\\tvar y = d3.scale.linear()\\n\\t\\t.domain([0, yStackMax])\\n\\t\\t.range([height, 0]);\\n\\t// Array of colour values\\n\\tvar color = d3.scale.linear()\\n\\t\\t.domain([0, n - 1])\\n\\t\\t.range([\\\&quot;#aad\\\&quot;, \\\&quot;#556\\\&quot;]);\\n\\t// x-axis\\n\\tvar xAxis = d3.svg.axis()\\n\\t\\t.scale(x)\\n\\t\\t.tickSize(0)\\n\\t\\t.tickPadding(6)\\n\\t\\t.orient(\\\&quot;bottom\\\&quot;);\\n\\t// Create SVG element\\n\\tvar svgElement = d3.select(parent).insert(\\\&quot;svg\\\&quot;,function() {return nextSibling;})\\n\\t\\t.attr(\\\&quot;viewBox\\\&quot;, \\\&quot;0 0 960 500\\\&quot;)\\n\\t\\t.attr(\\\&quot;preserveAspectRatio\\\&quot;, \\\&quot;xMinYMin meet\\\&quot;)\\n\\t\\t.attr(\\\&quot;width\\\&quot;, width + margin.left + margin.right)\\n\\t\\t.attr(\\\&quot;height\\\&quot;, height + margin.top + margin.bottom);\\n\\t// Create main group\\n\\tvar mainGroup = svgElement.append(\\\&quot;g\\\&quot;)\\n\\t\\t.attr(\\\&quot;transform\\\&quot;, \\\&quot;translate(\\\&quot; + margin.left + \\\&quot;,\\\&quot; + margin.top + \\\&quot;)\\\&quot;);\\n\\t// Create the layers\\n\\tvar layer = mainGroup.selectAll(\\\&quot;.layer\\\&quot;)\\n\\t\\t.data(layers)\\n\\t.enter().append(\\\&quot;g\\\&quot;)\\n\\t\\t.attr(\\\&quot;class\\\&quot;, \\\&quot;layer\\\&quot;)\\n\\t\\t.style(\\\&quot;fill\\\&quot;, function(d, i) { return color(i); });\\n\\t// Create the rectangles in each layer\\n\\tvar rect = layer.selectAll(\\\&quot;rect\\\&quot;)\\n\\t\\t.data(function(d) { return d; })\\n\\t.enter().append(\\\&quot;rect\\\&quot;)\\n\\t\\t.attr(\\\&quot;x\\\&quot;, function(d) { return x(d.x); })\\n\\t\\t.attr(\\\&quot;y\\\&quot;, height)\\n\\t\\t.attr(\\\&quot;width\\\&quot;, x.rangeBand())\\n\\t\\t.attr(\\\&quot;height\\\&quot;, 0);\\n\\t// Transition the rectangles to their final height\\n\\trect.transition()\\n\\t\\t.delay(function(d, i) { return i * 10; })\\n\\t\\t.attr(\\\&quot;y\\\&quot;, function(d) { return y(d.y0 + d.y); })\\n\\t\\t.attr(\\\&quot;height\\\&quot;, function(d) { return y(d.y0) - y(d.y0 + d.y); });\\n\\t// Add to the DOM\\n\\tmainGroup.append(\\\&quot;g\\\&quot;)\\n\\t\\t.attr(\\\&quot;class\\\&quot;, \\\&quot;x axis\\\&quot;)\\n\\t\\t.attr(\\\&quot;transform\\\&quot;, \\\&quot;translate(0,\\\&quot; + height + \\\&quot;)\\\&quot;)\\n\\t\\t.call(xAxis);\\n\\tvar self = this;\\n\\t// Return the svg node\\n\\treturn {\\n\\t\\tdomNode: svgElement[0][0],\\n\\t\\tupdateChart: function() {\\n\\t\\t\\tif(self.barGrouped !== \\\&quot;no\\\&quot;) {\\n\\t\\t\\t\\ttransitionGrouped();\\n\\t\\t\\t} else {\\n\\t\\t\\t\\ttransitionStacked();\\n\\t\\t\\t}\\n\\t\\t}\\n\\t};\\n\\n\\tfunction transitionGrouped() {\\n\\t\\ty.domain([0, yGroupMax]);\\n\\t\\trect.transition()\\n\\t\\t\\t.duration(500)\\n\\t\\t\\t.delay(function(d, i) { return i * 10; })\\n\\t\\t\\t.attr(\\\&quot;x\\\&quot;, function(d, i, j) { return x(d.x) + x.rangeBand() / n * j; })\\n\\t\\t\\t.attr(\\\&quot;width\\\&quot;, x.rangeBand() / n)\\n\\t\\t\\t.transition()\\n\\t\\t\\t.attr(\\\&quot;y\\\&quot;, function(d) { return y(d.y); })\\n\\t\\t\\t.attr(\\\&quot;height\\\&quot;, function(d) { return height - y(d.y); });\\n\\t}\\n\\n\\tfunction transitionStacked() {\\n\\t\\ty.domain([0, yStackMax]);\\n\\t\\trect.transition()\\n\\t\\t\\t.duration(500)\\n\\t\\t\\t.delay(function(d, i) { return i * 10; })\\n\\t\\t\\t.attr(\\\&quot;y\\\&quot;, function(d) { return y(d.y0 + d.y); })\\n\\t\\t\\t.attr(\\\&quot;height\\\&quot;, function(d) { return y(d.y0) - y(d.y0 + d.y); })\\n\\t\\t\\t.transition()\\n\\t\\t\\t.attr(\\\&quot;x\\\&quot;, function(d) { return x(d.x); })\\n\\t\\t\\t.attr(\\\&quot;width\\\&quot;, x.rangeBand());\\n\\t}\\n\\n\\t// Inspired by Lee Byron's test data generator.\\n\\tfunction bumpLayer(n, o) {\\n\\t\\tfunction bump(a) {\\n\\t\\t\\tvar x = 1 / (0.1 + Math.random()),\\n\\t\\t\\t\\ty = 2 * Math.random() - 0.5,\\n\\t\\t\\t\\tz = 10 / (0.1 + Math.random());\\n\\t\\t\\tfor(var i = 0; i \u003C n; i++) {\\n\\t\\t\\tvar w = (i / n - y) * z;\\n\\t\\t\\ta[i] += x * Math.exp(-w * w);\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\tvar a = [], i;\\n\\t\\tfor(i = 0; i \u003C n; ++i) a[i] = o + o * Math.random();\\n\\t\\tfor(i = 0; i \u003C 5; ++i) bump(a);\\n\\t\\treturn a.map(function(d, i) { return {x: i, y: Math.max(0, d)}; });\\n\\t}\\n};\\n\\n/*\\nCompute the internal state of the widget\\n*/\\nBarWidget.prototype.execute = function() {\\n\\t// Get the parameters from the attributes\\n\\tthis.barData = this.getAttribute(\\\&quot;data\\\&quot;);\\n\\tthis.barGrouped = this.getAttribute(\\\&quot;grouped\\\&quot;,\\\&quot;no\\\&quot;);\\n};\\n\\n/*\\nSelectively refreshes the widget if needed. Returns true if the widget or any of its children needed re-rendering\\n*/\\nBarWidget.prototype.refresh = function(changedTiddlers) {\\n\\tvar changedAttributes = this.computeAttributes();\\n\\tif(changedAttributes.data || changedTiddlers[this.barData]) {\\n\\t\\tthis.refreshSelf();\\n\\t\\treturn true;\\n\\t} else if(changedAttributes.grouped) {\\n\\t\\tthis.execute();\\n\\t\\tif(this.updateChart) {\\n\\t\\t\\tthis.updateChart();\\n\\t\\t}\\n\\t\\treturn true;\\n\\t}\\n\\treturn false;\\n};\\n\\nexports.d3bar = BarWidget;\\n\\n})();\\n\&quot;,\&quot;type\&quot;:\&quot;application/javascript\&quot;,\&quot;module-type\&quot;:\&quot;widget\&quot;},\&quot;$:/plugins/tiddlywiki/d3/base.tid\&quot;:{\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/base.tid\&quot;,\&quot;tags\&quot;:\&quot;[[$:/tags/Stylesheet]]\&quot;,\&quot;text\&quot;:\&quot;\\\\rules only filteredtranscludeinline transcludeinline macrodef macrocallinline\\n\\n.tc-barwidget {\\n}\\n\\n.tc-barwidget text {\\n  font: 8px sans-serif;\\n}\\n\\n.tc-barwidget .axis path,\\n.tc-barwidget .axis line {\\n  fill: none;\\n  stroke: #000;\\n  shape-rendering: crispEdges;\\n}\\n\&quot;},\&quot;$:/plugins/tiddlywiki/d3/cloudwidget.js\&quot;:{\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/cloudwidget.js\&quot;,\&quot;text\&quot;:\&quot;/*\\\\\\ntitle: $:/plugins/tiddlywiki/d3/cloudwidget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nA widget for displaying word clouds. Derived from https://github.com/jasondavies/d3-cloud\\n\\n\\\\*/\\n(function(){\\n\\n/*jslint node: true, browser: true */\\n/*global $tw: false */\\n\\\&quot;use strict\\\&quot;;\\n\\nvar Widget = require(\\\&quot;$:/core/modules/widgets/widget.js\\\&quot;).widget,\\n\\td3 = require(\\\&quot;$:/plugins/tiddlywiki/d3/d3.js\\\&quot;).d3;\\n\\nif($tw.browser) {\\n\\t// Frightful hack to give the cloud plugin the global d3 variable it needs\\n\\twindow.d3 = d3;\\n\\td3.layout.cloud  = require(\\\&quot;$:/plugins/tiddlywiki/d3/d3.layout.cloud.js\\\&quot;).cloud;\\n}\\n\\nvar CloudWidget = function(parseTreeNode,options) {\\n\\tthis.initialise(parseTreeNode,options);\\n};\\n\\n/*\\nInherit from the base widget class\\n*/\\nCloudWidget.prototype = new Widget();\\n\\n/*\\nRender this widget into the DOM\\n*/\\nCloudWidget.prototype.render = function(parent,nextSibling) {\\n\\t// Save the parent dom node\\n\\tthis.parentDomNode = parent;\\n\\t// Compute our attributes\\n\\tthis.computeAttributes();\\n\\t// Execute our logic\\n\\tthis.execute();\\n\\t// Create the chart\\n\\tvar chart = this.createChart(parent,nextSibling);\\n\\tthis.updateChart = chart.updateChart;\\n\\tif(this.updateChart) {\\n\\t\\tthis.updateChart();\\n\\t}\\n\\t// Insert the chart into the DOM and render any children\\n\\tparent.insertBefore(chart.domNode,nextSibling);\\n\\tthis.domNodes.push(chart.domNode);\\n};\\n\\nCloudWidget.prototype.createChart = function(parent,nextSibling) {\\n\\tvar self = this,\\n\\t\\tfill = d3.scale.category20(),\\n\\t\\tdata = this.wiki.getTiddlerData(this.cloudData);\\n\\t// Use dummy data if none provided\\n\\tif(!data) {\\n\\t\\tdata = \\\&quot;This word cloud does not have any data in it\\\&quot;.split(\\\&quot; \\\&quot;).map(function(d) {\\n\\t\\t\\treturn {text: d, size: 10 + Math.random() * 90};\\n\\t\\t});\\n\\t}\\n\\t// Create the svg element\\n\\tvar svgElement = d3.select(parent).insert(\\\&quot;svg\\\&quot;,function() {return nextSibling;})\\n\\t\\t.attr(\\\&quot;width\\\&quot;, 600)\\n\\t\\t.attr(\\\&quot;height\\\&quot;, 400);\\n\\t// Create the main group\\n\\tvar mainGroup = svgElement\\n\\t\\t.append(\\\&quot;g\\\&quot;)\\n\\t\\t.attr(\\\&quot;transform\\\&quot;, \\\&quot;translate(300,200)\\\&quot;);\\n\\t// Create the layout\\n\\tvar layout = d3.layout.cloud().size([600, 400])\\n\\t\\t.words(data)\\n\\t\\t.padding(5)\\n\\t\\t.rotate(function() { return ~~(Math.random() * 5) * 30 - 60; })\\n\\t\\t.font(\\\&quot;Impact\\\&quot;)\\n\\t\\t.fontSize(function(d) { return d.size*2; })\\n\\t\\t.on(\\\&quot;end\\\&quot;, draw)\\n\\t\\t.start();\\n\\t// Function to draw all the words\\n\\tfunction draw(words) {\\n\\t\\tmainGroup.selectAll(\\\&quot;text\\\&quot;)\\n\\t\\t\\t.data(words)\\n\\t\\t\\t.enter().append(\\\&quot;text\\\&quot;)\\n\\t\\t\\t.style(\\\&quot;font-size\\\&quot;, function(d) { return d.size + \\\&quot;px\\\&quot;; })\\n\\t\\t\\t.style(\\\&quot;font-family\\\&quot;, \\\&quot;Impact\\\&quot;)\\n\\t\\t\\t.style(\\\&quot;fill\\\&quot;, function(d, i) { return fill(i); })\\n\\t\\t\\t.attr(\\\&quot;text-anchor\\\&quot;, \\\&quot;middle\\\&quot;)\\n\\t\\t\\t.attr(\\\&quot;transform\\\&quot;, function(d) {\\n\\t\\t\\t\\treturn \\\&quot;translate(\\\&quot; + [d.x, d.y] + \\\&quot;)rotate(\\\&quot; + d.rotate + \\\&quot;)\\\&quot;;\\n\\t\\t\\t})\\n\\t\\t\\t.text(function(d) { return d.text; });\\n\\t}\\n\\tfunction updateChart() {\\n\\t\\tlayout.spiral(self.spiral);\\n\\t}\\n\\treturn {\\n\\t\\tdomNode: svgElement[0][0],\\n\\t\\tupdateChart: updateChart\\n\\t};\\n};\\n\\n/*\\nCompute the internal state of the widget\\n*/\\nCloudWidget.prototype.execute = function() {\\n\\t// Get the parameters from the attributes\\n\\tthis.cloudData = this.getAttribute(\\\&quot;data\\\&quot;);\\n\\tthis.cloudSpiral = this.getAttribute(\\\&quot;spiral\\\&quot;,\\\&quot;archimedean\\\&quot;);\\n};\\n\\n/*\\nSelectively refreshes the widget if needed. Returns true if the widget or any of its children needed re-rendering\\n*/\\nCloudWidget.prototype.refresh = function(changedTiddlers) {\\n\\tvar changedAttributes = this.computeAttributes();\\n\\tif(changedAttributes.data || changedTiddlers[this.cloudData]) {\\n\\t\\tthis.refreshSelf();\\n\\t\\treturn true;\\n\\t} else if(changedAttributes.spiral) {\\n\\t\\tthis.execute();\\n\\t\\tif(this.updateChart) {\\n\\t\\t\\tthis.updateChart();\\n\\t\\t}\\n\\t\\treturn true;\\n\\t}\\n\\treturn false;\\n};\\n\\nexports.d3cloud = CloudWidget;\\n\\n})();\\n\&quot;,\&quot;type\&quot;:\&quot;application/javascript\&quot;,\&quot;module-type\&quot;:\&quot;widget\&quot;},\&quot;$:/plugins/tiddlywiki/d3/d3.js\&quot;:{\&quot;text\&quot;:\&quot;var d3;if($tw.browser){\\nd3=function(){function n(n){return null!=n&amp;&amp;!isNaN(n)}function t(n){return n.length}function e(n){for(var t=1;n*t%1;)t*=10;return t}function r(n,t){try{for(var e in t)Object.defineProperty(n.prototype,e,{value:t[e],enumerable:!1})}catch(r){n.prototype=t}}function i(){}function u(){}function a(n,t,e){return function(){var r=e.apply(t,arguments);return r===t?n:r}}function o(n,t){if(t in n)return t;t=t.charAt(0).toUpperCase()+t.substring(1);for(var e=0,r=Na.length;r&gt;e;++e){var i=Na[e]+t;if(i in n)return i}}function c(n){for(var t=-1,e=n.length,r=[];++t\u003Ce;)r.push(n[t]);return r}function l(n){return Array.prototype.slice.call(n)}function s(){}function f(){}function h(n){function t(){for(var t,r=e,i=-1,u=r.length;++i\u003Cu;)(t=r[i].on)&amp;&amp;t.apply(this,arguments);return n}var e=[],r=new i;return t.on=function(t,i){var u,a=r.get(t);return arguments.length\u003C2?a&amp;&amp;a.on:(a&amp;&amp;(a.on=null,e=e.slice(0,u=e.indexOf(a)).concat(e.slice(u+1)),r.remove(t)),i&amp;&amp;e.push(r.set(t,{on:i})),n)},t}function g(){da.event.preventDefault()}function p(){for(var n,t=da.event;n=t.sourceEvent;)t=n;return t}function d(n){for(var t=new f,e=0,r=arguments.length;++e\u003Cr;)t[arguments[e]]=h(t);return t.of=function(e,r){return function(i){try{var u=i.sourceEvent=da.event;i.target=n,da.event=i,t[i.type].apply(e,r)}finally{da.event=u}}},t}function m(n){return za(n,Fa),n}function v(n){return\\\&quot;function\\\&quot;==typeof n?n:function(){return Da(n,this)}}function y(n){return\\\&quot;function\\\&quot;==typeof n?n:function(){return ja(n,this)}}function M(n,t){function e(){this.removeAttribute(n)}function r(){this.removeAttributeNS(n.space,n.local)}function i(){this.setAttribute(n,t)}function u(){this.setAttributeNS(n.space,n.local,t)}function a(){var e=t.apply(this,arguments);null==e?this.removeAttribute(n):this.setAttribute(n,e)}function o(){var e=t.apply(this,arguments);null==e?this.removeAttributeNS(n.space,n.local):this.setAttributeNS(n.space,n.local,e)}return n=da.ns.qualify(n),null==t?n.local?r:e:\\\&quot;function\\\&quot;==typeof t?n.local?o:a:n.local?u:i}function x(n){return n.trim().replace(/\\\\s+/g,\\\&quot; \\\&quot;)}function b(n){return new RegExp(\\\&quot;(?:^|\\\\\\\\s+)\\\&quot;+da.requote(n)+\\\&quot;(?:\\\\\\\\s+|$)\\\&quot;,\\\&quot;g\\\&quot;)}function _(n,t){function e(){for(var e=-1;++e\u003Ci;)n[e](this,t)}function r(){for(var e=-1,r=t.apply(this,arguments);++e\u003Ci;)n[e](this,r)}n=n.trim().split(/\\\\s+/).map(w);var i=n.length;return\\\&quot;function\\\&quot;==typeof t?r:e}function w(n){var t=b(n);return function(e,r){if(i=e.classList)return r?i.add(n):i.remove(n);var i=e.getAttribute(\\\&quot;class\\\&quot;)||\\\&quot;\\\&quot;;r?(t.lastIndex=0,t.test(i)||e.setAttribute(\\\&quot;class\\\&quot;,x(i+\\\&quot; \\\&quot;+n))):e.setAttribute(\\\&quot;class\\\&quot;,x(i.replace(t,\\\&quot; \\\&quot;)))}}function S(n,t,e){function r(){this.style.removeProperty(n)}function i(){this.style.setProperty(n,t,e)}function u(){var r=t.apply(this,arguments);null==r?this.style.removeProperty(n):this.style.setProperty(n,r,e)}return null==t?r:\\\&quot;function\\\&quot;==typeof t?u:i}function E(n,t){function e(){delete this[n]}function r(){this[n]=t}function i(){var e=t.apply(this,arguments);null==e?delete this[n]:this[n]=e}return null==t?e:\\\&quot;function\\\&quot;==typeof t?i:r}function k(n){return\\\&quot;function\\\&quot;==typeof n?n:(n=da.ns.qualify(n)).local?function(){return ma.createElementNS(n.space,n.local)}:function(){return ma.createElementNS(this.namespaceURI,n)}}function A(n){return{__data__:n}}function N(n){return function(){return Ha(this,n)}}function q(n){return arguments.length||(n=da.ascending),function(t,e){return!t-!e||n(t.__data__,e.__data__)}}function T(n,t){for(var e=0,r=n.length;r&gt;e;e++)for(var i,u=n[e],a=0,o=u.length;o&gt;a;a++)(i=u[a])&amp;&amp;t(i,a,e);return n}function C(n){return za(n,Oa),n}function z(n){var t,e;return function(r,i,u){var a,o=n[u].update,c=o.length;for(u!=e&amp;&amp;(e=u,t=0),i&gt;=t&amp;&amp;(t=i+1);!(a=o[t])&amp;&amp;++t\u003Cc;);return a}}function D(n,t,e){function r(){var t=this[a];t&amp;&amp;(this.removeEventListener(n,t,t.$),delete this[a])}function i(){var i=c(t,qa(arguments));r.call(this),this.addEventListener(n,this[a]=i,i.$=e),i._=t}function u(){var t,e=new RegExp(\\\&quot;^__on([^.]+)\\\&quot;+da.requote(n)+\\\&quot;$\\\&quot;);for(var r in this)if(t=r.match(e)){var i=this[r];this.removeEventListener(t[1],i,i.$),delete this[r]}}var a=\\\&quot;__on\\\&quot;+n,o=n.indexOf(\\\&quot;.\\\&quot;),c=j;o&gt;0&amp;&amp;(n=n.substring(0,o));var l=Ra.get(n);return l&amp;&amp;(n=l,c=L),o?t?i:r:t?s:u}function j(n,t){return function(e){var r=da.event;da.event=e,t[0]=this.__data__;try{n.apply(this,t)}finally{da.event=r}}}function L(n,t){var e=j(n,t);return function(n){var t=this,r=n.relatedTarget;r&amp;&amp;(r===t||8&amp;r.compareDocumentPosition(t))||e.call(t,n)}}function H(){var n=\\\&quot;.dragsuppress-\\\&quot;+ ++Ia,t=\\\&quot;touchmove\\\&quot;+n,e=\\\&quot;selectstart\\\&quot;+n,r=\\\&quot;dragstart\\\&quot;+n,i=\\\&quot;click\\\&quot;+n,u=da.select(ya).on(t,g).on(e,g).on(r,g),a=va.style,o=a[Ua];return a[Ua]=\\\&quot;none\\\&quot;,function(t){function e(){u.on(i,null)}u.on(n,null),a[Ua]=o,t&amp;&amp;(u.on(i,function(){g(),e()},!0),setTimeout(e,0))}}function F(n,t){var e=n.ownerSVGElement||n;if(e.createSVGPoint){var r=e.createSVGPoint();if(0&gt;Va&amp;&amp;(ya.scrollX||ya.scrollY)){e=da.select(\\\&quot;body\\\&quot;).append(\\\&quot;svg\\\&quot;).style({position:\\\&quot;absolute\\\&quot;,top:0,left:0,margin:0,padding:0,border:\\\&quot;none\\\&quot;},\\\&quot;important\\\&quot;);var i=e[0][0].getScreenCTM();Va=!(i.f||i.e),e.remove()}return Va?(r.x=t.pageX,r.y=t.pageY):(r.x=t.clientX,r.y=t.clientY),r=r.matrixTransform(n.getScreenCTM().inverse()),[r.x,r.y]}var u=n.getBoundingClientRect();return[t.clientX-u.left-n.clientLeft,t.clientY-u.top-n.clientTop]}function P(){}function O(n,t,e){return new Y(n,t,e)}function Y(n,t,e){this.h=n,this.s=t,this.l=e}function R(n,t,e){function r(n){return n&gt;360?n-=360:0&gt;n&amp;&amp;(n+=360),60&gt;n?u+(a-u)*n/60:180&gt;n?a:240&gt;n?u+(a-u)*(240-n)/60:u}function i(n){return Math.round(255*r(n))}var u,a;return n=isNaN(n)?0:(n%=360)\u003C0?n+360:n,t=isNaN(t)?0:0&gt;t?0:t&gt;1?1:t,e=0&gt;e?0:e&gt;1?1:e,a=.5&gt;=e?e*(1+t):e+t-e*t,u=2*e-a,it(i(n+120),i(n),i(n-120))}function U(n){return n&gt;0?1:0&gt;n?-1:0}function I(n){return n&gt;1?0:-1&gt;n?Wa:Math.acos(n)}function V(n){return n&gt;1?Wa/2:-1&gt;n?-Wa/2:Math.asin(n)}function X(n){return(Math.exp(n)-Math.exp(-n))/2}function Z(n){return(Math.exp(n)+Math.exp(-n))/2}function B(n){return(n=Math.sin(n/2))*n}function $(n,t,e){return new W(n,t,e)}function W(n,t,e){this.h=n,this.c=t,this.l=e}function J(n,t,e){return isNaN(n)&amp;&amp;(n=0),isNaN(t)&amp;&amp;(t=0),G(e,Math.cos(n*=Ka)*t,Math.sin(n)*t)}function G(n,t,e){return new K(n,t,e)}function K(n,t,e){this.l=n,this.a=t,this.b=e}function Q(n,t,e){var r=(n+16)/116,i=r+t/500,u=r-e/200;return i=tt(i)*eo,r=tt(r)*ro,u=tt(u)*io,it(rt(3.2404542*i-1.5371385*r-.4985314*u),rt(-.969266*i+1.8760108*r+.041556*u),rt(.0556434*i-.2040259*r+1.0572252*u))}function nt(n,t,e){return n&gt;0?$(Math.atan2(e,t)*Qa,Math.sqrt(t*t+e*e),n):$(0/0,0/0,n)}function tt(n){return n&gt;.206893034?n*n*n:(n-4/29)/7.787037}function et(n){return n&gt;.008856?Math.pow(n,1/3):7.787037*n+4/29}function rt(n){return Math.round(255*(.00304&gt;=n?12.92*n:1.055*Math.pow(n,1/2.4)-.055))}function it(n,t,e){return new ut(n,t,e)}function ut(n,t,e){this.r=n,this.g=t,this.b=e}function at(n){return 16&gt;n?\\\&quot;0\\\&quot;+Math.max(0,n).toString(16):Math.min(255,n).toString(16)}function ot(n,t,e){var r,i,u,a=0,o=0,c=0;if(r=/([a-z]+)\\\\((.*)\\\\)/i.exec(n))switch(i=r[2].split(\\\&quot;,\\\&quot;),r[1]){case\\\&quot;hsl\\\&quot;:return e(parseFloat(i[0]),parseFloat(i[1])/100,parseFloat(i[2])/100);case\\\&quot;rgb\\\&quot;:return t(ft(i[0]),ft(i[1]),ft(i[2]))}return(u=oo.get(n))?t(u.r,u.g,u.b):(null!=n&amp;&amp;\\\&quot;#\\\&quot;===n.charAt(0)&amp;&amp;(4===n.length?(a=n.charAt(1),a+=a,o=n.charAt(2),o+=o,c=n.charAt(3),c+=c):7===n.length&amp;&amp;(a=n.substring(1,3),o=n.substring(3,5),c=n.substring(5,7)),a=parseInt(a,16),o=parseInt(o,16),c=parseInt(c,16)),t(a,o,c))}function ct(n,t,e){var r,i,u=Math.min(n/=255,t/=255,e/=255),a=Math.max(n,t,e),o=a-u,c=(a+u)/2;return o?(i=.5&gt;c?o/(a+u):o/(2-a-u),r=n==a?(t-e)/o+(e&gt;t?6:0):t==a?(e-n)/o+2:(n-t)/o+4,r*=60):(r=0/0,i=c&gt;0&amp;&amp;1&gt;c?0:r),O(r,i,c)}function lt(n,t,e){n=st(n),t=st(t),e=st(e);var r=et((.4124564*n+.3575761*t+.1804375*e)/eo),i=et((.2126729*n+.7151522*t+.072175*e)/ro),u=et((.0193339*n+.119192*t+.9503041*e)/io);return G(116*i-16,500*(r-i),200*(i-u))}function st(n){return(n/=255)\u003C=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function ft(n){var t=parseFloat(n);return\\\&quot;%\\\&quot;===n.charAt(n.length-1)?Math.round(2.55*t):t}function ht(n){return\\\&quot;function\\\&quot;==typeof n?n:function(){return n}}function gt(n){return n}function pt(n){return function(t,e,r){return 2===arguments.length&amp;&amp;\\\&quot;function\\\&quot;==typeof e&amp;&amp;(r=e,e=null),dt(t,e,n,r)}}function dt(n,t,e,r){function i(){var n,t=c.status;if(!t&amp;&amp;c.responseText||t&gt;=200&amp;&amp;300&gt;t||304===t){try{n=e.call(u,c)}catch(r){return a.error.call(u,r),void 0}a.load.call(u,n)}else a.error.call(u,c)}var u={},a=da.dispatch(\\\&quot;progress\\\&quot;,\\\&quot;load\\\&quot;,\\\&quot;error\\\&quot;),o={},c=new XMLHttpRequest,l=null;return!ya.XDomainRequest||\\\&quot;withCredentials\\\&quot;in c||!/^(http(s)?:)?\\\\/\\\\//.test(n)||(c=new XDomainRequest),\\\&quot;onload\\\&quot;in c?c.onload=c.onerror=i:c.onreadystatechange=function(){c.readyState&gt;3&amp;&amp;i()},c.onprogress=function(n){var t=da.event;da.event=n;try{a.progress.call(u,c)}finally{da.event=t}},u.header=function(n,t){return n=(n+\\\&quot;\\\&quot;).toLowerCase(),arguments.length\u003C2?o[n]:(null==t?delete o[n]:o[n]=t+\\\&quot;\\\&quot;,u)},u.mimeType=function(n){return arguments.length?(t=null==n?null:n+\\\&quot;\\\&quot;,u):t},u.responseType=function(n){return arguments.length?(l=n,u):l},u.response=function(n){return e=n,u},[\\\&quot;get\\\&quot;,\\\&quot;post\\\&quot;].forEach(function(n){u[n]=function(){return u.send.apply(u,[n].concat(qa(arguments)))}}),u.send=function(e,r,i){if(2===arguments.length&amp;&amp;\\\&quot;function\\\&quot;==typeof r&amp;&amp;(i=r,r=null),c.open(e,n,!0),null==t||\\\&quot;accept\\\&quot;in o||(o.accept=t+\\\&quot;,*/*\\\&quot;),c.setRequestHeader)for(var a in o)c.setRequestHeader(a,o[a]);return null!=t&amp;&amp;c.overrideMimeType&amp;&amp;c.overrideMimeType(t),null!=l&amp;&amp;(c.responseType=l),null!=i&amp;&amp;u.on(\\\&quot;error\\\&quot;,i).on(\\\&quot;load\\\&quot;,function(n){i(null,n)}),c.send(null==r?null:r),u},u.abort=function(){return c.abort(),u},da.rebind(u,a,\\\&quot;on\\\&quot;),null==r?u:u.get(mt(r))}function mt(n){return 1===n.length?function(t,e){n(null==t?e:null)}:n}function vt(){var n=yt(),t=Mt()-n;t&gt;24?(isFinite(t)&amp;&amp;(clearTimeout(fo),fo=setTimeout(vt,t)),so=0):(so=1,ho(vt))}function yt(){for(var n=Date.now(),t=co;t;)n&gt;=t.time&amp;&amp;(t.flush=t.callback(n-t.time)),t=t.next;return n}function Mt(){for(var n,t=co,e=1/0;t;)t.flush?t=n?n.next=t.next:co=t.next:(t.time\u003Ce&amp;&amp;(e=t.time),t=(n=t).next);return lo=n,e}function xt(n,t){var e=Math.pow(10,3*Math.abs(8-t));return{scale:t&gt;8?function(n){return n/e}:function(n){return n*e},symbol:n}}function bt(n,t){return t-(n?Math.ceil(Math.log(n)/Math.LN10):1)}function _t(n){return n+\\\&quot;\\\&quot;}function wt(){}function St(n,t,e){var r=e.s=n+t,i=r-n,u=r-i;e.t=n-u+(t-i)}function Et(n,t){n&amp;&amp;Eo.hasOwnProperty(n.type)&amp;&amp;Eo[n.type](n,t)}function kt(n,t,e){var r,i=-1,u=n.length-e;for(t.lineStart();++i\u003Cu;)r=n[i],t.point(r[0],r[1]);t.lineEnd()}function At(n,t){var e=-1,r=n.length;for(t.polygonStart();++e\u003Cr;)kt(n[e],t,1);t.polygonEnd()}function Nt(){function n(n,t){n*=Ka,t=t*Ka/2+Wa/4;var e=n-r,a=Math.cos(t),o=Math.sin(t),c=u*o,l=i*a+c*Math.cos(e),s=c*Math.sin(e);Ao.add(Math.atan2(s,l)),r=n,i=a,u=o}var t,e,r,i,u;No.point=function(a,o){No.point=n,r=(t=a)*Ka,i=Math.cos(o=(e=o)*Ka/2+Wa/4),u=Math.sin(o)},No.lineEnd=function(){n(t,e)}}function qt(n){var t=n[0],e=n[1],r=Math.cos(e);return[r*Math.cos(t),r*Math.sin(t),Math.sin(e)]}function Tt(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function Ct(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}function zt(n,t){n[0]+=t[0],n[1]+=t[1],n[2]+=t[2]}function Dt(n,t){return[n[0]*t,n[1]*t,n[2]*t]}function jt(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=t,n[1]/=t,n[2]/=t}function Lt(n){return[Math.atan2(n[1],n[0]),V(n[2])]}function Ht(n,t){return Math.abs(n[0]-t[0])\u003CJa&amp;&amp;Math.abs(n[1]-t[1])\u003CJa}function Ft(n,t){n*=Ka;var e=Math.cos(t*=Ka);Pt(e*Math.cos(n),e*Math.sin(n),Math.sin(t))}function Pt(n,t,e){++qo,Co+=(n-Co)/qo,zo+=(t-zo)/qo,Do+=(e-Do)/qo}function Ot(){function n(n,i){n*=Ka;var u=Math.cos(i*=Ka),a=u*Math.cos(n),o=u*Math.sin(n),c=Math.sin(i),l=Math.atan2(Math.sqrt((l=e*c-r*o)*l+(l=r*a-t*c)*l+(l=t*o-e*a)*l),t*a+e*o+r*c);To+=l,jo+=l*(t+(t=a)),Lo+=l*(e+(e=o)),Ho+=l*(r+(r=c)),Pt(t,e,r)}var t,e,r;Yo.point=function(i,u){i*=Ka;var a=Math.cos(u*=Ka);t=a*Math.cos(i),e=a*Math.sin(i),r=Math.sin(u),Yo.point=n,Pt(t,e,r)}}function Yt(){Yo.point=Ft}function Rt(){function n(n,t){n*=Ka;var e=Math.cos(t*=Ka),a=e*Math.cos(n),o=e*Math.sin(n),c=Math.sin(t),l=i*c-u*o,s=u*a-r*c,f=r*o-i*a,h=Math.sqrt(l*l+s*s+f*f),g=r*a+i*o+u*c,p=h&amp;&amp;-I(g)/h,d=Math.atan2(h,g);Fo+=p*l,Po+=p*s,Oo+=p*f,To+=d,jo+=d*(r+(r=a)),Lo+=d*(i+(i=o)),Ho+=d*(u+(u=c)),Pt(r,i,u)}var t,e,r,i,u;Yo.point=function(a,o){t=a,e=o,Yo.point=n,a*=Ka;var c=Math.cos(o*=Ka);r=c*Math.cos(a),i=c*Math.sin(a),u=Math.sin(o),Pt(r,i,u)},Yo.lineEnd=function(){n(t,e),Yo.lineEnd=Yt,Yo.point=Ft}}function Ut(){return!0}function It(n,t,e,r,i){var u=[],a=[];if(n.forEach(function(n){if(!((t=n.length-1)\u003C=0)){var t,e=n[0],r=n[t];if(Ht(e,r)){i.lineStart();for(var o=0;t&gt;o;++o)i.point((e=n[o])[0],e[1]);return i.lineEnd(),void 0}var c={point:e,points:n,other:null,visited:!1,entry:!0,subject:!0},l={point:e,points:[e],other:c,visited:!1,entry:!1,subject:!1};c.other=l,u.push(c),a.push(l),c={point:r,points:[r],other:null,visited:!1,entry:!1,subject:!0},l={point:r,points:[r],other:c,visited:!1,entry:!0,subject:!1},c.other=l,u.push(c),a.push(l)}}),a.sort(t),Vt(u),Vt(a),u.length){if(e)for(var o=1,c=!e(a[0].point),l=a.length;l&gt;o;++o)a[o].entry=c=!c;for(var s,f,h,g=u[0];;){for(s=g;s.visited;)if((s=s.next)===g)return;f=s.points,i.lineStart();do{if(s.visited=s.other.visited=!0,s.entry){if(s.subject)for(var o=0;o\u003Cf.length;o++)i.point((h=f[o])[0],h[1]);else r(s.point,s.next.point,1,i);s=s.next}else{if(s.subject){f=s.prev.points;for(var o=f.length;--o&gt;=0;)i.point((h=f[o])[0],h[1])}else r(s.point,s.prev.point,-1,i);s=s.prev}s=s.other,f=s.points}while(!s.visited);i.lineEnd()}}}function Vt(n){if(t=n.length){for(var t,e,r=0,i=n[0];++r\u003Ct;)i.next=e=n[r],e.prev=i,i=e;i.next=e=n[0],e.prev=i}}function Xt(n,t,e,r){return function(i){function u(t,e){n(t,e)&amp;&amp;i.point(t,e)}function a(n,t){d.point(n,t)}function o(){m.point=a,d.lineStart()}function c(){m.point=u,d.lineEnd()}function l(n,t){y.point(n,t),p.push([n,t])}function s(){y.lineStart(),p=[]}function f(){l(p[0][0],p[0][1]),y.lineEnd();var n,t=y.clean(),e=v.buffer(),r=e.length;if(p.pop(),g.push(p),p=null,r){if(1&amp;t){n=e[0];var u,r=n.length-1,a=-1;for(i.lineStart();++a\u003Cr;)i.point((u=n[a])[0],u[1]);return i.lineEnd(),void 0}r&gt;1&amp;&amp;2&amp;t&amp;&amp;e.push(e.pop().concat(e.shift())),h.push(e.filter(Zt))}}var h,g,p,d=t(i),m={point:u,lineStart:o,lineEnd:c,polygonStart:function(){m.point=l,m.lineStart=s,m.lineEnd=f,h=[],g=[],i.polygonStart()},polygonEnd:function(){m.point=u,m.lineStart=o,m.lineEnd=c,h=da.merge(h),h.length?It(h,$t,null,e,i):r(g)&amp;&amp;(i.lineStart(),e(null,null,1,i),i.lineEnd()),i.polygonEnd(),h=g=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}},v=Bt(),y=t(v);return m}}function Zt(n){return n.length&gt;1}function Bt(){var n,t=[];return{lineStart:function(){t.push(n=[])},point:function(t,e){n.push([t,e])},lineEnd:s,buffer:function(){var e=t;return t=[],n=null,e},rejoin:function(){t.length&gt;1&amp;&amp;t.push(t.pop().concat(t.shift()))}}}function $t(n,t){return((n=n.point)[0]\u003C0?n[1]-Wa/2-Ja:Wa/2-n[1])-((t=t.point)[0]\u003C0?t[1]-Wa/2-Ja:Wa/2-t[1])}function Wt(n,t){var e=n[0],r=n[1],i=[Math.sin(e),-Math.cos(e),0],u=0,a=!1,o=!1,c=0;Ao.reset();for(var l=0,s=t.length;s&gt;l;++l){var f=t[l],h=f.length;if(h){for(var g=f[0],p=g[0],d=g[1]/2+Wa/4,m=Math.sin(d),v=Math.cos(d),y=1;;){y===h&amp;&amp;(y=0),n=f[y];var M=n[0],x=n[1]/2+Wa/4,b=Math.sin(x),_=Math.cos(x),w=M-p,S=Math.abs(w)&gt;Wa,E=m*b;if(Ao.add(Math.atan2(E*Math.sin(w),v*_+E*Math.cos(w))),Math.abs(x)\u003CJa&amp;&amp;(o=!0),u+=S?w+(w&gt;=0?2:-2)*Wa:w,S^p&gt;=e^M&gt;=e){var k=Ct(qt(g),qt(n));jt(k);var A=Ct(i,k);jt(A);var N=(S^w&gt;=0?-1:1)*V(A[2]);r&gt;N&amp;&amp;(c+=S^w&gt;=0?1:-1)}if(!y++)break;p=M,m=b,v=_,g=n}Math.abs(u)&gt;Ja&amp;&amp;(a=!0)}}return(!o&amp;&amp;!a&amp;&amp;0&gt;Ao||-Ja&gt;u)^1&amp;c}function Jt(n){var t,e=0/0,r=0/0,i=0/0;return{lineStart:function(){n.lineStart(),t=1},point:function(u,a){var o=u&gt;0?Wa:-Wa,c=Math.abs(u-e);Math.abs(c-Wa)\u003CJa?(n.point(e,r=(r+a)/2&gt;0?Wa/2:-Wa/2),n.point(i,r),n.lineEnd(),n.lineStart(),n.point(o,r),n.point(u,r),t=0):i!==o&amp;&amp;c&gt;=Wa&amp;&amp;(Math.abs(e-i)\u003CJa&amp;&amp;(e-=i*Ja),Math.abs(u-o)\u003CJa&amp;&amp;(u-=o*Ja),r=Gt(e,r,u,a),n.point(i,r),n.lineEnd(),n.lineStart(),n.point(o,r),t=0),n.point(e=u,r=a),i=o},lineEnd:function(){n.lineEnd(),e=r=0/0},clean:function(){return 2-t}}}function Gt(n,t,e,r){var i,u,a=Math.sin(n-e);return Math.abs(a)&gt;Ja?Math.atan((Math.sin(t)*(u=Math.cos(r))*Math.sin(e)-Math.sin(r)*(i=Math.cos(t))*Math.sin(n))/(i*u*a)):(t+r)/2}function Kt(n,t,e,r){var i;if(null==n)i=e*Wa/2,r.point(-Wa,i),r.point(0,i),r.point(Wa,i),r.point(Wa,0),r.point(Wa,-i),r.point(0,-i),r.point(-Wa,-i),r.point(-Wa,0),r.point(-Wa,i);else if(Math.abs(n[0]-t[0])&gt;Ja){var u=(n[0]\u003Ct[0]?1:-1)*Wa;i=e*u/2,r.point(-u,i),r.point(0,i),r.point(u,i)}else r.point(t[0],t[1])}function Qt(n){return Wt(Uo,n)}function ne(n){function t(n,t){return Math.cos(n)*Math.cos(t)&gt;a}function e(n){var e,u,a,c,s;return{lineStart:function(){c=a=!1,s=1},point:function(f,h){var g,p=[f,h],d=t(f,h),m=o?d?0:i(f,h):d?i(f+(0&gt;f?Wa:-Wa),h):0;if(!e&amp;&amp;(c=a=d)&amp;&amp;n.lineStart(),d!==a&amp;&amp;(g=r(e,p),(Ht(e,g)||Ht(p,g))&amp;&amp;(p[0]+=Ja,p[1]+=Ja,d=t(p[0],p[1]))),d!==a)s=0,d?(n.lineStart(),g=r(p,e),n.point(g[0],g[1])):(g=r(e,p),n.point(g[0],g[1]),n.lineEnd()),e=g;else if(l&amp;&amp;e&amp;&amp;o^d){var v;m&amp;u||!(v=r(p,e,!0))||(s=0,o?(n.lineStart(),n.point(v[0][0],v[0][1]),n.point(v[1][0],v[1][1]),n.lineEnd()):(n.point(v[1][0],v[1][1]),n.lineEnd(),n.lineStart(),n.point(v[0][0],v[0][1])))}!d||e&amp;&amp;Ht(e,p)||n.point(p[0],p[1]),e=p,a=d,u=m},lineEnd:function(){a&amp;&amp;n.lineEnd(),e=null},clean:function(){return s|(c&amp;&amp;a)\u003C\u003C1}}}function r(n,t,e){var r=qt(n),i=qt(t),u=[1,0,0],o=Ct(r,i),c=Tt(o,o),l=o[0],s=c-l*l;if(!s)return!e&amp;&amp;n;var f=a*c/s,h=-a*l/s,g=Ct(u,o),p=Dt(u,f),d=Dt(o,h);zt(p,d);var m=g,v=Tt(p,m),y=Tt(m,m),M=v*v-y*(Tt(p,p)-1);if(!(0&gt;M)){var x=Math.sqrt(M),b=Dt(m,(-v-x)/y);if(zt(b,p),b=Lt(b),!e)return b;var _,w=n[0],S=t[0],E=n[1],k=t[1];w&gt;S&amp;&amp;(_=w,w=S,S=_);var A=S-w,N=Math.abs(A-Wa)\u003CJa,q=N||Ja&gt;A;if(!N&amp;&amp;E&gt;k&amp;&amp;(_=E,E=k,k=_),q?N?E+k&gt;0^b[1]\u003C(Math.abs(b[0]-w)\u003CJa?E:k):E\u003C=b[1]&amp;&amp;b[1]\u003C=k:A&gt;Wa^(w\u003C=b[0]&amp;&amp;b[0]\u003C=S)){var T=Dt(m,(-v+x)/y);return zt(T,p),[b,Lt(T)]}}}function i(t,e){var r=o?n:Wa-n,i=0;return-r&gt;t?i|=1:t&gt;r&amp;&amp;(i|=2),-r&gt;e?i|=4:e&gt;r&amp;&amp;(i|=8),i}function u(n){return Wt(c,n)}var a=Math.cos(n),o=a&gt;0,c=[n,0],l=Math.abs(a)&gt;Ja,s=Ee(n,6*Ka);return Xt(t,e,s,u)}function te(n,t,e,r){function i(r,i){return Math.abs(r[0]-n)\u003CJa?i&gt;0?0:3:Math.abs(r[0]-e)\u003CJa?i&gt;0?2:1:Math.abs(r[1]-t)\u003CJa?i&gt;0?1:0:i&gt;0?3:2}function u(n,t){return a(n.point,t.point)}function a(n,t){var e=i(n,1),r=i(t,1);return e!==r?e-r:0===e?t[1]-n[1]:1===e?n[0]-t[0]:2===e?n[1]-t[1]:t[0]-n[0]}function o(i,u){var a=u[0]-i[0],o=u[1]-i[1],c=[0,1];return Math.abs(a)\u003CJa&amp;&amp;Math.abs(o)\u003CJa?n\u003C=i[0]&amp;&amp;i[0]\u003C=e&amp;&amp;t\u003C=i[1]&amp;&amp;i[1]\u003C=r:ee(n-i[0],a,c)&amp;&amp;ee(i[0]-e,-a,c)&amp;&amp;ee(t-i[1],o,c)&amp;&amp;ee(i[1]-r,-o,c)?(c[1]\u003C1&amp;&amp;(u[0]=i[0]+c[1]*a,u[1]=i[1]+c[1]*o),c[0]&gt;0&amp;&amp;(i[0]+=c[0]*a,i[1]+=c[0]*o),!0):!1}return function(c){function l(u){var a=i(u,-1),o=s([0===a||3===a?n:e,a&gt;1?r:t]);return o}function s(n){for(var t=0,e=M.length,r=n[1],i=0;e&gt;i;++i)for(var u,a=1,o=M[i],c=o.length,l=o[0];c&gt;a;++a)u=o[a],l[1]\u003C=r?u[1]&gt;r&amp;&amp;f(l,u,n)&gt;0&amp;&amp;++t:u[1]\u003C=r&amp;&amp;f(l,u,n)\u003C0&amp;&amp;--t,l=u;return 0!==t}function f(n,t,e){return(t[0]-n[0])*(e[1]-n[1])-(e[0]-n[0])*(t[1]-n[1])}function h(u,o,c,l){var s=0,f=0;if(null==u||(s=i(u,c))!==(f=i(o,c))||a(u,o)\u003C0^c&gt;0){do l.point(0===s||3===s?n:e,s&gt;1?r:t);while((s=(s+c+4)%4)!==f)}else l.point(o[0],o[1])}function g(i,u){return i&gt;=n&amp;&amp;e&gt;=i&amp;&amp;u&gt;=t&amp;&amp;r&gt;=u}function p(n,t){g(n,t)&amp;&amp;c.point(n,t)}function d(){T.point=v,M&amp;&amp;M.push(x=[]),A=!0,k=!1,S=E=0/0}function m(){y&amp;&amp;(v(b,_),w&amp;&amp;k&amp;&amp;q.rejoin(),y.push(q.buffer())),T.point=p,k&amp;&amp;c.lineEnd()}function v(n,t){n=Math.max(-Io,Math.min(Io,n)),t=Math.max(-Io,Math.min(Io,t));var e=g(n,t);if(M&amp;&amp;x.push([n,t]),A)b=n,_=t,w=e,A=!1,e&amp;&amp;(c.lineStart(),c.point(n,t));else if(e&amp;&amp;k)c.point(n,t);else{var r=[S,E],i=[n,t];o(r,i)?(k||(c.lineStart(),c.point(r[0],r[1])),c.point(i[0],i[1]),e||c.lineEnd()):e&amp;&amp;(c.lineStart(),c.point(n,t))}S=n,E=t,k=e}var y,M,x,b,_,w,S,E,k,A,N=c,q=Bt(),T={point:p,lineStart:d,lineEnd:m,polygonStart:function(){c=q,y=[],M=[]},polygonEnd:function(){c=N,(y=da.merge(y)).length?(c.polygonStart(),It(y,u,l,h,c),c.polygonEnd()):s([n,t])&amp;&amp;(c.polygonStart(),c.lineStart(),h(null,null,1,c),c.lineEnd(),c.polygonEnd()),y=M=x=null}};return T}}function ee(n,t,e){if(Math.abs(t)\u003CJa)return 0&gt;=n;var r=n/t;if(t&gt;0){if(r&gt;e[1])return!1;r&gt;e[0]&amp;&amp;(e[0]=r)}else{if(r\u003Ce[0])return!1;r\u003Ce[1]&amp;&amp;(e[1]=r)}return!0}function re(n,t){function e(e,r){return e=n(e,r),t(e[0],e[1])}return n.invert&amp;&amp;t.invert&amp;&amp;(e.invert=function(e,r){return e=t.invert(e,r),e&amp;&amp;n.invert(e[0],e[1])}),e}function ie(n){var t=0,e=Wa/3,r=ye(n),i=r(t,e);return i.parallels=function(n){return arguments.length?r(t=n[0]*Wa/180,e=n[1]*Wa/180):[180*(t/Wa),180*(e/Wa)]},i}function ue(n,t){function e(n,t){var e=Math.sqrt(u-2*i*Math.sin(t))/i;return[e*Math.sin(n*=i),a-e*Math.cos(n)]}var r=Math.sin(n),i=(r+Math.sin(t))/2,u=1+r*(2*i-r),a=Math.sqrt(u)/i;return e.invert=function(n,t){var e=a-t;return[Math.atan2(n,e)/i,V((u-(n*n+e*e)*i*i)/(2*i))]},e}function ae(){function n(n,t){Xo+=i*n-r*t,r=n,i=t}var t,e,r,i;Jo.point=function(u,a){Jo.point=n,t=r=u,e=i=a},Jo.lineEnd=function(){n(t,e)}}function oe(n,t){Zo&gt;n&amp;&amp;(Zo=n),n&gt;$o&amp;&amp;($o=n),Bo&gt;t&amp;&amp;(Bo=t),t&gt;Wo&amp;&amp;(Wo=t)}function ce(){function n(n,t){a.push(\\\&quot;M\\\&quot;,n,\\\&quot;,\\\&quot;,t,u)}function t(n,t){a.push(\\\&quot;M\\\&quot;,n,\\\&quot;,\\\&quot;,t),o.point=e}function e(n,t){a.push(\\\&quot;L\\\&quot;,n,\\\&quot;,\\\&quot;,t)}function r(){o.point=n}function i(){a.push(\\\&quot;Z\\\&quot;)}var u=le(4.5),a=[],o={point:n,lineStart:function(){o.point=t},lineEnd:r,polygonStart:function(){o.lineEnd=i},polygonEnd:function(){o.lineEnd=r,o.point=n},pointRadius:function(n){return u=le(n),o},result:function(){if(a.length){var n=a.join(\\\&quot;\\\&quot;);return a=[],n}}};return o}function le(n){return\\\&quot;m0,\\\&quot;+n+\\\&quot;a\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 1,1 0,\\\&quot;+-2*n+\\\&quot;a\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 1,1 0,\\\&quot;+2*n+\\\&quot;z\\\&quot;}function se(n,t){Co+=n,zo+=t,++Do}function fe(){function n(n,r){var i=n-t,u=r-e,a=Math.sqrt(i*i+u*u);jo+=a*(t+n)/2,Lo+=a*(e+r)/2,Ho+=a,se(t=n,e=r)}var t,e;Ko.point=function(r,i){Ko.point=n,se(t=r,e=i)}}function he(){Ko.point=se}function ge(){function n(n,t){var e=n-r,u=t-i,a=Math.sqrt(e*e+u*u);jo+=a*(r+n)/2,Lo+=a*(i+t)/2,Ho+=a,a=i*n-r*t,Fo+=a*(r+n),Po+=a*(i+t),Oo+=3*a,se(r=n,i=t)}var t,e,r,i;Ko.point=function(u,a){Ko.point=n,se(t=r=u,e=i=a)},Ko.lineEnd=function(){n(t,e)}}function pe(n){function t(t,e){n.moveTo(t,e),n.arc(t,e,a,0,2*Wa)}function e(t,e){n.moveTo(t,e),o.point=r}function r(t,e){n.lineTo(t,e)}function i(){o.point=t}function u(){n.closePath()}var a=4.5,o={point:t,lineStart:function(){o.point=e},lineEnd:i,polygonStart:function(){o.lineEnd=u},polygonEnd:function(){o.lineEnd=i,o.point=t},pointRadius:function(n){return a=n,o},result:s};return o}function de(n){function t(t){function r(e,r){e=n(e,r),t.point(e[0],e[1])}function i(){M=0/0,S.point=a,t.lineStart()}function a(r,i){var a=qt([r,i]),o=n(r,i);e(M,x,y,b,_,w,M=o[0],x=o[1],y=r,b=a[0],_=a[1],w=a[2],u,t),t.point(M,x)}function o(){S.point=r,t.lineEnd()}function c(){i(),S.point=l,S.lineEnd=s}function l(n,t){a(f=n,h=t),g=M,p=x,d=b,m=_,v=w,S.point=a}function s(){e(M,x,y,b,_,w,g,p,f,d,m,v,u,t),S.lineEnd=o,o()}var f,h,g,p,d,m,v,y,M,x,b,_,w,S={point:r,lineStart:i,lineEnd:o,polygonStart:function(){t.polygonStart(),S.lineStart=c},polygonEnd:function(){t.polygonEnd(),S.lineStart=i}};return S}function e(t,u,a,o,c,l,s,f,h,g,p,d,m,v){var y=s-t,M=f-u,x=y*y+M*M;if(x&gt;4*r&amp;&amp;m--){var b=o+g,_=c+p,w=l+d,S=Math.sqrt(b*b+_*_+w*w),E=Math.asin(w/=S),k=Math.abs(Math.abs(w)-1)\u003CJa?(a+h)/2:Math.atan2(_,b),A=n(k,E),N=A[0],q=A[1],T=N-t,C=q-u,z=M*T-y*C;(z*z/x&gt;r||Math.abs((y*T+M*C)/x-.5)&gt;.3||i&gt;o*g+c*p+l*d)&amp;&amp;(e(t,u,a,o,c,l,N,q,k,b/=S,_/=S,w,m,v),v.point(N,q),e(N,q,k,b,_,w,s,f,h,g,p,d,m,v))}}var r=.5,i=Math.cos(30*Ka),u=16;return t.precision=function(n){return arguments.length?(u=(r=n*n)&gt;0&amp;&amp;16,t):Math.sqrt(r)},t}function me(n){var t=de(function(t,e){return n([t*Qa,e*Qa])});return function(n){return n=t(n),{point:function(t,e){n.point(t*Ka,e*Ka)},sphere:function(){n.sphere()},lineStart:function(){n.lineStart()},lineEnd:function(){n.lineEnd()},polygonStart:function(){n.polygonStart()},polygonEnd:function(){n.polygonEnd()}}}}function ve(n){return ye(function(){return n})()}function ye(n){function t(n){return n=o(n[0]*Ka,n[1]*Ka),[n[0]*h+c,l-n[1]*h]}function e(n){return n=o.invert((n[0]-c)/h,(l-n[1])/h),n&amp;&amp;[n[0]*Qa,n[1]*Qa]}function r(){o=re(a=be(v,y,M),u);var n=u(d,m);return c=g-n[0]*h,l=p+n[1]*h,i()}function i(){return s&amp;&amp;(s.valid=!1,s=null),t}var u,a,o,c,l,s,f=de(function(n,t){return n=u(n,t),[n[0]*h+c,l-n[1]*h]}),h=150,g=480,p=250,d=0,m=0,v=0,y=0,M=0,x=Ro,b=gt,_=null,w=null;return t.stream=function(n){return s&amp;&amp;(s.valid=!1),s=Me(a,x(f(b(n)))),s.valid=!0,s},t.clipAngle=function(n){return arguments.length?(x=null==n?(_=n,Ro):ne((_=+n)*Ka),i()):_},t.clipExtent=function(n){return arguments.length?(w=n,b=null==n?gt:te(n[0][0],n[0][1],n[1][0],n[1][1]),i()):w},t.scale=function(n){return arguments.length?(h=+n,r()):h},t.translate=function(n){return arguments.length?(g=+n[0],p=+n[1],r()):[g,p]},t.center=function(n){return arguments.length?(d=n[0]%360*Ka,m=n[1]%360*Ka,r()):[d*Qa,m*Qa]},t.rotate=function(n){return arguments.length?(v=n[0]%360*Ka,y=n[1]%360*Ka,M=n.length&gt;2?n[2]%360*Ka:0,r()):[v*Qa,y*Qa,M*Qa]},da.rebind(t,f,\\\&quot;precision\\\&quot;),function(){return u=n.apply(this,arguments),t.invert=u.invert&amp;&amp;e,r()}}function Me(n,t){return{point:function(e,r){r=n(e*Ka,r*Ka),e=r[0],t.point(e&gt;Wa?e-2*Wa:-Wa&gt;e?e+2*Wa:e,r[1])},sphere:function(){t.sphere()},lineStart:function(){t.lineStart()},lineEnd:function(){t.lineEnd()},polygonStart:function(){t.polygonStart()},polygonEnd:function(){t.polygonEnd()}}}function xe(n,t){return[n,t]}function be(n,t,e){return n?t||e?re(we(n),Se(t,e)):we(n):t||e?Se(t,e):xe}function _e(n){return function(t,e){return t+=n,[t&gt;Wa?t-2*Wa:-Wa&gt;t?t+2*Wa:t,e]}}function we(n){var t=_e(n);return t.invert=_e(-n),t}function Se(n,t){function e(n,t){var e=Math.cos(t),o=Math.cos(n)*e,c=Math.sin(n)*e,l=Math.sin(t),s=l*r+o*i;return[Math.atan2(c*u-s*a,o*r-l*i),V(s*u+c*a)]}var r=Math.cos(n),i=Math.sin(n),u=Math.cos(t),a=Math.sin(t);return e.invert=function(n,t){var e=Math.cos(t),o=Math.cos(n)*e,c=Math.sin(n)*e,l=Math.sin(t),s=l*u-c*a;return[Math.atan2(c*u+l*a,o*r+s*i),V(s*r-o*i)]},e}function Ee(n,t){var e=Math.cos(n),r=Math.sin(n);return function(i,u,a,o){null!=i?(i=ke(e,i),u=ke(e,u),(a&gt;0?u&gt;i:i&gt;u)&amp;&amp;(i+=2*a*Wa)):(i=n+2*a*Wa,u=n);for(var c,l=a*t,s=i;a&gt;0?s&gt;u:u&gt;s;s-=l)o.point((c=Lt([e,-r*Math.cos(s),-r*Math.sin(s)]))[0],c[1])}}function ke(n,t){var e=qt(t);e[0]-=n,jt(e);var r=I(-e[1]);return((-e[2]\u003C0?-r:r)+2*Math.PI-Ja)%(2*Math.PI)}function Ae(n,t,e){var r=da.range(n,t-Ja,e).concat(t);return function(n){return r.map(function(t){return[n,t]})}}function Ne(n,t,e){var r=da.range(n,t-Ja,e).concat(t);return function(n){return r.map(function(t){return[t,n]})}}function qe(n){return n.source}function Te(n){return n.target}function Ce(n,t,e,r){var i=Math.cos(t),u=Math.sin(t),a=Math.cos(r),o=Math.sin(r),c=i*Math.cos(n),l=i*Math.sin(n),s=a*Math.cos(e),f=a*Math.sin(e),h=2*Math.asin(Math.sqrt(B(r-t)+i*a*B(e-n))),g=1/Math.sin(h),p=h?function(n){var t=Math.sin(n*=h)*g,e=Math.sin(h-n)*g,r=e*c+t*s,i=e*l+t*f,a=e*u+t*o;return[Math.atan2(i,r)*Qa,Math.atan2(a,Math.sqrt(r*r+i*i))*Qa]}:function(){return[n*Qa,t*Qa]};return p.distance=h,p}function ze(){function n(n,i){var u=Math.sin(i*=Ka),a=Math.cos(i),o=Math.abs((n*=Ka)-t),c=Math.cos(o);Qo+=Math.atan2(Math.sqrt((o=a*Math.sin(o))*o+(o=r*u-e*a*c)*o),e*u+r*a*c),t=n,e=u,r=a}var t,e,r;nc.point=function(i,u){t=i*Ka,e=Math.sin(u*=Ka),r=Math.cos(u),nc.point=n},nc.lineEnd=function(){nc.point=nc.lineEnd=s}}function De(n,t){function e(t,e){var r=Math.cos(t),i=Math.cos(e),u=n(r*i);return[u*i*Math.sin(t),u*Math.sin(e)]}return e.invert=function(n,e){var r=Math.sqrt(n*n+e*e),i=t(r),u=Math.sin(i),a=Math.cos(i);return[Math.atan2(n*u,r*a),Math.asin(r&amp;&amp;e*u/r)]},e}function je(n,t){function e(n,t){var e=Math.abs(Math.abs(t)-Wa/2)\u003CJa?0:a/Math.pow(i(t),u);return[e*Math.sin(u*n),a-e*Math.cos(u*n)]}var r=Math.cos(n),i=function(n){return Math.tan(Wa/4+n/2)},u=n===t?Math.sin(n):Math.log(r/Math.cos(t))/Math.log(i(t)/i(n)),a=r*Math.pow(i(n),u)/u;return u?(e.invert=function(n,t){var e=a-t,r=U(u)*Math.sqrt(n*n+e*e);return[Math.atan2(n,e)/u,2*Math.atan(Math.pow(a/r,1/u))-Wa/2]},e):He}function Le(n,t){function e(n,t){var e=u-t;return[e*Math.sin(i*n),u-e*Math.cos(i*n)]}var r=Math.cos(n),i=n===t?Math.sin(n):(r-Math.cos(t))/(t-n),u=r/i+n;return Math.abs(i)\u003CJa?xe:(e.invert=function(n,t){var e=u-t;return[Math.atan2(n,e)/i,u-U(i)*Math.sqrt(n*n+e*e)]},e)}function He(n,t){return[n,Math.log(Math.tan(Wa/4+t/2))]}function Fe(n){var t,e=ve(n),r=e.scale,i=e.translate,u=e.clipExtent;return e.scale=function(){var n=r.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.translate=function(){var n=i.apply(e,arguments);return n===e?t?e.clipExtent(null):e:n},e.clipExtent=function(n){var a=u.apply(e,arguments);if(a===e){if(t=null==n){var o=Wa*r(),c=i();u([[c[0]-o,c[1]-o],[c[0]+o,c[1]+o]])}}else t&amp;&amp;(a=null);return a},e.clipExtent(null)}function Pe(n,t){var e=Math.cos(t)*Math.sin(n);return[Math.log((1+e)/(1-e))/2,Math.atan2(Math.tan(t),Math.cos(n))]}function Oe(n){function t(t){function a(){l.push(\\\&quot;M\\\&quot;,u(n(s),o))}for(var c,l=[],s=[],f=-1,h=t.length,g=ht(e),p=ht(r);++f\u003Ch;)i.call(this,c=t[f],f)?s.push([+g.call(this,c,f),+p.call(this,c,f)]):s.length&amp;&amp;(a(),s=[]);return s.length&amp;&amp;a(),l.length?l.join(\\\&quot;\\\&quot;):null}var e=Ye,r=Re,i=Ut,u=Ue,a=u.key,o=.7;return t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t.defined=function(n){return arguments.length?(i=n,t):i},t.interpolate=function(n){return arguments.length?(a=\\\&quot;function\\\&quot;==typeof n?u=n:(u=ac.get(n)||Ue).key,t):a},t.tension=function(n){return arguments.length?(o=n,t):o},t}function Ye(n){return n[0]}function Re(n){return n[1]}function Ue(n){return n.join(\\\&quot;L\\\&quot;)}function Ie(n){return Ue(n)+\\\&quot;Z\\\&quot;}function Ve(n){for(var t=0,e=n.length,r=n[0],i=[r[0],\\\&quot;,\\\&quot;,r[1]];++t\u003Ce;)i.push(\\\&quot;H\\\&quot;,(r[0]+(r=n[t])[0])/2,\\\&quot;V\\\&quot;,r[1]);return e&gt;1&amp;&amp;i.push(\\\&quot;H\\\&quot;,r[0]),i.join(\\\&quot;\\\&quot;)}function Xe(n){for(var t=0,e=n.length,r=n[0],i=[r[0],\\\&quot;,\\\&quot;,r[1]];++t\u003Ce;)i.push(\\\&quot;V\\\&quot;,(r=n[t])[1],\\\&quot;H\\\&quot;,r[0]);return i.join(\\\&quot;\\\&quot;)}function Ze(n){for(var t=0,e=n.length,r=n[0],i=[r[0],\\\&quot;,\\\&quot;,r[1]];++t\u003Ce;)i.push(\\\&quot;H\\\&quot;,(r=n[t])[0],\\\&quot;V\\\&quot;,r[1]);return i.join(\\\&quot;\\\&quot;)}function Be(n,t){return n.length\u003C4?Ue(n):n[1]+Je(n.slice(1,n.length-1),Ge(n,t))}function $e(n,t){return n.length\u003C3?Ue(n):n[0]+Je((n.push(n[0]),n),Ge([n[n.length-2]].concat(n,[n[1]]),t))}function We(n,t){return n.length\u003C3?Ue(n):n[0]+Je(n,Ge(n,t))}function Je(n,t){if(t.length\u003C1||n.length!=t.length&amp;&amp;n.length!=t.length+2)return Ue(n);var e=n.length!=t.length,r=\\\&quot;\\\&quot;,i=n[0],u=n[1],a=t[0],o=a,c=1;if(e&amp;&amp;(r+=\\\&quot;Q\\\&quot;+(u[0]-2*a[0]/3)+\\\&quot;,\\\&quot;+(u[1]-2*a[1]/3)+\\\&quot;,\\\&quot;+u[0]+\\\&quot;,\\\&quot;+u[1],i=n[1],c=2),t.length&gt;1){o=t[1],u=n[c],c++,r+=\\\&quot;C\\\&quot;+(i[0]+a[0])+\\\&quot;,\\\&quot;+(i[1]+a[1])+\\\&quot;,\\\&quot;+(u[0]-o[0])+\\\&quot;,\\\&quot;+(u[1]-o[1])+\\\&quot;,\\\&quot;+u[0]+\\\&quot;,\\\&quot;+u[1];for(var l=2;l\u003Ct.length;l++,c++)u=n[c],o=t[l],r+=\\\&quot;S\\\&quot;+(u[0]-o[0])+\\\&quot;,\\\&quot;+(u[1]-o[1])+\\\&quot;,\\\&quot;+u[0]+\\\&quot;,\\\&quot;+u[1]}if(e){var s=n[c];r+=\\\&quot;Q\\\&quot;+(u[0]+2*o[0]/3)+\\\&quot;,\\\&quot;+(u[1]+2*o[1]/3)+\\\&quot;,\\\&quot;+s[0]+\\\&quot;,\\\&quot;+s[1]}return r}function Ge(n,t){for(var e,r=[],i=(1-t)/2,u=n[0],a=n[1],o=1,c=n.length;++o\u003Cc;)e=u,u=a,a=n[o],r.push([i*(a[0]-e[0]),i*(a[1]-e[1])]);return r}function Ke(n){if(n.length\u003C3)return Ue(n);var t=1,e=n.length,r=n[0],i=r[0],u=r[1],a=[i,i,i,(r=n[1])[0]],o=[u,u,u,r[1]],c=[i,\\\&quot;,\\\&quot;,u,\\\&quot;L\\\&quot;,er(lc,a),\\\&quot;,\\\&quot;,er(lc,o)];for(n.push(n[e-1]);++t\u003C=e;)r=n[t],a.shift(),a.push(r[0]),o.shift(),o.push(r[1]),rr(c,a,o);return n.pop(),c.push(\\\&quot;L\\\&quot;,r),c.join(\\\&quot;\\\&quot;)}function Qe(n){if(n.length\u003C4)return Ue(n);for(var t,e=[],r=-1,i=n.length,u=[0],a=[0];++r\u003C3;)t=n[r],u.push(t[0]),a.push(t[1]);for(e.push(er(lc,u)+\\\&quot;,\\\&quot;+er(lc,a)),--r;++r\u003Ci;)t=n[r],u.shift(),u.push(t[0]),a.shift(),a.push(t[1]),rr(e,u,a);return e.join(\\\&quot;\\\&quot;)}function nr(n){for(var t,e,r=-1,i=n.length,u=i+4,a=[],o=[];++r\u003C4;)e=n[r%i],a.push(e[0]),o.push(e[1]);for(t=[er(lc,a),\\\&quot;,\\\&quot;,er(lc,o)],--r;++r\u003Cu;)e=n[r%i],a.shift(),a.push(e[0]),o.shift(),o.push(e[1]),rr(t,a,o);return t.join(\\\&quot;\\\&quot;)}function tr(n,t){var e=n.length-1;if(e)for(var r,i,u=n[0][0],a=n[0][1],o=n[e][0]-u,c=n[e][1]-a,l=-1;++l\u003C=e;)r=n[l],i=l/e,r[0]=t*r[0]+(1-t)*(u+i*o),r[1]=t*r[1]+(1-t)*(a+i*c);return Ke(n)}function er(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]*t[3]}function rr(n,t,e){n.push(\\\&quot;C\\\&quot;,er(oc,t),\\\&quot;,\\\&quot;,er(oc,e),\\\&quot;,\\\&quot;,er(cc,t),\\\&quot;,\\\&quot;,er(cc,e),\\\&quot;,\\\&quot;,er(lc,t),\\\&quot;,\\\&quot;,er(lc,e))}function ir(n,t){return(t[1]-n[1])/(t[0]-n[0])\\n}function ur(n){for(var t=0,e=n.length-1,r=[],i=n[0],u=n[1],a=r[0]=ir(i,u);++t\u003Ce;)r[t]=(a+(a=ir(i=u,u=n[t+1])))/2;return r[t]=a,r}function ar(n){for(var t,e,r,i,u=[],a=ur(n),o=-1,c=n.length-1;++o\u003Cc;)t=ir(n[o],n[o+1]),Math.abs(t)\u003C1e-6?a[o]=a[o+1]=0:(e=a[o]/t,r=a[o+1]/t,i=e*e+r*r,i&gt;9&amp;&amp;(i=3*t/Math.sqrt(i),a[o]=i*e,a[o+1]=i*r));for(o=-1;++o\u003C=c;)i=(n[Math.min(c,o+1)][0]-n[Math.max(0,o-1)][0])/(6*(1+a[o]*a[o])),u.push([i||0,a[o]*i||0]);return u}function or(n){return n.length\u003C3?Ue(n):n[0]+Je(n,ar(n))}function cr(n,t,e,r){var i,u,a,o,c,l,s;return i=r[n],u=i[0],a=i[1],i=r[t],o=i[0],c=i[1],i=r[e],l=i[0],s=i[1],(s-a)*(o-u)-(c-a)*(l-u)&gt;0}function lr(n,t,e){return(e[0]-t[0])*(n[1]-t[1])\u003C(e[1]-t[1])*(n[0]-t[0])}function sr(n,t,e,r){var i=n[0],u=e[0],a=t[0]-i,o=r[0]-u,c=n[1],l=e[1],s=t[1]-c,f=r[1]-l,h=(o*(c-l)-f*(i-u))/(f*a-o*s);return[i+h*a,c+h*s]}function fr(n){var t=n[0],e=n[n.length-1];return!(t[0]-e[0]||t[1]-e[1])}function hr(n,t){var e={list:n.map(function(n,t){return{index:t,x:n[0],y:n[1]}}).sort(function(n,t){return n.y\u003Ct.y?-1:n.y&gt;t.y?1:n.x\u003Ct.x?-1:n.x&gt;t.x?1:0}),bottomSite:null},r={list:[],leftEnd:null,rightEnd:null,init:function(){r.leftEnd=r.createHalfEdge(null,\\\&quot;l\\\&quot;),r.rightEnd=r.createHalfEdge(null,\\\&quot;l\\\&quot;),r.leftEnd.r=r.rightEnd,r.rightEnd.l=r.leftEnd,r.list.unshift(r.leftEnd,r.rightEnd)},createHalfEdge:function(n,t){return{edge:n,side:t,vertex:null,l:null,r:null}},insert:function(n,t){t.l=n,t.r=n.r,n.r.l=t,n.r=t},leftBound:function(n){var t=r.leftEnd;do t=t.r;while(t!=r.rightEnd&amp;&amp;i.rightOf(t,n));return t=t.l},del:function(n){n.l.r=n.r,n.r.l=n.l,n.edge=null},right:function(n){return n.r},left:function(n){return n.l},leftRegion:function(n){return null==n.edge?e.bottomSite:n.edge.region[n.side]},rightRegion:function(n){return null==n.edge?e.bottomSite:n.edge.region[fc[n.side]]}},i={bisect:function(n,t){var e={region:{l:n,r:t},ep:{l:null,r:null}},r=t.x-n.x,i=t.y-n.y,u=r&gt;0?r:-r,a=i&gt;0?i:-i;return e.c=n.x*r+n.y*i+.5*(r*r+i*i),u&gt;a?(e.a=1,e.b=i/r,e.c/=r):(e.b=1,e.a=r/i,e.c/=i),e},intersect:function(n,t){var e=n.edge,r=t.edge;if(!e||!r||e.region.r==r.region.r)return null;var i=e.a*r.b-e.b*r.a;if(Math.abs(i)\u003C1e-10)return null;var u,a,o=(e.c*r.b-r.c*e.b)/i,c=(r.c*e.a-e.c*r.a)/i,l=e.region.r,s=r.region.r;l.y\u003Cs.y||l.y==s.y&amp;&amp;l.x\u003Cs.x?(u=n,a=e):(u=t,a=r);var f=o&gt;=a.region.r.x;return f&amp;&amp;\\\&quot;l\\\&quot;===u.side||!f&amp;&amp;\\\&quot;r\\\&quot;===u.side?null:{x:o,y:c}},rightOf:function(n,t){var e=n.edge,r=e.region.r,i=t.x&gt;r.x;if(i&amp;&amp;\\\&quot;l\\\&quot;===n.side)return 1;if(!i&amp;&amp;\\\&quot;r\\\&quot;===n.side)return 0;if(1===e.a){var u=t.y-r.y,a=t.x-r.x,o=0,c=0;if(!i&amp;&amp;e.b\u003C0||i&amp;&amp;e.b&gt;=0?c=o=u&gt;=e.b*a:(c=t.x+t.y*e.b&gt;e.c,e.b\u003C0&amp;&amp;(c=!c),c||(o=1)),!o){var l=r.x-e.region.l.x;c=e.b*(a*a-u*u)\u003Cl*u*(1+2*a/l+e.b*e.b),e.b\u003C0&amp;&amp;(c=!c)}}else{var s=e.c-e.a*t.x,f=t.y-s,h=t.x-r.x,g=s-r.y;c=f*f&gt;h*h+g*g}return\\\&quot;l\\\&quot;===n.side?c:!c},endPoint:function(n,e,r){n.ep[e]=r,n.ep[fc[e]]&amp;&amp;t(n)},distance:function(n,t){var e=n.x-t.x,r=n.y-t.y;return Math.sqrt(e*e+r*r)}},u={list:[],insert:function(n,t,e){n.vertex=t,n.ystar=t.y+e;for(var r=0,i=u.list,a=i.length;a&gt;r;r++){var o=i[r];if(!(n.ystar&gt;o.ystar||n.ystar==o.ystar&amp;&amp;t.x&gt;o.vertex.x))break}i.splice(r,0,n)},del:function(n){for(var t=0,e=u.list,r=e.length;r&gt;t&amp;&amp;e[t]!=n;++t);e.splice(t,1)},empty:function(){return 0===u.list.length},nextEvent:function(n){for(var t=0,e=u.list,r=e.length;r&gt;t;++t)if(e[t]==n)return e[t+1];return null},min:function(){var n=u.list[0];return{x:n.vertex.x,y:n.ystar}},extractMin:function(){return u.list.shift()}};r.init(),e.bottomSite=e.list.shift();for(var a,o,c,l,s,f,h,g,p,d,m,v,y,M=e.list.shift();;)if(u.empty()||(a=u.min()),M&amp;&amp;(u.empty()||M.y\u003Ca.y||M.y==a.y&amp;&amp;M.x\u003Ca.x))o=r.leftBound(M),c=r.right(o),h=r.rightRegion(o),v=i.bisect(h,M),f=r.createHalfEdge(v,\\\&quot;l\\\&quot;),r.insert(o,f),d=i.intersect(o,f),d&amp;&amp;(u.del(o),u.insert(o,d,i.distance(d,M))),o=f,f=r.createHalfEdge(v,\\\&quot;r\\\&quot;),r.insert(o,f),d=i.intersect(f,c),d&amp;&amp;u.insert(f,d,i.distance(d,M)),M=e.list.shift();else{if(u.empty())break;o=u.extractMin(),l=r.left(o),c=r.right(o),s=r.right(c),h=r.leftRegion(o),g=r.rightRegion(c),m=o.vertex,i.endPoint(o.edge,o.side,m),i.endPoint(c.edge,c.side,m),r.del(o),u.del(c),r.del(c),y=\\\&quot;l\\\&quot;,h.y&gt;g.y&amp;&amp;(p=h,h=g,g=p,y=\\\&quot;r\\\&quot;),v=i.bisect(h,g),f=r.createHalfEdge(v,y),r.insert(l,f),i.endPoint(v,fc[y],m),d=i.intersect(l,f),d&amp;&amp;(u.del(l),u.insert(l,d,i.distance(d,h))),d=i.intersect(f,s),d&amp;&amp;u.insert(f,d,i.distance(d,h))}for(o=r.right(r.leftEnd);o!=r.rightEnd;o=r.right(o))t(o.edge)}function gr(n){return n.x}function pr(n){return n.y}function dr(){return{leaf:!0,nodes:[],point:null,x:null,y:null}}function mr(n,t,e,r,i,u){if(!n(t,e,r,i,u)){var a=.5*(e+i),o=.5*(r+u),c=t.nodes;c[0]&amp;&amp;mr(n,c[0],e,r,a,o),c[1]&amp;&amp;mr(n,c[1],a,r,i,o),c[2]&amp;&amp;mr(n,c[2],e,o,a,u),c[3]&amp;&amp;mr(n,c[3],a,o,i,u)}}function vr(n,t){n=da.rgb(n),t=da.rgb(t);var e=n.r,r=n.g,i=n.b,u=t.r-e,a=t.g-r,o=t.b-i;return function(t){return n.r=Math.round(e+u*t),n.g=Math.round(r+a*t),n.b=Math.round(i+o*t),n}}function yr(n,t){var e,r={},i={};for(e in n)e in t?r[e]=br(n[e],t[e]):i[e]=n[e];for(e in t)e in n||(i[e]=t[e]);return function(n){for(e in r)i[e]=r[e](n);return i}}function Mr(n,t){return t-=n=+n,function(e){return n+t*e}}function xr(n,t){var e,r,i,u,a,o=0,c=0,l=[],s=[];for(n+=\\\&quot;\\\&quot;,t+=\\\&quot;\\\&quot;,hc.lastIndex=0,r=0;e=hc.exec(t);++r)e.index&amp;&amp;l.push(t.substring(o,c=e.index)),s.push({i:l.length,x:e[0]}),l.push(null),o=hc.lastIndex;for(o\u003Ct.length&amp;&amp;l.push(t.substring(o)),r=0,u=s.length;(e=hc.exec(n))&amp;&amp;u&gt;r;++r)if(a=s[r],a.x==e[0]){if(a.i)if(null==l[a.i+1])for(l[a.i-1]+=a.x,l.splice(a.i,1),i=r+1;u&gt;i;++i)s[i].i--;else for(l[a.i-1]+=a.x+l[a.i+1],l.splice(a.i,2),i=r+1;u&gt;i;++i)s[i].i-=2;else if(null==l[a.i+1])l[a.i]=a.x;else for(l[a.i]=a.x+l[a.i+1],l.splice(a.i+1,1),i=r+1;u&gt;i;++i)s[i].i--;s.splice(r,1),u--,r--}else a.x=Mr(parseFloat(e[0]),parseFloat(a.x));for(;u&gt;r;)a=s.pop(),null==l[a.i+1]?l[a.i]=a.x:(l[a.i]=a.x+l[a.i+1],l.splice(a.i+1,1)),u--;return 1===l.length?null==l[0]?(a=s[0].x,function(n){return a(n)+\\\&quot;\\\&quot;}):function(){return t}:function(n){for(r=0;u&gt;r;++r)l[(a=s[r]).i]=a.x(n);return l.join(\\\&quot;\\\&quot;)}}function br(n,t){for(var e,r=da.interpolators.length;--r&gt;=0&amp;&amp;!(e=da.interpolators[r](n,t)););return e}function _r(n,t){var e,r=[],i=[],u=n.length,a=t.length,o=Math.min(n.length,t.length);for(e=0;o&gt;e;++e)r.push(br(n[e],t[e]));for(;u&gt;e;++e)i[e]=n[e];for(;a&gt;e;++e)i[e]=t[e];return function(n){for(e=0;o&gt;e;++e)i[e]=r[e](n);return i}}function wr(n){return function(t){return 0&gt;=t?0:t&gt;=1?1:n(t)}}function Sr(n){return function(t){return 1-n(1-t)}}function Er(n){return function(t){return.5*(.5&gt;t?n(2*t):2-n(2-2*t))}}function kr(n){return n*n}function Ar(n){return n*n*n}function Nr(n){if(0&gt;=n)return 0;if(n&gt;=1)return 1;var t=n*n,e=t*n;return 4*(.5&gt;n?e:3*(n-t)+e-.75)}function qr(n){return function(t){return Math.pow(t,n)}}function Tr(n){return 1-Math.cos(n*Wa/2)}function Cr(n){return Math.pow(2,10*(n-1))}function zr(n){return 1-Math.sqrt(1-n*n)}function Dr(n,t){var e;return arguments.length\u003C2&amp;&amp;(t=.45),arguments.length?e=t/(2*Wa)*Math.asin(1/n):(n=1,e=t/4),function(r){return 1+n*Math.pow(2,10*-r)*Math.sin(2*(r-e)*Wa/t)}}function jr(n){return n||(n=1.70158),function(t){return t*t*((n+1)*t-n)}}function Lr(n){return 1/2.75&gt;n?7.5625*n*n:2/2.75&gt;n?7.5625*(n-=1.5/2.75)*n+.75:2.5/2.75&gt;n?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375}function Hr(n,t){n=da.hcl(n),t=da.hcl(t);var e=n.h,r=n.c,i=n.l,u=t.h-e,a=t.c-r,o=t.l-i;return isNaN(a)&amp;&amp;(a=0,r=isNaN(r)?t.c:r),isNaN(u)?(u=0,e=isNaN(e)?t.h:e):u&gt;180?u-=360:-180&gt;u&amp;&amp;(u+=360),function(t){return n.h=e+u*t,n.c=r+a*t,n.l=i+o*t,n}}function Fr(n,t){n=da.hsl(n),t=da.hsl(t);var e=n.h,r=n.s,i=n.l,u=t.h-e,a=t.s-r,o=t.l-i;return isNaN(a)&amp;&amp;(a=0,r=isNaN(r)?t.s:r),isNaN(u)?(u=0,e=isNaN(e)?t.h:e):u&gt;180?u-=360:-180&gt;u&amp;&amp;(u+=360),function(t){return n.h=e+u*t,n.s=r+a*t,n.l=i+o*t,n}}function Pr(n,t){n=da.lab(n),t=da.lab(t);var e=n.l,r=n.a,i=n.b,u=t.l-e,a=t.a-r,o=t.b-i;return function(t){return n.l=e+u*t,n.a=r+a*t,n.b=i+o*t,n}}function Or(n,t){return t-=n,function(e){return Math.round(n+t*e)}}function Yr(n){var t=[n.a,n.b],e=[n.c,n.d],r=Ur(t),i=Rr(t,e),u=Ur(Ir(e,t,-i))||0;t[0]*e[1]\u003Ce[0]*t[1]&amp;&amp;(t[0]*=-1,t[1]*=-1,r*=-1,i*=-1),this.rotate=(r?Math.atan2(t[1],t[0]):Math.atan2(-e[0],e[1]))*Qa,this.translate=[n.e,n.f],this.scale=[r,u],this.skew=u?Math.atan2(i,u)*Qa:0}function Rr(n,t){return n[0]*t[0]+n[1]*t[1]}function Ur(n){var t=Math.sqrt(Rr(n,n));return t&amp;&amp;(n[0]/=t,n[1]/=t),t}function Ir(n,t,e){return n[0]+=e*t[0],n[1]+=e*t[1],n}function Vr(n,t){var e,r=[],i=[],u=da.transform(n),a=da.transform(t),o=u.translate,c=a.translate,l=u.rotate,s=a.rotate,f=u.skew,h=a.skew,g=u.scale,p=a.scale;return o[0]!=c[0]||o[1]!=c[1]?(r.push(\\\&quot;translate(\\\&quot;,null,\\\&quot;,\\\&quot;,null,\\\&quot;)\\\&quot;),i.push({i:1,x:Mr(o[0],c[0])},{i:3,x:Mr(o[1],c[1])})):c[0]||c[1]?r.push(\\\&quot;translate(\\\&quot;+c+\\\&quot;)\\\&quot;):r.push(\\\&quot;\\\&quot;),l!=s?(l-s&gt;180?s+=360:s-l&gt;180&amp;&amp;(l+=360),i.push({i:r.push(r.pop()+\\\&quot;rotate(\\\&quot;,null,\\\&quot;)\\\&quot;)-2,x:Mr(l,s)})):s&amp;&amp;r.push(r.pop()+\\\&quot;rotate(\\\&quot;+s+\\\&quot;)\\\&quot;),f!=h?i.push({i:r.push(r.pop()+\\\&quot;skewX(\\\&quot;,null,\\\&quot;)\\\&quot;)-2,x:Mr(f,h)}):h&amp;&amp;r.push(r.pop()+\\\&quot;skewX(\\\&quot;+h+\\\&quot;)\\\&quot;),g[0]!=p[0]||g[1]!=p[1]?(e=r.push(r.pop()+\\\&quot;scale(\\\&quot;,null,\\\&quot;,\\\&quot;,null,\\\&quot;)\\\&quot;),i.push({i:e-4,x:Mr(g[0],p[0])},{i:e-2,x:Mr(g[1],p[1])})):(1!=p[0]||1!=p[1])&amp;&amp;r.push(r.pop()+\\\&quot;scale(\\\&quot;+p+\\\&quot;)\\\&quot;),e=i.length,function(n){for(var t,u=-1;++u\u003Ce;)r[(t=i[u]).i]=t.x(n);return r.join(\\\&quot;\\\&quot;)}}function Xr(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return(e-n)*t}}function Zr(n,t){return t=t-(n=+n)?1/(t-n):0,function(e){return Math.max(0,Math.min(1,(e-n)*t))}}function Br(n){for(var t=n.source,e=n.target,r=Wr(t,e),i=[t];t!==r;)t=t.parent,i.push(t);for(var u=i.length;e!==r;)i.splice(u,0,e),e=e.parent;return i}function $r(n){for(var t=[],e=n.parent;null!=e;)t.push(n),n=e,e=e.parent;return t.push(n),t}function Wr(n,t){if(n===t)return n;for(var e=$r(n),r=$r(t),i=e.pop(),u=r.pop(),a=null;i===u;)a=i,i=e.pop(),u=r.pop();return a}function Jr(n){n.fixed|=2}function Gr(n){n.fixed&amp;=-7}function Kr(n){n.fixed|=4,n.px=n.x,n.py=n.y}function Qr(n){n.fixed&amp;=-5}function ni(n,t,e){var r=0,i=0;if(n.charge=0,!n.leaf)for(var u,a=n.nodes,o=a.length,c=-1;++c\u003Co;)u=a[c],null!=u&amp;&amp;(ni(u,t,e),n.charge+=u.charge,r+=u.charge*u.cx,i+=u.charge*u.cy);if(n.point){n.leaf||(n.point.x+=Math.random()-.5,n.point.y+=Math.random()-.5);var l=t*e[n.point.index];n.charge+=n.pointCharge=l,r+=l*n.point.x,i+=l*n.point.y}n.cx=r/n.charge,n.cy=i/n.charge}function ti(n,t){return da.rebind(n,t,\\\&quot;sort\\\&quot;,\\\&quot;children\\\&quot;,\\\&quot;value\\\&quot;),n.nodes=n,n.links=ui,n}function ei(n){return n.children}function ri(n){return n.value}function ii(n,t){return t.value-n.value}function ui(n){return da.merge(n.map(function(n){return(n.children||[]).map(function(t){return{source:n,target:t}})}))}function ai(n){return n.x}function oi(n){return n.y}function ci(n,t,e){n.y0=t,n.y=e}function li(n){return da.range(n.length)}function si(n){for(var t=-1,e=n[0].length,r=[];++t\u003Ce;)r[t]=0;return r}function fi(n){for(var t,e=1,r=0,i=n[0][1],u=n.length;u&gt;e;++e)(t=n[e][1])&gt;i&amp;&amp;(r=e,i=t);return r}function hi(n){return n.reduce(gi,0)}function gi(n,t){return n+t[1]}function pi(n,t){return di(n,Math.ceil(Math.log(t.length)/Math.LN2+1))}function di(n,t){for(var e=-1,r=+n[0],i=(n[1]-r)/t,u=[];++e\u003C=t;)u[e]=i*e+r;return u}function mi(n){return[da.min(n),da.max(n)]}function vi(n,t){return n.parent==t.parent?1:2}function yi(n){var t=n.children;return t&amp;&amp;t.length?t[0]:n._tree.thread}function Mi(n){var t,e=n.children;return e&amp;&amp;(t=e.length)?e[t-1]:n._tree.thread}function xi(n,t){var e=n.children;if(e&amp;&amp;(i=e.length))for(var r,i,u=-1;++u\u003Ci;)t(r=xi(e[u],t),n)&gt;0&amp;&amp;(n=r);return n}function bi(n,t){return n.x-t.x}function _i(n,t){return t.x-n.x}function wi(n,t){return n.depth-t.depth}function Si(n,t){function e(n,r){var i=n.children;if(i&amp;&amp;(a=i.length))for(var u,a,o=null,c=-1;++c\u003Ca;)u=i[c],e(u,o),o=u;t(n,r)}e(n,null)}function Ei(n){for(var t,e=0,r=0,i=n.children,u=i.length;--u&gt;=0;)t=i[u]._tree,t.prelim+=e,t.mod+=e,e+=t.shift+(r+=t.change)}function ki(n,t,e){n=n._tree,t=t._tree;var r=e/(t.number-n.number);n.change+=r,t.change-=r,t.shift+=e,t.prelim+=e,t.mod+=e}function Ai(n,t,e){return n._tree.ancestor.parent==t.parent?n._tree.ancestor:e}function Ni(n,t){return n.value-t.value}function qi(n,t){var e=n._pack_next;n._pack_next=t,t._pack_prev=n,t._pack_next=e,e._pack_prev=t}function Ti(n,t){n._pack_next=t,t._pack_prev=n}function Ci(n,t){var e=t.x-n.x,r=t.y-n.y,i=n.r+t.r;return.999*i*i&gt;e*e+r*r}function zi(n){function t(n){s=Math.min(n.x-n.r,s),f=Math.max(n.x+n.r,f),h=Math.min(n.y-n.r,h),g=Math.max(n.y+n.r,g)}if((e=n.children)&amp;&amp;(l=e.length)){var e,r,i,u,a,o,c,l,s=1/0,f=-1/0,h=1/0,g=-1/0;if(e.forEach(Di),r=e[0],r.x=-r.r,r.y=0,t(r),l&gt;1&amp;&amp;(i=e[1],i.x=i.r,i.y=0,t(i),l&gt;2))for(u=e[2],Hi(r,i,u),t(u),qi(r,u),r._pack_prev=u,qi(u,i),i=r._pack_next,a=3;l&gt;a;a++){Hi(r,i,u=e[a]);var p=0,d=1,m=1;for(o=i._pack_next;o!==i;o=o._pack_next,d++)if(Ci(o,u)){p=1;break}if(1==p)for(c=r._pack_prev;c!==o._pack_prev&amp;&amp;!Ci(c,u);c=c._pack_prev,m++);p?(m&gt;d||d==m&amp;&amp;i.r\u003Cr.r?Ti(r,i=o):Ti(r=c,i),a--):(qi(r,u),i=u,t(u))}var v=(s+f)/2,y=(h+g)/2,M=0;for(a=0;l&gt;a;a++)u=e[a],u.x-=v,u.y-=y,M=Math.max(M,u.r+Math.sqrt(u.x*u.x+u.y*u.y));n.r=M,e.forEach(ji)}}function Di(n){n._pack_next=n._pack_prev=n}function ji(n){delete n._pack_next,delete n._pack_prev}function Li(n,t,e,r){var i=n.children;if(n.x=t+=r*n.x,n.y=e+=r*n.y,n.r*=r,i)for(var u=-1,a=i.length;++u\u003Ca;)Li(i[u],t,e,r)}function Hi(n,t,e){var r=n.r+e.r,i=t.x-n.x,u=t.y-n.y;if(r&amp;&amp;(i||u)){var a=t.r+e.r,o=i*i+u*u;a*=a,r*=r;var c=.5+(r-a)/(2*o),l=Math.sqrt(Math.max(0,2*a*(r+o)-(r-=o)*r-a*a))/(2*o);e.x=n.x+c*i+l*u,e.y=n.y+c*u-l*i}else e.x=n.x+r,e.y=n.y}function Fi(n){return 1+da.max(n,function(n){return n.y})}function Pi(n){return n.reduce(function(n,t){return n+t.x},0)/n.length}function Oi(n){var t=n.children;return t&amp;&amp;t.length?Oi(t[0]):n}function Yi(n){var t,e=n.children;return e&amp;&amp;(t=e.length)?Yi(e[t-1]):n}function Ri(n){return{x:n.x,y:n.y,dx:n.dx,dy:n.dy}}function Ui(n,t){var e=n.x+t[3],r=n.y+t[0],i=n.dx-t[1]-t[3],u=n.dy-t[0]-t[2];return 0&gt;i&amp;&amp;(e+=i/2,i=0),0&gt;u&amp;&amp;(r+=u/2,u=0),{x:e,y:r,dx:i,dy:u}}function Ii(n){var t=n[0],e=n[n.length-1];return e&gt;t?[t,e]:[e,t]}function Vi(n){return n.rangeExtent?n.rangeExtent():Ii(n.range())}function Xi(n,t,e,r){var i=e(n[0],n[1]),u=r(t[0],t[1]);return function(n){return u(i(n))}}function Zi(n,t){var e,r=0,i=n.length-1,u=n[r],a=n[i];return u&gt;a&amp;&amp;(e=r,r=i,i=e,e=u,u=a,a=e),n[r]=t.floor(u),n[i]=t.ceil(a),n}function Bi(n){return n?{floor:function(t){return Math.floor(t/n)*n},ceil:function(t){return Math.ceil(t/n)*n}}:_c}function $i(n,t,e,r){var i=[],u=[],a=0,o=Math.min(n.length,t.length)-1;for(n[o]\u003Cn[0]&amp;&amp;(n=n.slice().reverse(),t=t.slice().reverse());++a\u003C=o;)i.push(e(n[a-1],n[a])),u.push(r(t[a-1],t[a]));return function(t){var e=da.bisect(n,t,1,o)-1;return u[e](i[e](t))}}function Wi(n,t,e,r){function i(){var i=Math.min(n.length,t.length)&gt;2?$i:Xi,c=r?Zr:Xr;return a=i(n,t,c,e),o=i(t,n,c,br),u}function u(n){return a(n)}var a,o;return u.invert=function(n){return o(n)},u.domain=function(t){return arguments.length?(n=t.map(Number),i()):n},u.range=function(n){return arguments.length?(t=n,i()):t},u.rangeRound=function(n){return u.range(n).interpolate(Or)},u.clamp=function(n){return arguments.length?(r=n,i()):r},u.interpolate=function(n){return arguments.length?(e=n,i()):e},u.ticks=function(t){return nu(n,t)},u.tickFormat=function(t,e){return tu(n,t,e)},u.nice=function(t){return Gi(n,t),i()},u.copy=function(){return Wi(n,t,e,r)},i()}function Ji(n,t){return da.rebind(n,t,\\\&quot;range\\\&quot;,\\\&quot;rangeRound\\\&quot;,\\\&quot;interpolate\\\&quot;,\\\&quot;clamp\\\&quot;)}function Gi(n,t){return Zi(n,Bi(t?Qi(n,t)[2]:Ki(n)))}function Ki(n){var t=Ii(n),e=t[1]-t[0];return Math.pow(10,Math.round(Math.log(e)/Math.LN10)-1)}function Qi(n,t){var e=Ii(n),r=e[1]-e[0],i=Math.pow(10,Math.floor(Math.log(r/t)/Math.LN10)),u=t/r*i;return.15&gt;=u?i*=10:.35&gt;=u?i*=5:.75&gt;=u&amp;&amp;(i*=2),e[0]=Math.ceil(e[0]/i)*i,e[1]=Math.floor(e[1]/i)*i+.5*i,e[2]=i,e}function nu(n,t){return da.range.apply(da,Qi(n,t))}function tu(n,t,e){var r=-Math.floor(Math.log(Qi(n,t)[2])/Math.LN10+.01);return da.format(e?e.replace(Mo,function(n,t,e,i,u,a,o,c,l,s){return[t,e,i,u,a,o,c,l||\\\&quot;.\\\&quot;+(r-2*(\\\&quot;%\\\&quot;===s)),s].join(\\\&quot;\\\&quot;)}):\\\&quot;,.\\\&quot;+r+\\\&quot;f\\\&quot;)}function eu(n,t,e,r){function i(n){return(e?Math.log(0&gt;n?0:n):-Math.log(n&gt;0?0:-n))/Math.log(t)}function u(n){return e?Math.pow(t,n):-Math.pow(t,-n)}function a(t){return n(i(t))}return a.invert=function(t){return u(n.invert(t))},a.domain=function(t){return arguments.length?(e=t[0]&gt;=0,n.domain((r=t.map(Number)).map(i)),a):r},a.base=function(e){return arguments.length?(t=+e,n.domain(r.map(i)),a):t},a.nice=function(){var t=Zi(r.map(i),e?Math:Sc);return n.domain(t),r=t.map(u),a},a.ticks=function(){var n=Ii(r),a=[];if(n.every(isFinite)){var o=n[0],c=n[1],l=Math.floor(i(o)),s=Math.ceil(i(c)),f=t%1?2:t;if(e){for(;s&gt;l;l++)for(var h=1;f&gt;h;h++)a.push(u(l)*h);a.push(u(l))}else for(a.push(u(l));l++\u003Cs;)for(var h=f-1;h&gt;0;h--)a.push(u(l)*h);for(l=0;a[l]\u003Co;l++);for(s=a.length;a[s-1]&gt;c;s--);a=a.slice(l,s)}return a},a.tickFormat=function(n,t){if(!arguments.length)return wc;arguments.length\u003C2?t=wc:\\\&quot;function\\\&quot;!=typeof t&amp;&amp;(t=da.format(t));var r,o=Math.max(.1,n/a.ticks().length),c=e?(r=1e-12,Math.ceil):(r=-1e-12,Math.floor);return function(n){return n/u(c(i(n)+r))\u003C=o?t(n):\\\&quot;\\\&quot;}},a.copy=function(){return eu(n.copy(),t,e,r)},Ji(a,n)}function ru(n,t,e){function r(t){return n(i(t))}var i=iu(t),u=iu(1/t);return r.invert=function(t){return u(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain((e=t.map(Number)).map(i)),r):e},r.ticks=function(n){return nu(e,n)},r.tickFormat=function(n,t){return tu(e,n,t)},r.nice=function(n){return r.domain(Gi(e,n))},r.exponent=function(a){return arguments.length?(i=iu(t=a),u=iu(1/t),n.domain(e.map(i)),r):t},r.copy=function(){return ru(n.copy(),t,e)},Ji(r,n)}function iu(n){return function(t){return 0&gt;t?-Math.pow(-t,n):Math.pow(t,n)}}function uu(n,t){function e(t){return a[((u.get(t)||u.set(t,n.push(t)))-1)%a.length]}function r(t,e){return da.range(n.length).map(function(n){return t+e*n})}var u,a,o;return e.domain=function(r){if(!arguments.length)return n;n=[],u=new i;for(var a,o=-1,c=r.length;++o\u003Cc;)u.has(a=r[o])||u.set(a,n.push(a));return e[t.t].apply(e,t.a)},e.range=function(n){return arguments.length?(a=n,o=0,t={t:\\\&quot;range\\\&quot;,a:arguments},e):a},e.rangePoints=function(i,u){arguments.length\u003C2&amp;&amp;(u=0);var c=i[0],l=i[1],s=(l-c)/(Math.max(1,n.length-1)+u);return a=r(n.length\u003C2?(c+l)/2:c+s*u/2,s),o=0,t={t:\\\&quot;rangePoints\\\&quot;,a:arguments},e},e.rangeBands=function(i,u,c){arguments.length\u003C2&amp;&amp;(u=0),arguments.length\u003C3&amp;&amp;(c=u);var l=i[1]\u003Ci[0],s=i[l-0],f=i[1-l],h=(f-s)/(n.length-u+2*c);return a=r(s+h*c,h),l&amp;&amp;a.reverse(),o=h*(1-u),t={t:\\\&quot;rangeBands\\\&quot;,a:arguments},e},e.rangeRoundBands=function(i,u,c){arguments.length\u003C2&amp;&amp;(u=0),arguments.length\u003C3&amp;&amp;(c=u);var l=i[1]\u003Ci[0],s=i[l-0],f=i[1-l],h=Math.floor((f-s)/(n.length-u+2*c)),g=f-s-(n.length-u)*h;return a=r(s+Math.round(g/2),h),l&amp;&amp;a.reverse(),o=Math.round(h*(1-u)),t={t:\\\&quot;rangeRoundBands\\\&quot;,a:arguments},e},e.rangeBand=function(){return o},e.rangeExtent=function(){return Ii(t.a[0])},e.copy=function(){return uu(n,t)},e.domain(n)}function au(n,t){function e(){var e=0,u=t.length;for(i=[];++e\u003Cu;)i[e-1]=da.quantile(n,e/u);return r}function r(n){return isNaN(n=+n)?void 0:t[da.bisect(i,n)]}var i;return r.domain=function(t){return arguments.length?(n=t.filter(function(n){return!isNaN(n)}).sort(da.ascending),e()):n},r.range=function(n){return arguments.length?(t=n,e()):t},r.quantiles=function(){return i},r.invertExtent=function(e){return e=t.indexOf(e),0&gt;e?[0/0,0/0]:[e&gt;0?i[e-1]:n[0],e\u003Ci.length?i[e]:n[n.length-1]]},r.copy=function(){return au(n,t)},e()}function ou(n,t,e){function r(t){return e[Math.max(0,Math.min(a,Math.floor(u*(t-n))))]}function i(){return u=e.length/(t-n),a=e.length-1,r}var u,a;return r.domain=function(e){return arguments.length?(n=+e[0],t=+e[e.length-1],i()):[n,t]},r.range=function(n){return arguments.length?(e=n,i()):e},r.invertExtent=function(t){return t=e.indexOf(t),t=0&gt;t?0/0:t/u+n,[t,t+1/u]},r.copy=function(){return ou(n,t,e)},i()}function cu(n,t){function e(e){return e&gt;=e?t[da.bisect(n,e)]:void 0}return e.domain=function(t){return arguments.length?(n=t,e):n},e.range=function(n){return arguments.length?(t=n,e):t},e.invertExtent=function(e){return e=t.indexOf(e),[n[e-1],n[e]]},e.copy=function(){return cu(n,t)},e}function lu(n){function t(n){return+n}return t.invert=t,t.domain=t.range=function(e){return arguments.length?(n=e.map(t),t):n},t.ticks=function(t){return nu(n,t)},t.tickFormat=function(t,e){return tu(n,t,e)},t.copy=function(){return lu(n)},t}function su(n){return n.innerRadius}function fu(n){return n.outerRadius}function hu(n){return n.startAngle}function gu(n){return n.endAngle}function pu(n){for(var t,e,r,i=-1,u=n.length;++i\u003Cu;)t=n[i],e=t[0],r=t[1]+qc,t[0]=e*Math.cos(r),t[1]=e*Math.sin(r);return n}function du(n){function t(t){function c(){d.push(\\\&quot;M\\\&quot;,o(n(v),f),s,l(n(m.reverse()),f),\\\&quot;Z\\\&quot;)}for(var h,g,p,d=[],m=[],v=[],y=-1,M=t.length,x=ht(e),b=ht(i),_=e===r?function(){return g}:ht(r),w=i===u?function(){return p}:ht(u);++y\u003CM;)a.call(this,h=t[y],y)?(m.push([g=+x.call(this,h,y),p=+b.call(this,h,y)]),v.push([+_.call(this,h,y),+w.call(this,h,y)])):m.length&amp;&amp;(c(),m=[],v=[]);return m.length&amp;&amp;c(),d.length?d.join(\\\&quot;\\\&quot;):null}var e=Ye,r=Ye,i=0,u=Re,a=Ut,o=Ue,c=o.key,l=o,s=\\\&quot;L\\\&quot;,f=.7;return t.x=function(n){return arguments.length?(e=r=n,t):r},t.x0=function(n){return arguments.length?(e=n,t):e},t.x1=function(n){return arguments.length?(r=n,t):r},t.y=function(n){return arguments.length?(i=u=n,t):u},t.y0=function(n){return arguments.length?(i=n,t):i},t.y1=function(n){return arguments.length?(u=n,t):u},t.defined=function(n){return arguments.length?(a=n,t):a},t.interpolate=function(n){return arguments.length?(c=\\\&quot;function\\\&quot;==typeof n?o=n:(o=ac.get(n)||Ue).key,l=o.reverse||o,s=o.closed?\\\&quot;M\\\&quot;:\\\&quot;L\\\&quot;,t):c},t.tension=function(n){return arguments.length?(f=n,t):f},t}function mu(n){return n.radius}function vu(n){return[n.x,n.y]}function yu(n){return function(){var t=n.apply(this,arguments),e=t[0],r=t[1]+qc;return[e*Math.cos(r),e*Math.sin(r)]}}function Mu(){return 64}function xu(){return\\\&quot;circle\\\&quot;}function bu(n){var t=Math.sqrt(n/Wa);return\\\&quot;M0,\\\&quot;+t+\\\&quot;A\\\&quot;+t+\\\&quot;,\\\&quot;+t+\\\&quot; 0 1,1 0,\\\&quot;+-t+\\\&quot;A\\\&quot;+t+\\\&quot;,\\\&quot;+t+\\\&quot; 0 1,1 0,\\\&quot;+t+\\\&quot;Z\\\&quot;}function _u(n,t){return za(n,Hc),n.id=t,n}function wu(n,t,e,r){var i=n.id;return T(n,\\\&quot;function\\\&quot;==typeof e?function(n,u,a){n.__transition__[i].tween.set(t,r(e.call(n,n.__data__,u,a)))}:(e=r(e),function(n){n.__transition__[i].tween.set(t,e)}))}function Su(n){return null==n&amp;&amp;(n=\\\&quot;\\\&quot;),function(){this.textContent=n}}function Eu(n,t,e,r){var u=n.__transition__||(n.__transition__={active:0,count:0}),a=u[e];if(!a){var o=r.time;return a=u[e]={tween:new i,time:o,ease:r.ease,delay:r.delay,duration:r.duration},++u.count,da.timer(function(r){function i(r){return u.active&gt;e?l():(u.active=e,a.event&amp;&amp;a.event.start.call(n,s,t),a.tween.forEach(function(e,r){(r=r.call(n,s,t))&amp;&amp;p.push(r)}),c(r)||da.timer(c,0,o),1)}function c(r){if(u.active!==e)return l();for(var i=(r-h)/g,o=f(i),c=p.length;c&gt;0;)p[--c].call(n,o);return i&gt;=1?(l(),a.event&amp;&amp;a.event.end.call(n,s,t),1):void 0}function l(){return--u.count?delete u[e]:delete n.__transition__,1}var s=n.__data__,f=a.ease,h=a.delay,g=a.duration,p=[];return r&gt;=h?i(r):da.timer(i,h,o),1},0,o),a}}function ku(n,t){n.attr(\\\&quot;transform\\\&quot;,function(n){return\\\&quot;translate(\\\&quot;+t(n)+\\\&quot;,0)\\\&quot;})}function Au(n,t){n.attr(\\\&quot;transform\\\&quot;,function(n){return\\\&quot;translate(0,\\\&quot;+t(n)+\\\&quot;)\\\&quot;})}function Nu(n,t,e){if(r=[],e&amp;&amp;t.length&gt;1){for(var r,i,u,a=Ii(n.domain()),o=-1,c=t.length,l=(t[1]-t[0])/++e;++o\u003Cc;)for(i=e;--i&gt;0;)(u=+t[o]-i*l)&gt;=a[0]&amp;&amp;r.push(u);for(--o,i=0;++i\u003Ce&amp;&amp;(u=+t[o]+i*l)\u003Ca[1];)r.push(u)}return r}function qu(){this._=new Date(arguments.length&gt;1?Date.UTC.apply(this,arguments):arguments[0])}function Tu(n,t,e){function r(t){var e=n(t),r=u(e,1);return r-t&gt;t-e?e:r}function i(e){return t(e=n(new Uc(e-1)),1),e}function u(n,e){return t(n=new Uc(+n),e),n}function a(n,r,u){var a=i(n),o=[];if(u&gt;1)for(;r&gt;a;)e(a)%u||o.push(new Date(+a)),t(a,1);else for(;r&gt;a;)o.push(new Date(+a)),t(a,1);return o}function o(n,t,e){try{Uc=qu;var r=new qu;return r._=n,a(r,t,e)}finally{Uc=Date}}n.floor=n,n.round=r,n.ceil=i,n.offset=u,n.range=a;var c=n.utc=Cu(n);return c.floor=c,c.round=Cu(r),c.ceil=Cu(i),c.offset=Cu(u),c.range=o,n}function Cu(n){return function(t,e){try{Uc=qu;var r=new qu;return r._=t,n(r,e)._}finally{Uc=Date}}}function zu(n,t,e,r){for(var i,u,a=0,o=t.length,c=e.length;o&gt;a;){if(r&gt;=c)return-1;if(i=t.charCodeAt(a++),37===i){if(u=ll[t.charAt(a++)],!u||(r=u(n,e,r))\u003C0)return-1}else if(i!=e.charCodeAt(r++))return-1}return r}function Du(n){return new RegExp(\\\&quot;^(?:\\\&quot;+n.map(da.requote).join(\\\&quot;|\\\&quot;)+\\\&quot;)\\\&quot;,\\\&quot;i\\\&quot;)}function ju(n){for(var t=new i,e=-1,r=n.length;++e\u003Cr;)t.set(n[e].toLowerCase(),e);return t}function Lu(n,t,e){var r=0&gt;n?\\\&quot;-\\\&quot;:\\\&quot;\\\&quot;,i=(r?-n:n)+\\\&quot;\\\&quot;,u=i.length;return r+(e&gt;u?new Array(e-u+1).join(t)+i:i)}function Hu(n,t,e){nl.lastIndex=0;var r=nl.exec(t.substring(e));return r?(n.w=tl.get(r[0].toLowerCase()),e+r[0].length):-1}function Fu(n,t,e){Kc.lastIndex=0;var r=Kc.exec(t.substring(e));return r?(n.w=Qc.get(r[0].toLowerCase()),e+r[0].length):-1}function Pu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+1));return r?(n.w=+r[0],e+r[0].length):-1}function Ou(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e));return r?(n.U=+r[0],e+r[0].length):-1}function Yu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e));return r?(n.W=+r[0],e+r[0].length):-1}function Ru(n,t,e){il.lastIndex=0;var r=il.exec(t.substring(e));return r?(n.m=ul.get(r[0].toLowerCase()),e+r[0].length):-1}function Uu(n,t,e){el.lastIndex=0;var r=el.exec(t.substring(e));return r?(n.m=rl.get(r[0].toLowerCase()),e+r[0].length):-1}function Iu(n,t,e){return zu(n,cl.c.toString(),t,e)}function Vu(n,t,e){return zu(n,cl.x.toString(),t,e)}function Xu(n,t,e){return zu(n,cl.X.toString(),t,e)}function Zu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+4));return r?(n.y=+r[0],e+r[0].length):-1}function Bu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.y=$u(+r[0]),e+r[0].length):-1}function $u(n){return n+(n&gt;68?1900:2e3)}function Wu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.m=r[0]-1,e+r[0].length):-1}function Ju(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.d=+r[0],e+r[0].length):-1}function Gu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+3));return r?(n.j=+r[0],e+r[0].length):-1}function Ku(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.H=+r[0],e+r[0].length):-1}function Qu(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.M=+r[0],e+r[0].length):-1}function na(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+2));return r?(n.S=+r[0],e+r[0].length):-1}function ta(n,t,e){sl.lastIndex=0;var r=sl.exec(t.substring(e,e+3));return r?(n.L=+r[0],e+r[0].length):-1}function ea(n,t,e){var r=fl.get(t.substring(e,e+=2).toLowerCase());return null==r?-1:(n.p=r,e)}function ra(n){var t=n.getTimezoneOffset(),e=t&gt;0?\\\&quot;-\\\&quot;:\\\&quot;+\\\&quot;,r=~~(Math.abs(t)/60),i=Math.abs(t)%60;return e+Lu(r,\\\&quot;0\\\&quot;,2)+Lu(i,\\\&quot;0\\\&quot;,2)}function ia(n,t,e){al.lastIndex=0;var r=al.exec(t.substring(e,e+1));return r?e+r[0].length:-1}function ua(n){return n.toISOString()}function aa(n,t,e){function r(t){return n(t)}return r.invert=function(t){return oa(n.invert(t))},r.domain=function(t){return arguments.length?(n.domain(t),r):n.domain().map(oa)},r.nice=function(n){return r.domain(Zi(r.domain(),n))},r.ticks=function(e,i){var u=Ii(r.domain());if(\\\&quot;function\\\&quot;!=typeof e){var a=u[1]-u[0],o=a/e,c=da.bisect(gl,o);if(c==gl.length)return t.year(u,e);if(!c)return n.ticks(e).map(oa);Math.log(o/gl[c-1])\u003CMath.log(gl[c]/o)&amp;&amp;--c,e=t[c],i=e[1],e=e[0].range}return e(u[0],new Date(+u[1]+1),i)},r.tickFormat=function(){return e},r.copy=function(){return aa(n.copy(),t,e)},Ji(r,n)}function oa(n){return new Date(n)}function ca(n){return function(t){for(var e=n.length-1,r=n[e];!r[1](t);)r=n[--e];return r[0](t)}}function la(n){var t=new Date(n,0,1);return t.setFullYear(n),t}function sa(n){var t=n.getFullYear(),e=la(t),r=la(t+1);return t+(n-e)/(r-e)}function fa(n){var t=new Date(Date.UTC(n,0,1));return t.setUTCFullYear(n),t}function ha(n){var t=n.getUTCFullYear(),e=fa(t),r=fa(t+1);return t+(n-e)/(r-e)}function ga(n){return JSON.parse(n.responseText)}function pa(n){var t=ma.createRange();return t.selectNode(ma.body),t.createContextualFragment(n.responseText)}var da={version:\\\&quot;3.2.6\\\&quot;};Date.now||(Date.now=function(){return+new Date});var ma=document,va=ma.documentElement,ya=window;try{ma.createElement(\\\&quot;div\\\&quot;).style.setProperty(\\\&quot;opacity\\\&quot;,0,\\\&quot;\\\&quot;)}catch(Ma){var xa=ya.Element.prototype,ba=xa.setAttribute,_a=xa.setAttributeNS,wa=ya.CSSStyleDeclaration.prototype,Sa=wa.setProperty;xa.setAttribute=function(n,t){ba.call(this,n,t+\\\&quot;\\\&quot;)},xa.setAttributeNS=function(n,t,e){_a.call(this,n,t,e+\\\&quot;\\\&quot;)},wa.setProperty=function(n,t,e){Sa.call(this,n,t+\\\&quot;\\\&quot;,e)}}da.ascending=function(n,t){return t&gt;n?-1:n&gt;t?1:n&gt;=t?0:0/0},da.descending=function(n,t){return n&gt;t?-1:t&gt;n?1:t&gt;=n?0:0/0},da.min=function(n,t){var e,r,i=-1,u=n.length;if(1===arguments.length){for(;++i\u003Cu&amp;&amp;!(null!=(e=n[i])&amp;&amp;e&gt;=e);)e=void 0;for(;++i\u003Cu;)null!=(r=n[i])&amp;&amp;e&gt;r&amp;&amp;(e=r)}else{for(;++i\u003Cu&amp;&amp;!(null!=(e=t.call(n,n[i],i))&amp;&amp;e&gt;=e);)e=void 0;for(;++i\u003Cu;)null!=(r=t.call(n,n[i],i))&amp;&amp;e&gt;r&amp;&amp;(e=r)}return e},da.max=function(n,t){var e,r,i=-1,u=n.length;if(1===arguments.length){for(;++i\u003Cu&amp;&amp;!(null!=(e=n[i])&amp;&amp;e&gt;=e);)e=void 0;for(;++i\u003Cu;)null!=(r=n[i])&amp;&amp;r&gt;e&amp;&amp;(e=r)}else{for(;++i\u003Cu&amp;&amp;!(null!=(e=t.call(n,n[i],i))&amp;&amp;e&gt;=e);)e=void 0;for(;++i\u003Cu;)null!=(r=t.call(n,n[i],i))&amp;&amp;r&gt;e&amp;&amp;(e=r)}return e},da.extent=function(n,t){var e,r,i,u=-1,a=n.length;if(1===arguments.length){for(;++u\u003Ca&amp;&amp;!(null!=(e=i=n[u])&amp;&amp;e&gt;=e);)e=i=void 0;for(;++u\u003Ca;)null!=(r=n[u])&amp;&amp;(e&gt;r&amp;&amp;(e=r),r&gt;i&amp;&amp;(i=r))}else{for(;++u\u003Ca&amp;&amp;!(null!=(e=i=t.call(n,n[u],u))&amp;&amp;e&gt;=e);)e=void 0;for(;++u\u003Ca;)null!=(r=t.call(n,n[u],u))&amp;&amp;(e&gt;r&amp;&amp;(e=r),r&gt;i&amp;&amp;(i=r))}return[e,i]},da.sum=function(n,t){var e,r=0,i=n.length,u=-1;if(1===arguments.length)for(;++u\u003Ci;)isNaN(e=+n[u])||(r+=e);else for(;++u\u003Ci;)isNaN(e=+t.call(n,n[u],u))||(r+=e);return r},da.mean=function(t,e){var r,i=t.length,u=0,a=-1,o=0;if(1===arguments.length)for(;++a\u003Ci;)n(r=t[a])&amp;&amp;(u+=(r-u)/++o);else for(;++a\u003Ci;)n(r=e.call(t,t[a],a))&amp;&amp;(u+=(r-u)/++o);return o?u:void 0},da.quantile=function(n,t){var e=(n.length-1)*t+1,r=Math.floor(e),i=+n[r-1],u=e-r;return u?i+u*(n[r]-i):i},da.median=function(t,e){return arguments.length&gt;1&amp;&amp;(t=t.map(e)),t=t.filter(n),t.length?da.quantile(t.sort(da.ascending),.5):void 0},da.bisector=function(n){return{left:function(t,e,r,i){for(arguments.length\u003C3&amp;&amp;(r=0),arguments.length\u003C4&amp;&amp;(i=t.length);i&gt;r;){var u=r+i&gt;&gt;&gt;1;n.call(t,t[u],u)\u003Ce?r=u+1:i=u}return r},right:function(t,e,r,i){for(arguments.length\u003C3&amp;&amp;(r=0),arguments.length\u003C4&amp;&amp;(i=t.length);i&gt;r;){var u=r+i&gt;&gt;&gt;1;e\u003Cn.call(t,t[u],u)?i=u:r=u+1}return r}}};var Ea=da.bisector(function(n){return n});da.bisectLeft=Ea.left,da.bisect=da.bisectRight=Ea.right,da.shuffle=function(n){for(var t,e,r=n.length;r;)e=0|Math.random()*r--,t=n[r],n[r]=n[e],n[e]=t;return n},da.permute=function(n,t){for(var e=[],r=-1,i=t.length;++r\u003Ci;)e[r]=n[t[r]];return e},da.zip=function(){if(!(i=arguments.length))return[];for(var n=-1,e=da.min(arguments,t),r=new Array(e);++n\u003Ce;)for(var i,u=-1,a=r[n]=new Array(i);++u\u003Ci;)a[u]=arguments[u][n];return r},da.transpose=function(n){return da.zip.apply(da,n)},da.keys=function(n){var t=[];for(var e in n)t.push(e);return t},da.values=function(n){var t=[];for(var e in n)t.push(n[e]);return t},da.entries=function(n){var t=[];for(var e in n)t.push({key:e,value:n[e]});return t},da.merge=function(n){return Array.prototype.concat.apply([],n)},da.range=function(n,t,r){if(arguments.length\u003C3&amp;&amp;(r=1,arguments.length\u003C2&amp;&amp;(t=n,n=0)),1/0===(t-n)/r)throw new Error(\\\&quot;infinite range\\\&quot;);var i,u=[],a=e(Math.abs(r)),o=-1;if(n*=a,t*=a,r*=a,0&gt;r)for(;(i=n+r*++o)&gt;t;)u.push(i/a);else for(;(i=n+r*++o)\u003Ct;)u.push(i/a);return u},da.map=function(n){var t=new i;for(var e in n)t.set(e,n[e]);return t},r(i,{has:function(n){return ka+n in this},get:function(n){return this[ka+n]},set:function(n,t){return this[ka+n]=t},remove:function(n){return n=ka+n,n in this&amp;&amp;delete this[n]},keys:function(){var n=[];return this.forEach(function(t){n.push(t)}),n},values:function(){var n=[];return this.forEach(function(t,e){n.push(e)}),n},entries:function(){var n=[];return this.forEach(function(t,e){n.push({key:t,value:e})}),n},forEach:function(n){for(var t in this)t.charCodeAt(0)===Aa&amp;&amp;n.call(this,t.substring(1),this[t])\\n}});var ka=\\\&quot;\\\\0\\\&quot;,Aa=ka.charCodeAt(0);da.nest=function(){function n(t,o,c){if(c&gt;=a.length)return r?r.call(u,o):e?o.sort(e):o;for(var l,s,f,h,g=-1,p=o.length,d=a[c++],m=new i;++g\u003Cp;)(h=m.get(l=d(s=o[g])))?h.push(s):m.set(l,[s]);return t?(s=t(),f=function(e,r){s.set(e,n(t,r,c))}):(s={},f=function(e,r){s[e]=n(t,r,c)}),m.forEach(f),s}function t(n,e){if(e&gt;=a.length)return n;var r=[],i=o[e++];return n.forEach(function(n,i){r.push({key:n,values:t(i,e)})}),i?r.sort(function(n,t){return i(n.key,t.key)}):r}var e,r,u={},a=[],o=[];return u.map=function(t,e){return n(e,t,0)},u.entries=function(e){return t(n(da.map,e,0),0)},u.key=function(n){return a.push(n),u},u.sortKeys=function(n){return o[a.length-1]=n,u},u.sortValues=function(n){return e=n,u},u.rollup=function(n){return r=n,u},u},da.set=function(n){var t=new u;if(n)for(var e=0;e\u003Cn.length;e++)t.add(n[e]);return t},r(u,{has:function(n){return ka+n in this},add:function(n){return this[ka+n]=!0,n},remove:function(n){return n=ka+n,n in this&amp;&amp;delete this[n]},values:function(){var n=[];return this.forEach(function(t){n.push(t)}),n},forEach:function(n){for(var t in this)t.charCodeAt(0)===Aa&amp;&amp;n.call(this,t.substring(1))}}),da.behavior={},da.rebind=function(n,t){for(var e,r=1,i=arguments.length;++r\u003Ci;)n[e=arguments[r]]=a(n,t,t[e]);return n};var Na=[\\\&quot;webkit\\\&quot;,\\\&quot;ms\\\&quot;,\\\&quot;moz\\\&quot;,\\\&quot;Moz\\\&quot;,\\\&quot;o\\\&quot;,\\\&quot;O\\\&quot;],qa=l;try{qa(va.childNodes)[0].nodeType}catch(Ta){qa=c}da.dispatch=function(){for(var n=new f,t=-1,e=arguments.length;++t\u003Ce;)n[arguments[t]]=h(n);return n},f.prototype.on=function(n,t){var e=n.indexOf(\\\&quot;.\\\&quot;),r=\\\&quot;\\\&quot;;if(e&gt;=0&amp;&amp;(r=n.substring(e+1),n=n.substring(0,e)),n)return arguments.length\u003C2?this[n].on(r):this[n].on(r,t);if(2===arguments.length){if(null==t)for(n in this)this.hasOwnProperty(n)&amp;&amp;this[n].on(r,null);return this}},da.event=null,da.requote=function(n){return n.replace(Ca,\\\&quot;\\\\\\\\$&amp;\\\&quot;)};var Ca=/[\\\\\\\\\\\\^\\\\$\\\\*\\\\+\\\\?\\\\|\\\\[\\\\]\\\\(\\\\)\\\\.\\\\{\\\\}]/g,za={}.__proto__?function(n,t){n.__proto__=t}:function(n,t){for(var e in t)n[e]=t[e]},Da=function(n,t){return t.querySelector(n)},ja=function(n,t){return t.querySelectorAll(n)},La=va[o(va,\\\&quot;matchesSelector\\\&quot;)],Ha=function(n,t){return La.call(n,t)};\\\&quot;function\\\&quot;==typeof Sizzle&amp;&amp;(Da=function(n,t){return Sizzle(n,t)[0]||null},ja=function(n,t){return Sizzle.uniqueSort(Sizzle(n,t))},Ha=Sizzle.matchesSelector),da.selection=function(){return Ya};var Fa=da.selection.prototype=[];Fa.select=function(n){var t,e,r,i,u=[];n=v(n);for(var a=-1,o=this.length;++a\u003Co;){u.push(t=[]),t.parentNode=(r=this[a]).parentNode;for(var c=-1,l=r.length;++c\u003Cl;)(i=r[c])?(t.push(e=n.call(i,i.__data__,c,a)),e&amp;&amp;\\\&quot;__data__\\\&quot;in i&amp;&amp;(e.__data__=i.__data__)):t.push(null)}return m(u)},Fa.selectAll=function(n){var t,e,r=[];n=y(n);for(var i=-1,u=this.length;++i\u003Cu;)for(var a=this[i],o=-1,c=a.length;++o\u003Cc;)(e=a[o])&amp;&amp;(r.push(t=qa(n.call(e,e.__data__,o,i))),t.parentNode=e);return m(r)};var Pa={svg:\\\&quot;http://www.w3.org/2000/svg\\\&quot;,xhtml:\\\&quot;http://www.w3.org/1999/xhtml\\\&quot;,xlink:\\\&quot;http://www.w3.org/1999/xlink\\\&quot;,xml:\\\&quot;http://www.w3.org/XML/1998/namespace\\\&quot;,xmlns:\\\&quot;http://www.w3.org/2000/xmlns/\\\&quot;};da.ns={prefix:Pa,qualify:function(n){var t=n.indexOf(\\\&quot;:\\\&quot;),e=n;return t&gt;=0&amp;&amp;(e=n.substring(0,t),n=n.substring(t+1)),Pa.hasOwnProperty(e)?{space:Pa[e],local:n}:n}},Fa.attr=function(n,t){if(arguments.length\u003C2){if(\\\&quot;string\\\&quot;==typeof n){var e=this.node();return n=da.ns.qualify(n),n.local?e.getAttributeNS(n.space,n.local):e.getAttribute(n)}for(t in n)this.each(M(t,n[t]));return this}return this.each(M(n,t))},Fa.classed=function(n,t){if(arguments.length\u003C2){if(\\\&quot;string\\\&quot;==typeof n){var e=this.node(),r=(n=n.trim().split(/^|\\\\s+/g)).length,i=-1;if(t=e.classList){for(;++i\u003Cr;)if(!t.contains(n[i]))return!1}else for(t=e.getAttribute(\\\&quot;class\\\&quot;);++i\u003Cr;)if(!b(n[i]).test(t))return!1;return!0}for(t in n)this.each(_(t,n[t]));return this}return this.each(_(n,t))},Fa.style=function(n,t,e){var r=arguments.length;if(3&gt;r){if(\\\&quot;string\\\&quot;!=typeof n){2&gt;r&amp;&amp;(t=\\\&quot;\\\&quot;);for(e in n)this.each(S(e,n[e],t));return this}if(2&gt;r)return ya.getComputedStyle(this.node(),null).getPropertyValue(n);e=\\\&quot;\\\&quot;}return this.each(S(n,t,e))},Fa.property=function(n,t){if(arguments.length\u003C2){if(\\\&quot;string\\\&quot;==typeof n)return this.node()[n];for(t in n)this.each(E(t,n[t]));return this}return this.each(E(n,t))},Fa.text=function(n){return arguments.length?this.each(\\\&quot;function\\\&quot;==typeof n?function(){var t=n.apply(this,arguments);this.textContent=null==t?\\\&quot;\\\&quot;:t}:null==n?function(){this.textContent=\\\&quot;\\\&quot;}:function(){this.textContent=n}):this.node().textContent},Fa.html=function(n){return arguments.length?this.each(\\\&quot;function\\\&quot;==typeof n?function(){var t=n.apply(this,arguments);this.innerHTML=null==t?\\\&quot;\\\&quot;:t}:null==n?function(){this.innerHTML=\\\&quot;\\\&quot;}:function(){this.innerHTML=n}):this.node().innerHTML},Fa.append=function(n){return n=k(n),this.select(function(){return this.appendChild(n.apply(this,arguments))})},Fa.insert=function(n,t){return n=k(n),t=v(t),this.select(function(){return this.insertBefore(n.apply(this,arguments),t.apply(this,arguments))})},Fa.remove=function(){return this.each(function(){var n=this.parentNode;n&amp;&amp;n.removeChild(this)})},Fa.data=function(n,t){function e(n,e){var r,u,a,o=n.length,f=e.length,h=Math.min(o,f),g=new Array(f),p=new Array(f),d=new Array(o);if(t){var m,v=new i,y=new i,M=[];for(r=-1;++r\u003Co;)m=t.call(u=n[r],u.__data__,r),v.has(m)?d[r]=u:v.set(m,u),M.push(m);for(r=-1;++r\u003Cf;)m=t.call(e,a=e[r],r),(u=v.get(m))?(g[r]=u,u.__data__=a):y.has(m)||(p[r]=A(a)),y.set(m,a),v.remove(m);for(r=-1;++r\u003Co;)v.has(M[r])&amp;&amp;(d[r]=n[r])}else{for(r=-1;++r\u003Ch;)u=n[r],a=e[r],u?(u.__data__=a,g[r]=u):p[r]=A(a);for(;f&gt;r;++r)p[r]=A(e[r]);for(;o&gt;r;++r)d[r]=n[r]}p.update=g,p.parentNode=g.parentNode=d.parentNode=n.parentNode,c.push(p),l.push(g),s.push(d)}var r,u,a=-1,o=this.length;if(!arguments.length){for(n=new Array(o=(r=this[0]).length);++a\u003Co;)(u=r[a])&amp;&amp;(n[a]=u.__data__);return n}var c=C([]),l=m([]),s=m([]);if(\\\&quot;function\\\&quot;==typeof n)for(;++a\u003Co;)e(r=this[a],n.call(r,r.parentNode.__data__,a));else for(;++a\u003Co;)e(r=this[a],n);return l.enter=function(){return c},l.exit=function(){return s},l},Fa.datum=function(n){return arguments.length?this.property(\\\&quot;__data__\\\&quot;,n):this.property(\\\&quot;__data__\\\&quot;)},Fa.filter=function(n){var t,e,r,i=[];\\\&quot;function\\\&quot;!=typeof n&amp;&amp;(n=N(n));for(var u=0,a=this.length;a&gt;u;u++){i.push(t=[]),t.parentNode=(e=this[u]).parentNode;for(var o=0,c=e.length;c&gt;o;o++)(r=e[o])&amp;&amp;n.call(r,r.__data__,o)&amp;&amp;t.push(r)}return m(i)},Fa.order=function(){for(var n=-1,t=this.length;++n\u003Ct;)for(var e,r=this[n],i=r.length-1,u=r[i];--i&gt;=0;)(e=r[i])&amp;&amp;(u&amp;&amp;u!==e.nextSibling&amp;&amp;u.parentNode.insertBefore(e,u),u=e);return this},Fa.sort=function(n){n=q.apply(this,arguments);for(var t=-1,e=this.length;++t\u003Ce;)this[t].sort(n);return this.order()},Fa.each=function(n){return T(this,function(t,e,r){n.call(t,t.__data__,e,r)})},Fa.call=function(n){var t=qa(arguments);return n.apply(t[0]=this,t),this},Fa.empty=function(){return!this.node()},Fa.node=function(){for(var n=0,t=this.length;t&gt;n;n++)for(var e=this[n],r=0,i=e.length;i&gt;r;r++){var u=e[r];if(u)return u}return null},Fa.size=function(){var n=0;return this.each(function(){++n}),n};var Oa=[];da.selection.enter=C,da.selection.enter.prototype=Oa,Oa.append=Fa.append,Oa.empty=Fa.empty,Oa.node=Fa.node,Oa.call=Fa.call,Oa.size=Fa.size,Oa.select=function(n){for(var t,e,r,i,u,a=[],o=-1,c=this.length;++o\u003Cc;){r=(i=this[o]).update,a.push(t=[]),t.parentNode=i.parentNode;for(var l=-1,s=i.length;++l\u003Cs;)(u=i[l])?(t.push(r[l]=e=n.call(i.parentNode,u.__data__,l,o)),e.__data__=u.__data__):t.push(null)}return m(a)},Oa.insert=function(n,t){return arguments.length\u003C2&amp;&amp;(t=z(this)),Fa.insert.call(this,n,t)},Fa.transition=function(){for(var n,t,e=zc||++Fc,r=[],i=Dc||{time:Date.now(),ease:Nr,delay:0,duration:250},u=-1,a=this.length;++u\u003Ca;){r.push(n=[]);for(var o=this[u],c=-1,l=o.length;++c\u003Cl;)(t=o[c])&amp;&amp;Eu(t,c,e,i),n.push(t)}return _u(r,e)},da.select=function(n){var t=[\\\&quot;string\\\&quot;==typeof n?Da(n,ma):n];return t.parentNode=va,m([t])},da.selectAll=function(n){var t=qa(\\\&quot;string\\\&quot;==typeof n?ja(n,ma):n);return t.parentNode=va,m([t])};var Ya=da.select(va);Fa.on=function(n,t,e){var r=arguments.length;if(3&gt;r){if(\\\&quot;string\\\&quot;!=typeof n){2&gt;r&amp;&amp;(t=!1);for(e in n)this.each(D(e,n[e],t));return this}if(2&gt;r)return(r=this.node()[\\\&quot;__on\\\&quot;+n])&amp;&amp;r._;e=!1}return this.each(D(n,t,e))};var Ra=da.map({mouseenter:\\\&quot;mouseover\\\&quot;,mouseleave:\\\&quot;mouseout\\\&quot;});Ra.forEach(function(n){\\\&quot;on\\\&quot;+n in ma&amp;&amp;Ra.remove(n)});var Ua=o(va.style,\\\&quot;userSelect\\\&quot;),Ia=0;da.mouse=function(n){return F(n,p())};var Va=/WebKit/.test(ya.navigator.userAgent)?-1:0;da.touches=function(n,t){return arguments.length\u003C2&amp;&amp;(t=p().touches),t?qa(t).map(function(t){var e=F(n,t);return e.identifier=t.identifier,e}):[]},da.behavior.drag=function(){function n(){this.on(\\\&quot;mousedown.drag\\\&quot;,a).on(\\\&quot;touchstart.drag\\\&quot;,o)}function t(){return da.event.changedTouches[0].identifier}function e(n,t){return da.touches(n).filter(function(n){return n.identifier===t})[0]}function r(n,t,e,r){return function(){function a(){if(!s)return o();var n=t(s,g),e=n[0]-d[0],r=n[1]-d[1];m|=e|r,d=n,f({type:\\\&quot;drag\\\&quot;,x:n[0]+c[0],y:n[1]+c[1],dx:e,dy:r})}function o(){v.on(e+\\\&quot;.\\\&quot;+p,null).on(r+\\\&quot;.\\\&quot;+p,null),y(m&amp;&amp;da.event.target===h),f({type:\\\&quot;dragend\\\&quot;})}var c,l=this,s=l.parentNode,f=i.of(l,arguments),h=da.event.target,g=n(),p=null==g?\\\&quot;drag\\\&quot;:\\\&quot;drag-\\\&quot;+g,d=t(s,g),m=0,v=da.select(ya).on(e+\\\&quot;.\\\&quot;+p,a).on(r+\\\&quot;.\\\&quot;+p,o),y=H();u?(c=u.apply(l,arguments),c=[c.x-d[0],c.y-d[1]]):c=[0,0],f({type:\\\&quot;dragstart\\\&quot;})}}var i=d(n,\\\&quot;drag\\\&quot;,\\\&quot;dragstart\\\&quot;,\\\&quot;dragend\\\&quot;),u=null,a=r(s,da.mouse,\\\&quot;mousemove\\\&quot;,\\\&quot;mouseup\\\&quot;),o=r(t,e,\\\&quot;touchmove\\\&quot;,\\\&quot;touchend\\\&quot;);return n.origin=function(t){return arguments.length?(u=t,n):u},da.rebind(n,i,\\\&quot;on\\\&quot;)},da.behavior.zoom=function(){function n(){this.on(E,o).on(Ba+\\\&quot;.zoom\\\&quot;,l).on(k,s).on(\\\&quot;dblclick.zoom\\\&quot;,f).on(\\\&quot;touchstart.zoom\\\&quot;,c)}function t(n){return[(n[0]-_[0])/w,(n[1]-_[1])/w]}function e(n){return[n[0]*w+_[0],n[1]*w+_[1]]}function r(n){w=Math.max(S[0],Math.min(S[1],n))}function i(n,t){t=e(t),_[0]+=n[0]-t[0],_[1]+=n[1]-t[1]}function u(){y&amp;&amp;y.domain(v.range().map(function(n){return(n-_[0])/w}).map(v.invert)),x&amp;&amp;x.domain(M.range().map(function(n){return(n-_[1])/w}).map(M.invert))}function a(n){u(),n({type:\\\&quot;zoom\\\&quot;,scale:w,translate:_})}function o(){function n(){c=1,i(da.mouse(r),f),a(u)}function e(){l.on(k,ya===r?s:null).on(A,null),h(c&amp;&amp;da.event.target===o)}var r=this,u=N.of(r,arguments),o=da.event.target,c=0,l=da.select(ya).on(k,n).on(A,e),f=t(da.mouse(r)),h=H()}function c(){function n(){var n=da.touches(u),t=n[0],e=h[t.identifier];if(c=n[1]){var c,l=h[c.identifier],s=da.event.scale;if(null==s){var f=(f=c[0]-t[0])*f+(f=c[1]-t[1])*f;s=p&amp;&amp;Math.sqrt(f/p)}t=[(t[0]+c[0])/2,(t[1]+c[1])/2],e=[(e[0]+l[0])/2,(e[1]+l[1])/2],r(s*m)}b=null,i(t,e),a(o)}function e(){v.on(f,null).on(d,null),y()}var u=this,o=N.of(u,arguments),c=da.touches(u),l=Date.now(),s=\\\&quot;zoom-\\\&quot;+da.event.changedTouches[0].identifier,f=\\\&quot;touchmove.\\\&quot;+s,d=\\\&quot;touchend.\\\&quot;+s,v=da.select(ya).on(f,n).on(d,e).on(E,null).on(k,null),y=H();if(m=w,h={},p=0,c.forEach(function(n){h[n.identifier]=t(n)}),1===c.length){if(500&gt;l-b){var M=c[0],x=t(c[0]);r(2*w),i(M,x),g(),a(o)}b=l}else if(c.length&gt;1){var M=c[0],_=c[1],S=M[0]-_[0],A=M[1]-_[1];p=S*S+A*A}}function l(){g(),h||(h=t(da.mouse(this))),r(Math.pow(2,.002*Xa())*w),i(da.mouse(this),h),a(N.of(this,arguments))}function s(){h=null}function f(){var n=da.mouse(this),e=t(n),u=Math.log(w)/Math.LN2;r(Math.pow(2,da.event.shiftKey?Math.ceil(u)-1:Math.floor(u)+1)),i(n,e),a(N.of(this,arguments))}var h,p,m,v,y,M,x,b,_=[0,0],w=1,S=Za,E=\\\&quot;mousedown.zoom\\\&quot;,k=\\\&quot;mousemove.zoom\\\&quot;,A=\\\&quot;mouseup.zoom\\\&quot;,N=d(n,\\\&quot;zoom\\\&quot;);return n.translate=function(t){return arguments.length?(_=t.map(Number),u(),n):_},n.scale=function(t){return arguments.length?(w=+t,u(),n):w},n.scaleExtent=function(t){return arguments.length?(S=null==t?Za:t.map(Number),n):S},n.x=function(t){return arguments.length?(y=t,v=t.copy(),_=[0,0],w=1,n):y},n.y=function(t){return arguments.length?(x=t,M=t.copy(),_=[0,0],w=1,n):x},da.rebind(n,N,\\\&quot;on\\\&quot;)};var Xa,Za=[0,1/0],Ba=\\\&quot;onwheel\\\&quot;in ma?(Xa=function(){return-da.event.deltaY*(da.event.deltaMode?120:1)},\\\&quot;wheel\\\&quot;):\\\&quot;onmousewheel\\\&quot;in ma?(Xa=function(){return da.event.wheelDelta},\\\&quot;mousewheel\\\&quot;):(Xa=function(){return-da.event.detail},\\\&quot;MozMousePixelScroll\\\&quot;);P.prototype.toString=function(){return this.rgb()+\\\&quot;\\\&quot;},da.hsl=function(n,t,e){return 1===arguments.length?n instanceof Y?O(n.h,n.s,n.l):ot(\\\&quot;\\\&quot;+n,ct,O):O(+n,+t,+e)};var $a=Y.prototype=new P;$a.brighter=function(n){return n=Math.pow(.7,arguments.length?n:1),O(this.h,this.s,this.l/n)},$a.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),O(this.h,this.s,n*this.l)},$a.rgb=function(){return R(this.h,this.s,this.l)};var Wa=Math.PI,Ja=1e-6,Ga=Ja*Ja,Ka=Wa/180,Qa=180/Wa;da.hcl=function(n,t,e){return 1===arguments.length?n instanceof W?$(n.h,n.c,n.l):n instanceof K?nt(n.l,n.a,n.b):nt((n=lt((n=da.rgb(n)).r,n.g,n.b)).l,n.a,n.b):$(+n,+t,+e)};var no=W.prototype=new P;no.brighter=function(n){return $(this.h,this.c,Math.min(100,this.l+to*(arguments.length?n:1)))},no.darker=function(n){return $(this.h,this.c,Math.max(0,this.l-to*(arguments.length?n:1)))},no.rgb=function(){return J(this.h,this.c,this.l).rgb()},da.lab=function(n,t,e){return 1===arguments.length?n instanceof K?G(n.l,n.a,n.b):n instanceof W?J(n.l,n.c,n.h):lt((n=da.rgb(n)).r,n.g,n.b):G(+n,+t,+e)};var to=18,eo=.95047,ro=1,io=1.08883,uo=K.prototype=new P;uo.brighter=function(n){return G(Math.min(100,this.l+to*(arguments.length?n:1)),this.a,this.b)},uo.darker=function(n){return G(Math.max(0,this.l-to*(arguments.length?n:1)),this.a,this.b)},uo.rgb=function(){return Q(this.l,this.a,this.b)},da.rgb=function(n,t,e){return 1===arguments.length?n instanceof ut?it(n.r,n.g,n.b):ot(\\\&quot;\\\&quot;+n,it,R):it(~~n,~~t,~~e)};var ao=ut.prototype=new P;ao.brighter=function(n){n=Math.pow(.7,arguments.length?n:1);var t=this.r,e=this.g,r=this.b,i=30;return t||e||r?(t&amp;&amp;i&gt;t&amp;&amp;(t=i),e&amp;&amp;i&gt;e&amp;&amp;(e=i),r&amp;&amp;i&gt;r&amp;&amp;(r=i),it(Math.min(255,Math.floor(t/n)),Math.min(255,Math.floor(e/n)),Math.min(255,Math.floor(r/n)))):it(i,i,i)},ao.darker=function(n){return n=Math.pow(.7,arguments.length?n:1),it(Math.floor(n*this.r),Math.floor(n*this.g),Math.floor(n*this.b))},ao.hsl=function(){return ct(this.r,this.g,this.b)},ao.toString=function(){return\\\&quot;#\\\&quot;+at(this.r)+at(this.g)+at(this.b)};var oo=da.map({aliceblue:\\\&quot;#f0f8ff\\\&quot;,antiquewhite:\\\&quot;#faebd7\\\&quot;,aqua:\\\&quot;#00ffff\\\&quot;,aquamarine:\\\&quot;#7fffd4\\\&quot;,azure:\\\&quot;#f0ffff\\\&quot;,beige:\\\&quot;#f5f5dc\\\&quot;,bisque:\\\&quot;#ffe4c4\\\&quot;,black:\\\&quot;#000000\\\&quot;,blanchedalmond:\\\&quot;#ffebcd\\\&quot;,blue:\\\&quot;#0000ff\\\&quot;,blueviolet:\\\&quot;#8a2be2\\\&quot;,brown:\\\&quot;#a52a2a\\\&quot;,burlywood:\\\&quot;#deb887\\\&quot;,cadetblue:\\\&quot;#5f9ea0\\\&quot;,chartreuse:\\\&quot;#7fff00\\\&quot;,chocolate:\\\&quot;#d2691e\\\&quot;,coral:\\\&quot;#ff7f50\\\&quot;,cornflowerblue:\\\&quot;#6495ed\\\&quot;,cornsilk:\\\&quot;#fff8dc\\\&quot;,crimson:\\\&quot;#dc143c\\\&quot;,cyan:\\\&quot;#00ffff\\\&quot;,darkblue:\\\&quot;#00008b\\\&quot;,darkcyan:\\\&quot;#008b8b\\\&quot;,darkgoldenrod:\\\&quot;#b8860b\\\&quot;,darkgray:\\\&quot;#a9a9a9\\\&quot;,darkgreen:\\\&quot;#006400\\\&quot;,darkgrey:\\\&quot;#a9a9a9\\\&quot;,darkkhaki:\\\&quot;#bdb76b\\\&quot;,darkmagenta:\\\&quot;#8b008b\\\&quot;,darkolivegreen:\\\&quot;#556b2f\\\&quot;,darkorange:\\\&quot;#ff8c00\\\&quot;,darkorchid:\\\&quot;#9932cc\\\&quot;,darkred:\\\&quot;#8b0000\\\&quot;,darksalmon:\\\&quot;#e9967a\\\&quot;,darkseagreen:\\\&quot;#8fbc8f\\\&quot;,darkslateblue:\\\&quot;#483d8b\\\&quot;,darkslategray:\\\&quot;#2f4f4f\\\&quot;,darkslategrey:\\\&quot;#2f4f4f\\\&quot;,darkturquoise:\\\&quot;#00ced1\\\&quot;,darkviolet:\\\&quot;#9400d3\\\&quot;,deeppink:\\\&quot;#ff1493\\\&quot;,deepskyblue:\\\&quot;#00bfff\\\&quot;,dimgray:\\\&quot;#696969\\\&quot;,dimgrey:\\\&quot;#696969\\\&quot;,dodgerblue:\\\&quot;#1e90ff\\\&quot;,firebrick:\\\&quot;#b22222\\\&quot;,floralwhite:\\\&quot;#fffaf0\\\&quot;,forestgreen:\\\&quot;#228b22\\\&quot;,fuchsia:\\\&quot;#ff00ff\\\&quot;,gainsboro:\\\&quot;#dcdcdc\\\&quot;,ghostwhite:\\\&quot;#f8f8ff\\\&quot;,gold:\\\&quot;#ffd700\\\&quot;,goldenrod:\\\&quot;#daa520\\\&quot;,gray:\\\&quot;#808080\\\&quot;,green:\\\&quot;#008000\\\&quot;,greenyellow:\\\&quot;#adff2f\\\&quot;,grey:\\\&quot;#808080\\\&quot;,honeydew:\\\&quot;#f0fff0\\\&quot;,hotpink:\\\&quot;#ff69b4\\\&quot;,indianred:\\\&quot;#cd5c5c\\\&quot;,indigo:\\\&quot;#4b0082\\\&quot;,ivory:\\\&quot;#fffff0\\\&quot;,khaki:\\\&quot;#f0e68c\\\&quot;,lavender:\\\&quot;#e6e6fa\\\&quot;,lavenderblush:\\\&quot;#fff0f5\\\&quot;,lawngreen:\\\&quot;#7cfc00\\\&quot;,lemonchiffon:\\\&quot;#fffacd\\\&quot;,lightblue:\\\&quot;#add8e6\\\&quot;,lightcoral:\\\&quot;#f08080\\\&quot;,lightcyan:\\\&quot;#e0ffff\\\&quot;,lightgoldenrodyellow:\\\&quot;#fafad2\\\&quot;,lightgray:\\\&quot;#d3d3d3\\\&quot;,lightgreen:\\\&quot;#90ee90\\\&quot;,lightgrey:\\\&quot;#d3d3d3\\\&quot;,lightpink:\\\&quot;#ffb6c1\\\&quot;,lightsalmon:\\\&quot;#ffa07a\\\&quot;,lightseagreen:\\\&quot;#20b2aa\\\&quot;,lightskyblue:\\\&quot;#87cefa\\\&quot;,lightslategray:\\\&quot;#778899\\\&quot;,lightslategrey:\\\&quot;#778899\\\&quot;,lightsteelblue:\\\&quot;#b0c4de\\\&quot;,lightyellow:\\\&quot;#ffffe0\\\&quot;,lime:\\\&quot;#00ff00\\\&quot;,limegreen:\\\&quot;#32cd32\\\&quot;,linen:\\\&quot;#faf0e6\\\&quot;,magenta:\\\&quot;#ff00ff\\\&quot;,maroon:\\\&quot;#800000\\\&quot;,mediumaquamarine:\\\&quot;#66cdaa\\\&quot;,mediumblue:\\\&quot;#0000cd\\\&quot;,mediumorchid:\\\&quot;#ba55d3\\\&quot;,mediumpurple:\\\&quot;#9370db\\\&quot;,mediumseagreen:\\\&quot;#3cb371\\\&quot;,mediumslateblue:\\\&quot;#7b68ee\\\&quot;,mediumspringgreen:\\\&quot;#00fa9a\\\&quot;,mediumturquoise:\\\&quot;#48d1cc\\\&quot;,mediumvioletred:\\\&quot;#c71585\\\&quot;,midnightblue:\\\&quot;#191970\\\&quot;,mintcream:\\\&quot;#f5fffa\\\&quot;,mistyrose:\\\&quot;#ffe4e1\\\&quot;,moccasin:\\\&quot;#ffe4b5\\\&quot;,navajowhite:\\\&quot;#ffdead\\\&quot;,navy:\\\&quot;#000080\\\&quot;,oldlace:\\\&quot;#fdf5e6\\\&quot;,olive:\\\&quot;#808000\\\&quot;,olivedrab:\\\&quot;#6b8e23\\\&quot;,orange:\\\&quot;#ffa500\\\&quot;,orangered:\\\&quot;#ff4500\\\&quot;,orchid:\\\&quot;#da70d6\\\&quot;,palegoldenrod:\\\&quot;#eee8aa\\\&quot;,palegreen:\\\&quot;#98fb98\\\&quot;,paleturquoise:\\\&quot;#afeeee\\\&quot;,palevioletred:\\\&quot;#db7093\\\&quot;,papayawhip:\\\&quot;#ffefd5\\\&quot;,peachpuff:\\\&quot;#ffdab9\\\&quot;,peru:\\\&quot;#cd853f\\\&quot;,pink:\\\&quot;#ffc0cb\\\&quot;,plum:\\\&quot;#dda0dd\\\&quot;,powderblue:\\\&quot;#b0e0e6\\\&quot;,purple:\\\&quot;#800080\\\&quot;,red:\\\&quot;#ff0000\\\&quot;,rosybrown:\\\&quot;#bc8f8f\\\&quot;,royalblue:\\\&quot;#4169e1\\\&quot;,saddlebrown:\\\&quot;#8b4513\\\&quot;,salmon:\\\&quot;#fa8072\\\&quot;,sandybrown:\\\&quot;#f4a460\\\&quot;,seagreen:\\\&quot;#2e8b57\\\&quot;,seashell:\\\&quot;#fff5ee\\\&quot;,sienna:\\\&quot;#a0522d\\\&quot;,silver:\\\&quot;#c0c0c0\\\&quot;,skyblue:\\\&quot;#87ceeb\\\&quot;,slateblue:\\\&quot;#6a5acd\\\&quot;,slategray:\\\&quot;#708090\\\&quot;,slategrey:\\\&quot;#708090\\\&quot;,snow:\\\&quot;#fffafa\\\&quot;,springgreen:\\\&quot;#00ff7f\\\&quot;,steelblue:\\\&quot;#4682b4\\\&quot;,tan:\\\&quot;#d2b48c\\\&quot;,teal:\\\&quot;#008080\\\&quot;,thistle:\\\&quot;#d8bfd8\\\&quot;,tomato:\\\&quot;#ff6347\\\&quot;,turquoise:\\\&quot;#40e0d0\\\&quot;,violet:\\\&quot;#ee82ee\\\&quot;,wheat:\\\&quot;#f5deb3\\\&quot;,white:\\\&quot;#ffffff\\\&quot;,whitesmoke:\\\&quot;#f5f5f5\\\&quot;,yellow:\\\&quot;#ffff00\\\&quot;,yellowgreen:\\\&quot;#9acd32\\\&quot;});oo.forEach(function(n,t){oo.set(n,ot(t,it,R))}),da.functor=ht,da.xhr=pt(gt),da.dsv=function(n,t){function e(n,e,u){arguments.length\u003C3&amp;&amp;(u=e,e=null);var a=da.xhr(n,t,u);return a.row=function(n){return arguments.length?a.response(null==(e=n)?r:i(n)):e},a.row(e)}function r(n){return e.parse(n.responseText)}function i(n){return function(t){return e.parse(t.responseText,n)}}function a(t){return t.map(o).join(n)}function o(n){return c.test(n)?'\\\&quot;'+n.replace(/\\\\\\\&quot;/g,'\\\&quot;\\\&quot;')+'\\\&quot;':n}var c=new RegExp('[\\\&quot;'+n+\\\&quot;\\\\n]\\\&quot;),l=n.charCodeAt(0);return e.parse=function(n,t){var r;return e.parseRows(n,function(n,e){if(r)return r(n,e-1);var i=new Function(\\\&quot;d\\\&quot;,\\\&quot;return {\\\&quot;+n.map(function(n,t){return JSON.stringify(n)+\\\&quot;: d[\\\&quot;+t+\\\&quot;]\\\&quot;}).join(\\\&quot;,\\\&quot;)+\\\&quot;}\\\&quot;);r=t?function(n,e){return t(i(n),e)}:i})},e.parseRows=function(n,t){function e(){if(s&gt;=c)return a;if(i)return i=!1,u;var t=s;if(34===n.charCodeAt(t)){for(var e=t;e++\u003Cc;)if(34===n.charCodeAt(e)){if(34!==n.charCodeAt(e+1))break;++e}s=e+2;var r=n.charCodeAt(e+1);return 13===r?(i=!0,10===n.charCodeAt(e+2)&amp;&amp;++s):10===r&amp;&amp;(i=!0),n.substring(t+1,e).replace(/\\\&quot;\\\&quot;/g,'\\\&quot;')}for(;c&gt;s;){var r=n.charCodeAt(s++),o=1;if(10===r)i=!0;else if(13===r)i=!0,10===n.charCodeAt(s)&amp;&amp;(++s,++o);else if(r!==l)continue;return n.substring(t,s-o)}return n.substring(t)}for(var r,i,u={},a={},o=[],c=n.length,s=0,f=0;(r=e())!==a;){for(var h=[];r!==u&amp;&amp;r!==a;)h.push(r),r=e();(!t||(h=t(h,f++)))&amp;&amp;o.push(h)}return o},e.format=function(t){if(Array.isArray(t[0]))return e.formatRows(t);var r=new u,i=[];return t.forEach(function(n){for(var t in n)r.has(t)||i.push(r.add(t))}),[i.map(o).join(n)].concat(t.map(function(t){return i.map(function(n){return o(t[n])}).join(n)})).join(\\\&quot;\\\\n\\\&quot;)},e.formatRows=function(n){return n.map(a).join(\\\&quot;\\\\n\\\&quot;)},e},da.csv=da.dsv(\\\&quot;,\\\&quot;,\\\&quot;text/csv\\\&quot;),da.tsv=da.dsv(\\\&quot;\\t\\\&quot;,\\\&quot;text/tab-separated-values\\\&quot;);var co,lo,so,fo;da.timer=function(n,t,e){if(arguments.length\u003C3){if(arguments.length\u003C2)t=0;else if(!isFinite(t))return;e=Date.now()}var r=e+t,i={callback:n,time:r,next:null};lo?lo.next=i:co=i,lo=i,so||(fo=clearTimeout(fo),so=1,ho(vt))},da.timer.flush=function(){yt(),Mt()};var ho=ya[o(ya,\\\&quot;requestAnimationFrame\\\&quot;)]||function(n){setTimeout(n,17)},go=\\\&quot;.\\\&quot;,po=\\\&quot;,\\\&quot;,mo=[3,3],vo=\\\&quot;$\\\&quot;,yo=[\\\&quot;y\\\&quot;,\\\&quot;z\\\&quot;,\\\&quot;a\\\&quot;,\\\&quot;f\\\&quot;,\\\&quot;p\\\&quot;,\\\&quot;n\\\&quot;,\\\&quot;µ\\\&quot;,\\\&quot;m\\\&quot;,\\\&quot;\\\&quot;,\\\&quot;k\\\&quot;,\\\&quot;M\\\&quot;,\\\&quot;G\\\&quot;,\\\&quot;T\\\&quot;,\\\&quot;P\\\&quot;,\\\&quot;E\\\&quot;,\\\&quot;Z\\\&quot;,\\\&quot;Y\\\&quot;].map(xt);da.formatPrefix=function(n,t){var e=0;return n&amp;&amp;(0&gt;n&amp;&amp;(n*=-1),t&amp;&amp;(n=da.round(n,bt(n,t))),e=1+Math.floor(1e-12+Math.log(n)/Math.LN10),e=Math.max(-24,Math.min(24,3*Math.floor((0&gt;=e?e+1:e-1)/3)))),yo[8+e/3]},da.round=function(n,t){return t?Math.round(n*(t=Math.pow(10,t)))/t:Math.round(n)},da.format=function(n){var t=Mo.exec(n),e=t[1]||\\\&quot; \\\&quot;,r=t[2]||\\\&quot;&gt;\\\&quot;,i=t[3]||\\\&quot;\\\&quot;,u=t[4]||\\\&quot;\\\&quot;,a=t[5],o=+t[6],c=t[7],l=t[8],s=t[9],f=1,h=\\\&quot;\\\&quot;,g=!1;switch(l&amp;&amp;(l=+l.substring(1)),(a||\\\&quot;0\\\&quot;===e&amp;&amp;\\\&quot;=\\\&quot;===r)&amp;&amp;(a=e=\\\&quot;0\\\&quot;,r=\\\&quot;=\\\&quot;,c&amp;&amp;(o-=Math.floor((o-1)/4))),s){case\\\&quot;n\\\&quot;:c=!0,s=\\\&quot;g\\\&quot;;break;case\\\&quot;%\\\&quot;:f=100,h=\\\&quot;%\\\&quot;,s=\\\&quot;f\\\&quot;;break;case\\\&quot;p\\\&quot;:f=100,h=\\\&quot;%\\\&quot;,s=\\\&quot;r\\\&quot;;break;case\\\&quot;b\\\&quot;:case\\\&quot;o\\\&quot;:case\\\&quot;x\\\&quot;:case\\\&quot;X\\\&quot;:\\\&quot;#\\\&quot;===u&amp;&amp;(u=\\\&quot;0\\\&quot;+s.toLowerCase());case\\\&quot;c\\\&quot;:case\\\&quot;d\\\&quot;:g=!0,l=0;break;case\\\&quot;s\\\&quot;:f=-1,s=\\\&quot;r\\\&quot;}\\\&quot;#\\\&quot;===u?u=\\\&quot;\\\&quot;:\\\&quot;$\\\&quot;===u&amp;&amp;(u=vo),\\\&quot;r\\\&quot;!=s||l||(s=\\\&quot;g\\\&quot;),null!=l&amp;&amp;(\\\&quot;g\\\&quot;==s?l=Math.max(1,Math.min(21,l)):(\\\&quot;e\\\&quot;==s||\\\&quot;f\\\&quot;==s)&amp;&amp;(l=Math.max(0,Math.min(20,l)))),s=xo.get(s)||_t;var p=a&amp;&amp;c;return function(n){if(g&amp;&amp;n%1)return\\\&quot;\\\&quot;;var t=0&gt;n||0===n&amp;&amp;0&gt;1/n?(n=-n,\\\&quot;-\\\&quot;):i;if(0&gt;f){var d=da.formatPrefix(n,l);n=d.scale(n),h=d.symbol}else n*=f;n=s(n,l);var m=n.lastIndexOf(\\\&quot;.\\\&quot;),v=0&gt;m?n:n.substring(0,m),y=0&gt;m?\\\&quot;\\\&quot;:go+n.substring(m+1);!a&amp;&amp;c&amp;&amp;(v=bo(v));var M=u.length+v.length+y.length+(p?0:t.length),x=o&gt;M?new Array(M=o-M+1).join(e):\\\&quot;\\\&quot;;return p&amp;&amp;(v=bo(x+v)),t+=u,n=v+y,(\\\&quot;\u003C\\\&quot;===r?t+n+x:\\\&quot;&gt;\\\&quot;===r?x+t+n:\\\&quot;^\\\&quot;===r?x.substring(0,M&gt;&gt;=1)+t+n+x.substring(M):t+(p?n:x+n))+h}};var Mo=/(?:([^{])?([\u003C&gt;=^]))?([+\\\\- ])?([$#])?(0)?(\\\\d+)?(,)?(\\\\.-?\\\\d+)?([a-z%])?/i,xo=da.map({b:function(n){return n.toString(2)},c:function(n){return String.fromCharCode(n)},o:function(n){return n.toString(8)},x:function(n){return n.toString(16)},X:function(n){return n.toString(16).toUpperCase()},g:function(n,t){return n.toPrecision(t)},e:function(n,t){return n.toExponential(t)},f:function(n,t){return n.toFixed(t)},r:function(n,t){return(n=da.round(n,bt(n,t))).toFixed(Math.max(0,Math.min(20,bt(n*(1+1e-15),t))))}}),bo=gt;if(mo){var _o=mo.length;bo=function(n){for(var t=n.length,e=[],r=0,i=mo[0];t&gt;0&amp;&amp;i&gt;0;)e.push(n.substring(t-=i,t+i)),i=mo[r=(r+1)%_o];return e.reverse().join(po)}}da.geo={},wt.prototype={s:0,t:0,add:function(n){St(n,this.t,wo),St(wo.s,this.s,this),this.s?this.t+=wo.t:this.s=wo.t},reset:function(){this.s=this.t=0},valueOf:function(){return this.s}};var wo=new wt;da.geo.stream=function(n,t){n&amp;&amp;So.hasOwnProperty(n.type)?So[n.type](n,t):Et(n,t)};var So={Feature:function(n,t){Et(n.geometry,t)},FeatureCollection:function(n,t){for(var e=n.features,r=-1,i=e.length;++r\u003Ci;)Et(e[r].geometry,t)}},Eo={Sphere:function(n,t){t.sphere()},Point:function(n,t){var e=n.coordinates;t.point(e[0],e[1])},MultiPoint:function(n,t){for(var e,r=n.coordinates,i=-1,u=r.length;++i\u003Cu;)e=r[i],t.point(e[0],e[1])},LineString:function(n,t){kt(n.coordinates,t,0)},MultiLineString:function(n,t){for(var e=n.coordinates,r=-1,i=e.length;++r\u003Ci;)kt(e[r],t,0)},Polygon:function(n,t){At(n.coordinates,t)},MultiPolygon:function(n,t){for(var e=n.coordinates,r=-1,i=e.length;++r\u003Ci;)At(e[r],t)},GeometryCollection:function(n,t){for(var e=n.geometries,r=-1,i=e.length;++r\u003Ci;)Et(e[r],t)}};da.geo.area=function(n){return ko=0,da.geo.stream(n,No),ko};var ko,Ao=new wt,No={sphere:function(){ko+=4*Wa},point:s,lineStart:s,lineEnd:s,polygonStart:function(){Ao.reset(),No.lineStart=Nt},polygonEnd:function(){var n=2*Ao;ko+=0&gt;n?4*Wa+n:n,No.lineStart=No.lineEnd=No.point=s}};da.geo.bounds=function(){function n(n,t){M.push(x=[s=n,h=n]),f&gt;t&amp;&amp;(f=t),t&gt;g&amp;&amp;(g=t)}function t(t,e){var r=qt([t*Ka,e*Ka]);if(v){var i=Ct(v,r),u=[i[1],-i[0],0],a=Ct(u,i);jt(a),a=Lt(a);var c=t-p,l=c&gt;0?1:-1,d=a[0]*Qa*l,m=Math.abs(c)&gt;180;if(m^(d&gt;l*p&amp;&amp;l*t&gt;d)){var y=a[1]*Qa;y&gt;g&amp;&amp;(g=y)}else if(d=(d+360)%360-180,m^(d&gt;l*p&amp;&amp;l*t&gt;d)){var y=-a[1]*Qa;f&gt;y&amp;&amp;(f=y)}else f&gt;e&amp;&amp;(f=e),e&gt;g&amp;&amp;(g=e);m?p&gt;t?o(s,t)&gt;o(s,h)&amp;&amp;(h=t):o(t,h)&gt;o(s,h)&amp;&amp;(s=t):h&gt;=s?(s&gt;t&amp;&amp;(s=t),t&gt;h&amp;&amp;(h=t)):t&gt;p?o(s,t)&gt;o(s,h)&amp;&amp;(h=t):o(t,h)&gt;o(s,h)&amp;&amp;(s=t)}else n(t,e);v=r,p=t}function e(){b.point=t}function r(){x[0]=s,x[1]=h,b.point=n,v=null}function i(n,e){if(v){var r=n-p;y+=Math.abs(r)&gt;180?r+(r&gt;0?360:-360):r}else d=n,m=e;No.point(n,e),t(n,e)}function u(){No.lineStart()}function a(){i(d,m),No.lineEnd(),Math.abs(y)&gt;Ja&amp;&amp;(s=-(h=180)),x[0]=s,x[1]=h,v=null}function o(n,t){return(t-=n)\u003C0?t+360:t}function c(n,t){return n[0]-t[0]}function l(n,t){return t[0]\u003C=t[1]?t[0]\u003C=n&amp;&amp;n\u003C=t[1]:n\u003Ct[0]||t[1]\u003Cn}var s,f,h,g,p,d,m,v,y,M,x,b={point:n,lineStart:e,lineEnd:r,polygonStart:function(){b.point=i,b.lineStart=u,b.lineEnd=a,y=0,No.polygonStart()},polygonEnd:function(){No.polygonEnd(),b.point=n,b.lineStart=e,b.lineEnd=r,0&gt;Ao?(s=-(h=180),f=-(g=90)):y&gt;Ja?g=90:-Ja&gt;y&amp;&amp;(f=-90),x[0]=s,x[1]=h}};return function(n){g=h=-(s=f=1/0),M=[],da.geo.stream(n,b);var t=M.length;if(t){M.sort(c);for(var e,r=1,i=M[0],u=[i];t&gt;r;++r)e=M[r],l(e[0],i)||l(e[1],i)?(o(i[0],e[1])&gt;o(i[0],i[1])&amp;&amp;(i[1]=e[1]),o(e[0],i[1])&gt;o(i[0],i[1])&amp;&amp;(i[0]=e[0])):u.push(i=e);for(var a,e,p=-1/0,t=u.length-1,r=0,i=u[t];t&gt;=r;i=e,++r)e=u[r],(a=o(i[1],e[0]))&gt;p&amp;&amp;(p=a,s=e[0],h=i[1])}return M=x=null,1/0===s||1/0===f?[[0/0,0/0],[0/0,0/0]]:[[s,f],[h,g]]}}(),da.geo.centroid=function(n){qo=To=Co=zo=Do=jo=Lo=Ho=Fo=Po=Oo=0,da.geo.stream(n,Yo);var t=Fo,e=Po,r=Oo,i=t*t+e*e+r*r;return Ga&gt;i&amp;&amp;(t=jo,e=Lo,r=Ho,Ja&gt;To&amp;&amp;(t=Co,e=zo,r=Do),i=t*t+e*e+r*r,Ga&gt;i)?[0/0,0/0]:[Math.atan2(e,t)*Qa,V(r/Math.sqrt(i))*Qa]};var qo,To,Co,zo,Do,jo,Lo,Ho,Fo,Po,Oo,Yo={sphere:s,point:Ft,lineStart:Ot,lineEnd:Yt,polygonStart:function(){Yo.lineStart=Rt},polygonEnd:function(){Yo.lineStart=Ot}},Ro=Xt(Ut,Jt,Kt,Qt),Uo=[-Wa,0],Io=1e9;(da.geo.conicEqualArea=function(){return ie(ue)}).raw=ue,da.geo.albers=function(){return da.geo.conicEqualArea().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(1070)},da.geo.albersUsa=function(){function n(n){var u=n[0],a=n[1];return t=null,e(u,a),t||(r(u,a),t)||i(u,a),t}var t,e,r,i,u=da.geo.albers(),a=da.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),o=da.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),c={point:function(n,e){t=[n,e]}};return n.invert=function(n){var t=u.scale(),e=u.translate(),r=(n[0]-e[0])/t,i=(n[1]-e[1])/t;return(i&gt;=.12&amp;&amp;.234&gt;i&amp;&amp;r&gt;=-.425&amp;&amp;-.214&gt;r?a:i&gt;=.166&amp;&amp;.234&gt;i&amp;&amp;r&gt;=-.214&amp;&amp;-.115&gt;r?o:u).invert(n)},n.stream=function(n){var t=u.stream(n),e=a.stream(n),r=o.stream(n);return{point:function(n,i){t.point(n,i),e.point(n,i),r.point(n,i)},sphere:function(){t.sphere(),e.sphere(),r.sphere()},lineStart:function(){t.lineStart(),e.lineStart(),r.lineStart()},lineEnd:function(){t.lineEnd(),e.lineEnd(),r.lineEnd()},polygonStart:function(){t.polygonStart(),e.polygonStart(),r.polygonStart()},polygonEnd:function(){t.polygonEnd(),e.polygonEnd(),r.polygonEnd()}}},n.precision=function(t){return arguments.length?(u.precision(t),a.precision(t),o.precision(t),n):u.precision()},n.scale=function(t){return arguments.length?(u.scale(t),a.scale(.35*t),o.scale(t),n.translate(u.translate())):u.scale()},n.translate=function(t){if(!arguments.length)return u.translate();var l=u.scale(),s=+t[0],f=+t[1];return e=u.translate(t).clipExtent([[s-.455*l,f-.238*l],[s+.455*l,f+.238*l]]).stream(c).point,r=a.translate([s-.307*l,f+.201*l]).clipExtent([[s-.425*l+Ja,f+.12*l+Ja],[s-.214*l-Ja,f+.234*l-Ja]]).stream(c).point,i=o.translate([s-.205*l,f+.212*l]).clipExtent([[s-.214*l+Ja,f+.166*l+Ja],[s-.115*l-Ja,f+.234*l-Ja]]).stream(c).point,n},n.scale(1070)};var Vo,Xo,Zo,Bo,$o,Wo,Jo={point:s,lineStart:s,lineEnd:s,polygonStart:function(){Xo=0,Jo.lineStart=ae},polygonEnd:function(){Jo.lineStart=Jo.lineEnd=Jo.point=s,Vo+=Math.abs(Xo/2)}},Go={point:oe,lineStart:s,lineEnd:s,polygonStart:s,polygonEnd:s},Ko={point:se,lineStart:fe,lineEnd:he,polygonStart:function(){Ko.lineStart=ge},polygonEnd:function(){Ko.point=se,Ko.lineStart=fe,Ko.lineEnd=he}};da.geo.path=function(){function n(n){return n&amp;&amp;(\\\&quot;function\\\&quot;==typeof o&amp;&amp;u.pointRadius(+o.apply(this,arguments)),a&amp;&amp;a.valid||(a=i(u)),da.geo.stream(n,a)),u.result()}function t(){return a=null,n}var e,r,i,u,a,o=4.5;return n.area=function(n){return Vo=0,da.geo.stream(n,i(Jo)),Vo},n.centroid=function(n){return Co=zo=Do=jo=Lo=Ho=Fo=Po=Oo=0,da.geo.stream(n,i(Ko)),Oo?[Fo/Oo,Po/Oo]:Ho?[jo/Ho,Lo/Ho]:Do?[Co/Do,zo/Do]:[0/0,0/0]},n.bounds=function(n){return $o=Wo=-(Zo=Bo=1/0),da.geo.stream(n,i(Go)),[[Zo,Bo],[$o,Wo]]},n.projection=function(n){return arguments.length?(i=(e=n)?n.stream||me(n):gt,t()):e},n.context=function(n){return arguments.length?(u=null==(r=n)?new ce:new pe(n),\\\&quot;function\\\&quot;!=typeof o&amp;&amp;u.pointRadius(o),t()):r},n.pointRadius=function(t){return arguments.length?(o=\\\&quot;function\\\&quot;==typeof t?t:(u.pointRadius(+t),+t),n):o},n.projection(da.geo.albersUsa()).context(null)},da.geo.projection=ve,da.geo.projectionMutator=ye,(da.geo.equirectangular=function(){return ve(xe)}).raw=xe.invert=xe,da.geo.rotation=function(n){function t(t){return t=n(t[0]*Ka,t[1]*Ka),t[0]*=Qa,t[1]*=Qa,t}return n=be(n[0]%360*Ka,n[1]*Ka,n.length&gt;2?n[2]*Ka:0),t.invert=function(t){return t=n.invert(t[0]*Ka,t[1]*Ka),t[0]*=Qa,t[1]*=Qa,t},t},da.geo.circle=function(){function n(){var n=\\\&quot;function\\\&quot;==typeof r?r.apply(this,arguments):r,t=be(-n[0]*Ka,-n[1]*Ka,0).invert,i=[];return e(null,null,1,{point:function(n,e){i.push(n=t(n,e)),n[0]*=Qa,n[1]*=Qa}}),{type:\\\&quot;Polygon\\\&quot;,coordinates:[i]}}var t,e,r=[0,0],i=6;return n.origin=function(t){return arguments.length?(r=t,n):r},n.angle=function(r){return arguments.length?(e=Ee((t=+r)*Ka,i*Ka),n):t},n.precision=function(r){return arguments.length?(e=Ee(t*Ka,(i=+r)*Ka),n):i},n.angle(90)},da.geo.distance=function(n,t){var e,r=(t[0]-n[0])*Ka,i=n[1]*Ka,u=t[1]*Ka,a=Math.sin(r),o=Math.cos(r),c=Math.sin(i),l=Math.cos(i),s=Math.sin(u),f=Math.cos(u);return Math.atan2(Math.sqrt((e=f*a)*e+(e=l*s-c*f*o)*e),c*s+l*f*o)},da.geo.graticule=function(){function n(){return{type:\\\&quot;MultiLineString\\\&quot;,coordinates:t()}}function t(){return da.range(Math.ceil(u/m)*m,i,m).map(h).concat(da.range(Math.ceil(l/v)*v,c,v).map(g)).concat(da.range(Math.ceil(r/p)*p,e,p).filter(function(n){return Math.abs(n%m)&gt;Ja}).map(s)).concat(da.range(Math.ceil(o/d)*d,a,d).filter(function(n){return Math.abs(n%v)&gt;Ja}).map(f))}var e,r,i,u,a,o,c,l,s,f,h,g,p=10,d=p,m=90,v=360,y=2.5;return n.lines=function(){return t().map(function(n){return{type:\\\&quot;LineString\\\&quot;,coordinates:n}})},n.outline=function(){return{type:\\\&quot;Polygon\\\&quot;,coordinates:[h(u).concat(g(c).slice(1),h(i).reverse().slice(1),g(l).reverse().slice(1))]}},n.extent=function(t){return arguments.length?n.majorExtent(t).minorExtent(t):n.minorExtent()},n.majorExtent=function(t){return arguments.length?(u=+t[0][0],i=+t[1][0],l=+t[0][1],c=+t[1][1],u&gt;i&amp;&amp;(t=u,u=i,i=t),l&gt;c&amp;&amp;(t=l,l=c,c=t),n.precision(y)):[[u,l],[i,c]]},n.minorExtent=function(t){return arguments.length?(r=+t[0][0],e=+t[1][0],o=+t[0][1],a=+t[1][1],r&gt;e&amp;&amp;(t=r,r=e,e=t),o&gt;a&amp;&amp;(t=o,o=a,a=t),n.precision(y)):[[r,o],[e,a]]},n.step=function(t){return arguments.length?n.majorStep(t).minorStep(t):n.minorStep()},n.majorStep=function(t){return arguments.length?(m=+t[0],v=+t[1],n):[m,v]},n.minorStep=function(t){return arguments.length?(p=+t[0],d=+t[1],n):[p,d]},n.precision=function(t){return arguments.length?(y=+t,s=Ae(o,a,90),f=Ne(r,e,y),h=Ae(l,c,90),g=Ne(u,i,y),n):y},n.majorExtent([[-180,-90+Ja],[180,90-Ja]]).minorExtent([[-180,-80-Ja],[180,80+Ja]])},da.geo.greatArc=function(){function n(){return{type:\\\&quot;LineString\\\&quot;,coordinates:[t||r.apply(this,arguments),e||i.apply(this,arguments)]}}var t,e,r=qe,i=Te;return n.distance=function(){return da.geo.distance(t||r.apply(this,arguments),e||i.apply(this,arguments))},n.source=function(e){return arguments.length?(r=e,t=\\\&quot;function\\\&quot;==typeof e?null:e,n):r},n.target=function(t){return arguments.length?(i=t,e=\\\&quot;function\\\&quot;==typeof t?null:t,n):i},n.precision=function(){return arguments.length?n:0},n},da.geo.interpolate=function(n,t){return Ce(n[0]*Ka,n[1]*Ka,t[0]*Ka,t[1]*Ka)},da.geo.length=function(n){return Qo=0,da.geo.stream(n,nc),Qo};var Qo,nc={sphere:s,point:s,lineStart:ze,lineEnd:s,polygonStart:s,polygonEnd:s},tc=De(function(n){return Math.sqrt(2/(1+n))},function(n){return 2*Math.asin(n/2)});(da.geo.azimuthalEqualArea=function(){return ve(tc)}).raw=tc;var ec=De(function(n){var t=Math.acos(n);return t&amp;&amp;t/Math.sin(t)},gt);(da.geo.azimuthalEquidistant=function(){return ve(ec)}).raw=ec,(da.geo.conicConformal=function(){return ie(je)}).raw=je,(da.geo.conicEquidistant=function(){return ie(Le)}).raw=Le;var rc=De(function(n){return 1/n},Math.atan);(da.geo.gnomonic=function(){return ve(rc)}).raw=rc,He.invert=function(n,t){return[n,2*Math.atan(Math.exp(t))-Wa/2]},(da.geo.mercator=function(){return Fe(He)}).raw=He;var ic=De(function(){return 1},Math.asin);(da.geo.orthographic=function(){return ve(ic)}).raw=ic;var uc=De(function(n){return 1/(1+n)},function(n){return 2*Math.atan(n)});(da.geo.stereographic=function(){return ve(uc)}).raw=uc,Pe.invert=function(n,t){return[Math.atan2(X(n),Math.cos(t)),V(Math.sin(t)/Z(n))]},(da.geo.transverseMercator=function(){return Fe(Pe)}).raw=Pe,da.geom={},da.svg={},da.svg.line=function(){return Oe(gt)\\n};var ac=da.map({linear:Ue,\\\&quot;linear-closed\\\&quot;:Ie,step:Ve,\\\&quot;step-before\\\&quot;:Xe,\\\&quot;step-after\\\&quot;:Ze,basis:Ke,\\\&quot;basis-open\\\&quot;:Qe,\\\&quot;basis-closed\\\&quot;:nr,bundle:tr,cardinal:We,\\\&quot;cardinal-open\\\&quot;:Be,\\\&quot;cardinal-closed\\\&quot;:$e,monotone:or});ac.forEach(function(n,t){t.key=n,t.closed=/-closed$/.test(n)});var oc=[0,2/3,1/3,0],cc=[0,1/3,2/3,0],lc=[0,1/6,2/3,1/6];da.geom.hull=function(n){function t(n){if(n.length\u003C3)return[];var t,i,u,a,o,c,l,s,f,h,g,p,d=ht(e),m=ht(r),v=n.length,y=v-1,M=[],x=[],b=0;if(d===Ye&amp;&amp;r===Re)t=n;else for(u=0,t=[];v&gt;u;++u)t.push([+d.call(this,i=n[u],u),+m.call(this,i,u)]);for(u=1;v&gt;u;++u)(t[u][1]\u003Ct[b][1]||t[u][1]==t[b][1]&amp;&amp;t[u][0]\u003Ct[b][0])&amp;&amp;(b=u);for(u=0;v&gt;u;++u)u!==b&amp;&amp;(c=t[u][1]-t[b][1],o=t[u][0]-t[b][0],M.push({angle:Math.atan2(c,o),index:u}));for(M.sort(function(n,t){return n.angle-t.angle}),g=M[0].angle,h=M[0].index,f=0,u=1;y&gt;u;++u){if(a=M[u].index,g==M[u].angle){if(o=t[h][0]-t[b][0],c=t[h][1]-t[b][1],l=t[a][0]-t[b][0],s=t[a][1]-t[b][1],o*o+c*c&gt;=l*l+s*s){M[u].index=-1;continue}M[f].index=-1}g=M[u].angle,f=u,h=a}for(x.push(b),u=0,a=0;2&gt;u;++a)M[a].index&gt;-1&amp;&amp;(x.push(M[a].index),u++);for(p=x.length;y&gt;a;++a)if(!(M[a].index\u003C0)){for(;!cr(x[p-2],x[p-1],M[a].index,t);)--p;x[p++]=M[a].index}var _=[];for(u=p-1;u&gt;=0;--u)_.push(n[x[u]]);return _}var e=Ye,r=Re;return arguments.length?t(n):(t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t)},da.geom.polygon=function(n){return za(n,sc),n};var sc=da.geom.polygon.prototype=[];sc.area=function(){for(var n,t=-1,e=this.length,r=this[e-1],i=0;++t\u003Ce;)n=r,r=this[t],i+=n[1]*r[0]-n[0]*r[1];return.5*i},sc.centroid=function(n){var t,e,r=-1,i=this.length,u=0,a=0,o=this[i-1];for(arguments.length||(n=-1/(6*this.area()));++r\u003Ci;)t=o,o=this[r],e=t[0]*o[1]-o[0]*t[1],u+=(t[0]+o[0])*e,a+=(t[1]+o[1])*e;return[u*n,a*n]},sc.clip=function(n){for(var t,e,r,i,u,a,o=fr(n),c=-1,l=this.length-fr(this),s=this[l-1];++c\u003Cl;){for(t=n.slice(),n.length=0,i=this[c],u=t[(r=t.length-o)-1],e=-1;++e\u003Cr;)a=t[e],lr(a,s,i)?(lr(u,s,i)||n.push(sr(u,a,s,i)),n.push(a)):lr(u,s,i)&amp;&amp;n.push(sr(u,a,s,i)),u=a;o&amp;&amp;n.push(n[0]),s=i}return n},da.geom.delaunay=function(n){var t=n.map(function(){return[]}),e=[];return hr(n,function(e){t[e.region.l.index].push(n[e.region.r.index])}),t.forEach(function(t,r){var i=n[r],u=i[0],a=i[1];t.forEach(function(n){n.angle=Math.atan2(n[0]-u,n[1]-a)}),t.sort(function(n,t){return n.angle-t.angle});for(var o=0,c=t.length-1;c&gt;o;o++)e.push([i,t[o],t[o+1]])}),e},da.geom.voronoi=function(n){function t(n){var t,u,a,o=n.map(function(){return[]}),c=ht(e),l=ht(r),s=n.length,f=1e6;if(c===Ye&amp;&amp;l===Re)t=n;else for(t=new Array(s),a=0;s&gt;a;++a)t[a]=[+c.call(this,u=n[a],a),+l.call(this,u,a)];if(hr(t,function(n){var t,e,r,i,u,a;1===n.a&amp;&amp;n.b&gt;=0?(t=n.ep.r,e=n.ep.l):(t=n.ep.l,e=n.ep.r),1===n.a?(u=t?t.y:-f,r=n.c-n.b*u,a=e?e.y:f,i=n.c-n.b*a):(r=t?t.x:-f,u=n.c-n.a*r,i=e?e.x:f,a=n.c-n.a*i);var c=[r,u],l=[i,a];o[n.region.l.index].push(c,l),o[n.region.r.index].push(c,l)}),o=o.map(function(n,e){var r=t[e][0],i=t[e][1],u=n.map(function(n){return Math.atan2(n[0]-r,n[1]-i)}),a=da.range(n.length).sort(function(n,t){return u[n]-u[t]});return a.filter(function(n,t){return!t||u[n]-u[a[t-1]]&gt;Ja}).map(function(t){return n[t]})}),o.forEach(function(n,e){var r=n.length;if(!r)return n.push([-f,-f],[-f,f],[f,f],[f,-f]);if(!(r&gt;2)){var i=t[e],u=n[0],a=n[1],o=i[0],c=i[1],l=u[0],s=u[1],h=a[0],g=a[1],p=Math.abs(h-l),d=g-s;if(Math.abs(d)\u003CJa){var m=s&gt;c?-f:f;n.push([-f,m],[f,m])}else if(Ja&gt;p){var v=l&gt;o?-f:f;n.push([v,-f],[v,f])}else{var m=(l-o)*(g-s)&gt;(h-l)*(s-c)?f:-f,y=Math.abs(d)-p;Math.abs(y)\u003CJa?n.push([0&gt;d?m:-m,m]):(y&gt;0&amp;&amp;(m*=-1),n.push([-f,m],[f,m]))}}}),i)for(a=0;s&gt;a;++a)i.clip(o[a]);for(a=0;s&gt;a;++a)o[a].point=n[a];return o}var e=Ye,r=Re,i=null;return arguments.length?t(n):(t.x=function(n){return arguments.length?(e=n,t):e},t.y=function(n){return arguments.length?(r=n,t):r},t.clipExtent=function(n){if(!arguments.length)return i&amp;&amp;[i[0],i[2]];if(null==n)i=null;else{var e=+n[0][0],r=+n[0][1],u=+n[1][0],a=+n[1][1];i=da.geom.polygon([[e,r],[e,a],[u,a],[u,r]])}return t},t.size=function(n){return arguments.length?t.clipExtent(n&amp;&amp;[[0,0],n]):i&amp;&amp;i[2]},t.links=function(n){var t,i,u,a=n.map(function(){return[]}),o=[],c=ht(e),l=ht(r),s=n.length;if(c===Ye&amp;&amp;l===Re)t=n;else for(t=new Array(s),u=0;s&gt;u;++u)t[u]=[+c.call(this,i=n[u],u),+l.call(this,i,u)];return hr(t,function(t){var e=t.region.l.index,r=t.region.r.index;a[e][r]||(a[e][r]=a[r][e]=!0,o.push({source:n[e],target:n[r]}))}),o},t.triangles=function(n){if(e===Ye&amp;&amp;r===Re)return da.geom.delaunay(n);for(var t,i=new Array(c),u=ht(e),a=ht(r),o=-1,c=n.length;++o\u003Cc;)(i[o]=[+u.call(this,t=n[o],o),+a.call(this,t,o)]).data=t;return da.geom.delaunay(i).map(function(n){return n.map(function(n){return n.data})})},t)};var fc={l:\\\&quot;r\\\&quot;,r:\\\&quot;l\\\&quot;};da.geom.quadtree=function(n,t,e,r,i){function u(n){function u(n,t,e,r,i,u,a,o){if(!isNaN(e)&amp;&amp;!isNaN(r))if(n.leaf){var c=n.x,s=n.y;if(null!=c)if(Math.abs(c-e)+Math.abs(s-r)\u003C.01)l(n,t,e,r,i,u,a,o);else{var f=n.point;n.x=n.y=n.point=null,l(n,f,c,s,i,u,a,o),l(n,t,e,r,i,u,a,o)}else n.x=e,n.y=r,n.point=t}else l(n,t,e,r,i,u,a,o)}function l(n,t,e,r,i,a,o,c){var l=.5*(i+o),s=.5*(a+c),f=e&gt;=l,h=r&gt;=s,g=(h\u003C\u003C1)+f;n.leaf=!1,n=n.nodes[g]||(n.nodes[g]=dr()),f?i=l:o=l,h?a=s:c=s,u(n,t,e,r,i,a,o,c)}var s,f,h,g,p,d,m,v,y,M=ht(o),x=ht(c);if(null!=t)d=t,m=e,v=r,y=i;else if(v=y=-(d=m=1/0),f=[],h=[],p=n.length,a)for(g=0;p&gt;g;++g)s=n[g],s.x\u003Cd&amp;&amp;(d=s.x),s.y\u003Cm&amp;&amp;(m=s.y),s.x&gt;v&amp;&amp;(v=s.x),s.y&gt;y&amp;&amp;(y=s.y),f.push(s.x),h.push(s.y);else for(g=0;p&gt;g;++g){var b=+M(s=n[g],g),_=+x(s,g);d&gt;b&amp;&amp;(d=b),m&gt;_&amp;&amp;(m=_),b&gt;v&amp;&amp;(v=b),_&gt;y&amp;&amp;(y=_),f.push(b),h.push(_)}var w=v-d,S=y-m;w&gt;S?y=m+w:v=d+S;var E=dr();if(E.add=function(n){u(E,n,+M(n,++g),+x(n,g),d,m,v,y)},E.visit=function(n){mr(n,E,d,m,v,y)},g=-1,null==t){for(;++g\u003Cp;)u(E,n[g],f[g],h[g],d,m,v,y);--g}else n.forEach(E.add);return f=h=n=s=null,E}var a,o=Ye,c=Re;return(a=arguments.length)?(o=gr,c=pr,3===a&amp;&amp;(i=e,r=t,e=t=0),u(n)):(u.x=function(n){return arguments.length?(o=n,u):o},u.y=function(n){return arguments.length?(c=n,u):c},u.extent=function(n){return arguments.length?(null==n?t=e=r=i=null:(t=+n[0][0],e=+n[0][1],r=+n[1][0],i=+n[1][1]),u):null==t?null:[[t,e],[r,i]]},u.size=function(n){return arguments.length?(null==n?t=e=r=i=null:(t=e=0,r=+n[0],i=+n[1]),u):null==t?null:[r-t,i-e]},u)},da.interpolateRgb=vr,da.interpolateObject=yr,da.interpolateNumber=Mr,da.interpolateString=xr;var hc=/[-+]?(?:\\\\d+\\\\.?\\\\d*|\\\\.?\\\\d+)(?:[eE][-+]?\\\\d+)?/g;da.interpolate=br,da.interpolators=[function(n,t){var e=typeof t;return(\\\&quot;string\\\&quot;===e?oo.has(t)||/^(#|rgb\\\\(|hsl\\\\()/.test(t)?vr:xr:t instanceof P?vr:\\\&quot;object\\\&quot;===e?Array.isArray(t)?_r:yr:Mr)(n,t)}],da.interpolateArray=_r;var gc=function(){return gt},pc=da.map({linear:gc,poly:qr,quad:function(){return kr},cubic:function(){return Ar},sin:function(){return Tr},exp:function(){return Cr},circle:function(){return zr},elastic:Dr,back:jr,bounce:function(){return Lr}}),dc=da.map({\\\&quot;in\\\&quot;:gt,out:Sr,\\\&quot;in-out\\\&quot;:Er,\\\&quot;out-in\\\&quot;:function(n){return Er(Sr(n))}});da.ease=function(n){var t=n.indexOf(\\\&quot;-\\\&quot;),e=t&gt;=0?n.substring(0,t):n,r=t&gt;=0?n.substring(t+1):\\\&quot;in\\\&quot;;return e=pc.get(e)||gc,r=dc.get(r)||gt,wr(r(e.apply(null,Array.prototype.slice.call(arguments,1))))},da.interpolateHcl=Hr,da.interpolateHsl=Fr,da.interpolateLab=Pr,da.interpolateRound=Or,da.transform=function(n){var t=ma.createElementNS(da.ns.prefix.svg,\\\&quot;g\\\&quot;);return(da.transform=function(n){if(null!=n){t.setAttribute(\\\&quot;transform\\\&quot;,n);var e=t.transform.baseVal.consolidate()}return new Yr(e?e.matrix:mc)})(n)},Yr.prototype.toString=function(){return\\\&quot;translate(\\\&quot;+this.translate+\\\&quot;)rotate(\\\&quot;+this.rotate+\\\&quot;)skewX(\\\&quot;+this.skew+\\\&quot;)scale(\\\&quot;+this.scale+\\\&quot;)\\\&quot;};var mc={a:1,b:0,c:0,d:1,e:0,f:0};da.interpolateTransform=Vr,da.layout={},da.layout.bundle=function(){return function(n){for(var t=[],e=-1,r=n.length;++e\u003Cr;)t.push(Br(n[e]));return t}},da.layout.chord=function(){function n(){var n,l,f,h,g,p={},d=[],m=da.range(u),v=[];for(e=[],r=[],n=0,h=-1;++h\u003Cu;){for(l=0,g=-1;++g\u003Cu;)l+=i[h][g];d.push(l),v.push(da.range(u)),n+=l}for(a&amp;&amp;m.sort(function(n,t){return a(d[n],d[t])}),o&amp;&amp;v.forEach(function(n,t){n.sort(function(n,e){return o(i[t][n],i[t][e])})}),n=(2*Wa-s*u)/n,l=0,h=-1;++h\u003Cu;){for(f=l,g=-1;++g\u003Cu;){var y=m[h],M=v[y][g],x=i[y][M],b=l,_=l+=x*n;p[y+\\\&quot;-\\\&quot;+M]={index:y,subindex:M,startAngle:b,endAngle:_,value:x}}r[y]={index:y,startAngle:f,endAngle:l,value:(l-f)/n},l+=s}for(h=-1;++h\u003Cu;)for(g=h-1;++g\u003Cu;){var w=p[h+\\\&quot;-\\\&quot;+g],S=p[g+\\\&quot;-\\\&quot;+h];(w.value||S.value)&amp;&amp;e.push(w.value\u003CS.value?{source:S,target:w}:{source:w,target:S})}c&amp;&amp;t()}function t(){e.sort(function(n,t){return c((n.source.value+n.target.value)/2,(t.source.value+t.target.value)/2)})}var e,r,i,u,a,o,c,l={},s=0;return l.matrix=function(n){return arguments.length?(u=(i=n)&amp;&amp;i.length,e=r=null,l):i},l.padding=function(n){return arguments.length?(s=n,e=r=null,l):s},l.sortGroups=function(n){return arguments.length?(a=n,e=r=null,l):a},l.sortSubgroups=function(n){return arguments.length?(o=n,e=null,l):o},l.sortChords=function(n){return arguments.length?(c=n,e&amp;&amp;t(),l):c},l.chords=function(){return e||n(),e},l.groups=function(){return r||n(),r},l},da.layout.force=function(){function n(n){return function(t,e,r,i){if(t.point!==n){var u=t.cx-n.x,a=t.cy-n.y,o=1/Math.sqrt(u*u+a*a);if(d&gt;(i-e)*o){var c=t.charge*o*o;return n.px-=u*c,n.py-=a*c,!0}if(t.point&amp;&amp;isFinite(o)){var c=t.pointCharge*o*o;n.px-=u*c,n.py-=a*c}}return!t.charge}}function t(n){n.px=da.event.x,n.py=da.event.y,o.resume()}var e,r,i,u,a,o={},c=da.dispatch(\\\&quot;start\\\&quot;,\\\&quot;tick\\\&quot;,\\\&quot;end\\\&quot;),l=[1,1],s=.9,f=vc,h=yc,g=-30,p=.1,d=.8,m=[],v=[];return o.tick=function(){if((r*=.99)\u003C.005)return c.end({type:\\\&quot;end\\\&quot;,alpha:r=0}),!0;var t,e,o,f,h,d,y,M,x,b=m.length,_=v.length;for(e=0;_&gt;e;++e)o=v[e],f=o.source,h=o.target,M=h.x-f.x,x=h.y-f.y,(d=M*M+x*x)&amp;&amp;(d=r*u[e]*((d=Math.sqrt(d))-i[e])/d,M*=d,x*=d,h.x-=M*(y=f.weight/(h.weight+f.weight)),h.y-=x*y,f.x+=M*(y=1-y),f.y+=x*y);if((y=r*p)&amp;&amp;(M=l[0]/2,x=l[1]/2,e=-1,y))for(;++e\u003Cb;)o=m[e],o.x+=(M-o.x)*y,o.y+=(x-o.y)*y;if(g)for(ni(t=da.geom.quadtree(m),r,a),e=-1;++e\u003Cb;)(o=m[e]).fixed||t.visit(n(o));for(e=-1;++e\u003Cb;)o=m[e],o.fixed?(o.x=o.px,o.y=o.py):(o.x-=(o.px-(o.px=o.x))*s,o.y-=(o.py-(o.py=o.y))*s);c.tick({type:\\\&quot;tick\\\&quot;,alpha:r})},o.nodes=function(n){return arguments.length?(m=n,o):m},o.links=function(n){return arguments.length?(v=n,o):v},o.size=function(n){return arguments.length?(l=n,o):l},o.linkDistance=function(n){return arguments.length?(f=\\\&quot;function\\\&quot;==typeof n?n:+n,o):f},o.distance=o.linkDistance,o.linkStrength=function(n){return arguments.length?(h=\\\&quot;function\\\&quot;==typeof n?n:+n,o):h},o.friction=function(n){return arguments.length?(s=+n,o):s},o.charge=function(n){return arguments.length?(g=\\\&quot;function\\\&quot;==typeof n?n:+n,o):g},o.gravity=function(n){return arguments.length?(p=+n,o):p},o.theta=function(n){return arguments.length?(d=+n,o):d},o.alpha=function(n){return arguments.length?(n=+n,r?r=n&gt;0?n:0:n&gt;0&amp;&amp;(c.start({type:\\\&quot;start\\\&quot;,alpha:r=n}),da.timer(o.tick)),o):r},o.start=function(){function n(n,r){for(var i,u=t(e),a=-1,o=u.length;++a\u003Co;)if(!isNaN(i=u[a][n]))return i;return Math.random()*r}function t(){if(!c){for(c=[],r=0;p&gt;r;++r)c[r]=[];for(r=0;d&gt;r;++r){var n=v[r];c[n.source.index].push(n.target),c[n.target.index].push(n.source)}}return c[e]}var e,r,c,s,p=m.length,d=v.length,y=l[0],M=l[1];for(e=0;p&gt;e;++e)(s=m[e]).index=e,s.weight=0;for(e=0;d&gt;e;++e)s=v[e],\\\&quot;number\\\&quot;==typeof s.source&amp;&amp;(s.source=m[s.source]),\\\&quot;number\\\&quot;==typeof s.target&amp;&amp;(s.target=m[s.target]),++s.source.weight,++s.target.weight;for(e=0;p&gt;e;++e)s=m[e],isNaN(s.x)&amp;&amp;(s.x=n(\\\&quot;x\\\&quot;,y)),isNaN(s.y)&amp;&amp;(s.y=n(\\\&quot;y\\\&quot;,M)),isNaN(s.px)&amp;&amp;(s.px=s.x),isNaN(s.py)&amp;&amp;(s.py=s.y);if(i=[],\\\&quot;function\\\&quot;==typeof f)for(e=0;d&gt;e;++e)i[e]=+f.call(this,v[e],e);else for(e=0;d&gt;e;++e)i[e]=f;if(u=[],\\\&quot;function\\\&quot;==typeof h)for(e=0;d&gt;e;++e)u[e]=+h.call(this,v[e],e);else for(e=0;d&gt;e;++e)u[e]=h;if(a=[],\\\&quot;function\\\&quot;==typeof g)for(e=0;p&gt;e;++e)a[e]=+g.call(this,m[e],e);else for(e=0;p&gt;e;++e)a[e]=g;return o.resume()},o.resume=function(){return o.alpha(.1)},o.stop=function(){return o.alpha(0)},o.drag=function(){return e||(e=da.behavior.drag().origin(gt).on(\\\&quot;dragstart.force\\\&quot;,Jr).on(\\\&quot;drag.force\\\&quot;,t).on(\\\&quot;dragend.force\\\&quot;,Gr)),arguments.length?(this.on(\\\&quot;mouseover.force\\\&quot;,Kr).on(\\\&quot;mouseout.force\\\&quot;,Qr).call(e),void 0):e},da.rebind(o,c,\\\&quot;on\\\&quot;)};var vc=20,yc=1;da.layout.hierarchy=function(){function n(t,a,o){var c=i.call(e,t,a);if(t.depth=a,o.push(t),c&amp;&amp;(l=c.length)){for(var l,s,f=-1,h=t.children=[],g=0,p=a+1;++f\u003Cl;)s=n(c[f],p,o),s.parent=t,h.push(s),g+=s.value;r&amp;&amp;h.sort(r),u&amp;&amp;(t.value=g)}else u&amp;&amp;(t.value=+u.call(e,t,a)||0);return t}function t(n,r){var i=n.children,a=0;if(i&amp;&amp;(o=i.length))for(var o,c=-1,l=r+1;++c\u003Co;)a+=t(i[c],l);else u&amp;&amp;(a=+u.call(e,n,r)||0);return u&amp;&amp;(n.value=a),a}function e(t){var e=[];return n(t,0,e),e}var r=ii,i=ei,u=ri;return e.sort=function(n){return arguments.length?(r=n,e):r},e.children=function(n){return arguments.length?(i=n,e):i},e.value=function(n){return arguments.length?(u=n,e):u},e.revalue=function(n){return t(n,0),n},e},da.layout.partition=function(){function n(t,e,r,i){var u=t.children;if(t.x=e,t.y=t.depth*i,t.dx=r,t.dy=i,u&amp;&amp;(a=u.length)){var a,o,c,l=-1;for(r=t.value?r/t.value:0;++l\u003Ca;)n(o=u[l],e,c=o.value*r,i),e+=c}}function t(n){var e=n.children,r=0;if(e&amp;&amp;(i=e.length))for(var i,u=-1;++u\u003Ci;)r=Math.max(r,t(e[u]));return 1+r}function e(e,u){var a=r.call(this,e,u);return n(a[0],0,i[0],i[1]/t(a[0])),a}var r=da.layout.hierarchy(),i=[1,1];return e.size=function(n){return arguments.length?(i=n,e):i},ti(e,r)},da.layout.pie=function(){function n(u){var a=u.map(function(e,r){return+t.call(n,e,r)}),o=+(\\\&quot;function\\\&quot;==typeof r?r.apply(this,arguments):r),c=((\\\&quot;function\\\&quot;==typeof i?i.apply(this,arguments):i)-o)/da.sum(a),l=da.range(u.length);null!=e&amp;&amp;l.sort(e===Mc?function(n,t){return a[t]-a[n]}:function(n,t){return e(u[n],u[t])});var s=[];return l.forEach(function(n){var t;s[n]={data:u[n],value:t=a[n],startAngle:o,endAngle:o+=t*c}}),s}var t=Number,e=Mc,r=0,i=2*Wa;return n.value=function(e){return arguments.length?(t=e,n):t},n.sort=function(t){return arguments.length?(e=t,n):e},n.startAngle=function(t){return arguments.length?(r=t,n):r},n.endAngle=function(t){return arguments.length?(i=t,n):i},n};var Mc={};da.layout.stack=function(){function n(o,c){var l=o.map(function(e,r){return t.call(n,e,r)}),s=l.map(function(t){return t.map(function(t,e){return[u.call(n,t,e),a.call(n,t,e)]})}),f=e.call(n,s,c);l=da.permute(l,f),s=da.permute(s,f);var h,g,p,d=r.call(n,s,c),m=l.length,v=l[0].length;for(g=0;v&gt;g;++g)for(i.call(n,l[0][g],p=d[g],s[0][g][1]),h=1;m&gt;h;++h)i.call(n,l[h][g],p+=s[h-1][g][1],s[h][g][1]);return o}var t=gt,e=li,r=si,i=ci,u=ai,a=oi;return n.values=function(e){return arguments.length?(t=e,n):t},n.order=function(t){return arguments.length?(e=\\\&quot;function\\\&quot;==typeof t?t:xc.get(t)||li,n):e},n.offset=function(t){return arguments.length?(r=\\\&quot;function\\\&quot;==typeof t?t:bc.get(t)||si,n):r},n.x=function(t){return arguments.length?(u=t,n):u},n.y=function(t){return arguments.length?(a=t,n):a},n.out=function(t){return arguments.length?(i=t,n):i},n};var xc=da.map({\\\&quot;inside-out\\\&quot;:function(n){var t,e,r=n.length,i=n.map(fi),u=n.map(hi),a=da.range(r).sort(function(n,t){return i[n]-i[t]}),o=0,c=0,l=[],s=[];for(t=0;r&gt;t;++t)e=a[t],c&gt;o?(o+=u[e],l.push(e)):(c+=u[e],s.push(e));return s.reverse().concat(l)},reverse:function(n){return da.range(n.length).reverse()},\\\&quot;default\\\&quot;:li}),bc=da.map({silhouette:function(n){var t,e,r,i=n.length,u=n[0].length,a=[],o=0,c=[];for(e=0;u&gt;e;++e){for(t=0,r=0;i&gt;t;t++)r+=n[t][e][1];r&gt;o&amp;&amp;(o=r),a.push(r)}for(e=0;u&gt;e;++e)c[e]=(o-a[e])/2;return c},wiggle:function(n){var t,e,r,i,u,a,o,c,l,s=n.length,f=n[0],h=f.length,g=[];for(g[0]=c=l=0,e=1;h&gt;e;++e){for(t=0,i=0;s&gt;t;++t)i+=n[t][e][1];for(t=0,u=0,o=f[e][0]-f[e-1][0];s&gt;t;++t){for(r=0,a=(n[t][e][1]-n[t][e-1][1])/(2*o);t&gt;r;++r)a+=(n[r][e][1]-n[r][e-1][1])/o;u+=a*n[t][e][1]}g[e]=c-=i?u/i*o:0,l&gt;c&amp;&amp;(l=c)}for(e=0;h&gt;e;++e)g[e]-=l;return g},expand:function(n){var t,e,r,i=n.length,u=n[0].length,a=1/i,o=[];for(e=0;u&gt;e;++e){for(t=0,r=0;i&gt;t;t++)r+=n[t][e][1];if(r)for(t=0;i&gt;t;t++)n[t][e][1]/=r;else for(t=0;i&gt;t;t++)n[t][e][1]=a}for(e=0;u&gt;e;++e)o[e]=0;return o},zero:si});da.layout.histogram=function(){function n(n,u){for(var a,o,c=[],l=n.map(e,this),s=r.call(this,l,u),f=i.call(this,s,l,u),u=-1,h=l.length,g=f.length-1,p=t?1:1/h;++u\u003Cg;)a=c[u]=[],a.dx=f[u+1]-(a.x=f[u]),a.y=0;if(g&gt;0)for(u=-1;++u\u003Ch;)o=l[u],o&gt;=s[0]&amp;&amp;o\u003C=s[1]&amp;&amp;(a=c[da.bisect(f,o,1,g)-1],a.y+=p,a.push(n[u]));return c}var t=!0,e=Number,r=mi,i=pi;return n.value=function(t){return arguments.length?(e=t,n):e},n.range=function(t){return arguments.length?(r=ht(t),n):r},n.bins=function(t){return arguments.length?(i=\\\&quot;number\\\&quot;==typeof t?function(n){return di(n,t)}:ht(t),n):i},n.frequency=function(e){return arguments.length?(t=!!e,n):t},n},da.layout.tree=function(){function n(n,u){function a(n,t){var r=n.children,i=n._tree;if(r&amp;&amp;(u=r.length)){for(var u,o,l,s=r[0],f=s,h=-1;++h\u003Cu;)l=r[h],a(l,o),f=c(l,o,f),o=l;Ei(n);var g=.5*(s._tree.prelim+l._tree.prelim);t?(i.prelim=t._tree.prelim+e(n,t),i.mod=i.prelim-g):i.prelim=g}else t&amp;&amp;(i.prelim=t._tree.prelim+e(n,t))}function o(n,t){n.x=n._tree.prelim+t;var e=n.children;if(e&amp;&amp;(r=e.length)){var r,i=-1;for(t+=n._tree.mod;++i\u003Cr;)o(e[i],t)}}function c(n,t,r){if(t){for(var i,u=n,a=n,o=t,c=n.parent.children[0],l=u._tree.mod,s=a._tree.mod,f=o._tree.mod,h=c._tree.mod;o=Mi(o),u=yi(u),o&amp;&amp;u;)c=yi(c),a=Mi(a),a._tree.ancestor=n,i=o._tree.prelim+f-u._tree.prelim-l+e(o,u),i&gt;0&amp;&amp;(ki(Ai(o,n,r),n,i),l+=i,s+=i),f+=o._tree.mod,l+=u._tree.mod,h+=c._tree.mod,s+=a._tree.mod;o&amp;&amp;!Mi(a)&amp;&amp;(a._tree.thread=o,a._tree.mod+=f-s),u&amp;&amp;!yi(c)&amp;&amp;(c._tree.thread=u,c._tree.mod+=l-h,r=n)}return r}var l=t.call(this,n,u),s=l[0];Si(s,function(n,t){n._tree={ancestor:n,prelim:0,mod:0,change:0,shift:0,number:t?t._tree.number+1:0}}),a(s),o(s,-s._tree.prelim);var f=xi(s,_i),h=xi(s,bi),g=xi(s,wi),p=f.x-e(f,h)/2,d=h.x+e(h,f)/2,m=g.depth||1;return Si(s,i?function(n){n.x*=r[0],n.y=n.depth*r[1],delete n._tree}:function(n){n.x=(n.x-p)/(d-p)*r[0],n.y=n.depth/m*r[1],delete n._tree}),l}var t=da.layout.hierarchy().sort(null).value(null),e=vi,r=[1,1],i=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(i=null==(r=t),n):i?null:r},n.nodeSize=function(t){return arguments.length?(i=null!=(r=t),n):i?r:null},ti(n,t)},da.layout.pack=function(){function n(n,u){var a=e.call(this,n,u),o=a[0],c=i[0],l=i[1],s=null==t?Math.sqrt:\\\&quot;function\\\&quot;==typeof t?t:function(){return t};if(o.x=o.y=0,Si(o,function(n){n.r=+s(n.value)}),Si(o,zi),r){var f=r*(t?1:Math.max(2*o.r/c,2*o.r/l))/2;Si(o,function(n){n.r+=f}),Si(o,zi),Si(o,function(n){n.r-=f})}return Li(o,c/2,l/2,t?1:1/Math.max(2*o.r/c,2*o.r/l)),a}var t,e=da.layout.hierarchy().sort(Ni),r=0,i=[1,1];return n.size=function(t){return arguments.length?(i=t,n):i},n.radius=function(e){return arguments.length?(t=null==e||\\\&quot;function\\\&quot;==typeof e?e:+e,n):t},n.padding=function(t){return arguments.length?(r=+t,n):r},ti(n,e)},da.layout.cluster=function(){function n(n,u){var a,o=t.call(this,n,u),c=o[0],l=0;Si(c,function(n){var t=n.children;t&amp;&amp;t.length?(n.x=Pi(t),n.y=Fi(t)):(n.x=a?l+=e(n,a):0,n.y=0,a=n)});var s=Oi(c),f=Yi(c),h=s.x-e(s,f)/2,g=f.x+e(f,s)/2;return Si(c,i?function(n){n.x=(n.x-c.x)*r[0],n.y=(c.y-n.y)*r[1]}:function(n){n.x=(n.x-h)/(g-h)*r[0],n.y=(1-(c.y?n.y/c.y:1))*r[1]}),o}var t=da.layout.hierarchy().sort(null).value(null),e=vi,r=[1,1],i=!1;return n.separation=function(t){return arguments.length?(e=t,n):e},n.size=function(t){return arguments.length?(i=null==(r=t),n):i?null:r},n.nodeSize=function(t){return arguments.length?(i=null!=(r=t),n):i?r:null},ti(n,t)},da.layout.treemap=function(){function n(n,t){for(var e,r,i=-1,u=n.length;++i\u003Cu;)r=(e=n[i]).value*(0&gt;t?0:t),e.area=isNaN(r)||0&gt;=r?0:r}function t(e){var u=e.children;if(u&amp;&amp;u.length){var a,o,c,l=f(e),s=[],h=u.slice(),p=1/0,d=\\\&quot;slice\\\&quot;===g?l.dx:\\\&quot;dice\\\&quot;===g?l.dy:\\\&quot;slice-dice\\\&quot;===g?1&amp;e.depth?l.dy:l.dx:Math.min(l.dx,l.dy);for(n(h,l.dx*l.dy/e.value),s.area=0;(c=h.length)&gt;0;)s.push(a=h[c-1]),s.area+=a.area,\\\&quot;squarify\\\&quot;!==g||(o=r(s,d))\u003C=p?(h.pop(),p=o):(s.area-=s.pop().area,i(s,d,l,!1),d=Math.min(l.dx,l.dy),s.length=s.area=0,p=1/0);s.length&amp;&amp;(i(s,d,l,!0),s.length=s.area=0),u.forEach(t)}}function e(t){var r=t.children;if(r&amp;&amp;r.length){var u,a=f(t),o=r.slice(),c=[];for(n(o,a.dx*a.dy/t.value),c.area=0;u=o.pop();)c.push(u),c.area+=u.area,null!=u.z&amp;&amp;(i(c,u.z?a.dx:a.dy,a,!o.length),c.length=c.area=0);r.forEach(e)}}function r(n,t){for(var e,r=n.area,i=0,u=1/0,a=-1,o=n.length;++a\u003Co;)(e=n[a].area)&amp;&amp;(u&gt;e&amp;&amp;(u=e),e&gt;i&amp;&amp;(i=e));return r*=r,t*=t,r?Math.max(t*i*p/r,r/(t*u*p)):1/0}function i(n,t,e,r){var i,u=-1,a=n.length,o=e.x,l=e.y,s=t?c(n.area/t):0;if(t==e.dx){for((r||s&gt;e.dy)&amp;&amp;(s=e.dy);++u\u003Ca;)i=n[u],i.x=o,i.y=l,i.dy=s,o+=i.dx=Math.min(e.x+e.dx-o,s?c(i.area/s):0);i.z=!0,i.dx+=e.x+e.dx-o,e.y+=s,e.dy-=s}else{for((r||s&gt;e.dx)&amp;&amp;(s=e.dx);++u\u003Ca;)i=n[u],i.x=o,i.y=l,i.dx=s,l+=i.dy=Math.min(e.y+e.dy-l,s?c(i.area/s):0);i.z=!1,i.dy+=e.y+e.dy-l,e.x+=s,e.dx-=s}}function u(r){var i=a||o(r),u=i[0];return u.x=0,u.y=0,u.dx=l[0],u.dy=l[1],a&amp;&amp;o.revalue(u),n([u],u.dx*u.dy/u.value),(a?e:t)(u),h&amp;&amp;(a=i),i}var a,o=da.layout.hierarchy(),c=Math.round,l=[1,1],s=null,f=Ri,h=!1,g=\\\&quot;squarify\\\&quot;,p=.5*(1+Math.sqrt(5));return u.size=function(n){return arguments.length?(l=n,u):l},u.padding=function(n){function t(t){var e=n.call(u,t,t.depth);return null==e?Ri(t):Ui(t,\\\&quot;number\\\&quot;==typeof e?[e,e,e,e]:e)}function e(t){return Ui(t,n)}if(!arguments.length)return s;var r;return f=null==(s=n)?Ri:\\\&quot;function\\\&quot;==(r=typeof n)?t:\\\&quot;number\\\&quot;===r?(n=[n,n,n,n],e):e,u},u.round=function(n){return arguments.length?(c=n?Math.round:Number,u):c!=Number},u.sticky=function(n){return arguments.length?(h=n,a=null,u):h},u.ratio=function(n){return arguments.length?(p=n,u):p},u.mode=function(n){return arguments.length?(g=n+\\\&quot;\\\&quot;,u):g},ti(u,o)},da.random={normal:function(n,t){var e=arguments.length;return 2&gt;e&amp;&amp;(t=1),1&gt;e&amp;&amp;(n=0),function(){var e,r,i;do e=2*Math.random()-1,r=2*Math.random()-1,i=e*e+r*r;while(!i||i&gt;1);return n+t*e*Math.sqrt(-2*Math.log(i)/i)}},logNormal:function(){var n=da.random.normal.apply(da,arguments);return function(){return Math.exp(n())}},irwinHall:function(n){return function(){for(var t=0,e=0;n&gt;e;e++)t+=Math.random();return t/n}}},da.scale={};var _c={floor:gt,ceil:gt};da.scale.linear=function(){return Wi([0,1],[0,1],br,!1)},da.scale.log=function(){return eu(da.scale.linear().domain([0,1]),10,!0,[1,10])};var wc=da.format(\\\&quot;.0e\\\&quot;),Sc={floor:function(n){return-Math.ceil(-n)},ceil:function(n){return-Math.floor(-n)}};da.scale.pow=function(){return ru(da.scale.linear(),1,[0,1])},da.scale.sqrt=function(){return da.scale.pow().exponent(.5)},da.scale.ordinal=function(){return uu([],{t:\\\&quot;range\\\&quot;,a:[[]]})},da.scale.category10=function(){return da.scale.ordinal().range(Ec)},da.scale.category20=function(){return da.scale.ordinal().range(kc)},da.scale.category20b=function(){return da.scale.ordinal().range(Ac)},da.scale.category20c=function(){return da.scale.ordinal().range(Nc)};var Ec=[\\\&quot;#1f77b4\\\&quot;,\\\&quot;#ff7f0e\\\&quot;,\\\&quot;#2ca02c\\\&quot;,\\\&quot;#d62728\\\&quot;,\\\&quot;#9467bd\\\&quot;,\\\&quot;#8c564b\\\&quot;,\\\&quot;#e377c2\\\&quot;,\\\&quot;#7f7f7f\\\&quot;,\\\&quot;#bcbd22\\\&quot;,\\\&quot;#17becf\\\&quot;],kc=[\\\&quot;#1f77b4\\\&quot;,\\\&quot;#aec7e8\\\&quot;,\\\&quot;#ff7f0e\\\&quot;,\\\&quot;#ffbb78\\\&quot;,\\\&quot;#2ca02c\\\&quot;,\\\&quot;#98df8a\\\&quot;,\\\&quot;#d62728\\\&quot;,\\\&quot;#ff9896\\\&quot;,\\\&quot;#9467bd\\\&quot;,\\\&quot;#c5b0d5\\\&quot;,\\\&quot;#8c564b\\\&quot;,\\\&quot;#c49c94\\\&quot;,\\\&quot;#e377c2\\\&quot;,\\\&quot;#f7b6d2\\\&quot;,\\\&quot;#7f7f7f\\\&quot;,\\\&quot;#c7c7c7\\\&quot;,\\\&quot;#bcbd22\\\&quot;,\\\&quot;#dbdb8d\\\&quot;,\\\&quot;#17becf\\\&quot;,\\\&quot;#9edae5\\\&quot;],Ac=[\\\&quot;#393b79\\\&quot;,\\\&quot;#5254a3\\\&quot;,\\\&quot;#6b6ecf\\\&quot;,\\\&quot;#9c9ede\\\&quot;,\\\&quot;#637939\\\&quot;,\\\&quot;#8ca252\\\&quot;,\\\&quot;#b5cf6b\\\&quot;,\\\&quot;#cedb9c\\\&quot;,\\\&quot;#8c6d31\\\&quot;,\\\&quot;#bd9e39\\\&quot;,\\\&quot;#e7ba52\\\&quot;,\\\&quot;#e7cb94\\\&quot;,\\\&quot;#843c39\\\&quot;,\\\&quot;#ad494a\\\&quot;,\\\&quot;#d6616b\\\&quot;,\\\&quot;#e7969c\\\&quot;,\\\&quot;#7b4173\\\&quot;,\\\&quot;#a55194\\\&quot;,\\\&quot;#ce6dbd\\\&quot;,\\\&quot;#de9ed6\\\&quot;],Nc=[\\\&quot;#3182bd\\\&quot;,\\\&quot;#6baed6\\\&quot;,\\\&quot;#9ecae1\\\&quot;,\\\&quot;#c6dbef\\\&quot;,\\\&quot;#e6550d\\\&quot;,\\\&quot;#fd8d3c\\\&quot;,\\\&quot;#fdae6b\\\&quot;,\\\&quot;#fdd0a2\\\&quot;,\\\&quot;#31a354\\\&quot;,\\\&quot;#74c476\\\&quot;,\\\&quot;#a1d99b\\\&quot;,\\\&quot;#c7e9c0\\\&quot;,\\\&quot;#756bb1\\\&quot;,\\\&quot;#9e9ac8\\\&quot;,\\\&quot;#bcbddc\\\&quot;,\\\&quot;#dadaeb\\\&quot;,\\\&quot;#636363\\\&quot;,\\\&quot;#969696\\\&quot;,\\\&quot;#bdbdbd\\\&quot;,\\\&quot;#d9d9d9\\\&quot;];da.scale.quantile=function(){return au([],[])},da.scale.quantize=function(){return ou(0,1,[0,1])},da.scale.threshold=function(){return cu([.5],[0,1])},da.scale.identity=function(){return lu([0,1])},da.svg.arc=function(){function n(){var n=t.apply(this,arguments),u=e.apply(this,arguments),a=r.apply(this,arguments)+qc,o=i.apply(this,arguments)+qc,c=(a&gt;o&amp;&amp;(c=a,a=o,o=c),o-a),l=Wa&gt;c?\\\&quot;0\\\&quot;:\\\&quot;1\\\&quot;,s=Math.cos(a),f=Math.sin(a),h=Math.cos(o),g=Math.sin(o);return c&gt;=Tc?n?\\\&quot;M0,\\\&quot;+u+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 1,1 0,\\\&quot;+-u+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 1,1 0,\\\&quot;+u+\\\&quot;M0,\\\&quot;+n+\\\&quot;A\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 1,0 0,\\\&quot;+-n+\\\&quot;A\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 1,0 0,\\\&quot;+n+\\\&quot;Z\\\&quot;:\\\&quot;M0,\\\&quot;+u+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 1,1 0,\\\&quot;+-u+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 1,1 0,\\\&quot;+u+\\\&quot;Z\\\&quot;:n?\\\&quot;M\\\&quot;+u*s+\\\&quot;,\\\&quot;+u*f+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 \\\&quot;+l+\\\&quot;,1 \\\&quot;+u*h+\\\&quot;,\\\&quot;+u*g+\\\&quot;L\\\&quot;+n*h+\\\&quot;,\\\&quot;+n*g+\\\&quot;A\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 \\\&quot;+l+\\\&quot;,0 \\\&quot;+n*s+\\\&quot;,\\\&quot;+n*f+\\\&quot;Z\\\&quot;:\\\&quot;M\\\&quot;+u*s+\\\&quot;,\\\&quot;+u*f+\\\&quot;A\\\&quot;+u+\\\&quot;,\\\&quot;+u+\\\&quot; 0 \\\&quot;+l+\\\&quot;,1 \\\&quot;+u*h+\\\&quot;,\\\&quot;+u*g+\\\&quot;L0,0\\\&quot;+\\\&quot;Z\\\&quot;}var t=su,e=fu,r=hu,i=gu;return n.innerRadius=function(e){return arguments.length?(t=ht(e),n):t},n.outerRadius=function(t){return arguments.length?(e=ht(t),n):e},n.startAngle=function(t){return arguments.length?(r=ht(t),n):r},n.endAngle=function(t){return arguments.length?(i=ht(t),n):i},n.centroid=function(){var n=(t.apply(this,arguments)+e.apply(this,arguments))/2,u=(r.apply(this,arguments)+i.apply(this,arguments))/2+qc;return[Math.cos(u)*n,Math.sin(u)*n]},n};var qc=-Wa/2,Tc=2*Wa-1e-6;da.svg.line.radial=function(){var n=Oe(pu);return n.radius=n.x,delete n.x,n.angle=n.y,delete n.y,n},Xe.reverse=Ze,Ze.reverse=Xe,da.svg.area=function(){return du(gt)},da.svg.area.radial=function(){var n=du(pu);return n.radius=n.x,delete n.x,n.innerRadius=n.x0,delete n.x0,n.outerRadius=n.x1,delete n.x1,n.angle=n.y,delete n.y,n.startAngle=n.y0,delete n.y0,n.endAngle=n.y1,delete n.y1,n},da.svg.chord=function(){function n(n,o){var c=t(this,u,n,o),l=t(this,a,n,o);return\\\&quot;M\\\&quot;+c.p0+r(c.r,c.p1,c.a1-c.a0)+(e(c,l)?i(c.r,c.p1,c.r,c.p0):i(c.r,c.p1,l.r,l.p0)+r(l.r,l.p1,l.a1-l.a0)+i(l.r,l.p1,c.r,c.p0))+\\\&quot;Z\\\&quot;}function t(n,t,e,r){var i=t.call(n,e,r),u=o.call(n,i,r),a=c.call(n,i,r)+qc,s=l.call(n,i,r)+qc;return{r:u,a0:a,a1:s,p0:[u*Math.cos(a),u*Math.sin(a)],p1:[u*Math.cos(s),u*Math.sin(s)]}}function e(n,t){return n.a0==t.a0&amp;&amp;n.a1==t.a1}function r(n,t,e){return\\\&quot;A\\\&quot;+n+\\\&quot;,\\\&quot;+n+\\\&quot; 0 \\\&quot;+ +(e&gt;Wa)+\\\&quot;,1 \\\&quot;+t}function i(n,t,e,r){return\\\&quot;Q 0,0 \\\&quot;+r}var u=qe,a=Te,o=mu,c=hu,l=gu;return n.radius=function(t){return arguments.length?(o=ht(t),n):o},n.source=function(t){return arguments.length?(u=ht(t),n):u},n.target=function(t){return arguments.length?(a=ht(t),n):a},n.startAngle=function(t){return arguments.length?(c=ht(t),n):c},n.endAngle=function(t){return arguments.length?(l=ht(t),n):l},n},da.svg.diagonal=function(){function n(n,i){var u=t.call(this,n,i),a=e.call(this,n,i),o=(u.y+a.y)/2,c=[u,{x:u.x,y:o},{x:a.x,y:o},a];return c=c.map(r),\\\&quot;M\\\&quot;+c[0]+\\\&quot;C\\\&quot;+c[1]+\\\&quot; \\\&quot;+c[2]+\\\&quot; \\\&quot;+c[3]}var t=qe,e=Te,r=vu;return n.source=function(e){return arguments.length?(t=ht(e),n):t},n.target=function(t){return arguments.length?(e=ht(t),n):e},n.projection=function(t){return arguments.length?(r=t,n):r},n},da.svg.diagonal.radial=function(){var n=da.svg.diagonal(),t=vu,e=n.projection;return n.projection=function(n){return arguments.length?e(yu(t=n)):t},n},da.svg.symbol=function(){function n(n,r){return(Cc.get(t.call(this,n,r))||bu)(e.call(this,n,r))}var t=xu,e=Mu;return n.type=function(e){return arguments.length?(t=ht(e),n):t},n.size=function(t){return arguments.length?(e=ht(t),n):e},n};var Cc=da.map({circle:bu,cross:function(n){var t=Math.sqrt(n/5)/2;return\\\&quot;M\\\&quot;+-3*t+\\\&quot;,\\\&quot;+-t+\\\&quot;H\\\&quot;+-t+\\\&quot;V\\\&quot;+-3*t+\\\&quot;H\\\&quot;+t+\\\&quot;V\\\&quot;+-t+\\\&quot;H\\\&quot;+3*t+\\\&quot;V\\\&quot;+t+\\\&quot;H\\\&quot;+t+\\\&quot;V\\\&quot;+3*t+\\\&quot;H\\\&quot;+-t+\\\&quot;V\\\&quot;+t+\\\&quot;H\\\&quot;+-3*t+\\\&quot;Z\\\&quot;},diamond:function(n){var t=Math.sqrt(n/(2*Lc)),e=t*Lc;return\\\&quot;M0,\\\&quot;+-t+\\\&quot;L\\\&quot;+e+\\\&quot;,0\\\&quot;+\\\&quot; 0,\\\&quot;+t+\\\&quot; \\\&quot;+-e+\\\&quot;,0\\\&quot;+\\\&quot;Z\\\&quot;},square:function(n){var t=Math.sqrt(n)/2;return\\\&quot;M\\\&quot;+-t+\\\&quot;,\\\&quot;+-t+\\\&quot;L\\\&quot;+t+\\\&quot;,\\\&quot;+-t+\\\&quot; \\\&quot;+t+\\\&quot;,\\\&quot;+t+\\\&quot; \\\&quot;+-t+\\\&quot;,\\\&quot;+t+\\\&quot;Z\\\&quot;},\\\&quot;triangle-down\\\&quot;:function(n){var t=Math.sqrt(n/jc),e=t*jc/2;return\\\&quot;M0,\\\&quot;+e+\\\&quot;L\\\&quot;+t+\\\&quot;,\\\&quot;+-e+\\\&quot; \\\&quot;+-t+\\\&quot;,\\\&quot;+-e+\\\&quot;Z\\\&quot;},\\\&quot;triangle-up\\\&quot;:function(n){var t=Math.sqrt(n/jc),e=t*jc/2;return\\\&quot;M0,\\\&quot;+-e+\\\&quot;L\\\&quot;+t+\\\&quot;,\\\&quot;+e+\\\&quot; \\\&quot;+-t+\\\&quot;,\\\&quot;+e+\\\&quot;Z\\\&quot;}});da.svg.symbolTypes=Cc.keys();var zc,Dc,jc=Math.sqrt(3),Lc=Math.tan(30*Ka),Hc=[],Fc=0;Hc.call=Fa.call,Hc.empty=Fa.empty,Hc.node=Fa.node,Hc.size=Fa.size,da.transition=function(n){return arguments.length?zc?n.transition():n:Ya.transition()},da.transition.prototype=Hc,Hc.select=function(n){var t,e,r,i=this.id,u=[];n=v(n);for(var a=-1,o=this.length;++a\u003Co;){u.push(t=[]);for(var c=this[a],l=-1,s=c.length;++l\u003Cs;)(r=c[l])&amp;&amp;(e=n.call(r,r.__data__,l,a))?(\\\&quot;__data__\\\&quot;in r&amp;&amp;(e.__data__=r.__data__),Eu(e,l,i,r.__transition__[i]),t.push(e)):t.push(null)}return _u(u,i)},Hc.selectAll=function(n){var t,e,r,i,u,a=this.id,o=[];n=y(n);for(var c=-1,l=this.length;++c\u003Cl;)for(var s=this[c],f=-1,h=s.length;++f\u003Ch;)if(r=s[f]){u=r.__transition__[a],e=n.call(r,r.__data__,f,c),o.push(t=[]);for(var g=-1,p=e.length;++g\u003Cp;)(i=e[g])&amp;&amp;Eu(i,g,a,u),t.push(i)}return _u(o,a)},Hc.filter=function(n){var t,e,r,i=[];\\\&quot;function\\\&quot;!=typeof n&amp;&amp;(n=N(n));for(var u=0,a=this.length;a&gt;u;u++){i.push(t=[]);for(var e=this[u],o=0,c=e.length;c&gt;o;o++)(r=e[o])&amp;&amp;n.call(r,r.__data__,o)&amp;&amp;t.push(r)}return _u(i,this.id,this.time).ease(this.ease())},Hc.tween=function(n,t){var e=this.id;return arguments.length\u003C2?this.node().__transition__[e].tween.get(n):T(this,null==t?function(t){t.__transition__[e].tween.remove(n)}:function(r){r.__transition__[e].tween.set(n,t)})},Hc.attr=function(n,t){function e(){this.removeAttribute(o)}function r(){this.removeAttributeNS(o.space,o.local)}function i(n){return null==n?e:(n+=\\\&quot;\\\&quot;,function(){var t,e=this.getAttribute(o);return e!==n&amp;&amp;(t=a(e,n),function(n){this.setAttribute(o,t(n))})})}function u(n){return null==n?r:(n+=\\\&quot;\\\&quot;,function(){var t,e=this.getAttributeNS(o.space,o.local);return e!==n&amp;&amp;(t=a(e,n),function(n){this.setAttributeNS(o.space,o.local,t(n))})})}if(arguments.length\u003C2){for(t in n)this.attr(t,n[t]);return this}var a=\\\&quot;transform\\\&quot;==n?Vr:br,o=da.ns.qualify(n);return wu(this,\\\&quot;attr.\\\&quot;+n,t,o.local?u:i)},Hc.attrTween=function(n,t){function e(n,e){var r=t.call(this,n,e,this.getAttribute(i));return r&amp;&amp;function(n){this.setAttribute(i,r(n))}}function r(n,e){var r=t.call(this,n,e,this.getAttributeNS(i.space,i.local));return r&amp;&amp;function(n){this.setAttributeNS(i.space,i.local,r(n))}}var i=da.ns.qualify(n);return this.tween(\\\&quot;attr.\\\&quot;+n,i.local?r:e)},Hc.style=function(n,t,e){function r(){this.style.removeProperty(n)}function i(t){return null==t?r:(t+=\\\&quot;\\\&quot;,function(){var r,i=ya.getComputedStyle(this,null).getPropertyValue(n);return i!==t&amp;&amp;(r=br(i,t),function(t){this.style.setProperty(n,r(t),e)})})}var u=arguments.length;if(3&gt;u){if(\\\&quot;string\\\&quot;!=typeof n){2&gt;u&amp;&amp;(t=\\\&quot;\\\&quot;);for(e in n)this.style(e,n[e],t);return this}e=\\\&quot;\\\&quot;}return wu(this,\\\&quot;style.\\\&quot;+n,t,i)},Hc.styleTween=function(n,t,e){function r(r,i){var u=t.call(this,r,i,ya.getComputedStyle(this,null).getPropertyValue(n));return u&amp;&amp;function(t){this.style.setProperty(n,u(t),e)}}return arguments.length\u003C3&amp;&amp;(e=\\\&quot;\\\&quot;),this.tween(\\\&quot;style.\\\&quot;+n,r)},Hc.text=function(n){return wu(this,\\\&quot;text\\\&quot;,n,Su)},Hc.remove=function(){return this.each(\\\&quot;end.transition\\\&quot;,function(){var n;!this.__transition__&amp;&amp;(n=this.parentNode)&amp;&amp;n.removeChild(this)})},Hc.ease=function(n){var t=this.id;return arguments.length\u003C1?this.node().__transition__[t].ease:(\\\&quot;function\\\&quot;!=typeof n&amp;&amp;(n=da.ease.apply(da,arguments)),T(this,function(e){e.__transition__[t].ease=n}))},Hc.delay=function(n){var t=this.id;return T(this,\\\&quot;function\\\&quot;==typeof n?function(e,r,i){e.__transition__[t].delay=0|n.call(e,e.__data__,r,i)}:(n|=0,function(e){e.__transition__[t].delay=n}))},Hc.duration=function(n){var t=this.id;return T(this,\\\&quot;function\\\&quot;==typeof n?function(e,r,i){e.__transition__[t].duration=Math.max(1,0|n.call(e,e.__data__,r,i))}:(n=Math.max(1,0|n),function(e){e.__transition__[t].duration=n}))},Hc.each=function(n,t){var e=this.id;if(arguments.length\u003C2){var r=Dc,i=zc;zc=e,T(this,function(t,r,i){Dc=t.__transition__[e],n.call(t,t.__data__,r,i)}),Dc=r,zc=i}else T(this,function(r){var i=r.__transition__[e];(i.event||(i.event=da.dispatch(\\\&quot;start\\\&quot;,\\\&quot;end\\\&quot;))).on(n,t)});return this},Hc.transition=function(){for(var n,t,e,r,i=this.id,u=++Fc,a=[],o=0,c=this.length;c&gt;o;o++){a.push(n=[]);for(var t=this[o],l=0,s=t.length;s&gt;l;l++)(e=t[l])&amp;&amp;(r=Object.create(e.__transition__[i]),r.delay+=r.duration,Eu(e,l,u,r)),n.push(e)}return _u(a,u)},da.svg.axis=function(){function n(n){n.each(function(){var n,f=da.select(this),h=null==l?e.ticks?e.ticks.apply(e,c):e.domain():l,g=null==t?e.tickFormat?e.tickFormat.apply(e,c):String:t,p=Nu(e,h,s),d=f.selectAll(\\\&quot;.tick.minor\\\&quot;).data(p,String),m=d.enter().insert(\\\&quot;line\\\&quot;,\\\&quot;.tick\\\&quot;).attr(\\\&quot;class\\\&quot;,\\\&quot;tick minor\\\&quot;).style(\\\&quot;opacity\\\&quot;,1e-6),v=da.transition(d.exit()).style(\\\&quot;opacity\\\&quot;,1e-6).remove(),y=da.transition(d).style(\\\&quot;opacity\\\&quot;,1),M=f.selectAll(\\\&quot;.tick.major\\\&quot;).data(h,String),x=M.enter().insert(\\\&quot;g\\\&quot;,\\\&quot;.domain\\\&quot;).attr(\\\&quot;class\\\&quot;,\\\&quot;tick major\\\&quot;).style(\\\&quot;opacity\\\&quot;,1e-6),b=da.transition(M.exit()).style(\\\&quot;opacity\\\&quot;,1e-6).remove(),_=da.transition(M).style(\\\&quot;opacity\\\&quot;,1),w=Vi(e),S=f.selectAll(\\\&quot;.domain\\\&quot;).data([0]),E=(S.enter().append(\\\&quot;path\\\&quot;).attr(\\\&quot;class\\\&quot;,\\\&quot;domain\\\&quot;),da.transition(S)),k=e.copy(),A=this.__chart__||k;\\nthis.__chart__=k,x.append(\\\&quot;line\\\&quot;),x.append(\\\&quot;text\\\&quot;);var N=x.select(\\\&quot;line\\\&quot;),q=_.select(\\\&quot;line\\\&quot;),T=M.select(\\\&quot;text\\\&quot;).text(g),C=x.select(\\\&quot;text\\\&quot;),z=_.select(\\\&quot;text\\\&quot;);switch(r){case\\\&quot;bottom\\\&quot;:n=ku,m.attr(\\\&quot;y2\\\&quot;,u),y.attr(\\\&quot;x2\\\&quot;,0).attr(\\\&quot;y2\\\&quot;,u),N.attr(\\\&quot;y2\\\&quot;,i),C.attr(\\\&quot;y\\\&quot;,Math.max(i,0)+o),q.attr(\\\&quot;x2\\\&quot;,0).attr(\\\&quot;y2\\\&quot;,i),z.attr(\\\&quot;x\\\&quot;,0).attr(\\\&quot;y\\\&quot;,Math.max(i,0)+o),T.attr(\\\&quot;dy\\\&quot;,\\\&quot;.71em\\\&quot;).style(\\\&quot;text-anchor\\\&quot;,\\\&quot;middle\\\&quot;),E.attr(\\\&quot;d\\\&quot;,\\\&quot;M\\\&quot;+w[0]+\\\&quot;,\\\&quot;+a+\\\&quot;V0H\\\&quot;+w[1]+\\\&quot;V\\\&quot;+a);break;case\\\&quot;top\\\&quot;:n=ku,m.attr(\\\&quot;y2\\\&quot;,-u),y.attr(\\\&quot;x2\\\&quot;,0).attr(\\\&quot;y2\\\&quot;,-u),N.attr(\\\&quot;y2\\\&quot;,-i),C.attr(\\\&quot;y\\\&quot;,-(Math.max(i,0)+o)),q.attr(\\\&quot;x2\\\&quot;,0).attr(\\\&quot;y2\\\&quot;,-i),z.attr(\\\&quot;x\\\&quot;,0).attr(\\\&quot;y\\\&quot;,-(Math.max(i,0)+o)),T.attr(\\\&quot;dy\\\&quot;,\\\&quot;0em\\\&quot;).style(\\\&quot;text-anchor\\\&quot;,\\\&quot;middle\\\&quot;),E.attr(\\\&quot;d\\\&quot;,\\\&quot;M\\\&quot;+w[0]+\\\&quot;,\\\&quot;+-a+\\\&quot;V0H\\\&quot;+w[1]+\\\&quot;V\\\&quot;+-a);break;case\\\&quot;left\\\&quot;:n=Au,m.attr(\\\&quot;x2\\\&quot;,-u),y.attr(\\\&quot;x2\\\&quot;,-u).attr(\\\&quot;y2\\\&quot;,0),N.attr(\\\&quot;x2\\\&quot;,-i),C.attr(\\\&quot;x\\\&quot;,-(Math.max(i,0)+o)),q.attr(\\\&quot;x2\\\&quot;,-i).attr(\\\&quot;y2\\\&quot;,0),z.attr(\\\&quot;x\\\&quot;,-(Math.max(i,0)+o)).attr(\\\&quot;y\\\&quot;,0),T.attr(\\\&quot;dy\\\&quot;,\\\&quot;.32em\\\&quot;).style(\\\&quot;text-anchor\\\&quot;,\\\&quot;end\\\&quot;),E.attr(\\\&quot;d\\\&quot;,\\\&quot;M\\\&quot;+-a+\\\&quot;,\\\&quot;+w[0]+\\\&quot;H0V\\\&quot;+w[1]+\\\&quot;H\\\&quot;+-a);break;case\\\&quot;right\\\&quot;:n=Au,m.attr(\\\&quot;x2\\\&quot;,u),y.attr(\\\&quot;x2\\\&quot;,u).attr(\\\&quot;y2\\\&quot;,0),N.attr(\\\&quot;x2\\\&quot;,i),C.attr(\\\&quot;x\\\&quot;,Math.max(i,0)+o),q.attr(\\\&quot;x2\\\&quot;,i).attr(\\\&quot;y2\\\&quot;,0),z.attr(\\\&quot;x\\\&quot;,Math.max(i,0)+o).attr(\\\&quot;y\\\&quot;,0),T.attr(\\\&quot;dy\\\&quot;,\\\&quot;.32em\\\&quot;).style(\\\&quot;text-anchor\\\&quot;,\\\&quot;start\\\&quot;),E.attr(\\\&quot;d\\\&quot;,\\\&quot;M\\\&quot;+a+\\\&quot;,\\\&quot;+w[0]+\\\&quot;H0V\\\&quot;+w[1]+\\\&quot;H\\\&quot;+a)}if(e.rangeBand){var D=k.rangeBand()/2,j=function(n){return k(n)+D};x.call(n,j),_.call(n,j)}else x.call(n,A),_.call(n,k),b.call(n,k),m.call(n,A),y.call(n,k),v.call(n,k)})}var t,e=da.scale.linear(),r=Pc,i=6,u=6,a=6,o=3,c=[10],l=null,s=0;return n.scale=function(t){return arguments.length?(e=t,n):e},n.orient=function(t){return arguments.length?(r=t in Oc?t+\\\&quot;\\\&quot;:Pc,n):r},n.ticks=function(){return arguments.length?(c=arguments,n):c},n.tickValues=function(t){return arguments.length?(l=t,n):l},n.tickFormat=function(e){return arguments.length?(t=e,n):t},n.tickSize=function(t,e){if(!arguments.length)return i;var r=arguments.length-1;return i=+t,u=r&gt;1?+e:i,a=r&gt;0?+arguments[r]:i,n},n.tickPadding=function(t){return arguments.length?(o=+t,n):o},n.tickSubdivide=function(t){return arguments.length?(s=+t,n):s},n};var Pc=\\\&quot;bottom\\\&quot;,Oc={top:1,right:1,bottom:1,left:1};da.svg.brush=function(){function n(u){u.each(function(){var u,a=da.select(this),s=a.selectAll(\\\&quot;.background\\\&quot;).data([0]),f=a.selectAll(\\\&quot;.extent\\\&quot;).data([0]),h=a.selectAll(\\\&quot;.resize\\\&quot;).data(l,String);a.style(\\\&quot;pointer-events\\\&quot;,\\\&quot;all\\\&quot;).on(\\\&quot;mousedown.brush\\\&quot;,i).on(\\\&quot;touchstart.brush\\\&quot;,i),s.enter().append(\\\&quot;rect\\\&quot;).attr(\\\&quot;class\\\&quot;,\\\&quot;background\\\&quot;).style(\\\&quot;visibility\\\&quot;,\\\&quot;hidden\\\&quot;).style(\\\&quot;cursor\\\&quot;,\\\&quot;crosshair\\\&quot;),f.enter().append(\\\&quot;rect\\\&quot;).attr(\\\&quot;class\\\&quot;,\\\&quot;extent\\\&quot;).style(\\\&quot;cursor\\\&quot;,\\\&quot;move\\\&quot;),h.enter().append(\\\&quot;g\\\&quot;).attr(\\\&quot;class\\\&quot;,function(n){return\\\&quot;resize \\\&quot;+n}).style(\\\&quot;cursor\\\&quot;,function(n){return Yc[n]}).append(\\\&quot;rect\\\&quot;).attr(\\\&quot;x\\\&quot;,function(n){return/[ew]$/.test(n)?-3:null}).attr(\\\&quot;y\\\&quot;,function(n){return/^[ns]/.test(n)?-3:null}).attr(\\\&quot;width\\\&quot;,6).attr(\\\&quot;height\\\&quot;,6).style(\\\&quot;visibility\\\&quot;,\\\&quot;hidden\\\&quot;),h.style(\\\&quot;display\\\&quot;,n.empty()?\\\&quot;none\\\&quot;:null),h.exit().remove(),o&amp;&amp;(u=Vi(o),s.attr(\\\&quot;x\\\&quot;,u[0]).attr(\\\&quot;width\\\&quot;,u[1]-u[0]),e(a)),c&amp;&amp;(u=Vi(c),s.attr(\\\&quot;y\\\&quot;,u[0]).attr(\\\&quot;height\\\&quot;,u[1]-u[0]),r(a)),t(a)})}function t(n){n.selectAll(\\\&quot;.resize\\\&quot;).attr(\\\&quot;transform\\\&quot;,function(n){return\\\&quot;translate(\\\&quot;+s[+/e$/.test(n)][0]+\\\&quot;,\\\&quot;+s[+/^s/.test(n)][1]+\\\&quot;)\\\&quot;})}function e(n){n.select(\\\&quot;.extent\\\&quot;).attr(\\\&quot;x\\\&quot;,s[0][0]),n.selectAll(\\\&quot;.extent,.n&gt;rect,.s&gt;rect\\\&quot;).attr(\\\&quot;width\\\&quot;,s[1][0]-s[0][0])}function r(n){n.select(\\\&quot;.extent\\\&quot;).attr(\\\&quot;y\\\&quot;,s[0][1]),n.selectAll(\\\&quot;.extent,.e&gt;rect,.w&gt;rect\\\&quot;).attr(\\\&quot;height\\\&quot;,s[1][1]-s[0][1])}function i(){function i(){var n=da.event.changedTouches;return n?da.touches(M,n)[0]:da.mouse(M)}function l(){32==da.event.keyCode&amp;&amp;(k||(v=null,N[0]-=s[1][0],N[1]-=s[1][1],k=2),g())}function h(){32==da.event.keyCode&amp;&amp;2==k&amp;&amp;(N[0]+=s[1][0],N[1]+=s[1][1],k=0,g())}function p(){var n=i(),u=!1;y&amp;&amp;(n[0]+=y[0],n[1]+=y[1]),k||(da.event.altKey?(v||(v=[(s[0][0]+s[1][0])/2,(s[0][1]+s[1][1])/2]),N[0]=s[+(n[0]\u003Cv[0])][0],N[1]=s[+(n[1]\u003Cv[1])][1]):v=null),S&amp;&amp;d(n,o,0)&amp;&amp;(e(_),u=!0),E&amp;&amp;d(n,c,1)&amp;&amp;(r(_),u=!0),u&amp;&amp;(t(_),b({type:\\\&quot;brush\\\&quot;,mode:k?\\\&quot;move\\\&quot;:\\\&quot;resize\\\&quot;}))}function d(n,t,e){var r,i,a=Vi(t),o=a[0],c=a[1],l=N[e],h=s[1][e]-s[0][e];return k&amp;&amp;(o-=l,c-=h+l),r=f[e]?Math.max(o,Math.min(c,n[e])):n[e],k?i=(r+=l)+h:(v&amp;&amp;(l=Math.max(o,Math.min(c,2*v[e]-r))),r&gt;l?(i=r,r=l):i=l),s[0][e]!==r||s[1][e]!==i?(u=null,s[0][e]=r,s[1][e]=i,!0):void 0}function m(){p(),_.style(\\\&quot;pointer-events\\\&quot;,\\\&quot;all\\\&quot;).selectAll(\\\&quot;.resize\\\&quot;).style(\\\&quot;display\\\&quot;,n.empty()?\\\&quot;none\\\&quot;:null),da.select(\\\&quot;body\\\&quot;).style(\\\&quot;cursor\\\&quot;,null),q.on(\\\&quot;mousemove.brush\\\&quot;,null).on(\\\&quot;mouseup.brush\\\&quot;,null).on(\\\&quot;touchmove.brush\\\&quot;,null).on(\\\&quot;touchend.brush\\\&quot;,null).on(\\\&quot;keydown.brush\\\&quot;,null).on(\\\&quot;keyup.brush\\\&quot;,null),A(),b({type:\\\&quot;brushend\\\&quot;})}var v,y,M=this,x=da.select(da.event.target),b=a.of(M,arguments),_=da.select(M),w=x.datum(),S=!/^(n|s)$/.test(w)&amp;&amp;o,E=!/^(e|w)$/.test(w)&amp;&amp;c,k=x.classed(\\\&quot;extent\\\&quot;),A=H(),N=i(),q=da.select(ya).on(\\\&quot;keydown.brush\\\&quot;,l).on(\\\&quot;keyup.brush\\\&quot;,h);if(da.event.changedTouches?q.on(\\\&quot;touchmove.brush\\\&quot;,p).on(\\\&quot;touchend.brush\\\&quot;,m):q.on(\\\&quot;mousemove.brush\\\&quot;,p).on(\\\&quot;mouseup.brush\\\&quot;,m),k)N[0]=s[0][0]-N[0],N[1]=s[0][1]-N[1];else if(w){var T=+/w$/.test(w),C=+/^n/.test(w);y=[s[1-T][0]-N[0],s[1-C][1]-N[1]],N[0]=s[T][0],N[1]=s[C][1]}else da.event.altKey&amp;&amp;(v=N.slice());_.style(\\\&quot;pointer-events\\\&quot;,\\\&quot;none\\\&quot;).selectAll(\\\&quot;.resize\\\&quot;).style(\\\&quot;display\\\&quot;,null),da.select(\\\&quot;body\\\&quot;).style(\\\&quot;cursor\\\&quot;,x.style(\\\&quot;cursor\\\&quot;)),b({type:\\\&quot;brushstart\\\&quot;}),p()}var u,a=d(n,\\\&quot;brushstart\\\&quot;,\\\&quot;brush\\\&quot;,\\\&quot;brushend\\\&quot;),o=null,c=null,l=Rc[0],s=[[0,0],[0,0]],f=[!0,!0];return n.x=function(t){return arguments.length?(o=t,l=Rc[!o\u003C\u003C1|!c],n):o},n.y=function(t){return arguments.length?(c=t,l=Rc[!o\u003C\u003C1|!c],n):c},n.clamp=function(t){return arguments.length?(o&amp;&amp;c?f=[!!t[0],!!t[1]]:(o||c)&amp;&amp;(f[+!o]=!!t),n):o&amp;&amp;c?f:o||c?f[+!o]:null},n.extent=function(t){var e,r,i,a,l;return arguments.length?(u=[[0,0],[0,0]],o&amp;&amp;(e=t[0],r=t[1],c&amp;&amp;(e=e[0],r=r[0]),u[0][0]=e,u[1][0]=r,o.invert&amp;&amp;(e=o(e),r=o(r)),e&gt;r&amp;&amp;(l=e,e=r,r=l),s[0][0]=0|e,s[1][0]=0|r),c&amp;&amp;(i=t[0],a=t[1],o&amp;&amp;(i=i[1],a=a[1]),u[0][1]=i,u[1][1]=a,c.invert&amp;&amp;(i=c(i),a=c(a)),i&gt;a&amp;&amp;(l=i,i=a,a=l),s[0][1]=0|i,s[1][1]=0|a),n):(t=u||s,o&amp;&amp;(e=t[0][0],r=t[1][0],u||(e=s[0][0],r=s[1][0],o.invert&amp;&amp;(e=o.invert(e),r=o.invert(r)),e&gt;r&amp;&amp;(l=e,e=r,r=l))),c&amp;&amp;(i=t[0][1],a=t[1][1],u||(i=s[0][1],a=s[1][1],c.invert&amp;&amp;(i=c.invert(i),a=c.invert(a)),i&gt;a&amp;&amp;(l=i,i=a,a=l))),o&amp;&amp;c?[[e,i],[r,a]]:o?[e,r]:c&amp;&amp;[i,a])},n.clear=function(){return u=null,s[0][0]=s[0][1]=s[1][0]=s[1][1]=0,n},n.empty=function(){return o&amp;&amp;s[0][0]===s[1][0]||c&amp;&amp;s[0][1]===s[1][1]},da.rebind(n,a,\\\&quot;on\\\&quot;)};var Yc={n:\\\&quot;ns-resize\\\&quot;,e:\\\&quot;ew-resize\\\&quot;,s:\\\&quot;ns-resize\\\&quot;,w:\\\&quot;ew-resize\\\&quot;,nw:\\\&quot;nwse-resize\\\&quot;,ne:\\\&quot;nesw-resize\\\&quot;,se:\\\&quot;nwse-resize\\\&quot;,sw:\\\&quot;nesw-resize\\\&quot;},Rc=[[\\\&quot;n\\\&quot;,\\\&quot;e\\\&quot;,\\\&quot;s\\\&quot;,\\\&quot;w\\\&quot;,\\\&quot;nw\\\&quot;,\\\&quot;ne\\\&quot;,\\\&quot;se\\\&quot;,\\\&quot;sw\\\&quot;],[\\\&quot;e\\\&quot;,\\\&quot;w\\\&quot;],[\\\&quot;n\\\&quot;,\\\&quot;s\\\&quot;],[]];da.time={};var Uc=Date,Ic=[\\\&quot;Sunday\\\&quot;,\\\&quot;Monday\\\&quot;,\\\&quot;Tuesday\\\&quot;,\\\&quot;Wednesday\\\&quot;,\\\&quot;Thursday\\\&quot;,\\\&quot;Friday\\\&quot;,\\\&quot;Saturday\\\&quot;];qu.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){Vc.setUTCDate.apply(this._,arguments)},setDay:function(){Vc.setUTCDay.apply(this._,arguments)},setFullYear:function(){Vc.setUTCFullYear.apply(this._,arguments)},setHours:function(){Vc.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){Vc.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){Vc.setUTCMinutes.apply(this._,arguments)},setMonth:function(){Vc.setUTCMonth.apply(this._,arguments)},setSeconds:function(){Vc.setUTCSeconds.apply(this._,arguments)},setTime:function(){Vc.setTime.apply(this._,arguments)}};var Vc=Date.prototype,Xc=\\\&quot;%a %b %e %X %Y\\\&quot;,Zc=\\\&quot;%m/%d/%Y\\\&quot;,Bc=\\\&quot;%H:%M:%S\\\&quot;,$c=[\\\&quot;Sunday\\\&quot;,\\\&quot;Monday\\\&quot;,\\\&quot;Tuesday\\\&quot;,\\\&quot;Wednesday\\\&quot;,\\\&quot;Thursday\\\&quot;,\\\&quot;Friday\\\&quot;,\\\&quot;Saturday\\\&quot;],Wc=[\\\&quot;Sun\\\&quot;,\\\&quot;Mon\\\&quot;,\\\&quot;Tue\\\&quot;,\\\&quot;Wed\\\&quot;,\\\&quot;Thu\\\&quot;,\\\&quot;Fri\\\&quot;,\\\&quot;Sat\\\&quot;],Jc=[\\\&quot;January\\\&quot;,\\\&quot;February\\\&quot;,\\\&quot;March\\\&quot;,\\\&quot;April\\\&quot;,\\\&quot;May\\\&quot;,\\\&quot;June\\\&quot;,\\\&quot;July\\\&quot;,\\\&quot;August\\\&quot;,\\\&quot;September\\\&quot;,\\\&quot;October\\\&quot;,\\\&quot;November\\\&quot;,\\\&quot;December\\\&quot;],Gc=[\\\&quot;Jan\\\&quot;,\\\&quot;Feb\\\&quot;,\\\&quot;Mar\\\&quot;,\\\&quot;Apr\\\&quot;,\\\&quot;May\\\&quot;,\\\&quot;Jun\\\&quot;,\\\&quot;Jul\\\&quot;,\\\&quot;Aug\\\&quot;,\\\&quot;Sep\\\&quot;,\\\&quot;Oct\\\&quot;,\\\&quot;Nov\\\&quot;,\\\&quot;Dec\\\&quot;];da.time.year=Tu(function(n){return n=da.time.day(n),n.setMonth(0,1),n},function(n,t){n.setFullYear(n.getFullYear()+t)},function(n){return n.getFullYear()}),da.time.years=da.time.year.range,da.time.years.utc=da.time.year.utc.range,da.time.day=Tu(function(n){var t=new Uc(2e3,0);return t.setFullYear(n.getFullYear(),n.getMonth(),n.getDate()),t},function(n,t){n.setDate(n.getDate()+t)},function(n){return n.getDate()-1}),da.time.days=da.time.day.range,da.time.days.utc=da.time.day.utc.range,da.time.dayOfYear=function(n){var t=da.time.year(n);return Math.floor((n-t-6e4*(n.getTimezoneOffset()-t.getTimezoneOffset()))/864e5)},Ic.forEach(function(n,t){n=n.toLowerCase(),t=7-t;var e=da.time[n]=Tu(function(n){return(n=da.time.day(n)).setDate(n.getDate()-(n.getDay()+t)%7),n},function(n,t){n.setDate(n.getDate()+7*Math.floor(t))},function(n){var e=da.time.year(n).getDay();return Math.floor((da.time.dayOfYear(n)+(e+t)%7)/7)-(e!==t)});da.time[n+\\\&quot;s\\\&quot;]=e.range,da.time[n+\\\&quot;s\\\&quot;].utc=e.utc.range,da.time[n+\\\&quot;OfYear\\\&quot;]=function(n){var e=da.time.year(n).getDay();return Math.floor((da.time.dayOfYear(n)+(e+t)%7)/7)}}),da.time.week=da.time.sunday,da.time.weeks=da.time.sunday.range,da.time.weeks.utc=da.time.sunday.utc.range,da.time.weekOfYear=da.time.sundayOfYear,da.time.format=function(n){function t(t){for(var r,i,u,a=[],o=-1,c=0;++o\u003Ce;)37===n.charCodeAt(o)&amp;&amp;(a.push(n.substring(c,o)),null!=(i=ol[r=n.charAt(++o)])&amp;&amp;(r=n.charAt(++o)),(u=cl[r])&amp;&amp;(r=u(t,null==i?\\\&quot;e\\\&quot;===r?\\\&quot; \\\&quot;:\\\&quot;0\\\&quot;:i)),a.push(r),c=o+1);return a.push(n.substring(c,o)),a.join(\\\&quot;\\\&quot;)}var e=n.length;return t.parse=function(t){var e={y:1900,m:0,d:1,H:0,M:0,S:0,L:0},r=zu(e,n,t,0);if(r!=t.length)return null;\\\&quot;p\\\&quot;in e&amp;&amp;(e.H=e.H%12+12*e.p);var i=new Uc;return\\\&quot;j\\\&quot;in e?i.setFullYear(e.y,0,e.j):\\\&quot;w\\\&quot;in e&amp;&amp;(\\\&quot;W\\\&quot;in e||\\\&quot;U\\\&quot;in e)?(i.setFullYear(e.y,0,1),i.setFullYear(e.y,0,\\\&quot;W\\\&quot;in e?(e.w+6)%7+7*e.W-(i.getDay()+5)%7:e.w+7*e.U-(i.getDay()+6)%7)):i.setFullYear(e.y,e.m,e.d),i.setHours(e.H,e.M,e.S,e.L),i},t.toString=function(){return n},t};var Kc=Du($c),Qc=ju($c),nl=Du(Wc),tl=ju(Wc),el=Du(Jc),rl=ju(Jc),il=Du(Gc),ul=ju(Gc),al=/^%/,ol={\\\&quot;-\\\&quot;:\\\&quot;\\\&quot;,_:\\\&quot; \\\&quot;,0:\\\&quot;0\\\&quot;},cl={a:function(n){return Wc[n.getDay()]},A:function(n){return $c[n.getDay()]},b:function(n){return Gc[n.getMonth()]},B:function(n){return Jc[n.getMonth()]},c:da.time.format(Xc),d:function(n,t){return Lu(n.getDate(),t,2)},e:function(n,t){return Lu(n.getDate(),t,2)},H:function(n,t){return Lu(n.getHours(),t,2)},I:function(n,t){return Lu(n.getHours()%12||12,t,2)},j:function(n,t){return Lu(1+da.time.dayOfYear(n),t,3)},L:function(n,t){return Lu(n.getMilliseconds(),t,3)},m:function(n,t){return Lu(n.getMonth()+1,t,2)},M:function(n,t){return Lu(n.getMinutes(),t,2)},p:function(n){return n.getHours()&gt;=12?\\\&quot;PM\\\&quot;:\\\&quot;AM\\\&quot;},S:function(n,t){return Lu(n.getSeconds(),t,2)},U:function(n,t){return Lu(da.time.sundayOfYear(n),t,2)},w:function(n){return n.getDay()},W:function(n,t){return Lu(da.time.mondayOfYear(n),t,2)},x:da.time.format(Zc),X:da.time.format(Bc),y:function(n,t){return Lu(n.getFullYear()%100,t,2)},Y:function(n,t){return Lu(n.getFullYear()%1e4,t,4)},Z:ra,\\\&quot;%\\\&quot;:function(){return\\\&quot;%\\\&quot;}},ll={a:Hu,A:Fu,b:Ru,B:Uu,c:Iu,d:Ju,e:Ju,H:Ku,I:Ku,j:Gu,L:ta,m:Wu,M:Qu,p:ea,S:na,U:Ou,w:Pu,W:Yu,x:Vu,X:Xu,y:Bu,Y:Zu,\\\&quot;%\\\&quot;:ia},sl=/^\\\\s*\\\\d+/,fl=da.map({am:0,pm:1});da.time.format.utc=function(n){function t(n){try{Uc=qu;var t=new Uc;return t._=n,e(t)}finally{Uc=Date}}var e=da.time.format(n);return t.parse=function(n){try{Uc=qu;var t=e.parse(n);return t&amp;&amp;t._}finally{Uc=Date}},t.toString=e.toString,t};var hl=da.time.format.utc(\\\&quot;%Y-%m-%dT%H:%M:%S.%LZ\\\&quot;);da.time.format.iso=Date.prototype.toISOString&amp;&amp;+new Date(\\\&quot;2000-01-01T00:00:00.000Z\\\&quot;)?ua:hl,ua.parse=function(n){var t=new Date(n);return isNaN(t)?null:t},ua.toString=hl.toString,da.time.second=Tu(function(n){return new Uc(1e3*Math.floor(n/1e3))},function(n,t){n.setTime(n.getTime()+1e3*Math.floor(t))},function(n){return n.getSeconds()}),da.time.seconds=da.time.second.range,da.time.seconds.utc=da.time.second.utc.range,da.time.minute=Tu(function(n){return new Uc(6e4*Math.floor(n/6e4))},function(n,t){n.setTime(n.getTime()+6e4*Math.floor(t))},function(n){return n.getMinutes()}),da.time.minutes=da.time.minute.range,da.time.minutes.utc=da.time.minute.utc.range,da.time.hour=Tu(function(n){var t=n.getTimezoneOffset()/60;return new Uc(36e5*(Math.floor(n/36e5-t)+t))},function(n,t){n.setTime(n.getTime()+36e5*Math.floor(t))},function(n){return n.getHours()}),da.time.hours=da.time.hour.range,da.time.hours.utc=da.time.hour.utc.range,da.time.month=Tu(function(n){return n=da.time.day(n),n.setDate(1),n},function(n,t){n.setMonth(n.getMonth()+t)},function(n){return n.getMonth()}),da.time.months=da.time.month.range,da.time.months.utc=da.time.month.utc.range;var gl=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6],pl=[[da.time.second,1],[da.time.second,5],[da.time.second,15],[da.time.second,30],[da.time.minute,1],[da.time.minute,5],[da.time.minute,15],[da.time.minute,30],[da.time.hour,1],[da.time.hour,3],[da.time.hour,6],[da.time.hour,12],[da.time.day,1],[da.time.day,2],[da.time.week,1],[da.time.month,1],[da.time.month,3],[da.time.year,1]],dl=[[da.time.format(\\\&quot;%Y\\\&quot;),Ut],[da.time.format(\\\&quot;%B\\\&quot;),function(n){return n.getMonth()}],[da.time.format(\\\&quot;%b %d\\\&quot;),function(n){return 1!=n.getDate()}],[da.time.format(\\\&quot;%a %d\\\&quot;),function(n){return n.getDay()&amp;&amp;1!=n.getDate()}],[da.time.format(\\\&quot;%I %p\\\&quot;),function(n){return n.getHours()}],[da.time.format(\\\&quot;%I:%M\\\&quot;),function(n){return n.getMinutes()}],[da.time.format(\\\&quot;:%S\\\&quot;),function(n){return n.getSeconds()}],[da.time.format(\\\&quot;.%L\\\&quot;),function(n){return n.getMilliseconds()}]],ml=da.scale.linear(),vl=ca(dl);pl.year=function(n,t){return ml.domain(n.map(sa)).ticks(t).map(la)},da.time.scale=function(){return aa(da.scale.linear(),pl,vl)};var yl=pl.map(function(n){return[n[0].utc,n[1]]}),Ml=[[da.time.format.utc(\\\&quot;%Y\\\&quot;),Ut],[da.time.format.utc(\\\&quot;%B\\\&quot;),function(n){return n.getUTCMonth()}],[da.time.format.utc(\\\&quot;%b %d\\\&quot;),function(n){return 1!=n.getUTCDate()}],[da.time.format.utc(\\\&quot;%a %d\\\&quot;),function(n){return n.getUTCDay()&amp;&amp;1!=n.getUTCDate()}],[da.time.format.utc(\\\&quot;%I %p\\\&quot;),function(n){return n.getUTCHours()}],[da.time.format.utc(\\\&quot;%I:%M\\\&quot;),function(n){return n.getUTCMinutes()}],[da.time.format.utc(\\\&quot;:%S\\\&quot;),function(n){return n.getUTCSeconds()}],[da.time.format.utc(\\\&quot;.%L\\\&quot;),function(n){return n.getUTCMilliseconds()}]],xl=ca(Ml);return yl.year=function(n,t){return ml.domain(n.map(ha)).ticks(t).map(fa)},da.time.scale.utc=function(){return aa(da.scale.linear(),yl,xl)},da.text=pt(function(n){return n.responseText}),da.json=function(n,t){return dt(n,\\\&quot;application/json\\\&quot;,ga,t)},da.html=function(n,t){return dt(n,\\\&quot;text/html\\\&quot;,pa,t)},da.xml=pt(function(n){return n.responseXML}),da}();}\\nexports.d3 = d3;\\n\&quot;,\&quot;type\&quot;:\&quot;application/javascript\&quot;,\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/d3.js\&quot;,\&quot;module-type\&quot;:\&quot;library\&quot;},\&quot;$:/plugins/tiddlywiki/d3/d3.layout.cloud.js\&quot;:{\&quot;text\&quot;:\&quot;// Word cloud layout by Jason Davies, http://www.jasondavies.com/word-cloud/\\n// Algorithm due to Jonathan Feinberg, http://static.mrfeinberg.com/bv_ch03.pdf\\n(function(exports) {\\n  function cloud() {\\n    var size = [256, 256],\\n        text = cloudText,\\n        font = cloudFont,\\n        fontSize = cloudFontSize,\\n        fontStyle = cloudFontNormal,\\n        fontWeight = cloudFontNormal,\\n        rotate = cloudRotate,\\n        padding = cloudPadding,\\n        spiral = archimedeanSpiral,\\n        words = [],\\n        timeInterval = Infinity,\\n        event = d3.dispatch(\\\&quot;word\\\&quot;, \\\&quot;end\\\&quot;),\\n        timer = null,\\n        cloud = {};\\n\\n    cloud.start = function() {\\n      var board = zeroArray((size[0] &gt;&gt; 5) * size[1]),\\n          bounds = null,\\n          n = words.length,\\n          i = -1,\\n          tags = [],\\n          data = words.map(function(d, i) {\\n            d.text = text.call(this, d, i);\\n            d.font = font.call(this, d, i);\\n            d.style = fontStyle.call(this, d, i);\\n            d.weight = fontWeight.call(this, d, i);\\n            d.rotate = rotate.call(this, d, i);\\n            d.size = ~~fontSize.call(this, d, i);\\n            d.padding = padding.call(this, d, i);\\n            return d;\\n          }).sort(function(a, b) { return b.size - a.size; });\\n\\n      if (timer) clearInterval(timer);\\n      timer = setInterval(step, 0);\\n      step();\\n\\n      return cloud;\\n\\n      function step() {\\n        var start = +new Date,\\n            d;\\n        while (+new Date - start \u003C timeInterval &amp;&amp; ++i \u003C n &amp;&amp; timer) {\\n          d = data[i];\\n          d.x = (size[0] * (Math.random() + .5)) &gt;&gt; 1;\\n          d.y = (size[1] * (Math.random() + .5)) &gt;&gt; 1;\\n          cloudSprite(d, data, i);\\n          if (d.hasText &amp;&amp; place(board, d, bounds)) {\\n            tags.push(d);\\n            event.word(d);\\n            if (bounds) cloudBounds(bounds, d);\\n            else bounds = [{x: d.x + d.x0, y: d.y + d.y0}, {x: d.x + d.x1, y: d.y + d.y1}];\\n            // Temporary hack\\n            d.x -= size[0] &gt;&gt; 1;\\n            d.y -= size[1] &gt;&gt; 1;\\n          }\\n        }\\n        if (i &gt;= n) {\\n          cloud.stop();\\n          event.end(tags, bounds);\\n        }\\n      }\\n    }\\n\\n    cloud.stop = function() {\\n      if (timer) {\\n        clearInterval(timer);\\n        timer = null;\\n      }\\n      return cloud;\\n    };\\n\\n    cloud.timeInterval = function(x) {\\n      if (!arguments.length) return timeInterval;\\n      timeInterval = x == null ? Infinity : x;\\n      return cloud;\\n    };\\n\\n    function place(board, tag, bounds) {\\n      var perimeter = [{x: 0, y: 0}, {x: size[0], y: size[1]}],\\n          startX = tag.x,\\n          startY = tag.y,\\n          maxDelta = Math.sqrt(size[0] * size[0] + size[1] * size[1]),\\n          s = spiral(size),\\n          dt = Math.random() \u003C .5 ? 1 : -1,\\n          t = -dt,\\n          dxdy,\\n          dx,\\n          dy;\\n\\n      while (dxdy = s(t += dt)) {\\n        dx = ~~dxdy[0];\\n        dy = ~~dxdy[1];\\n\\n        if (Math.min(dx, dy) &gt; maxDelta) break;\\n\\n        tag.x = startX + dx;\\n        tag.y = startY + dy;\\n\\n        if (tag.x + tag.x0 \u003C 0 || tag.y + tag.y0 \u003C 0 ||\\n            tag.x + tag.x1 &gt; size[0] || tag.y + tag.y1 &gt; size[1]) continue;\\n        // TODO only check for collisions within current bounds.\\n        if (!bounds || !cloudCollide(tag, board, size[0])) {\\n          if (!bounds || collideRects(tag, bounds)) {\\n            var sprite = tag.sprite,\\n                w = tag.width &gt;&gt; 5,\\n                sw = size[0] &gt;&gt; 5,\\n                lx = tag.x - (w \u003C\u003C 4),\\n                sx = lx &amp; 0x7f,\\n                msx = 32 - sx,\\n                h = tag.y1 - tag.y0,\\n                x = (tag.y + tag.y0) * sw + (lx &gt;&gt; 5),\\n                last;\\n            for (var j = 0; j \u003C h; j++) {\\n              last = 0;\\n              for (var i = 0; i \u003C= w; i++) {\\n                board[x + i] |= (last \u003C\u003C msx) | (i \u003C w ? (last = sprite[j * w + i]) &gt;&gt;&gt; sx : 0);\\n              }\\n              x += sw;\\n            }\\n            delete tag.sprite;\\n            return true;\\n          }\\n        }\\n      }\\n      return false;\\n    }\\n\\n    cloud.words = function(x) {\\n      if (!arguments.length) return words;\\n      words = x;\\n      return cloud;\\n    };\\n\\n    cloud.size = function(x) {\\n      if (!arguments.length) return size;\\n      size = [+x[0], +x[1]];\\n      return cloud;\\n    };\\n\\n    cloud.font = function(x) {\\n      if (!arguments.length) return font;\\n      font = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.fontStyle = function(x) {\\n      if (!arguments.length) return fontStyle;\\n      fontStyle = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.fontWeight = function(x) {\\n      if (!arguments.length) return fontWeight;\\n      fontWeight = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.rotate = function(x) {\\n      if (!arguments.length) return rotate;\\n      rotate = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.text = function(x) {\\n      if (!arguments.length) return text;\\n      text = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.spiral = function(x) {\\n      if (!arguments.length) return spiral;\\n      spiral = spirals[x + \\\&quot;\\\&quot;] || x;\\n      return cloud;\\n    };\\n\\n    cloud.fontSize = function(x) {\\n      if (!arguments.length) return fontSize;\\n      fontSize = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    cloud.padding = function(x) {\\n      if (!arguments.length) return padding;\\n      padding = d3.functor(x);\\n      return cloud;\\n    };\\n\\n    return d3.rebind(cloud, event, \\\&quot;on\\\&quot;);\\n  }\\n\\n  function cloudText(d) {\\n    return d.text;\\n  }\\n\\n  function cloudFont() {\\n    return \\\&quot;serif\\\&quot;;\\n  }\\n\\n  function cloudFontNormal() {\\n    return \\\&quot;normal\\\&quot;;\\n  }\\n\\n  function cloudFontSize(d) {\\n    return Math.sqrt(d.value);\\n  }\\n\\n  function cloudRotate() {\\n    return (~~(Math.random() * 6) - 3) * 30;\\n  }\\n\\n  function cloudPadding() {\\n    return 1;\\n  }\\n\\n  // Fetches a monochrome sprite bitmap for the specified text.\\n  // Load in batches for speed.\\n  function cloudSprite(d, data, di) {\\n    if (d.sprite) return;\\n    c.clearRect(0, 0, (cw \u003C\u003C 5) / ratio, ch / ratio);\\n    var x = 0,\\n        y = 0,\\n        maxh = 0,\\n        n = data.length;\\n    --di;\\n    while (++di \u003C n) {\\n      d = data[di];\\n      c.save();\\n      c.font = d.style + \\\&quot; \\\&quot; + d.weight + \\\&quot; \\\&quot; + ~~((d.size + 1) / ratio) + \\\&quot;px \\\&quot; + d.font;\\n      var w = c.measureText(d.text + \\\&quot;m\\\&quot;).width * ratio,\\n          h = d.size \u003C\u003C 1;\\n      if (d.rotate) {\\n        var sr = Math.sin(d.rotate * cloudRadians),\\n            cr = Math.cos(d.rotate * cloudRadians),\\n            wcr = w * cr,\\n            wsr = w * sr,\\n            hcr = h * cr,\\n            hsr = h * sr;\\n        w = (Math.max(Math.abs(wcr + hsr), Math.abs(wcr - hsr)) + 0x1f) &gt;&gt; 5 \u003C\u003C 5;\\n        h = ~~Math.max(Math.abs(wsr + hcr), Math.abs(wsr - hcr));\\n      } else {\\n        w = (w + 0x1f) &gt;&gt; 5 \u003C\u003C 5;\\n      }\\n      if (h &gt; maxh) maxh = h;\\n      if (x + w &gt;= (cw \u003C\u003C 5)) {\\n        x = 0;\\n        y += maxh;\\n        maxh = 0;\\n      }\\n      if (y + h &gt;= ch) break;\\n      c.translate((x + (w &gt;&gt; 1)) / ratio, (y + (h &gt;&gt; 1)) / ratio);\\n      if (d.rotate) c.rotate(d.rotate * cloudRadians);\\n      c.fillText(d.text, 0, 0);\\n      if (d.padding) c.lineWidth = 2 * d.padding, c.strokeText(d.text, 0, 0);\\n      c.restore();\\n      d.width = w;\\n      d.height = h;\\n      d.xoff = x;\\n      d.yoff = y;\\n      d.x1 = w &gt;&gt; 1;\\n      d.y1 = h &gt;&gt; 1;\\n      d.x0 = -d.x1;\\n      d.y0 = -d.y1;\\n      d.hasText = true;\\n      x += w;\\n    }\\n    var pixels = c.getImageData(0, 0, (cw \u003C\u003C 5) / ratio, ch / ratio).data,\\n        sprite = [];\\n    while (--di &gt;= 0) {\\n      d = data[di];\\n      if (!d.hasText) continue;\\n      var w = d.width,\\n          w32 = w &gt;&gt; 5,\\n          h = d.y1 - d.y0;\\n      // Zero the buffer\\n      for (var i = 0; i \u003C h * w32; i++) sprite[i] = 0;\\n      x = d.xoff;\\n      if (x == null) return;\\n      y = d.yoff;\\n      var seen = 0,\\n          seenRow = -1;\\n      for (var j = 0; j \u003C h; j++) {\\n        for (var i = 0; i \u003C w; i++) {\\n          var k = w32 * j + (i &gt;&gt; 5),\\n              m = pixels[((y + j) * (cw \u003C\u003C 5) + (x + i)) \u003C\u003C 2] ? 1 \u003C\u003C (31 - (i % 32)) : 0;\\n          sprite[k] |= m;\\n          seen |= m;\\n        }\\n        if (seen) seenRow = j;\\n        else {\\n          d.y0++;\\n          h--;\\n          j--;\\n          y++;\\n        }\\n      }\\n      d.y1 = d.y0 + seenRow;\\n      d.sprite = sprite.slice(0, (d.y1 - d.y0) * w32);\\n    }\\n  }\\n\\n  // Use mask-based collision detection.\\n  function cloudCollide(tag, board, sw) {\\n    sw &gt;&gt;= 5;\\n    var sprite = tag.sprite,\\n        w = tag.width &gt;&gt; 5,\\n        lx = tag.x - (w \u003C\u003C 4),\\n        sx = lx &amp; 0x7f,\\n        msx = 32 - sx,\\n        h = tag.y1 - tag.y0,\\n        x = (tag.y + tag.y0) * sw + (lx &gt;&gt; 5),\\n        last;\\n    for (var j = 0; j \u003C h; j++) {\\n      last = 0;\\n      for (var i = 0; i \u003C= w; i++) {\\n        if (((last \u003C\u003C msx) | (i \u003C w ? (last = sprite[j * w + i]) &gt;&gt;&gt; sx : 0))\\n            &amp; board[x + i]) return true;\\n      }\\n      x += sw;\\n    }\\n    return false;\\n  }\\n\\n  function cloudBounds(bounds, d) {\\n    var b0 = bounds[0],\\n        b1 = bounds[1];\\n    if (d.x + d.x0 \u003C b0.x) b0.x = d.x + d.x0;\\n    if (d.y + d.y0 \u003C b0.y) b0.y = d.y + d.y0;\\n    if (d.x + d.x1 &gt; b1.x) b1.x = d.x + d.x1;\\n    if (d.y + d.y1 &gt; b1.y) b1.y = d.y + d.y1;\\n  }\\n\\n  function collideRects(a, b) {\\n    return a.x + a.x1 &gt; b[0].x &amp;&amp; a.x + a.x0 \u003C b[1].x &amp;&amp; a.y + a.y1 &gt; b[0].y &amp;&amp; a.y + a.y0 \u003C b[1].y;\\n  }\\n\\n  function archimedeanSpiral(size) {\\n    var e = size[0] / size[1];\\n    return function(t) {\\n      return [e * (t *= .1) * Math.cos(t), t * Math.sin(t)];\\n    };\\n  }\\n\\n  function rectangularSpiral(size) {\\n    var dy = 4,\\n        dx = dy * size[0] / size[1],\\n        x = 0,\\n        y = 0;\\n    return function(t) {\\n      var sign = t \u003C 0 ? -1 : 1;\\n      // See triangular numbers: T_n = n * (n + 1) / 2.\\n      switch ((Math.sqrt(1 + 4 * sign * t) - sign) &amp; 3) {\\n        case 0:  x += dx; break;\\n        case 1:  y += dy; break;\\n        case 2:  x -= dx; break;\\n        default: y -= dy; break;\\n      }\\n      return [x, y];\\n    };\\n  }\\n\\n  // TODO reuse arrays?\\n  function zeroArray(n) {\\n    var a = [],\\n        i = -1;\\n    while (++i \u003C n) a[i] = 0;\\n    return a;\\n  }\\n\\n  var cloudRadians = Math.PI / 180,\\n      cw = 1 \u003C\u003C 11 &gt;&gt; 5,\\n      ch = 1 \u003C\u003C 11,\\n      canvas,\\n      ratio = 1;\\n\\n  if (typeof document !== \\\&quot;undefined\\\&quot;) {\\n    canvas = document.createElement(\\\&quot;canvas\\\&quot;);\\n    canvas.width = 1;\\n    canvas.height = 1;\\n    ratio = Math.sqrt(canvas.getContext(\\\&quot;2d\\\&quot;).getImageData(0, 0, 1, 1).data.length &gt;&gt; 2);\\n    canvas.width = (cw \u003C\u003C 5) / ratio;\\n    canvas.height = ch / ratio;\\n  } else {\\n    // node-canvas support\\n    var Canvas = require(\\\&quot;canvas\\\&quot;);\\n    canvas = new Canvas(cw \u003C\u003C 5, ch);\\n  }\\n\\n  var c = canvas.getContext(\\\&quot;2d\\\&quot;),\\n      spirals = {\\n        archimedean: archimedeanSpiral,\\n        rectangular: rectangularSpiral\\n      };\\n  c.fillStyle = c.strokeStyle = \\\&quot;red\\\&quot;;\\n  c.textAlign = \\\&quot;center\\\&quot;;\\n\\n  exports.cloud = cloud;\\n})(typeof exports === \\\&quot;undefined\\\&quot; ? d3.layout || (d3.layout = {}) : exports);\\n\&quot;,\&quot;type\&quot;:\&quot;application/javascript\&quot;,\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/d3.layout.cloud.js\&quot;,\&quot;module-type\&quot;:\&quot;library\&quot;},\&quot;$:/plugins/tiddlywiki/d3/readme\&quot;:{\&quot;title\&quot;:\&quot;$:/plugins/tiddlywiki/d3/readme\&quot;,\&quot;text\&quot;:\&quot;The D3 plugin is a proof-of-concept demo of integration with the D3.js data visualisation framework (http://d3js.org).\\n\\nIt is not currently in a state where it can be used for anything useful.\\n\\n[[Source code|https://github.com/TiddlyWiki/TiddlyWiki5/blob/master/plugins/tiddlywiki/d3]]\\n\&quot;}}}&quot;}
</pre>
</div>
<div title="D3Showcase" creator="YourName" modifier="YourName" created="202507191937" tags="innerTW5Plugin demo d3" changecount="1">
<pre>{&quot;title&quot;:&quot;TW5Sandbox&quot;,&quot;text&quot;:&quot;This is a demo of TiddlyWiki5 incorporating a plugin for the [[D3.js]] visualisation library.\n\n! Word Cloud\n\n\u003C$d3cloud data=\&quot;CloudData\&quot; spiral={{$:/spiral}}/&gt;\n\n\n//[[Raw data|CloudData]]//\n\n! Bar Chart\n\n\u003C$d3bar grouped={{$:/grouped}} data=\&quot;GraphData\&quot;/&gt;\n\u003C$button set=\&quot;$:/grouped\&quot; setTo=\&quot;yes\&quot;&gt;grouped\u003C/$button&gt; \u003C$button set=\&quot;$:/grouped\&quot; setTo=\&quot;no\&quot;&gt;stacked\u003C/$button&gt;\n\n//[[Raw data|GraphData]]//&quot;}
</pre>
</div>
<div title="DefaultTiddlers" creator="YourName" modifier="YourName" created="202507191950" changecount="1">
<pre>[[Home]]</pre>
</div>
<div title="EncryptDecryptBookmarkletPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191918" modified="202507191944" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name        |EncryptDecryptBookmarkletPlugin|
|Description |Plugin adapted from https://qiita.com/useiichi/items/0786199ee61443df3af5.|
|Source      |https://github.com/wangyenshu/EncryptDecryptBookmarkletPlugin/blob/main/EncryptDecryptBookmarkletPlugin.js|
|Version     |1.0|
|Author      |Yanshu Wang with the help of AI|
|License     |MIT|
|~CoreVersion|2.x|
|Type        |plugin|
!!!!!Documentation
Use the {{{&lt;&lt;EncryptDecryptBookmarklet&gt;&gt;}}} macro to display a button that launches the encryption/decryption tool.
The tool will open in a new pop-up window, allowing you to encrypt and decrypt text using a passphrase.
&lt;&lt;EncryptDecryptBookmarklet&gt;&gt;
!!!!!Code
***/
//{{{
config.macros.EncryptDecryptBookmarklet = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Create a button element
        var button = document.createElement(&quot;button&quot;);
        button.innerText = &quot;Encrypt/Decrypt Tool&quot;; // Text displayed on the button
        button.title = &quot;Click to open the AES encryption/decryption tool&quot;; // Tooltip

        // Add some basic styling classes for consistency with TiddlyWiki buttons
        // Assuming 'tiddlyLink' and 'button' classes exist and provide styling.
        button.className = &quot;tiddlyLink button&quot;;

        button.onclick = function() {
            var w = window.open('','Links','scrollbars,resizable,width=640,height=550');
            if (!w) { // Check if pop-up was blocked
                alert(&quot;Pop-up blocked! Please allow pop-ups for this site to use the AES tool.&quot;);
                return;
            }

            // Construct the HTML content for the new window.
            // All double quotes within the HTML string must be escaped as \&quot;
            var htmlContent = &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=\&quot;utf-8\&quot;/&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/sha1.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/cipher-core.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/aes.js\&quot;&gt;&lt;/script&gt;&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/pbkdf2.js\&quot;&gt;&lt;/script&gt;&lt;script type=\&quot;text/javascript\&quot;&gt;function encrypt(){var encypt_text=document.getElementById(\&quot;encypt-text\&quot;).value;var pass=CryptoJS.enc.Utf8.parse(document.getElementById(\&quot;encrypt-password\&quot;).value);var salt=CryptoJS.lib.WordArray.random(128/8);var key=CryptoJS.PBKDF2(pass,salt,{keySize:256/32,iterations:100});var iv=CryptoJS.lib.WordArray.random(128/8);var options={iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7};var encrypted=CryptoJS.AES.encrypt(encypt_text,key,options);document.getElementById(\&quot;transitmessage\&quot;).value=salt.toString()+iv.toString()+encrypted.toString();}function decrypt(){document.getElementById(\&quot;decrypted\&quot;).value=\&quot;\&quot;;var transitmessage=document.getElementById(\&quot;transitmessage\&quot;).value;var salt=CryptoJS.enc.Hex.parse(transitmessage.substr(0,32));var iv=CryptoJS.enc.Hex.parse(transitmessage.substr(32,32));var encrypted=transitmessage.substring(64);var pass=CryptoJS.enc.Utf8.parse(document.getElementById(\&quot;decrypt-password\&quot;).value);var key=CryptoJS.PBKDF2(pass,salt,{keySize:256/32,iterations:100});var options={iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7};var decrypted=CryptoJS.AES.decrypt(encrypted,key,options);document.getElementById(\&quot;decrypted\&quot;).value=decrypted.toString(CryptoJS.enc.Utf8);}&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;label for=\&quot;encypt-text\&quot;&gt;Text to encrypt:&lt;/label&gt;&lt;br /&gt;&lt;textarea id=\&quot;encypt-text\&quot; rows=\&quot;8\&quot; cols=\&quot;85\&quot;&gt;Hello&lt;/textarea&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;label for=\&quot;encrypt-password\&quot;&gt;Encryption Password:&lt;/label&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;input id=\&quot;encrypt-password\&quot; type=\&quot;text\&quot; size=\&quot;80\&quot; value=\&quot;password\&quot; /&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;input id=\&quot;encrypt\&quot; type=\&quot;button\&quot; value=\&quot;Encrypt\&quot; onclick=\&quot;encrypt()\&quot; /&gt;&lt;br /&gt;&lt;label for=\&quot;transitmessage\&quot;&gt;Ciphertext:&lt;/label&gt;&lt;br /&gt;&lt;textarea id=\&quot;transitmessage\&quot; rows=\&quot;4\&quot; cols=\&quot;85\&quot;&gt;&lt;/textarea&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;label for=\&quot;decrypt-password\&quot;&gt;Decryption Password:&lt;/label&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;input id=\&quot;decrypt-password\&quot; type=\&quot;text\&quot; size=\&quot;80\&quot; value=\&quot;password\&quot; /&gt;&lt;br /&gt;&amp;nbsp;↓&amp;nbsp;&lt;input id=\&quot;decrypt\&quot; type=\&quot;button\&quot; value=\&quot;Decrypt\&quot; onclick=\&quot;decrypt()\&quot; /&gt;&lt;br /&gt;&lt;label for=\&quot;decrypted\&quot;&gt;Decrypted Plaintext:&lt;/label&gt;&lt;br /&gt;&lt;textarea id=\&quot;decrypted\&quot; rows=\&quot;8\&quot; cols=\&quot;85\&quot;&gt;&lt;/textarea&gt;&lt;/body&gt;&lt;/html&gt;&quot;;

            w.document.write(htmlContent);
            w.document.close(); // Important to close the document stream after writing content
            return false; // Prevent default link action (though not a link here, good practice)
        };

        // Append the button to the place where the macro is called
        place.appendChild(button);
    }
};
//}}}</pre>
</div>
<div title="ForEachTiddlerPlugin" creator="YourName" modifier="YourName" created="202507191948" modified="202507191950" tags="systemConfig" changecount="2">
<pre>/***
|''Name:''|ForEachTiddlerPlugin|
|''Version:''|1.0.8 (2007-04-12)|
|''Source:''|http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin|
|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|
|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|
|''Copyright:''|&amp;copy; 2005-2007 [[abego Software|http://www.abego-software.de]]|
|''TiddlyWiki:''|1.2.38+, 2.0|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|
!Description

Create customizable lists, tables etc. for your selections of tiddlers. Specify the tiddlers to include and their order through a powerful language.

''Syntax:''
|&gt;|{{{&lt;&lt;}}}''forEachTiddler'' [''in'' //tiddlyWikiPath//] [''where'' //whereCondition//] [''sortBy'' //sortExpression// [''ascending'' //or// ''descending'']] [''script'' //scriptText//] [//action// [//actionParameters//]]{{{&gt;&gt;}}}|
|//tiddlyWikiPath//|The filepath to the TiddlyWiki the macro should work on. When missing the current TiddlyWiki is used.|
|//whereCondition//|(quoted) JavaScript boolean expression. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//sortExpression//|(quoted) JavaScript expression returning &quot;comparable&quot; objects (using '{{{&lt;}}}','{{{&gt;}}}','{{{==}}}'. May refer to the build-in variables {{{tiddler}}} and  {{{context}}}.|
|//scriptText//|(quoted) JavaScript text. Typically defines JavaScript functions that are called by the various JavaScript expressions (whereClause, sortClause, action arguments,...)|
|//action//|The action that should be performed on every selected tiddler, in the given order. By default the actions [[addToList|AddToListAction]] and [[write|WriteAction]] are supported. When no action is specified [[addToList|AddToListAction]]  is used.|
|//actionParameters//|(action specific) parameters the action may refer while processing the tiddlers (see action descriptions for details). &lt;&lt;tiddler [[JavaScript in actionParameters]]&gt;&gt;|
|&gt;|~~Syntax formatting: Keywords in ''bold'', optional parts in [...]. 'or' means that exactly one of the two alternatives must exist.~~|

See details see [[ForEachTiddlerMacro]] and [[ForEachTiddlerExamples]].

!Revision history
* v1.0.8 (2007-04-12)
** Adapted to latest TiddlyWiki 2.2 Beta importTiddlyWiki API (introduced with changeset 2004). TiddlyWiki 2.2 Beta builds prior to changeset 2004 are no longer supported (but TiddlyWiki 2.1 and earlier, of cause)
* v1.0.7 (2007-03-28)
** Also support &quot;pre&quot; formatted TiddlyWikis (introduced with TW 2.2) (when using &quot;in&quot; clause to work on external tiddlers)
* v1.0.6 (2006-09-16)
** Context provides &quot;viewerTiddler&quot;, i.e. the tiddler used to view the macro. Most times this is equal to the &quot;inTiddler&quot;, but when using the &quot;tiddler&quot; macro both may be different.
** Support &quot;begin&quot;, &quot;end&quot; and &quot;none&quot; expressions in &quot;write&quot; action
* v1.0.5 (2006-02-05)
** Pass tiddler containing the macro with wikify, context object also holds reference to tiddler containing the macro (&quot;inTiddler&quot;). Thanks to SimonBaird.
** Support Firefox 1.5.0.1
** Internal
*** Make &quot;JSLint&quot; conform
*** &quot;Only install once&quot;
* v1.0.4 (2006-01-06)
** Support TiddlyWiki 2.0
* v1.0.3 (2005-12-22)
** Features:
*** Write output to a file supports multi-byte environments (Thanks to Bram Chen)
*** Provide API to access the forEachTiddler functionality directly through JavaScript (see getTiddlers and performMacro)
** Enhancements:
*** Improved error messages on InternetExplorer.
* v1.0.2 (2005-12-10)
** Features:
*** context object also holds reference to store (TiddlyWiki)
** Fixed Bugs:
*** ForEachTiddler 1.0.1 has broken support on win32 Opera 8.51 (Thanks to BrunoSabin for reporting)
* v1.0.1 (2005-12-08)
** Features:
*** Access tiddlers stored in separated TiddlyWikis through the &quot;in&quot; option. I.e. you are no longer limited to only work on the &quot;current TiddlyWiki&quot;.
*** Write output to an external file using the &quot;toFile&quot; option of the &quot;write&quot; action. With this option you may write your customized tiddler exports.
*** Use the &quot;script&quot; section to define &quot;helper&quot; JavaScript functions etc. to be used in the various JavaScript expressions (whereClause, sortClause, action arguments,...).
*** Access and store context information for the current forEachTiddler invocation (through the build-in &quot;context&quot; object) .
*** Improved script evaluation (for where/sort clause and write scripts).
* v1.0.0 (2005-11-20)
** initial version

!Code
***/
//{{{


//============================================================================
//============================================================================
//		   ForEachTiddlerPlugin
//============================================================================
//============================================================================

// Only install once
if (!version.extensions.ForEachTiddlerPlugin) {

if (!window.abego) window.abego = {};

version.extensions.ForEachTiddlerPlugin = {
	major: 1, minor: 0, revision: 8,
	date: new Date(2007,3,12),
	source: &quot;http://tiddlywiki.abego-software.de/#ForEachTiddlerPlugin&quot;,
	licence: &quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,
	copyright: &quot;Copyright (c) abego Software GmbH, 2005-2007 (www.abego-software.de)&quot;
};

// For backward compatibility with TW 1.2.x
//
if (!TiddlyWiki.prototype.forEachTiddler) {
	TiddlyWiki.prototype.forEachTiddler = function(callback) {
		for(var t in this.tiddlers) {
			callback.call(this,t,this.tiddlers[t]);
		}
	};
}

//============================================================================
// forEachTiddler Macro
//============================================================================

version.extensions.forEachTiddler = {
	major: 1, minor: 0, revision: 8, date: new Date(2007,3,12), provider: &quot;http://tiddlywiki.abego-software.de&quot;};

// ---------------------------------------------------------------------------
// Configurations and constants
// ---------------------------------------------------------------------------

config.macros.forEachTiddler = {
	 // Standard Properties
	 label: &quot;forEachTiddler&quot;,
	 prompt: &quot;Perform actions on a (sorted) selection of tiddlers&quot;,

	 // actions
	 actions: {
		 addToList: {},
		 write: {}
	 }
};

// ---------------------------------------------------------------------------
//  The forEachTiddler Macro Handler
// ---------------------------------------------------------------------------

config.macros.forEachTiddler.getContainingTiddler = function(e) {
	while(e &amp;&amp; !hasClass(e,&quot;tiddler&quot;))
		e = e.parentNode;
	var title = e ? e.getAttribute(&quot;tiddler&quot;) : null;
	return title ? store.getTiddler(title) : null;
};

config.macros.forEachTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	// config.macros.forEachTiddler.traceMacroCall(place,macroName,params,wikifier,paramString,tiddler);

	if (!tiddler) tiddler = config.macros.forEachTiddler.getContainingTiddler(place);
	// --- Parsing ------------------------------------------

	var i = 0; // index running over the params
	// Parse the &quot;in&quot; clause
	var tiddlyWikiPath = undefined;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;in&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;TiddlyWiki path expected behind 'in'.&quot;);
			return;
		}
		tiddlyWikiPath = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the where clause
	var whereClause =&quot;true&quot;;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;where&quot;) {
		i++;
		whereClause = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the sort stuff
	var sortClause = null;
	var sortAscending = true;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;sortBy&quot;) {
		i++;
		if (i &gt;= params.length) {
			this.handleError(place, &quot;sortClause missing behind 'sortBy'.&quot;);
			return;
		}
		sortClause = this.paramEncode(params[i]);
		i++;

		if ((i &lt; params.length) &amp;&amp; (params[i] == &quot;ascending&quot; || params[i] == &quot;descending&quot;)) {
			 sortAscending = params[i] == &quot;ascending&quot;;
			 i++;
		}
	}

	// Parse the script
	var scriptText = null;
	if ((i &lt; params.length) &amp;&amp; params[i] == &quot;script&quot;) {
		i++;
		scriptText = this.paramEncode((i &lt; params.length) ? params[i] : &quot;&quot;);
		i++;
	}

	// Parse the action.
	// When we are already at the end use the default action
	var actionName = &quot;addToList&quot;;
	if (i &lt; params.length) {
	   if (!config.macros.forEachTiddler.actions[params[i]]) {
			this.handleError(place, &quot;Unknown action '&quot;+params[i]+&quot;'.&quot;);
			return;
		} else {
			actionName = params[i];
			i++;
		}
	}

	// Get the action parameter
	// (the parsing is done inside the individual action implementation.)
	var actionParameter = params.slice(i);


	// --- Processing ------------------------------------------
	try {
		this.performMacro({
				place: place,
				inTiddler: tiddler,
				whereClause: whereClause,
				sortClause: sortClause,
				sortAscending: sortAscending,
				actionName: actionName,
				actionParameter: actionParameter,
				scriptText: scriptText,
				tiddlyWikiPath: tiddlyWikiPath});

	} catch (e) {
		this.handleError(place, e);
	}
};

// Returns an object with properties &quot;tiddlers&quot; and &quot;context&quot;.
// tiddlers holds the (sorted) tiddlers selected by the parameter,
// context the context of the execution of the macro.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlersAndContext = function(parameter) {

	var context = config.macros.forEachTiddler.createContext(parameter.place, parameter.whereClause, parameter.sortClause, parameter.sortAscending, parameter.actionName, parameter.actionParameter, parameter.scriptText, parameter.tiddlyWikiPath, parameter.inTiddler);

	var tiddlyWiki = parameter.tiddlyWikiPath ? this.loadTiddlyWiki(parameter.tiddlyWikiPath) : store;
	context[&quot;tiddlyWiki&quot;] = tiddlyWiki;

	// Get the tiddlers, as defined by the whereClause
	var tiddlers = this.findTiddlers(parameter.whereClause, context, tiddlyWiki);
	context[&quot;tiddlers&quot;] = tiddlers;

	// Sort the tiddlers, when sorting is required.
	if (parameter.sortClause) {
		this.sortTiddlers(tiddlers, parameter.sortClause, parameter.sortAscending, context);
	}

	return {tiddlers: tiddlers, context: context};
};

// Returns the (sorted) tiddlers selected by the parameter.
//
// The action is not yet performed.
//
// @parameter see performMacro
//
config.macros.forEachTiddler.getTiddlers = function(parameter) {
	return this.getTiddlersAndContext(parameter).tiddlers;
};

// Performs the macros with the given parameter.
//
// @param parameter holds the parameter of the macro as separate properties.
//				  The following properties are supported:
//
//						place
//						whereClause
//						sortClause
//						sortAscending
//						actionName
//						actionParameter
//						scriptText
//						tiddlyWikiPath
//
//					All properties are optional.
//					For most actions the place property must be defined.
//
config.macros.forEachTiddler.performMacro = function(parameter) {
	var tiddlersAndContext = this.getTiddlersAndContext(parameter);

	// Perform the action
	var actionName = parameter.actionName ? parameter.actionName : &quot;addToList&quot;;
	var action = config.macros.forEachTiddler.actions[actionName];
	if (!action) {
		this.handleError(parameter.place, &quot;Unknown action '&quot;+actionName+&quot;'.&quot;);
		return;
	}

	var actionHandler = action.handler;
	actionHandler(parameter.place, tiddlersAndContext.tiddlers, parameter.actionParameter, tiddlersAndContext.context);
};

// ---------------------------------------------------------------------------
//  The actions
// ---------------------------------------------------------------------------

// Internal.
//
// --- The addToList Action -----------------------------------------------
//
config.macros.forEachTiddler.actions.addToList.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;addToList&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var list = document.createElement(&quot;ul&quot;);
	place.appendChild(list);
	for (var i = 0; i &lt; tiddlers.length; i++) {
		var tiddler = tiddlers[i];
		var listItem = document.createElement(&quot;li&quot;);
		list.appendChild(listItem);
		createTiddlyLink(listItem, tiddler.title, true);
	}
};

abego.parseNamedParameter = function(name, parameter, i) {
	var beginExpression = null;
	if ((i &lt; parameter.length) &amp;&amp; parameter[i] == name) {
		i++;
		if (i &gt;= parameter.length) {
			throw &quot;Missing text behind '%0'&quot;.format([name]);
		}

		return config.macros.forEachTiddler.paramEncode(parameter[i]);
	}
	return null;
}

// Internal.
//
// --- The write Action ---------------------------------------------------
//
config.macros.forEachTiddler.actions.write.handler = function(place, tiddlers, parameter, context) {
	// Parse the parameter
	var p = 0;
	if (p &gt;= parameter.length) {
		this.handleError(place, &quot;Missing expression behind 'write'.&quot;);
		return;
	}

	var textExpression = config.macros.forEachTiddler.paramEncode(parameter[p]);
	p++;

	// Parse the &quot;begin&quot; option
	var beginExpression = abego.parseNamedParameter(&quot;begin&quot;, parameter, p);
	if (beginExpression !== null)
		p += 2;
	var endExpression = abego.parseNamedParameter(&quot;end&quot;, parameter, p);
	if (endExpression !== null)
		p += 2;
	var noneExpression = abego.parseNamedParameter(&quot;none&quot;, parameter, p);
	if (noneExpression !== null)
		p += 2;

	// Parse the &quot;toFile&quot; option
	var filename = null;
	var lineSeparator = undefined;
	if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;toFile&quot;) {
		p++;
		if (p &gt;= parameter.length) {
			this.handleError(place, &quot;Filename expected behind 'toFile' of 'write' action.&quot;);
			return;
		}

		filename = config.macros.forEachTiddler.getLocalPath(config.macros.forEachTiddler.paramEncode(parameter[p]));
		p++;
		if ((p &lt; parameter.length) &amp;&amp; parameter[p] == &quot;withLineSeparator&quot;) {
			p++;
			if (p &gt;= parameter.length) {
				this.handleError(place, &quot;Line separator text expected behind 'withLineSeparator' of 'write' action.&quot;);
				return;
			}
			lineSeparator = config.macros.forEachTiddler.paramEncode(parameter[p]);
			p++;
		}
	}

	// Check for extra parameters
	if (parameter.length &gt; p) {
		config.macros.forEachTiddler.createExtraParameterErrorElement(place, &quot;write&quot;, parameter, p);
		return;
	}

	// Perform the action.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(textExpression, context);
	var count = tiddlers.length;
	var text = &quot;&quot;;
	if (count &gt; 0 &amp;&amp; beginExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(beginExpression, context)(undefined, context, count, undefined);

	for (var i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		text += func(tiddler, context, count, i);
	}

	if (count &gt; 0 &amp;&amp; endExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(endExpression, context)(undefined, context, count, undefined);

	if (count == 0 &amp;&amp; noneExpression)
		text += config.macros.forEachTiddler.getEvalTiddlerFunction(noneExpression, context)(undefined, context, count, undefined);


	if (filename) {
		if (lineSeparator !== undefined) {
			lineSeparator = lineSeparator.replace(/\\n/mg, &quot;\n&quot;).replace(/\\r/mg, &quot;\r&quot;);
			text = text.replace(/\n/mg,lineSeparator);
		}
		saveFile(filename, convertUnicodeToUTF8(text));
	} else {
		var wrapper = createTiddlyElement(place, &quot;span&quot;);
		wikify(text, wrapper, null/* highlightRegExp */, context.inTiddler);
	}
};


// ---------------------------------------------------------------------------
//  Helpers
// ---------------------------------------------------------------------------

// Internal.
//
config.macros.forEachTiddler.createContext = function(placeParam, whereClauseParam, sortClauseParam, sortAscendingParam, actionNameParam, actionParameterParam, scriptText, tiddlyWikiPathParam, inTiddlerParam) {
	return {
		place : placeParam,
		whereClause : whereClauseParam,
		sortClause : sortClauseParam,
		sortAscending : sortAscendingParam,
		script : scriptText,
		actionName : actionNameParam,
		actionParameter : actionParameterParam,
		tiddlyWikiPath : tiddlyWikiPathParam,
		inTiddler : inTiddlerParam, // the tiddler containing the &lt;&lt;forEachTiddler ...&gt;&gt; macro call.
		viewerTiddler : config.macros.forEachTiddler.getContainingTiddler(placeParam) // the tiddler showing the forEachTiddler result
	};
};

// Internal.
//
// Returns a TiddlyWiki with the tiddlers loaded from the TiddlyWiki of
// the given path.
//
config.macros.forEachTiddler.loadTiddlyWiki = function(path, idPrefix) {
	if (!idPrefix) {
		idPrefix = &quot;store&quot;;
	}
	var lenPrefix = idPrefix.length;

	// Read the content of the given file
	var content = loadFile(this.getLocalPath(path));
	if(content === null) {
		throw &quot;TiddlyWiki '&quot;+path+&quot;' not found.&quot;;
	}

	var tiddlyWiki = new TiddlyWiki();

	// Starting with TW 2.2 there is a helper function to import the tiddlers
	if (tiddlyWiki.importTiddlyWiki) {
		if (!tiddlyWiki.importTiddlyWiki(content))
			throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
		tiddlyWiki.dirty = false;
		return tiddlyWiki;
	}

	// The legacy code, for TW &lt; 2.2

	// Locate the storeArea div's
	var posOpeningDiv = content.indexOf(startSaveArea);
	var posClosingDiv = content.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1)) {
		throw &quot;File '&quot;+path+&quot;' is not a TiddlyWiki.&quot;;
	}
	var storageText = content.substr(posOpeningDiv + startSaveArea.length, posClosingDiv);

	// Create a &quot;div&quot; element that contains the storage text
	var myStorageDiv = document.createElement(&quot;div&quot;);
	myStorageDiv.innerHTML = storageText;
	myStorageDiv.normalize();

	// Create all tiddlers in a new TiddlyWiki
	// (following code is modified copy of TiddlyWiki.prototype.loadFromDiv)
	var store = myStorageDiv.childNodes;
	for(var t = 0; t &lt; store.length; t++) {
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute(&quot;tiddler&quot;);
		if(!title &amp;&amp; e.id &amp;&amp; e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title &amp;&amp; title !== &quot;&quot;) {
			var tiddler = tiddlyWiki.createTiddler(title);
			tiddler.loadFromDiv(e,title);
		}
	}
	tiddlyWiki.dirty = false;

	return tiddlyWiki;
};



// Internal.
//
// Returns a function that has a function body returning the given javaScriptExpression.
// The function has the parameters:
//
//	 (tiddler, context, count, index)
//
config.macros.forEachTiddler.getEvalTiddlerFunction = function (javaScriptExpression, context) {
	var script = context[&quot;script&quot;];
	var functionText = &quot;var theFunction = function(tiddler, context, count, index) { return &quot;+javaScriptExpression+&quot;}&quot;;
	var fullText = (script ? script+&quot;;&quot; : &quot;&quot;)+functionText+&quot;;theFunction;&quot;;
	return eval(fullText);
};

// Internal.
//
config.macros.forEachTiddler.findTiddlers = function(whereClause, context, tiddlyWiki) {
	var result = [];
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(whereClause, context);
	tiddlyWiki.forEachTiddler(function(title,tiddler) {
		if (func(tiddler, context, undefined, undefined)) {
			result.push(tiddler);
		}
	});
	return result;
};

// Internal.
//
config.macros.forEachTiddler.createExtraParameterErrorElement = function(place, actionName, parameter, firstUnusedIndex) {
	var message = &quot;Extra parameter behind '&quot;+actionName+&quot;':&quot;;
	for (var i = firstUnusedIndex; i &lt; parameter.length; i++) {
		message += &quot; &quot;+parameter[i];
	}
	this.handleError(place, message);
};

// Internal.
//
config.macros.forEachTiddler.sortAscending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? -1
			   : +1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortDescending = function(tiddlerA, tiddlerB) {
	var result =
		(tiddlerA.forEachTiddlerSortValue == tiddlerB.forEachTiddlerSortValue)
			? 0
			: (tiddlerA.forEachTiddlerSortValue &lt; tiddlerB.forEachTiddlerSortValue)
			   ? +1
			   : -1;
	return result;
};

// Internal.
//
config.macros.forEachTiddler.sortTiddlers = function(tiddlers, sortClause, ascending, context) {
	// To avoid evaluating the sortClause whenever two items are compared
	// we pre-calculate the sortValue for every item in the array and store it in a
	// temporary property (&quot;forEachTiddlerSortValue&quot;) of the tiddlers.
	var func = config.macros.forEachTiddler.getEvalTiddlerFunction(sortClause, context);
	var count = tiddlers.length;
	var i;
	for (i = 0; i &lt; count; i++) {
		var tiddler = tiddlers[i];
		tiddler.forEachTiddlerSortValue = func(tiddler,context, undefined, undefined);
	}

	// Do the sorting
	tiddlers.sort(ascending ? this.sortAscending : this.sortDescending);

	// Delete the temporary property that holds the sortValue.
	for (i = 0; i &lt; tiddlers.length; i++) {
		delete tiddlers[i].forEachTiddlerSortValue;
	}
};


// Internal.
//
config.macros.forEachTiddler.trace = function(message) {
	displayMessage(message);
};

// Internal.
//
config.macros.forEachTiddler.traceMacroCall = function(place,macroName,params) {
	var message =&quot;&lt;&lt;&quot;+macroName;
	for (var i = 0; i &lt; params.length; i++) {
		message += &quot; &quot;+params[i];
	}
	message += &quot;&gt;&gt;&quot;;
	displayMessage(message);
};


// Internal.
//
// Creates an element that holds an error message
//
config.macros.forEachTiddler.createErrorElement = function(place, exception) {
	var message = (exception.description) ? exception.description : exception.toString();
	return createTiddlyElement(place,&quot;span&quot;,null,&quot;forEachTiddlerError&quot;,&quot;&lt;&lt;forEachTiddler ...&gt;&gt;: &quot;+message);
};

// Internal.
//
// @param place [may be null]
//
config.macros.forEachTiddler.handleError = function(place, exception) {
	if (place) {
		this.createErrorElement(place, exception);
	} else {
		throw exception;
	}
};

// Internal.
//
// Encodes the given string.
//
// Replaces
//	 &quot;$))&quot; to &quot;&gt;&gt;&quot;
//	 &quot;$)&quot; to &quot;&gt;&quot;
//
config.macros.forEachTiddler.paramEncode = function(s) {
	var reGTGT = new RegExp(&quot;\\$\\)\\)&quot;,&quot;mg&quot;);
	var reGT = new RegExp(&quot;\\$\\)&quot;,&quot;mg&quot;);
	return s.replace(reGTGT, &quot;&gt;&gt;&quot;).replace(reGT, &quot;&gt;&quot;);
};

// Internal.
//
// Returns the given original path (that is a file path, starting with &quot;file:&quot;)
// as a path to a local file, in the systems native file format.
//
// Location information in the originalPath (i.e. the &quot;#&quot; and stuff following)
// is stripped.
//
config.macros.forEachTiddler.getLocalPath = function(originalPath) {
	// Remove any location part of the URL
	var hashPos = originalPath.indexOf(&quot;#&quot;);
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert to a native file format assuming
	// &quot;file:///x:/path/path/path...&quot; - pc local file --&gt; &quot;x:\path\path\path...&quot;
	// &quot;file://///server/share/path/path/path...&quot; - FireFox pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	// &quot;file:///path/path/path...&quot; - mac/unix local file --&gt; &quot;/path/path/path...&quot;
	// &quot;file://server/share/path/path/path...&quot; - pc network file --&gt; &quot;\\server\share\path\path\path...&quot;
	var localPath;
	if(originalPath.charAt(9) == &quot;:&quot;) // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file://///&quot;) === 0) // FireFox pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(10)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	else if(originalPath.indexOf(&quot;file:///&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf(&quot;file:/&quot;) === 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = &quot;\\\\&quot; + unescape(originalPath.substr(7)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\\&quot;);
	return localPath;
};

// ---------------------------------------------------------------------------
// Stylesheet Extensions (may be overridden by local StyleSheet)
// ---------------------------------------------------------------------------
//
setStylesheet(
	&quot;.forEachTiddlerError{color: #ffffff;background-color: #880000;}&quot;,
	&quot;forEachTiddler&quot;);

//============================================================================
// End of forEachTiddler Macro
//============================================================================


//============================================================================
// String.startsWith Function
//============================================================================
//
// Returns true if the string starts with the given prefix, false otherwise.
//
version.extensions[&quot;String.startsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.startsWith = function(prefix) {
	var n =  prefix.length;
	return (this.length &gt;= n) &amp;&amp; (this.slice(0, n) == prefix);
};



//============================================================================
// String.endsWith Function
//============================================================================
//
// Returns true if the string ends with the given suffix, false otherwise.
//
version.extensions[&quot;String.endsWith&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.endsWith = function(suffix) {
	var n = suffix.length;
	return (this.length &gt;= n) &amp;&amp; (this.right(n) == suffix);
};


//============================================================================
// String.contains Function
//============================================================================
//
// Returns true when the string contains the given substring, false otherwise.
//
version.extensions[&quot;String.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
String.prototype.contains = function(substring) {
	return this.indexOf(substring) &gt;= 0;
};

//============================================================================
// Array.indexOf Function
//============================================================================
//
// Returns the index of the first occurance of the given item in the array or
// -1 when no such item exists.
//
// @param item [may be null]
//
version.extensions[&quot;Array.indexOf&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.indexOf = function(item) {
	for (var i = 0; i &lt; this.length; i++) {
		if (this[i] == item) {
			return i;
		}
	}
	return -1;
};

//============================================================================
// Array.contains Function
//============================================================================
//
// Returns true when the array contains the given item, otherwise false.
//
// @param item [may be null]
//
version.extensions[&quot;Array.contains&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.contains = function(item) {
	return (this.indexOf(item) &gt;= 0);
};

//============================================================================
// Array.containsAny Function
//============================================================================
//
// Returns true when the array contains at least one of the elements
// of the item. Otherwise (or when items contains no elements) false is returned.
//
version.extensions[&quot;Array.containsAny&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAny = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (this.contains(items[i])) {
			return true;
		}
	}
	return false;
};


//============================================================================
// Array.containsAll Function
//============================================================================
//
// Returns true when the array contains all the items, otherwise false.
//
// When items is null false is returned (even if the array contains a null).
//
// @param items [may be null]
//
version.extensions[&quot;Array.containsAll&quot;] = {major: 1, minor: 0, revision: 0, date: new Date(2005,11,20), provider: &quot;http://tiddlywiki.abego-software.de&quot;};
//
Array.prototype.containsAll = function(items) {
	for(var i = 0; i &lt; items.length; i++) {
		if (!this.contains(items[i])) {
			return false;
		}
	}
	return true;
};


} // of &quot;install only once&quot;

// Used Globals (for JSLint) ==============
// ... DOM
/*global 	document */
// ... TiddlyWiki Core
/*global 	convertUnicodeToUTF8, createTiddlyElement, createTiddlyLink,
			displayMessage, endSaveArea, hasClass, loadFile, saveFile,
			startSaveArea, store, wikify */
//}}}


/***
!Licence and Copyright
Copyright (c) abego Software ~GmbH, 2005 ([[www.abego-software.de|http://www.abego-software.de]])

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of abego Software nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
***/

</pre>
</div>
<div title="GraphData" creator="YourName" modifier="YourName" created="202507191937" tags="innerTW5Plugin demo d3" changecount="1">
<pre>{&quot;title&quot;:&quot;GraphData&quot;,&quot;type&quot;:&quot;application/json&quot;,&quot;text&quot;:&quot;{\n\t\&quot;layers\&quot;: 4,\n\t\&quot;samples\&quot;: 58,\n\t\&quot;data\&quot;: [[{\&quot;x\&quot;:0,\&quot;y\&quot;:1.5465653425978438,\&quot;y0\&quot;:0},{\&quot;x\&quot;:1,\&quot;y\&quot;:1.685317173883538,\&quot;y0\&quot;:0},{\&quot;x\&quot;:2,\&quot;y\&quot;:1.8574362488718479,\&quot;y0\&quot;:0},{\&quot;x\&quot;:3,\&quot;y\&quot;:1.8955971722736493,\&quot;y0\&quot;:0},{\&quot;x\&quot;:4,\&quot;y\&quot;:1.9097577836599329,\&quot;y0\&quot;:0},{\&quot;x\&quot;:5,\&quot;y\&quot;:1.8465434425997016,\&quot;y0\&quot;:0},{\&quot;x\&quot;:6,\&quot;y\&quot;:1.633439930626274,\&quot;y0\&quot;:0},{\&quot;x\&quot;:7,\&quot;y\&quot;:1.52631967808687,\&quot;y0\&quot;:0},{\&quot;x\&quot;:8,\&quot;y\&quot;:1.254071127423236,\&quot;y0\&quot;:0},{\&quot;x\&quot;:9,\&quot;y\&quot;:1.0827254551382322,\&quot;y0\&quot;:0},{\&quot;x\&quot;:10,\&quot;y\&quot;:0.8638985445997883,\&quot;y0\&quot;:0},{\&quot;x\&quot;:11,\&quot;y\&quot;:0.6413689486056139,\&quot;y0\&quot;:0},{\&quot;x\&quot;:12,\&quot;y\&quot;:0.5413942661821705,\&quot;y0\&quot;:0},{\&quot;x\&quot;:13,\&quot;y\&quot;:0.36278061239443893,\&quot;y0\&quot;:0},{\&quot;x\&quot;:14,\&quot;y\&quot;:0.3256964071352306,\&quot;y0\&quot;:0},{\&quot;x\&quot;:15,\&quot;y\&quot;:0.2137255237212198,\&quot;y0\&quot;:0},{\&quot;x\&quot;:16,\&quot;y\&quot;:0.19963582829410498,\&quot;y0\&quot;:0},{\&quot;x\&quot;:17,\&quot;y\&quot;:0.16830706117875752,\&quot;y0\&quot;:0},{\&quot;x\&quot;:18,\&quot;y\&quot;:0.17206850583228236,\&quot;y0\&quot;:0},{\&quot;x\&quot;:19,\&quot;y\&quot;:0.10830681834972318,\&quot;y0\&quot;:0},{\&quot;x\&quot;:20,\&quot;y\&quot;:0.11873772657810025,\&quot;y0\&quot;:0},{\&quot;x\&quot;:21,\&quot;y\&quot;:0.11084964578647072,\&quot;y0\&quot;:0},{\&quot;x\&quot;:22,\&quot;y\&quot;:0.1484696893575204,\&quot;y0\&quot;:0},{\&quot;x\&quot;:23,\&quot;y\&quot;:0.1867012666922508,\&quot;y0\&quot;:0},{\&quot;x\&quot;:24,\&quot;y\&quot;:0.12949785228379762,\&quot;y0\&quot;:0},{\&quot;x\&quot;:25,\&quot;y\&quot;:0.13160216135876143,\&quot;y0\&quot;:0},{\&quot;x\&quot;:26,\&quot;y\&quot;:0.17191603579071696,\&quot;y0\&quot;:0},{\&quot;x\&quot;:27,\&quot;y\&quot;:0.13015751294359376,\&quot;y0\&quot;:0},{\&quot;x\&quot;:28,\&quot;y\&quot;:0.14401777421011913,\&quot;y0\&quot;:0},{\&quot;x\&quot;:29,\&quot;y\&quot;:0.10201715281901944,\&quot;y0\&quot;:0},{\&quot;x\&quot;:30,\&quot;y\&quot;:0.13096141940224687,\&quot;y0\&quot;:0},{\&quot;x\&quot;:31,\&quot;y\&quot;:0.13007539913630495,\&quot;y0\&quot;:0},{\&quot;x\&quot;:32,\&quot;y\&quot;:0.1548329677287279,\&quot;y0\&quot;:0},{\&quot;x\&quot;:33,\&quot;y\&quot;:0.12825426147451768,\&quot;y0\&quot;:0},{\&quot;x\&quot;:34,\&quot;y\&quot;:0.11173963750950311,\&quot;y0\&quot;:0},{\&quot;x\&quot;:35,\&quot;y\&quot;:0.10009802752875707,\&quot;y0\&quot;:0},{\&quot;x\&quot;:36,\&quot;y\&quot;:0.15986871614703402,\&quot;y0\&quot;:0},{\&quot;x\&quot;:37,\&quot;y\&quot;:0.13176775383781347,\&quot;y0\&quot;:0},{\&quot;x\&quot;:38,\&quot;y\&quot;:0.11931081113873895,\&quot;y0\&quot;:0},{\&quot;x\&quot;:39,\&quot;y\&quot;:0.16285687568597873,\&quot;y0\&quot;:0},{\&quot;x\&quot;:40,\&quot;y\&quot;:0.17962864991277508,\&quot;y0\&quot;:0},{\&quot;x\&quot;:41,\&quot;y\&quot;:0.12206525453366346,\&quot;y0\&quot;:0},{\&quot;x\&quot;:42,\&quot;y\&quot;:0.18058574651367965,\&quot;y0\&quot;:0},{\&quot;x\&quot;:43,\&quot;y\&quot;:0.17203539919573813,\&quot;y0\&quot;:0},{\&quot;x\&quot;:44,\&quot;y\&quot;:0.14411348106805236,\&quot;y0\&quot;:0},{\&quot;x\&quot;:45,\&quot;y\&quot;:0.11210963563062251,\&quot;y0\&quot;:0},{\&quot;x\&quot;:46,\&quot;y\&quot;:0.1381196621572599,\&quot;y0\&quot;:0},{\&quot;x\&quot;:47,\&quot;y\&quot;:0.13853569640778007,\&quot;y0\&quot;:0},{\&quot;x\&quot;:48,\&quot;y\&quot;:0.1413255832623691,\&quot;y0\&quot;:0},{\&quot;x\&quot;:49,\&quot;y\&quot;:0.1174182482529442,\&quot;y0\&quot;:0},{\&quot;x\&quot;:50,\&quot;y\&quot;:0.10530492262916305,\&quot;y0\&quot;:0},{\&quot;x\&quot;:51,\&quot;y\&quot;:0.10311489694306446,\&quot;y0\&quot;:0},{\&quot;x\&quot;:52,\&quot;y\&quot;:0.11639756702594588,\&quot;y0\&quot;:0},{\&quot;x\&quot;:53,\&quot;y\&quot;:0.1319517292574534,\&quot;y0\&quot;:0},{\&quot;x\&quot;:54,\&quot;y\&quot;:0.11580932540132466,\&quot;y0\&quot;:0},{\&quot;x\&quot;:55,\&quot;y\&quot;:0.14951149305133773,\&quot;y0\&quot;:0},{\&quot;x\&quot;:56,\&quot;y\&quot;:0.13733844893200403,\&quot;y0\&quot;:0},{\&quot;x\&quot;:57,\&quot;y\&quot;:0.15683227159202287,\&quot;y0\&quot;:0}],[{\&quot;x\&quot;:0,\&quot;y\&quot;:0.4205513236112361,\&quot;y0\&quot;:1.5465653425978438},{\&quot;x\&quot;:1,\&quot;y\&quot;:0.5468517829897288,\&quot;y0\&quot;:1.685317173883538},{\&quot;x\&quot;:2,\&quot;y\&quot;:0.968925897059711,\&quot;y0\&quot;:1.8574362488718479},{\&quot;x\&quot;:3,\&quot;y\&quot;:1.4906540525791687,\&quot;y0\&quot;:1.8955971722736493},{\&quot;x\&quot;:4,\&quot;y\&quot;:2.0955950901132407,\&quot;y0\&quot;:1.9097577836599329},{\&quot;x\&quot;:5,\&quot;y\&quot;:2.4548437717415097,\&quot;y0\&quot;:1.8465434425997016},{\&quot;x\&quot;:6,\&quot;y\&quot;:2.3871398992501094,\&quot;y0\&quot;:1.633439930626274},{\&quot;x\&quot;:7,\&quot;y\&quot;:1.8956592631335767,\&quot;y0\&quot;:1.52631967808687},{\&quot;x\&quot;:8,\&quot;y\&quot;:1.3310277640299937,\&quot;y0\&quot;:1.254071127423236},{\&quot;x\&quot;:9,\&quot;y\&quot;:0.740004500538676,\&quot;y0\&quot;:1.0827254551382322},{\&quot;x\&quot;:10,\&quot;y\&quot;:0.41341056933113224,\&quot;y0\&quot;:0.8638985445997883},{\&quot;x\&quot;:11,\&quot;y\&quot;:0.25508869446689425,\&quot;y0\&quot;:0.6413689486056139},{\&quot;x\&quot;:12,\&quot;y\&quot;:0.21465672884279616,\&quot;y0\&quot;:0.5413942661821705},{\&quot;x\&quot;:13,\&quot;y\&quot;:0.2030322655655626,\&quot;y0\&quot;:0.36278061239443893},{\&quot;x\&quot;:14,\&quot;y\&quot;:0.17778946560320333,\&quot;y0\&quot;:0.3256964071352306},{\&quot;x\&quot;:15,\&quot;y\&quot;:0.13993989381581068,\&quot;y0\&quot;:0.2137255237212198},{\&quot;x\&quot;:16,\&quot;y\&quot;:0.1509842264651427,\&quot;y0\&quot;:0.19963582829410498},{\&quot;x\&quot;:17,\&quot;y\&quot;:0.14400590082193815,\&quot;y0\&quot;:0.16830706117875752},{\&quot;x\&quot;:18,\&quot;y\&quot;:0.30062332723788887,\&quot;y0\&quot;:0.17206850583228236},{\&quot;x\&quot;:19,\&quot;y\&quot;:0.47865475204719965,\&quot;y0\&quot;:0.10830681834972318},{\&quot;x\&quot;:20,\&quot;y\&quot;:0.911871360864478,\&quot;y0\&quot;:0.11873772657810025},{\&quot;x\&quot;:21,\&quot;y\&quot;:1.5099221362867215,\&quot;y0\&quot;:0.11084964578647072},{\&quot;x\&quot;:22,\&quot;y\&quot;:1.9414749203225334,\&quot;y0\&quot;:0.1484696893575204},{\&quot;x\&quot;:23,\&quot;y\&quot;:1.9571455162890212,\&quot;y0\&quot;:0.1867012666922508},{\&quot;x\&quot;:24,\&quot;y\&quot;:1.4064503011974243,\&quot;y0\&quot;:0.12949785228379762},{\&quot;x\&quot;:25,\&quot;y\&quot;:0.8310477425188015,\&quot;y0\&quot;:0.13160216135876143},{\&quot;x\&quot;:26,\&quot;y\&quot;:0.4000029514079704,\&quot;y0\&quot;:0.17191603579071696},{\&quot;x\&quot;:27,\&quot;y\&quot;:0.27666872064180015,\&quot;y0\&quot;:0.13015751294359376},{\&quot;x\&quot;:28,\&quot;y\&quot;:0.1732079458981994,\&quot;y0\&quot;:0.14401777421011913},{\&quot;x\&quot;:29,\&quot;y\&quot;:0.16434562900185226,\&quot;y0\&quot;:0.10201715281901944},{\&quot;x\&quot;:30,\&quot;y\&quot;:0.10902278389939715,\&quot;y0\&quot;:0.13096141940224687},{\&quot;x\&quot;:31,\&quot;y\&quot;:0.12130552647880047,\&quot;y0\&quot;:0.13007539913630495},{\&quot;x\&quot;:32,\&quot;y\&quot;:0.13189499389209813,\&quot;y0\&quot;:0.1548329677287279},{\&quot;x\&quot;:33,\&quot;y\&quot;:0.16701788078384439,\&quot;y0\&quot;:0.12825426147451768},{\&quot;x\&quot;:34,\&quot;y\&quot;:0.19748827143641204,\&quot;y0\&quot;:0.11173963750950311},{\&quot;x\&quot;:35,\&quot;y\&quot;:0.10048470402153871,\&quot;y0\&quot;:0.10009802752875707},{\&quot;x\&quot;:36,\&quot;y\&quot;:0.1589328406733382,\&quot;y0\&quot;:0.15986871614703402},{\&quot;x\&quot;:37,\&quot;y\&quot;:0.1260306214335577,\&quot;y0\&quot;:0.13176775383781347},{\&quot;x\&quot;:38,\&quot;y\&quot;:0.12310005807202623,\&quot;y0\&quot;:0.11931081113873895},{\&quot;x\&quot;:39,\&quot;y\&quot;:0.19081063238544746,\&quot;y0\&quot;:0.16285687568597873},{\&quot;x\&quot;:40,\&quot;y\&quot;:0.11915995362201988,\&quot;y0\&quot;:0.17962864991277508},{\&quot;x\&quot;:41,\&quot;y\&quot;:0.16775608610181492,\&quot;y0\&quot;:0.12206525453366346},{\&quot;x\&quot;:42,\&quot;y\&quot;:0.11689659197281145,\&quot;y0\&quot;:0.18058574651367965},{\&quot;x\&quot;:43,\&quot;y\&quot;:0.10478702228876778,\&quot;y0\&quot;:0.17203539919573813},{\&quot;x\&quot;:44,\&quot;y\&quot;:0.11845520244093624,\&quot;y0\&quot;:0.14411348106805236},{\&quot;x\&quot;:45,\&quot;y\&quot;:0.12148839301915355,\&quot;y0\&quot;:0.11210963563062251},{\&quot;x\&quot;:46,\&quot;y\&quot;:0.10516531708389541,\&quot;y0\&quot;:0.1381196621572599},{\&quot;x\&quot;:47,\&quot;y\&quot;:0.1443174046222646,\&quot;y0\&quot;:0.13853569640778007},{\&quot;x\&quot;:48,\&quot;y\&quot;:0.21339332873273398,\&quot;y0\&quot;:0.1413255832623691},{\&quot;x\&quot;:49,\&quot;y\&quot;:0.2712006000742741,\&quot;y0\&quot;:0.1174182482529442},{\&quot;x\&quot;:50,\&quot;y\&quot;:0.5050451567911616,\&quot;y0\&quot;:0.10530492262916305},{\&quot;x\&quot;:51,\&quot;y\&quot;:0.909821514076055,\&quot;y0\&quot;:0.10311489694306446},{\&quot;x\&quot;:52,\&quot;y\&quot;:1.5406349016176095,\&quot;y0\&quot;:0.11639756702594588},{\&quot;x\&quot;:53,\&quot;y\&quot;:1.9406928968291974,\&quot;y0\&quot;:0.1319517292574534},{\&quot;x\&quot;:54,\&quot;y\&quot;:2.1437324147686923,\&quot;y0\&quot;:0.11580932540132466},{\&quot;x\&quot;:55,\&quot;y\&quot;:1.8465368739328496,\&quot;y0\&quot;:0.14951149305133773},{\&quot;x\&quot;:56,\&quot;y\&quot;:1.4092532224974688,\&quot;y0\&quot;:0.13733844893200403},{\&quot;x\&quot;:57,\&quot;y\&quot;:0.8817856427333232,\&quot;y0\&quot;:0.15683227159202287}],[{\&quot;x\&quot;:0,\&quot;y\&quot;:0.1944409988255144,\&quot;y0\&quot;:1.96711666620908},{\&quot;x\&quot;:1,\&quot;y\&quot;:0.15033225801417882,\&quot;y0\&quot;:2.2321689568732666},{\&quot;x\&quot;:2,\&quot;y\&quot;:0.14925294980475312,\&quot;y0\&quot;:2.826362145931559},{\&quot;x\&quot;:3,\&quot;y\&quot;:0.13370916755531753,\&quot;y0\&quot;:3.386251224852818},{\&quot;x\&quot;:4,\&quot;y\&quot;:0.19872840374154924,\&quot;y0\&quot;:4.005352873773173},{\&quot;x\&quot;:5,\&quot;y\&quot;:0.13950762000676847,\&quot;y0\&quot;:4.3013872143412115},{\&quot;x\&quot;:6,\&quot;y\&quot;:0.16267251262861193,\&quot;y0\&quot;:4.020579829876383},{\&quot;x\&quot;:7,\&quot;y\&quot;:0.1577907670976032,\&quot;y0\&quot;:3.4219789412204467},{\&quot;x\&quot;:8,\&quot;y\&quot;:0.21860201765439113,\&quot;y0\&quot;:2.58509889145323},{\&quot;x\&quot;:9,\&quot;y\&quot;:0.18971610615072376,\&quot;y0\&quot;:1.822729955676908},{\&quot;x\&quot;:10,\&quot;y\&quot;:0.3651241384995914,\&quot;y0\&quot;:1.2773091139309205},{\&quot;x\&quot;:11,\&quot;y\&quot;:0.40364878074449406,\&quot;y0\&quot;:0.8964576430725082},{\&quot;x\&quot;:12,\&quot;y\&quot;:0.641325222983355,\&quot;y0\&quot;:0.7560509950249666},{\&quot;x\&quot;:13,\&quot;y\&quot;:0.7970356614298015,\&quot;y0\&quot;:0.5658128779600016},{\&quot;x\&quot;:14,\&quot;y\&quot;:1.035079540774146,\&quot;y0\&quot;:0.5034858727384339},{\&quot;x\&quot;:15,\&quot;y\&quot;:1.2114900571612826,\&quot;y0\&quot;:0.3536654175370305},{\&quot;x\&quot;:16,\&quot;y\&quot;:1.2955027464964213,\&quot;y0\&quot;:0.3506200547592477},{\&quot;x\&quot;:17,\&quot;y\&quot;:1.2704279232237192,\&quot;y0\&quot;:0.3123129620006957},{\&quot;x\&quot;:18,\&quot;y\&quot;:1.1110482804839328,\&quot;y0\&quot;:0.47269183307017126},{\&quot;x\&quot;:19,\&quot;y\&quot;:0.95265250419215,\&quot;y0\&quot;:0.5869615703969229},{\&quot;x\&quot;:20,\&quot;y\&quot;:0.7625642407866274,\&quot;y0\&quot;:1.0306090874425782},{\&quot;x\&quot;:21,\&quot;y\&quot;:0.48432505597654985,\&quot;y0\&quot;:1.6207717820731922},{\&quot;x\&quot;:22,\&quot;y\&quot;:0.3605975129100767,\&quot;y0\&quot;:2.089944609680054},{\&quot;x\&quot;:23,\&quot;y\&quot;:0.25079581943021645,\&quot;y0\&quot;:2.143846782981272},{\&quot;x\&quot;:24,\&quot;y\&quot;:0.17992789872009896,\&quot;y0\&quot;:1.5359481534812218},{\&quot;x\&quot;:25,\&quot;y\&quot;:0.15831991003627732,\&quot;y0\&quot;:0.962649903877563},{\&quot;x\&quot;:26,\&quot;y\&quot;:0.209545591944138,\&quot;y0\&quot;:0.5719189871986874},{\&quot;x\&quot;:27,\&quot;y\&quot;:0.1815386065993288,\&quot;y0\&quot;:0.40682623358539394},{\&quot;x\&quot;:28,\&quot;y\&quot;:0.22451288616655046,\&quot;y0\&quot;:0.3172257201083185},{\&quot;x\&quot;:29,\&quot;y\&quot;:0.18631048531302957,\&quot;y0\&quot;:0.2663627818208717},{\&quot;x\&quot;:30,\&quot;y\&quot;:0.2693049686300363,\&quot;y0\&quot;:0.23998420330164402},{\&quot;x\&quot;:31,\&quot;y\&quot;:0.4390040968595268,\&quot;y0\&quot;:0.2513809256151054},{\&quot;x\&quot;:32,\&quot;y\&quot;:0.5561378323665368,\&quot;y0\&quot;:0.28672796162082603},{\&quot;x\&quot;:33,\&quot;y\&quot;:0.9278805101372621,\&quot;y0\&quot;:0.29527214225836207},{\&quot;x\&quot;:34,\&quot;y\&quot;:1.3353385179667492,\&quot;y0\&quot;:0.3092279089459151},{\&quot;x\&quot;:35,\&quot;y\&quot;:1.7554694271042415,\&quot;y0\&quot;:0.20058273155029577},{\&quot;x\&quot;:36,\&quot;y\&quot;:2.308524602434114,\&quot;y0\&quot;:0.31880155682037226},{\&quot;x\&quot;:37,\&quot;y\&quot;:2.7798378587096577,\&quot;y0\&quot;:0.25779837527137117},{\&quot;x\&quot;:38,\&quot;y\&quot;:3.0871471730848987,\&quot;y0\&quot;:0.24241086921076518},{\&quot;x\&quot;:39,\&quot;y\&quot;:3.19362118064261,\&quot;y0\&quot;:0.3536675080714262},{\&quot;x\&quot;:40,\&quot;y\&quot;:3.0580826674114436,\&quot;y0\&quot;:0.29878860353479497},{\&quot;x\&quot;:41,\&quot;y\&quot;:2.8290814192483107,\&quot;y0\&quot;:0.2898213406354784},{\&quot;x\&quot;:42,\&quot;y\&quot;:2.403204319807294,\&quot;y0\&quot;:0.2974823384864911},{\&quot;x\&quot;:43,\&quot;y\&quot;:1.979503686260371,\&quot;y0\&quot;:0.2768224214845059},{\&quot;x\&quot;:44,\&quot;y\&quot;:1.5386751122848177,\&quot;y0\&quot;:0.2625686835089886},{\&quot;x\&quot;:45,\&quot;y\&quot;:1.22746871167621,\&quot;y0\&quot;:0.23359802864977608},{\&quot;x\&quot;:46,\&quot;y\&quot;:1.0047814505063442,\&quot;y0\&quot;:0.24328497924115533},{\&quot;x\&quot;:47,\&quot;y\&quot;:0.920231760634797,\&quot;y0\&quot;:0.2828531010300447},{\&quot;x\&quot;:48,\&quot;y\&quot;:1.194396098267215,\&quot;y0\&quot;:0.3547189119951031},{\&quot;x\&quot;:49,\&quot;y\&quot;:1.4579447933613743,\&quot;y0\&quot;:0.38861884832721827},{\&quot;x\&quot;:50,\&quot;y\&quot;:1.8332767350779728,\&quot;y0\&quot;:0.6103500794203246},{\&quot;x\&quot;:51,\&quot;y\&quot;:1.785497637913814,\&quot;y0\&quot;:1.0129364110191195},{\&quot;x\&quot;:52,\&quot;y\&quot;:1.3961662093621368,\&quot;y0\&quot;:1.6570324686435554},{\&quot;x\&quot;:53,\&quot;y\&quot;:0.9233138020734465,\&quot;y0\&quot;:2.072644626086651},{\&quot;x\&quot;:54,\&quot;y\&quot;:0.535039156141422,\&quot;y0\&quot;:2.259541740170017},{\&quot;x\&quot;:55,\&quot;y\&quot;:0.2889374100548123,\&quot;y0\&quot;:1.9960483669841873},{\&quot;x\&quot;:56,\&quot;y\&quot;:0.1537458202547387,\&quot;y0\&quot;:1.5465916714294727},{\&quot;x\&quot;:57,\&quot;y\&quot;:0.1883149606515614,\&quot;y0\&quot;:1.038617914325346}],[{\&quot;x\&quot;:0,\&quot;y\&quot;:0.11051783803850412,\&quot;y0\&quot;:2.1615576650345942},{\&quot;x\&quot;:1,\&quot;y\&quot;:0.13068661955185235,\&quot;y0\&quot;:2.382501214887445},{\&quot;x\&quot;:2,\&quot;y\&quot;:0.1578517352230847,\&quot;y0\&quot;:2.975615095736312},{\&quot;x\&quot;:3,\&quot;y\&quot;:0.1728128878166899,\&quot;y0\&quot;:3.5199603924081355},{\&quot;x\&quot;:4,\&quot;y\&quot;:0.10202869654167444,\&quot;y0\&quot;:4.204081277514723},{\&quot;x\&quot;:5,\&quot;y\&quot;:0.17840681280940773,\&quot;y0\&quot;:4.44089483434798},{\&quot;x\&quot;:6,\&quot;y\&quot;:0.17828655322082343,\&quot;y0\&quot;:4.1832523425049954},{\&quot;x\&quot;:7,\&quot;y\&quot;:0.19687224281951787,\&quot;y0\&quot;:3.5797697083180497},{\&quot;x\&quot;:8,\&quot;y\&quot;:0.15308661116287114,\&quot;y0\&quot;:2.803700909107621},{\&quot;x\&quot;:9,\&quot;y\&quot;:0.16337432491127402,\&quot;y0\&quot;:2.0124460618276316},{\&quot;x\&quot;:10,\&quot;y\&quot;:0.19935019137337806,\&quot;y0\&quot;:1.6424332524305119},{\&quot;x\&quot;:11,\&quot;y\&quot;:0.12992399381473663,\&quot;y0\&quot;:1.3001064238170024},{\&quot;x\&quot;:12,\&quot;y\&quot;:0.19960449892096221,\&quot;y0\&quot;:1.3973762180083216},{\&quot;x\&quot;:13,\&quot;y\&quot;:0.10027564393822104,\&quot;y0\&quot;:1.362848539389803},{\&quot;x\&quot;:14,\&quot;y\&quot;:0.12569230108056217,\&quot;y0\&quot;:1.53856541351258},{\&quot;x\&quot;:15,\&quot;y\&quot;:0.17503334458451777,\&quot;y0\&quot;:1.565155474698313},{\&quot;x\&quot;:16,\&quot;y\&quot;:0.19269541966194062,\&quot;y0\&quot;:1.646122801255669},{\&quot;x\&quot;:17,\&quot;y\&quot;:0.1962713932455704,\&quot;y0\&quot;:1.582740885224415},{\&quot;x\&quot;:18,\&quot;y\&quot;:0.19479403514149154,\&quot;y0\&quot;:1.583740113554104},{\&quot;x\&quot;:19,\&quot;y\&quot;:0.18478477013321984,\&quot;y0\&quot;:1.539614074589073},{\&quot;x\&quot;:20,\&quot;y\&quot;:0.3903502085015326,\&quot;y0\&quot;:1.7931733282292055},{\&quot;x\&quot;:21,\&quot;y\&quot;:2.113535902304932,\&quot;y0\&quot;:2.105096838049742},{\&quot;x\&quot;:22,\&quot;y\&quot;:4.817339276092961,\&quot;y0\&quot;:2.4505421225901305},{\&quot;x\&quot;:23,\&quot;y\&quot;:2.7301424058386385,\&quot;y0\&quot;:2.394642602411489},{\&quot;x\&quot;:24,\&quot;y\&quot;:0.5160762371843461,\&quot;y0\&quot;:1.7158760522013208},{\&quot;x\&quot;:25,\&quot;y\&quot;:0.18540916174249022,\&quot;y0\&quot;:1.1209698139138404},{\&quot;x\&quot;:26,\&quot;y\&quot;:0.5677074867030829,\&quot;y0\&quot;:0.7814645791428254},{\&quot;x\&quot;:27,\&quot;y\&quot;:1.1464075745324163,\&quot;y0\&quot;:0.5883648401847228},{\&quot;x\&quot;:28,\&quot;y\&quot;:1.2876248090555846,\&quot;y0\&quot;:0.541738606274869},{\&quot;x\&quot;:29,\&quot;y\&quot;:0.6980320380328242,\&quot;y0\&quot;:0.45267326713390127},{\&quot;x\&quot;:30,\&quot;y\&quot;:0.24283358972081664,\&quot;y0\&quot;:0.5092891719316803},{\&quot;x\&quot;:31,\&quot;y\&quot;:0.11682030700960003,\&quot;y0\&quot;:0.6903850224746322},{\&quot;x\&quot;:32,\&quot;y\&quot;:0.15527601995343537,\&quot;y0\&quot;:0.8428657939873628},{\&quot;x\&quot;:33,\&quot;y\&quot;:0.12116465080341,\&quot;y0\&quot;:1.2231526523956242},{\&quot;x\&quot;:34,\&quot;y\&quot;:0.11856791414918837,\&quot;y0\&quot;:1.6445664269126643},{\&quot;x\&quot;:35,\&quot;y\&quot;:0.18425266326500114,\&quot;y0\&quot;:1.9560521586545372},{\&quot;x\&quot;:36,\&quot;y\&quot;:0.1885328239909346,\&quot;y0\&quot;:2.627326159254486},{\&quot;x\&quot;:37,\&quot;y\&quot;:0.22762141668860758,\&quot;y0\&quot;:3.0376362339810288},{\&quot;x\&quot;:38,\&quot;y\&quot;:0.30843369961151645,\&quot;y0\&quot;:3.329558042295664},{\&quot;x\&quot;:39,\&quot;y\&quot;:0.5150686859947133,\&quot;y0\&quot;:3.547288688714036},{\&quot;x\&quot;:40,\&quot;y\&quot;:0.7904080489023975,\&quot;y0\&quot;:3.3568712709462387},{\&quot;x\&quot;:41,\&quot;y\&quot;:0.9969372223042159,\&quot;y0\&quot;:3.118902759883789},{\&quot;x\&quot;:42,\&quot;y\&quot;:1.1835681067174746,\&quot;y0\&quot;:2.700686658293785},{\&quot;x\&quot;:43,\&quot;y\&quot;:1.1976013965051904,\&quot;y0\&quot;:2.256326107744877},{\&quot;x\&quot;:44,\&quot;y\&quot;:1.0675440751484562,\&quot;y0\&quot;:1.8012437957938063},{\&quot;x\&quot;:45,\&quot;y\&quot;:0.7788761831088342,\&quot;y0\&quot;:1.461066740325986},{\&quot;x\&quot;:46,\&quot;y\&quot;:0.5260592994869968,\&quot;y0\&quot;:1.2480664297474995},{\&quot;x\&quot;:47,\&quot;y\&quot;:0.32297373237592664,\&quot;y0\&quot;:1.2030848616648417},{\&quot;x\&quot;:48,\&quot;y\&quot;:0.23281612172581895,\&quot;y0\&quot;:1.5491150102623181},{\&quot;x\&quot;:49,\&quot;y\&quot;:0.15490821516916609,\&quot;y0\&quot;:1.8465636416885927},{\&quot;x\&quot;:50,\&quot;y\&quot;:0.19289989359183243,\&quot;y0\&quot;:2.4436268144982973},{\&quot;x\&quot;:51,\&quot;y\&quot;:0.19691381881928033,\&quot;y0\&quot;:2.7984340489329336},{\&quot;x\&quot;:52,\&quot;y\&quot;:0.16966840994286328,\&quot;y0\&quot;:3.053198678005692},{\&quot;x\&quot;:53,\&quot;y\&quot;:0.10215978941475964,\&quot;y0\&quot;:2.9959584281600975},{\&quot;x\&quot;:54,\&quot;y\&quot;:0.1131423233217642,\&quot;y0\&quot;:2.7945808963114387},{\&quot;x\&quot;:55,\&quot;y\&quot;:0.11913954267715618,\&quot;y0\&quot;:2.2849857770389996},{\&quot;x\&quot;:56,\&quot;y\&quot;:0.12786382707962554,\&quot;y0\&quot;:1.7003374916842113},{\&quot;x\&quot;:57,\&quot;y\&quot;:0.1917928157522389,\&quot;y0\&quot;:1.2269328749769075}]]\n}\n\n\n&quot;}</pre>
</div>
<div title="Home" creator="YourName" modifier="YourName" created="202507191948" modified="202507191951" changecount="4">
<pre>This site is a demo for all plugins I made.
!YSPlugin
&lt;&lt;forEachTiddler 
where 
'tiddler.tags.contains(&quot;YSPlugin&quot;)'
sortBy
'tiddler.title'
write 
'&quot;|vertical-align:top;@@white-space: nowrap;{{large{[[&quot;
+tiddler.title
+&quot;]]}}}@@&lt;br&gt;  &quot;
+&quot;|\n&quot;'
&gt;&gt;</pre>
</div>
<div title="HorizontalSplitScreenPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191918" modified="202507191944" tags="systemConfig YSPlugin" changecount="3">
<pre>/***
|Name        |HorizontalSplitScreenPlugin|
|Description |Opens a new pop-up window with a horizontal split view, displaying the current page and another URL in a frameset.|
|Source      |https://github.com/wangyenshu/HorizontalSplitScreenPlugin/blob/main/HorizontalSplitScreenPlugin.js|
|Version     |0.1|
|Author      |Yanshu Wang, with the help of AI|
|License     |MIT|
|~CoreVersion|2.x|
|Type        |plugin|
!!!!!Documentation
Use the {{{&lt;&lt;HorizontalSplitScreen&gt;&gt;}}} macro to display a button that launches the horizontal split-screen browser.
It will open in a new pop-up window, prompting for a URL for the bottom pane.
&lt;&lt;HorizontalSplitScreen&gt;&gt;
!!!!!Code
***/
//{{{
config.macros.HorizontalSplitScreen = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Create a button element
        var button = document.createElement(&quot;button&quot;);
        button.innerText = &quot;Open Horizontal Split Screen&quot;; // Text displayed on the button
        button.title = &quot;Click to open a horizontal split screen view on the current page&quot;; // Tooltip

        // Add basic styling classes for consistency with TiddlyWiki buttons
        button.className = &quot;tiddlyLink button&quot;;

        button.onclick = function() {
            var href = location.href;
            // Prompt for the URL for the bottom frame.
            var website = prompt('Please enter the URL for the bottom pane:', '') || href;

            // Remove any existing split screen containers or close buttons before creating new ones
            var existingContainer = document.getElementById(&quot;horizontalSplitScreenContainer&quot;);
            if (existingContainer) {
                document.body.removeChild(existingContainer);
            }
            var existingCloseButton = document.getElementById(&quot;horizontalSplitScreenCloseButton&quot;);
            if (existingCloseButton) {
                document.body.removeChild(existingCloseButton);
            }

            // Create the main container for the split view
            var splitContainer = document.createElement(&quot;div&quot;);
            splitContainer.setAttribute(&quot;id&quot;, &quot;horizontalSplitScreenContainer&quot;);
            splitContainer.style.position = &quot;fixed&quot;;
            splitContainer.style.left = &quot;0&quot;;
            splitContainer.style.top = &quot;0&quot;;
            splitContainer.style.width = &quot;100vw&quot;;
            splitContainer.style.height = &quot;100vh&quot;;
            splitContainer.style.zIndex = &quot;99999&quot;; // High z-index to overlay content
            splitContainer.style.display = &quot;flex&quot;; // Use flexbox for layout
            splitContainer.style.flexDirection = &quot;column&quot;; // Arrange items vertically (top-bottom)
            splitContainer.style.border = &quot;none&quot;;
            splitContainer.style.margin = &quot;0&quot;;
            splitContainer.style.padding = &quot;0&quot;;
            splitContainer.style.backgroundColor = &quot;white&quot;; // Ensure background is solid if iframes don't load fully

            // Create the top iframe for the current page
            var topIframe = document.createElement(&quot;iframe&quot;);
            topIframe.style.width = &quot;100%&quot;;
            topIframe.style.height = &quot;50%&quot;; // Top half
            topIframe.style.border = &quot;none&quot;;
            topIframe.style.margin = &quot;0&quot;;
            topIframe.style.padding = &quot;0&quot;;
            topIframe.src = href; // Load current page into top iframe

            // Create the bottom iframe for the specified website
            var bottomIframe = document.createElement(&quot;iframe&quot;);
            bottomIframe.style.width = &quot;100%&quot;;
            bottomIframe.style.height = &quot;50%&quot;; // Bottom half
            bottomIframe.style.border = &quot;none&quot;;
            bottomIframe.style.margin = &quot;0&quot;;
            bottomIframe.style.padding = &quot;0&quot;;
            bottomIframe.src = website; // Load user-specified website into bottom iframe

            // Append iframes to the container
            splitContainer.appendChild(topIframe);
            splitContainer.appendChild(bottomIframe);

            // Append the container to the document body
            document.body.appendChild(splitContainer);

            // Create a close button for the split view
            var closeButton = document.createElement(&quot;button&quot;);
            closeButton.innerText = &quot;Close Split View&quot;;
            closeButton.style.position = &quot;fixed&quot;;
            closeButton.style.top = &quot;10px&quot;;
            closeButton.style.right = &quot;10px&quot;;
            closeButton.style.zIndex = &quot;100000&quot;; // Higher than iframe container
            closeButton.style.padding = &quot;5px 10px&quot;;
            closeButton.style.borderRadius = &quot;5px&quot;;
            closeButton.style.backgroundColor = &quot;#ff4d4d&quot;; // Red color
            closeButton.style.color = &quot;white&quot;;
            closeButton.style.border = &quot;none&quot;;
            closeButton.style.cursor = &quot;pointer&quot;;
            closeButton.setAttribute(&quot;id&quot;, &quot;horizontalSplitScreenCloseButton&quot;);

            closeButton.onclick = function() {
                var containerToRemove = document.getElementById(&quot;horizontalSplitScreenContainer&quot;);
                if (containerToRemove) {
                    document.body.removeChild(containerToRemove);
                }
                var buttonToRemove = document.getElementById(&quot;horizontalSplitScreenCloseButton&quot;);
                if (buttonToRemove) {
                    document.body.removeChild(buttonToRemove);
                }
            };
            document.body.appendChild(closeButton);

            return false; // Prevent default button action
        };

        // Append the main plugin button to the place where the macro is called
        place.appendChild(button);
    }
};
//}}}</pre>
</div>
<div title="JSONEditorPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191919" modified="202507191945" tags="systemConfig YSPlugin" changecount="5">
<pre>/***
|Name|JSONEditorPlugin|
|Description|A GUI editor for JSON content in TiddlyWiki tiddlers. Companion plugin for innerTW5Plugin.|
|Version|0.1|
|Source|https://github.com/wangyenshu/JSONEditorPlugin/blob/main/JSONEditorPlugin.js|
|Author|YanshuWang, with the help of AI|
|License|MIT|
|~CoreVersion|2.x|
!Installation:
Add {{{jsonEdit}}} to [[ToolbarCommands]].
***/
//{{{
// Ensure config.extensions.JSONEditor is defined for proper namespacing
if (!config.extensions.JSONEditor) {
    config.extensions.JSONEditor = {};
}

(function() { // Start of a closure for local aliases and variables

    var JSONEditor = config.extensions.JSONEditor; // Alias for our plugin's namespace

    /*
    ** Helper Functions (Namespaced within JSONEditor)
    */

    // JSONEditor.tryParseJSON: Safely parses a JSON string. Returns null if invalid or not an object/array.
    JSONEditor.tryParseJSON = function(jsonString) {
        if (!jsonString) {
            return null; // Handle empty or null strings directly
        }
        try {
            var o = JSON.parse(jsonString);
            // Ensure it's an object or array, not just a primitive like &quot;null&quot; or &quot;123&quot;
            if (typeof o === &quot;object&quot; &amp;&amp; o !== null) {
                return o;
            }
        } catch (e) {
            // Parsing failed, return null
        }
        return null;
    };

    // JSONEditor.addPropertyField: Adds a new key-value input pair to the editor GUI
    // This function is also used for existing properties now.
    JSONEditor.addPropertyField = function(wrapper, key, value, isNewProperty) {
        key = key || &quot;newProperty&quot;;
        value = value || &quot;&quot;;
        isNewProperty = isNewProperty === true; // Ensure boolean

        var fieldContainer = createTiddlyElement(wrapper, &quot;div&quot;, null, &quot;jsonEditorField&quot;);

        // Key Input
        var keyLabel = createTiddlyElement(fieldContainer, &quot;label&quot;, null, &quot;jsonEditorLabel jsonEditorKeyLabel&quot;);
        keyLabel.textContent = &quot;Key:&quot;;
        var keyInput = createTiddlyElement(keyLabel, &quot;input&quot;, null, &quot;jsonEditorKeyInput&quot;);
        keyInput.type = &quot;text&quot;;
        keyInput.value = key;
        if (!isNewProperty) {
            keyInput.setAttribute(&quot;readonly&quot;, &quot;readonly&quot;); // Make existing keys non-editable to simplify
            keyInput.className += &quot; jsonEditorKeyInputReadonly&quot;;
        }
        keyInput.setAttribute(&quot;data-json-key-field&quot;, &quot;true&quot;); // Mark as key input

        // Value Input
        var valueInput;
        // Determine input type based on value, if not new property
        if (!isNewProperty) {
            if (typeof value === 'string' &amp;&amp; (value.length &gt; 50 || value.indexOf('\n') !== -1)) {
                valueInput = createTiddlyElement(fieldContainer, &quot;textarea&quot;, null, &quot;jsonEditorInput jsonEditorTextarea&quot;);
                valueInput.value = value;
                valueInput.style.height = &quot;60px&quot;; // Default height for existing long textareas
            } else if (typeof value === 'boolean') {
                valueInput = createTiddlyElement(fieldContainer, &quot;input&quot;, null, &quot;jsonEditorInput jsonEditorCheckbox&quot;);
                valueInput.type = &quot;checkbox&quot;;
                valueInput.checked = value;
            } else if (typeof value === 'number') {
                valueInput = createTiddlyElement(fieldContainer, &quot;input&quot;, null, &quot;jsonEditorInput jsonEditorNumber&quot;);
                valueInput.type = &quot;number&quot;;
                valueInput.value = value;
            } else if (value === null) {
                valueInput = createTiddlyElement(fieldContainer, &quot;input&quot;, null, &quot;jsonEditorInput jsonEditorNull&quot;);
                valueInput.type = &quot;text&quot;;
                valueInput.value = &quot;null&quot;;
            } else if (typeof value === 'object') {
                valueInput = createTiddlyElement(fieldContainer, &quot;textarea&quot;, null, &quot;jsonEditorInput jsonEditorObject&quot;);
                valueInput.value = JSON.stringify(value, null, 2); // Still pretty-print for in-editor display
                valueInput.style.height = &quot;100px&quot;;
            } else {
                valueInput = createTiddlyElement(fieldContainer, &quot;input&quot;, null, &quot;jsonEditorInput jsonEditorText&quot;);
                valueInput.type = &quot;text&quot;;
                valueInput.value = String(value);
            }
        } else {
            // For new properties, default to a textarea with smaller initial height
            valueInput = createTiddlyElement(fieldContainer, &quot;textarea&quot;, null, &quot;jsonEditorInput jsonEditorTextarea&quot;);
            valueInput.value = value;
            valueInput.style.height = &quot;30px&quot;;
        }

        valueInput.setAttribute(&quot;data-json-value-field&quot;, &quot;true&quot;); // Mark as value input

        // Delete button
        var deleteButton = createTiddlyButton(fieldContainer, &quot;X&quot;, &quot;Remove this property&quot;, function() {
            wrapper.removeChild(fieldContainer);
        }, &quot;jsonEditorDeleteButton&quot;);

        fieldContainer.appendChild(keyLabel); // Append key label (which contains key input)
        fieldContainer.appendChild(valueInput); // Then value input
        fieldContainer.appendChild(deleteButton); // Add delete button at the end
    };


    /*
    ** JSON Editor Macro (config.macros.jsonEdit)
    */
    config.macros.jsonEdit = {
        handler: function(place, macroName, params, wikifier, paramString, tiddler) {
            var jsonString = tiddler.text || &quot;&quot;; // Get tiddler's main text content, default to empty string
            var data = JSONEditor.tryParseJSON(jsonString); // Use namespaced helper

            if (!data) {
                // If invalid or empty JSON, display a simple textarea for manual editing
                var msg = createTiddlyElement(place, &quot;p&quot;);
                msg.className = &quot;jsonEditorErrorMessage&quot;;
                msg.innerHTML = &quot;&lt;strong&gt;Error:&lt;/strong&gt; This tiddler's 'text' content does not contain valid JSON (must be an object or array). Displaying as plain text.&lt;br&gt;Please enter valid JSON to use the GUI editor.&quot;;

                var textArea = createTiddlyElement(place, &quot;textarea&quot;, null, &quot;jsonEditorFallbackTextArea&quot;);
                textArea.value = jsonString; // Show whatever content was there (even if 'undefined' from source)
                textArea.style.width = &quot;100%&quot;;
                textArea.style.height = config.options.txtEasyEditorHeight || &quot;500px&quot;; // Reuse EasyEdit height option
                textArea.setAttribute(&quot;edit&quot;, &quot;text&quot;); // Mark for saving: specifically target the 'text' property
                return;
            }

            // --- Valid JSON detected, render GUI editor ---
            var wrapper = createTiddlyElement(place, &quot;div&quot;, null, &quot;jsonEditorWrapper&quot;);
            wrapper.setAttribute(&quot;jsonEdit&quot;, &quot;text&quot;); // Custom attribute to identify this editor for gathering data, always 'text'

            // Add button for adding new properties
            var addButtonContainer = createTiddlyElement(wrapper, &quot;div&quot;, null, &quot;jsonEditorAddButtonContainer&quot;);
            var addBtn = createTiddlyButton(addButtonContainer, &quot;Add Property&quot;, &quot;Add a new key-value pair&quot;, function() {
                JSONEditor.addPropertyField(wrapper, &quot;&quot;, &quot;&quot;, true); // Add new empty field, mark as new
            }, &quot;jsonEditorAddButton&quot;);

            // Render existing properties
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    JSONEditor.addPropertyField(wrapper, key, data[key], false); // Pass key, value, and false for isNewProperty
                }
            }
        },

        // gather: Collects data from the GUI and converts back to JSON
        gather: function(element) {
            var jsonEditAttr = element.getAttribute(&quot;jsonEdit&quot;);
            if (jsonEditAttr) {
                var newData = {};
                var isValid = true; // Flag for overall validity

                // Iterate over all field containers to gather both existing and new properties
                var fieldContainers = element.querySelectorAll(&quot;.jsonEditorField&quot;);
                fieldContainers.forEach(function(container) {
                    var keyInput = container.querySelector(&quot;.jsonEditorKeyInput&quot;);
                    var valueInput = container.querySelector(&quot;.jsonEditorInput[data-json-value-field='true']&quot;);

                    if (keyInput &amp;&amp; valueInput) {
                        var key = keyInput.value.trim();
                        var value = JSONEditor._parseInputValue(valueInput, key); // Use namespaced helper
                        if (value === undefined) isValid = false; // Flag if parsing failed

                        if (key) { // Only add if key is not empty
                            if (newData.hasOwnProperty(key)) {
                                displayMessage(&quot;Warning: Duplicate key '&quot; + key + &quot;' found. Only the first instance will be saved.&quot;);
                            } else {
                                newData[key] = value;
                            }
                        }
                    }
                });

                if (!isValid) {
                    displayMessage(&quot;Some values were not valid. Please check the JSON editor.&quot;);
                }

                return JSON.stringify(newData); // Compact JSON output
            } else {
                // If it's the fallback textarea (for invalid initial JSON)
                var textArea = element.querySelector(&quot;.jsonEditorFallbackTextArea&quot;);
                if (textArea) {
                    return textArea.value; // Return the content of the raw textarea
                }
            }
            return null;
        }
    };

    /*
    ** Internal Helper for Parsing Input Values (within JSONEditor namespace)
    */
    JSONEditor._parseInputValue = function(inputElement, keyName) {
        var value;
        if (inputElement.classList.contains(&quot;jsonEditorCheckbox&quot;)) {
            value = inputElement.checked;
        } else if (inputElement.classList.contains(&quot;jsonEditorNumber&quot;)) {
            value = parseFloat(inputElement.value);
            if (isNaN(value) &amp;&amp; inputElement.value !== &quot;&quot;) {
                displayMessage(&quot;Warning: Value for '&quot; + keyName + &quot;' is not a valid number. Saving as string.&quot;);
                value = inputElement.value; // Fallback to string
            }
        } else if (inputElement.classList.contains(&quot;jsonEditorNull&quot;)) {
            value = (inputElement.value.toLowerCase() === &quot;null&quot;) ? null : inputElement.value;
        } else if (inputElement.classList.contains(&quot;jsonEditorObject&quot;)) {
            value = JSONEditor.tryParseJSON(inputElement.value); // Use namespaced helper
            if (value === null &amp;&amp; inputElement.value !== &quot;&quot;) {
                displayMessage(&quot;Warning: Value for '&quot; + keyName + &quot;' is not valid JSON. Saving as plain string.&quot;);
                value = inputElement.value; // Fallback to string
            }
        } else {
            value = inputElement.value; // For plain text inputs (includes new property values)
        }
        return value;
    };


    /*
    ** Hijacking Story.prototype.gatherSaveFields
    */

    // 1. Backup the original function in the same namespace
    Story.prototype.gatherSaveFields_JSONEditor = Story.prototype.gatherSaveFields;

    // 2. Overwrite the original
    Story.prototype.gatherSaveFields = function(e, fields) {
        // First, invoke the original gatherSaveFields
        Story.prototype.gatherSaveFields_JSONEditor.apply(this, arguments);

        // Then, add our custom gathering logic if our editor is present
        // The 'f' attribute should always be 'text' for this specific plugin.
        if (e &amp;&amp; e.getAttribute) {
            var f = e.getAttribute(&quot;jsonEdit&quot;);
            if (f === &quot;text&quot;) { // Explicitly check for 'text' field
                var newVal = config.macros.jsonEdit.gather(e);
                if (newVal !== null) { // Only update if gather returned a non-null value
                    fields[f] = newVal;
                }
            }
        }
    };

    /*
    ** JSON Editor Command (config.commands.jsonEdit)
    */
    config.commands.jsonEdit = {
        text: &quot;edit JSON&quot;,
        tooltip: &quot;Edit this tiddler's content as JSON in a GUI&quot;,
        readOnlyText: &quot;view JSON&quot;,
        readOnlyTooltip: &quot;View the JSON source of this tiddler&quot;,
        handler: function(event, src, title) {
            clearMessage();
            // Pass 'text' as the parameter to the template, indicating we want to edit the 'text' field.
            story.displayTiddler(null, title, &quot;JsonEditTemplate&quot;, false, null, &quot;text&quot;); // Note: template name still 'JsonEditTemplate'
            return false;
        }
    };

})(window.jQuery); // End of closure, using window.jQuery if available, otherwise just ()

/*
** Shadow Tiddlers and Stylesheets
*/

// Modify the ViewTemplate to add a &quot;edit JSON&quot; button next to the &quot;edit&quot; button
// This is outside the closure as it modifies a global config object directly.
config.shadowTiddlers.ViewTemplate = config.shadowTiddlers.ViewTemplate.replace(/\+editTiddler/, &quot;+editTiddler jsonEdit&quot;);

// Create the JsonEditTemplate by modifying the default EditTemplate
// This tells TiddlyWiki to use our 'jsonEdit' macro instead of the default 'edit' macro
// for the 'text' field when the JsonEditTemplate is active.
// Keep the template name as 'JsonEditTemplate' for compatibility with existing references
config.shadowTiddlers.JsonEditTemplate = config.shadowTiddlers.EditTemplate.replace(/macro='edit text'/g, &quot;macro='jsonEdit text'&quot;);

// Optional: Stylesheet for the JSON editor GUI
config.shadowTiddlers.JsonEditorStyleSheet = &quot;/*{{{*/\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorWrapper { margin: 1em 0; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorField { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 5px; }\n&quot;; /* Added gap for spacing */
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorKeyLabel { flex-shrink: 0; display: flex; align-items: center; gap: 5px; }\n&quot;; /* For key input */
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorKeyInput { flex-grow: 1; padding: 6px 8px; border: 1px solid #bbb; border-radius: 4px; font-family: monospace; font-size: 0.9em; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorKeyInputReadonly { background-color: #eee; cursor: not-allowed; }\n&quot;; /* Style for readonly keys */
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorLabel { font-weight: bold; margin-right: 10px; min-width: 120px; color: #333; padding-top: 5px; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorInput { flex-grow: 1; padding: 6px 8px; border: 1px solid #bbb; border-radius: 4px; font-family: monospace; font-size: 0.9em; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorInput:focus, .jsonEditorKeyInput:focus { border-color: #5cb3fd; outline: none; box-shadow: 0 0 5px rgba(82,168,236,0.5); }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorTextarea { resize: vertical; min-height: 60px; **width: 100px;** }\n&quot;; /* CRITICAL CHANGE */
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorCheckbox { margin-left: 0; margin-top: 8px; transform: scale(1.2); }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorFallbackTextArea { /* Styles for the raw text fallback area */ }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorErrorMessage { color: #D8000C; background-color: #FFBABA; border: 1px solid #D8000C; padding: 8px; margin-bottom: 10px; border-radius: 4px; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorAddButtonContainer { margin-bottom: 10px; text-align: right; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorAddButton { background-color: #4CAF50; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorAddButton:hover { background-color: #45a049; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorDeleteButton { background-color: #f44336; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-left: 5px; line-height: 1; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;.jsonEditorDeleteButton:hover { background-color: #da190b; }\n&quot;;
config.shadowTiddlers.JsonEditorStyleSheet += &quot;/*}}}*/&quot;;

store.addNotification(&quot;JsonEditorStyleSheet&quot;, refreshStyles);

//}}}</pre>
</div>
<div title="LLMPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191920" modified="202507191945" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name        |LLMPlugin|
|Description |Displays an interface for llm.js to run a language model.|
|Source      |https://github.com/wangyenshu/LLMPlugin/blob/main/LLMPlugin.js|
|Version     |0.1|
|Author      |Yanshu Wang|
|License     |MIT|
|~CoreVersion|2.x|
|Type        |plugin|
!!!!!Documentation
Download llm.js release from https://github.com/rahuldshetty/llm.js/releases. Keep the folder structure. Set the path to llm.js in [[LLMPluginConfig]].
Use the {{{llmjs}}} macro (accepts optional parameters &quot;prompt&quot;, &quot;model&quot;, and &quot;modelType&quot;):
{{{
&lt;&lt;llmjs
  prompt:&quot;def fibonacci(n):&quot;
  model:&quot;https://huggingface.co/RichardErkhov/bigcode_-_tiny_starcoder_py-gguf/resolve/main/tiny_starcoder_py.Q8_0.gguf&quot;
  modelType:&quot;GGUF_CPU&quot;
&gt;&gt;
}}}
&lt;&lt;llmjs
  prompt:&quot;def fibonacci(n):&quot;
  model:&quot;https://huggingface.co/RichardErkhov/bigcode_-_tiny_starcoder_py-gguf/resolve/main/tiny_starcoder_py.Q8_0.gguf&quot;
  modelType:&quot;GGUF_CPU&quot;
&gt;&gt;
!!!!!Code
***/
//{{{
config.macros.llmjs = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters
        var p = paramString.parseParams()[0] || {};
        var initialPrompt = p.prompt ? p.prompt[0] : &quot;def fibonacci(n):&quot;;
        var modelUrl = p.model ? p.model[0] : &quot;https://huggingface.co/RichardErkhov/bigcode_-_tiny_starcoder_py-gguf/resolve/main/tiny_starcoder_py.Q8_0.gguf&quot;;
        var modelType = p.modelType ? p.modelType[0] : &quot;GGUF_CPU&quot;;

        // Create a container for the LLM.js interface
        var container = document.createElement(&quot;div&quot;);
        container.innerHTML = `
            &lt;style&gt;
			  .llmInteraction {
				box-sizing: border-box;
				border: 1px solid black;
				width: 500px;
				border-radius: 10px;
				padding: 10px;

				font-family: monospace;
			  }
			&lt;/style&gt;
            &lt;h3&gt;Enter Prompt for LLM:&lt;/h3&gt;
            &lt;textarea id=&quot;llmPromptInput&quot; rows=&quot;4&quot; class=&quot;llmInteraction&quot; style=&quot;background-color:#f4f4f4;&quot;&gt;${initialPrompt}&lt;/textarea&gt;
            &lt;div&gt;&lt;button id=&quot;runLLMButton&quot;&gt;Run Model&lt;/button&gt;&lt;/div&gt;
            &lt;div&gt;
              &lt;h3&gt;Output:&lt;/h3&gt;
              &lt;pre id=&quot;llmOutput&quot; class=&quot;llmInteraction&quot; style=&quot;white-space: pre-wrap; background-color:#EBEEF1; height:150px; overflow-y:auto;&quot;&gt;&lt;/pre&gt;
            &lt;/div&gt;
        `;
        place.appendChild(container);
        
        // Load llm.js from the configured path
        var llmjsPath = config.options.txtllmjsPath;
        if (!llmjsPath) {
            console.error(&quot;The path to llm.js is not set in config.options.txtllmjsPath.&quot;);
            return;
        }
        var scriptElement = document.createElement(&quot;script&quot;);
        scriptElement.src = llmjsPath;
        scriptElement.type = &quot;module&quot;;
        scriptElement.onload = function() {
            // Within the module, import LLM and expose it globally
            // (We use an inline module script to do this.)
            var moduleCode = `
                import { LLM } from &quot;${llmjsPath}&quot;;
                window.LLM = LLM;
            `;
            var inlineScript = document.createElement(&quot;script&quot;);
            inlineScript.type = &quot;module&quot;;
            inlineScript.textContent = moduleCode;
            document.head.appendChild(inlineScript);
            
            // Delay setup to allow the inline module to execute and define window.LLM
            setTimeout(function(){
                if (typeof window.LLM === 'undefined') {
                    console.error(&quot;Failed to load LLM from the specified path:&quot;, llmjsPath);
                    return;
                }
                
                // State variable to track model load status
                let model_loaded = false;
                
                // Get references to UI elements
                const outputElem = document.getElementById(&quot;llmOutput&quot;);
                const promptInput = document.getElementById(&quot;llmPromptInput&quot;);
                const runButton = document.getElementById(&quot;runLLMButton&quot;);
                
                // Callback functions
                const on_loaded = () =&gt; { 
                    model_loaded = true; 
                    console.log(&quot;LLM model loaded&quot;);
                };
                const write_result = (text) =&gt; { 
                    outputElem.innerText += text + &quot;\n&quot;; 
                };
                const run_complete = () =&gt; { 
                    console.log(&quot;Model run complete&quot;);
                };
                
                // Configure the LLM instance using parameters from the macro
                const app = new window.LLM(
                    modelType,
                    modelUrl,
                    on_loaded,
                    write_result,
                    run_complete
                );
                
                // Download and load the model using a web worker
                app.load_worker();
                
                // Function to run the model using the current prompt
                async function runModel() {
                    if (!model_loaded) {
                        outputElem.innerText += &quot;Model not loaded yet. Please wait...\n&quot;;
                        return;
                    }
                    // Clear previous output
                    outputElem.innerText = &quot;&quot;;
                    // Run the model with the prompt from the input
                    const promptText = promptInput.value;
                    await app.run({ prompt: promptText, top_k: 1 });
                }
                
                // Attach the event listener to the run button
                runButton.addEventListener(&quot;click&quot;, runModel);
                
                // Optionally, trigger a run automatically once the model loads
                const checkInterval = setInterval(() =&gt; {
                    if(model_loaded) {
                        runModel();
                        clearInterval(checkInterval);
                    } else {
                        console.log(&quot;Waiting for model to load...&quot;);
                    }
                }, 5000);
            }, 500); // Adjust delay as needed
        };
        scriptElement.onerror = function() {
            console.error(&quot;Error loading llm.js from the specified path:&quot;, llmjsPath);
        };
        document.body.appendChild(scriptElement);
    }
};
//}}}</pre>
</div>
<div title="LLMPluginConfig" creator="YourName" modifier="YourName" created="202507191940" tags="systemConfig" changecount="1">
<pre>config.options.txtllmjsPath = &quot;./js/llm.js/llm.js&quot;;</pre>
</div>
<div title="MainMenu" creator="YourName" modifier="YourName" created="202507191947" changecount="1">
<pre>[[Home]]</pre>
</div>
<div title="ModelViewerPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191921" modified="202507191945" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name|ModelViewerPlugin|
|Source|https://github.com/wangyenshu/ModelViewerPlugin/blob/main/ModelViewerPlugin.js|
|Version|0.1|
|Author|Yanshu Wang|
|License|MIT|
|~CoreVersion|2.x|
|Type|plugin|
|Description|Displays a 3D model using the model‑viewer web component|
!!!!!Documentation
{{{
&lt;&lt;modelviewer src:&quot;https://example.com/model.glb&quot; alt:&quot;3D Model&quot; ar:&quot;true&quot; environmentImage:&quot;https://example.com/env.hdr&quot; poster:&quot;https://example.com/poster.webp&quot; shadowIntensity:&quot;1&quot; cameraControls:&quot;true&quot; touchAction:&quot;pan-y&quot; size:&quot;200%,200%&quot;&gt;&gt;
}}}
Model downloaded from https://sketchfab.com/3d-models/low-poly-truck-car-drifter-f3750246b6564607afbefc61cb1683b1.
&lt;&lt;modelviewer src:&quot;./assets/models/low-poly_truck_car_drifter.glb&quot; alt:&quot;3D Model Demo&quot; ar:&quot;true&quot; shadowIntensity:&quot;1&quot; cameraControls:&quot;true&quot; touchAction:&quot;pan-y&quot; size:&quot;200%,200%&quot;&gt;&gt;
!!!!!Credit
https://modelviewer.dev/
!!!!!Code
***/
//{{{
if(!version.extensions.ModelViewerPlugin) {
    version.extensions.ModelViewerPlugin = {major: 1, minor: 0, revision: 4, date: new Date()};
}

config.macros.modelviewer = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Ensure the model-viewer JS is loaded
        if(!document.getElementById(&quot;model-viewer-script&quot;)) {
            var script = document.createElement(&quot;script&quot;);
            script.type = &quot;module&quot;;
            script.src = &quot;https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js&quot;;
            script.id = &quot;model-viewer-script&quot;;
            document.getElementsByTagName(&quot;head&quot;)[0].appendChild(script);
        }
        // Parse parameters using TiddlyWiki Classic's parseParams method.
        var p = paramString.parseParams(&quot;name&quot;, null, true)[0] || {};
        
        // Build attribute string for &lt;model-viewer&gt;
        var attr = &quot;&quot;;
        if(p.src) { attr += ' src=&quot;' + p.src + '&quot;'; }
        if(p.alt) { attr += ' alt=&quot;' + p.alt + '&quot;'; }
        if(p.poster) { attr += ' poster=&quot;' + p.poster + '&quot;'; }
        if(p.ar &amp;&amp; p.ar.toString().toLowerCase() === &quot;true&quot;) { attr += &quot; ar&quot;; }
        if(p.environmentImage) { attr += ' environment-image=&quot;' + p.environmentImage + '&quot;'; }
        if(p.shadowIntensity) { attr += ' shadow-intensity=&quot;' + p.shadowIntensity + '&quot;'; }
        if(p.cameraControls &amp;&amp; p.cameraControls.toString().toLowerCase() === &quot;true&quot;) { attr += &quot; camera-controls&quot;; }
        if(p.touchAction) { attr += ' touch-action=&quot;' + p.touchAction + '&quot;'; }
        
        // Create a container with resize functionality
        var div = createTiddlyElement(place, &quot;div&quot;);
        div.style.resize = &quot;both&quot;;
        div.style.overflow = &quot;auto&quot;;
        div.style.minWidth = &quot;200px&quot;;
        div.style.minHeight = &quot;200px&quot;;
        
        // If a size parameter is provided, apply it.
        if(p.size) {
            var dims = String(p.size).split(&quot;,&quot;);
            if(dims.length === 2) {
                div.style.width = dims[0].trim();
                div.style.height = dims[1].trim();
            }
        }
        
        // Insert the &lt;model-viewer&gt; element into the container
        div.innerHTML = &quot;&lt;model-viewer&quot; + attr + &quot;&gt;&lt;/model-viewer&gt;&quot;;
    }
};
//}}}</pre>
</div>
<div title="NewTW5TiddlerMacro" creator="Yanshu Wang" modifier="YourName" created="202507191921" modified="202507191946" tags="systemConfig YSPlugin" changecount="6">
<pre>/***
|Name|NewTW5TiddlerMacro|
|Description|Generates a tiddler named 'New TW5Tiddler' with a default TW5-like JSON structure and current timestamps. Companion Plugin for InnerTW5Plugin.|
|Version|0.1|
|Source|https://github.com/wangyenshu/NewTW5TiddlerMacro/blob/main/NewTW5TiddlerMacro.js|
|Author|Yanshu Wang, with the help of AI|
|License|MIT|
|~CoreVersion|2.x|
!Documentation
This plugin depends on [[JSONEditorPlugin]].
!Usage
{{{&lt;&lt;NewTW5Tiddler&gt;&gt;}}}
!Demo
&lt;&lt;NewTW5Tiddler&gt;&gt;
***/
//{{{
config.macros.NewTW5Tiddler = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Create a button to trigger the new tiddler creation
        var button = createTiddlyButton(place, &quot;New TW5Tiddler&quot;, &quot;Create a new tiddler named 'New TW5Tiddler' with JSON content&quot;, this.onClick);
    },

    onClick: function(e) {
        // Generate current timestamp in TiddlyWiki's format (YYYYMMDDHHMMSSmmm)
        var now = new Date();
        var year = now.getFullYear().toString();
        var month = (now.getMonth() + 1).toString();
        if (month.length == 1) month = &quot;0&quot; + month;
        var day = now.getDate().toString();
        if (day.length == 1) day = &quot;0&quot; + day;
        var hours = now.getHours().toString();
        if (hours.length == 1) hours = &quot;0&quot; + hours;
        var minutes = now.getMinutes().toString();
        if (minutes.length == 1) minutes = &quot;0&quot; + minutes;
        var seconds = now.getSeconds().toString();
        if (seconds.length == 1) seconds = &quot;0&quot; + seconds;
        var milliseconds = now.getMilliseconds().toString();
        while (milliseconds.length &lt; 3) milliseconds = &quot;0&quot; + milliseconds; // Ensure 3 digits for milliseconds

        var timestamp = year + month + day + hours + minutes + seconds + milliseconds;

        // Define the content for the new tiddler
        var newTiddlerContent = {
            &quot;created&quot;: timestamp,
            &quot;text&quot;: &quot;&quot;,
            &quot;tags&quot;: &quot;&quot;,
            &quot;title&quot;: &quot;New Tiddler&quot;, // This is the 'title' property *within* the JSON content
            &quot;modified&quot;: timestamp
        };

        // Convert the object to a compact JSON string
        var jsonString = JSON.stringify(newTiddlerContent);

        // *** CRITICAL CHANGE: Set the tiddler's actual title to &quot;New TW5Tiddler&quot; ***
        var newTiddlerTitle = &quot;New TW5Tiddler&quot;;

        // Create the new Tiddler object
        var newTiddler = new Tiddler();
        newTiddler.title = newTiddlerTitle;
        newTiddler.text = jsonString; // Set the JSON string as the tiddler's main text content
        newTiddler.created = now; // Set TiddlyWiki's internal created timestamp
        newTiddler.modified = now; // Set TiddlyWiki's internal modified timestamp
        newTiddler.tags = [&quot;JSON&quot;]; // Optionally add a tag to identify JSON tiddlers

        // Add the new tiddler to the store and display it
        store.addTiddler(newTiddler);
        // Display the newly created tiddler. Use &quot;JsonEditTemplate&quot; if your JSON editor plugin is active.
        story.displayTiddler(null, newTiddlerTitle, &quot;JsonEditTemplate&quot;, true);
        return false; // Prevent default button action
    }
};
//}}}</pre>
</div>
<div title="Pyodide_Example_Fibonacci" creator="YourName" modifier="YourName" created="202507191942" tags="demo RunScriptPlugin" changecount="1">
<pre>def fibonacci_sequence(n):
    &quot;&quot;&quot;
    Generates a Fibonacci sequence up to n terms.

    Args:
        n: The number of terms in the sequence.

    Returns:
        A list containing the Fibonacci sequence.
    &quot;&quot;&quot;
    if n &lt;= 0:
        return []
    elif n == 1:
        return [0]
    else:
        list_fib = [0, 1]
        while len(list_fib) &lt; n:
            next_fib = list_fib[-1] + list_fib[-2]
            list_fib.append(next_fib)
        return list_fib
# Example usage:
num_terms = 10
fib_sequence = fibonacci_sequence(num_terms)
print(f&quot;Fibonacci sequence up to {num_terms} terms: {fib_sequence}&quot;)

num_terms = 5
fib_sequence = fibonacci_sequence(num_terms)
print(f&quot;Fibonacci sequence up to {num_terms} terms: {fib_sequence}&quot;)</pre>
</div>
<div title="RSSReaderFeedrPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191921" modified="202507191946" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name        |RSSReaderFeedrPlugin|
|Description |Read and render RSS feeds using feedr.|
|Source      |https://github.com/wangyenshu/RSSReaderFeedrPlugin/blob/main/RSSReaderFeedrPlugin.js|
|Version     |0.1|
|Author      |Yanshu Wang|
|License     |MIT|
|~CoreVersion|2.x|
|Type        |plugin|
!!!!!Documentation
The first parameter is the feed url, the second parameter is the template for displaying.
By default, it uses the server https://www.feedrapp.info. For selfhosting, see https://feedrapp.info/hosting.
{{{
&lt;&lt;rssReader &quot;http://feeds.feedburner.com/premiumpixels&quot; &quot;&lt;li&gt;&lt;a href='{url}'&gt;[{author}@{date}] {title}&lt;/a&gt;&lt;br/&gt;{teaserImage}{shortBodyPlain}&lt;/li&gt;&quot;&gt;&gt;
}}}
&lt;&lt;rssReader &quot;http://feeds.feedburner.com/premiumpixels&quot; &quot;&lt;li&gt;&lt;a href='{url}'&gt;[{author}@{date}] {title}&lt;/a&gt;&lt;br/&gt;{teaserImage}{shortBodyPlain}&lt;/li&gt;&quot;&gt;&gt;
!!!!!Credit
https://github.com/sdepold/feedrapp
!!!!!Code
***/
//{{{
config.macros.rssReader = {
    dateFormat: &quot;MMM DD, YYYY&quot;,
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Get the feed URL (first parameter) or default.
        var feedURL = params[0] || &quot;http://feeds.feedburner.com/premiumpixels&quot;;
        // Get the entry template (second parameter) or default.
        var entryTemplate = params[1] || &quot;&lt;li&gt;&lt;a href='{url}'&gt;[{author}@{date}] {title}&lt;/a&gt;&lt;br/&gt;{teaserImage}{shortBodyPlain}&lt;/li&gt;&quot;;
        
        // Create a container for the RSS feed.
        var container = document.createElement(&quot;div&quot;);
        container.id = &quot;rssReaderContainer_&quot; + new Date().getTime();
        container.style.margin = &quot;10px&quot;;
        container.style.padding = &quot;10px&quot;;
        container.style.border = &quot;1px solid #ccc&quot;;
        place.appendChild(container);
        
        // Utility: Load a script dynamically.
        function loadScript(src, id, callback) {
            if (!document.getElementById(id)) {
                var script = document.createElement(&quot;script&quot;);
                script.id = id;
                script.src = src;
                script.onload = callback;
                document.head.appendChild(script);
            } else {
                callback();
            }
        }
        
        // Load jQuery 1.6.4, then Moment.js 2.8.4, then jquery.rss plugin.
        loadScript(&quot;https://code.jquery.com/jquery-1.6.4.min.js&quot;, &quot;jquery_1.6.4&quot;, function() {
            loadScript(&quot;https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js&quot;, &quot;moment_2.8.4&quot;, function() {
                loadScript(&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery-rss/4.3.0/jquery.rss.min.js&quot;, &quot;jquery_rss&quot;, function() {
                    // Give jquery.rss a short delay to ensure it has attached.
                    setTimeout(function() {
                        $(container).rss(feedURL, {
                            entryTemplate: entryTemplate,
                            ssl: true,
                            limit: 10,
                            dateFormat: config.macros.rssReader.dateFormat
                        });
                    }, 100);
                });
            });
        });
    }
};
//}}}</pre>
</div>
<div title="RunScriptPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191922" modified="202507191946" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name|RunScriptPlugin|
|Source|https://github.com/wangyenshu/RunScriptPlugin/blob/main/RunScriptPlugin.js|
|Author|Yanshu Wang|
|Version|0.1|
|Type|plugin|
|Description|A TiddlyWiki Classic plugin to run multiple programming language.|
|License|MIT|

!Usage
{{{
&lt;&lt;BrythonScript script:print('Hello world!')&gt;&gt;
&lt;&lt;BrythonScript tid:TiddlerName&gt;&gt;
&lt;&lt;PyodideScript script:print('Hello world!')&gt;&gt;
&lt;&lt;PyodideScript tid:TiddlerName&gt;&gt;
&lt;&lt;runcppscript script:#include &lt;iostream&gt;using namespace std;int main() {    cout &lt;&lt; &quot;Hello, World!&quot; &lt;&lt; endl;    return 0;}&gt;&gt;
&lt;&lt;runcppscript tid:TiddlerName&gt;&gt;
&lt;&lt;runwebrscript script:fit &lt;- lm(mpg ~ am, data=mtcars); summary(fit)&gt;&gt;
&lt;&lt;runwebrscript tid:TiddlerName&gt;&gt;
}}}
Edit pathlib in [[RunScriptPluginConfig]].

!Demo
&lt;&lt;BrythonScript tid:Brython_Example_HelloBrython&gt;&gt;
&lt;&lt;PyodideScript tid:Pyodide_Example_Fibonacci&gt;&gt;
&lt;&lt;runcppscript&gt;&gt;
&lt;&lt;runwebrscript&gt;&gt;
!Todo
Add input method.
Implement a similar plugin for 
- basic https://github.com/google/wwwbasic
- php https://phpjs.hertzen.com/
- tex https://manuels.github.io/texlive.js/
-       p5  p5.js
-       C#
-	SQL	SQL.js	https://sql.js.org/
-	Go	GopherJS	https://github.com/gopherjs/gopherjs
-	Delphi/Object Pascal
-	Visual Basic	
-	Fortran	
-	Scratch	
-	Rust
-	Ruby	Opal	https://opalrb.com/
-	Lua
-	Perl	
-	Haskell
-	OCaml	BuckleScript	https://bucklescript.github.io/
-	Scala	Scala.js	https://www.scala-js.org/
-	Kotlin	Kotlin/JS	https://kotlinlang.org/docs/reference/js-overview.html
-	Swift	SwiftWasm	https://swiftwasm.org/
-	Racket
-	Scheme	BiwaScheme	https://github.com/biwascheme/biwascheme
-	Tcl
-	Erlang
-	Elixir	Nerves	https://nerves-project.org/
-	Clojure	ClojureScript	https://clojurescript.org/
-	F#	Fable	https://fable.io/
-	D	
-	VHDL
-	Verilog	EDA Playground	https://www.edaplayground.com/
-	COBOL
-	ActionScript
-	Ada
-	ALGOL
-	LISP
-	Bash	ShellJS	https://github.com/shelljs/shelljs
-	BCPL
-	Crystal	
-	Forth	
!Credit
https://brython.info
https://pyodide.org
https://docs.r-wasm.org/webr/latest/
https://github.com/felixhao28/JSCPP
***/
//{{{
config.macros.BrythonScript = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script:&quot; and &quot;tid:&quot;.
        var paramsObj = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var defaultScript = &quot;&quot;;
        if (paramsObj.tid &amp;&amp; paramsObj.tid.length) {
            // Load Python code from the specified tiddler.
            defaultScript = store.getTiddlerText(paramsObj.tid[0]) || &quot;&quot;;
        } else if (paramsObj.script &amp;&amp; paramsObj.script.length) {
            defaultScript = paramsObj.script.join(&quot; &quot;);
        } else {
            defaultScript = &quot;Write your Python code here...&quot;;
        }
        
        // Create the container for the Brython Script.
        var container = document.createElement(&quot;div&quot;);
        container.innerHTML = `
            &lt;div id=&quot;brythonScriptContainer&quot;&gt;
                &lt;textarea id=&quot;brythonCodeInput&quot; class=&quot;brythonCodeArea&quot; rows=&quot;10&quot; cols=&quot;60&quot; placeholder=&quot;Write your Python code here...&quot;&gt;${defaultScript}&lt;/textarea&gt;
                &lt;div&gt;&lt;button id=&quot;executeBrythonCode&quot;&gt;Run Code&lt;/button&gt;&lt;/div&gt;
            &lt;/div&gt;
        `;
        place.appendChild(container);
        
        // Dynamically load Brython scripts.
        var brythonScript = document.createElement(&quot;script&quot;);
        brythonScript.src = config.options.txtBrythonjsPath;
        brythonScript.onload = function() {
            var brythonStdlibScript = document.createElement(&quot;script&quot;);
            brythonStdlibScript.src = config.options.txtBrythonStdLibjsPath;
            brythonStdlibScript.onload = function() {
                // Initialize Brython after the standard library is loaded.
                brython({debug: 1});
            };
            document.body.appendChild(brythonStdlibScript);
        };
        document.body.appendChild(brythonScript);
        
        // Once Brython is loaded, set up the event listener on the button.
        brythonScript.onload = function() {
            document.getElementById(&quot;executeBrythonCode&quot;).addEventListener(&quot;click&quot;, function() {
                var pythonCode = document.getElementById(&quot;brythonCodeInput&quot;).value;
                try {
                    if (typeof __BRYTHON__ !== 'undefined') {
                        __BRYTHON__.runPythonSource(pythonCode);
                    } else {
                        alert(&quot;Brython is not ready yet.&quot;);
                    }
                } catch (e) {
                    alert(&quot;Execution error: &quot; + e.message);
                }
            });
        };
    }
};

config.macros.PyodideScript = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script:&quot; and &quot;tid:&quot;
        var p = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var defaultScript = &quot;&quot;;

        if (p.tid &amp;&amp; p.tid.length) {
            // Load Python code from the specified tiddler
            defaultScript = store.getTiddlerText(p.tid[0]) || &quot;&quot;;
        } else if (p.script &amp;&amp; p.script.length) {
            defaultScript = p.script.join(&quot; &quot;);
        }

        // Create the UI container
        const container = document.createElement(&quot;div&quot;);
        container.innerHTML = `
            &lt;div id=&quot;pyodideContainer&quot;&gt;
                &lt;!-- Input Window Box for Python code --&gt;
                &lt;div style=&quot;margin-bottom: 10px;&quot;&gt;
                    &lt;label for=&quot;pythonInput&quot; style=&quot;font-weight: bold;&quot;&gt;Enter Python Code:&lt;/label&gt;&lt;br&gt;
                    &lt;textarea id=&quot;pythonInput&quot; class=&quot;pythonTextarea&quot; rows=&quot;10&quot; cols=&quot;60&quot; placeholder=&quot;Write your Python code here...&quot;&gt;${defaultScript}&lt;/textarea&gt;
                &lt;/div&gt;
                &lt;!-- Button to Run Code --&gt;
                &lt;div&gt;
                    &lt;button id=&quot;runCode&quot;&gt;Run Code&lt;/button&gt;
                &lt;/div&gt;
                &lt;!-- Output Window Box --&gt;
                &lt;div id=&quot;logOutput&quot; style=&quot;white-space: pre-wrap; font-family: monospace; padding: 10px; background-color: #EBEEF1; margin-top: 10px; width: 470px; height: 150px; overflow-y: auto; border: 1px solid black;&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
        `;
        place.appendChild(container);

        // Dynamically load Pyodide script
        const pyodideScript = document.createElement(&quot;script&quot;);
        pyodideScript.src = config.options.txtPyodidejsPath;
        pyodideScript.onload = async function() {
            // Initialize Pyodide when the script has loaded.
            let pyodide = await loadPyodide();

            // Get reference to the log output div
            const logOutputDiv = document.getElementById(&quot;logOutput&quot;);
            let outputLines = [];
            const maxLines = 10;

            // Override Python's built-in input function to prompt the user
            const originalInput = pyodide.pyimport(&quot;builtins&quot;).input;
            pyodide.pyimport(&quot;builtins&quot;).input = function(prompt) {
                const userInput = window.prompt(prompt);
                if (userInput === null) {
                    throw new Error(&quot;User cancelled the prompt.&quot;);
                }
                return userInput;
            };

            // Override the print function in Python to capture output
            const originalPrint = pyodide.pyimport(&quot;builtins&quot;).print;
            pyodide.pyimport(&quot;builtins&quot;).print = function(...args) {
                const output = args.join(&quot; &quot;) + &quot;\n&quot;;
                if (outputLines.length &gt;= maxLines) {
                    outputLines.shift();
                }
                outputLines.push(output);
                logOutputDiv.textContent = outputLines.join('');
            };

            // Evaluate Python code when the &quot;Run Code&quot; button is clicked
            document.getElementById(&quot;runCode&quot;).addEventListener(&quot;click&quot;, async function() {
                const pythonInput = document.getElementById(&quot;pythonInput&quot;).value.trim();
                if (!pythonInput) {
                    alert(&quot;Please enter Python code before running.&quot;);
                    return;
                }
                logOutputDiv.textContent = &quot;&quot;; // Clear previous output
                try {
                    await pyodide.runPythonAsync(pythonInput);
                } catch (e) {
                    logOutputDiv.textContent = &quot;Error: &quot; + e.message;
                }
            });
        };
        document.body.appendChild(pyodideScript);
    }
};

config.macros.runcppscript = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script:&quot; and &quot;tid:&quot;.
        var p = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var scriptContent;
        if (p.tid &amp;&amp; p.tid.length) {
            // Load C++ source from the specified tiddler.
            scriptContent = store.getTiddlerText(p.tid[0]) || &quot;&quot;;
        } else if (p.script &amp;&amp; p.script.length) {
            // Use the provided script parameter.
            scriptContent = p.script.join(&quot; &quot;);
        } else {
            // Default C++ source code.
            scriptContent = &quot;#include &lt;iostream&gt; using namespace std; int main() { cout &lt;&lt; \&quot;Hello, World!\&quot; &lt;&lt; endl; return 0; }&quot;;
        }
        
        // Create the container for the C++ Script.
        const container = document.createElement(&quot;div&quot;);
        container.innerHTML = `
            &lt;h3&gt;Enter your C++ code:&lt;/h3&gt;
            &lt;textarea id=&quot;cppCodeInput&quot; class=&quot;cppCodeArea&quot; rows=&quot;10&quot; cols=&quot;60&quot; placeholder=&quot;Write your C++ code here...&quot;&gt;${scriptContent}&lt;/textarea&gt;
            &lt;div&gt;&lt;button id=&quot;executeCppCode&quot;&gt;Run Code&lt;/button&gt;&lt;/div&gt;
            &lt;div&gt;
                &lt;h3&gt;Output:&lt;/h3&gt;
                &lt;pre id=&quot;cppOutput&quot; class=&quot;cppOutputArea&quot; style=&quot;white-space: pre-wrap; font-family: monospace; padding: 10px; background-color: #EBEEF1; margin-top: 10px; width: 470px; height: 35px; overflow-y: auto; border: 1px solid black;&quot;&gt;&lt;/pre&gt;
            &lt;/div&gt;
        `;
        place.appendChild(container);

        // Dynamically load the JSCPP library.
        const jsCppScript = document.createElement(&quot;script&quot;);
        jsCppScript.src = config.options.txtJSCPPjsPath;
        jsCppScript.onload = function() {
            if (typeof JSCPP !== 'undefined') {
                console.log(&quot;JSCPP library loaded successfully!&quot;);
            } else {
                alert(&quot;Failed to load JSCPP library.&quot;);
            }
        };
        document.body.appendChild(jsCppScript);

        // Set up the button to run the C++ code when clicked.
        document.getElementById(&quot;executeCppCode&quot;).addEventListener(&quot;click&quot;, function() {
            const cppCode = document.getElementById(&quot;cppCodeInput&quot;).value;  // Get the C++ code from the textarea.
            const outputBox = document.getElementById(&quot;cppOutput&quot;);  // Get the output box.

            // Custom configuration for JSCPP.
            const configObj = {
                maxTimeout: 5000,
                debug: false,
                unsigned_overflow: 'warn',
                stdio: {
                    write: function(s) {
                        outputBox.textContent += s;
                    }
                }
            };

            try {
                if (typeof JSCPP !== 'undefined') {
                    // Compile and execute the C++ code.
                    JSCPP.run(cppCode, &quot;&quot;, configObj, function(result) {
                        outputBox.textContent = result;
                    });
                } else {
                    alert(&quot;JSCPP library is not ready yet.&quot;);
                }
            } catch (e) {
                outputBox.textContent = &quot;Execution error: &quot; + e.message;
            }
        });
    }
};

config.macros.runwebrscript = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script:&quot; and &quot;tid:&quot;.
        var p = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var scriptContent = &quot;&quot;;
        if(p.tid &amp;&amp; p.tid.length) {
            // Load R code from the specified tiddler.
            scriptContent = store.getTiddlerText(p.tid[0]) || &quot;&quot;;
        } else if(p.script &amp;&amp; p.script.length) {
            scriptContent = p.script.join(&quot; &quot;);
        } else {
            scriptContent = &quot;fit &lt;- lm(mpg ~ am, data=mtcars); summary(fit)&quot;;
        }
        
        // Create container for the webR interface.
        var container = document.createElement(&quot;div&quot;);
        container.innerHTML = `
            &lt;h3&gt;Enter your R code:&lt;/h3&gt;
            &lt;textarea id=&quot;rCodeInput&quot; rows=&quot;10&quot; cols=&quot;60&quot; placeholder=&quot;Write your R code here...&quot; style=&quot;background-color:#f4f4f4;&quot;&gt;${scriptContent}&lt;/textarea&gt;
            &lt;div&gt;&lt;button id=&quot;runRButton&quot; disabled&gt;Loading webR...&lt;/button&gt;&lt;/div&gt;
            &lt;div&gt;
                &lt;h3&gt;Output:&lt;/h3&gt;
                &lt;pre id=&quot;rOutput&quot; style=&quot;white-space: pre-wrap; font-family: monospace; padding:10px; background-color:#EBEEF1; border:1px solid black; width:470px; height:150px; overflow-y:auto;&quot;&gt;&lt;/pre&gt;
            &lt;/div&gt;
            &lt;canvas id=&quot;rCanvas&quot; width=&quot;1008&quot; height=&quot;1008&quot; style=&quot;display:none; margin:auto; width:700px;&quot;&gt;&lt;/canvas&gt;
        `;
        place.appendChild(container);
        
        // Dynamically load webR from its CDN (or local path if configured)
        var webrPath = config.options.txtwebrjsPath || &quot;https://webr.r-wasm.org/latest/webr.mjs&quot;;
        var scriptEl = document.createElement(&quot;script&quot;);
        scriptEl.type = &quot;module&quot;;
        scriptEl.innerHTML = `
            import { WebR } from &quot;${webrPath}&quot;;
            // Initialize webR and expose it globally.
            const webR = new WebR();
            await webR.init();
            // Set the device to use the canvas for graphics.
            await webR.evalRVoid('options(device=webr::canvas)');
            // Create a shelter to capture output.
            const shelter = await new webR.Shelter();
            // Enable the Run button.
            document.getElementById(&quot;runRButton&quot;).disabled = false;
            document.getElementById(&quot;runRButton&quot;).innerText = &quot;Run Code&quot;;
            
            // Function to run R code.
            async function runRCode() {
                document.getElementById(&quot;rCanvas&quot;).style.display = &quot;none&quot;;
                const code = document.getElementById(&quot;rCodeInput&quot;).value;
                const result = await shelter.captureR(code, {
                    withAutoprint: true,
                    captureStreams: true,
                    captureConditions: false
                });
                try {
                    const out = result.output.filter(evt =&gt; evt.type === 'stdout' || evt.type === 'stderr')
                                              .map(evt =&gt; evt.data)
                                              .join('\\n');
                    document.getElementById(&quot;rOutput&quot;).innerText = out;
                } finally {
                    shelter.purge();
                }
            }
            document.getElementById(&quot;runRButton&quot;).addEventListener(&quot;click&quot;, runRCode);
            
            // Async loop to handle canvas events (optional)
            (async () =&gt; {
                for (;;) {
                    const output = await webR.read();
                    if (output.type === 'canvas') {
                        const canvas = document.getElementById('rCanvas');
                        if (output.data.event === 'canvasNewPage') {
                            canvas.style.display = 'block';
                            canvas.getContext('2d').clearRect(0, 0, 1008, 1008);
                        }
                        if (output.data.event === 'canvasImage') {
                            canvas.getContext('2d').drawImage(output.data.image, 0, 0);
                        }
                    }
                }
            })();
        `;
        document.body.appendChild(scriptEl);
    }
};
//}}}

</pre>
</div>
<div title="RunScriptPluginConfig" creator="YourName" modifier="YourName" created="202507191941" tags="settings systemConfig" changecount="1">
<pre>//{{{
config.options.txtBrythonjsPath=&quot;https://cdn.jsdelivr.net/npm/brython@3/brython.min.js&quot;;
config.options.txtBrythonStdLibjsPath=&quot;https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js&quot;;
config.options.txtPyodidejsPath=&quot;https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js&quot;;
config.options.txtwebrjsPath=&quot;https://webr.r-wasm.org/latest/webr.mjs&quot;;
config.options.txtJSCPPjsPath=&quot;https://cdn.jsdelivr.net/gh/felixhao28/JSCPP@gh-pages/dist/JSCPP.es5.min.js&quot;;
//}}}</pre>
</div>
<div title="ShowBackStageTweak" creator="YourName" modifier="YourName" created="202507200247" tags="systemConfig" changecount="1">
<pre>//{{{
var originalShowBackstage = showBackstage;
showBackstage = true; 
//}}}</pre>
</div>
<div title="SiteTitle" creator="Yanshu Wang" modifier="Yanshu Wang" created="202507191917" changecount="1">
<pre>YS_Extension</pre>
</div>
<div title="SwiftLatexPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191922" modified="202507191947" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name|SwiftLatexPlugin|
|Source|https://github.com/wangyenshu/SwiftLatexPlugin/blob/main/SwiftLatexPlugin.js|
|Author|Yanshu Wang|
|Version|0.1|
|Type|plugin|
|Description|A TiddlyWiki Classic plugin to compile latex using swiftlatex.|
|License|MIT|

!Usage
Put the js and wasm files downloaded from https://github.com/SwiftLaTeX/SwiftLaTeX/releases in the root folder.
{{{
&lt;&lt;PdfTeX script:\documentclass{article}\begin{document}\section{Hello, World!}\end{document}&gt;&gt;
&lt;&lt;PdfTeX tid:Document&gt;&gt;
&lt;&lt;XeTeX script:\documentclass{article}\begin{document}\section{Hello, XeTeX!}\end{document}&gt;&gt;
&lt;&lt;XeTeX tid:Document&gt;&gt;
}}}
Notice that due to restrictions of ace editor, you can only use use one of these two macros. For example, once you have used PdfTex macro, running another macro will still use PdfTex Engine.
!Demo
&lt;&lt;PdfTeX&gt;&gt;
!Todo
- Support multiple ace editor and using PdfTeX and XeTeX in the same page.
- Support custom image path and bibtex path
- Support input of multiple lines

!Credit
https://www.swiftlatex.com/
***/
//{{{
config.macros.PdfTeX = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script&quot; and &quot;tid&quot;
        var p = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var scriptContent;
        if (p.tid &amp;&amp; p.tid.length) {
            // Load LaTeX source from the specified tiddler.
            scriptContent = store.getTiddlerText(p.tid[0]) || &quot;&quot;;
        } else if (p.script &amp;&amp; p.script.length) {
            scriptContent = p.script.join(&quot; &quot;);
        } else {
            scriptContent = &quot;\\documentclass{article}\n\\begin{document}\n\\section{Hello, World!}\nHello, PdfTeX!\n\\end{document}&quot;;
        }
            
        // Create the UI container with unique IDs.
        var container = document.createElement(&quot;div&quot;);
        container.innerHTML = &quot;&quot;
          + &quot;&lt;div id='pdftex_container' style='margin:10px; padding:10px; border:1px solid #ccc;'&gt;&quot;
          + &quot;  &lt;h3&gt;PdfTeX Editor&lt;/h3&gt;&quot;
          + &quot;  &lt;div id='pdftex_editor' style='width:100%; height:400px; background-color:#272822;'&gt;&quot; + scriptContent + &quot;&lt;/div&gt;&quot;
          + &quot;  &lt;br&gt;&lt;button id='pdftex_compilebtn' disabled&gt;Initializing&lt;/button&gt;&quot;
          + &quot;  &lt;br&gt;&lt;h4&gt;Engine Log:&lt;/h4&gt;&quot;
          + &quot;  &lt;pre id='pdftex_log' style='white-space: pre-wrap; font-family: monospace; padding:10px; background-color:#EBEEF1; border:1px solid #ccc; width:80%; height:150px; overflow-y:auto;'&gt;&lt;/pre&gt;&quot;
          + &quot;  &lt;br&gt;&lt;div id='pdftex_pdfbox'&gt;&lt;/div&gt;&quot;
          + &quot;&lt;/div&gt;&quot;;
        place.appendChild(container);
            
        // Load Ace Editor from CDN if not already loaded.
        if (!document.getElementById(&quot;ace_script&quot;)) {
            var aceScript = document.createElement(&quot;script&quot;);
            aceScript.id = &quot;ace_script&quot;;
            aceScript.src = &quot;https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js&quot;;
            document.head.appendChild(aceScript);
        }
            
        // Load PdfTeXEngine.js if not already loaded.
        if (!document.getElementById(&quot;pdflatex_script&quot;)) {
            var pdfScript = document.createElement(&quot;script&quot;);
            pdfScript.id = &quot;pdflatex_script&quot;;
            pdfScript.src = &quot;PdfTeXEngine.js&quot;; // Adjust path as needed.
            document.body.appendChild(pdfScript);
        }
            
        // Utility: wait until a condition is met.
        function waitFor(conditionFunc, callback, interval) {
            interval = interval || 100;
            if (conditionFunc()) {
                callback();
            } else {
                setTimeout(function(){ waitFor(conditionFunc, callback, interval); }, interval);
            }
        }
            
        // Wait for both Ace and PdfTeXEngine to be loaded.
        waitFor(function(){ 
            return (typeof ace !== &quot;undefined&quot;) &amp;&amp; 
                   (typeof PdfTeXEngine !== &quot;undefined&quot;); 
        }, initEngine);
            
        function initEngine(){
            // Initialize Ace Editor on the &quot;pdftex_editor&quot; element.
            var editor = ace.edit(&quot;pdftex_editor&quot;);
            editor.setTheme(&quot;ace/theme/monokai&quot;);
            editor.session.setMode(&quot;ace/mode/latex&quot;);
            editor.session.setUseWrapMode(true);
            editor.setFontSize(18);
                
            var pdftexCompileBtn = document.getElementById(&quot;pdftex_compilebtn&quot;);
            var pdftexLog = document.getElementById(&quot;pdftex_log&quot;);
            var pdftexPdfBox = document.getElementById(&quot;pdftex_pdfbox&quot;);
                
            // Create an instance of PdfTeXEngine.
            var engine = new PdfTeXEngine();
                
            async function init() {
                await engine.loadEngine();
                pdftexCompileBtn.innerHTML = &quot;Compile&quot;;
                pdftexCompileBtn.disabled = false;
            }
            
            async function compile() {
                if(!engine.isReady()){
                    console.log(&quot;Engine not ready yet&quot;);
                    return;
                }
                pdftexCompileBtn.disabled = true;
                pdftexCompileBtn.innerHTML = &quot;Compiling...&quot;;

                /*    
                try {
                    // Optionally, fetch an image asset.
                    let downloadReq = await fetch(&quot;assets/troll.jpg&quot;);
                    let imageBlob = await downloadReq.arrayBuffer();
                    engine.writeMemFSFile(&quot;troll.jpg&quot;, new Uint8Array(imageBlob));
                } catch(e) {
                    console.warn(&quot;Could not load image: &quot;, e);
                }
                */
                    
                engine.writeMemFSFile(&quot;main.tex&quot;, editor.getValue());
                engine.setEngineMainFile(&quot;main.tex&quot;);
                    
                let r = await engine.compileLaTeX();
                pdftexLog.innerHTML = r.log;
                pdftexCompileBtn.innerHTML = &quot;Compile&quot;;
                pdftexCompileBtn.disabled = false;
                if (r.status === 0) {
                    const pdfblob = new Blob([r.pdf], { type: &quot;application/pdf&quot; });
                    const objectURL = URL.createObjectURL(pdfblob);
                    pdftexPdfBox.innerHTML = `&lt;embed src=&quot;${objectURL}&quot; width=&quot;100%&quot; height=&quot;400px&quot; type=&quot;application/pdf&quot;&gt;`;
                    setTimeout(function(){ URL.revokeObjectURL(objectURL); }, 30000);
                }
            }
            
            pdftexCompileBtn.addEventListener(&quot;click&quot;, compile);
            init();
        }
    }
};

config.macros.XeTeX = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;script:&quot; and &quot;tid:&quot;.
        // If &quot;tid:&quot; is provided, load content from that tiddler.
        var p = paramString.parseParams(&quot;script tid&quot;, null, true)[0] || {};
        var scriptContent;
        if(p.tid &amp;&amp; p.tid.length) {
            scriptContent = store.getTiddlerText(p.tid[0]) || &quot;&quot;;
        } else if(p.script &amp;&amp; p.script.length) {
            scriptContent = p.script.join(&quot; &quot;);
        } else {
            scriptContent = &quot;%% Sample XeTeX document\n\\documentclass{article}\n\\begin{document}\nHello, XeTeX!\n\\end{document}&quot;;
        }
            
        // Create the UI container with unique IDs.
        var container = document.createElement(&quot;div&quot;);
        container.innerHTML = &quot;&quot;
          + &quot;&lt;div id='xetex_container' style='margin:10px; padding:10px; border:1px solid #ccc;'&gt;&quot;
          + &quot;  &lt;h3&gt;XeTeX Editor&lt;/h3&gt;&quot;
          + &quot;  &lt;div id='xetex_editor' style='width:100%; height:400px; background-color:#272822; color:#F8F8F2;'&gt;&quot;
          + scriptContent + &quot;&lt;/div&gt;&quot;
          + &quot;  &lt;br&gt;&lt;button id='xetex_compilebtn' disabled&gt;Initializing&lt;/button&gt;&quot;
          + &quot;  &lt;br&gt;&lt;h4&gt;Engine Log:&lt;/h4&gt;&quot;
          + &quot;  &lt;pre id='xetex_console' style='white-space: pre-wrap; font-family: monospace; padding:10px; background-color:#EBEEF1; border:1px solid #ccc; width:80%; height:150px; overflow-y:auto;'&gt;&lt;/pre&gt;&quot;
          + &quot;  &lt;br&gt;&lt;div id='xetex_pdfbox'&gt;&lt;/div&gt;&quot;
          + &quot;&lt;/div&gt;&quot;;
        place.appendChild(container);
            
        // Load Ace Editor from CDN if not already loaded.
        if (!document.getElementById(&quot;ace_script&quot;)) {
            var aceScript = document.createElement(&quot;script&quot;);
            aceScript.id = &quot;ace_script&quot;;
            aceScript.src = &quot;https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js&quot;;
            document.head.appendChild(aceScript);
        }
            
        // Load XeTeXEngine.js if not already loaded.
        if (!document.getElementById(&quot;xetex_engine_script&quot;)) {
            var xetexScript = document.createElement(&quot;script&quot;);
            xetexScript.id = &quot;xetex_engine_script&quot;;
            xetexScript.src = &quot;XeTeXEngine.js&quot;; // Adjust path as needed.
            document.body.appendChild(xetexScript);
        }
        // Load DvipdfmxEngine.js if not already loaded.
        if (!document.getElementById(&quot;dvipdfmx_script&quot;)) {
            var dvipdfmxScript = document.createElement(&quot;script&quot;);
            dvipdfmxScript.id = &quot;dvipdfmx_script&quot;;
            dvipdfmxScript.src = &quot;DvipdfmxEngine.js&quot;; // Adjust path as needed.
            document.body.appendChild(dvipdfmxScript);
        }
            
        // Utility: wait until a condition is met.
        function waitFor(conditionFunc, callback, interval) {
            interval = interval || 100;
            if (conditionFunc()) {
                callback();
            } else {
                setTimeout(function(){ waitFor(conditionFunc, callback, interval); }, interval);
            }
        }
            
        // Wait for Ace and both XeTeX engines to be loaded.
        waitFor(function(){ 
            return (typeof ace !== &quot;undefined&quot;) &amp;&amp; 
                   (typeof XeTeXEngine !== &quot;undefined&quot;) &amp;&amp; 
                   (typeof DvipdfmxEngine !== &quot;undefined&quot;); 
        }, initEngine);
            
        function initEngine(){
            // Initialize Ace Editor on the &quot;xetex_editor&quot; element.
            var editor = ace.edit(&quot;xetex_editor&quot;);
            editor.setTheme(&quot;ace/theme/monokai&quot;);
            editor.session.setMode(&quot;ace/mode/latex&quot;);
            editor.session.setUseWrapMode(true);
            editor.setFontSize(18);
                
            var xetexCompileBtn = document.getElementById(&quot;xetex_compilebtn&quot;);
            var xetexConsole = document.getElementById(&quot;xetex_console&quot;);
            var xetexPdfBox = document.getElementById(&quot;xetex_pdfbox&quot;);
                
            // Create engine instances.
            var xetexEn = new XeTeXEngine();
            var dvipdfmxEn = new DvipdfmxEngine();
                
            async function init() {
                await xetexEn.loadEngine();
                await dvipdfmxEn.loadEngine();
                xetexCompileBtn.innerHTML = &quot;Compile&quot;;
                xetexCompileBtn.disabled = false;
            }
            
            async function compile() {
                if (!xetexEn.isReady() || !dvipdfmxEn.isReady()) {
                    console.log(&quot;Engine not ready yet&quot;);
                    return;
                }
                xetexCompileBtn.disabled = true;
                xetexCompileBtn.innerHTML = &quot;Compiling...&quot;;
                    
                let imageDownloadReq, imageBlob, bibDownloadReq, bibBlob;
                /*
                try {
                    imageDownloadReq = await fetch('assets/troll.jpg');
                    imageBlob = await imageDownloadReq.arrayBuffer();
                    bibDownloadReq = await fetch('assets/sample-base.bib');
                    bibBlob = await bibDownloadReq.arrayBuffer();
                    xetexEn.writeMemFSFile(&quot;troll.jpg&quot;, new Uint8Array(imageBlob));
                    xetexEn.writeMemFSFile(&quot;sample-base.bib&quot;, new Uint8Array(bibBlob));
                } catch(e) {
                    console.warn(&quot;Asset download failed: &quot;, e);
                }
                */    
                xetexEn.writeMemFSFile(&quot;main.tex&quot;, editor.getValue());
                xetexEn.setEngineMainFile(&quot;main.tex&quot;);
                    
                let r = await xetexEn.compileLaTeX();
                xetexConsole.innerHTML = r.log;
                xetexCompileBtn.innerHTML = &quot;Compile&quot;;
                xetexCompileBtn.disabled = false;
                    
                if (r.status === 0) {
                    dvipdfmxEn.writeMemFSFile(&quot;main.xdv&quot;, r.pdf);
                    dvipdfmxEn.setEngineMainFile(&quot;main.xdv&quot;);
                    // Re-upload image if needed.
                    // dvipdfmxEn.writeMemFSFile(&quot;troll.jpg&quot;, new Uint8Array(imageBlob));
                    let r1 = await dvipdfmxEn.compilePDF();
                    const pdfblob = new Blob([r1.pdf], { type: &quot;application/pdf&quot; });
                    const objectURL = URL.createObjectURL(pdfblob);
                    xetexPdfBox.innerHTML = `&lt;embed src=&quot;${objectURL}&quot; width=&quot;100%&quot; height=&quot;400px&quot; type=&quot;application/pdf&quot;&gt;`;
                    setTimeout(function(){ URL.revokeObjectURL(objectURL); }, 30000);
                }
            }
            
            xetexCompileBtn.addEventListener(&quot;click&quot;, compile);
            init();
        }
    }
};
//}}}

</pre>
</div>
<div title="TW5Sandbox" creator="YourName" modifier="YourName" created="202507191939" modified="202507200245" tags="innerTW5Plugin TW5Sandbox" changecount="2">
<pre>
&lt;!doctype html&gt;
&lt;!-- The following comment is called a MOTW comment and is necessary for the TiddlyIE Internet Explorer extension --&gt;
&lt;!-- saved from url=(0021)https://tiddlywiki.com --&gt;
&lt;html lang=&quot;en-GB&quot;&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=utf-8&quot; /&gt;
&lt;!--~~ Raw markup for the top of the head section ~~--&gt;

&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=Edge&quot;/&gt;
&lt;meta name=&quot;application-name&quot; content=&quot;TiddlyWiki&quot; /&gt;
&lt;meta name=&quot;generator&quot; content=&quot;TiddlyWiki&quot; /&gt;
&lt;meta name=&quot;tiddlywiki-version&quot; content=&quot;5.3.7&quot; /&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
&lt;meta name=&quot;apple-mobile-web-app-capable&quot; content=&quot;yes&quot; /&gt;
&lt;meta name=&quot;apple-mobile-web-app-status-bar-style&quot; content=&quot;black-translucent&quot; /&gt;
&lt;meta name=&quot;mobile-web-app-capable&quot; content=&quot;yes&quot;/&gt;
&lt;meta name=&quot;format-detection&quot; content=&quot;telephone=no&quot; /&gt;
&lt;meta name=&quot;copyright&quot; content=&quot;TiddlyWiki created by Jeremy Ruston, (jeremy [at] jermolene [dot] com)

Copyright (c) 2004-2007, Jeremy Ruston
Copyright (c) 2007-2025, UnaMesa Association
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

* Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

* Neither the name of the copyright holder nor the names of its
  contributors may be used to endorse or promote products derived from
  this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS'
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&quot; /&gt;
&lt;link id=&quot;faviconLink&quot; rel=&quot;shortcut icon&quot; href=&quot;favicon.ico&quot;&gt;
&lt;title&gt;My TiddlyWiki — a non-linear personal web notebook&lt;/title&gt;
&lt;!--~~ This is a Tiddlywiki file. The points of interest in the file are marked with this pattern ~~--&gt;

&lt;!--~~ Raw markup ~~--&gt;



&lt;/head&gt;
&lt;body class=&quot;tc-body&quot;&gt;
&lt;!--~~ Raw markup for the top of the body section ~~--&gt;

&lt;!--~~ Static styles ~~--&gt;
&lt;div id=&quot;styleArea&quot;&gt;
&lt;style data-tiddler-title=&quot;$:/boot/boot.css&quot; data-tiddler-type=&quot;text/css&quot; type=&quot;text/css&quot;&gt;/*
Basic styles used before we boot up the parsing engine
*/

/*
Error message and password prompt
*/

.tc-error-form {
	font-family: sans-serif;
	color: #fff;
	z-index: 20000;
	position: fixed;
	background-color: rgb(255, 75, 75);
	border: 8px solid rgb(255, 0, 0);
	border-radius: 8px;
	width: 50%;
	margin-left: 25%;
	margin-top: 4em;
	padding: 0 2em 1em 2em;
}

.tc-error-form h1 {
	text-align: center;
}

.tc-error-prompt {
	text-align: center;
	color: #000;
}

.tc-error-message {
	overflow: auto;
	max-height: 40em;
	padding-right: 1em;
	margin: 1em 0;
	white-space: pre-line;
}

.tc-password-wrapper {
    font-family: sans-serif;
	z-index: 20000;
	position: fixed;
	text-align: center;
	width: 200px;
	top: 4em;
	left: 50%;
	margin-left: -144px; /* - width/2 - paddingHorz/2 - border */
	padding: 16px 16px 16px 16px;
	border-radius: 8px;
}

.tc-password-wrapper {
	color: #000;
	text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
	background-color: rgb(197, 235, 183);
	border: 8px solid rgb(164, 197, 152);
}

.tc-password-wrapper form {
	text-align: left;
}

.tc-password-wrapper h1 {
	font-size: 16px;
	line-height: 20px;
	padding-bottom: 16px;
}

.tc-password-wrapper input {
	width: 100%;
}
&lt;/style&gt;
&lt;/div&gt;
&lt;!--~~ Static content for Google and browsers without JavaScript ~~--&gt;
&lt;noscript&gt;
&lt;div id=&quot;splashArea&quot;&gt;


&lt;p&gt;This &lt;a class=&quot;tc-tiddlylink-external&quot; href=&quot;https://tiddlywiki.com&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_blank&quot;&gt;TiddlyWiki&lt;/a&gt; contains the following tiddlers:&lt;/p&gt;&lt;p&gt;&lt;ul&gt;

&lt;li&gt;$:/config/SaveWikiButton/Template&lt;/li&gt;

&lt;li&gt;$:/DefaultTiddlers&lt;/li&gt;

&lt;li&gt;$:/isEncrypted&lt;/li&gt;

&lt;li&gt;$:/state/http-requests&lt;/li&gt;

&lt;li&gt;$:/status/RequireReloadDueToPluginChange&lt;/li&gt;

&lt;li&gt;$:/StoryList&lt;/li&gt;

&lt;li&gt;$:/themes/tiddlywiki/snowwhite&lt;/li&gt;

&lt;li&gt;$:/themes/tiddlywiki/vanilla&lt;/li&gt;

&lt;/ul&gt;
&lt;/p&gt;



&lt;style&gt;
.tc-remove-when-wiki-loaded {display: none;}
&lt;/style&gt;

&lt;/div&gt;
&lt;/noscript&gt;
&lt;!--~~ Ordinary tiddlers ~~--&gt;
&lt;script class=&quot;tiddlywiki-tiddler-store&quot; type=&quot;application/json&quot;&gt;[
{&quot;title&quot;:&quot;$:/config/SaveWikiButton/Template&quot;,&quot;text&quot;:&quot;$:/core/save/offline-external-js&quot;},
{&quot;created&quot;:&quot;20250720024232227&quot;,&quot;title&quot;:&quot;$:/DefaultTiddlers&quot;,&quot;text&quot;:&quot;TW5Sandbox\n&quot;,&quot;modified&quot;:&quot;20250720024304382&quot;},
{&quot;title&quot;:&quot;$:/isEncrypted&quot;,&quot;text&quot;:&quot;no&quot;},
{&quot;title&quot;:&quot;$:/state/http-requests&quot;,&quot;text&quot;:&quot;0&quot;},
{&quot;title&quot;:&quot;$:/status/RequireReloadDueToPluginChange&quot;,&quot;text&quot;:&quot;no&quot;},
{&quot;title&quot;:&quot;$:/StoryList&quot;,&quot;created&quot;:&quot;20250720024032010&quot;,&quot;text&quot;:&quot;&quot;,&quot;list&quot;:&quot;$:/AdvancedSearch GettingStarted&quot;,&quot;modified&quot;:&quot;20250720024051400&quot;},
{&quot;title&quot;:&quot;$:/themes/tiddlywiki/snowwhite&quot;,&quot;name&quot;:&quot;Snow White&quot;,&quot;author&quot;:&quot;JeremyRuston&quot;,&quot;core-version&quot;:&quot;&gt;=5.0.0&quot;,&quot;plugin-type&quot;:&quot;theme&quot;,&quot;description&quot;:&quot;Emphasises individual tiddlers&quot;,&quot;dependents&quot;:&quot;$:/themes/tiddlywiki/vanilla&quot;,&quot;plugin-priority&quot;:&quot;0&quot;,&quot;version&quot;:&quot;5.3.7&quot;,&quot;type&quot;:&quot;application/json&quot;,&quot;text&quot;:&quot;{\&quot;tiddlers\&quot;:{\&quot;$:/themes/tiddlywiki/snowwhite/base\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/snowwhite/base\&quot;,\&quot;tags\&quot;:\&quot;[[$:/tags/Stylesheet]]\&quot;,\&quot;text\&quot;:\&quot;\\\\define sidebarbreakpoint-minus-one()\\n\u003C$text text={{{ [{$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint}removesuffix[px]subtract[1]addsuffix[px]] ~[{$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint}] }}}/&gt;\\n\\\\end\\n\\n\\\\rules only filteredtranscludeinline transcludeinline macrodef macrocallinline\\n\\n.tc-sidebar-header {\\n\\ttext-shadow: 0 1px 0 \u003C\u003Ccolour sidebar-foreground-shadow&gt;&gt;;\\n}\\n\\n.tc-tiddler-info {\\n\\t\u003C\u003Cbox-shadow \\\&quot;inset 1px 2px 3px rgba(0,0,0,0.1)\\\&quot;&gt;&gt;\\n}\\n\\n@media screen {\\n\\t.tc-tiddler-frame {\\n\\t\\t\u003C\u003Cbox-shadow \\\&quot;1px 1px 5px rgba(0, 0, 0, 0.3)\\\&quot;&gt;&gt;\\n\\t}\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\t.tc-tiddler-frame {\\n\\t\\t\u003C\u003Cbox-shadow none&gt;&gt;\\n\\t}\\n}\\n\\n.tc-page-controls button svg, .tc-tiddler-controls button svg, .tc-topbar button svg {\\n\\t\u003C\u003Ctransition \\\&quot;fill 150ms ease-in-out\\\&quot;&gt;&gt;\\n}\\n\\n.tc-tiddler-controls button.tc-selected,\\n.tc-page-controls button.tc-selected {\\n\\t\u003C\u003Cfilter \\\&quot;drop-shadow(0px -1px 2px rgba(0,0,0,0.25))\\\&quot;&gt;&gt;\\n}\\n\\n.tc-tiddler-frame input.tc-edit-texteditor,\\n.tc-tiddler-frame select.tc-edit-texteditor {\\n\\t\u003C\u003Cbox-shadow \\\&quot;inset 0 1px 8px rgba(0, 0, 0, 0.15)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-edit-tags {\\n\\t\u003C\u003Cbox-shadow \\\&quot;inset 0 1px 8px rgba(0, 0, 0, 0.15)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-tiddler-frame .tc-edit-tags input.tc-edit-texteditor {\\n\\t\u003C\u003Cbox-shadow \\\&quot;none\\\&quot;&gt;&gt;\\n\\tborder: none;\\n\\toutline: none;\\n}\\n\\ntextarea.tc-edit-texteditor {\\n\\tfont-family: {{$:/themes/tiddlywiki/vanilla/settings/editorfontfamily}};\\n}\\n\\ncanvas.tc-edit-bitmapeditor  {\\n\\t\u003C\u003Cbox-shadow \\\&quot;2px 2px 5px rgba(0, 0, 0, 0.5)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-drop-down {\\n\\tborder-radius: 4px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;2px 2px 10px rgba(0, 0, 0, 0.5)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-block-dropdown {\\n\\tborder-radius: 4px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;2px 2px 10px rgba(0, 0, 0, 0.5)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-modal {\\n\\tborder-radius: 6px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;0 3px 7px rgba(0,0,0,0.3)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-modal-footer {\\n\\tborder-radius: 0 0 6px 6px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;inset 0 1px 0 #fff\\\&quot;&gt;&gt;;\\n}\\n\\n\\n.tc-alert {\\n\\tborder-radius: 6px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;0 3px 7px rgba(0,0,0,0.6)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-notification {\\n\\tborder-radius: 6px;\\n\\t\u003C\u003Cbox-shadow \\\&quot;0 3px 7px rgba(0,0,0,0.3)\\\&quot;&gt;&gt;\\n\\ttext-shadow: 0 1px 0 rgba(255,255,255, 0.8);\\n}\\n\\n.tc-sidebar-lists .tc-tab-set .tc-tab-divider {\\n\\tborder-top: none;\\n\\theight: 1px;\\n\\t\u003C\u003Cbackground-linear-gradient \\\&quot;left, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.0) 100%\\\&quot;&gt;&gt;\\n}\\n\\n.tc-more-sidebar &gt; .tc-tab-set &gt; .tc-tab-buttons &gt; button {\\n\\t\u003C\u003Cbackground-linear-gradient \\\&quot;left, rgba(0,0,0,0.01) 0%, rgba(0,0,0,0.1) 100%\\\&quot;&gt;&gt;\\n}\\n\\n.tc-more-sidebar &gt; .tc-tab-set &gt; .tc-tab-buttons &gt; button.tc-tab-selected {\\n\\t\u003C\u003Cbackground-linear-gradient \\\&quot;left, rgba(0,0,0,0.05) 0%, rgba(255,255,255,0.05) 100%\\\&quot;&gt;&gt;\\n}\\n\\n.tc-message-box img {\\n\\t\u003C\u003Cbox-shadow \\\&quot;1px 1px 3px rgba(0,0,0,0.5)\\\&quot;&gt;&gt;\\n}\\n\\n.tc-plugin-info {\\n\\t\u003C\u003Cbox-shadow \\\&quot;1px 1px 3px rgba(0,0,0,0.5)\\\&quot;&gt;&gt;\\n}\\n\&quot;}}}&quot;},
{&quot;title&quot;:&quot;$:/themes/tiddlywiki/vanilla&quot;,&quot;name&quot;:&quot;Vanilla&quot;,&quot;author&quot;:&quot;JeremyRuston&quot;,&quot;core-version&quot;:&quot;&gt;=5.0.0&quot;,&quot;plugin-type&quot;:&quot;theme&quot;,&quot;description&quot;:&quot;Basic theme&quot;,&quot;plugin-priority&quot;:&quot;0&quot;,&quot;version&quot;:&quot;5.3.7&quot;,&quot;dependents&quot;:&quot;&quot;,&quot;type&quot;:&quot;application/json&quot;,&quot;text&quot;:&quot;{\&quot;tiddlers\&quot;:{\&quot;$:/themes/tiddlywiki/vanilla/themetweaks\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/themetweaks\&quot;,\&quot;tags\&quot;:\&quot;$:/tags/ControlPanel/Appearance\&quot;,\&quot;caption\&quot;:\&quot;{{$:/language/ThemeTweaks/ThemeTweaks}}\&quot;,\&quot;text\&quot;:\&quot;\\\\define lingo-base() $:/language/ThemeTweaks/\\n\\n\\\\define replacement-text()\\n[img[$(imageTitle)$]]\\n\\\\end\\n\\n\\\\define backgroundimage-dropdown()\\n\u003Cdiv class=\\\&quot;tc-drop-down-wrapper\\\&quot;&gt;\\n\u003C$set name=\\\&quot;state\\\&quot; value=\u003C\u003Cqualify \\\&quot;$:/state/popup/themetweaks/backgroundimage\\\&quot;&gt;&gt;&gt;\\n\u003C$button popup=\u003C\u003Cstate&gt;&gt; class=\\\&quot;tc-btn-invisible tc-btn-dropdown\\\&quot;&gt;{{$:/core/images/down-arrow}}\u003C/$button&gt;\\n\u003C$reveal state=\u003C\u003Cstate&gt;&gt; type=\\\&quot;popup\\\&quot; position=\\\&quot;belowleft\\\&quot; text=\\\&quot;\\\&quot; default=\\\&quot;\\\&quot; class=\\\&quot;tc-popup-keep\\\&quot;&gt;\\n\u003Cdiv class=\\\&quot;tc-drop-down\\\&quot; style=\\\&quot;text-align:center;\\\&quot;&gt;\\n\u003C$macrocall $name=\\\&quot;image-picker\\\&quot; actions=\\\&quot;\\\&quot;\\\&quot;\\n\\n\u003C$action-setfield\\n\\t$tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimage\\\&quot;\\n\\t$value=\u003C\u003CimageTitle&gt;&gt;\\n/&gt;\\n\\n\u003C$action-deletetiddler $tiddler=\u003C\u003Cstate&gt;&gt;/&gt;\\n\\n\\\&quot;\\\&quot;\\\&quot;/&gt;\\n\u003C/div&gt;\\n\u003C/$reveal&gt;\\n\u003C/$set&gt;\\n\u003C/div&gt;\\n\\\\end\\n\\n\\\\define backgroundimageattachment-dropdown()\\n\u003C$select tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimageattachment\\\&quot; default=\\\&quot;scroll\\\&quot;&gt;\\n\u003Coption value=\\\&quot;scroll\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageAttachment/Scroll&gt;&gt;\u003C/option&gt;\\n\u003Coption value=\\\&quot;fixed\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageAttachment/Fixed&gt;&gt;\u003C/option&gt;\\n\u003C/$select&gt;\\n\\\\end\\n\\n\\\\define backgroundimagesize-dropdown()\\n\u003C$select tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize\\\&quot; default=\\\&quot;scroll\\\&quot;&gt;\\n\u003Coption value=\\\&quot;auto\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageSize/Auto&gt;&gt;\u003C/option&gt;\\n\u003Coption value=\\\&quot;cover\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageSize/Cover&gt;&gt;\u003C/option&gt;\\n\u003Coption value=\\\&quot;contain\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageSize/Contain&gt;&gt;\u003C/option&gt;\\n\u003C/$select&gt;\\n\\\\end\\n\\n\u003C\u003Clingo ThemeTweaks/Hint&gt;&gt;\\n\\n! \u003C\u003Clingo Options&gt;&gt;\\n\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/options/sidebarlayout\\\&quot;&gt;\u003C\u003Clingo Options/SidebarLayout&gt;&gt;\u003C/$link&gt; |\u003C$select tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/options/sidebarlayout\\\&quot;&gt;\u003Coption value=\\\&quot;fixed-fluid\\\&quot;&gt;\u003C\u003Clingo Options/SidebarLayout/Fixed-Fluid&gt;&gt;\u003C/option&gt;\u003Coption value=\\\&quot;fluid-fixed\\\&quot;&gt;\u003C\u003Clingo Options/SidebarLayout/Fluid-Fixed&gt;&gt;\u003C/option&gt;\u003C/$select&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/options/stickytitles\\\&quot;&gt;\u003C\u003Clingo Options/StickyTitles&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Options/StickyTitles/Hint&gt;&gt;// |\u003C$select tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/options/stickytitles\\\&quot;&gt;\u003Coption value=\\\&quot;no\\\&quot;&gt;{{$:/language/No}}\u003C/option&gt;\u003Coption value=\\\&quot;yes\\\&quot;&gt;{{$:/language/Yes}}\u003C/option&gt;\u003C/$select&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/options/codewrapping\\\&quot;&gt;\u003C\u003Clingo Options/CodeWrapping&gt;&gt;\u003C/$link&gt; |\u003C$select tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/options/codewrapping\\\&quot;&gt;\u003Coption value=\\\&quot;pre\\\&quot;&gt;{{$:/language/No}}\u003C/option&gt;\u003Coption value=\\\&quot;pre-wrap\\\&quot;&gt;{{$:/language/Yes}}\u003C/option&gt;\u003C/$select&gt; |\\n\\n! \u003C\u003Clingo Settings&gt;&gt;\\n\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/fontfamily\\\&quot;&gt;\u003C\u003Clingo Settings/FontFamily&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/fontfamily\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; | |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/codefontfamily\\\&quot;&gt;\u003C\u003Clingo Settings/CodeFontFamily&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/codefontfamily\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; | |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/editorfontfamily\\\&quot;&gt;\u003C\u003Clingo Settings/EditorFontFamily&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/editorfontfamily\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; | |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimage\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImage&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimage\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\u003C\u003Cbackgroundimage-dropdown&gt;&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimageattachment\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageAttachment&gt;&gt;\u003C/$link&gt; |\u003C\u003Cbackgroundimageattachment-dropdown&gt;&gt; | |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize\\\&quot;&gt;\u003C\u003Clingo Settings/BackgroundImageSize&gt;&gt;\u003C/$link&gt; |\u003C\u003Cbackgroundimagesize-dropdown&gt;&gt; | |\\n\\n! \u003C\u003Clingo Metrics&gt;&gt;\\n\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/fontsize\\\&quot;&gt;\u003C\u003Clingo Metrics/FontSize&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/fontsize\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/lineheight\\\&quot;&gt;\u003C\u003Clingo Metrics/LineHeight&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/lineheight\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodyfontsize\\\&quot;&gt;\u003C\u003Clingo Metrics/BodyFontSize&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodyfontsize\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodylineheight\\\&quot;&gt;\u003C\u003Clingo Metrics/BodyLineHeight&gt;&gt;\u003C/$link&gt; |\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodylineheight\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyleft\\\&quot;&gt;\u003C\u003Clingo Metrics/StoryLeft&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/StoryLeft/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyleft\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storytop\\\&quot;&gt;\u003C\u003Clingo Metrics/StoryTop&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/StoryTop/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storytop\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyright\\\&quot;&gt;\u003C\u003Clingo Metrics/StoryRight&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/StoryRight/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyright\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storywidth\\\&quot;&gt;\u003C\u003Clingo Metrics/StoryWidth&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/StoryWidth/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/storywidth\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/tiddlerwidth\\\&quot;&gt;\u003C\u003Clingo Metrics/TiddlerWidth&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/TiddlerWidth/Hint&gt;&gt;//\u003Cbr&gt; |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/tiddlerwidth\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint\\\&quot;&gt;\u003C\u003Clingo Metrics/SidebarBreakpoint&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/SidebarBreakpoint/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n|\u003C$link to=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth\\\&quot;&gt;\u003C\u003Clingo Metrics/SidebarWidth&gt;&gt;\u003C/$link&gt;\u003Cbr&gt;//\u003C\u003Clingo Metrics/SidebarWidth/Hint&gt;&gt;// |^\u003C$edit-text tiddler=\\\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth\\\&quot; default=\\\&quot;\\\&quot; tag=\\\&quot;input\\\&quot;/&gt; |\\n\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/base\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/base\&quot;,\&quot;tags\&quot;:\&quot;[[$:/tags/Stylesheet]]\&quot;,\&quot;list-before\&quot;:\&quot;\&quot;,\&quot;code-body\&quot;:\&quot;yes\&quot;,\&quot;text\&quot;:\&quot;\\\\define custom-background-datauri()\\n\u003C$set name=\\\&quot;background\\\&quot; value={{$:/themes/tiddlywiki/vanilla/settings/backgroundimage}}&gt;\\n\u003C$list filter=\\\&quot;[\u003Cbackground&gt;is[image]]\\\&quot;&gt;\\n`background: url(`\\n\u003C$list filter=\\\&quot;[\u003Cbackground&gt;!has[_canonical_uri]]\\\&quot;&gt;\\n`\\\&quot;`\u003C$macrocall $name=\\\&quot;datauri\\\&quot; title={{$:/themes/tiddlywiki/vanilla/settings/backgroundimage}}/&gt;`\\\&quot;`\\n\u003C/$list&gt;\\n\u003C$list filter=\\\&quot;[\u003Cbackground&gt;has[_canonical_uri]]\\\&quot;&gt;\\n`\\\&quot;`\u003C$view tiddler={{$:/themes/tiddlywiki/vanilla/settings/backgroundimage}} field=\\\&quot;_canonical_uri\\\&quot;/&gt;`\\\&quot;`\\n\u003C/$list&gt;\\n`) center center;`\\n`background-attachment: `{{$:/themes/tiddlywiki/vanilla/settings/backgroundimageattachment}}`;\\n-webkit-background-size:` {{$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize}}`;\\n-moz-background-size:` {{$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize}}`;\\n-o-background-size:` {{$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize}}`;\\nbackground-size:` {{$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize}}`;`\\n\u003C/$list&gt;\\n\u003C/$set&gt;\\n\\\\end\\n\\n\\\\define sidebarbreakpoint()\\n\u003C$text text={{$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint}}/&gt;\\n\\\\end\\n\\n\\\\define sidebarbreakpoint-minus-one()\\n\u003C$text text={{{ [{$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint}removesuffix[px]subtract[1]addsuffix[px]] ~[{$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint}] }}}/&gt;\\n\\\\end\\n\\n\\\\define if-fluid-fixed(text,hiddenSidebarText)\\n\u003C$reveal state=\\\&quot;$:/themes/tiddlywiki/vanilla/options/sidebarlayout\\\&quot; type=\\\&quot;match\\\&quot; text=\\\&quot;fluid-fixed\\\&quot;&gt;\\n$text$\\n\u003C$reveal state=\\\&quot;$:/state/sidebar\\\&quot; type=\\\&quot;nomatch\\\&quot; text=\\\&quot;yes\\\&quot; default=\\\&quot;yes\\\&quot;&gt;\\n$hiddenSidebarText$\\n\u003C/$reveal&gt;\\n\u003C/$reveal&gt;\\n\\\\end\\n\\n\\\\define if-editor-height-fixed(then,else)\\n\u003C$reveal state=\\\&quot;$:/config/TextEditor/EditorHeight/Mode\\\&quot; type=\\\&quot;match\\\&quot; text=\\\&quot;fixed\\\&quot;&gt;\\n$then$\\n\u003C/$reveal&gt;\\n\u003C$reveal state=\\\&quot;$:/config/TextEditor/EditorHeight/Mode\\\&quot; type=\\\&quot;match\\\&quot; text=\\\&quot;auto\\\&quot;&gt;\\n$else$\\n\u003C/$reveal&gt;\\n\\\\end\\n\\n\\\\define set-type-selector-min-width()\\n\u003C$set name=\\\&quot;typeLength\\\&quot; value={{{ [all[shadows+tiddlers]prefix[$:/language/Docs/Types/]get[name]length[]maxall[]] }}}&gt;\\n\\n\\t.tc-type-selector-dropdown-wrapper {\\n\\t\\tmin-width: calc(\u003C\u003CtypeLength&gt;&gt;ch + 4em);\\n\\t}\\n\\n\\t.tc-type-selector-dropdown-wrapper input.tc-edit-typeeditor {\\n\\t\\tmin-width: \u003C\u003CtypeLength&gt;&gt;ch;\\n\\t}\\n\\n\u003C/$set&gt;\\n\\\\end\\n\\n\\\\rules only filteredtranscludeinline transcludeinline macrodef macrocallinline macrocallblock\\n\\n/*\\n** Start with the normalize CSS reset, and then belay some of its effects\\n*/\\n\\n{{$:/themes/tiddlywiki/vanilla/reset}}\\n\\ninput[type=\\\&quot;search\\\&quot;] {\\n\\toutline-offset: initial;\\n}\\n\\nbutton:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible {\\n\\toutline: 2px solid \u003C\u003Ccolour primary&gt;&gt;;\\n\\toutline-offset: -2px;\\n\\tborder-radius: 0.25em;\\n}\\n\\nbutton:-moz-focusring, input:-moz-focusring, textarea:-moz-focusring, select:-moz-focusring {\\n\\toutline: 2px solid \u003C\u003Ccolour primary&gt;&gt;;\\n\\toutline-offset: -2px;\\n\\tborder-radius: 0.25em;\\n}\\n\\n/*\\n** Button default styles. Makes them look consistent for all browsers\\n*/\\nhtml button {\\n\\tline-height: 1.2;\\n\\tcolor: \u003C\u003Ccolour button-foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour button-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour button-background&gt;&gt;;\\n\\tborder-color: \u003C\u003Ccolour button-border&gt;&gt;;\\n\\tcursor: pointer;\\n}\\n\\nbutton:disabled {\\n\\tcursor: default;\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\nbutton:disabled svg {\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n/*\\n** Basic element styles\\n*/\\n\\nhtml, body {\\n\\tfont-family: {{$:/themes/tiddlywiki/vanilla/settings/fontfamily}};\\n\\ttext-rendering: optimizeLegibility; /* Enables kerning and ligatures etc. */\\n\\t-webkit-font-smoothing: antialiased;\\n\\t-moz-osx-font-smoothing: grayscale;\\n}\\n\\nhtml:-webkit-full-screen {\\n\\tbackground-color: \u003C\u003Ccolour page-background&gt;&gt;;\\n}\\n\\nbody.tc-body {\\n\\tfont-size: {{$:/themes/tiddlywiki/vanilla/metrics/fontsize}};\\n\\tline-height: {{$:/themes/tiddlywiki/vanilla/metrics/lineheight}};\\n\\tword-wrap: break-word;\\n\\t\u003C\u003Ccustom-background-datauri&gt;&gt;\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour page-background&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n\u003C\u003Cif-background-attachment \\\&quot;\\\&quot;\\\&quot;\\n\\nbody.tc-body {\\n\\tbackground-color: transparent;\\n}\\n\\n\\\&quot;\\\&quot;\\\&quot;&gt;&gt;\\n\\n/**\\n * Correct the font size and margin on `h1` elements within `section` and\\n * `article` contexts in Chrome, Firefox, and Safari.\\n */\\n\\nh1 {\\n\\tfont-size: 2em;\\n}\\n\\nh1, h2, h3, h4, h5, h6 {\\n\\tline-height: 1.2;\\n\\tfont-weight: normal;\\n}\\n\\npre {\\n\\tdisplay: block;\\n\\tmargin-top: 1em;\\n\\tmargin-bottom: 1em;\\n\\tword-break: normal;\\n\\tword-wrap: break-word;\\n\\twhite-space: {{$:/themes/tiddlywiki/vanilla/options/codewrapping}};\\n\\tbackground-color: \u003C\u003Ccolour pre-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour pre-border&gt;&gt;;\\n\\tpadding: 0 3px 2px;\\n\\tborder-radius: 3px;\\n\\tfont-family: {{$:/themes/tiddlywiki/vanilla/settings/codefontfamily}};\\n}\\n\\ncode {\\n\\tcolor: \u003C\u003Ccolour code-foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour code-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour code-border&gt;&gt;;\\n\\twhite-space: pre-wrap;\\n\\tpadding: 0 3px 2px;\\n\\tborder-radius: 3px;\\n\\tfont-family: {{$:/themes/tiddlywiki/vanilla/settings/codefontfamily}};\\n}\\n\\nblockquote {\\n\\tborder-left: 5px solid \u003C\u003Ccolour blockquote-bar&gt;&gt;;\\n\\tmargin-left: 25px;\\n\\tpadding-left: 10px;\\n\\tquotes: \\\&quot;\\\\201C\\\&quot;\\\&quot;\\\\201D\\\&quot;\\\&quot;\\\\2018\\\&quot;\\\&quot;\\\\2019\\\&quot;;\\n}\\n\\nblockquote &gt; div {\\n\\tmargin-top: 1em;\\n\\tmargin-bottom: 1em;\\n}\\n\\nblockquote.tc-big-quote {\\n\\tfont-family: Georgia, serif;\\n\\tposition: relative;\\n\\tbackground: \u003C\u003Ccolour pre-background&gt;&gt;;\\n\\tborder-left: none;\\n\\tmargin-left: 50px;\\n\\tmargin-right: 50px;\\n\\tpadding: 10px;\\n\\tborder-radius: 8px;\\n}\\n\\nblockquote.tc-big-quote cite:before {\\n\\tcontent: \\\&quot;\\\\2014 \\\\2009\\\&quot;;\\n}\\n\\nblockquote.tc-big-quote:before {\\n\\tfont-family: Georgia, serif;\\n\\tcolor: \u003C\u003Ccolour blockquote-bar&gt;&gt;;\\n\\tcontent: open-quote;\\n\\tfont-size: 8em;\\n\\tline-height: 0.1em;\\n\\tmargin-right: 0.25em;\\n\\tvertical-align: -0.4em;\\n\\tposition: absolute;\\n\\tleft: -50px;\\n\\ttop: 42px;\\n}\\n\\nblockquote.tc-big-quote:after {\\n\\tfont-family: Georgia, serif;\\n\\tcolor: \u003C\u003Ccolour blockquote-bar&gt;&gt;;\\n\\tcontent: close-quote;\\n\\tfont-size: 8em;\\n\\tline-height: 0.1em;\\n\\tmargin-right: 0.25em;\\n\\tvertical-align: -0.4em;\\n\\tposition: absolute;\\n\\tright: -80px;\\n\\tbottom: -20px;\\n}\\n\\ndl dt {\\n\\tfont-weight: bold;\\n\\tmargin-top: 6px;\\n}\\n\\ntextarea,\\ninput[type=text],\\ninput[type=search],\\ninput[type=number],\\ninput[type=password],\\ninput[type=email],\\ninput[type=tel],\\ninput[type=url],\\ninput[type=\\\&quot;\\\&quot;],\\ninput:not([type]) {\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\ninput[type=\\\&quot;checkbox\\\&quot;] {\\n\\tvertical-align: middle;\\n}\\n\\ninput[type=\\\&quot;search\\\&quot;]::-webkit-search-decoration,\\ninput[type=\\\&quot;search\\\&quot;]::-webkit-search-cancel-button,\\ninput[type=\\\&quot;search\\\&quot;]::-webkit-search-results-button,\\ninput[type=\\\&quot;search\\\&quot;]::-webkit-search-results-decoration {\\n\\t-webkit-appearance:none;\\n}\\n\\n.tc-muted {\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\nsvg.tc-image-button {\\n\\tpadding: 0px 1px 1px 0px;\\n}\\n\\n.tc-icon-wrapper &gt; svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n}\\n\\nkbd {\\n\\tdisplay: inline-block;\\n\\tpadding: 3px 5px;\\n\\tfont-size: 0.8em;\\n\\tline-height: 1.2;\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tvertical-align: middle;\\n\\tbackground-color: \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder: solid 1px \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-bottom-color: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-radius: 3px;\\n\\tbox-shadow: inset 0 -1px 0 \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n::selection {\\n\\tbackground-color: Highlight;\\n\\tcolor: HighlightText;\\n\\tbackground-color: \u003C\u003Ccolour selection-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour selection-foreground&gt;&gt;;\\n}\\n\\n.tc-inline-style {\\n\\tbackground: \u003C\u003Ccolour highlight-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour highlight-foreground&gt;&gt;;\\n}\\n\\n/* Markdown uses mark element to highlight */\\n\\nmark {\\n\\tbackground: \u003C\u003Ccolour highlight-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour highlight-foreground&gt;&gt;;\\n}\\n\\nform.tc-form-inline {\\n\\tdisplay: inline;\\n}\\n\\n/*\\nMarkdown likes putting code elements inside pre elements\\n*/\\npre &gt; code {\\n\\tdisplay: block;\\n\\tpadding: 0.5em;\\n\\tborder: none;\\n\\twhite-space: {{$:/themes/tiddlywiki/vanilla/options/codewrapping}};\\n\\tbackground-color: inherit;\\n\\tcolor: inherit;\\n\\toverflow-x: auto;\\n}\\n\\n/*\\nTable defaults\\n*/\\n\\ntable {\\n\\tborder: 1px solid \u003C\u003Ccolour table-border&gt;&gt;;\\n\\twidth: auto;\\n\\tmax-width: 100%;\\n\\tcaption-side: bottom;\\n\\tmargin-top: 1em;\\n\\tmargin-bottom: 1em;\\n\\t/* next 2 elements needed, since normalize 8.0.1 */\\n\\tborder-collapse: collapse;\\n\\tborder-spacing: 0;\\n}\\n\\ntable th, table td {\\n\\tpadding: 0 7px 0 7px;\\n\\tborder-top: 1px solid \u003C\u003Ccolour table-border&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour table-border&gt;&gt;;\\n}\\n\\ntable thead tr td, table th {\\n\\tbackground-color: \u003C\u003Ccolour table-header-background&gt;&gt;;\\n\\tfont-weight: bold;\\n}\\n\\ntable tfoot tr td {\\n\\tbackground-color: \u003C\u003Ccolour table-footer-background&gt;&gt;;\\n}\\n\\n/*\\nTable utility classes\\n*/\\n\\n/* Remove borders from table as used in eg: GettingStarted*/\\n.tc-table-no-border,\\n.tc-table-no-border th,\\n.tc-table-no-border td {\\n\\tborder: initial;\\n}\\n\\n/* First column in table width will fit to text.*/\\n/* This rule makes most sense with tc-first-link-nowrap*/\\n.tc-first-col-min-width td:nth-child(1) {\\n\\twidth: 1%;\\n}\\n\\n/*\\n** Utility classes work well with tables but also for other containers\\n*/\\n\\n/* First link A element will not wrap */\\n.tc-first-link-nowrap:first-of-type a {\\n\\twhite-space: nowrap;\\n}\\n\\n/* Move the table to the center of the container */\\n.tc-center {\\n\\tmargin-left: auto;\\n\\tmargin-right: auto;\\n}\\n\\n.tc-max-width {\\n\\twidth: 100%;\\n}\\n\\n.tc-max-width-80 {\\n\\tmax-width: 80%;\\n}\\n\\n/* Allow input and textarea to look like the ControlPanel inputs */\\n.tc-edit-max-width input,\\n.tc-edit-max-width textarea {\\n\\twidth: 100%;\\n\\tpadding: 3px;\\n}\\n\\n/*\\nCSV parser plugin\\n*/\\n\\n.tc-csv-table {\\n\\twhite-space: nowrap;\\n}\\n\\n.tc-csv-table th,\\n.tc-csv-table td {\\n\\twhite-space: pre-line;\\n}\\n\\n/*\\nTiddler frame in story river\\n*/\\n\\n.tc-tiddler-frame img,\\n.tc-tiddler-frame svg,\\n.tc-tiddler-frame canvas,\\n.tc-tiddler-frame embed,\\n.tc-tiddler-frame iframe {\\n\\tmax-width: 100%;\\n}\\n\\n.tc-tiddler-body &gt; embed,\\n.tc-tiddler-body &gt; iframe {\\n\\twidth: 100%;\\n\\theight: 600px;\\n}\\n\\n:root {\\n\\tcolor-scheme: {{{ [{$:/palette}get[color-scheme]] ~light }}};\\n}\\n\\n/*\\n** Links\\n*/\\n\\nbutton.tc-tiddlylink,\\na.tc-tiddlylink {\\n\\ttext-decoration: none;\\n\\tfont-weight: 500;\\n\\tcolor: \u003C\u003Ccolour tiddler-link-foreground&gt;&gt;;\\n\\t-webkit-user-select: inherit; /* Otherwise the draggable attribute makes links impossible to select */\\n\\t-webkit-touch-callout: none; /* Prevents long presses from bringing up a link preview */\\n}\\n\\n.tc-sidebar-lists a.tc-tiddlylink {\\n\\tcolor: \u003C\u003Ccolour sidebar-tiddler-link-foreground&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists a.tc-tiddlylink:hover {\\n\\tcolor: \u003C\u003Ccolour sidebar-tiddler-link-foreground-hover&gt;&gt;;\\n}\\n\\nbutton.tc-tiddlylink:hover,\\na.tc-tiddlylink:hover {\\n\\ttext-decoration: underline;\\n}\\n\\na.tc-tiddlylink-resolves {\\n}\\n\\na.tc-tiddlylink-shadow {\\n\\tfont-weight: bold;\\n}\\n\\na.tc-tiddlylink-shadow.tc-tiddlylink-resolves {\\n\\tfont-weight: normal;\\n}\\n\\na.tc-tiddlylink-missing {\\n\\tfont-style: italic;\\n}\\n\\na.tc-tiddlylink-external {\\n\\ttext-decoration: underline;\\n\\tcolor: \u003C\u003Ccolour external-link-foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour external-link-background&gt;&gt;;\\n}\\n\\na.tc-tiddlylink-external:visited {\\n\\tcolor: \u003C\u003Ccolour external-link-foreground-visited&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour external-link-background-visited&gt;&gt;;\\n}\\n\\na.tc-tiddlylink-external:hover {\\n\\tcolor: \u003C\u003Ccolour external-link-foreground-hover&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour external-link-background-hover&gt;&gt;;\\n}\\n\\n.tc-drop-down a.tc-tiddlylink:hover {\\n\\tcolor: \u003C\u003Ccolour tiddler-link-background&gt;&gt;;\\n}\\n\\n/*\\n** Drag and drop styles\\n*/\\n\\n.tc-tiddler-dragger {\\n\\tposition: relative;\\n\\tz-index: -10000;\\n}\\n\\n.tc-tiddler-dragger-inner {\\n\\tposition: absolute;\\n\\ttop: -1000px;\\n\\tleft: -1000px;\\n\\tdisplay: inline-block;\\n\\tpadding: 8px 20px;\\n\\tfont-size: 16.9px;\\n\\tfont-weight: bold;\\n\\tline-height: 20px;\\n\\tcolor: \u003C\u003Ccolour dragger-foreground&gt;&gt;;\\n\\ttext-shadow: 0 1px 0 rgba(0, 0, 0, 1);\\n\\twhite-space: nowrap;\\n\\tvertical-align: baseline;\\n\\tbackground-color: \u003C\u003Ccolour dragger-background&gt;&gt;;\\n\\tborder-radius: 20px;\\n}\\n\\n.tc-tiddler-dragger-cover {\\n\\tposition: absolute;\\n\\tbackground-color: \u003C\u003Ccolour page-background&gt;&gt;;\\n}\\n\\n.tc-page-container &gt; .tc-dropzone {\\n\\tmin-height: 100vh;\\n}\\n\\n.tc-dropzone {\\n\\tposition: relative;\\n}\\n\\n.tc-dropzone.tc-dragover:before {\\n\\tz-index: 10000;\\n\\tdisplay: block;\\n\\tposition: fixed;\\n\\ttop: 0;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tbackground: \u003C\u003Ccolour dropzone-background&gt;&gt;;\\n\\ttext-align: center;\\n\\tcontent: \\\&quot;\u003C\u003Clingo DropMessage&gt;&gt;\\\&quot;;\\n}\\n\\n.tc-droppable &gt; .tc-droppable-placeholder {\\n\\tdisplay: none;\\n}\\n\\n.tc-droppable.tc-dragover &gt; .tc-droppable-placeholder {\\n\\tdisplay: block;\\n\\tborder: 2px dashed \u003C\u003Ccolour dropzone-background&gt;&gt;;\\n}\\n\\n.tc-draggable {\\n\\tcursor: move;\\n}\\n\\n.tc-sidebar-tab-open .tc-droppable-placeholder, .tc-tagged-draggable-list .tc-droppable-placeholder,\\n.tc-links-draggable-list .tc-droppable-placeholder {\\n\\tline-height: 2em;\\n\\theight: 2em;\\n}\\n\\n.tc-sidebar-tab-open-item {\\n\\tposition: relative;\\n}\\n\\n.tc-sidebar-tab-open .tc-btn-invisible.tc-btn-mini svg {\\n\\tfont-size: 0.7em;\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n/*\\n** Plugin reload warning\\n*/\\n\\n.tc-plugin-reload-warning {\\n\\tz-index: 1000;\\n\\tdisplay: block;\\n\\tposition: fixed;\\n\\ttop: 0;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tbackground: \u003C\u003Ccolour alert-background&gt;&gt;;\\n\\ttext-align: center;\\n}\\n\\n/*\\n** Buttons\\n*/\\n\\nbutton svg, button img, label svg, label img {\\n\\tvertical-align: middle;\\n}\\n\\n.tc-btn-invisible {\\n\\tpadding: 0;\\n\\tmargin: 0;\\n\\tbackground: none;\\n\\tborder: none;\\n\\tcursor: pointer;\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\nbutton:disabled.tc-btn-invisible  {\\n\\tcursor: default;\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-btn-boxed {\\n\\tfont-size: 0.6em;\\n\\tpadding: 0.2em;\\n\\tmargin: 1px;\\n\\tbackground: none;\\n\\tborder: 1px solid \u003C\u003Ccolour tiddler-controls-foreground&gt;&gt;;\\n\\tborder-radius: 0.25em;\\n}\\n\\nhtml body.tc-body .tc-btn-boxed svg {\\n\\tfont-size: 1.6666em;\\n}\\n\\n.tc-btn-boxed:hover {\\n\\tbackground: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\nhtml body.tc-body .tc-btn-boxed:hover svg {\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-btn-rounded {\\n\\tfont-size: 0.5em;\\n\\tline-height: 2;\\n\\tpadding: 0em 0.3em 0.2em 0.4em;\\n\\tmargin: 1px;\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder-radius: 2em;\\n}\\n\\nhtml body.tc-body .tc-btn-rounded svg {\\n\\tfont-size: 1.6666em;\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-btn-rounded:hover {\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\nhtml body.tc-body .tc-btn-rounded:hover svg {\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-btn-icon svg {\\n\\theight: 1em;\\n\\twidth: 1em;\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n\\n.tc-btn-text {\\n\\tmargin-left: 7px;\\n}\\n\\n/* used for documentation \\\&quot;fake\\\&quot; buttons */\\n.tc-btn-standard {\\n\\tline-height: 1.8;\\n\\tcolor: #667;\\n\\tbackground-color: #e0e0e0;\\n\\tborder: 1px solid #888;\\n\\tpadding: 2px 1px 2px 1px;\\n\\tmargin: 1px 4px 1px 4px;\\n}\\n\\n.tc-btn-big-green {\\n\\tdisplay: inline-block;\\n\\tpadding: 8px;\\n\\tmargin: 4px 8px 4px 8px;\\n\\tbackground: \u003C\u003Ccolour download-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour download-foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour download-foreground&gt;&gt;;\\n\\tborder: none;\\n\\tborder-radius: 2px;\\n\\tfont-size: 1.2em;\\n\\tline-height: 1.4em;\\n\\ttext-decoration: none;\\n}\\n\\n.tc-btn-big-green svg,\\n.tc-btn-big-green img {\\n\\theight: 2em;\\n\\twidth: 2em;\\n\\tvertical-align: middle;\\n\\tfill: \u003C\u003Ccolour download-foreground&gt;&gt;;\\n}\\n\\n.tc-primary-btn {\\n\\tbackground: \u003C\u003Ccolour primary&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists input {\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists button {\\n\\tcolor: \u003C\u003Ccolour sidebar-button-foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour sidebar-button-foreground&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists button.tc-btn-mini {\\n\\tcolor: \u003C\u003Ccolour sidebar-muted-foreground&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists button.tc-btn-mini:hover {\\n\\tcolor: \u003C\u003Ccolour sidebar-muted-foreground-hover&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists button small {\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\nbutton svg.tc-image-button, button .tc-image-button img {\\n\\theight: 1em;\\n\\twidth: 1em;\\n}\\n\\n.tc-unfold-banner {\\n\\tposition: absolute;\\n\\tpadding: 0;\\n\\tmargin: 0;\\n\\tbackground: none;\\n\\tborder: none;\\n\\twidth: 100%;\\n\\twidth: calc(100% + 2px);\\n\\tmargin-left: -43px;\\n\\ttext-align: center;\\n\\tborder-top: 2px solid \u003C\u003Ccolour tiddler-info-background&gt;&gt;;\\n\\tmargin-top: 4px;\\n}\\n\\n.tc-unfold-banner:hover {\\n\\tbackground: \u003C\u003Ccolour tiddler-info-background&gt;&gt;;\\n\\tborder-top: 2px solid \u003C\u003Ccolour tiddler-info-border&gt;&gt;;\\n}\\n\\n.tc-unfold-banner svg, .tc-fold-banner svg {\\n\\theight: 0.75em;\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground&gt;&gt;;\\n}\\n\\n.tc-unfold-banner:hover svg, .tc-fold-banner:hover svg {\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground-hover&gt;&gt;;\\n}\\n\\n.tc-fold-banner {\\n\\tposition: absolute;\\n\\tpadding: 0;\\n\\tmargin: 0;\\n\\tbackground: none;\\n\\tborder: none;\\n\\twidth: 23px;\\n\\ttext-align: center;\\n\\tmargin-left: -35px;\\n\\ttop: 6px;\\n\\tbottom: 6px;\\n}\\n\\n.tc-fold-banner:hover {\\n\\tbackground: \u003C\u003Ccolour tiddler-info-background&gt;&gt;;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\n\\t.tc-unfold-banner {\\n\\t\\tposition: static;\\n\\t\\twidth: calc(100% + 59px);\\n\\t}\\n\\n\\t.tc-fold-banner {\\n\\t\\twidth: 16px;\\n\\t\\tmargin-left: -16px;\\n\\t\\tfont-size: 0.75em;\\n\\t}\\n\\n}\\n\\n/*\\n** Tags and missing tiddlers\\n*/\\n\\n.tc-tag-list-item {\\n\\tposition: relative;\\n\\tdisplay: inline-block;\\n}\\n\\n.tc-tags-wrapper {\\n\\tmargin: 4px 0 14px 0;\\n}\\n\\n.tc-tags-wrapper .tc-tag-list-item {\\n\\tmargin-right: 7px;\\n}\\n\\n.tc-missing-tiddler-label {\\n\\tfont-style: italic;\\n\\tfont-weight: normal;\\n\\tdisplay: inline-block;\\n\\tfont-size: 11.844px;\\n\\tline-height: 14px;\\n\\twhite-space: nowrap;\\n\\tvertical-align: baseline;\\n}\\n\\n.tc-block-tags-dropdown &gt; .tc-btn-invisible:hover {\\n\\tbackground-color: \u003C\u003Ccolour primary&gt;&gt;;\\n}\\n\\nbutton.tc-tag-label, span.tc-tag-label {\\n\\tdisplay: inline-block;\\n\\tpadding: 0.16em 0.7em;\\n\\tfont-size: 0.9em;\\n\\tfont-weight: normal;\\n\\tline-height: 1.2em;\\n\\tcolor: \u003C\u003Ccolour tag-foreground&gt;&gt;;\\n\\twhite-space: break-spaces;\\n\\tvertical-align: baseline;\\n\\tbackground-color: \u003C\u003Ccolour tag-background&gt;&gt;;\\n\\tborder-radius: 1em;\\n}\\n\\n.tc-sidebar-scrollable .tc-tag-label {\\n\\ttext-shadow: none;\\n}\\n\\n.tc-untagged-separator {\\n\\tborder: 0;\\n\\theight: 1px;\\n\\tbackground: \u003C\u003Ccolour tab-divider&gt;&gt;;\\n}\\n\\nbutton.tc-untagged-label {\\n\\tbackground-color: \u003C\u003Ccolour untagged-background&gt;&gt;;\\n}\\n\\n.tc-tag-label svg, .tc-tag-label img {\\n\\theight: 1em;\\n\\twidth: 1em;\\n\\tmargin-right: 3px;\\n\\tmargin-bottom: 1px;\\n\\tvertical-align: bottom;\\n}\\n\\n.tc-edit-tags button.tc-remove-tag-button svg {\\n\\tfont-size: 0.7em;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-tag-manager-table .tc-tag-label {\\n}\\n\\n.tc-tag-manager-tag {\\n\\twidth: 100%;\\n}\\n\\nbutton.tc-btn-invisible.tc-remove-tag-button {\\n\\toutline: none;\\n}\\n\\n.tc-tag-button-selected,\\n.tc-list-item-selected a.tc-tiddlylink, a.tc-list-item-selected {\\n\\tbackground-color: \u003C\u003Ccolour primary&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour tiddler-background&gt;&gt;;\\n}\\n\\n/*\\n** Page layout\\n*/\\n\\n.tc-topbar {\\n\\tposition: fixed;\\n\\tz-index: 1200;\\n}\\n\\n.tc-topbar-left {\\n\\tleft: 29px;\\n\\ttop: 5px;\\n}\\n\\n.tc-topbar-right {\\n\\ttop: 5px;\\n\\tright: 29px;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\n\\t.tc-topbar-right {\\n\\t\\tright: 10px;\\n\\t}\\n\\n}\\n\\n.tc-topbar button {\\n\\tpadding: 8px;\\n}\\n\\n.tc-topbar svg {\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-topbar button:hover svg {\\n\\tfill: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\n\\t.tc-show-sidebar-btn svg.tc-image-chevron-left, .tc-hide-sidebar-btn svg.tc-image-chevron-right {\\n\\t\\ttransform: rotate(-90deg);\\n\\t}\\n\\n}\\n\\n.tc-sidebar-header {\\n\\tcolor: \u003C\u003Ccolour sidebar-foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour sidebar-foreground&gt;&gt;;\\n}\\n\\n.tc-sidebar-header .tc-title a.tc-tiddlylink-resolves {\\n\\tfont-weight: normal;\\n}\\n\\n.tc-sidebar-header .tc-sidebar-lists p,\\n.tc-sidebar-tools-item {\\n\\tmargin-top: 3px;\\n\\tmargin-bottom: 3px;\\n}\\n\\n.tc-sidebar-header .tc-missing-tiddler-label {\\n\\tcolor: \u003C\u003Ccolour sidebar-foreground&gt;&gt;;\\n}\\n\\n.tc-advanced-search input {\\n\\twidth: 60%;\\n}\\n\\n.tc-search a svg {\\n\\twidth: 1.2em;\\n\\theight: 1.2em;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-page-controls {\\n\\tmargin-top: 14px;\\n\\tmargin-bottom: 14px;\\n\\tfont-size: 1.5em;\\n}\\n\\n.tc-page-controls .tc-drop-down {\\n\\tfont-size: 1rem;\\n}\\n\\n.tc-page-controls button {\\n\\tmargin-right: 0.5em;\\n}\\n\\n.tc-page-controls a.tc-tiddlylink:hover {\\n\\ttext-decoration: none;\\n}\\n\\n.tc-page-controls img {\\n\\twidth: 1em;\\n}\\n\\n.tc-page-controls svg {\\n\\tfill: \u003C\u003Ccolour sidebar-controls-foreground&gt;&gt;;\\n}\\n\\n.tc-page-controls button:hover svg, .tc-page-controls a:hover svg {\\n\\tfill: \u003C\u003Ccolour sidebar-controls-foreground-hover&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists .tc-menu-list-item {\\n\\twhite-space: nowrap;\\n}\\n\\n.tc-menu-list-count {\\n\\tfont-weight: bold;\\n}\\n\\n.tc-menu-list-subitem {\\n\\tpadding-left: 7px;\\n}\\n\\n.tc-story-river {\\n\\tposition: relative;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\n\\t.tc-sidebar-header {\\n\\t\\tpadding: 14px;\\n\\t\\tmin-height: 32px;\\n\\t\\tmargin-top: {{$:/themes/tiddlywiki/vanilla/metrics/storytop}};\\n\\t\\ttransition:  min-height {{$:/config/AnimationDuration}}ms ease-in-out, padding-top {{$:/config/AnimationDuration}}ms ease-in-out, padding-bottom {{$:/config/AnimationDuration}}ms ease-in-out;\\n\\t}\\n\\n\\t\u003C\u003Cif-no-sidebar \\\&quot;\\\&quot;\\\&quot;\\n\\n\\t\\t.tc-sidebar-header {\\n\\t\\t\\tmin-height: 0;\\n\\t\\t\\tpadding-top: 0;\\n\\t\\t\\tpadding-bottom: 0;\\n\\t\\t}\\n\\n\\t\\\&quot;\\\&quot;\\\&quot;&gt;&gt;\\n\\n\\t.tc-story-river {\\n\\t\\tposition: relative;\\n\\t\\tpadding: 0;\\n\\t}\\n}\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\\t.tc-message-box {\\n\\t\\tmargin: 21px -21px 21px -21px;\\n\\t}\\n\\n\\t.tc-sidebar-scrollable {\\n\\t\\tposition: fixed;\\n\\t\\ttop: {{$:/themes/tiddlywiki/vanilla/metrics/storytop}};\\n\\t\\tleft: {{$:/themes/tiddlywiki/vanilla/metrics/storyright}};\\n\\t\\tbottom: 0;\\n\\t\\tright: 0;\\n\\t\\toverflow-y: auto;\\n\\t\\toverflow-x: auto;\\n\\t\\t-webkit-overflow-scrolling: touch;\\n\\t\\tmargin: 0 0 0 -42px;\\n\\t\\tpadding: 71px 0 28px 42px;\\n\\t}\\n\\n\\thtml[dir=\\\&quot;rtl\\\&quot;] .tc-sidebar-scrollable {\\n\\t\\tleft: auto;\\n\\t\\tright: {{$:/themes/tiddlywiki/vanilla/metrics/storyright}};\\n\\t}\\n\\n\\t.tc-story-river {\\n\\t\\tposition: relative;\\n\\t\\tleft: {{$:/themes/tiddlywiki/vanilla/metrics/storyleft}};\\n\\t\\ttop: {{$:/themes/tiddlywiki/vanilla/metrics/storytop}};\\n\\t\\twidth: {{$:/themes/tiddlywiki/vanilla/metrics/storywidth}};\\n\\t\\tpadding: 42px 42px 42px 42px;\\n\\t}\\n\\n\u003C\u003Cif-no-sidebar \\\&quot;\\n\\n\\t.tc-story-river {\\n\\t\\twidth: calc(100% - {{$:/themes/tiddlywiki/vanilla/metrics/storyleft}});\\n\\t}\\n\\n\\\&quot;&gt;&gt;\\n\\n\\t.tc-story-river.tc-static-story-river {\\n\\t\\tmargin-right: 0;\\n\\t\\tpadding-right: 42px;\\n\\t}\\n\\n}\\n\\n@media print {\\n\\n\\tbody.tc-body {\\n\\t\\tbackground-color: transparent;\\n\\t}\\n\\n\\t.tc-sidebar-header, .tc-topbar {\\n\\t\\tdisplay: none;\\n\\t}\\n\\n\\t.tc-story-river {\\n\\t\\tmargin: 0;\\n\\t\\tpadding: 0;\\n\\t}\\n\\n\\t.tc-story-river .tc-tiddler-frame {\\n\\t\\tmargin: 0;\\n\\t\\tborder: none;\\n\\t\\tpadding: 0;\\n\\t}\\n}\\n\\n/*\\n** Tiddler styles\\n*/\\n\\n.tc-tiddler-frame {\\n\\tposition: relative;\\n\\tmargin-bottom: 28px;\\n\\tbackground-color: \u003C\u003Ccolour tiddler-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour tiddler-border&gt;&gt;;\\n}\\n\\n{{$:/themes/tiddlywiki/vanilla/sticky}}\\n\\n.tc-tiddler-info {\\n\\toverflow: hidden;\\n\\tpadding: 14px 42px 14px 42px;\\n\\tbackground-color: \u003C\u003Ccolour tiddler-info-background&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour tiddler-info-border&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tiddler-info-border&gt;&gt;;\\n}\\n\\n.tc-tiddler-info p {\\n\\tmargin-top: 3px;\\n\\tmargin-bottom: 3px;\\n}\\n\\n.tc-tiddler-info .tc-tab-buttons button.tc-tab-selected {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-info-tab-background&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tiddler-info-tab-background&gt;&gt;;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\n\\t.tc-tiddler-info {\\n\\t\\tpadding: 14px 14px 14px 14px;\\n\\t}\\n\\n}\\n\\n.tc-view-field-table {\\n\\twidth: 100%;\\n}\\n\\n.tc-view-field-name {\\n\\twidth: 1%; /* Makes this column be as narrow as possible */\\n\\twhite-space: nowrap;\\n\\tvertical-align: top;\\n\\ttext-align: right;\\n\\tfont-style: italic;\\n\\tfont-weight: normal;\\n}\\n\\n.tc-view-field-value {\\n\\tword-break: break-all;\\n}\\n\\n@media (max-width: \u003C\u003Csidebarbreakpoint-minus-one&gt;&gt;) {\\n\\t.tc-tiddler-frame {\\n\\t\\tpadding: 14px 14px 14px 14px;\\n\\t\\tmargin-bottom: .5em;\\n\\t}\\n\\n\\t.tc-tiddler-info {\\n\\t\\tmargin: 0 -14px 0 -14px;\\n\\t}\\n}\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\t.tc-tiddler-frame {\\n\\t\\tpadding: 28px 42px 42px 42px;\\n\\t\\twidth: {{$:/themes/tiddlywiki/vanilla/metrics/tiddlerwidth}};\\n\\t\\tborder-radius: 2px;\\n\\t}\\n\\n\u003C\u003Cif-no-sidebar \\\&quot;\\n\\n\\t.tc-tiddler-frame {\\n\\t\\twidth: 100%;\\n\\t}\\n\\n\\\&quot;&gt;&gt;\\n\\n\\t.tc-tiddler-info {\\n\\t\\tmargin: 0 -42px 0 -42px;\\n\\t}\\n}\\n\\n.tc-site-title,\\n.tc-titlebar {\\n\\tfont-weight: normal;\\n\\tfont-size: 2.35em;\\n\\tline-height: 1.35em;\\n\\tcolor: \u003C\u003Ccolour tiddler-title-foreground&gt;&gt;;\\n\\tmargin: 0;\\n}\\n\\n.tc-site-title {\\n\\tcolor: \u003C\u003Ccolour site-title-foreground&gt;&gt;;\\n}\\n\\n.tc-tiddler-title-icon {\\n\\tvertical-align: middle;\\n\\tmargin-right: .1em;\\n}\\n\\n.tc-tiddler-title-icon svg {\\n\\twidth: 0.9em;\\n\\theight: 0.9em;\\n}\\n\\n.tc-system-title-prefix {\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-tiddler-lazy-loading {\\n\\theight: 4px;\\n\\twidth: 100%;\\n\\tbackground: no-repeat linear-gradient(\u003C\u003Ccolour background&gt;&gt; 0 0),no-repeat linear-gradient(\u003C\u003Ccolour background&gt;&gt; 0 0),\u003C\u003Ccolour primary&gt;&gt;;\\n\\tbackground-size: 60% 100%;\\n\\tanimation: animation-loading-progress 3s infinite;\\n}\\n\\n@keyframes animation-loading-progress {\\n\\t0%   {background-position:-150% 0,-150% 0}\\n\\t66%  {background-position: 250% 0,-150% 0}\\n\\t100% {background-position: 250% 0, 250% 0}\\n}\\n\\n.tc-titlebar h2 {\\n\\tfont-size: 1em;\\n\\tdisplay: inline;\\n}\\n\\n.tc-titlebar img {\\n\\theight: 1em;\\n}\\n\\n.tc-subtitle {\\n\\tfont-size: 0.9em;\\n\\tcolor: \u003C\u003Ccolour tiddler-subtitle-foreground&gt;&gt;;\\n\\tfont-weight: normal;\\n}\\n\\n.tc-subtitle .tc-tiddlylink {\\n\\tmargin-right: .3em;\\n}\\n\\n.tc-tiddler-missing .tc-title {\\n\\tfont-style: italic;\\n\\tfont-weight: normal;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-controls {\\n\\tfloat: right;\\n\\tpadding: 3px; /* make space for outline */\\n}\\n\\n.tc-tiddler-controls .tc-drop-down {\\n\\tfont-size: 0.6em;\\n}\\n\\n.tc-tiddler-controls .tc-drop-down .tc-drop-down {\\n\\tfont-size: 1em;\\n}\\n\\n.tc-tiddler-controls &gt; span &gt; button,\\n.tc-tiddler-controls &gt; span &gt; span &gt; button,\\n.tc-tiddler-controls &gt; span &gt; span &gt; span &gt; button {\\n\\tvertical-align: baseline;\\n\\tmargin-left:5px;\\n}\\n\\n.tc-tiddler-controls button svg, .tc-tiddler-controls button img,\\n.tc-search button svg, .tc-search a svg {\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg, .tc-tiddler-controls button img {\\n\\theight: 0.75em;\\n}\\n\\n.tc-search button svg, .tc-search a svg {\\n\\theight: 1.2em;\\n\\twidth: 1.2em;\\n\\tmargin: 0 0.25em;\\n}\\n\\n.tc-tiddler-controls button.tc-selected svg,\\n.tc-page-controls button.tc-selected svg  {\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground-selected&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button.tc-btn-invisible:hover svg,\\n.tc-search button:hover svg, .tc-search a:hover svg {\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground-hover&gt;&gt;;\\n}\\n\\n@media print {\\n\\t.tc-tiddler-controls {\\n\\t\\tdisplay: none;\\n\\t}\\n}\\n\\n.tc-tiddler-help { /* Help prompts within tiddler template */\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tmargin-top: 14px;\\n}\\n\\n.tc-tiddler-help a.tc-tiddlylink {\\n\\tcolor: \u003C\u003Ccolour very-muted-foreground&gt;&gt;;\\n}\\n\\n.tc-tiddler-frame .tc-edit-texteditor {\\n\\twidth: 100%;\\n\\tmargin: 4px 0 4px 0;\\n}\\n\\n.tc-tiddler-frame input.tc-edit-texteditor,\\n.tc-tiddler-frame textarea.tc-edit-texteditor,\\n.tc-tiddler-frame iframe.tc-edit-texteditor,\\n.tc-tiddler-frame select.tc-edit-texteditor {\\n\\tpadding: 3px 3px 3px 3px;\\n\\tborder: 1px solid \u003C\u003Ccolour tiddler-editor-border&gt;&gt;;\\n\\tline-height: 1.3em;\\n\\tfont-family: {{$:/themes/tiddlywiki/vanilla/settings/editorfontfamily}};\\n}\\n\\n.tc-tiddler-frame input.tc-edit-texteditor,\\n.tc-tiddler-frame textarea.tc-edit-texteditor,\\n.tc-tiddler-frame iframe.tc-edit-texteditor {\\n\\t-webkit-appearance: none;\\n}\\n\\n.tc-tiddler-frame input.tc-edit-texteditor,\\n.tc-tiddler-frame select.tc-edit-texteditor,\\n.tc-tiddler-frame textarea.tc-edit-texteditor {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-editor-background&gt;&gt;;\\n}\\n\\n.tc-tiddler-frame iframe.tc-edit-texteditor {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-background&gt;&gt;;\\n}\\n\\n.tc-tiddler-frame .tc-edit-fields input.tc-edit-fieldeditor,\\n.tc-tiddler-frame .tc-edit-fields select.tc-edit-fieldeditor,\\n.tc-tiddler-frame .tc-edit-fields textarea.tc-edit-fieldeditor {\\n\\tmargin: 0;\\n\\tpadding: 2px 3px;\\n}\\n\\n.tc-tiddler-frame .tc-binary-warning {\\n\\twidth: 100%;\\n\\theight: 5em;\\n\\ttext-align: center;\\n\\tpadding: 3em 3em 6em 3em;\\n\\tbackground: \u003C\u003Ccolour alert-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour alert-border&gt;&gt;;\\n}\\n\\ncanvas.tc-edit-bitmapeditor  {\\n\\tborder: 6px solid \u003C\u003Ccolour tiddler-editor-border-image&gt;&gt;;\\n\\tcursor: crosshair;\\n\\t-moz-user-select: none;\\n\\t-webkit-user-select: none;\\n\\t-ms-user-select: none;\\n\\tmargin-top: 6px;\\n\\tmargin-bottom: 6px;\\n}\\n\\n.tc-edit-bitmapeditor-width {\\n\\tdisplay: block;\\n}\\n\\n.tc-edit-bitmapeditor-height {\\n\\tdisplay: block;\\n}\\n\\n.tc-single-tiddler-window .tc-tiddler-body,\\n.tc-tiddler-frame .tc-tiddler-body {\\n\\tfont-size: {{$:/themes/tiddlywiki/vanilla/metrics/bodyfontsize}};\\n\\tline-height: {{$:/themes/tiddlywiki/vanilla/metrics/bodylineheight}};\\n}\\n\\n.tc-titlebar, .tc-tiddler-edit-title {\\n\\toverflow: hidden; /* https://github.com/TiddlyWiki/TiddlyWiki5/issues/282 */\\n}\\n\\n/*\\n* Tiddler in a new window.\\n* Also see: .tc-single-tiddler-window .tc-tiddler-body, above\\n*/\\n\\nhtml body.tc-body.tc-single-tiddler-window {\\n\\tmargin: 1em;\\n\\tbackground: \u003C\u003Ccolour tiddler-background&gt;&gt;;\\n}\\n\\n.tc-single-tiddler-window img,\\n.tc-single-tiddler-window svg,\\n.tc-single-tiddler-window canvas,\\n.tc-single-tiddler-window embed,\\n.tc-single-tiddler-window iframe {\\n\\tmax-width: 100%;\\n}\\n\\n/*\\n** Editor\\n*/\\n\\n.tc-editor-toolbar {\\n\\tmargin-top: 8px;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview .tc-editor-toolbar,\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview-hidden .tc-editor-toolbar {\\n\\tgrid-area: toolbar;\\n}\\n\\n.tc-editor-toolbar button {\\n\\tvertical-align: middle;\\n\\tbackground-color: \u003C\u003Ccolour tiddler-controls-foreground&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour tiddler-controls-foreground-selected&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground-selected&gt;&gt;;\\n\\tborder-radius: 4px;\\n\\tpadding: 3px;\\n\\tmargin: 2px 0 2px 4px;\\n}\\n\\n.tc-editor-toolbar button.tc-text-editor-toolbar-item-adjunct {\\n\\tmargin-left: 1px;\\n\\twidth: 1em;\\n\\tborder-radius: 8px;\\n}\\n\\n.tc-editor-toolbar button.tc-text-editor-toolbar-item-start-group {\\n\\tmargin-left: 11px;\\n}\\n\\n.tc-editor-toolbar button.tc-selected {\\n\\tbackground-color: \u003C\u003Ccolour primary&gt;&gt;;\\n}\\n\\n.tc-editor-toolbar button svg {\\n\\twidth: 1.6em;\\n\\theight: 1.2em;\\n}\\n\\n.tc-editor-toolbar .tc-drop-down button.tc-btn-mini {\\n\\tpadding: 2px 4px;\\n}\\n\\n.tc-editor-toolbar button:hover {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-controls-foreground-selected&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-editor-toolbar .tc-text-editor-toolbar-more {\\n\\twhite-space: normal;\\n}\\n\\n.tc-editor-toolbar .tc-text-editor-toolbar-more button {\\n\\tdisplay: inline-block;\\n\\tpadding: 3px;\\n\\twidth: auto;\\n}\\n\\n.tc-editor-toolbar .tc-search-results {\\n\\tpadding: 0;\\n}\\n\\n.tc-editor-toolbar button.tc-editortoolbar-stamp-button + .tc-popup .tc-drop-down &gt; p {\\n\\tmargin: 0;\\n\\tpadding: 0;\\n}\\n\\n.tc-editor-toolbar button.tc-editortoolbar-stamp-button + .tc-popup .tc-drop-down a.tc-tiddlylink {\\n\\tfont-weight: normal;\\n}\\n\\n/*\\n** Adjustments for fluid-fixed mode\\n*/\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\u003C\u003Cif-fluid-fixed text:\\\&quot;\\\&quot;\\\&quot;\\n\\n\\t.tc-story-river {\\n\\t\\tpadding-right: 0;\\n\\t\\tposition: relative;\\n\\t\\twidth: auto;\\n\\t\\tleft: 0;\\n\\t\\tmargin-left: {{$:/themes/tiddlywiki/vanilla/metrics/storyleft}};\\n\\t\\tmargin-right: {{$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth}};\\n\\t}\\n\\n\\t.tc-tiddler-frame {\\n\\t\\twidth: 100%;\\n\\t}\\n\\n\\t.tc-sidebar-scrollable {\\n\\t\\tleft: auto;\\n\\t\\tbottom: 0;\\n\\t\\tright: 0;\\n\\t\\twidth: {{$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth}};\\n\\t}\\n\\n\\tbody.tc-body .tc-page-container.tc-page-view-zoomin .tc-tiddler-frame {\\n\\t\\twidth: 100%;\\n\\t\\twidth: calc(100% - 42px);\\n\\t}\\n\\n\\\&quot;\\\&quot;\\\&quot; hiddenSidebarText:\\\&quot;\\\&quot;\\\&quot;\\n\\n\\t.tc-story-river {\\n\\t\\tpadding-right: 3em;\\n\\t\\tmargin-right: 0;\\n\\t}\\n\\n\\tbody.tc-body .tc-page-container.tc-page-view-zoomin .tc-tiddler-frame {\\n\\t\\twidth: 100%;\\n\\t\\twidth: calc(100% - 84px);\\n\\t}\\n\\n\\\&quot;\\\&quot;\\\&quot;&gt;&gt;\\n\\n}\\n\\n/*\\n** Toolbar buttons\\n*/\\n\\n.tc-page-controls svg.tc-image-new-button {\\n\\tfill: \u003C\u003Ccolour toolbar-new-button&gt;&gt;;\\n}\\n\\n.tc-page-controls svg.tc-image-options-button {\\n\\tfill: \u003C\u003Ccolour toolbar-options-button&gt;&gt;;\\n}\\n\\n.tc-page-controls svg.tc-image-save-button {\\n\\tfill: \u003C\u003Ccolour toolbar-save-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-info-button {\\n\\tfill: \u003C\u003Ccolour toolbar-info-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-edit-button {\\n\\tfill: \u003C\u003Ccolour toolbar-edit-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-close-button {\\n\\tfill: \u003C\u003Ccolour toolbar-close-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-delete-button {\\n\\tfill: \u003C\u003Ccolour toolbar-delete-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-cancel-button {\\n\\tfill: \u003C\u003Ccolour toolbar-cancel-button&gt;&gt;;\\n}\\n\\n.tc-tiddler-controls button svg.tc-image-done-button {\\n\\tfill: \u003C\u003Ccolour toolbar-done-button&gt;&gt;;\\n}\\n\\n.tc-page-controls svg.tc-image-layout-button {\\n\\tfill: \u003C\u003Ccolour toolbar-options-button&gt;&gt;;\\n}\\n\\n/*\\n** Tiddler edit mode\\n*/\\n\\n.tc-tiddler-edit-frame em.tc-edit {\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tfont-style: normal;\\n}\\n\\n.tc-edit-type-dropdown a.tc-tiddlylink-missing {\\n\\tfont-style: normal;\\n}\\n\\n.tc-type-selector .tc-edit-typeeditor {\\n\\twidth: auto;\\n}\\n\\n.tc-type-selector-dropdown-wrapper {\\n\\tdisplay: inline-block;\\n}\\n\\n\u003C\u003Cset-type-selector-min-width&gt;&gt;\\n\\n.tc-edit-tags {\\n\\tborder: 1px solid \u003C\u003Ccolour tiddler-editor-border&gt;&gt;;\\n\\tpadding: 4px 8px 4px 8px;\\n}\\n\\n.tc-edit-add-tag {\\n\\tdisplay: inline-block;\\n}\\n\\n.tc-edit-add-tag .tc-add-tag-name input {\\n\\twidth: 50%;\\n}\\n\\n.tc-edit-add-tag .tc-keyboard {\\n\\tdisplay:inline;\\n}\\n\\n.tc-edit-tags .tc-tag-label {\\n\\tdisplay: inline-block;\\n}\\n\\n.tc-edit-tags-list {\\n\\tmargin: 14px 0 14px 0;\\n}\\n\\n.tc-remove-tag-button {\\n\\tpadding-left: 4px;\\n}\\n\\n.tc-tiddler-editor {\\n\\tdisplay: grid;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview {\\n\\tgrid-template-areas:\\n\\t\\t\\\&quot;toolbar toolbar\\\&quot;\\n\\t\\t\\\&quot;editor preview\\\&quot;;\\n\\tgrid-template-columns: repeat(2, minmax(0px, 1fr));\\n\\tgrid-template-rows: auto 1fr;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview-hidden {\\n\\tgrid-template-areas:\\n\\t\\t\\\&quot;toolbar\\\&quot;\\n\\t\\t\\\&quot;editor\\\&quot;;\\n\\tgrid-template-columns: 1fr;\\n\\tgrid-template-rows: auto 1fr;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview .tc-tiddler-preview-preview {\\n\\tgrid-area: preview;\\n\\toverflow-wrap: anywhere;\\n\\tword-break: normal;\\n\\tborder: 1px solid \u003C\u003Ccolour tiddler-editor-border&gt;&gt;;\\n\\tmargin: 4px 0 3px 3px;\\n\\tpadding: 3px 3px 3px 3px;\\n}\\n\\n\u003C\u003Cif-editor-height-fixed then:\\\&quot;\\\&quot;\\\&quot;\\n\\n.tc-tiddler-preview-preview {\\n\\toverflow-y: scroll;\\n\\theight: {{$:/config/TextEditor/EditorHeight/Height}};\\n}\\n\\n\\\&quot;\\\&quot;\\\&quot;&gt;&gt;\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview .tc-edit-texteditor,\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview-hidden .tc-edit-texteditor {\\n\\tgrid-area: editor;\\n}\\n\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview canvas.tc-edit-bitmapeditor,\\n.tc-tiddler-frame .tc-tiddler-editor.tc-tiddler-preview-hidden canvas.tc-edit-bitmapeditor {\\n\\tgrid-area: editor;\\n\\tmax-width: 100%;\\n}\\n\\n.tc-edit-fields {\\n\\twidth: 100%;\\n}\\n\\n.tc-edit-fields.tc-edit-fields-small {\\n\\tmargin-top: 0;\\n\\tmargin-bottom: 0;\\n}\\n\\n.tc-edit-fields table, .tc-edit-fields tr, .tc-edit-fields td {\\n\\tborder: none;\\n\\tpadding: 4px;\\n}\\n\\n.tc-edit-fields &gt; tbody &gt; .tc-edit-field:nth-child(odd) {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-editor-fields-odd&gt;&gt;;\\n}\\n\\n.tc-edit-fields &gt; tbody &gt; .tc-edit-field:nth-child(even) {\\n\\tbackground-color: \u003C\u003Ccolour tiddler-editor-fields-even&gt;&gt;;\\n}\\n\\n.tc-edit-field-name {\\n\\ttext-align: right;\\n}\\n\\n.tc-edit-field-value input {\\n\\twidth: 100%;\\n}\\n\\n.tc-edit-field-remove {\\n}\\n\\n.tc-edit-field-remove svg {\\n\\theight: 1em;\\n\\twidth: 1em;\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-edit-field-add-name-wrapper input.tc-edit-texteditor {\\n\\twidth: auto;\\n}\\n\\n.tc-edit-field-add-name-wrapper {\\n\\tdisplay: inline-block;\\n}\\n\\n.tc-edit-field-add-value {\\n\\tdisplay: inline-block;\\n}\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\\t.tc-edit-field-add-value {\\n\\t\\twidth: 35%;\\n\\t}\\n\\n}\\n\\n.tc-edit-field-add-button {\\n\\tdisplay: inline-block;\\n\\twidth: 10%;\\n}\\n\\n\\n/*\\n** Tiddler editor dropzone\\n*/\\n\\n.tc-dropzone-editor {\\n\\tposition:relative;\\n}\\n\\n.tc-dropzone-editor.tc-dragover .tc-editor-toolbar::after{\\n\\tz-index: 10000;\\n\\ttop:0;\\n\\tleft:0;\\n\\tright:0;\\n\\theight: 100%;\\n\\tbackground: \u003C\u003Ccolour dropzone-background&gt;&gt;;\\n\\tcontent: \\\&quot;\u003C\u003Clingo DropMessage&gt;&gt;\\\&quot;;\\n\\tpointer-events: none;\\n\\tposition: absolute;\\n\\tdisplay: flex;\\n\\talign-items: center;\\n\\tjustify-content: center;\\n\\tbackground-color: \u003C\u003Ccolor background&gt;&gt;;\\n\\tborder: 4px dashed \u003C\u003Ccolor modal-border&gt;&gt;;\\n\\tfont-weight: bold;\\n\\tfont-size: 150%;\\n\\topacity: 0.8;\\n\\tcolor: \u003C\u003Ccolor foreground&gt;&gt;;\\n}\\n\\n.tc-editor-importpopup {\\n\\twidth: 100%;\\n\\theight: 100%;\\n}\\n\\n.tc-editor-import {\\n\\tposition: absolute;\\n\\ttop: 50%;\\n\\tleft: 50%;\\n\\ttransform: translate(-50%, -50%);\\n\\tbackground: \u003C\u003Ccolor pre-background&gt;&gt;;\\n\\tbox-shadow: 2px 2px 10px \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tpadding: 10px;\\n\\twidth: 96%;\\n\\tborder: 1px solid \u003C\u003Ccolor tiddler-controls-foreground&gt;&gt;;\\n\\ttext-align:center;\\n}\\n\\n.tc-editor-import img {\\n\\tmax-height: 500px;\\n}\\n\\n/*\\n** Storyview Classes\\n*/\\n\\n.tc-viewswitcher .tc-image-button {\\n\\tmargin-right: .3em;\\n}\\n\\n.tc-page-container.tc-page-view-zoomin .tc-tiddler-frame {\\n\\tposition: absolute;\\n\\tdisplay: block;\\n\\twidth: 100%;\\n}\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\\t.tc-page-container.tc-page-view-zoomin .tc-tiddler-frame {\\n\\t\\twidth: calc(100% - 84px);\\n\\t}\\n\\n}\\n\\n/*\\n** Dropdowns\\n*/\\n\\n.tc-btn-dropdown {\\n\\ttext-align: left;\\n}\\n\\n.tc-btn-dropdown svg, .tc-btn-dropdown img {\\n\\theight: 1em;\\n\\twidth: 1em;\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-drop-down-wrapper {\\n\\tposition: relative;\\n}\\n\\n.tc-drop-down {\\n\\tmin-width: 380px;\\n\\tborder: 1px solid \u003C\u003Ccolour dropdown-border&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour dropdown-background&gt;&gt;;\\n\\tpadding: 7px 0 7px 0;\\n\\tmargin: 4px 0 0 0;\\n\\twhite-space: nowrap;\\n\\ttext-shadow: none;\\n\\tline-height: 1.4;\\n}\\n\\n.tc-drop-down .tc-drop-down {\\n\\tmargin-left: 14px;\\n}\\n\\n.tc-drop-down button svg, .tc-drop-down a svg  {\\n\\tfill: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-drop-down button:disabled svg {\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-drop-down button.tc-btn-invisible:hover svg {\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-drop-down .tc-drop-down-info {\\n\\tpadding-left: 14px;\\n}\\n\\n.tc-drop-down p {\\n\\tpadding: 0 14px 0 14px;\\n}\\n\\n.tc-drop-down svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n}\\n\\n.tc-drop-down img {\\n\\twidth: 1em;\\n}\\n\\n.tc-drop-down a, .tc-drop-down button {\\n\\tdisplay: block;\\n\\tpadding: 0 14px 0 14px;\\n\\twidth: 100%;\\n\\ttext-align: left;\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tline-height: 1.4;\\n}\\n\\n.tc-drop-down .tc-tab-set .tc-tab-buttons button {\\n\\tdisplay: inline-block;\\n\\twidth: auto;\\n\\tmargin-bottom: 0px;\\n\\tborder-bottom-left-radius: 0;\\n\\tborder-bottom-right-radius: 0;\\n}\\n\\n.tc-drop-down .tc-prompt {\\n\\tpadding: 0 14px;\\n}\\n\\n.tc-drop-down .tc-chooser {\\n\\tborder: none;\\n}\\n\\n.tc-drop-down .tc-chooser .tc-swatches-horiz {\\n\\tfont-size: 0.4em;\\n\\tpadding-left: 1.2em;\\n}\\n\\n.tc-drop-down .tc-file-input-wrapper {\\n\\twidth: 100%;\\n}\\n\\n.tc-drop-down .tc-file-input-wrapper button {\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-drop-down a:hover, .tc-drop-down button:hover, .tc-drop-down .tc-file-input-wrapper:hover button {\\n\\tcolor: \u003C\u003Ccolour tiddler-link-background&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour tiddler-link-foreground&gt;&gt;;\\n\\ttext-decoration: none;\\n}\\n\\n.tc-drop-down .tc-tab-buttons button {\\n\\tbackground-color: \u003C\u003Ccolour dropdown-tab-background&gt;&gt;;\\n}\\n\\n.tc-drop-down .tc-tab-buttons button.tc-tab-selected {\\n\\tbackground-color: \u003C\u003Ccolour dropdown-tab-background-selected&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour dropdown-tab-background-selected&gt;&gt;;\\n}\\n\\n.tc-drop-down-bullet {\\n\\tdisplay: inline-block;\\n\\twidth: 0.5em;\\n}\\n\\n.tc-drop-down .tc-tab-contents a {\\n\\tpadding: 0 0.5em 0 0.5em;\\n}\\n\\n.tc-block-dropdown-wrapper {\\n\\tposition: relative;\\n}\\n\\n.tc-block-dropdown {\\n\\tposition: absolute;\\n\\tmin-width: 220px;\\n\\tborder: 1px solid \u003C\u003Ccolour dropdown-border&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour dropdown-background&gt;&gt;;\\n\\tpadding: 7px 0;\\n\\tmargin: 4px 0 0 0;\\n\\twhite-space: nowrap;\\n\\tz-index: 1000;\\n\\ttext-shadow: none;\\n}\\n\\n.tc-block-dropdown.tc-search-drop-down {\\n\\tmargin-left: -12px;\\n}\\n\\n.tc-block-dropdown a {\\n\\tdisplay: block;\\n\\tpadding: 4px 14px 4px 14px;\\n}\\n\\n.tc-block-dropdown.tc-search-drop-down a {\\n\\tdisplay: block;\\n\\tpadding: 0px 10px 0px 10px;\\n}\\n\\n.tc-drop-down .tc-dropdown-item-plain,\\n.tc-block-dropdown .tc-dropdown-item-plain {\\n\\tpadding: 4px 14px 4px 7px;\\n}\\n\\n.tc-drop-down .tc-dropdown-item,\\n.tc-block-dropdown .tc-dropdown-item {\\n\\tpadding: 4px 14px 4px 7px;\\n\\tcolor: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-block-dropdown a.tc-tiddlylink:hover {\\n\\tcolor: \u003C\u003Ccolour tiddler-link-background&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour tiddler-link-foreground&gt;&gt;;\\n\\ttext-decoration: none;\\n}\\n\\n.tc-search-results {\\n\\tpadding: 0 7px 0 7px;\\n}\\n\\n.tc-image-chooser, .tc-colour-chooser {\\n\\twhite-space: normal;\\n}\\n\\n.tc-image-chooser a,\\n.tc-colour-chooser a {\\n\\tdisplay: inline-block;\\n\\tvertical-align: top;\\n\\ttext-align: center;\\n\\tposition: relative;\\n}\\n\\n.tc-image-chooser a {\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tpadding: 2px;\\n\\tmargin: 2px;\\n\\twidth: 4em;\\n\\theight: 4em;\\n}\\n\\n.tc-colour-chooser a {\\n\\tpadding: 3px;\\n\\twidth: 2em;\\n\\theight: 2em;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-image-chooser a:hover,\\n.tc-colour-chooser a:hover {\\n\\tbackground: \u003C\u003Ccolour primary&gt;&gt;;\\n\\tpadding: 0px;\\n\\tborder: 3px solid \u003C\u003Ccolour primary&gt;&gt;;\\n}\\n\\n.tc-image-chooser a svg,\\n.tc-image-chooser a img {\\n\\tdisplay: inline-block;\\n\\twidth: auto;\\n\\theight: auto;\\n\\tmax-width: 3.5em;\\n\\tmax-height: 3.5em;\\n\\tposition: absolute;\\n\\ttop: 0;\\n\\tbottom: 0;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tmargin: auto;\\n}\\n\\n/* Make search dropdown visible on small screens. issue #7003 */\\n@media (max-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\\t.tc-sidebar-search .tc-block-dropdown-wrapper {\\n\\t\\tposition: initial;\\n\\t}\\n\\n}\\n\\n/*\\n** Modals\\n*/\\n\\n.tc-modal-wrapper {\\n\\tposition: fixed;\\n\\toverflow: auto;\\n\\toverflow-y: scroll;\\n\\ttop: 0;\\n\\tright: 0;\\n\\tbottom: 0;\\n\\tleft: 0;\\n\\tz-index: 900;\\n}\\n\\n.tc-modal-backdrop {\\n\\tposition: fixed;\\n\\ttop: 0;\\n\\tright: 0;\\n\\tbottom: 0;\\n\\tleft: 0;\\n\\tz-index: 1000;\\n\\tbackground-color: \u003C\u003Ccolour modal-backdrop&gt;&gt;;\\n}\\n\\n.tc-modal {\\n\\tz-index: 1100;\\n\\tbackground-color: \u003C\u003Ccolour modal-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour modal-border&gt;&gt;;\\n}\\n\\n@media (max-width: 55em) {\\n\\t.tc-modal {\\n\\t\\tposition: fixed;\\n\\t\\ttop: 1em;\\n\\t\\tleft: 1em;\\n\\t\\tright: 1em;\\n\\t}\\n\\n\\t.tc-modal-body {\\n\\t\\toverflow-y: auto;\\n\\t\\tmax-height: 400px;\\n\\t\\tmax-height: 60vh;\\n\\t}\\n}\\n\\n@media (min-width: 55em) {\\n\\t.tc-modal {\\n\\t\\tposition: fixed;\\n\\t\\ttop: 2em;\\n\\t\\tleft: 25%;\\n\\t\\twidth: 50%;\\n\\t}\\n\\n\\t.tc-modal-body {\\n\\t\\toverflow-y: auto;\\n\\t\\tmax-height: 400px;\\n\\t\\tmax-height: 60vh;\\n\\t}\\n}\\n\\n.tc-modal-header {\\n\\tpadding: 9px 15px;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour modal-header-border&gt;&gt;;\\n}\\n\\n.tc-modal-header h3 {\\n\\tmargin: 0;\\n\\tline-height: 30px;\\n}\\n\\n.tc-modal-header img, .tc-modal-header svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n}\\n\\n.tc-modal-body {\\n\\tpadding: 15px;\\n}\\n\\n.tc-modal-footer {\\n\\tpadding: 14px 15px 15px;\\n\\tmargin-bottom: 0;\\n\\ttext-align: right;\\n\\tbackground-color: \u003C\u003Ccolour modal-footer-background&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour modal-footer-border&gt;&gt;;\\n}\\n\\n.tc-modal-prevent-scroll {\\n\\toverflow: hidden;\\n}\\n\\n/*\\n** Centered modals\\n*/\\n.tc-modal-centered .tc-modal {\\n\\twidth: auto;\\n\\ttop: 50%;\\n\\tleft: 50%;\\n\\ttransform: translate(-50%, -50%) !important;\\n}\\n\\n/*\\n** Notifications\\n*/\\n\\n.tc-notification {\\n\\tposition: fixed;\\n\\ttop: 14px;\\n\\tright: 42px;\\n\\tz-index: 1300;\\n\\tmax-width: 280px;\\n\\tpadding: 0 14px 0 14px;\\n\\tbackground-color: \u003C\u003Ccolour notification-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour notification-border&gt;&gt;;\\n}\\n\\n/*\\n** Tabs\\n*/\\n\\n.tc-tab-set.tc-vertical {\\n\\tdisplay: -webkit-flex;\\n\\tdisplay: flex;\\n}\\n\\n.tc-tab-buttons {\\n\\tfont-size: 0.85em;\\n\\tpadding-top: 1em;\\n\\tmargin-bottom: -2px;\\n}\\n\\n.tc-tab-buttons.tc-vertical  {\\n\\tz-index: 100;\\n\\tdisplay: block;\\n\\tpadding-top: 14px;\\n\\tvertical-align: top;\\n\\ttext-align: right;\\n\\tmargin-bottom: inherit;\\n\\tmargin-right: -1px;\\n\\tmax-width: 33%;\\n\\t-webkit-flex: 0 0 auto;\\n\\tflex: 0 0 auto;\\n}\\n\\n.tc-tab-buttons button.tc-tab-selected {\\n\\tcolor: \u003C\u003Ccolour tab-foreground-selected&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour tab-background-selected&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border-selected&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-border-selected&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour tab-border-selected&gt;&gt;;\\n}\\n\\n.tc-tab-buttons button {\\n\\tcolor: \u003C\u003Ccolour tab-foreground&gt;&gt;;\\n\\tpadding: 3px 5px 3px 5px;\\n\\tmargin-right: 0.3em;\\n\\tfont-weight: normal;\\n\\tborder: none;\\n\\tbackground: inherit;\\n\\tbackground-color: \u003C\u003Ccolour tab-background&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-top-left-radius: 2px;\\n\\tborder-top-right-radius: 2px;\\n\\tborder-bottom-left-radius: 0;\\n\\tborder-bottom-right-radius: 0;\\n}\\n\\n.tc-tab-buttons.tc-vertical button {\\n\\tdisplay: block;\\n\\twidth: 100%;\\n\\tmargin-top: 3px;\\n\\tmargin-right: 0;\\n\\ttext-align: right;\\n\\tbackground-color: \u003C\u003Ccolour tab-background&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-right: none;\\n\\tborder-top-left-radius: 2px;\\n\\tborder-bottom-left-radius: 2px;\\n\\tborder-top-right-radius: 0;\\n\\tborder-bottom-right-radius: 0;\\n}\\n\\n.tc-tab-buttons.tc-vertical button.tc-tab-selected {\\n\\tbackground-color: \u003C\u003Ccolour tab-background-selected&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour tab-background-selected&gt;&gt;;\\n}\\n\\n.tc-tab-divider {\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-divider&gt;&gt;;\\n}\\n\\n.tc-tab-divider.tc-vertical  {\\n\\tdisplay: none;\\n}\\n\\n.tc-tab-content {\\n\\tmargin-top: 14px;\\n}\\n\\n.tc-tab-content.tc-vertical  {\\n\\tdisplay: inline-block;\\n\\tvertical-align: top;\\n\\tpadding-top: 0;\\n\\tpadding-left: 14px;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\t-webkit-flex: 1 0 70%;\\n\\tflex: 1 0 70%;\\n\\toverflow: auto;\\n}\\n\\n.tc-sidebar-lists .tc-tab-buttons {\\n\\tmargin-bottom: -1px;\\n}\\n\\n.tc-sidebar-lists .tc-tab-buttons button.tc-tab-selected {\\n\\tbackground-color: \u003C\u003Ccolour sidebar-tab-background-selected&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour sidebar-tab-foreground-selected&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour sidebar-tab-border-selected&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour sidebar-tab-border-selected&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour sidebar-tab-border-selected&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists .tc-tab-buttons button {\\n\\tbackground-color: \u003C\u003Ccolour sidebar-tab-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour sidebar-tab-foreground&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour sidebar-tab-border&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour sidebar-tab-border&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour sidebar-tab-border&gt;&gt;;\\n}\\n\\n.tc-sidebar-lists .tc-tab-divider {\\n\\tborder-top: 1px solid \u003C\u003Ccolour sidebar-tab-divider&gt;&gt;;\\n}\\n\\n.tc-more-sidebar &gt; .tc-tab-set &gt; .tc-tab-buttons &gt; button {\\n\\tdisplay: block;\\n\\twidth: 100%;\\n\\tbackground-color: \u003C\u003Ccolour sidebar-tab-background&gt;&gt;;\\n\\tborder-top: none;\\n\\tborder-left: none;\\n\\tborder-bottom: none;\\n\\tborder-right: 1px solid #ccc;\\n\\tmargin-bottom: inherit;\\n}\\n\\n.tc-more-sidebar &gt; .tc-tab-set &gt; .tc-tab-buttons &gt; button.tc-tab-selected {\\n\\tbackground-color: \u003C\u003Ccolour sidebar-tab-background-selected&gt;&gt;;\\n\\tborder: none;\\n}\\n\\n/*\\n** Manager\\n*/\\n\\n.tc-manager-wrapper {\\n\\n}\\n\\n.tc-manager-controls {\\n\\n}\\n\\n.tc-manager-control {\\n\\tmargin: 0.5em 0;\\n}\\n\\n.tc-manager-control select {\\n\\tmax-width: 100%;\\n}\\n\\n.tc-manager-list {\\n\\twidth: 100%;\\n\\tborder-top: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-right: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-manager-list-item {\\n\\n}\\n\\n.tc-manager-list-item-heading {\\n\\tdisplay: block;\\n\\twidth: 100%;\\n\\ttext-align: left;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tpadding: 3px;\\n}\\n\\n.tc-manager-list-item-heading-selected {\\n\\tfont-weight: bold;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-manager-list-item-heading:hover {\\n\\tbackground: \u003C\u003Ccolour primary&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-manager-list-item-content {\\n\\tdisplay: flex;\\n}\\n\\n.tc-manager-list-item-content-sidebar {\\n\\tflex: 1 0;\\n\\tbackground: \u003C\u003Ccolour tiddler-editor-background&gt;&gt;;\\n\\tborder-right: 0.5em solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-bottom: 0.5em solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\twhite-space: nowrap;\\n}\\n\\n.tc-manager-list-item-content-item-heading {\\n\\tdisplay: block;\\n\\twidth: 100%;\\n\\ttext-align: left;\\n\\tbackground: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\ttext-transform: uppercase;\\n\\tfont-size: 0.6em;\\n\\tfont-weight: bold;\\n\\tpadding: 0.5em 0 0.5em 0;\\n}\\n\\n.tc-manager-list-item-content-item-body {\\n\\tpadding: 0 0.5em 0 0.5em;\\n}\\n\\n.tc-manager-list-item-content-item-body &gt; pre {\\n\\tmargin: 0.5em 0 0.5em 0;\\n\\tborder: none;\\n\\tbackground: inherit;\\n}\\n\\n.tc-manager-list-item-content-tiddler {\\n\\tflex: 3 1;\\n\\tborder-left: 0.5em solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-right: 0.5em solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-bottom: 0.5em solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-manager-list-item-content-item-body &gt; table {\\n\\tborder: none;\\n\\tpadding: 0;\\n\\tmargin: 0;\\n}\\n\\n.tc-manager-list-item-content-item-body &gt; table td {\\n\\tborder: none;\\n}\\n\\n.tc-manager-icon-editor &gt; button {\\n\\twidth: 100%;\\n}\\n\\n.tc-manager-icon-editor &gt; button &gt; svg,\\n.tc-manager-icon-editor &gt; button &gt; button {\\n\\twidth: 100%;\\n\\theight: auto;\\n}\\n\\n/*\\n** Import table\\n*/\\n\\n.tc-import-table {\\n\\twidth: 100%;\\n}\\n\\n.tc-import-table svg.tc-image-edit-button {\\n\\tmax-width: unset;\\n}\\n\\n.tc-import-table th:first-of-type {\\n\\twidth: 10%;\\n}\\n\\n.tc-import-table th:last-of-type {\\n\\twidth: 30%;\\n}\\n\\n.tc-import-table .tc-row-disabled {\\n\\tbackground: \u003C\u003Ccolour very-muted-foreground&gt;&gt;10;\\n\\topacity: 0.8;\\n}\\n\\n.tc-import-table .tc-row-warning {\\n\\tbackground: \u003C\u003Ccolour diff-delete-background&gt;&gt;50;\\n}\\n\\n/*\\n** Alerts\\n*/\\n\\n.tc-alerts {\\n\\tposition: fixed;\\n\\ttop: 28px;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tmax-width: 50%;\\n\\tz-index: 20000;\\n}\\n\\n.tc-alert {\\n\\tposition: relative;\\n\\tmargin: 14px;\\n\\tpadding: 7px;\\n\\tborder: 1px solid \u003C\u003Ccolour alert-border&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour alert-background&gt;&gt;;\\n}\\n\\n.tc-alert-toolbar {\\n\\tposition: absolute;\\n\\ttop: 7px;\\n\\tright: 7px;\\n\\tline-height: 0;\\n}\\n\\n.tc-alert-toolbar svg {\\n\\tfill: \u003C\u003Ccolour alert-muted-foreground&gt;&gt;;\\n}\\n\\n.tc-alert-subtitle {\\n\\tcolor: \u003C\u003Ccolour alert-muted-foreground&gt;&gt;;\\n\\tfont-weight: bold;\\n\\tfont-size: 0.8em;\\n\\tmargin-bottom: 0.5em;\\n}\\n\\n.tc-alert-body &gt; p {\\n\\tmargin: 0;\\n}\\n\\n.tc-alert-highlight {\\n\\tcolor: \u003C\u003Ccolour alert-highlight&gt;&gt;;\\n}\\n\\n@media (min-width: \u003C\u003Csidebarbreakpoint&gt;&gt;) {\\n\\n\\t.tc-static-alert {\\n\\t\\tposition: relative;\\n\\t}\\n\\n\\t.tc-static-alert-inner {\\n\\t\\tposition: absolute;\\n\\t\\tz-index: 100;\\n\\t}\\n\\n}\\n\\n.tc-static-alert-inner {\\n\\tpadding: 0 2px 2px 42px;\\n\\tcolor: \u003C\u003Ccolour static-alert-foreground&gt;&gt;;\\n}\\n\\n/*\\n** Floating drafts list\\n*/\\n\\n.tc-drafts-list {\\n\\tz-index: 2000;\\n\\tposition: fixed;\\n\\tfont-size: 0.8em;\\n\\tleft: 0;\\n\\tbottom: 0;\\n}\\n\\n.tc-drafts-list a {\\n\\tmargin: 0 0.5em;\\n\\tpadding: 4px 4px;\\n\\tborder-top-left-radius: 4px;\\n\\tborder-top-right-radius: 4px;\\n\\tborder: 1px solid \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder-bottom: none;\\n\\tbackground: \u003C\u003Ccolour dirty-indicator&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-drafts-list a:hover {\\n\\ttext-decoration: none;\\n\\tbackground: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-drafts-list a svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n\\tvertical-align: text-bottom;\\n}\\n\\n/*\\n** Control panel\\n*/\\n\\n.tc-control-panel td {\\n\\tpadding: 4px;\\n}\\n\\n.tc-control-panel table, .tc-control-panel table input, .tc-control-panel table textarea {\\n\\twidth: 100%;\\n}\\n\\n.tc-control-panel-setting {\\n\\tborder-top: 1px solid \u003C\u003Ccolour blockquote-bar&gt;&gt;;\\n}\\n\\n.tc-plugin-info {\\n\\tdisplay: flex;\\n\\ttext-shadow: none;\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour background&gt;&gt;;\\n\\tmargin: 0.5em 0 0.5em 0;\\n\\tpadding: 4px;\\n\\talign-items: center;\\n}\\n\\n.tc-sidebar-lists a.tc-tiddlylink.tc-plugin-info {\\n\\tcolor: \u003C\u003Ccolour tiddler-link-foreground&gt;&gt;;\\n}\\n\\n\\n.tc-plugin-info-sub-plugins .tc-plugin-info {\\n\\tmargin: 0.5em;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-plugin-info-sub-plugin-indicator {\\n\\tmargin: -16px 1em 0 2em;\\n}\\n\\n.tc-plugin-info-sub-plugin-indicator button {\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tborder-radius: 8px;\\n\\tpadding: 2px 7px;\\n\\tfont-size: 0.75em;\\n}\\n\\n.tc-plugin-info-sub-plugins .tc-plugin-info-dropdown {\\n\\tmargin-left: 1em;\\n\\tmargin-right: 1em;\\n}\\n\\n.tc-plugin-info-disabled {\\n\\tbackground: -webkit-repeating-linear-gradient(45deg, #ff0, #ff0 10px, #eee 10px, #eee 20px);\\n\\tbackground: repeating-linear-gradient(45deg, #ff0, #ff0 10px, #eee 10px, #eee 20px);\\n}\\n\\n.tc-plugin-info-disabled:hover {\\n\\tbackground: -webkit-repeating-linear-gradient(45deg, #aa0, #aa0 10px, #888 10px, #888 20px);\\n\\tbackground: repeating-linear-gradient(45deg, #aa0, #aa0 10px, #888 10px, #888 20px);\\n}\\n\\na.tc-tiddlylink.tc-plugin-info:hover {\\n\\ttext-decoration: none;\\n\\tbackground-color: \u003C\u003Ccolour primary&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n\\tfill: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\na.tc-tiddlylink.tc-plugin-info:hover &gt; .tc-plugin-info-chunk &gt; svg {\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\na.tc-tiddlylink.tc-plugin-info:hover &gt; .tc-plugin-info-chunk .tc-plugin-info-stability {\\n\\tborder: 1px solid \u003C\u003Ccolour background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-plugin-info-chunk {\\n\\tmargin: 2px;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-toggle {\\n\\tflex-grow: 0;\\n\\tflex-shrink: 0;\\n\\tline-height: 1;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-icon {\\n\\tflex-grow: 0;\\n\\tflex-shrink: 0;\\n\\tline-height: 1;\\n\\theight: 2em;\\n\\twidth: 2em;\\n\\tdisplay: grid;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-description {\\n\\tflex-grow: 1;\\n}\\n\\n.tc-plugin-info-chunk .tc-plugin-info-stability {\\n\\tmargin-right: 4px;\\n\\tpadding: 1px 3px;\\n\\tfont-size: 0.8em;\\n\\tborder-radius: 4px;\\n\\tfont-weight: bold;\\n}\\n\\n.tc-plugin-info-chunk .tc-plugin-info-stability-stable {\\n\\tborder: 1px solid \u003C\u003Ccolour stability-stable&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour stability-stable&gt;&gt;;\\n}\\n\\n.tc-plugin-info-chunk .tc-plugin-info-stability-experimental {\\n\\tborder: 1px solid \u003C\u003Ccolour stability-experimental&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour stability-experimental&gt;&gt;;\\n}\\n\\n.tc-plugin-info-chunk .tc-plugin-info-stability-deprecated {\\n\\tborder: 1px solid \u003C\u003Ccolour stability-deprecated&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour stability-deprecated&gt;&gt;;\\n}\\n\\n.tc-plugin-info-chunk .tc-plugin-info-stability-legacy {\\n\\tborder: 1px solid \u003C\u003Ccolour stability-legacy&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour stability-legacy&gt;&gt;;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-buttons {\\n\\tfont-size: 0.8em;\\n\\tline-height: 1.2;\\n\\tflex-grow: 0;\\n\\tflex-shrink: 0;\\n\\ttext-align: right;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-description h1 {\\n\\tfont-size: 1em;\\n\\tline-height: 1.2;\\n\\tmargin: 2px 0 2px 0;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-description h2 {\\n\\tfont-size: 0.8em;\\n\\tline-height: 1.2;\\n\\tmargin: 2px 0 2px 0;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-description div {\\n\\tfont-size: 0.8em;\\n\\tline-height: 1.2;\\n\\tmargin: 2px 0 2px 0;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-toggle img, .tc-plugin-info-chunk.tc-plugin-info-toggle svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n}\\n\\n.tc-plugin-info-chunk.tc-plugin-info-icon img, .tc-plugin-info-chunk.tc-plugin-info-icon svg {\\n\\tmax-width: 2em;\\n\\tmax-height: 2em;\\n\\tmargin: auto;\\n}\\n\\n.tc-plugin-info-dropdown {\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tmargin-top: -8px;\\n}\\n\\n.tc-plugin-info-dropdown-message {\\n\\tbackground: \u003C\u003Ccolour message-background&gt;&gt;;\\n\\tpadding: 0.5em 1em 0.5em 1em;\\n\\tfont-weight: bold;\\n\\tfont-size: 0.8em;\\n}\\n\\n.tc-plugin-info-dropdown-body {\\n\\tpadding: 1em 1em 0 1em;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-plugin-info-sub-plugins {\\n\\tpadding: 0.5em;\\n\\tmargin: 0 1em 1em 1em;\\n\\tbackground: \u003C\u003Ccolour notification-background&gt;&gt;;\\n}\\n\\n.tc-install-plugin {\\n\\tfont-weight: bold;\\n\\tbackground: green;\\n\\tcolor: white;\\n\\tfill: white;\\n\\tborder-radius: 4px;\\n\\tpadding: 3px;\\n}\\n\\n.tc-install-plugin.tc-reinstall-downgrade {\\n\\tbackground: red;\\n}\\n\\n.tc-install-plugin.tc-reinstall {\\n\\tbackground: blue;\\n}\\n\\n.tc-install-plugin.tc-reinstall-upgrade {\\n\\tbackground: orange;\\n}\\n\\n.tc-check-list {\\n\\tline-height: 2em;\\n}\\n\\n.tc-check-list .tc-image-button {\\n\\theight: 1.5em;\\n}\\n\\n/*\\n** Message boxes\\n*/\\n\\n.tc-message-box {\\n\\tborder: 1px solid \u003C\u003Ccolour message-border&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour message-background&gt;&gt;;\\n\\tpadding: 0px 21px 0px 21px;\\n\\tfont-size: 12px;\\n\\tline-height: 18px;\\n\\tcolor: \u003C\u003Ccolour message-foreground&gt;&gt;;\\n}\\n\\n.tc-message-box svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n\\tvertical-align: text-bottom;\\n}\\n\\n/*\\n** Pictures\\n*/\\n\\n.tc-bordered-image {\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tpadding: 5px;\\n\\tmargin: 5px;\\n}\\n\\n/*\\n** Floats\\n*/\\n\\n.tc-float-right {\\n\\tfloat: right;\\n}\\n\\n/* Float tc-clearfix. Needs to be used by elements that allow float:right in their content.\\n** So the floating element does not overflow\\n*/\\n\\n.tc-clearfix:after {\\n\\tcontent: \\\&quot;\\\&quot;;\\n\\tclear: both;\\n\\tdisplay: table;\\n}\\n\\n/* Fix overflow toc, manager and testcase output */\\n.tc-tiddler-body .tc-tabbed-table-of-contents, .tc-manager-list-item-content, .tc-test-case-output {\\n\\toverflow-x: auto;\\n}\\n\\n/* A wrapper to fix table overflow */\\n\\n.tc-table-wrapper {\\n\\toverflow-x: auto;\\n}\\n\\n/*\\n** Chooser\\n*/\\n\\n.tc-chooser {\\n\\tborder-right: 1px solid \u003C\u003Ccolour table-header-background&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour table-header-background&gt;&gt;;\\n}\\n\\n\\n.tc-chooser-item {\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour table-header-background&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour table-header-background&gt;&gt;;\\n\\tpadding: 2px 4px 2px 14px;\\n}\\n\\n.tc-drop-down .tc-chooser-item {\\n\\tpadding: 2px;\\n}\\n\\n.tc-chosen,\\n.tc-chooser-item:hover {\\n\\tbackground-color: \u003C\u003Ccolour table-header-background&gt;&gt;;\\n\\tborder-color: \u003C\u003Ccolour table-footer-background&gt;&gt;;\\n}\\n\\n.tc-chosen .tc-tiddlylink {\\n\\tcursor:default;\\n}\\n\\n.tc-chooser-item .tc-tiddlylink {\\n\\tdisplay: block;\\n\\ttext-decoration: none;\\n\\tbackground-color: transparent;\\n}\\n\\n.tc-chooser-item:hover .tc-tiddlylink:hover {\\n\\ttext-decoration: none;\\n}\\n\\n.tc-drop-down .tc-chosen .tc-tiddlylink,\\n.tc-drop-down .tc-chooser-item .tc-tiddlylink:hover {\\n\\tcolor: \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-chosen &gt; .tc-tiddlylink:before {\\n\\tmargin-left: -10px;\\n\\tposition: relative;\\n\\tcontent: \\\&quot;» \\\&quot;;\\n}\\n\\n.tc-chooser-item svg,\\n.tc-chooser-item img{\\n\\tmax-width: 1em;\\n\\tmax-height: 1em;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-language-chooser .tc-image-button img {\\n\\tmax-width: 2em;\\n\\tmax-height: 1em;\\n\\twidth: auto;\\n\\theight: auto;\\n\\tvertical-align: -0.15em;\\n}\\n\\n/*\\n** Palette swatches\\n*/\\n\\n.tc-swatches-horiz {\\n}\\n\\n.tc-swatches-horiz .tc-swatch {\\n\\tdisplay: inline-block;\\n}\\n\\n.tc-swatch {\\n\\twidth: 2em;\\n\\theight: 2em;\\n\\tmargin: 0.4em;\\n\\tborder: 1px solid #888;\\n}\\n\\ninput.tc-palette-manager-colour-input {\\n\\twidth: 100%;\\n\\tpadding: 0;\\n}\\n\\n/*\\n** Table of contents\\n*/\\n\\n.tc-sidebar-lists .tc-table-of-contents {\\n\\twhite-space: nowrap;\\n}\\n\\n.tc-table-of-contents button,\\n.tc-table-of-contents .toc-item-muted {\\n\\tcolor: \u003C\u003Ccolour sidebar-foreground&gt;&gt;;\\n}\\n\\n.tc-table-of-contents svg {\\n\\twidth: 0.7em;\\n\\theight: 0.7em;\\n\\tvertical-align: middle;\\n\\tfill: \u003C\u003Ccolour sidebar-foreground&gt;&gt;;\\n}\\n\\n.tc-table-of-contents ol {\\n\\tlist-style-type: none;\\n\\tpadding-left: 0;\\n}\\n\\n.tc-table-of-contents ol ol {\\n\\tpadding-left: 1em;\\n}\\n\\n.tc-table-of-contents li {\\n\\tfont-size: 1.0em;\\n\\tfont-weight: bold;\\n}\\n\\n.tc-table-of-contents li a {\\n\\tfont-weight: bold;\\n}\\n\\n.tc-table-of-contents li li {\\n\\tfont-size: 0.95em;\\n\\tfont-weight: normal;\\n\\tline-height: 1.4;\\n}\\n\\n.tc-table-of-contents li li a {\\n\\tfont-weight: normal;\\n}\\n\\n.tc-table-of-contents li li li {\\n\\tfont-size: 0.95em;\\n\\tfont-weight: normal;\\n\\tline-height: 1.5;\\n}\\n\\n.tc-table-of-contents li li li li {\\n\\tfont-size: 0.95em;\\n\\tfont-weight: normal;\\n}\\n\\n.tc-tabbed-table-of-contents {\\n\\tdisplay: -webkit-flex;\\n\\tdisplay: flex;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents {\\n\\tz-index: 100;\\n\\tdisplay: inline-block;\\n\\tpadding-left: 1em;\\n\\tmax-width: 50%;\\n\\t-webkit-flex: 0 0 auto;\\n\\tflex: 0 0 auto;\\n\\tbackground: \u003C\u003Ccolour tab-background&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item &gt; a,\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item-selected &gt; a {\\n\\tdisplay: block;\\n\\tpadding: 0.12em 1em 0.12em 0.25em;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item &gt; a {\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-background&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-background&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tab-background&gt;&gt;;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item &gt; a:hover {\\n\\ttext-decoration: none;\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour tab-border&gt;&gt;;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item-selected &gt; a {\\n\\tborder-top: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-left: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tmargin-right: -1px;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-table-of-contents .toc-item-selected &gt; a:hover {\\n\\ttext-decoration: none;\\n}\\n\\n.tc-tabbed-table-of-contents .tc-tabbed-table-of-contents-content {\\n\\tdisplay: inline-block;\\n\\tvertical-align: top;\\n\\tpadding-left: 1.5em;\\n\\tpadding-right: 1.5em;\\n\\tborder: 1px solid \u003C\u003Ccolour tab-border&gt;&gt;;\\n\\t-webkit-flex: 1 0 50%;\\n\\tflex: 1 0 50%;\\n}\\n\\n/*\\n** Dirty indicator\\n*/\\n\\nhtml body svg.tc-image-save-button-dynamic .tc-image-save-button-dynamic-clean {\\n\\tvisibility: visible;\\n}\\n\\nhtml body svg.tc-image-save-button-dynamic .tc-image-save-button-dynamic-dirty {\\n\\tvisibility: hidden;\\n}\\n\\nhtml body.tc-dirty svg.tc-image-save-button-dynamic .tc-image-save-button-dynamic-clean {\\n\\tvisibility: hidden;\\n}\\n\\nhtml body.tc-dirty svg.tc-image-save-button-dynamic .tc-image-save-button-dynamic-dirty {\\n\\tvisibility: visible;\\n}\\n\\nhtml body.tc-dirty span.tc-dirty-indicator, html body.tc-dirty span.tc-dirty-indicator svg {\\n\\tfill: \u003C\u003Ccolour dirty-indicator&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour dirty-indicator&gt;&gt;;\\n}\\n\\n/*\\n** File inputs\\n*/\\n\\n.tc-file-input-wrapper {\\n\\tposition: relative;\\n\\toverflow: hidden;\\n\\tdisplay: inline-block;\\n\\tvertical-align: middle;\\n}\\n\\n.tc-file-input-wrapper input[type=file] {\\n\\tposition: absolute;\\n\\ttop: 0;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tbottom: 0;\\n\\tfont-size: 999px;\\n\\tmax-width: 100%;\\n\\tmax-height: 100%;\\n\\tfilter: alpha(opacity=0);\\n\\topacity: 0;\\n\\toutline: none;\\n\\tbackground: white;\\n\\tcursor: pointer;\\n\\tdisplay: inline-block;\\n}\\n\\n::-webkit-file-upload-button {\\n\\tcursor:pointer;\\n}\\n\\n/*\\n** Thumbnail macros\\n*/\\n\\n.tc-thumbnail-wrapper {\\n\\tposition: relative;\\n\\tdisplay: inline-block;\\n\\tmargin: 6px;\\n\\tvertical-align: top;\\n}\\n\\n.tc-thumbnail-right-wrapper {\\n\\tfloat:right;\\n\\tmargin: 0.5em 0 0.5em 0.5em;\\n}\\n\\n.tc-thumbnail-image {\\n\\ttext-align: center;\\n\\toverflow: hidden;\\n\\tborder-radius: 3px;\\n}\\n\\n.tc-thumbnail-image svg,\\n.tc-thumbnail-image img {\\n\\tfilter: alpha(opacity=1);\\n\\topacity: 1;\\n\\tmin-width: 100%;\\n\\tmin-height: 100%;\\n\\tmax-width: 100%;\\n}\\n\\n.tc-thumbnail-wrapper:hover .tc-thumbnail-image svg,\\n.tc-thumbnail-wrapper:hover .tc-thumbnail-image img {\\n\\tfilter: alpha(opacity=0.8);\\n\\topacity: 0.8;\\n}\\n\\n.tc-thumbnail-background {\\n\\tposition: absolute;\\n\\tborder-radius: 3px;\\n}\\n\\n.tc-thumbnail-icon svg,\\n.tc-thumbnail-icon img {\\n\\twidth: 3em;\\n\\theight: 3em;\\n\\t\u003C\u003Cfilter \\\&quot;drop-shadow(2px 2px 4px rgba(0,0,0,0.3))\\\&quot;&gt;&gt;\\n}\\n\\n.tc-thumbnail-wrapper:hover .tc-thumbnail-icon svg,\\n.tc-thumbnail-wrapper:hover .tc-thumbnail-icon img {\\n\\tfill: #fff;\\n\\t\u003C\u003Cfilter \\\&quot;drop-shadow(3px 3px 4px rgba(0,0,0,0.6))\\\&quot;&gt;&gt;\\n}\\n\\n.tc-thumbnail-icon {\\n\\tposition: absolute;\\n\\ttop: 0;\\n\\tleft: 0;\\n\\tright: 0;\\n\\tbottom: 0;\\n\\tdisplay: -webkit-flex;\\n\\t-webkit-align-items: center;\\n\\t-webkit-justify-content: center;\\n\\tdisplay: flex;\\n\\talign-items: center;\\n\\tjustify-content: center;\\n}\\n\\n.tc-thumbnail-caption {\\n\\tposition: absolute;\\n\\tbackground-color: #777;\\n\\tcolor: #fff;\\n\\ttext-align: center;\\n\\tbottom: 0;\\n\\twidth: 100%;\\n\\tfilter: alpha(opacity=0.9);\\n\\topacity: 0.9;\\n\\tline-height: 1.4;\\n\\tborder-bottom-left-radius: 3px;\\n\\tborder-bottom-right-radius: 3px;\\n}\\n\\n.tc-thumbnail-wrapper:hover .tc-thumbnail-caption {\\n\\tfilter: alpha(opacity=1);\\n\\topacity: 1;\\n}\\n\\n/*\\n** Diffs\\n*/\\n\\n.tc-diff-equal {\\n\\tbackground-color: \u003C\u003Ccolour diff-equal-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour diff-equal-foreground&gt;&gt;;\\n}\\n\\n.tc-diff-insert {\\n\\tbackground-color: \u003C\u003Ccolour diff-insert-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour diff-insert-foreground&gt;&gt;;\\n}\\n\\n.tc-diff-delete {\\n\\tbackground-color: \u003C\u003Ccolour diff-delete-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour diff-delete-foreground&gt;&gt;;\\n}\\n\\n.tc-diff-invisible {\\n\\tbackground-color: \u003C\u003Ccolour diff-invisible-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour diff-invisible-foreground&gt;&gt;;\\n}\\n\\n.tc-diff-tiddlers th {\\n\\ttext-align: right;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tfont-weight: normal;\\n\\tfont-style: italic;\\n}\\n\\n.tc-diff-tiddlers pre {\\n\\tmargin: 0;\\n\\tpadding: 0;\\n\\tborder: none;\\n\\tbackground: none;\\n}\\n\\n/*\\n** Errors\\n*/\\n\\n.tc-error {\\n\\tbackground: #f00;\\n\\tcolor: #fff;\\n}\\n\\n/*\\n** Tree macro\\n*/\\n\\n.tc-tree div {\\n\\tpadding-left: 14px;\\n}\\n\\n.tc-tree ol {\\n\\tlist-style-type: none;\\n\\tpadding-left: 0;\\n\\tmargin-top: 0;\\n}\\n\\n.tc-tree ol ol {\\n\\tpadding-left: 1em;\\n}\\n\\n.tc-tree button {\\n\\tcolor: #acacac;\\n}\\n\\n.tc-tree svg {\\n\\tfill: #acacac;\\n}\\n\\n.tc-tree span svg {\\n\\twidth: 1em;\\n\\theight: 1em;\\n\\tvertical-align: baseline;\\n}\\n\\n.tc-tree li span {\\n\\tcolor: lightgray;\\n}\\n\\nselect {\\n\\tcolor: \u003C\u003Ccolour select-tag-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour select-tag-background&gt;&gt;;\\n}\\n\\n/*\\n** Translink macro\\n*/\\n\\n.tc-translink {\\n\\tbackground-color: \u003C\u003Ccolour pre-background&gt;&gt;;\\n\\tborder: 1px solid \u003C\u003Ccolour pre-border&gt;&gt;;\\n\\tpadding: 0 3px;\\n\\tborder-radius: 3px;\\n}\\n\\ndiv.tc-translink &gt; div {\\n\\tmargin: 1em;\\n}\\n\\ndiv.tc-translink &gt; div &gt; a:first-child &gt; h1 {\\n\\tfont-size: 1.2em;\\n\\tfont-weight: bold;\\n}\\n\\nspan.tc-translink &gt; a:first-child {\\n\\tfont-weight: bold;\\n}\\n\\n/*\\n** Classes for displaying globals\\n*/\\n\\n.tc-global-tiddler-body {\\n\\tpadding: 0.25em;\\n\\tborder: 1px solid \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-radius: 3px;\\n}\\n\\n.tc-global-tiddler-body-heading {\\n\\tmargin: 0 0 0.25em 0;\\n\\tfont-weight: normal;\\n}\\n\\n.tc-global-tiddler-body-type {\\n\\tmargin: 0 0 0.25em 0;\\n\\tborder-bottom: 1px solid \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n.tc-global-tiddler-body-details {\\n\\tbackground-color: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-global-tiddler-body pre {\\n\\tmargin: 0;\\n\\tborder: 1px solid \u003C\u003Ccolour foreground&gt;&gt;;\\n}\\n\\n/*\\n** Utility classes for SVG icons\\n*/\\n\\n.tc-fill-background {\\n\\tfill: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-network-activity-background {\\n\\tfill: \u003C\u003Ccolour network-activity-foreground&gt;&gt;;\\n}\\n\\n/*\\n** Test Cases\\n*/\\n\\n.tc-test-case-wrapper {\\n\\tborder: 1px solid \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tborder-radius: 6px;\\n}\\n\\n.tc-test-case-wrapper {\\n\\tbackground-color: \u003C\u003Ccolour testcase-accent-level-1&gt;&gt;;\\n}\\n\\n.tc-test-case-wrapper .tc-test-case-wrapper {\\n\\tbackground-color: \u003C\u003Ccolour testcase-accent-level-2&gt;&gt;;\\n}\\n\\n.tc-test-case-wrapper .tc-test-case-wrapper .tc-test-case-wrapper {\\n\\tbackground-color: \u003C\u003Ccolour testcase-accent-level-3&gt;&gt;;\\n}\\n\\n.tc-test-case-header {\\n\\tfont-weight: normal;\\n\\tmargin: 0.5em 0;\\n\\tpadding: 0 0.5em;\\n}\\n\\n.tc-test-case-divider {\\n\\tx-background-color: \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n}\\n\\n.tc-test-case-result-icon {\\n\\tfill: #fff;\\n\\tpadding: 0.25em;\\n\\tdisplay: inline-block;\\n\\tline-height: 0;\\n\\tborder-radius: 1em;\\n\\tvertical-align: text-bottom;\\n\\tmargin-right: 0.25em;\\n}\\n\\n.tc-test-case-result-icon-pass {\\n\\tbackground-color: green;\\n}\\n\\n.tc-test-case-result-icon-fail {\\n\\tbackground-color: red;\\n}\\n\\n.tc-test-case-result-icon svg {\\n\\twidth: 0.5em;\\n\\theight: 0.5em;\\n}\\n\\n.tc-test-case-header &gt; h2 {\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder-radius: 4px;\\n\\tpadding: 0.25em;\\n}\\n\\n.tc-test-case-header &gt; h2,\\n.tc-test-case-source &gt; pre {\\n\\tmargin: 0;\\n}\\n\\n.tc-test-case-header &gt; h2 a.tc-tiddlylink-missing {\\n\\tfont-style: normal;\\n}\\n\\n.tc-test-case-toolbar {\\n\\tfloat: right;\\n}\\n\\n.tc-test-case-toolbar svg {\\n\\tfill: \u003C\u003Ccolour tiddler-controls-foreground&gt;&gt;;\\n}\\n\\n.tc-test-case-toolbar .tc-drop-down {\\n\\tfont-size: 0.8em;\\n}\\n\\n.tc-test-case-result-fail {\\n\\tborder: 1px solid \u003C\u003Ccolour foreground&gt;&gt;;\\n\\tbackground-color: \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder-radius: 4px;\\n\\tmargin: 0 0.5em;\\n\\tpadding: 0;\\n}\\n\\n.tc-test-case-result-fail-header {\\n\\tbackground: \u003C\u003Ccolour diff-delete-background&gt;&gt;;\\n\\tcolor: \u003C\u003Ccolour diff-delete-foreground&gt;&gt;;\\n\\tborder-top-left-radius: 4px;\\n\\tborder-top-right-radius: 4px;\\n\\tpadding: 4px;\\n}\\n\\n.tc-test-case-result-fail-body {\\n\\tpadding: 4px;\\n}\\n\\n.tc-test-case-source &gt; pre {\\n\\theight: 100%;\\n}\\n\\n.tc-test-case-narrative {\\n\\tpadding: 0.5em;\\n}\\n\\n.tc-test-case-panes {\\n\\tdisplay: flex;\\n\\talign-items: stretch;\\n\\tflex-wrap: wrap;\\n\\tpadding: 0.5em;\\n\\tborder-bottom-left-radius: 6px;\\n\\tborder-bottom-right-radius: 6px;\\n}\\n\\n.tc-test-case-source {\\n\\tflex: 1 0 49%;\\n\\tmin-width: 250px;\\n}\\n\\n.tc-test-case-source .tc-tab-content {\\n\\tbackground: inherit;\\n\\tmargin: 0;\\n}\\n\\n.tc-test-case-source .tc-tab-content .tc-field-table {\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n}\\n\\n.tc-test-case-source .tc-field-table {\\n\\twidth: 100%;\\n}\\n\\n.tc-test-case-source table.tc-field-table {\\n\\tmargin: 0;\\n}\\n\\n.tc-test-case-source .tc-tiddler-frame .tc-edit-texteditor {\\n\\tmargin: 0;\\n}\\n\\n.tc-test-case-divider {\\n\\tflex: 0 0 1.5%;\\n}\\n\\n.tc-test-case-source .tc-tab-buttons {\\n\\tpadding-top: 0;\\n}\\n\\n.tc-test-case-footer-toolbar {\\n\\tdisplay: flex;\\n\\tjustify-content: flex-end;\\n}\\n\\n.tc-test-case-output {\\n\\tbox-shadow: inset 2px 2px 10px 0px \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tbackground: \u003C\u003Ccolour background&gt;&gt;;\\n\\tborder-radius: 4px;\\n\\tborder: 1px solid \u003C\u003Ccolour muted-foreground&gt;&gt;;\\n\\tflex: 1 0 49%;\\n\\tmin-width: 250px;\\n\\tpadding: 0.25em 1em;\\n}\\n\\n/*\\n** Flexbox utility classes\\n*/\\n\\n.tc-flex {\\n\\tdisplay: -webkit-flex;\\n\\tdisplay: flex;\\n}\\n\\n.tc-flex-column {\\n\\tflex-direction: column;\\n}\\n\\n.tc-flex-row {\\n\\tflex-direction: row;\\n}\\n\\n.tc-flex-grow-1 {\\n\\tflex-grow: 1;\\n}\\n\\n.tc-flex-grow-2 {\\n\\tflex-grow: 2;\\n}\\n\\n/*\\n** Other utility classes\\n*/\\n\\n/* Horizontal gaps */\\n\\n.tc-tiny-gap {\\n\\tmargin-left: .25em;\\n\\tmargin-right: .25em;\\n}\\n\\n.tc-tiny-gap-left {\\n\\tmargin-left: .25em;\\n}\\n\\n.tc-tiny-gap-right {\\n\\tmargin-right: .25em;\\n}\\n\\n.tc-small-gap {\\n\\tmargin-left: .5em;\\n\\tmargin-right: .5em;\\n}\\n\\n.tc-small-gap-left {\\n\\tmargin-left: .5em;\\n}\\n\\n.tc-small-gap-right {\\n\\tmargin-right: .5em;\\n}\\n\\n.tc-big-gap {\\n\\tmargin-left: 1em;\\n\\tmargin-right: 1em;\\n}\\n\\n.tc-big-gap-left {\\n\\tmargin-left: 1em;\\n}\\n\\n.tc-big-gap-right {\\n\\tmargin-right: 1em;\\n}\\n\\n.tc-word-break {\\n\\tword-break: break-all;\\n}\\n\\n/* Vertical gaps */\\n\\n.tc-tiny-v-gap-bottom {\\n\\tmargin-bottom: 3px;\\n}\\n\\n\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodyfontsize\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodyfontsize\&quot;,\&quot;text\&quot;:\&quot;15px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodylineheight\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/bodylineheight\&quot;,\&quot;text\&quot;:\&quot;22px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/fontsize\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/fontsize\&quot;,\&quot;text\&quot;:\&quot;14px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/lineheight\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/lineheight\&quot;,\&quot;text\&quot;:\&quot;20px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyleft\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyleft\&quot;,\&quot;text\&quot;:\&quot;0px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/storytop\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/storytop\&quot;,\&quot;text\&quot;:\&quot;0px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyright\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/storyright\&quot;,\&quot;text\&quot;:\&quot;770px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/storywidth\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/storywidth\&quot;,\&quot;text\&quot;:\&quot;770px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/tiddlerwidth\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/tiddlerwidth\&quot;,\&quot;text\&quot;:\&quot;686px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarbreakpoint\&quot;,\&quot;text\&quot;:\&quot;960px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/metrics/sidebarwidth\&quot;,\&quot;text\&quot;:\&quot;350px\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/options/stickytitles\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/options/stickytitles\&quot;,\&quot;text\&quot;:\&quot;no\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/options/sidebarlayout\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/options/sidebarlayout\&quot;,\&quot;text\&quot;:\&quot;fixed-fluid\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/options/codewrapping\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/options/codewrapping\&quot;,\&quot;text\&quot;:\&quot;pre-wrap\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/reset\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/reset\&quot;,\&quot;type\&quot;:\&quot;text/css\&quot;,\&quot;text\&quot;:\&quot;/*! modern-normalize v2.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */\\n\\n/*\\nDocument\\n========\\n*/\\n\\n/**\\nUse a better box model (opinionated).\\n*/\\n\\n*,\\n::before,\\n::after {\\n\\tbox-sizing: border-box;\\n}\\n\\nhtml {\\n\\t/* Improve consistency of default fonts in all browsers. (https://github.com/sindresorhus/modern-normalize/issues/3) */\\n\\tfont-family:\\n\\t\\tsystem-ui,\\n\\t\\t'Segoe UI',\\n\\t\\tRoboto,\\n\\t\\tHelvetica,\\n\\t\\tArial,\\n\\t\\tsans-serif,\\n\\t\\t'Apple Color Emoji',\\n\\t\\t'Segoe UI Emoji';\\n\\tline-height: 1.15; /* 1. Correct the line height in all browsers. */\\n\\t-webkit-text-size-adjust: 100%; /* 2. Prevent adjustments of font size after orientation changes in iOS. */\\n\\t-moz-tab-size: 4; /* 3. Use a more readable tab size (opinionated). */\\n\\ttab-size: 4; /* 3 */\\n}\\n\\n/*\\nSections\\n========\\n*/\\n\\nbody {\\n\\tmargin: 0; /* Remove the margin in all browsers. */\\n}\\n\\n/*\\nGrouping content\\n================\\n*/\\n\\n/**\\n1. Add the correct height in Firefox.\\n2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)\\n*/\\n\\nhr {\\n\\theight: 0; /* 1 */\\n\\tcolor: inherit; /* 2 */\\n}\\n\\n/*\\nText-level semantics\\n====================\\n*/\\n\\n/**\\nAdd the correct text decoration in Chrome, Edge, and Safari.\\n*/\\n\\nabbr[title] {\\n\\ttext-decoration: underline dotted;\\n}\\n\\n/**\\nAdd the correct font weight in Edge and Safari.\\n*/\\n\\nb,\\nstrong {\\n\\tfont-weight: bolder;\\n}\\n\\n/**\\n1. Improve consistency of default fonts in all browsers. (https://github.com/sindresorhus/modern-normalize/issues/3)\\n2. Correct the odd 'em' font sizing in all browsers.\\n*/\\n\\ncode,\\nkbd,\\nsamp,\\npre {\\n\\tfont-family:\\n\\t\\tui-monospace,\\n\\t\\tSFMono-Regular,\\n\\t\\tConsolas,\\n\\t\\t'Liberation Mono',\\n\\t\\tMenlo,\\n\\t\\tmonospace; /* 1 */\\n\\tfont-size: 1em; /* 2 */\\n}\\n\\n/**\\nAdd the correct font size in all browsers.\\n*/\\n\\nsmall {\\n\\tfont-size: 80%;\\n}\\n\\n/**\\nPrevent 'sub' and 'sup' elements from affecting the line height in all browsers.\\n*/\\n\\nsub,\\nsup {\\n\\tfont-size: 75%;\\n\\tline-height: 0;\\n\\tposition: relative;\\n\\tvertical-align: baseline;\\n}\\n\\nsub {\\n\\tbottom: -0.25em;\\n}\\n\\nsup {\\n\\ttop: -0.5em;\\n}\\n\\n/*\\nTabular data\\n============\\n*/\\n\\n/**\\n1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)\\n2. Correct table border color inheritance in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)\\n*/\\n\\ntable {\\n\\ttext-indent: 0; /* 1 */\\n\\tborder-color: inherit; /* 2 */\\n}\\n\\n/*\\nForms\\n=====\\n*/\\n\\n/**\\n1. Change the font styles in all browsers.\\n2. Remove the margin in Firefox and Safari.\\n*/\\n\\nbutton,\\ninput,\\noptgroup,\\nselect,\\ntextarea {\\n\\tfont-family: inherit; /* 1 */\\n\\tfont-size: 100%; /* 1 */\\n\\tline-height: 1.15; /* 1 */\\n\\tmargin: 0; /* 2 */\\n}\\n\\n/**\\nRemove the inheritance of text transform in Edge and Firefox.\\n*/\\n\\nbutton,\\nselect {\\n\\ttext-transform: none;\\n}\\n\\n/**\\nCorrect the inability to style clickable types in iOS and Safari.\\n*/\\n\\nbutton,\\n[type='button'],\\n[type='reset'],\\n[type='submit'] {\\n\\t-webkit-appearance: button;\\n}\\n\\n/**\\nRemove the inner border and padding in Firefox.\\n*/\\n\\n::-moz-focus-inner {\\n\\tborder-style: none;\\n\\tpadding: 0;\\n}\\n\\n/**\\nRestore the focus styles unset by the previous rule.\\n*/\\n\\n:-moz-focusring {\\n\\toutline: 1px dotted ButtonText;\\n}\\n\\n/**\\nRemove the additional ':invalid' styles in Firefox.\\nSee: https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737\\n*/\\n\\n:-moz-ui-invalid {\\n\\tbox-shadow: none;\\n}\\n\\n/**\\nRemove the padding so developers are not caught out when they zero out 'fieldset' elements in all browsers.\\n*/\\n\\nlegend {\\n\\tpadding: 0;\\n}\\n\\n/**\\nAdd the correct vertical alignment in Chrome and Firefox.\\n*/\\n\\nprogress {\\n\\tvertical-align: baseline;\\n}\\n\\n/**\\nCorrect the cursor style of increment and decrement buttons in Safari.\\n*/\\n\\n::-webkit-inner-spin-button,\\n::-webkit-outer-spin-button {\\n\\theight: auto;\\n}\\n\\n/**\\n1. Correct the odd appearance in Chrome and Safari.\\n2. Correct the outline style in Safari.\\n*/\\n\\n[type='search'] {\\n\\t-webkit-appearance: textfield; /* 1 */\\n\\toutline-offset: -2px; /* 2 */\\n}\\n\\n/**\\nRemove the inner padding in Chrome and Safari on macOS.\\n*/\\n\\n::-webkit-search-decoration {\\n\\t-webkit-appearance: none;\\n}\\n\\n/**\\n1. Correct the inability to style clickable types in iOS and Safari.\\n2. Change font properties to 'inherit' in Safari.\\n*/\\n\\n::-webkit-file-upload-button {\\n\\t-webkit-appearance: button; /* 1 */\\n\\tfont: inherit; /* 2 */\\n}\\n\\n/*\\nInteractive\\n===========\\n*/\\n\\n/*\\nAdd the correct display in Chrome and Safari.\\n*/\\n\\nsummary {\\n\\tdisplay: list-item;\\n}\\n\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/settings/fontfamily\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/settings/fontfamily\&quot;,\&quot;text\&quot;:\&quot;-apple-system, BlinkMacSystemFont, \\\&quot;Segoe UI\\\&quot;, \\\&quot;Noto Sans\\\&quot;, sans-serif, Helvetica, Arial, \\\&quot;Apple Color Emoji\\\&quot;, \\\&quot;Segoe UI Emoji\\\&quot;\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/settings/codefontfamily\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/settings/codefontfamily\&quot;,\&quot;text\&quot;:\&quot;ui-monospace, \\\&quot;SFMono-Regular\\\&quot;, \\\&quot;SF Mono\\\&quot;, Menlo, Consolas, \\\&quot;Liberation Mono\\\&quot;, monospace\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimageattachment\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimageattachment\&quot;,\&quot;text\&quot;:\&quot;fixed\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/settings/backgroundimagesize\&quot;,\&quot;text\&quot;:\&quot;auto\&quot;},\&quot;$:/themes/tiddlywiki/vanilla/sticky\&quot;:{\&quot;title\&quot;:\&quot;$:/themes/tiddlywiki/vanilla/sticky\&quot;,\&quot;code-body\&quot;:\&quot;yes\&quot;,\&quot;text\&quot;:\&quot;\u003C$reveal state=\\\&quot;$:/themes/tiddlywiki/vanilla/options/stickytitles\\\&quot; type=\\\&quot;match\\\&quot; text=\\\&quot;yes\\\&quot;&gt;\\n``\\n.tc-tiddler-title {\\n\\tposition: -webkit-sticky;\\n\\tposition: -moz-sticky;\\n\\tposition: -o-sticky;\\n\\tposition: -ms-sticky;\\n\\tposition: sticky;\\n\\ttop: 0px;\\n\\tbackground: ``\u003C\u003Ccolour tiddler-background&gt;&gt;``;\\n\\tz-index: 500;\\n}\\n\\n``\\n\u003C$list filter=\\\&quot;[range[100]]\\\&quot;&gt;\\n`.tc-story-river .tc-tiddler-frame:nth-child(100n+`\u003C$text text=\u003C\u003CcurrentTiddler&gt;&gt;/&gt;`) {\\nz-index: `\u003C$text text={{{ [[200]subtract\u003CcurrentTiddler&gt;] }}}/&gt;`;\\n}\\n`\\n\u003C/$list&gt;\\n\u003C/$reveal&gt;\\n\&quot;}}}&quot;}
]&lt;/script&gt;&lt;div id=&quot;storeArea&quot; style=&quot;display:none;&quot;&gt;&lt;/div&gt;
&lt;!--~~ Raw markup for the bottom of the body section ~~--&gt;

&lt;!--~~ Load external JavaScripts ~~--&gt;
&lt;script src=&quot;tiddlywikicore-5.3.7.js&quot; onerror=&quot;alert('Error: Cannot load tiddlywikicore-5.3.7.js');&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
<div title="ToolbarCommands" creator="YourName" modifier="YourName" created="202507191924" changecount="1">
<pre>|~ViewToolbar|closeTiddler closeOthers +editTiddler jsonEdit &gt; fields permalink references jump|
|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|</pre>
</div>
<div title="VerticalSplitScreenPlugin" creator="Yanshu Wang" modifier="YourName" created="202507191922" modified="202507191947" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name        |VerticalSplitScreenPlugin|
|Description |Opens a new pop-up window with a vertical split view, displaying the current page and another URL in a frameset.|
|Source      |https://github.com/wangyenshu/VerticalSplitScreenPlugin/blob/main/VerticalSplitScreenPlugin.js|
|Version     |0.1|
|Author      |Yanshu Wang, with the help of AI|
|License     |MIT|
|~CoreVersion|2.x|
|Type        |plugin|
!!!!!Documentation
Use the {{{&lt;&lt;VerticalSplitScreen&gt;&gt;}}} macro to display a button that launches the vertical split-screen browser.
It will open in a new pop-up window, prompting for a URL for the right pane.
&lt;&lt;VerticalSplitScreen&gt;&gt;
!!!!!Code
***/
//{{{
config.macros.VerticalSplitScreen = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Create a button element
        var button = document.createElement(&quot;button&quot;);
        button.innerText = &quot;Open Vertical Split Screen&quot;; // Text displayed on the button
        button.title = &quot;Click to open a vertical split screen view on the current page&quot;; // Tooltip

        // Add basic styling classes for consistency with TiddlyWiki buttons
        button.className = &quot;tiddlyLink button&quot;;

        button.onclick = function() {
            var href = location.href;
            // Prompt for the URL for the right frame.
            var website = prompt('Please enter the URL for the right pane:', '') || href;

            // Remove any existing split screen containers or close buttons before creating new ones
            var existingContainer = document.getElementById(&quot;verticalSplitScreenContainer&quot;);
            if (existingContainer) {
                document.body.removeChild(existingContainer);
            }
            var existingCloseButton = document.getElementById(&quot;verticalSplitScreenCloseButton&quot;);
            if (existingCloseButton) {
                document.body.removeChild(existingCloseButton);
            }

            // Create the main container for the split view
            var splitContainer = document.createElement(&quot;div&quot;);
            splitContainer.setAttribute(&quot;id&quot;, &quot;verticalSplitScreenContainer&quot;);
            splitContainer.style.position = &quot;fixed&quot;;
            splitContainer.style.left = &quot;0&quot;;
            splitContainer.style.top = &quot;0&quot;;
            splitContainer.style.width = &quot;100vw&quot;;
            splitContainer.style.height = &quot;100vh&quot;;
            splitContainer.style.zIndex = &quot;99999&quot;; // High z-index to overlay content
            splitContainer.style.display = &quot;flex&quot;; // Use flexbox for side-by-side layout
            splitContainer.style.border = &quot;none&quot;;
            splitContainer.style.margin = &quot;0&quot;;
            splitContainer.style.padding = &quot;0&quot;;
            splitContainer.style.backgroundColor = &quot;white&quot;; // Ensure background is solid if iframes don't load fully

            // Create the left iframe for the current page
            var leftIframe = document.createElement(&quot;iframe&quot;);
            leftIframe.style.width = &quot;50%&quot;;
            leftIframe.style.height = &quot;100%&quot;;
            leftIframe.style.border = &quot;none&quot;;
            leftIframe.style.margin = &quot;0&quot;;
            leftIframe.style.padding = &quot;0&quot;;
            leftIframe.src = href; // Load current page into left iframe

            // Create the right iframe for the specified website
            var rightIframe = document.createElement(&quot;iframe&quot;);
            rightIframe.style.width = &quot;50%&quot;;
            rightIframe.style.height = &quot;100%&quot;;
            rightIframe.style.border = &quot;none&quot;;
            rightIframe.style.margin = &quot;0&quot;;
            rightIframe.style.padding = &quot;0&quot;;
            rightIframe.src = website; // Load user-specified website into right iframe

            // Append iframes to the container
            splitContainer.appendChild(leftIframe);
            splitContainer.appendChild(rightIframe);

            // Append the container to the document body
            document.body.appendChild(splitContainer);

            // Create a close button for the split view
            var closeButton = document.createElement(&quot;button&quot;);
            closeButton.innerText = &quot;Close Split View&quot;;
            closeButton.style.position = &quot;fixed&quot;;
            closeButton.style.top = &quot;10px&quot;;
            closeButton.style.right = &quot;10px&quot;;
            closeButton.style.zIndex = &quot;100000&quot;; // Higher than iframe container
            closeButton.style.padding = &quot;5px 10px&quot;;
            closeButton.style.borderRadius = &quot;5px&quot;;
            closeButton.style.backgroundColor = &quot;#ff4d4d&quot;; // Red color
            closeButton.style.color = &quot;white&quot;;
            closeButton.style.border = &quot;none&quot;;
            closeButton.style.cursor = &quot;pointer&quot;;
            closeButton.setAttribute(&quot;id&quot;, &quot;verticalSplitScreenCloseButton&quot;);

            closeButton.onclick = function() {
                var containerToRemove = document.getElementById(&quot;verticalSplitScreenContainer&quot;);
                if (containerToRemove) {
                    document.body.removeChild(containerToRemove);
                }
                var buttonToRemove = document.getElementById(&quot;verticalSplitScreenCloseButton&quot;);
                if (buttonToRemove) {
                    document.body.removeChild(buttonToRemove);
                }
            };
            document.body.appendChild(closeButton);

            return false; // Prevent default button action
        };

        // Append the main plugin button to the place where the macro is called
        place.appendChild(button);
    }
};
//}}}</pre>
</div>
<div title="innerTW5Plugin" creator="Yanshu Wang" modifier="YourName" created="202507191919" modified="202507191945" tags="systemConfig YSPlugin" changecount="2">
<pre>/***
|Name|innerTW5Plugin|
|Source|https://github.com/wangyenshu/innerTW5Plugin/blob/main/innerTW5Plugin.js|
|Author|Yanshu Wang|
|Version|0.1|
|Type|plugin|
|Description|Embedded Tiddlywiki5 frame inside Tiddlywiki Classic, allowing users to use Tiddlywiki5 Plugins inside Tiddlywiki classic.|
|License|MIT|
!Usage
{{{
&lt;&lt;innerTW5Plugin tid:&quot;innerTW5PluginDemo&quot; tid:&quot;innerTW5PluginMultiDemo&quot; width:&quot;80%&quot; height:&quot;400px&quot;&gt;&gt;
}}}
&lt;&lt;innerTW5Plugin tid:&quot;innerTW5PluginDemo&quot; tid:&quot;innerTW5PluginMultiDemo&quot; width:&quot;80%&quot; height:&quot;400px&quot;&gt;&gt;
!Documentation
This macro will append the content inside the tiddler that the 'tid' parameter calls inside this place in [[TW5Sandbox]]
{{{
&lt;!--~~ Ordinary tiddlers ~~--&gt;
&lt;script class=&quot;tiddlywiki-tiddler-store&quot; type=&quot;application/json&quot;&gt;[
]&lt;/script&gt;&lt;div id=&quot;storeArea&quot; 
}}}
in order. In the example, it will append the content in [[innerTW5PluginDemo]] then append the content in [[innerTW5PluginMultiDemo]] to that place in [[TW5Sandbox]] and display it in an iframe.
So the content should be in JSON format, see [[innerTW5PluginDemo]] for an example.
Edit the template TW5 in [[TW5Sandbox]].
The default tiddler for [[TW5Sandbox]] is configured as {{{TW5Sandbox}}}.
Example [[innerTW5PluginDemoD3]] shows how to use D3 plugin in TW5 in TWC.
This macro works for Firefox but not Chrome. Since Chrome does not support loading iframe of size greater than 2MB.

The following bookmarklet simplify the json editing:
{{{
javascript:w=window.open('','Links','scrollbars,resizable,width=640,height=550');w.document.write('&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1.0&quot;&gt;&lt;title&gt;TiddlyWiki Tiddler JSON Editor&lt;/title&gt;&lt;style&gt;body{font-family:\'Inter\',sans-serif;margin:0;padding:20px;min-height:100vh;display:flex;align-items:center;justify-content:center;background-color:#f0f0f0;}@media(max-width:768px){body{padding:10px;}.container{padding:15px;}.flex-buttons%20button{width:100%;min-width:unset;}.message-box-content{padding:15px;}}@media(min-width:769px){.container{max-width:800px;}}.container{background-color:#fff;padding:30px;border-radius:10px;box-shadow:0%204px%2015px%20rgba(0,0,0,.1);width:100%;box-sizing:border-box;}h1{text-align:center;margin-bottom:20px;}p{text-align:center;margin-bottom:20px;}textarea,input[type=&quot;text&quot;]{width:100%;padding:8px;margin-bottom:10px;border:1px%20solid%20#ccc;border-radius:4px;box-sizing:border-box;}textarea{resize:vertical;}button{padding:10px%2015px;border:none;border-radius:5px;cursor:pointer;background-color:#007bff;color:white;margin-right:10px;}button:hover{background-color:#0056b3;}#fieldEditor,#jsonOutput,#messageBox{display:none;}#messageBox{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;}#messageBox&gt;div{background-color:white;padding:20px;border-radius:8px;box-shadow:0%204px%2010px%20rgba(0,0,0,.2);max-width:400px;width:100%;text-align:center;}#messageText{margin-bottom:15px;}.flex-buttons{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:20px;}.flex-buttons%20button{flex:1;min-width:120px;}.field-group{margin-bottom:10px;}.border-top{border-top:1px%20solid%20#eee;padding-top:20px;margin-top:20px;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div%20class=&quot;container&quot;&gt;&lt;h1&gt;TiddlyWiki%20Tiddler%20JSON%20Editor&lt;/h1&gt;&lt;p&gt;Paste%20a%20tiddler\'s%20JSON%20below%20to%20edit%20its%20fields.&lt;br&gt;Modify%20the%20fields,%20then%20click%20&quot;Generate%20JSON&quot;%20to%20see%20the%20updated%20output.&lt;/p&gt;&lt;div%20id=&quot;initialJsonInput&quot;&gt;&lt;label%20for=&quot;inputJson&quot;&gt;Paste%20Tiddler%20JSON%20Here:&lt;/label&gt;&lt;textarea%20id=&quot;inputJson&quot;rows=&quot;10&quot;placeholder=\'{\n%20%20%20%20&quot;title&quot;:%20&quot;My%20Example%20Tiddler&quot;,\n%20%20%20%20&quot;text&quot;:%20&quot;This%20is%20some%20example%20text%20for%20the%20tiddler.%20You%20can%20[[edit]]%20it.&quot;,\n%20%20%20%20&quot;tags&quot;:%20&quot;example%20demo&quot;,\n%20%20%20%20&quot;created&quot;:%20&quot;20250622100000000&quot;,\n%20%20%20%20&quot;modified&quot;:%20&quot;20250622100000000&quot;,\n%20%20%20%20&quot;modifier&quot;:%20&quot;TiddlyWikiUser&quot;,\n%20%20%20%20&quot;type&quot;:%20&quot;text/vnd.tiddlywiki&quot;,\n%20%20%20%20&quot;customField1&quot;:%20&quot;Custom%20Value%201&quot;,\n%20%20%20%20&quot;anotherField&quot;:%20&quot;Another%20custom%20value&quot;\n}\'&gt;&lt;/textarea&gt;&lt;button%20id=&quot;loadJsonButton&quot;style=&quot;width:100%;&quot;&gt;Load%20Tiddler&lt;/button&gt;&lt;/div&gt;&lt;div%20id=&quot;fieldEditor&quot;style=&quot;display:none;&quot;&gt;&lt;h2&gt;Edit%20Tiddler%20Fields&lt;/h2&gt;&lt;div%20id=&quot;field-container&quot;&gt;&lt;/div&gt;&lt;div%20class=&quot;border-top&quot;&gt;&lt;h3&gt;Add%20New%20Field&lt;/h3&gt;&lt;div%20style=&quot;display:flex;gap:10px;&quot;&gt;&lt;input%20type=&quot;text&quot;id=&quot;newFieldName&quot;style=&quot;flex-grow:1;&quot;placeholder=&quot;Enter%20new%20field%20name%20(e.g.,%20\'my-custom-field\')&quot;&gt;&lt;button%20id=&quot;addNewFieldButton&quot;&gt;Add%20Field&lt;/button&gt;&lt;/div&gt;&lt;/div&gt;&lt;div%20class=&quot;flex-buttons&quot;&gt;&lt;button%20id=&quot;generateJsonButton&quot;&gt;Generate%20JSON&lt;/button&gt;&lt;button%20id=&quot;resetButton&quot;&gt;Reset&lt;/button&gt;&lt;/div&gt;&lt;/div&gt;&lt;div%20id=&quot;jsonOutput&quot;style=&quot;display:none;&quot;&gt;&lt;h2&gt;Generated%20Tiddler%20JSON&lt;/h2&gt;&lt;pre%20id=&quot;jsonCode&quot;style=&quot;background-color:#f9f9f9;padding:10px;border:1px%20solid%20#ddd;border-radius:4px;overflow:auto;max-height:200px;&quot;&gt;&lt;/pre&gt;&lt;button%20id=&quot;copyJsonButton&quot;style=&quot;width:100%;margin-top:10px;&quot;&gt;Copy%20JSON&lt;/button&gt;&lt;/div&gt;&lt;div%20id=&quot;messageBox&quot;style=&quot;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;&quot;&gt;&lt;div%20style=&quot;background-color:white;padding:20px;border-radius:8px;box-shadow:0%204px%2010px%20rgba(0,0,0,.2);max-width:400px;width:100%;text-align:center;&quot;&gt;&lt;p%20id=&quot;messageText&quot;style=&quot;margin-bottom:15px;&quot;&gt;&lt;/p&gt;&lt;button%20id=&quot;messageBoxClose&quot;&gt;OK&lt;/button&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;script&gt;function%20showMessageBox(message){const%20messageBox=document.getElementById(\'messageBox\');const%20messageText=document.getElementById(\'messageText\');messageText.textContent=message;messageBox.style.display=\'flex\';}document.getElementById(\'messageBoxClose\').addEventListener(\'click\',()=&gt;{(document.getElementById(\'messageBox\').style.display=\'none\');});const%20inputJsonTextarea=document.getElementById(\'inputJson\');const%20loadJsonButton=document.getElementById(\'loadJsonButton\');const%20fieldEditorDiv=document.getElementById(\'fieldEditor\');const%20initialJsonInputDiv=document.getElementById(\'initialJsonInput\');const%20fieldContainer=document.getElementById(\'field-container\');const%20generateJsonButton=document.getElementById(\'generateJsonButton\');const%20resetButton=document.getElementById(\'resetButton\');const%20jsonOutputDiv=document.getElementById(\'jsonOutput\');const%20jsonCodePre=document.getElementById(\'jsonCode\');const%20copyJsonButton=document.getElementById(\'copyJsonButton\');const%20newFieldNameInput=document.getElementById(\'newFieldName\');const%20addNewFieldButton=document.getElementById(\'addNewFieldButton\');let%20currentTiddlerData=null;const%20fieldInputs={};function%20createFieldInput(fieldName,fieldValue=\'\'){const%20fieldGroup=document.createElement(\'div\');fieldGroup.className=\'field-group\';const%20label=document.createElement(\'label\');label.textContent=fieldName;label.setAttribute(\'for\',`field-${fieldName}`);fieldGroup.appendChild(label);let%20inputElement;if(fieldName===\'text\'){inputElement=document.createElement(\'textarea\');inputElement.rows=8;}else{inputElement=document.createElement(\'input\');inputElement.type=\'text\';}inputElement.id=`field-${fieldName}`;inputElement.name=fieldName;inputElement.value=fieldValue;fieldGroup.appendChild(inputElement);fieldContainer.appendChild(fieldGroup);fieldInputs[fieldName]=inputElement;}function%20loadTiddlerFields(jsonString){try{currentTiddlerData=JSON.parse(jsonString);fieldContainer.innerHTML=\'\';for(const%20key%20in%20fieldInputs){delete%20fieldInputs[key];}const%20sortedFields=Object.keys(currentTiddlerData).sort((a,b)=&gt;{if(a===\'title\')return-1;if(b===\'title\')return%201;if(a===\'text\')return-1;if(b===\'text\')return%201;return%20a.localeCompare(b);});sortedFields.forEach(fieldName=&gt;{createFieldInput(fieldName,currentTiddlerData[fieldName]);});initialJsonInputDiv.style.display=\'none\';fieldEditorDiv.style.display=\'block\';jsonOutputDiv.style.display=\'none\';}catch(e){showMessageBox(\'Invalid%20JSON%20provided.%20Please%20check%20your%20input.\');console.error(\'JSON%20parsing%20error:\',e);}}loadJsonButton.addEventListener(\'click\',()=&gt;{(json=inputJsonTextarea.value.trim());if(json){loadTiddlerFields(json);}else{showMessageBox(\'Please%20paste%20Tiddler%20JSON%20into%20the%20textarea%20first.\');}});addNewFieldButton.addEventListener(\'click\',()=&gt;{(newFieldName=newFieldNameInput.value.trim());if(newFieldName){if(fieldInputs[newFieldName]){showMessageBox(`Field%20&quot;${newFieldName}&quot;%20already%20exists.`);}else{createFieldInput(newFieldName,\'\');newFieldNameInput.value=\'\';}}else{showMessageBox(\'Please%20enter%20a%20field%20name.\');}});generateJsonButton.addEventListener(\'click\',()=&gt;{(updatedTiddlerData={});for(const%20fieldName%20in%20fieldInputs){if(fieldInputs.hasOwnProperty(fieldName)){updatedTiddlerData[fieldName]=fieldInputs[fieldName].value;}}try{(outputJsonString=JSON.stringify(updatedTiddlerData));jsonCodePre.textContent=outputJsonString;jsonOutputDiv.style.display=\'block\';}catch(e){showMessageBox(\'Error%20generating%20JSON%20from%20fields.%20Please%20check%20your%20field%20values.\');console.error(\'JSON%20stringify%20error:\',e);}});resetButton.addEventListener(\'click\',()=&gt;{(initialJsonInputDiv.style.display=\'block\');fieldEditorDiv.style.display=\'none\';jsonOutputDiv.style.display=\'none\';inputJsonTextarea.value=inputJsonTextarea.placeholder;fieldContainer.innerHTML=\'\';currentTiddlerData=null;for(const%20key%20in%20fieldInputs){delete%20fieldInputs[key];}});document.addEventListener(\'DOMContentLoaded\',()=&gt;{(inputJsonTextarea.value=inputJsonTextarea.placeholder);});copyJsonButton.addEventListener(\'click\',async()=&gt;{(jsonText=jsonCodePre.textContent);if(jsonText){try{await%20navigator.clipboard.writeText(jsonText);showMessageBox(\'JSON%20copied%20to%20clipboard!\');}catch(err){showMessageBox(\'Failed%20to%20copy%20JSON%20to%20clipboard.%20Your%20browser%20might%20require%20user%20interaction%20or%20permissions%20to%20copy.\');console.error(\'Copy%20to%20clipboard%20failed:\',err);}}else{showMessageBox(\'No%20JSON%20to%20copy!\');}});&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;');
}}}
!Todo
Reduce the size of [[TW5Sandbox]].
Add a parameter to configure default tiddler in [[TW5Sandbox]].
!Credit
The example [[innerTW5PluginDemoD3]] use tiddlers in https://tiddlywiki.com/plugins/tiddlywiki/d3/.
***/
//{{{
config.macros.innerTW5Plugin = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler) {
        // Parse parameters &quot;tid&quot;, &quot;width&quot;, and &quot;height&quot;
        var paramsObj = paramString.parseParams(&quot;tid width height&quot;, null, true)[0] || {};
        var tidList = paramsObj.tid || [];
        var iframeWidth = (paramsObj.width &amp;&amp; paramsObj.width.length) ? paramsObj.width[0] : &quot;100%&quot;;
        var iframeHeight = (paramsObj.height &amp;&amp; paramsObj.height.length) ? paramsObj.height[0] : &quot;600px&quot;;
        
        if(tidList.length === 0) {
            createTiddlyText(place, &quot;No tiddler names provided&quot;);
            return;
        }
        
        // Retrieve the TW5Sandbox tiddler which contains the basic TW5 HTML template.
        var sandbox = store.getTiddlerText(&quot;TW5Sandbox&quot;);
        if(!sandbox) {
            createTiddlyText(place, &quot;TW5Sandbox tiddler not found&quot;);
            return;
        }
        
        // Locate the insertion marker and the &lt;script&gt; tag that holds the JSON tiddler store.
        var marker = &quot;&lt;!--~~ Ordinary tiddlers ~~--&gt;&quot;;
        var markerIndex = sandbox.indexOf(marker);
        if(markerIndex === -1) {
            createTiddlyText(place, &quot;Insertion marker not found in TW5Sandbox&quot;);
            return;
        }
        var scriptTag = '&lt;script class=&quot;tiddlywiki-tiddler-store&quot; type=&quot;application/json&quot;&gt;';
        var scriptStart = sandbox.indexOf(scriptTag, markerIndex);
        if(scriptStart === -1) {
            createTiddlyText(place, &quot;Script tag not found in TW5Sandbox&quot;);
            return;
        }
        var scriptEnd = sandbox.indexOf(&quot;&lt;/script&gt;&quot;, scriptStart);
        if(scriptEnd === -1) {
            createTiddlyText(place, &quot;Script closing tag not found in TW5Sandbox&quot;);
            return;
        }
        
        // Extract the JSON content between the script tags.
        var jsonStart = sandbox.indexOf(&quot;&gt;&quot;, scriptStart) + 1;
        var jsonContent = sandbox.substring(jsonStart, scriptEnd).trim();
        if(jsonContent.slice(-1) !== &quot;]&quot;) {
            createTiddlyText(place, &quot;Store JSON content not in expected format&quot;);
            return;
        }
        
        // Remove the closing bracket from the JSON array so we can append additional tiddler content.
        var newJsonContent = jsonContent.slice(0, -1).trim();
        
        // Loop over each tid parameter, fetch its content and append it.
        for(var i = 0; i &lt; tidList.length; i++){
            var tContent = store.getTiddlerText(tidList[i]);
            if(!tContent) {
                createTiddlyText(place, &quot;Tiddler '&quot; + tidList[i] + &quot;' not found&quot;);
                return;
            }
            // Add a comma separator if necessary.
            if(newJsonContent.length &gt; 1) {
                newJsonContent += &quot;,\n&quot; + tContent;
            } else {
                newJsonContent += tContent;
            }
        }
        // Close the JSON array.
        newJsonContent += &quot;]&quot;;
        
        // Rebuild the sandbox HTML with the updated JSON inserted.
        var newSandbox = sandbox.substring(0, jsonStart) + &quot;\n&quot; + newJsonContent + &quot;\n&quot; + sandbox.substring(scriptEnd);
        
        // Create a data URL for the modified HTML and create an iframe.
        var iframeSrc = &quot;data:text/html;charset=utf-8,&quot; + encodeURIComponent(newSandbox);
        var iframe = document.createElement(&quot;iframe&quot;);
        iframe.style.width = iframeWidth;
        iframe.style.height = iframeHeight;
        iframe.src = iframeSrc;
        place.appendChild(iframe);
    }
};
//}}}</pre>
</div>
<div title="innerTW5PluginDemo" creator="YourName" modifier="YourName" created="202507191938" tags="innerTW5Plugin demo" changecount="1">
<pre>{&quot;created&quot;:&quot;20250326190612216&quot;,&quot;text&quot;:&quot;TiddlerContent&quot;,&quot;tags&quot;:&quot;&quot;,&quot;title&quot;:&quot;New Tiddler&quot;,&quot;modified&quot;:&quot;20250326190624762&quot;}</pre>
</div>
<div title="innerTW5PluginDemoD3" creator="YourName" modifier="YourName" created="202507191938" tags="innerTW5Plugin demo d3" changecount="1">
<pre>&lt;&lt;innerTW5Plugin tid:&quot;D3&quot; tid:&quot;CloudData&quot; tid:&quot;GraphData&quot; tid:&quot;D3Showcase&quot; width:&quot;80%&quot; height:&quot;1000px&quot;&gt;&gt;</pre>
</div>
<div title="innerTW5PluginMultiDemo" creator="YourName" modifier="YourName" created="202507191938" tags="innerTW5Plugin demo" changecount="1">
<pre>{&quot;created&quot;:&quot;20250326190612217&quot;,&quot;text&quot;:&quot;TiddlerContent2&quot;,&quot;tags&quot;:&quot;&quot;,&quot;title&quot;:&quot;New Tiddler2&quot;,&quot;modified&quot;:&quot;20250326190624763&quot;}</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[

//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project repository at https://github.com/TiddlyWiki/tiddlywiki
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//
// JSLint directives
/*global jQuery:false, version:false */
/*jslint bitwise:true, browser:true, confusion:true, eqeq:true, evil:true, forin:true, maxerr:100, plusplus:true, regexp:true, sloppy:true, sub:true, undef:true, unparam:true, vars:true, white:true */

//--
//-- Global tw object (window.tw) exposing available methods and structures for developers
//--

window.tw = {
	assets: {
		icons: {}
	},
	io: {},
	textUtils: {}
};

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

config.adaptors = {};
config.defaultAdaptor = null;

// defines the order of the backstage tasks
config.backstageTasks = ["save", "importTask", "tweak", "upgrade", "plugins"];
// map by names from config.backstageTasks, defines their content (see Lingo.js and Backstage.js)
config.tasks = {};

config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkAnimate: true,
	chkAutoSave: false,
	chkBackstage: false,
	chkCaseSensitiveSearch: false,
	chkConfirmDelete: true,
	chkDisplayInstrumentation: false,
	chkForceMinorUpdate: false,
	chkGenerateAnRssFeed: false,
	chkHttpReadOnly: true,
	chkIncrementalSearch: true,
	chkInsertTabs: false,
	chkOpenInNewWindow: true,
	chkPreventAsyncSaving: true,
	chkRegExpSearch: false,
	chkRemoveExtraMarkers: false, // #162
	chkSaveBackups: true,
	chkSaveEmptyTemplate: false,
	chkSliderOptionsPanel: false,
	chkToggleLinks: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtFileSystemCharSet: "UTF-8",
	txtMainTab: "tabTimeline",
	txtMaxEditRows: "30",
	txtMoreTab: "moreTabAll",
	txtTheme: "",
	txtUpgradeCoreURI: ""
};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: { sizeTextbox: 15 },
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: { defaultView: "text" },
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "https://classic.tiddlywiki.com/upgrade/",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: { hideReadOnly: true },
	cancelTiddler: {},
	deleteTiddler: { hideReadOnly: true },
	permalink: {},
	references: { type: "popup" },
	jump: { type: "popup" },
	syncing: { type: "popup" },
	fields: { type: "popup" }
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
var isBadSafari = !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")); //# see 52678d4 and #22  ..remove at all?
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
// Moved navigator dependent code out of Config.js into a separate module. Helps with https://github.com/TiddlyWiki/tiddlywiki/issues/22
if(isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern =
	"(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b|\\[|\\])"; // #132
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter +
	"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead, "mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp =
	new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");
config.textPrimitives.tiddlerAnyLinkRegExp =
	new RegExp("(" + config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")", "mg");

config.glyphs = {
	currBrowser: null,
	browsers: [],
	codes: {}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	SystemSettings: '',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields permalink references jump|\n' +
		'|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|', // #160
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	// config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	ieVersion: /MSIE (\d{1,2}.\d)/i.exec(config.userAgent),
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]", "g")).test("\u0150")),
	// config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent),
	isOpera: config.userAgent.indexOf("opera") != -1,
	isChrome: config.userAgent.indexOf('chrome') > -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

merge(config.glyphs, {
	browsers: [
		function() { return config.browser.isIE },
		function() { return true }
	],
	codes: {
		downTriangle: ["\u25BC", "\u25BE"],
		downArrow: ["\u2193", "\u2193"],
		bentArrowLeft: ["\u2190", "\u21A9"],
		bentArrowRight: ["\u2192", "\u21AA"]
	}
});

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options, {
	txtUserName: "YourName"
});

merge(config.tasks, {
	save: { text: "save", tooltip: "Save your changes to this TiddlyWiki" },
	importTask: { text: "import", tooltip: "Import tiddlers and plugins " +
		"from other TiddlyWiki files and servers", content: '<<importTiddlers>>' },
	tweak: { text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>' },
	upgrade: { text: "upgrade", tooltip: "Upgrade TiddlyWiki core", content: '<<upgrade>>' },
	plugins: { text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>' }
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc, {
	chkAnimate: "Enable animations",
	chkAutoSave: "Automatically save changes",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkOpenInNewWindow: "Open external links in a new window",
	chkPreventAsyncSaving: "Disable attempting async saving (may be needed by old plugins)",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkSaveBackups: "Keep backup file when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	txtBackupFolder: "Name of folder to use for backups",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	chkRemoveExtraMarkers: "Replace unused transclusion markers with blanks", // #162
	txtTheme: "Name of the theme to use",
	txtUpgradeCoreURI: "Custom URI to download TiddlyWiki core from (when upgrading)",
	txtUserName: "Username for signing your edits"
});

merge(config.messages, {
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see https://classic.tiddlywiki.com/#SaveUnpredictabilities for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "TiddlyWiki saved",
	mainDownload: "Downloading/saving main TiddlyWiki file",
	mainDownloadManual: "RIGHT CLICK HERE to download/save main TiddlyWiki file",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"
});

merge(config.messages.messageClose, {
	text: "close",
	tooltip: "close this message area"
});

config.messages.backstage = {
	open: { text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks" },
	close: { text: "close", tooltip: "Close the backstage area" },
	prompt: "backstage: ",
	decal: {
		edit: { text: "edit", tooltip: "Edit the tiddler '%0'" }
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June",
	"July", "August", "September", "October", "November", "December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = [
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"th", "th", "th", "th", "th", "th", "th", "th", "th", "th",
	"st", "nd", "rd", "th", "th", "th", "th", "th", "th", "th",
	"st"
];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup, {});

merge(config.views.wikified.tag, {
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"
});

merge(config.views.wikified, {
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"
});

merge(config.views.editor, {
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"
});

merge(config.views.editor.tagChooser, {
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"
});

merge(config.messages, {
	sizeTemplates: [
		{ unit: 1024 * 1024 * 1024, template: "%0\u00a0GB" },
		{ unit: 1024 * 1024, template: "%0\u00a0MB" },
		{ unit: 1024, template: "%0\u00a0KB" },
		{ unit: 1, template: "%0\u00a0B" }
	]
});

merge(config.macros.search, {
	label: "search",
	prompt: "Search this TiddlyWiki",
	placeholder: "",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"
});

merge(config.macros.tagging, {
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"
});

merge(config.macros.timeline, {
	dateFormat: "DD MMM YYYY"
});

merge(config.macros.allTags, {
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"
});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll, {
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"
});

merge(config.macros.permaview, {
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"
});

merge(config.macros.saveChanges, {
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"
});

merge(config.macros.newTiddler, {
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"
});

merge(config.macros.newJournal, {
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"
});

merge(config.macros.options, {
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br>" +
		"<label><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</label>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{ name: 'Option', field: 'option', title: "Option", type: 'String' },
			{ name: 'Description', field: 'description', title: "Description", type: 'WikiText' },
			{ name: 'Name', field: 'name', title: "Name", type: 'String' }
		],
		rowClasses: [
			{ className: 'lowlight', field: 'lowlight' }
		]
	}
});

merge(config.macros.plugins, {
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox' },
			{ name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	},
	listViewTemplateReadOnly: {
		columns: [
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Description', field: 'Description', title: "Description", type: 'String' },
			{ name: 'Version', field: 'Version', title: "Version", type: 'String' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No" },
			{ name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String' },
			{ name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK" },
			{ name: 'Log', field: 'log', title: "Log", type: 'StringList' }
		],
		rowClasses: [
			{ className: 'error', field: 'error' },
			{ className: 'warning', field: 'warning' }
		]
	}
});

merge(config.macros.toolbar, {
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
});

merge(config.macros.refreshDisplay, {
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
});

merge(config.macros.importTiddlers, {
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>" +
		"Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>" +
		"...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>" +
		"...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: " +
		"<select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	errorGettingTiddlerListHttp404: "Error retrieving tiddlers from url, please ensure the url exists. Click Cancel to try again.",
	errorGettingTiddlerListHttp: "Error retrieving tiddlers from url, please " +
		"ensure this url exists and is <a href='http://enable-cors.org/'>CORS</a> enabled",
	errorGettingTiddlerListFile: "Error retrieving tiddlers from local file, " +
		"please make sure the file is in the same directory as your TiddlyWiki. Click Cancel to try again.",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>" +
		"Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br>" +
		"<input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' " +
		"to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\n" +
		"This tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{ name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector' },
			{ name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler' },
			{ name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size' },
			{ name: 'Tags', field: 'tags', title: "Tags", type: 'Tags' }
		],
		rowClasses: []
	}
});

merge(config.macros.upgrade, {
	wizardTitle: "Upgrade TiddlyWiki",
	step1Title: "Update or repair TiddlyWiki core to the latest release",
	step1Html: "You are about to upgrade TiddlyWiki core to the latest release " +
		"(from <a href='%0' class='externalLink' target='_blank'>%1</a>). " +
		"Your content will be preserved across the upgrade.<br><br>" +
		"Note that core upgrades have been known to interfere with older plugins. " +
		"If you run into problems with upgrading, read how to handle them " +
		"<a href='%2' class='externalLink' target='_blank'>here</a>.",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>" +
		"You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	errorVerifyingBackup: "Failed to verify the backup was saved. " +
		"This is either because it wasn't saved to the moment of the check or " +
		"loading file doesn't work with your saver (and it is needed for " +
		"the next step of upgrading). To upgrade your TiddlyWiki, you can use " +
		"other methods listed at <a href='%0' class='externalLink' target='_blank'>%0</a>",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
});

merge(config.macros.annotations, {});

merge(config.commands.closeTiddler, {
	text: "close",
	tooltip: "Close this tiddler"
});

merge(config.commands.closeOthers, {
	text: "close others",
	tooltip: "Close all other tiddlers"
});

merge(config.commands.editTiddler, {
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"
});

merge(config.commands.saveTiddler, {
	text: "done",
	tooltip: "Save changes to this tiddler"
});

merge(config.commands.cancelTiddler, {
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"
});

merge(config.commands.deleteTiddler, {
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"
});

merge(config.commands.permalink, {
	text: "permalink",
	tooltip: "Permalink for this tiddler"
});

merge(config.commands.references, {
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"
});

merge(config.commands.jump, {
	text: "jump",
	tooltip: "Jump to another open tiddler"
});

merge(config.commands.fields, {
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{ name: 'Field', field: 'field', title: "Field", type: 'String' },
			{ name: 'Value', field: 'value', title: "Value", type: 'String' }
		],
		rowClasses: [],
		buttons: []
	}
});

merge(config.shadowTiddlers, {
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">>' +
		'<<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
});

merge(config.annotations, {
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. " +
		"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. " +
	"''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "Options may be stored here using the slice notation (like {{{chkAutoSave: true}}} or {{{|txtUserName|The great inventor|}}})",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo, tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file can be saved back to the same location [Preemption]
window.allowSave = window.allowSave || function(l) {
	return true;
};

// Whether this file is being viewed locally
window.isLocal = function() {
	return (document.location.protocol == "file:");
};

var useJavaSaver = false;

// Allow preemption code a chance to tweak config and useJavaSaver [Preemption]
if (window.tweakConfig) window.tweakConfig();

if(!window || !window.console) {
	console = { tiddlywiki: true, log: function(message) { displayMessage(message) } };
}

// Starting up
function main() {
	window.originalHTML = recreateOriginal();

	var t10, t9, t8, t7, t6, t5, t4, t3, t2, t1, t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) { if(window.confirmExit) return confirmExit(); };
	params = getParameters();
	if(params) params = params.parseParams("open", null, false);
	store = new TiddlyWiki({ config: config });
	invokeParamifier(params, "oninit");
	story = new Story("tiddlerDisplay", "tiddler");
	addEvent(document, "click", Popup.onDocumentClick);
	saveTest();
	for(var i = 0; i < config.notifyTiddlers.length; i++)
		store.addNotification(config.notifyTiddlers[i].name, config.notifyTiddlers[i].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea", "store", true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params, "onload");
	t4 = new Date();
	readOnly = window.isLocal() ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params, "onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	for(var name in config.macros) {
		if(config.macros[name].init)
			config.macros[name].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null, "PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2 - t1) + " ms");
		displayMessage("LoadFromDiv " + (t3 - t2) + " ms");
		displayMessage("LoadPlugins " + (t5 - t4) + " ms");
		displayMessage("Macro init " + (t7 - t6) + " ms");
		displayMessage("Notify " + (t8 - t7) + " ms");
		displayMessage("Restart " + (t9 - t8) + " ms");
		displayMessage("Total: " + (t10 - t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. Functions may get unloaded too, so they are called conditionally.
function unload() {
	if(window.checkUnsavedChanges) checkUnsavedChanges();
	if(window.scrubNodes) scrubNodes(document.body);
}

// Restarting
function restart() {
	invokeParamifier(params, "onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0, 0);
}

function saveTest() {
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers() {
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea", "shadows", true);
	shadows.forEachTiddler(function(title, tiddler) { config.shadowTiddlers[title] = tiddler.text });
}

function loadPlugins(tag) {
	if(safeMode) return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1) });

	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	for(var i = 0; i < nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n) map[n] = p;
		n = p.Source;
		if(n) map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done) return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			for(var i = 0; i < reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i = 0; i < nPlugins; i++)
		visit(installedPlugins[i]);
	for(i = 0; i < toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text) window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler) {
	var p = store.getTiddlerSlices(tiddler.title, ["Name", "Description", "Version",
		"Requires", "CoreVersion", "Date", "Source", "Author", "License", "Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin) {
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0], 10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1], 10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2], 10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin) {
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}

//--
//-- Paramifiers
//--

function getParameters() {
	return window.location.hash ? decodeURIComponent(window.location.hash.substr(1)) : null;
}

function invokeParamifier(params, handler) {
	if(!params || params.length == undefined || params.length <= 1)
		return;

	for(var i = 1; i < params.length; i++) {
		var name = params[i].name,
		    value = params[i].value;
		var p = config.paramifiers[name];
		if(p && p[handler] instanceof Function)
			p[handler](value);
		else {
			var h = config.optionHandlers[name.substr(0, 3)];
			if(h && h.set instanceof Function)
				h.set(name, value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(title) {
		if(!readOnly || store.tiddlerExists(title) || store.isShadowTiddler(title))
			story.displayTiddler("bottom", title, null, false, null);
	}
};

config.paramifiers.story = {
	onstart: function(title) {
		var list = store.getTiddlerText(title, "").parseParams("open", null, false);
		invokeParamifier(list, "onstart");
	}
};

config.paramifiers.search = {
	onstart: function(query) {
		story.search(query, false, false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v, false, true);
	}
};

config.paramifiers.tag = {
	onstart: function(tag) {
		story.displayTiddlers(null, store.filterTiddlers("[tag[" + tag + "]]"), null, false, null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(readOnly) return;
		var args = v.parseParams("anon", null, null)[0];
		var title = args.title ? args.title[0] : v;
		var customFields = args.fields ? args.fields[0] : null;

		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, customFields);
		story.focusTiddler(title, "text");
		var i, tags = args.tag || [];
		for(i = 0; i < tags.length; i++) {
			story.setTiddlerTag(title, tags[i], +1);
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(titleTemplate) {
		if(readOnly) return;
		var now = new Date();
		var title = now.formatString(titleTemplate.trim());
		story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE);
		story.focusTiddler(title, "text");
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(themeTitle) {
		story.switchTheme(themeTitle);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent = {
	onstart: function(limit) {
		var titles = [];
		var i, tiddlers = store.getTiddlers("modified", "excludeLists").reverse();
		for(i = 0; i < limit && i < tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null, titles);
	}
};

config.paramifiers.filter = {
	onstart: function(filterExpression) {
		story.displayTiddlers(null, store.filterTiddlers(filterExpression), null, false);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters) {
	this.formatters = [];
	var pattern = [];
	for(var n = 0; n < formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"), "mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w) {
		w.subWikifyTerm(createTiddlyElement(w.output, this.element), this.termRegExp);
	},

	inlineCssHelper: function(w) {
		// Convert CSS property name to a JavaScript style name ("background-color" -> "backgroundColor")
		var unDash = function(name) {
			return name
				.split("-")
				.map(function(word, i) {
					return i == 0 ? word :
						word.charAt(0).toUpperCase() + word.slice(1);
				})
				.join("");
		};
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s, v;
			if(lookaheadMatch[1]) {
				s = unDash(lookaheadMatch[1]);
				v = lookaheadMatch[2];
			} else {
				s = unDash(lookaheadMatch[3]);
				v = lookaheadMatch[4];
			}
			if(s == "bgcolor") s = "backgroundColor";
			if(s == "float") s = "cssFloat";
			styles.push({ style: s, value: v });
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e, styles) {
		for(var i = 0; i < styles.length; i++) {
			try {
				e.style[styles[i].style] = styles[i].value;
			} catch (ex) {}
		}
	},

	enclosedTextHelper: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE && (config.browser.ieVersion[1] < 10))
				text = text.replace(/\n/g, "\r");
			createTiddlyElement(w.output, this.element, null, null, text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link) {
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern, "mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".") != -1 ||
		   link.indexOf("\\") != -1 ||
		   link.indexOf("/") != -1 ||
		   link.indexOf("#") != -1
		) {
			return true;
		}
		return false;
	}
};

//--
//-- Standard formatters
//--

config.formatters = [
	{
		name: "table",
		match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
		lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
		rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
		cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
		cellTermRegExp: /((?:\x20*)\|)/mg,
		rowTypes: { "c": "caption", "h": "thead", "": "tbody", "f": "tfoot" },
		handler: function(w) {
			var table = createTiddlyElement(w.output, "table", null, "twtable");
			var prevColumns = [];
			var currRowType = null;
			var rowContainer;
			var rowCount = 0;
			var onmouseover = function() { jQuery(this).addClass("hoverRow") };
			var onmouseout = function() { jQuery(this).removeClass("hoverRow") };
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				var nextRowType = lookaheadMatch[2];
				if(nextRowType == "k") {
					table.className = lookaheadMatch[1];
					w.nextMatch += lookaheadMatch[0].length + 1;
				} else {
					if(nextRowType != currRowType) {
						rowContainer = createTiddlyElement(table, this.rowTypes[nextRowType]);
						currRowType = nextRowType;
					}
					if(currRowType == "c") {
						// Caption
						w.nextMatch++;
						if(rowContainer != table.firstChild)
							table.insertBefore(rowContainer, table.firstChild);
						rowContainer.setAttribute("align", rowCount == 0 ? "top" : "bottom");
						w.subWikifyTerm(rowContainer, this.rowTermRegExp);
					} else {
						var theRow = createTiddlyElement(rowContainer, "tr", null, rowCount % 2 ? "oddRow" : "evenRow");
						theRow.onmouseover = onmouseover;
						theRow.onmouseout = onmouseout;
						this.rowHandler(w, theRow, prevColumns);
						rowCount++;
					}
				}
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		},
		rowHandler: function(w, e, prevColumns) {
			var col = 0;
			var colSpanCount = 1;
			var prevCell = null;
			this.cellRegExp.lastIndex = w.nextMatch;
			var cellMatch = this.cellRegExp.exec(w.source);
			while(cellMatch && cellMatch.index == w.nextMatch) {
				if(cellMatch[1] == "~") {
					// Rowspan
					var last = prevColumns[col];
					if(last) {
						last.rowSpanCount++;
						last.element.setAttribute("rowspan", last.rowSpanCount);
						last.element.setAttribute("rowSpan", last.rowSpanCount); // Needed for IE
						last.element.valign = "center";
						if(colSpanCount > 1) {
							last.element.setAttribute("colspan", colSpanCount);
							last.element.setAttribute("colSpan", colSpanCount); // Needed for IE
							colSpanCount = 1;
						}
					}
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[1] == ">") {
					// Colspan
					colSpanCount++;
					w.nextMatch = this.cellRegExp.lastIndex - 1;
				} else if(cellMatch[2]) {
					// End of row
					if(prevCell && colSpanCount > 1) {
						prevCell.setAttribute("colspan", colSpanCount);
						prevCell.setAttribute("colSpan", colSpanCount); // Needed for IE
					}
					w.nextMatch = this.cellRegExp.lastIndex;
					break;
				} else {
					// Cell
					w.nextMatch++;
					var styles = config.formatterHelpers.inlineCssHelper(w);
					var spaceLeft = false;
					var chr = w.source.substr(w.nextMatch, 1);
					while(chr == " ") {
						spaceLeft = true;
						w.nextMatch++;
						chr = w.source.substr(w.nextMatch, 1);
					}
					var cell;
					if(chr == "!") {
						cell = createTiddlyElement(e, "th");
						w.nextMatch++;
					} else {
						var isInsideHeader = e.parentElement.tagName.toLocaleLowerCase() === 'thead';
						cell = createTiddlyElement(e, isInsideHeader ? "th" : "td");
					}
					prevCell = cell;
					prevColumns[col] = { rowSpanCount: 1, element: cell };
					if(colSpanCount > 1) {
						cell.setAttribute("colspan", colSpanCount);
						cell.setAttribute("colSpan", colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
					config.formatterHelpers.applyCssHelper(cell, styles);
					w.subWikifyTerm(cell, this.cellTermRegExp);
					if(w.matchText.substr(w.matchText.length - 2, 1) == " ") // spaceRight
						cell.align = spaceLeft ? "center" : "left";
					else if(spaceLeft)
						cell.align = "right";
					w.nextMatch--;
				}
				col++;
				this.cellRegExp.lastIndex = w.nextMatch;
				cellMatch = this.cellRegExp.exec(w.source);
			}
		}
	},

	{
		name: "heading",
		match: "^!{1,6}",
		termRegExp: /(\n)/mg,
		handler: function(w) {
			w.subWikifyTerm(createTiddlyElement(w.output, "h" + w.matchLength), this.termRegExp);
		}
	},

	{
		name: "list",
		match: "^(?:[\\*#;:]+)",
		lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
		termRegExp: /(\n)/mg,
		handler: function(w) {
			// stack holds nested elements to which (nested) lists are appended
			var stack = [w.output];
			var currLevel = 0, currType = null;
			var listLevel, listType, itemType, baseType;
			w.nextMatch = w.matchStart;
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
				if(lookaheadMatch[1]) {
					listType = "ul";
					itemType = "li";
				} else if(lookaheadMatch[2]) {
					listType = "ol";
					itemType = "li";
				} else if(lookaheadMatch[3]) {
					listType = "dl";
					itemType = "dt";
				} else if(lookaheadMatch[4]) {
					listType = "dl";
					itemType = "dd";
				}
				if(!baseType)
					baseType = listType;
				listLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				var l;
				if(listLevel > currLevel) {
					for(l = currLevel; l < listLevel; l++) {
						var target = (currLevel == 0) ? stack[stack.length - 1] : stack[stack.length - 1].lastChild;
						stack.push(createTiddlyElement(target, listType));
					}
				} else if(listType != baseType && listLevel == 1) {
					w.nextMatch -= lookaheadMatch[0].length;
					return;
				} else if(listLevel < currLevel) {
					for(l = currLevel; l > listLevel; l--)
						stack.pop();
				} else if(listLevel == currLevel && listType != currType) {
					stack.pop();
					stack.push(createTiddlyElement(stack[stack.length - 1].lastChild, listType));
				}
				currLevel = listLevel;
				currType = listType;
				var itemElement = createTiddlyElement(stack[stack.length - 1], itemType);
				w.subWikifyTerm(itemElement, this.termRegExp);
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			}
		}
	},

	{
		name: "quoteByBlock",
		match: "^<<<\\n",
		termRegExp: /(^<<<(\n|$))/mg,
		element: "blockquote",
		handler: config.formatterHelpers.createElementAndWikify
	},

	{
		name: "quoteByLine",
		match: "^>+",
		lookaheadRegExp: /^>+/mg,
		termRegExp: /(\n)/mg,
		element: "blockquote",
		handler: function(w) {
			var stack = [w.output];
			var currLevel = 0;
			var newLevel = w.matchLength;
			var l, matched;
			do {
				if(newLevel > currLevel) {
					for(l = currLevel; l < newLevel; l++)
						stack.push(createTiddlyElement(stack[stack.length - 1], this.element));
				} else if(newLevel < currLevel) {
					for(l = currLevel; l > newLevel; l--)
						stack.pop();
				}
				currLevel = newLevel;
				w.subWikifyTerm(stack[stack.length - 1], this.termRegExp);
				createTiddlyElement(stack[stack.length - 1], "br");
				this.lookaheadRegExp.lastIndex = w.nextMatch;
				var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
				matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
				if(matched) {
					newLevel = lookaheadMatch[0].length;
					w.nextMatch += lookaheadMatch[0].length;
				}
			} while(matched);
		}
	},

	{
		name: "rule",
		match: "^----+$\\n?|<hr ?/?>\\n?",
		handler: function(w) {
			createTiddlyElement(w.output, "hr");
		}
	},

	{
		name: "monospacedByLine",
		match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
		element: "pre",
		handler: function(w) {
			switch(w.matchText) {
				case "/*{{{*/\n": // CSS
					this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
					break;
				case "{{{\n": // monospaced block
					this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
					break;
				case "//{{{\n": // plugin
					this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
					break;
				case "<!--{{{-->\n": //template
					this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
					break;
				default:
					break;
			}
			config.formatterHelpers.enclosedTextHelper.call(this, w);
		}
	},

	{
		name: "wikifyComment",
		match: "^(?:/\\*\\*\\*|<!---)\\n",
		handler: function(w) {
			var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
			w.subWikifyTerm(w.output, termRegExp);
		}
	},

	{
		name: "macro",
		match: "<<",
		lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
				w.nextMatch = this.lookaheadRegExp.lastIndex;
				invokeMacro(w.output, lookaheadMatch[1], lookaheadMatch[2], w, w.tiddler);
			}
		}
	},

	{
		name: "prettyLink",
		match: "\\[\\[",
		lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var e;
				var text = lookaheadMatch[1];
				if(lookaheadMatch[3]) {
					// Pretty bracketted link
					var link = lookaheadMatch[3];
					e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link))
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
				} else {
					// Simple bracketted link
					e = createTiddlyLink(w.output, text, false, null, w.isStatic, w.tiddler);
				}
				createTiddlyText(e, text);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "wikiLink",
		match: config.textPrimitives.unWikiLink + "?" + config.textPrimitives.wikiLink,
		handler: function(w) {
			if(w.matchText.substr(0, 1) == config.textPrimitives.unWikiLink) {
				w.outputText(w.output, w.matchStart + 1, w.nextMatch);
				return;
			}
			if(w.matchStart > 0) {
				var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict, "mg");
				preRegExp.lastIndex = w.matchStart - 1;
				var preMatch = preRegExp.exec(w.source);
				if(preMatch.index == w.matchStart - 1) {
					w.outputText(w.output, w.matchStart, w.nextMatch);
					return;
				}
			}
			if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
				var link = createTiddlyLink(w.output, w.matchText, false, null, w.isStatic, w.tiddler);
				w.outputText(link, w.matchStart, w.nextMatch);
			} else {
				w.outputText(w.output, w.matchStart, w.nextMatch);
			}
		}
	},

	{
		name: "urlLink",
		match: config.textPrimitives.urlPattern,
		handler: function(w) {
			w.outputText(createExternalLink(w.output, w.matchText), w.matchStart, w.nextMatch);
		}
	},

	{
		name: "image",
		match: "\\[[<>]?[Ii][Mm][Gg]\\[",
		lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				var container = w.output;
				var link = lookaheadMatch[5];
				if(link) {
					container = config.formatterHelpers.isExternalLink(link)
						? createExternalLink(w.output, link)
						: createTiddlyLink(w.output, link, false, null, w.isStatic, w.tiddler);
					jQuery(container).addClass("imageLink");
				}
				var img = createTiddlyElement(container, "img");
				if(lookaheadMatch[1])
					img.align = "left";
				else if(lookaheadMatch[2])
					img.align = "right";
				if(lookaheadMatch[3]) {
					img.title = lookaheadMatch[3];
					img.setAttribute("alt", lookaheadMatch[3]);
				}
				img.src = lookaheadMatch[4];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "html",
		match: "<[Hh][Tt][Mm][Ll]>",
		lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span").innerHTML = lookaheadMatch[1];
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "commentByBlock",
		match: "/%",
		lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
				w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	},

	{
		name: "characterFormat",
		match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "''":
					w.subWikifyTerm(w.output.appendChild(document.createElement("strong")), /('')/mg);
					break;
				case "//":
					w.subWikifyTerm(createTiddlyElement(w.output, "em"), /(\/\/)/mg);
					break;
				case "__":
					w.subWikifyTerm(createTiddlyElement(w.output, "u"), /(__)/mg);
					break;
				case "^^":
					w.subWikifyTerm(createTiddlyElement(w.output, "sup"), /(\^\^)/mg);
					break;
				case "~~":
					w.subWikifyTerm(createTiddlyElement(w.output, "sub"), /(~~)/mg);
					break;
				case "--":
					w.subWikifyTerm(createTiddlyElement(w.output, "strike"), /(--)/mg);
					break;
				case "{{{":
					var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
						createTiddlyElement(w.output, "code", null, null, lookaheadMatch[1]);
						w.nextMatch = lookaheadRegExp.lastIndex;
					}
					break;
			}
		}
	},

	{
		name: "customFormat",
		match: "@@|\\{\\{",
		handler: function(w) {
			switch(w.matchText) {
				case "@@":
					var e = createTiddlyElement(w.output, "span");
					var styles = config.formatterHelpers.inlineCssHelper(w);
					if(styles.length == 0)
						e.className = "marked";
					else
						config.formatterHelpers.applyCssHelper(e, styles);
					w.subWikifyTerm(e, /(@@)/mg);
					break;
				case "{{":
					var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w-]*)[\s]*\{(\n?)/mg;
					lookaheadRegExp.lastIndex = w.matchStart;
					var lookaheadMatch = lookaheadRegExp.exec(w.source);
					if(lookaheadMatch) {
						w.nextMatch = lookaheadRegExp.lastIndex;
						e = createTiddlyElement(w.output, lookaheadMatch[2] == "\n" ? "div" : "span", null, lookaheadMatch[1]);
						w.subWikifyTerm(e, /(\}\}\})/mg);
					}
					break;
			}
		}
	},

	{
		name: "mdash",
		match: "--",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = "&mdash;";
		}
	},

	{
		name: "lineBreak",
		match: "\\n|<br ?/?>",
		handler: function(w) {
			createTiddlyElement(w.output, "br");
		}
	},

	{
		name: "rawText",
		match: "\"{3}|<nowiki>",
		lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
		handler: function(w) {
			this.lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output, "span", null, null, lookaheadMatch[1]);
				w.nextMatch = this.lookaheadRegExp.lastIndex;
			}
		}
	},

	{
		name: "htmlEntitiesEncoding",
		match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)" +
			"(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*" +
			"(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+" +
			"|&#?[a-zA-Z0-9]{2,8};)",
		handler: function(w) {
			createTiddlyElement(w.output, "span").innerHTML = w.matchText;
		}
	}
];

//--
//-- Wikifier
//--

function getParser(tiddler, format) {
	if(tiddler) {
		if(!format) format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers)
				if(format == config.parsers[i].format)
					return config.parsers[i];
		} else {
			for(i in config.parsers)
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
		}
	}
	return formatter;
}

function Wikifier(source, formatter, highlightRegExp, tiddler) {
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function() {
	var e = createTiddlyElement(document.body, "div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(output, terminator) {
	try {
		if(terminator)
			this.subWikifyTerm(output, new RegExp("(" + terminator + ")", "mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output) {
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch;
	while(formatterMatch = this.formatter.formatterRegExp.exec(this.source)) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output, terminatorRegExp) {
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
		this.source.substr(0, terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output, this.nextMatch, terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var i = 1; i < formatterMatch.length; i++) {
			if(formatterMatch[i]) {
				this.formatter.formatters[i - 1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ?
			this.source.substr(0, terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output, this.nextMatch, this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place, startPos, endPos) {
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) &&
		  (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place, this.source.substring(startPos, this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex, endPos);
		createTiddlyElement(place, "span", null, "highlight", this.source.substring(startPos, highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place, this.source.substring(startPos, endPos));
	}
};

function wikify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, getParser(tiddler), highlightRegExp, tiddler);
	var t0 = new Date();
	wikifier.subWikify(output);
	if(tiddler && config.options.chkDisplayInstrumentation)
		displayMessage("wikify:" + tiddler.title + " in " + (new Date() - t0) + " ms");
}

function wikifyStatic(source, highlightRegExp, tiddler, format) {
	if(!source) return "";
	if(!tiddler) tiddler = new Tiddler("temp");
	var wikifier = new Wikifier(source, getParser(tiddler, format), highlightRegExp, tiddler);
	wikifier.isStatic = true;

	var e = createTiddlyElement(document.body, "pre");
	e.style.display = "none";
	wikifier.subWikify(e);
	var html = e.innerHTML;
	jQuery(e).remove();
	return html;
}

function wikifyPlainText(text, limit, tiddler) {
	if(limit > 0)
		text = text.substr(0, limit);
	var wikifier = new Wikifier(text, formatter, null, tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source, output, highlightRegExp, tiddler) {
	if(!source) return;
	var wikifier = new Wikifier(source, formatter, highlightRegExp, tiddler);
	wikifier.outputText(output, 0, source.length);
}

//--
//-- Macro definitions
//--

function invokeMacro(place, macro, params, wikifier, tiddler) {
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);

			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;

			var allowEval = true;
			if(config.evaluateMacroParameters == "system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place, macro, m.noPreParse ? null : params.readMacroParams(!allowEval), wikifier, params, tiddler);
		} else {
			createTiddlyError(place, config.messages.macroError.format([macro]),
				config.messages.macroErrorDetails.format([macro, config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place, config.messages.macroError.format([macro]),
			config.messages.macroErrorDetails.format([macro, ex.toString()]));
	}
}

config.macros.version.handler = function(place) {
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place, macroName, params) {
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";
config.macros.list.handler = function(place, macroName, params, wikifier, paramString) {
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	var template = args.template ? store.getTiddlerText(args.template[0]) : false;
	if(!template) {
		template = config.macros.list.template;
	}
	var results;
	if(this[type].handler)
		results = this[type].handler(params);

	jQuery(list).empty().addClass("list list-" + type);
	if(this[type].prompt)
		createTiddlyElement(list, "li", null, "listTitle", this[type].prompt);

	for(var i = 0; i < results.length; i++) {
		var li = createTiddlyElement(list, "li");
		var tiddler = results[i];
		if(typeof(tiddler) == 'string') { // deal with missing etc..
			tiddler = store.getTiddler(tiddler) || new Tiddler(tiddler);
		}
		wikify(template, li, null, tiddler);
	}
	if(results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params) {
	return store.reverseLookup("tags", "excludeLists", false, "title");
};

config.macros.list.missing.handler = function(params) {
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params) {
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params) {
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params) {
	return store.getTouched();
};

config.macros.list.filter.handler = function(params) {
	var filter = params[1];
	if(!filter) return [];
	return store.filterTiddlers(filter).map(function(tiddler) {
		return tiddler.title;
	});
};

config.macros.allTags.handler = function(place, macroName, params) {
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place, "ul");
	if(tags.length == 0) createTiddlyElement(ul, "li", null, "listTitle", this.noTags);

	for(var i = 0; i < tags.length; i++) {
		var title = tags[i][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul, "li");
		var btn = createTiddlyButton(li, title + " (" + tags[i][1] + ")",
			this.tooltip.format([title]), onClickTag, info.classes);
		btn.setAttribute("tag", title);
		btn.setAttribute("refresh", "link");
		btn.setAttribute("tiddlyLink", title);
		if(params[1]) btn.setAttribute("sortby", params[1]);
	}
};

var macro = config.macros.timeline;
merge(macro, {
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).
			attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var field = params[0] || "modified";
		var prefix = field.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? field.substr(1, field.length) : field;
		var dateFormat = params[2] || this.dateFormat;

		var groupTemplate = (args.groupTemplate ? store.getTiddlerText(args.groupTemplate[0]) : null)
			|| macro.groupTemplate.format(no_prefix_field, dateFormat);
		var itemTemplate = (args.template ? store.getTiddlerText(args.template[0]) : null)
			|| macro.itemTemplate;

		var tiddlers = args.filter ? store.sortTiddlers(store.filterTiddlers(args.filter[0]), field) :
			store.reverseLookup("tags", "excludeLists", false, field);
		var last = params[1] ? tiddlers.length - Math.min(tiddlers.length, parseInt(params[1], 10)) : 0;
		var lastGroup = "", ul;

		for(var i = tiddlers.length - 1; i >= last; i--) {
			var theGroup = wikifyPlainText(groupTemplate, 0, tiddlers[i]);
			if(ul === undefined || theGroup != lastGroup) {
				ul = createTiddlyElement(container, "ul", null, "timeline");
				createTiddlyElement(ul, "li", null, "listTitle", theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul, "li", null, "listLink");
			wikify(itemTemplate, item, null, tiddlers[i]);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>",
	itemTemplate: "<<view title link>>"
});

config.macros.tiddler.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length - 1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0, pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name", null, allowEval, false, true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];

	var wrapper = createTiddlyElement(place, "span", null, className, null, {
		refresh: "content", tiddler: tiddlerName
	});
	if(args !== undefined)
		wrapper.macroArgs = args; // #154
	this.transclude(wrapper, tiddlerName, args);
};

config.macros.tiddler.transclude = function(wrapper, tiddlerName, args) {
	var text = store.getTiddlerText(tiddlerName);
	if(!text) return;

	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1) return;

	stack.push(tiddlerName);
	try {
		// substitute $1, $2, .. placeholders (markers)
		if(typeof args == "string")
			args = args.readBracketedList();
		var maxSupportedPlaceholders = 9; // $1 - $9
		var n = args ? args.length : 0;
		for(var i = 0; i < maxSupportedPlaceholders; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1), "mg");
			if(i < n) {
				text = text.replace(placeholderRE, args[i]);
			}
			// #162
			else if(n && config.options.chkRemoveExtraMarkers) {
				text = text.replace(placeholderRE, "");
			}
		}

		config.macros.tiddler.renderText(wrapper, text, tiddlerName);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place, text, tiddlerName) {
	wikify(text, place, null, store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place, macroName, params) {
	var btn = createTagButton(place, params[0], null, params[1], params[2]);
	if(params[3]) btn.setAttribute('sortby', params[3]);
};

config.macros.tags.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params, "sep", " ");
	var lingo = config.views.wikified.tag;

	var ul = createTiddlyElement(place, "ul");
	createTiddlyElement(ul, "li", null, "listTitle",
		(tiddler.tags.length ? lingo.labelTags : lingo.labelNoTags).format([tiddler.title])
	);
	for(var i = 0; i < tiddler.tags.length; i++) {
		var tag = store.getTiddler(tiddler.tags[i]);
		if(tag && tag.tags.indexOf("excludeLists") != -1) continue;
		createTagButton(createTiddlyElement(ul, "li"), tiddler.tags[i], tiddler.title);
		if(i < tiddler.tags.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.tagging.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, true, false, false);
	var title = getParam(params, "anon", "");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params, "sep", " ");
	var sortby = getParam(params, "sortBy", false);
	var tagged = store.getTaggedTiddlers(title, sortby);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;

	var ul = createTiddlyElement(place, "ul");
	ul.setAttribute("title", this.tooltip.format([title]));
	createTiddlyElement(ul, "li", null, "listTitle", prompt.format([title, tagged.length]));

	for(var i = 0; i < tagged.length; i++) {
		createTiddlyLink(createTiddlyElement(ul, "li"), tagged[i].title, true);
		if(i < tagged.length - 1)
			createTiddlyText(ul, sep);
	}
};

config.macros.closeAll.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.closeAll.onClick = function(e) {
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.permaview.onClick = function(e) {
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place, macroName, params) {
	if(!readOnly)
		createTiddlyButton(place, params[0] || this.label, params[1] || this.prompt, this.onClick, null, null, this.accessKey);
};

config.macros.saveChanges.onClick = function(e) {
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev) {
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n, !isOpen, null, "none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place, cookie, title, tooltip) {
	var c = cookie || "";
	createTiddlyButton(place, title, tooltip, this.onClickSlider);
	var panel = createTiddlyElement(null, "div", null, "sliderPanel");
	panel.setAttribute("cookie", c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place, macroName, params) {
	var panel = this.createSlider(place, params[0], params[2], params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh", "content");
	panel.setAttribute("tiddler", params[1]);
	if(text)
		wikify(text, panel, null, store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var panel = wikifier ? createTiddlyElement(place, "div", null, "gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel, styles);
	}
	params = paramString.parseParams("color");
	var loColors = [], hiColors = [];

	for(var i = 2; i < params.length; i++) {
		var c = params[i].value;
		if(params[i].name == "snap") {
			hiColors[hiColors.length - 1] = c;
		} else {
			loColors.push(c);
			hiColors.push(c);
		}
	}
	drawGradient(panel, params[1].value != "vert", loColors, hiColors);
	if(wikifier)
		wikifier.subWikify(panel, ">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place, macroName, params) {
	if(!params[0]) return;

	var names = params[0].split(".");
	var lookupMessage = function(root, nameIndex) {
		if(root[names[nameIndex]]) {
			if(nameIndex < names.length - 1)
				return (lookupMessage(root[names[nameIndex]], nameIndex + 1));
			else
				return root[names[nameIndex]];
		} else
			return null;
	};
	var m = lookupMessage(config, 0);
	if(m == null)
		m = lookupMessage(window, 0);
	createTiddlyText(place, m.toString().format(params.splice(1)));
};

config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value, place, params, wikifier, paramString, tiddler) {
		highlightify(value, place, highlightHack, tiddler);
	},
	link: function(value, place, params, wikifier, paramString, tiddler) {
		createTiddlyLink(place, value, true);
	},
	wikified: function(value, place, params, wikifier, paramString, tiddler) {
		if(config.macros.view.depth > 50)
			return;
		if(config.macros.view.depth > 0) {
			if (value == config.macros.view.values[config.macros.view.depth - 1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if(params[2])
			value = params[2].unescapeLineBreaks().format([value]);
		wikify(value, place, highlightHack, tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value, place, params, wikifier, paramString, tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place, value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler) || !params[0]) return;
	var value = store.getValue(tiddler, params[0]);
	if(!value) return;

	var type = params[1] || config.macros.view.defaultView;
	var handler = config.macros.view.views[type];
	if(handler)
		handler(value, place, params, wikifier, paramString, tiddler);
};

config.macros.edit.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var field = params[0];
	var rows = params[1] || 0;
	var defaultValue = params[2] || '';
	if(!(tiddler instanceof Tiddler) || !field) return;

	story.setDirty(tiddler.title, true);
	var e, value = store.getValue(tiddler, field) || defaultValue;
	if(field != "text" && !rows) {
		e = createTiddlyElement(place, "input", null, null, null, {
			type: "text", edit: field, size: "40", autocomplete: "off"
		});
		e.value = value;
	} else {
		rows = rows || 10;
		var lines = value.match(/\n/mg);
		var maxLines = Math.max(parseInt(config.options.txtMaxEditRows), 5);
		if(lines != null && lines.length > rows)
			rows = lines.length + 5;
		rows = Math.min(rows, maxLines);

		var wrapper1 = createTiddlyElement(null, "fieldset", null, "fieldsetFix");
		var wrapper2 = createTiddlyElement(wrapper1, "div");
		e = createTiddlyElement(wrapper2, "textarea");
		e.value = value;
		e.setAttribute("rows", rows);
		e.setAttribute("edit", field);
		place.appendChild(wrapper1);
	}
	if(tiddler.isReadOnly()) {
		e.setAttribute("readOnly", "readOnly");
		jQuery(e).addClass("readOnly");
	}
	return e;
};

config.macros.tagChooser.onClick = function(ev) {
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));

	for(var i = 0; i < tags.length; i++) {
		var tag = createTiddlyButton(createTiddlyElement(popup, "li"), tags[i][0],
			lingo.tagTooltip.format([tags[i][0]]), config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag", tags[i][0]);
		tag.setAttribute("tiddler", this.getAttribute("tiddler"));
	}
	if(tags.length == 0) jQuery("<li/>").addClass('disabled').text(lingo.popupNone).appendTo(popup);

	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev) {
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly) story.setTiddlerTag(title, tag, 0);
	return false;
};

config.macros.tagChooser.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(!(tiddler instanceof Tiddler)) return;
	var lingo = config.views.editor.tagChooser;
	createTiddlyButton(place, lingo.text, lingo.tooltip, this.onClick, null, null, null, {
		tiddler: tiddler.title,
		tags: params[0]
	});
};

config.macros.refreshDisplay.handler = function(place) {
	createTiddlyButton(place, this.label, this.prompt, this.onClick);
};

config.macros.refreshDisplay.onClick = function(e) {
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	var title = tiddler ? tiddler.title : null;
	var annotation = title ? config.annotations[title] : null;
	if(!tiddler || !title || !annotation) return;
	var text = annotation.format([title]);
	wikify(text, createTiddlyElement(place, "div", null, "annotation"), null, tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(
	place, title, params, label, prompt, accessKey, newFocus, isJournal
) {
	label = getParam(params, "label", label);
	prompt = getParam(params, "prompt", prompt);
	accessKey = getParam(params, "accessKey", accessKey);
	var customFields = getParam(params, "fields", "");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var tags = [];
	for(var i = 1; i < params.length; i++) {
		if((params[i].name == "anon" && i != 1) || (params[i].name == "tag"))
			tags.push(params[i].value);
	}
	var text = getParam(params, "text");

	var btn = createTiddlyButton(place, label, prompt, this.onClickNewTiddler, null, null, accessKey, {
		newTitle: title,
		isJournal: isJournal ? "true" : "false",
		newFocus: getParam(params, "focus", newFocus),
		newTemplate: getParam(params, "template", DEFAULT_EDIT_TEMPLATE)
	});
	if(tags.length > 0)
		btn.setAttribute("params", tags.join("|"));
	if(customFields !== "")
		btn.setAttribute("customFields", customFields);
	if(text !== undefined)
		btn.setAttribute("newText", text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function() {
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);

	story.displayTiddler(this, title, template, false, null, null); // #161
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem, customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title, "text"))
		story.getTiddlerField(title, "text").value = text.format([title]);
	for(var i = 0; i < tags.length; i++)
		story.setTiddlerTag(title, tags[i], +1);
	story.focusTiddler(title, focus);
	return false;
};

config.macros.newTiddler.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
	title = getParam(params, "title", title);
	this.createNewTiddlerButton(place, title, params, this.label, this.prompt, this.accessKey, "title", false);
};

config.macros.newJournal.handler = function(place, macroName, params, wikifier, paramString) {
	if(readOnly) return;
	params = paramString.parseParams("anon", null, true, false, false);
	var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
	title = getParam(params, "title", title);
	config.macros.newTiddler.createNewTiddlerButton(place, title,
		params, this.label, this.prompt, this.accessKey, "text", true);
};

//--
//-- Search macro
//--

config.macros.search.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	params = paramString.parseParams("anon", null, false, false, false);
	createTiddlyButton(place, this.label, this.prompt, this.onClick, "button searchButton");

	var attributes = {
		size: this.sizeTextbox,
		accessKey: getParam(params, "accesskey", this.accessKey),
		autocomplete: "off",
		lastSearchText: "",
		placeholder: getParam(params, "placeholder", this.placeholder)
	};
	if(config.browser.isSafari) {
		attributes.type = "search";
		attributes.results = "5";
	} else {
		attributes.type = "text";
	}

	var input = createTiddlyElement(place, "input", null, "txtOptionInput searchField", null, attributes);
	input.value = getParam(params, "anon", "");
	input.onkeyup = this.onKeyPress;
	input.onfocus = this.onFocus;
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(input) {
	if(input.value.length == 0) return;
	story.search(input.value, config.options.chkCaseSensitiveSearch, config.options.chkRegExpSearch);
	input.setAttribute("lastSearchText", input.value);
};

config.macros.search.onClick = function(e) {
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev) {
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) clearTimeout(me.timeout);
				var input = this;
				me.timeout = setTimeout(function() { me.doSearch(input) }, 500);
			}
		} else {
			if(me.timeout) clearTimeout(me.timeout);
		}
	}
};

config.macros.search.onFocus = function(e) {
	this.select();
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place, macroName, params) {
	var cookie = params[0];
	var numTabs = (params.length - 1) / 3;
	var wrapper = createTiddlyElement(null, "div", null, "tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper, "div", null, "tabset");
	tabset.setAttribute("cookie", cookie);
	var validTab = false;
	for(var i = 0; i < numTabs; i++) {
		var label = params[i * 3 + 1];
		var prompt = params[i * 3 + 2];
		var content = params[i * 3 + 3];
		var tab = createTiddlyButton(tabset, label, prompt, this.onClickTab, "tab tabUnselected");
		createTiddlyElement(tab, "span", null, null, " ", { style: "font-size:0pt;line-height:0px" });
		tab.setAttribute("tab", label);
		tab.setAttribute("content", content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset, config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e) {
	config.macros.tabs.switchTab(this.parentNode, this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset, tab) {
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var i = 0; i < nodes.length; i++) {
		if(nodes[i].getAttribute && nodes[i].getAttribute("tab") == tab) {
			theTab = nodes[i];
			theTab.className = "tab tabSelected";
		} else {
			nodes[i].className = "tab tabUnselected";
		}
	}
	if(!theTab) return;

	if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
		jQuery(tabset.nextSibling).remove();
	var tabContent = createTiddlyElement(null, "div", null, "tabContents");
	tabset.parentNode.insertBefore(tabContent, tabset.nextSibling);
	var contentTitle = theTab.getAttribute("content");
	wikify(store.getTiddlerText(contentTitle), tabContent, null, store.getTiddler(contentTitle));
	if(cookie) {
		config.options[cookie] = tab;
		saveOption(cookie);
	}
};

//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place, commandName, tiddler, className) {
	if(!(tiddler instanceof Tiddler)) return;
	if(typeof commandName != "string") {
		for(var name in config.commands) {
			if(config.commands[name] == commandName)
				commandName = name;
		}
	}
	if(typeof commandName != "string") return;
	var command = config.commands[commandName];
	if(command.isEnabled ? !command.isEnabled(tiddler) : !this.isCommandEnabled(command, tiddler))
		return;

	var text = command.getText ? command.getText(tiddler) : this.getCommandText(command, tiddler);
	var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command, tiddler);
	var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
	var btn = createTiddlyButton(place, text, tooltip, cmd, "button command_" + commandName, null, null, {
		commandName: commandName,
		tiddler: tiddler.title
	});
	if(className) jQuery(btn).addClass(className);
	if(commandName === 'permalink') {
		jQuery(btn).attr('href', config.commands.permalink.getUrl(tiddler.title));
	}
};

config.macros.toolbar.isCommandEnabled = function(command, tiddler) {
	var title = tiddler.title;
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	if(shadow && command.hideShadow) return false;
	var ro = tiddler.isReadOnly();
	return !ro || (ro && !command.hideReadOnly);
};

config.macros.toolbar.getCommandText = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e, this, this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var title = this.getAttribute("tiddler");
	popup.setAttribute("tiddler", title);
	var command = config.commands[this.getAttribute("commandName")];
	command.handlePopup(popup, title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place, className, event) {
	var children = place.getElementsByTagName("a");
	for(var i = 0; i < children.length; i++) {
		var c = children[i];
		if(jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c, event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev) {
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev) {
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	for(var i = 0; i < params.length; i++) {
		var commandName = params[i];
		switch(commandName) {
			case "!":
				createTiddlyText(place, this.separator);
				break;
			case "*":
				createTiddlyElement(place, "br");
				break;
			case "<":
				createTiddlyButton(place, this.lessLabel, this.lessPrompt,
					config.macros.toolbar.onClickLess, "button lessCommand");
				break;
			case ">":
				createTiddlyButton(place, this.moreLabel, this.morePrompt,
					config.macros.toolbar.onClickMore, "button moreCommand");
				place = createTiddlyElement(place, "span", null, "moreCommand");
				place.style.display = "none";
				break;
			default:
				var className = "";
				switch(commandName.substring(0, 1)) {
					case "+":
						className = "defaultCommand";
						commandName = commandName.substring(1);
						break;
					case "-":
						className = "cancelCommand";
						commandName = commandName.substring(1);
						break;
				}
				if(config.commands[commandName]) {
					this.createCommand(place, commandName, tiddler, className);
				} else {
					this.customCommand(place, commandName, wikifier, tiddler);
				}
				break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place, command, wikifier, tiddler) {
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event, src, title) {
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.closeTiddler(title, true);
	return false;
};

config.commands.closeOthers.handler = function(event, src, title) {
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event, src, title) {
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null, title, DEFAULT_EDIT_TEMPLATE, false, null, fields);

	var editorElement = story.getTiddlerField(title, config.options.txtEditorFocus || "text");
	if(editorElement) setCaretPosition(editorElement, 0);
	return false;
};

config.commands.saveTiddler.handler = function(event, src, title) {
	var newTitle = story.saveTiddler(title, event.shiftKey);
	if(newTitle) story.displayTiddler(null, newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event, src, title) {
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.displayTiddler(null, title);
	return false;
};

config.commands.deleteTiddler.handler = function(event, src, title) {
	var deleteIt = true;
	if(config.options.chkConfirmDelete) deleteIt = confirm(this.warning.format([title]));
	if(!deleteIt) return false;

	store.removeTiddler(title);
	story.closeTiddler(title, true);
	autoSaveChanges();
	return false;
};

config.commands.permalink.getUrl = function(title) {
	var hash = story.getPermaViewHash([title]);
	return window.location.href.replace(/#.*/, '') + hash;
};
config.commands.permalink.handler = function(event, src, title) {
	var hash = story.getPermaViewHash([title]);
	if(window.location.hash != hash) window.location.hash = hash;
	return false;
};

config.commands.references.handlePopup = function(popup, title) {
	var references = store.getReferringTiddlers(title);
	var hasRefs = false;
	for(var i = 0; i < references.length; i++) {
		if(references[i].title != title && !references[i].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup, "li"), references[i].title, true);
			hasRefs = true;
		}
	}
	if(!hasRefs) createTiddlyElement(popup, "li", null, "disabled", this.popupNone);
};

config.commands.jump.handlePopup = function(popup, title) {
	story.forEachTiddler(function(title, element) {
		createTiddlyLink(createTiddlyElement(popup, "li"), title, true, null, false, null, true);
	});
};

config.commands.fields.handlePopup = function(popup, title) {
	var tiddler = store.fetchTiddler(title);
	if(!tiddler) return;
	var items = [];
	store.forEachField(tiddler, function(tiddler, fieldName, value) {
		items.push({ field: fieldName, value: value });
	}, true);
	items.sort(function(a, b) { return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1) });

	if(items.length > 0) {
		ListView.create(popup, items, this.listViewTemplate);
	} else {
		createTiddlyElement(popup, "li", null, "disabled", this.emptyText);
	}
};

//--
//-- Tiddler() object
//--

function Tiddler(title) {
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function() {
	if(this.linksUpdated == false) this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function() {
	var f = {};
	for(var i in this.fields) {
		if(i == "server.host" || i == "server.workspace" || i == "wikiformat" || i == "server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function() {
	var c = this.fields['changecount'];
	c = c ? parseInt(c, 10) : 0;
	this.fields['changecount'] = String(c + 1);
};

Tiddler.prototype.clearChangeCount = function() {
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function() {
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function() {
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title, text, modifier, modified, tags, created, fields, creator) {
	this.assign(title, text, modifier, modified, tags, created, fields, creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title, text, modifier, modified, tags, created, fields, creator) {
	if(title != undefined) this.title = title;
	if(text != undefined) this.text = text;
	if(modifier != undefined) this.modifier = modifier;
	if(modified != undefined) this.modified = modified;
	if(creator != undefined) this.creator = creator;
	if(created != undefined) this.created = created;
	if(fields != undefined) this.fields = fields;
	if(tags != undefined) this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined) this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function() {
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag) {
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text) {
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function() {
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like .links array) after a change to a tiddler
Tiddler.prototype.changed = function() {
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g, "")
		.replace(/\{{3}((?:.|\n)*?)\}{3}/g, "")
		.replace(/"""((?:.|\n)*?)"""/g, "")
		.replace(/<nowiki\>((?:.|\n)*?)<\/nowiki\>/g, "")
		.replace(/<html\>((?:.|\n)*?)<\/html\>/g, "")
		.replace(/<script((?:.|\n)*?)<\/script\>/g, "");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t == 0 ?
		config.textPrimitives.tiddlerAnyLinkRegExp :
		config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t == 0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink + "|" +
					config.textPrimitives.anyLetter, "mg");
				preRegExp.lastIndex = formatMatch.index - 1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index - 1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2 - t] && !config.formatterHelpers.isExternalLink(formatMatch[3 - t]))
			// titledBrackettedLink
			this.links.pushUnique(formatMatch[3 - t]);
		else if(formatMatch[4 - t] && formatMatch[4 - t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4 - t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function() {
	var modifier = this.modifier || config.messages.subtitleUnknown || "";
	var modified = this.modified ?
		this.modified.toLocaleString() :
		config.messages.subtitleUnknown || "";
	var f = config.messages.tiddlerLinkTooltip || "%0 - %1, %2";
	return f.format([this.title, modifier, modified]);
};

Tiddler.prototype.isReadOnly = function() {
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function() {
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function() {
	var serverType = this.fields['server.type'] || this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType]) return null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function() {
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};

//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki(params) {
	var tiddlers = {}; // Hashmap by name of tiddlers
	if(params && params.config) {
		this.config = config;
	}
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var title in tiddlers) {
			var tiddler = tiddlers[title];
			if(tiddler instanceof Tiddler)
				callback.call(this, title, tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty) {
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function() {
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title) {
	return this.fetchTiddler(title) != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title) {
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.isAvailable = function(title) {
	if(!title) return false;
	var i = title.indexOf(config.textPrimitives.sectionSeparator);
	if(i != -1) title = title.substring(0, i);
	return this.tiddlerExists(title) || this.isShadowTiddler(title);
};

TiddlyWiki.prototype.createTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title) {
	return this.fetchTiddler(title) || null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title) {
	return (typeof config.shadowTiddlers[title] == "string")
		? config.shadowTiddlers[title]
		: "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title, defaultText) {
	if(!title) return defaultText;

	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0, pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var sliceNameStart = pos + config.textPrimitives.sliceSeparator.length;
		var slice = this.getTiddlerSlice(title.substr(0, pos), title.substr(sliceNameStart));
		if(slice) return slice;
	}

	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(!text) return defaultText != undefined ? defaultText : null;
	if(!section) return text;

	var headerRE = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)", "mg");
	headerRE.lastIndex = 0;
	var match = headerRE.exec(text);
	if(!match) return defaultText;

	var t = text.substr(match.index + match[1].length);
	var nextHeaderRE = /^!/mg;
	nextHeaderRE.lastIndex = 0;
	match = nextHeaderRE.exec(t);
	return !match ? t :
		// don't include final \n
		t.substr(0, match.index - 1);
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title, defaultText, depth) {
	var text = this.getTiddlerText(title, null);
	if(text == null) return defaultText;

	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])", "mg");
	var textOut = [], match, lastPos = 0;
	do {
		if(match = bracketRegExp.exec(text)) {
			textOut.push(text.substr(lastPos, match.index - lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1], "", depth - 1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|\x20?([\'\/]{0,2})~?([^\|\s\:\~\'\/]|(?:[^\|\s~\'\/][^\|\n\f\r]*[^\|\s\:\'\/]))\:?\4[\x20\t]*\|[\t\x20]*([^\n\t\x20](?:[^\n]*[^\n\t\x20])?)[\t\x20]*\|$)/gm; // #112
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title) {
	var text = this.getTiddlerText(title, "");
	this.slicesRE.lastIndex = 0;
	var slices = {}, m;
	while(m = this.slicesRE.exec(text)) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title, sliceName) {
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title, sliceNames) {
	var i, r = {};
	for(i = 0; i < sliceNames.length; i++) {
		var slice = this.getTiddlerSlice(title, sliceNames[i]);
		if(slice) r[sliceNames[i]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function() {
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function() {
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title, doBlanket) {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if((n.name == null && doBlanket) || (n.name == title))
			n.notify(title);
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function() {
	if(this.notificationLevel) return;
	for(var i = 0; i < this.namedNotifications.length; i++) {
		var n = this.namedNotifications[i];
		if(n.name)
			n.notify(n.name);
	}
};

// Add a notification handler to a tiddler unless it's already set
TiddlyWiki.prototype.addNotification = function(title, fn) {
	for(var i = 0; i < this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({ name: title, notify: fn });
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title, true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title, true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title, status, tag) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	var t = tiddler.tags.indexOf(tag);
	if(t != -1)
		tiddler.tags.splice(t, 1);
	if(status)
		tiddler.tags.push(tag);

	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

TiddlyWiki.prototype.addTiddlerFields = function(title, fields) {
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) return;

	merge(tiddler.fields, fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title, true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(titleOrTiddler, newTitle, newBody,
	modifier, modified, tags, fields, clearChangeCount, created, creator) {
	var wasTiddlerProvided = titleOrTiddler instanceof Tiddler;
	var tiddler = this.resolveTiddler(titleOrTiddler);
	var title = tiddler ? tiddler.title : titleOrTiddler;
	newTitle = newTitle || title;

	if(tiddler) {
		this.deleteTiddler(title); //# clean up slices for title, make sure the tiddler is not copied when renamed
		created = created || tiddler.created; // Preserve created date
		creator = creator || tiddler.creator;
	} else {
		tiddler = new Tiddler();
		created = created || modified;
	}

	if(wasTiddlerProvided) {
		tiddler.fields = merge(merge({}, tiddler.fields), config.defaultCustomFields, true);
	} else {
		fields = merge(merge({}, fields), config.defaultCustomFields, true);
		tiddler.set(newTitle, newBody, modifier, modified, tags, created, fields, creator);
	}
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();

	this.addTiddler(tiddler); //# clean up slices for newTitle, add/return the tiddler
	if(title != newTitle) this.notify(title, true);
	this.notify(newTitle, true);
	this.setDirty(true);

	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title) {
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function() {
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function() {
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function() {
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src, idPrefix, noUpdate) {
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem) return;

	this.idPrefix = idPrefix;
	var tiddlers = this.getLoader().loadTiddlers(this, storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0; i < tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text) {
	var posDiv = locateStoreArea(text);
	if(!posDiv) return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0], posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";

	// Create an iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6

	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();

	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea, "store");

	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function() {
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title, tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp, sortField, excludeTag, match) {
	var candidates = this.reverseLookup("tags", excludeTag, !!match);
	var i, results = [];
	for(i = 0; i < candidates.length; i++) {
		if((candidates[i].title.search(searchRegExp) != -1) || (candidates[i].text.search(searchRegExp) != -1))
			results.push(candidates[i]);
	}
	if(!sortField) sortField = "title";
	results.sort(function(a, b) { return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1) });
	return results;
};

// Returns a list of all tags in use (in the form of an array of [tagName, numberOfOccurances] "tuples")
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
TiddlyWiki.prototype.getTags = function(excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
	    var i, j;
		for(i = 0; i < tiddler.tags.length; i++) {
			var tag = tiddler.tags[i];
			var isTagToAdd = true;
			for(j = 0; j < results.length; j++) {
				if(results[j][0] == tag) {
					isTagToAdd = false;
					results[j][1]++;
				}
			}
			if(isTagToAdd && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					isTagToAdd = false;
			}
			if(isTagToAdd) results.push([tag, 1]);
		}
	});
	results.sort(function(a, b) {
		var tag1 = a[0].toLowerCase(), tag2 = b[0].toLowerCase();
		return tag1 < tag2 ? -1 : (tag1 == tag2 ? 0 : +1);
	});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag, sortField) {
	return this.reverseLookup("tags", tag, true, sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field, value, sortField) {
	return this.reverseLookup(field, value, true, sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title, unusedParameter, sortField) {
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links", title, true, sortField);
};

// Return an array of the tiddlers that have a specified entry (lookupValue) in the specified field (lookupField, like "links" or "tags")
// if shouldMatch == true, or don't have such entry (if shouldMatch == false)
TiddlyWiki.prototype.reverseLookup = function(lookupField, lookupValue, shouldMatch, sortField) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			var accessor = TiddlyWiki.standardFieldAccess[lookupField];
			values = accessor ? [ accessor.get(tiddler) ] :
				( tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [] );
		}

		var hasMatch = false;
		for(var i = 0; i < values.length; i++) {
			if(values[i] == lookupValue)
				hasMatch = true;
		}
		if(hasMatch == !!shouldMatch) results.push(tiddler);
	});
	return this.sortTiddlers(results, sortField || "title");
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field, excludeTag) {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field) results.sort(function(a, b) { return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1) });
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function() {
	if(!this.tiddlersUpdated) this.updateTiddlers();

	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;

		for(var i = 0; i < tiddler.links.length; i++) {
			var link = tiddler.links[i];
			if(this.getTiddlerText(link, null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function() {
	var results = [];
	this.forEachTiddler(function (title, tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function() {
	var t, results = [];
	for(t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function() {
	var results = [];
	this.forEachTiddler(function(title, tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
	});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler) {
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers, field) {
	var asc = +1;
	switch(field.substr(0, 1)) {
		case "-":
			asc = -1;
			field = field.substr(1);
			break;
		case "+":
			field = field.substr(1);
			break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field == "title") {
			tiddlers.sort(function(a, b) {
				var t1 = a[field].toLowerCase(), t2 = b[field].toLowerCase();
				return t1 < t2 ? -asc : (t1 == t2 ? 0 : asc);
			});
		} else {
			tiddlers.sort(function(a, b) {
				return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);
			});
		}
	} else {
		tiddlers.sort(function(a, b) {
			return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);
		});
	}
	return tiddlers;
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results, match) {
		var title = match[1] || match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title, this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results, match) {
		var i, matched = this.getTaggedTiddlers(match[3]);
		for(i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	},
	sort: function(results, match) {
		return this.sortTiddlers(results, match[3]);
	},
	limit: function(results, match) {
		return results.slice(0, parseInt(match[3], 10));
	},
	field: function(results, match) {
		var i, matched = this.getValueTiddlers(match[2], match[3]);
		for (i = 0; i < matched.length; i++) {
			results.pushUnique(matched[i]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter, results) {
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	results = results || [];
	if(filter) {
		var match;
		while(match = re.exec(filter)) {
			var handler = (match[1] || match[4]) ? 'tiddler' :
				config.filters[match[2]] ? match[2] : 'field';
			results = config.filters[handler].call(this, results, match);
		}
	}
	return results;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name) {
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name) {
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(fName, readOnly) {
	this.set = readOnly ?
		function(tiddler, newValue) {
			if(newValue != tiddler[fName]) throw config.messages.fieldCannotBeChanged.format([fName]);
		} :
		function(tiddler, newValue) {
			if(newValue == tiddler[fName]) return;
			tiddler[fName] = newValue;
			return true;
		};
	this.get = function(tiddler) { return tiddler[fName] };
}

function DateFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var d = newValue instanceof Date ? newValue : Date.convertFromYYYYMMDDHHMM(newValue);
		if(d == tiddler[fName]) return;
		tiddler[fName] = d;
		return true;
	};
	this.get = function(tiddler) { return tiddler[fName].convertToYYYYMMDDHHMM() };
}

function LinksFieldAccess(fName) {
	this.set = function(tiddler, newValue) {
		var items = (typeof newValue == "string") ? newValue.readBracketedList() : newValue;
		if(items.toString() == tiddler[fName].toString()) return;
		tiddler[fName] = items;
		return true;
	};
	this.get = function(tiddler) { return String.encodeTiddlyLinkList(tiddler[fName]) };
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title", true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title", true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name) {
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddlerOrTitle, fieldName, value) {
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return;

	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		// don't remove StandardFields
		if(isRemove) return;
		if(!accessor.set(t, value)) return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^" + fieldName + "\\.");
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty) return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience convert Date -> String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value) return;
			t.fields[fieldName] = value;
		}
	}

	// When we are here the tiddler/store really was changed.
	this.notify(t.title, true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddlerOrTitle, fieldName) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	if(fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 ||
	   fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0
	) {
		var separator = fieldName.substr(0, 2);
		var partName = fieldName.substring(2);
		return store.getTiddlerText(t.title + separator + partName);
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = TiddlyWiki.standardFieldAccess[fieldName];
		if(accessor) return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler, fieldName, value).
TiddlyWiki.prototype.forEachField = function(tiddlerOrTitle, callback, onlyExtendedFields) {
	var t = this.resolveTiddler(tiddlerOrTitle);
	if(!t) return undefined;

	var name, result;
	for(name in t.fields) {
		result = callback(t, name, t.fields[name]);
		if(result) return result;
	}

	if(onlyExtendedFields) return undefined;
	for(name in TiddlyWiki.standardFieldAccess) {
		// even though the "title" field can also be referenced through the name "tiddler"
		// we only visit this field once.
		if(name == "tiddler") continue;

		result = callback(t, name, TiddlyWiki.standardFieldAccess[name].get(t));
		if(result) return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

// A story is a HTML div containing a sequence of tiddlers that can be manipulated
//  container - id of containing element
//  idPrefix - string prefix prepended to title to make ids for tiddlers in this story
function Story(containerId, idPrefix) {
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		var validId = title.replace(/_/g, "__").replace(/ /g, "_");
		var id = this.idPrefix + validId;
		return id == this.container ? this.idPrefix + "_" + validId : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title) {
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function() {
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(handleTiddler) {
	var place = this.getContainer();
	if(!place) return;
	var el = place.firstChild;
	while(el) {
		var next = el.nextSibling;
		var title = el.getAttribute("tiddler");
		if(title) {
			handleTiddler.call(this, title, el);
		}
		el = next;
	}
};

Story.prototype.displayTiddler = function(srcElement, tiddler,
	template, animate, unused, customFields, toggle, animationSrc) {
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title, true);
		} else {
			this.refreshTiddler(title, template, false, customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place, before, title, template, customFields);
	}

	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim &&
		   typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title, srcElement, tiddlerElem), new Scroller(tiddlerElem));
		else
			window.scrollTo(0, ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.displayTiddlers = function(srcElement, titles, template, animate, unused, customFields, toggle) {
	for(var i = titles.length - 1; i >= 0; i--)
		this.displayTiddler(srcElement, titles[i], template, animate, unused, customFields);
};

Story.prototype.displayDefaultTiddlers = function() {
	this.displayTiddlers(null, store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.positionTiddler = function(srcElement) {
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place, before, title, template, customFields) {
	var tiddlerElem = createTiddlyElement(null, "div", this.tiddlerId(title), "tiddler");
	tiddlerElem.setAttribute("refresh", "tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields", customFields);
	place.insertBefore(tiddlerElem, before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title, customFields);
	this.refreshTiddler(title, template, false, customFields, defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title, fields, callback) {
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields || {};
	var context = { serverType: tiddler.getServerType() };
	if(!context.serverType) return "";
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType]();

	var onLoadTiddlerResponse = function(context) {
		if(context.status) {
			var t = context.tiddler;
			t.created  = t.created  || new Date();
			t.modified = t.modified || t.created;
			var dirty = store.isDirty();
			context.tiddler = store.saveTiddler(t.title, t.title, t.text, t.modifier, t.modified,
				t.tags, t.fields, true, t.created, t.creator);
			if(!window.allowSave())
				store.setDirty(dirty);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title, null, true);
		}
		context.adaptor.close();
		if(callback) callback(context);
	};
	adaptor.getTiddler(title, context, null, onLoadTiddlerResponse);
	return config.messages.loadingMissingTiddler.format([title, context.serverType, context.host, context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title, template) {
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title, template, tiddler) {
	return store.getRecursiveTiddlerText(template, null, 10);
};

Story.prototype.refreshTiddler = function(title, template, force, customFields, defaultText) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	if(tiddlerElem.getAttribute("dirty") == "true" && !force)
		return tiddlerElem;
	template = this.chooseTemplateForTiddler(title, template);
	var currTemplate = tiddlerElem.getAttribute("template");
	if((template == currTemplate) && !force)
		return tiddlerElem;

	var tiddler = store.getTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler();
		if(store.isShadowTiddler(title)) {
			var tags = [];
			tiddler.set(title, store.getTiddlerText(title),
				config.views.wikified.shadowModifier, version.date, tags, version.date);
		} else {
			var text = template == config.tiddlerTemplates[DEFAULT_EDIT_TEMPLATE] // #166
				? config.views.editor.defaultText.format([title])
				: config.views.wikified.defaultText.format([title]);
			text = defaultText || text;
			var fields = customFields ? customFields.decodeHashMap() : null;
			tiddler.set(title, text, config.views.wikified.defaultModifier, version.date, [], version.date, fields);
		}
	}

	tiddlerElem.setAttribute("tags", tiddler.tags.join(" "));
	tiddlerElem.setAttribute("tiddler", title);
	tiddlerElem.setAttribute("template", template);
	tiddlerElem.onmouseover = this.onTiddlerMouseOver;
	tiddlerElem.onmouseout = this.onTiddlerMouseOut;
	tiddlerElem.ondblclick = this.onTiddlerDblClick;
	tiddlerElem[window.event ? "onkeydown" : "onkeypress"] = this.onTiddlerKeyPress;
	tiddlerElem.innerHTML = this.getTemplateForTiddler(title, template, tiddler);
	applyHtmlMacros(tiddlerElem, tiddler);
	if(store.getTaggedTiddlers(title).length > 0)
		jQuery(tiddlerElem).addClass("isTag");
	else
		jQuery(tiddlerElem).removeClass("isTag");
	if(store.tiddlerExists(title)) {
		jQuery(tiddlerElem).removeClass("shadow");
		jQuery(tiddlerElem).removeClass("missing");
	} else {
		jQuery(tiddlerElem).addClass(store.isShadowTiddler(title) ? "shadow" : "missing");
	}
	if(customFields)
		this.addCustomFields(tiddlerElem, customFields);

	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place, customFields) {
	var fields = customFields.decodeHashMap();
	var container = createTiddlyElement(place, "div", null, "customFields");
	container.style.display = "none";
	for(var fieldName in fields) {
		var input = document.createElement("input");
		input.setAttribute("type", "text");
		input.setAttribute("value", fields[fieldName]);
		container.appendChild(input);
		input.setAttribute("edit", fieldName);
	}
};

Story.prototype.refreshAllTiddlers = function(force) {
	this.forEachTiddler(function(title, element) {
		var template = element.getAttribute("template");
		if(template && element.getAttribute("dirty") != "true") {
			this.refreshTiddler(title, force ? null : template, true);
		}
	});
};

Story.prototype.onTiddlerMouseOver = function() {
	jQuery(this).addClass("selected");
};

Story.prototype.onTiddlerMouseOut = function() {
	jQuery(this).removeClass("selected");
};

Story.prototype.onTiddlerDblClick = function(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(!target || target.nodeName.toLowerCase() == "input" || target.nodeName.toLowerCase() == "textarea")
		return false;
	if(document.selection && document.selection.empty)
		document.selection.empty();
	config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return true;
};

Story.prototype.onTiddlerKeyPress = function(ev) {
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			var editor = story.getTiddlerField(title, "text");
			if(target.tagName.toLowerCase() == "input"
			   && editor.value == config.views.editor.defaultText.format([title])) {
				// moving from input field and editor still contains default text, so select it
				editor.focus();
				editor.select();
				consume = true;
			}
			if(config.options.chkInsertTabs && !e.ctrlKey && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target, String.fromCharCode(9));
				consume = true;
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this, "defaultCommand", e);
				consume = true;
			}
			break;
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this, "cancelCommand", e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title, field) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var $editors = jQuery(tiddlerElem).find('input, textarea');
	return $editors.filter('[edit="' + field + '"]')[0] || $editors[0] || null;
};

Story.prototype.focusTiddler = function(title, field) {
	var e = this.getTiddlerField(title, field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title, tag, mode, field) {
	var editor = this.getTiddlerField(title, field);
	var tags = editor.value.readBracketedList();

	var i = tags.indexOf(tag);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) tags.push(tag);
	} else if(mode == -1) {
		if(i != -1) tags.splice(i, 1);
	}

	editor.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title, tag, mode) {
	this.setTiddlerField(title, tag, mode, "tags");
};

Story.prototype.closeTiddler = function(title, shouldAnimate, unused) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return;

	clearMessage();
	this.scrubTiddler(tiddlerElem);
	if(config.options.chkAnimate && shouldAnimate && anim && typeof Slider == "function") {
		anim.startAnimating(new Slider(tiddlerElem, false, null, "all"));
	} else {
		jQuery(tiddlerElem).remove();
	}
};

Story.prototype.scrubTiddler = function(tiddlerElement) {
	tiddlerElement.id = null;
};

// 'dirty' flag attribute is used on tiddlers to mark those having unsaved changes

Story.prototype.setDirty = function(title, dirty) {
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty", dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;
	return tiddlerElem.getAttribute("dirty") == "true";
};

Story.prototype.areAnyDirty = function() {
	var r = false;
	this.forEachTiddler(function(title, element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude) {
	clearMessage();
	this.forEachTiddler(function(title, element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0, ensureVisible(this.container));
};

Story.prototype.isEmpty = function() {
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text, useCaseSensitive, useRegExp) {
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(), useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack, "title", "excludeSearch");
	this.displayTiddlers(null, matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(), q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(el) {
	while(el && !jQuery(el).hasClass("tiddler")) {
		el = jQuery(el).hasClass("popup") && Popup.stack[0] ? Popup.stack[0].root
			: el.parentNode;
	}
	return el;
};

Story.prototype.gatherSaveFields = function(el, fields) {
	if(!el || !el.getAttribute) return;
	var fieldName = el.getAttribute("edit");
	if(fieldName)
		fields[fieldName] = el.value.replace(/\r/mg, "");
	if(el.hasChildNodes()) {
		for(var i = 0; i < el.childNodes.length; i++)
			this.gatherSaveFields(el.childNodes[i], fields);
	}
};

Story.prototype.hasChanges = function(title) {
	var tiddlerElement = this.getTiddler(title);
	if(!tiddlerElement) return false;

	var fields = {};
	this.gatherSaveFields(tiddlerElement, fields);
	if(store.fetchTiddler(title)) {
		for(var fieldName in fields) {
			if(store.getValue(title, fieldName) != fields[fieldName])
				return true;
		}
		return false;
	}
	if(store.isShadowTiddler(title)) {
		// not checking for title or tags
		return store.getShadowTiddlerText(title) != fields.text;
	}
	// new tiddler
	return true;
};

Story.prototype.saveTiddler = function(title, minorUpdate) {
	var tiddlerElem = this.getTiddler(title);
	if(!tiddlerElem) return null;

	var fields = {};
	this.gatherSaveFields(tiddlerElem, fields);
	var newTitle = fields.title || title;
	if(!store.tiddlerExists(newTitle)) {
		newTitle = newTitle.trim();
		var creator = config.options.txtUserName;
	}
	if(store.tiddlerExists(newTitle) && newTitle != title) {
		if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
			return null;
	}
	if(newTitle != title)
		this.closeTiddler(newTitle, false);
	tiddlerElem.id = this.tiddlerId(newTitle);
	tiddlerElem.setAttribute("tiddler", newTitle);
	tiddlerElem.setAttribute("template", DEFAULT_VIEW_TEMPLATE);
	tiddlerElem.setAttribute("dirty", "false");
	if(config.options.chkForceMinorUpdate)
		minorUpdate = !minorUpdate;
	if(!store.tiddlerExists(newTitle))
		minorUpdate = false;
	if(store.tiddlerExists(title)) {
		var t = store.fetchTiddler(title);
		var extendedFields = t.fields;
		creator = t.creator;
	} else {
		extendedFields = merge({}, config.defaultCustomFields);
	}
	for(var n in fields) {
		if(!TiddlyWiki.isStandardField(n))
			extendedFields[n] = fields[n];
	}
	var tiddler = store.saveTiddler(title, newTitle, fields.text, minorUpdate ? undefined : config.options.txtUserName,
		minorUpdate ? undefined : new Date(), fields.tags, extendedFields, null, null, creator);
	autoSaveChanges(null, [tiddler]);
	return newTitle;
};

Story.prototype.getPermaViewHash = function(titles) {
	return '#' + encodeURIComponent(String.encodeTiddlyLinkList(titles));
};

Story.prototype.permaView = function() {
	var titles = [];
	this.forEachTiddler(function(title, element) {
		titles.push(title);
	});
	var hash = this.getPermaViewHash(titles);
	if(window.location.hash != hash)
		window.location.hash = hash;
};

Story.prototype.switchTheme = function(theme) {
	if(safeMode) return;

	var getSlice = function(theme, slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme, slice + "ReadOnly") || store.getTiddlerSlice(theme, "Web" + slice);
		r = r || store.getTiddlerSlice(theme, slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator) == 0)
			r = theme + r;
		return store.isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i, name, theme, slice) {
		var newName = getSlice(theme, slice);
		if(name != newName && store.namedNotifications[i].name == name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	for(var i = 0; i < config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
			case "PageTemplate":
				config.refresherData.pageTemplate = replaceNotification(i, config.refresherData.pageTemplate, theme, name);
				break;
			case "StyleSheet":
				removeStyleSheet(config.refresherData.styleSheet);
				config.refresherData.styleSheet = replaceNotification(i, config.refresherData.styleSheet, theme, name);
				break;
			case "ColorPalette":
				config.refresherData.colorPalette = replaceNotification(i, config.refresherData.colorPalette, theme, name);
				break;
			default:
				break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme, "ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme, "EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate != pt || config.tiddlerTemplates[vi] != vt
		   || config.tiddlerTemplates[ei] != et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet, "", 10),
				config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};

//--
//-- Backstage
//--
// Backstage tasks
config.tasks.save.action = saveChanges;

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var text = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button, text, cmb.open.tooltip,
			function(e) { backstage.show(); return false }, null, "backstageShow");
		text = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button, text, cmb.close.tooltip,
			function(e) { backstage.hide(); return false }, null, "backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel, "div", null, "backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel, "div", null, "backstagePanelBody");
		this.cloak.onmousedown = function(e) { backstage.switchTab(null) };
		createTiddlyText(this.toolbar, cmb.prompt);
		for(var i = 0; i < config.backstageTasks.length; i++) {
			var taskName = config.backstageTasks[i];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar, text, task.tooltip, handler, "backstageTab");
			jQuery(btn).addClass(task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
		}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: findWindowWidth(), end: 0, template: "%0px" }
			]));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		jQuery(this.content).addClass("backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			// close current tab, not backstage
			this.switchTab(null);
			return;
		}

		backstage.toolbar.style.left = "0px";
		var hide = function() { backstage.area.style.display = "none" };
		if(anim && config.options.chkAnimate) {
			anim.startAnimating(new Morpher(backstage.toolbar, config.animDuration, [
				{ style: "left", start: 0, end: findWindowWidth(), template: "%0px" }
			], hide));
		} else {
			hide();
		}
		this.showButton.style.display = "block";
		this.hideButton.style.display = "none";
		config.options.chkBackstage = false;
		saveOption("chkBackstage");
		jQuery(this.content).removeClass("backstageVisible");
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e) {
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
		}
		if(tabName == this.currTabName) {
			this.hidePanel();
			return;
		}
		if(this.currTabElem) {
			jQuery(this.currTabElem).removeClass("backstageSelTab");
		}
		if(tabElem && tabName) {
			this.preparePanel();
			jQuery(tabElem).addClass("backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content, this.panelBody, null, null);
			this.showPanel();
		} else if(this.currTabElem) {
			this.hidePanel();
		}
		this.currTabName = tabName;
		this.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findDocHeight() + "px";
		backstage.cloak.style.display = "block";
		jQuery(backstage.panelBody).empty();
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px" }
			]), new Scroller(backstage.panel, false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			jQuery(backstage.currTabElem).removeClass("backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var callback = function() { backstage.cloak.style.display = "none" };
			anim.startAnimating(new Morpher(backstage.panel, config.animDuration, [
				{ style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px" },
				{ style: "display", atEnd: "none" }
			], callback));
		} else {
			jQuery([backstage.panel, backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place, macroName, params) {
	var backstageTask = config.tasks[params[0]];
	if(!backstageTask) return;
	createTiddlyButton(place, backstageTask.text, backstageTask.tooltip, function(e) {
		backstage.switchTab(params[0]);
		return false;
	});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place, macroName, params, wikifier, paramString, tiddler) {
	if(readOnly) {
		createTiddlyElement(place, "div", null, "marked", this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e) {
	var wizard = new Wizard(this);
	wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e) {
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard) {
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title, this.step1Html);

	var name, s = wizard.getElement("selTypes");
	for(name in config.adaptors) {
		var e = createTiddlyElement(s, "option", null, null, config.adaptors[name].serverLabel || name);
		e.value = name;
	}
	if(config.defaultAdaptor) s.value = config.defaultAdaptor;

	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(name in feeds) {
		e = createTiddlyElement(s, "option", null, null, name);
		e.value = name;
	}
	wizard.setValue("feeds", feeds);
	s.onchange = me.onFeedChange;

	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{ caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen }]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function() {
	var feeds = {};
	var i, tagged = store.getTaggedTiddlers("systemServer", "title");
	for(i = 0; i < tagged.length; i++) {
		var title = tagged[i].title;
		feeds[title] = {
			title: title,
			url: store.getTiddlerSlice(title, "URL"),
			workspace: store.getTiddlerSlice(title, "Workspace"),
			workspaceList: store.getTiddlerSlice(title, "WorkspaceList"),
			tiddlerFilter: store.getTiddlerSlice(title, "TiddlerFilter"),
			serverType: store.getTiddlerSlice(title, "Type") || "file",
			description: store.getTiddlerSlice(title, "Description")
		};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e) {
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName", f.serverType);
		wizard.setValue("feedHost", f.url);
		wizard.setValue("feedWorkspace", f.workspace);
		wizard.setValue("feedWorkspaceList", f.workspaceList);
		wizard.setValue("feedTiddlerFilter", f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e) {
	var wizard = new Wizard(this);
	var file = this.value;
	file = file.replace(/^C:\\fakepath\\/i, ''); // remove fakepath (chrome/opera/safari)
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
			file = this.files[0].fileName; // REQUIRES PRIVILEGES.. NULL otherwise
		} catch (ex) {
			// non-priv fallback: combine filename with path to current document
			var path = tw.io.getOriginalLocalPath();
			var slashpos = path.lastIndexOf('/');
			if (slashpos == -1) slashpos = path.lastIndexOf('\\');
			if (slashpos != -1) path = path.substr(0, slashpos + 1); // remove filename, leave trailing slash
			file = path + file;
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(file);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(path) {
	if(!path) return path;
	// use "/" for cross-platform consistency
	path = path.replace(/\\/g, "/");

	var t = path.split(":");
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		// input is already a URL
		return path;
	}

	var p = t[1] || t[0]; // remove drive letter (if any)
	if(p.substr(0, 1) == "/") {
		// path is absolute, add protocol + domain + extra slash (if drive letter)
		return document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + path;
	}

	// path is relative, add current document protocol + domain + path
	var c = document.location.href.replace(/\\/g, "/");
	var pos = c.lastIndexOf("/");
	if(pos != -1)
		c = c.substring(0, pos); // remove filename
	return c + "/" + p;
};

config.macros.importTiddlers.onOpen = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor", adaptor);
	wizard.setValue("serverType", serverType);
	wizard.setValue("host", url);
	adaptor.openHost(url, null, wizard, me.onOpenHost);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context, wizard) {
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	adaptor.getWorkspaceList(context, wizard, me.onGetWorkspaceList);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context", context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length == 1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		context.adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
		wizard.setValue("workspace", workspace);
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title, me.step2Html);
	var i, s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(i = 0; i < context.workspaces.length; i++) {
		var e = createTiddlyElement(s, "option", null, null, context.workspaces[i].title);
		e.value = context.workspaces[i].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var list = workspaceList.parseParams("workspace", null, false, true);
		for(i = 1; i < list.length; i++) {
			if(context.workspaces.findByField("title", list[i].value) == null) {
				e = createTiddlyElement(s, "option", null, null, list[i].value);
				e.value = list[i].value;
			}
		}
	}
	if(workspace) {
		wizard.getElement("txtWorkspace").value = workspace;
	}
	wizard.setButtons([{ caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace }]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e) {
	var wizard = new Wizard(this);
	wizard.getElement("txtWorkspace").value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace", workspace);
	var context = wizard.getValue("context");
	adaptor.openWorkspace(workspace, context, wizard, me.onOpenWorkspace);
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	var browse = wizard.getElement("txtBrowse");
	if (browse.files) context.file = browse.files[0]; // for HTML5 FileReader
	adaptor.getTiddlerList(context, wizard, me.onGetTiddlerList, wizard.getValue("feedTiddlerFilter"));
	wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context, wizard) {
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		var error = context.statusText || me.errorGettingTiddlerList;
		if(context.host.indexOf("file://") === 0) {
			error = me.errorGettingTiddlerListFile;
		} else {
			error = context.xhr && context.xhr.status == 404 ? me.errorGettingTiddlerListHttp404 :
				me.errorGettingTiddlerListHttp;
		}
		wizard.setButtons([{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }], "");
		jQuery("span.status", wizard.footerEl).html(error); // so error message can be html
		return;
	}

	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		for(var i = 0; i < context.tiddlers.length; i++) {
			var tiddler = context.tiddlers[i];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text, 100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a, b) { return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1) });

	// Display the listview
	wizard.addStep(me.step3Title, me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	var listView = ListView.create(listWrapper, listedTiddlers, me.listViewTemplate);
	wizard.setValue("listView", listView);
	wizard.setValue("context", context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel },
		{ caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport }
	]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard) {
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType, host, workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard) {
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType, host, workspace]);
	store.saveTiddler(txtSaveTiddler, txtSaveTiddler, text, me.serverSaveModifier, new Date(), ["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e) {
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync", chkSync);

	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	for(var i = 0; i < rowNames.length; i++) {
		if(store.tiddlerExists(rowNames[i]))
			overwrite.push(rowNames[i]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}

	wizard.addStep(me.step4Title.format([rowNames.length]), me.step4Html);
	for(i = 0; i < rowNames.length; i++) {
		var linkHolder = document.createElement("div");
		createTiddlyLink(linkHolder, rowNames[i], true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(linkHolder, place);
	}
	wizard.setValue("remainingImports", rowNames.length);
	wizard.setButtons([
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	], me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(i = 0; i < rowNames.length; i++) {
		var context = {
			allowSynchronous: true,
			tiddler: tiddlers[tiddlers.findByField("title", rowNames[i])]
		};
		adaptor.getTiddler(rowNames[i], context, wizard, me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context, wizard) {
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier,
		tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title, 'server', null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous) store.notify(tiddler.title, true);

	var remainingImports = wizard.getValue("remainingImports") - 1;
	wizard.setValue("remainingImports", remainingImports);

	if(remainingImports != 0) return;
	if(context.isSynchronous) {
		store.notifyAll();
		refreshDisplay();
	}
	var me = config.macros.importTiddlers;
	wizard.setButtons([
		{ caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose }
	], me.statusDoneImport);
	autoSaveChanges();
};

//--
//-- Upgrade macro
//--

config.macros.upgrade.docsUrl = 'https://classic.tiddlywiki.com/#HowToUpgrade';

config.macros.upgrade.getSourceURL = function() {
	return config.options.txtUpgradeCoreURI || config.macros.upgrade.source;
};

config.macros.upgrade.loadLatestCore = function(onSuccess, onError) {
	ajaxReq({
		type: "GET",
		url: this.getSourceURL(),
		processData: false,
		success: onSuccess,
		error: onError
	});
};

config.macros.upgrade.handler = function(place) {
	var w = new Wizard();
	w.createWizard(place, this.wizardTitle);
	w.addStep(this.step1Title, this.step1Html.format([
		this.getSourceURL(),
		this.getSourceURL().replace(/^https:\/\//, ''),
		this.docsUrl
	]));
	w.setButtons([{
		caption: this.upgradeLabel,
		tooltip: this.upgradePrompt,
		onClick: this.onClickUpgrade
	}]);
};

config.macros.upgrade.onClickUpgrade = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(!window.allowSave()) {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}

	w.setButtons([], me.statusPreparingBackup);
	var localPath = tw.io.getOriginalLocalPath();
	var backupPath = getBackupPath(localPath, me.backupExtension);
	var original = loadOriginal(localPath);

	w.setButtons([], me.statusSavingBackup);
	var backupSuccessOrPending = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(!backupSuccessOrPending) {
		w.setButtons([], me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}

	// make sure both the backup is saved and tw.io.loadFile works before proceeding
	tw.io.loadFile(backupPath, function(backupContent) {
		if(!backupContent) {
			w.setButtons([], me.errorVerifyingBackup.format([me.docsUrl]));
			return;
		}

		w.setValue("backupPath", backupPath);

		w.setButtons([], me.statusLoadingCore);
		var sourceURL = me.getSourceURL();
		me.loadLatestCore(function(data, textStatus, jqXHR) {
			me.onLoadCore(true, w, jqXHR.responseText, sourceURL, jqXHR);
		}, function(jqXHR, textStatus, errorThrown) {
			me.onLoadCore(false, w, null, sourceURL, jqXHR);
		});
	});

	return false;
};

config.macros.upgrade.onLoadCore = function(status, w, responseText, url, xhr) {
	var me = config.macros.upgrade;
	var errMsg;
	if(!status) errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer) errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([], errMsg);
		alert(errMsg);
		return;
	}

	var step2 = [me.step2Html_downgrade, me.step2Html_restore, me.step2Html_upgrade][compareVersions(version, newVer) + 1];
	w.addStep(me.step2Title, step2.format([formatVersion(newVer), formatVersion(version)]));
	w.setButtons([
		{ caption: me.startLabel,  tooltip: me.startPrompt,  onClick: function() {
			config.macros.upgrade.onStartUpgrade(w, responseText);
		} },
		{ caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel }
	]);
};

config.macros.upgrade.onStartUpgrade = function(wizard, newCoreHtml) {
	wizard.setButtons([], config.macros.upgrade.statusSavingCore);
	var localPath = tw.io.getOriginalLocalPath();
	saveFile(localPath, newCoreHtml);

	wizard.setButtons([], config.macros.upgrade.statusReloadingCore);
	var backupPath = wizard.getValue("backupPath");
	var newLocation = addUpgradePartsToURI(document.location.toString(), backupPath);
	window.setTimeout(function () { window.location = newLocation }, 10);
};

config.macros.upgrade.onCancel = function(e) {
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title, me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile) {
	var re = /version = \{\s*title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return !m ? null : {
		title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])
	};
};

// a helper, splits uri into parts, passes the map of parts to modify and glues parts back
function changeUri(uri, modify) {
	var uriPartsRE = /^(?:([\w:]+)\/\/)?([^\/\?#]+)?([^\?#]+)?(?:\?([^#]*))?(?:#(.*))?$/;
	var match = uriPartsRE.exec(uri) || [null, '', '', '', '', ''];
	var parts = {
		scheme:	match[1],
		host:	match[2],
		path:	match[3],
		query:	match[4],
		hash:	match[5]
	};
	modify(parts);
	var newScheme = parts.scheme === undefined ? '' : (parts.scheme + '//'),
	    newHost   = parts.host || '',
	    newPath   = parts.path || '',
	    newQuery  = parts.query ? ('?' + parts.query) : '',
	    newHash   = parts.hash   === undefined ? '' : ('#' + parts.hash);
	return newScheme + newHost + newPath + newQuery + newHash;
}

function addUpgradePartsToURI(uri, backupPath) {
	return changeUri(uri, function(uriParts) {
		var newParamifier = 'upgrade:[[' + encodeURI(backupPath) + ']]';
		uriParts.hash = (uriParts.hash ? uriParts.hash + '%20' : '') + newParamifier;

		var newQuery = "time=" + new Date().convertToYYYYMMDDHHMM();
		uriParts.query = (uriParts.query ? uriParts.query + '&' : '') + newQuery;
	});
}

function stripUpgradePartsFromURI(uri) {
	return changeUri(uri, function(uriParts) {
		var queryParts = uriParts.query.split('&'),
		    hashParts = uriParts.hash.split('%20'); // splits paramifiers with a space in argument

		for(var i = 0; i < queryParts.length; i++)
			if(queryParts[i].indexOf('time=') == 0)
				queryParts.splice(i--, 1);

		// relies on the upgrade paramifier being added to the end of hash
		for(i = 0; i < hashParts.length; i++)
			if(hashParts[i].indexOf('upgrade:') == 0)
				hashParts = hashParts.slice(0, i);

		uriParts.query = queryParts.join('&');
		uriParts.hash = hashParts.join('%20') || undefined;
	});
}

function upgradeFrom(path) {
	tw.io.loadFile(path, function(oldTw) {
		var importStore = new TiddlyWiki();
		importStore.importTiddlyWiki(oldTw);
		importStore.forEachTiddler(function(title, tiddler) {
			if(!store.getTiddler(title)) {
				store.addTiddler(tiddler);
			}
		});

		refreshDisplay();
		saveChanges();
		alert(config.messages.upgradeDone.format([formatVersion()]));
		window.location = stripUpgradePartsFromURI(window.location.toString());
	});
}

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place, macroName, params, wikifier, paramString) {
	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper, markList);
	listWrapper.setAttribute("refresh", "macro");
	listWrapper.setAttribute("macroName", "plugins");
	listWrapper.setAttribute("params", paramString);
	this.refresh(listWrapper, paramString);
};

config.macros.plugins.refresh = function(listWrapper, paramString) {
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper, function(e, rowName) {
		if(e.checked) selectedRows.push(e.getAttribute("rowName"));
	});
	jQuery(listWrapper).empty();

	var plugins = installedPlugins.slice(0);
	// not all plugins are installed, gather info about those, too
	var i, tiddler, p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(i = 0; i < configTiddlers.length; i++) {
		tiddler = configTiddlers[i];
		if(plugins.findByField("title", tiddler.title) != null) continue;

		p = getPluginInfo(tiddler);
		p.executed = false;
		p.log.splice(0, 0, this.skippedText);
		plugins.push(p);
	}

	for(i = 0; i < plugins.length; i++) {
		p = plugins[i];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[i].title) != -1;
	}

	if(plugins.length == 0) {
		createTiddlyElement(listWrapper, "em", null, null, this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper, plugins, template, this.onSelectCommand);
		wizard.setValue("listView", listView);
		if(!readOnly) {
			var me = config.macros.plugins;
			wizard.setButtons([
				{ caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag },
				{ caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete }
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		for(var i = 0; i < rowNames.length; i++) {
			store.setTiddlerTag(rowNames[i], false, "systemConfig");
		}
		autoSaveChanges();
	}
};

config.macros.plugins.doDelete = function(e) {
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			for(var i = 0; i < rowNames.length; i++) {
				store.removeTiddler(rowNames[i]);
				story.closeTiddler(rowNames[i], true);
			}
		}
		autoSaveChanges();
	}
};

//--
//-- Message area
//--

function getMessageDiv() {
	var msgArea = document.getElementById("messageArea");
	if(!msgArea) return null;

	if(!msgArea.hasChildNodes()) {
		var toolbar = createTiddlyElement(msgArea, "div", null, "messageArea__toolbar messageToolbar");
		var btn = createTiddlyButton(toolbar, '', config.messages.messageClose.tooltip, clearMessage,
			"button messageToolbar__button");

		btn.innerHTML = tw.assets.icons.closeSvg;
		// inline SVG is unsupported in old FireFox
		if(window.HTMLUnknownElement && btn.firstChild instanceof window.HTMLUnknownElement) {
			btn.innerHTML = config.messages.messageClose.text;
		} else {
			btn.classList.add('messageToolbar__button_withIcon');
		}
	}
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea, "div", null, "messageArea__text");
}

function displayMessage(text, link) {
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(!link) {
		createTiddlyText(e, text);
	} else {
		createTiddlyElement(e, "a", null, null, text, { href: link, target: "_blank" });
	}
}

function clearMessage() {
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		jQuery(msgArea).empty();
		msgArea.style.display = "none";
	}
	return false;
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{ name: "SystemSettings", notify: onSystemSettingsChange },
	{ name: "StyleSheetLayout", notify: refreshStyles },
	{ name: "StyleSheetColors", notify: refreshStyles },
	{ name: "StyleSheet", notify: refreshStyles },
	{ name: "StyleSheetPrint", notify: refreshStyles },
	{ name: "PageTemplate", notify: refreshPageTemplate },
	{ name: "SiteTitle", notify: refreshPageTitle },
	{ name: "SiteSubtitle", notify: refreshPageTitle },
	{ name: "WindowTitle", notify: refreshPageTitle },
	{ name: "ColorPalette", notify: refreshColorPalette },
	{ name: null, notify: refreshDisplay }
];

config.refreshers = {
	link: function(e, changeList) {
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e, title);
		return true;
	},

	tiddler: function(e, changeList) {
		if (startingUp) return true; // #147
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title, template, true);
		else
			refreshElements(e, changeList);
		return true;
	},

	content: function(e, changeList) {
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.macroArgs; // #154
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e, title, args);
			return true;
		} else
			return false;
	},

	macro: function(e, changeList) {
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e, params);
		return true;
	}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root, changeList) {
	var i, nodes = root.childNodes;
	for(i = 0; i < nodes.length; i++) {
		var e = nodes[i], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = refresher ? refresher(e, changeList) : false;
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e, changeList);
	}
}

function applyHtmlMacros(root, tiddler) {
	for(var e = root.firstChild; !!e; e = nextChild) {
		// macros can manipulate DOM, so we remember nextChild before invokeMacro
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p + 1);
					macro = macro.substr(0, p);
				}
				invokeMacro(e, macro, params, null, tiddler);
			}
		}
		if(e.hasChildNodes()) applyHtmlMacros(e, tiddler);
	}
}

function refreshPageTemplate(title) {
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes, i;
	if(display) {
		nodes = display.childNodes;
		for(i = nodes.length - 1; i >= 0; i--)
			stash.appendChild(nodes[i]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if(!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable

	wrapper.innerHTML = store.getRecursiveTiddlerText(title, null, 10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	jQuery(display).empty();
	if(!display)
		display = createTiddlyElement(wrapper, "div", story.containerId());
	nodes = stash.childNodes;
	for(i = nodes.length - 1; i >= 0; i--)
		display.appendChild(nodes[i]);
	jQuery(stash).remove();
}

function refreshDisplay(hint) {
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e, hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e, hint);
	}
}

function refreshPageTitle() {
	document.title = getPageTitle();
}

function getPageTitle() {
	return wikifyPlainText(store.getTiddlerText("WindowTitle", ""), null, tiddler);
}

function refreshStyles(title, doc) {
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title, "", 10), title, doc || document);
}

function refreshColorPalette(title) {
	if(!startingUp)
		refreshAll();
}

function refreshAll() {
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

tw.options = {
	defaults: {},
	define: function(name, defaultValue, description) {
		this.defaults[name] = defaultValue;
		if(config.options[name] === undefined) config.options[name] = defaultValue;
		if(description) config.optionsDesc[name] = description;
	},
	hasDefaultValue: function(name) {
		return config.options[name] == this.defaults[name] ||
		       config.options[name] === undefined;
	}
};

for(var name in config.options) {
	tw.options.define(name, config.options[name], config.optionsDesc[name]);
}

config.optionHandlers = {
	'txt': {
		get: function(name) { return encodeCookie(config.options[name].toString()) },
		set: function(name, value) { config.options[name] = decodeCookie(value) }
	},
	'chk': {
		get: function(name) { return config.options[name] ? 'true' : 'false' },
		set: function(name, value) { config.options[name] = value == 'true' }
	}
};

function setOption(name, value) {
	var optType = name.substr(0, 3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name, value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name) {
	var optType = name.substring(0, 3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ?
		config.optionHandlers[optType].get(name) : null;
}

function loadOptions() {
	if(safeMode) return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies() {
	var cookieList = document.cookie.split(';');
	var i, cookies = {};
	for(i = 0; i < cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = jQuery.trim(cookieList[i].substring(0, p));
			var value = jQuery.trim(cookieList[i].substring(p + 1));
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies() {
	var i, cookies = getCookies();
	if(cookies['TiddlyWikiClassicOptions']) // TW291 and later //#159
		cookies = cookies['TiddlyWikiClassicOptions'].replace(/%22/g, '"').replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWikiOptions']) // TW290 beta //#159
		cookies = cookies['TiddlyWikiOptions'].replace(/%25/g, '%').decodeHashMap(); // #159
	else if(cookies['TiddlyWiki']) // TW281 and earlier
		cookies = cookies['TiddlyWiki'].decodeHashMap();

	for(i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i, cookies[i]);
		}
	}
}

function loadSystemSettings() {
	var key, settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(key in settings) {
		setOption(key, settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange() {
	if(!startingUp) loadSystemSettings();
}

function saveOption(name) {
	if(safeMode) return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}

	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name, true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name) {
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name) {
	var key, cookies = {};
	for(key in config.options) {
		if(tw.options.hasDefaultValue(key)) continue;
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWikiClassicOptions='
		+ String.encodeHashMap(cookies).replace(/%/g, '%25').replace(/"/g, '%22')
		+ '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';

	// clean up cookies saved in an earlier format, before TW291 (#159)
	cookies = getCookies();
	for(var c in cookies) {
		var optType = c.substring(0, 3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

var systemSettingSave;
function commitSystemSettings(storeWasDirty) {
	if(systemSettingSave) {
		window.clearTimeout(systemSettingSave);
	}
	systemSettingSave = window.setTimeout(function() {
		var tiddler = store.getTiddler('SystemSettings');
		autoSaveChanges(null, [tiddler]);
	}, 1000);
}

function saveSystemSetting(name, saveFile) {
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title, name);
	var isUnchanged = slice === getOption(name);
	if(readOnly || isUnchanged) return;

	var slices = store.calcAllSlices(title);
	for(var key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}

	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key, slices[key]]));
	}
	text = text.sort().join('\n');

	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title, title, text, 'System',
			new Date(), ['excludeLists'], config.defaultCustomFields);
	}
	if(saveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s) {
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s) {
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re, function($0) { return String.fromCharCode(eval($0.replace(/[&#;]/g, ''))) });
}

config.macros.option.genericCreate = function(place, type, opt, className, desc) {
	var typeInfo = config.macros.option.types[type];
	var text = desc != 'no' ? (config.optionsDesc[opt] || opt) : null;
	var attributes = { option: opt };
	if(typeInfo.typeValue) attributes.type = typeInfo.typeValue;
	if(config.optionsDesc[opt]) attributes.title = config.optionsDesc[opt];
	var c = createTiddlyElement(place, typeInfo.elementType, null, className || typeInfo.className, text, attributes);
	c[typeInfo.eventName] = typeInfo.onChange;
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e) {
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substring(0, 3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt, handler.valueField,
				this[handler.valueField], handler.elementType, this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt, valueField, value, elementType, sourceEditor) {
	config.options[opt] = value;
	saveOption(opt);

	jQuery(elementType + '[option=' + opt + ']').each(function(i, editor) {
		if(editor != sourceEditor) editor[valueField] = value;
	});
};

config.macros.option.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params, 'name', null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params, 'class', null);
	var desc = getParam(params, 'desc', 'no');
	var type = opt.substring(0, 3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place, type, opt, className, desc);
};

config.macros.options.handler = function(place, macroName, params, wikifier, paramString) {
	params = paramString.parseParams('anon', null, true, false, false);
	var showUnknown = getParam(params, 'showUnknown', 'no');

	var wizard = new Wizard();
	wizard.createWizard(place, this.wizardTitle);
	wizard.addStep(this.step1Title, this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper, markList);
	wizard.setValue('listWrapper', listWrapper);
	this.refreshOptions(listWrapper, showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper, showUnknown) {
	var n, opts = [];
	for(n in config.options) {
		var isUnknown = !config.optionsDesc[n];
		if(!isUnknown || showUnknown) opts.push({
			option: '',
			name: n,
			lowlight: isUnknown,
			description: config.optionsDesc[n] || this.unknownDescription
		});
	}
	opts.sort(function(a, b) {
		var nameA = a.name.substring(3);
		var nameB = b.name.substring(3);
		return nameA < nameB ? -1 : (nameA == nameB ? 0 : +1);
	});

	ListView.create(listWrapper, opts, this.listViewTemplate);
	for(var i = 0; i < opts.length; i++) {
		var type = opts[i].name.substring(0, 3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[i].colElements['option'], type, opts[i].name, null, 'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e) {
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper, this.checked);
	return false;
};

//--
//-- Saving
//--

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var startSaveAreaRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var endSaveArea = '</d' + 'iv>';
var endSaveAreaCaps = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit() {
	hadConfirmExit = true;
	var hasDirtyStore = store && store.isDirty && store.isDirty();
	var hasDirtyStory = story && story.areAnyDirty && story.areAnyDirty();
	if(hasDirtyStore || hasDirtyStory) return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges() {
	if(!(store && store.isDirty && store.isDirty()) || window.hadConfirmExit !== false) return;
	if(confirm(config.messages.unsavedChangesWarning)) saveChanges();
}

function updateLanguageAttribute(s) {
	if(!config.locale) return s;
	var m = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/.exec(s);
	if(!m) return s;

	var htmlTag = m[1];
	if(m[2]) htmlTag += ' xml:lang="' + config.locale + '"';
	if(m[3]) htmlTag += ' lang="' + config.locale + '"';
	htmlTag += ">";

	return s.substr(0, m.index) + htmlTag + s.substr(m.index + m[0].length);
}

function updateMarkupBlock(s, blockName, tiddlerName) {
	return tw.textUtils.replaceChunk(s,
		"<!--%0-START-->".format([blockName]),
		"<!--%0-END-->".format([blockName]),
		"\n" + store.getRecursiveTiddlerText(tiddlerName, "") + "\n");
}

function updateOriginal(original, posDiv, localPath) {
	if(!posDiv) posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0, posDiv[0] + startSaveArea.length) + "\n" +
		store.allTiddlersAsHtml() + "\n" +
		original.substr(posDiv[1]);
	var newSiteTitle = getPageTitle().htmlEncode();
	revised = tw.textUtils.replaceChunk(revised, "<title" + ">", "</title" + ">", " " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised, "PRE-HEAD", "MarkupPreHead");
	revised = updateMarkupBlock(revised, "POST-HEAD", "MarkupPostHead");
	revised = updateMarkupBlock(revised, "PRE-BODY", "MarkupPreBody");
	revised = updateMarkupBlock(revised, "POST-SCRIPT", "MarkupPostBody");
	return revised;
}

function locateStoreArea(original) {
	// Locate the storeArea divs
	if(!original) return null;
	var posOpeningDiv = original.search(startSaveAreaRE);
	var limitClosingDiv = original.indexOf("<" + "!--POST-STOREAREA--" + ">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<" + "!--POST-BODY-START--" + ">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(endSaveArea, start);
	if(posClosingDiv == -1)
		posClosingDiv = original.lastIndexOf(endSaveAreaCaps, start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv, posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty, tiddlers) {
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty, tiddlers);
}

// get the full HTML of the original file
function loadOriginal(localPath, callback) {
	if(!callback) return loadFile(localPath) || window.originalHTML || recreateOriginal();

	tw.io.loadFile(localPath, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			var original = window.originalHTML || recreateOriginal();
			callback(original);
		}
	});
}

// reconstruct original HTML file content from current document memory
function recreateOriginal() {
	// construct doctype
	var content = "<!DOCTYPE ";
	var t = document.doctype;
	if (!t)
		content += "html";
	else {
		content += t.name;
		if(t.publicId)
			content += ' PUBLIC "' + t.publicId + '"';
		else if(t.systemId)
			content += ' SYSTEM "' + t.systemId + '"';
	}
	content += ' "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"';
	content += '>\n';

	// append current document content
	content += document.documentElement.outerHTML;

	// clear 'savetest' marker
	content = content.replace(/<div id="saveTest">savetest<\/div>/, '<div id="saveTest"></div>');
	content = content.replace(/script><applet [^\>]*><\/applet>/g, 'script>');
	// newline before head tag
	content = content.replace(/><head>/, '>\n<head>');
	// newlines before/after end of body/html tags
	content = content.replace(/\n\n<\/body><\/html>$/, '</' + 'body>\n</' + 'html>\n'); // #170
	// meta tag terminators
	content = content.replace(/(<(meta) [^\>]*[^\/])>/g, '$1 />');
	// decode LT/GT entities in noscript
	content = content.replace(/<noscript>[^\<]*<\/noscript>/,
		function(m) { return m.replace(/&lt;/g, '<').replace(/&gt;/g, '>') });
	// encode copyright symbols (UTF-8 to HTML entity)
	content = content.replace(/<div id="copyright">[^\<]*<\/div>/,
		function(m) { return m.replace(/\xA9/g, '&copy;') });

	return content;
}

// reconstruct the local path to TW itself
tw.io.getOriginalLocalPath = function() {
	return getLocalPath(document.location.toString());
};

// Save tiddlywiki (but not backup or anything else)
tw.io.knownSaveMainFailures = {
	failedToLoadOriginal: 1,
	invalidFile: 2
};

// Save this tiddlywiki with the pending changes
tw.io.saveMainAndReport = function(callback) {
	var localPath = tw.io.getOriginalLocalPath();
	var onLoadOriginal = function(original) {
		var msg = config.messages;
		if(original == null) {
			alert(msg.cantSaveError);
			if(store.tiddlerExists(msg.saveInstructions))
				story.displayTiddler(null, msg.saveInstructions);

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.failedToLoadOriginal
			});
		}

		var posDiv = locateStoreArea(original);
		if(!posDiv) {
			alert(msg.invalidFileError.format([localPath]));

			return callback(false, {
				reason: tw.io.knownSaveMainFailures.invalidFile
			});
		}

		config.saveByDownload = false;
		config.saveByManualDownload = false;
		// chkPreventAsyncSaving is checked inside saveMain
		saveMain(localPath, original, posDiv, callback);
	};

	if(!config.options.chkPreventAsyncSaving) {
		loadOriginal(localPath, onLoadOriginal);
	} else {
		// useful when loadOriginal is overwritten without support of callback
		// or when an extension relies saveChanges being a sync function
		var original = loadOriginal(localPath);
		onLoadOriginal(original);
	}
};

function saveChanges(onlyIfDirty, tiddlers) {
	if(onlyIfDirty && !store.isDirty()) return;

	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	if(!window.allowSave()) {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null, msg.saveInstructions);
		return;
	}

	tw.io.saveMainAndReport(function postSave(savedOrPending, details) {
		var co = config.options;
		if (!config.saveByDownload && !config.saveByManualDownload && details && details.original) {
			var localPath = tw.io.getOriginalLocalPath();
			if(co.chkSaveBackups) saveBackup(localPath, details.original);
			if(co.chkSaveEmptyTemplate) saveEmpty(localPath, details.original);
			if(co.chkGenerateAnRssFeed) saveRss(localPath);
		}

		if(co.chkDisplayInstrumentation)
			displayMessage("saveChanges " + (new Date() - t0) + " ms");
	});
}

function saveMain(localPath, original, posDiv, callback) {
	var reportStatusAndHandle = function(successOrPending, localPath, revised) {
		if(successOrPending) {
			tw.io.onSaveMainSuccess(config.saveByDownload ?
				getDataURI(revised) : "file://" + localPath, revised, original);
		} else {
			tw.io.onSaveMainFail();
		}
	};
	try {
		var revised = updateOriginal(original, posDiv, localPath);

		if(!callback || config.options.chkPreventAsyncSaving) {
			var savedOrPending = tw.io.saveFile(localPath, revised);
			reportStatusAndHandle(savedOrPending, localPath, revised);
			if(callback) callback(savedOrPending, {
				original: original
			});
		} else tw.io.saveFile(localPath, revised, function(success, details) {
			reportStatusAndHandle(success, localPath, revised);
			details.original = original;
			callback(success, details);
		});
	} catch (ex) {
		tw.io.onSaveMainFail(ex);
		if(callback) callback(false, { original: original });
	}
}

tw.io.onSaveMainSuccess = function(urlSaved, savedHtml, original) {
	if (!config.saveByManualDownload) {
		displayMessage(
			// set by HTML5DownloadSaveFile()
			config.saveByDownload ?
				config.messages.mainDownload :
				config.messages.mainSaved,
			urlSaved);
	}

	store.setDirty(false);
};

tw.io.onSaveMainFail = function(catchedExeption) {
	alert(config.messages.mainFailed);
	if(catchedExeption) showException(catchedExeption);
};

function saveBackup(localPath, original) {
	var backupPath = getBackupPath(localPath);
	var backupSuccess = copyFile(backupPath, localPath) || saveFile(backupPath, original);
	if(backupSuccess)
		displayMessage(config.messages.backupSaved, "file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath, original, posDiv) {
	posDiv = posDiv || locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.emptyFailed);
		return;
	}

	var emptyPath, slashPosition;
	if((slashPosition = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "/";
	else if((slashPosition = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0, slashPosition) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";

	var empty = original.substr(0, posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath, empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved, "file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

// Translate URL to local path [Preemption]
window.getLocalPath = window.getLocalPath || function(origPath) {
	var originalPath = convertUriToUTF8(origPath, config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0, argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0, hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/", "g"), "\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/", "g"), "\\");
	return localPath;
};

function getBackupPath(localPath, filenameSuffix, extension) {
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder || ".";
	var backupPath = localPath.substring(0, dirPathPos) + slash + backupFolder + localPath.substring(dirPathPos);
	backupPath = backupPath.substring(0, backupPath.lastIndexOf(".")) + ".";
	if(filenameSuffix) {
		var illegalFilenameCharacterOrSpaceRE = /[\\\/\*\?\":<> ]/g;
		backupPath += filenameSuffix.replace(illegalFilenameCharacterOrSpaceRE, "_") + ".";
	}
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}

//--
//-- RSS Saving
//--

function saveRss(localPath, callback) {
	var rssPath = localPath.substr(0, localPath.lastIndexOf(".")) + ".xml";

	tw.io.saveFile(rssPath, generateRss(), callback || function(result, details) {
		if(result)
			displayMessage(config.messages.rssSaved, "file://" + rssPath);
		else
			alert(config.messages.rssFailed);
	});
}

function tiddlerToRssItem(tiddler, uri) {
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text, null, tiddler).htmlEncode() + "</description>\n";
	for(var i = 0; i < tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s += "<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
}

function generateRss() {
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlainText(store.getTiddlerText("SiteTitle", ""),
		null, tiddler).htmlEncode() + "</title" + ">");
	if(u) s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlainText(store.getTiddlerText("SiteSubtitle", ""),
		null, tiddler).htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified", "excludeLists");
	var i, n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length - config.numRssItems;
	for(i = tiddlers.length - 1; i >= n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i], u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

//--
//-- Filesystem code
//--

// Copy a file in filesystem [Preemption]
window.copyFile = window.copyFile || function(dest, source) {
	return config.browser.isIE ? ieCopyFile(dest, source) : false;
};

// Save a file in filesystem [Preemption]
window.saveFile = window.saveFile || function(fileUrl, content) {
	var r = mozillaSaveFile(fileUrl, content);
	if(!r)
		r = ieSaveFile(fileUrl, content);
	if(!r)
		r = javaSaveFile(fileUrl, content);
	if(!r)
		r = HTML5DownloadSaveFile(fileUrl, content);
	if(!r)
		r = manualSaveFile(fileUrl, content);
	return r;
};

// A placeholder method that can be overwritten/decorated by savers.
// In such a case, it's required to call callback on both success and fail.
// See details about the callback in tw.io.saveFile.
tw.io.asyncSaveFile = tw.io.asyncSaveFile || function(fileUrl, content, callback) {
	callback(false, { reason: 'Async saving is not implemented' });
};

// The general save method to use
// ==============================
// If callback is set, tries to save in an async fashion and do callback(success: boolean, details: object)
// ⚠️ Some savers within window.saveFile, like download saving or Timimi don't care about the callback,
// so it can be called before actual saving is done (or even give false positives).
tw.io.saveFile = function(fileUrl, content, callback) {
	if(!callback) return saveFile(fileUrl, content);

	tw.io.asyncSaveFile(fileUrl, content, function(success, details) {
		if(success) callback(success, details);
		else {
			result = saveFile(fileUrl, content);
			callback(result, {});
		}
	});
};

// Load a file from filesystem [Preemption]
window.loadFile = window.loadFile || function(fileUrl) {
	var r = mozillaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = ieLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = javaLoadFile(fileUrl);
	if((r === null) || (r === false))
		r = tw.io.xhrLoadFile(fileUrl);
	return r;
};

tw.io.xhrLoadFile = function(filePath, callback) {
	try {
		var isAsync = !!callback;
		var url = 'file://' + (filePath[0] != '/' ? '/' : '') + encodeURIComponent(filePath);
		if(isAsync) {
			httpReq('GET', url, function(status, params, responseText, url, xhr) {
				callback(responseText, { xhr: xhr });
			});
		} else {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, isAsync);
			xhr.send(null);
			return xhr.responseText;
		}
	} catch(ex) {
		return callback ? callback(null) : null;
	}
};

// The general load method to use
// ==============================
// If callback is set, tries to load in an async fashion and do callback(result, details)
tw.io.loadFile = function(fileUrl, callback) {
	if(!callback) return loadFile(fileUrl);

	tw.io.xhrLoadFile(fileUrl, function(result, details) {
		if(typeof result == 'string') {
			callback(result, details);
		} else {
			result = loadFile(fileUrl);
			callback(result);
		}
	});
};


function ieCreatePath(path) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	// Remove the filename, if present. Use trailing slash (i.e. "foo\bar\") if no filename.
	var pos = path.lastIndexOf("\\");
	if(pos == -1) pos = path.lastIndexOf("/");
	if(pos != -1) path = path.substring(0, pos + 1);

	// Walk up the path until we find a folder that exists
	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	// Walk back down the path, creating folders
	for(var i = scan.length - 1; i >= 0; i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content) {
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath, 2, -1, 0);
	file.Write(convertUnicodeToHtmlEntities(content));
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath) {
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath, 1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest, source) {
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content) {
	if(!window.Components) return null;

	content = mozConvertUnicodeToUTF8(content);
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"]
			.createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			file.create(0, 0x01B4);// 0x01B4 = 0664
		var out = Components.classes["@mozilla.org/network/file-output-stream;1"]
			.createInstance(Components.interfaces.nsIFileOutputStream);
		out.init(file, 0x22, 0x04, null);
		out.write(content, content.length);
		out.flush();
		out.close();
		return true;
	} catch(ex) {
		return false;
	}
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath) {
	if(!window.Components) return null;

	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
		file.initWithPath(filePath);
		if(!file.exists())
			return null;
		var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"]
			.createInstance(Components.interfaces.nsIFileInputStream);
		inputStream.init(file, 0x01, 0x04, null);
		var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"]
			.createInstance(Components.interfaces.nsIScriptableInputStream);
		sInputStream.init(inputStream);
		var contents = sInputStream.read(sInputStream.available());
		sInputStream.close();
		inputStream.close();
		return mozConvertUTF8ToUnicode(contents);
	} catch(ex) {
		return false;
	}
}

function HTML5DownloadSaveFile(filePath, content) {
	var link = document.createElement("a");
	if(link.download === undefined)
		return null;

	config.saveByDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	link.setAttribute("target", "_blank");
	link.setAttribute("href", uri);
	link.setAttribute("download", filename);
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function manualSaveFile(filePath, content) {
	// FALLBACK for showing a link to data: URI
	config.saveByManualDownload = true;
	var slashpos = filePath.lastIndexOf("/");
	if (slashpos == -1) slashpos = filePath.lastIndexOf("\\");
	var filename = filePath.substr(slashpos + 1);
	var uri = getDataURI(content);
	displayMessage(config.messages.mainDownloadManual, uri);
	return true;
}

// construct data URI (using base64 encoding to preserve multi-byte encodings)
function getDataURI(data) {
	return config.browser.isIE ?
		"data:text/html," + encodeURIComponent(data) :

		// manualConvertUnicodeToUTF8 was moved here from convertUnicodeToFileFormat
		// In 2.9.1, it was used only for FireFox but happened to fix
		// download saving non-ASCII in Chrome & Safari as well (see 949aff6)
		"data:text/html;base64," + encodeBase64(manualConvertUnicodeToUTF8(data));
}

function encodeBase64(data) {
	if (!data) return "";
	var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
	var out = "";
	var chr1, chr2, chr3 = "";
	var enc1, enc2, enc3, enc4 = "";
	for (var i = 0; i < data.length; ) {
		chr1 = data.charCodeAt(i++);
		chr2 = data.charCodeAt(i++);
		chr3 = data.charCodeAt(i++);
		enc1 = chr1 >> 2;
		enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
		enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
		enc4 = chr3 & 63;
		if (isNaN(chr2)) enc3 = enc4 = 64;
		else if (isNaN(chr3)) enc4 = 64;
		out += keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
		chr1 = chr2 = chr3 = enc1 = enc2 = enc3 = enc4 = "";
	}
	return out;
}

//--
//-- Filesystem utilities
//--

function convertUTF8ToUnicode(u) {
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}


function manualConvertUTF8ToUnicode(utf) {
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0, dst++).concat(c, utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s + fin : s;
}

function manualConvertUnicodeToUTF8(s) {
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s) {
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"]
			.createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUnicodeToHtmlEntities(s) {
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re, function($0) { return "&#" + $0.charCodeAt(0).toString() + ";" });
}

function convertUriToUTF8(uri, charSet) {
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"]
			.getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri, charSet);
}

// deprecated helper for backward-compatibility with elder extensions
// (browser/saving method-specific convertion is only needed in browser-specific savers)
function convertUnicodeToFileFormat(s) {
	return s;
}

// deprecated helper for backward-compatibility with elder extensions
function convertUnicodeToUTF8(s) {
	return s;
}

//--
//-- Server adaptor base class
//--

function AdaptorBase() {
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function() {
	return true;
};

AdaptorBase.prototype.fullHostName = function(host) {
	if(!host) return '';
	host = jQuery.trim(host);
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length - 1) == '/')
		host = host.substr(0, host.length - 1);
	return host;
};

AdaptorBase.minHostName = function(host) {
	return host;
};

AdaptorBase.prototype.setContext = function(context, userParams, callback) {
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
//   host - uri of host (eg, "http://www.tiddlywiki.com/" or "www.tiddlywiki.com")
//   context is itself passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - optional function to be called on completion
// Return value is true if the request was successfully issued, false if this connector doesn't support openHost(),
//   or an error description string if there was a problem
// The callback parameters are callback(context)
//   context.status - true if OK, string if error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openHost function
AdaptorBase.prototype.openHost = function(host, context, userParams, callback) {
	this.host = host;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	return true;
};

// Open the specified workspace
//   workspace - name of workspace to open
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the openWorkspace function
AdaptorBase.prototype.openWorkspace = function(workspace, context, userParams, callback) {
	this.workspace = workspace;
	context = this.setContext(context, userParams, callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor() {}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiSuccess = function(context, jqXHR) {
	context.status = true;
	context.adaptor.store = new TiddlyWiki();
	if(!context.adaptor.store.importTiddlyWiki(jqXHR.responseText)) {
		context.statusText = config.messages.invalidFileError.format([context.host]);
		context.status = false;
	}
	context.complete(context, context.userParams);
};

FileAdaptor.loadTiddlyWikiError = function(context, jqXHR) {
	context.status = false;
	context.statusText = jqXHR.message;
	context.complete(context, context.userParams);
};

// Get the list of workspaces on a given server
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   false if this connector doesn't support getWorkspaceList(),
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   userParams - parameters as originally passed into the getWorkspaceList function
FileAdaptor.prototype.getWorkspaceList = function(context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.workspaces = [{ title: "(default)" }];
	context.status = true;
	if(callback)
		window.setTimeout(function() { callback(context, userParams) }, 10);
	return true;
};

// Gets the list of tiddlers within a given workspace
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
//   filter - filter expression
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddlers - array of tiddler objects
//   userParams - parameters as originally passed into the getTiddlerList function
FileAdaptor.prototype.getTiddlerList = function(context, userParams, callback, filter) {
	context = this.setContext(context, userParams, callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		file: context.file, // for HTML5 FileReader
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			context.xhr = jqXHR;
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerListComplete = function(context, userParams) {
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title, tiddler) { context.tiddlers.push(tiddler) });
		}
		for(var i = 0; i < context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler) {
	return {
		uri: tiddler.fields['server.host'] + "#" + tiddler.title
	};
};

// Retrieve a tiddler from a given workspace on a given server
//   title - title of the tiddler to get
//   context - passed on as a parameter to the callback function
//   userParams - user settable object object that is passed on unchanged to the callback function
//   callback - function to be called on completion
// Return value is true if the request was successfully issued,
//   or an error description string if there was a problem
// The callback parameters are callback(context, userParams)
//   context.status - true if OK, false if error
//   context.statusText - error message if there was an error
//   context.adaptor - reference to this adaptor object
//   context.tiddler - the retrieved tiddler, or null if it cannot be found
//   userParams - parameters as originally passed into the getTiddler function
FileAdaptor.prototype.getTiddler = function(title, context, userParams, callback) {
	context = this.setContext(context, userParams, callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	if(context.adaptor.store) {
		return context.complete(context, context.userParams);
	}
	var options = {
		type: "GET",
		url: context.host,
		processData: false,
		success: function(data, textStatus, jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context, jqXHR);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			FileAdaptor.loadTiddlyWikiError(context, jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerComplete = function(context, userParams) {
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context, userParams);
	} else {
		window.setTimeout(function() { context.callback(context, userParams) }, 10);
	}
	return true;
};

FileAdaptor.prototype.close = function() {
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;

//--
//-- HTTP request code
//--

// Perform an http request using the jQuery ajax function
// fallback to privileged file I/O or HTML5 FileReader
function ajaxReq(args) {
	if (args.file || args.url.startsWith("file"))  // LOCAL FILE
		return localAjax(args);
	return jQuery.ajax(args);
}

// perform local I/O and FAKE a minimal XHR response object
function localAjax(args) {
	var success = function(data) {
		args.success(data, "success", { responseText: data });
	};
	var failure = function(who) {
		args.error({ message: who + ": cannot read local file" }, "error", 0);
	};

	if (args.file) try { // HTML5 FileReader (Chrome, FF20+, Safari, etc.)
		var reader = new FileReader();
		reader.onload = function(e)  { success(e.target.result) };
		reader.onerror = function(e) { failure("FileReader") };
		reader.readAsText(args.file);
		return true;
	} catch (ex) { ; }

	// local file I/O (IE, FF with security.fileuri.strict_origin_policy:false, etc.)
	try {
		var data = loadFile(getLocalPath(args.url));
		if (data) success(data);
		else failure("loadFile");
		return true;
	} catch (ex) { ; }

	return true;
}

// Perform an http request
//   type - GET/POST/PUT/DELETE
//   url - the source url
//   data - optional data for POST and PUT
//   contentType - optionalContent type for the data (defaults to application/x-www-form-urlencoded)
//   username - optional username for basic authentication
//   password - optional password for basic authentication
//   callback - function to call when there is a response
//   params - parameter object that gets passed to the callback for storing it's state
//   headers - optional hashmap of additional headers
//   allowCache - unless true, adds a "nocache=" parameter to the URL
// Return value is the underlying XMLHttpRequest object, or a string if there was an error
// Callback function is called like this:
//   callback(status, params, responseText, url, xhr)
//     status - true if OK, false if error
//     params - the parameter object provided to loadRemoteFile()
//     responseText - the text of the file
//     url - requested URL
//     xhr - the underlying XMLHttpRequest object
function httpReq(type, url, callback, params, headers, data, contentType, username, password, allowCache) {
	var httpSuccess = function(xhr) {
		try {
			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
			return (!xhr.status && location.protocol === "file:") ||
				(xhr.status >= 200 && xhr.status < 300) ||
				xhr.status === 304 || xhr.status === 1223;
		} catch(e) {}
		return false;
	};

	var options = {
		type: type,
		url: url,
		processData: false,
		data: data,
		cache: !!allowCache,
		beforeSend: function(xhr) {
			for(var i in headers)
				xhr.setRequestHeader(i, headers[i]);
		}
	};

	if(callback) {
		options.complete = function(xhr, textStatus) {
			if(httpSuccess(xhr))
				callback(true, params, xhr.responseText, url, xhr);
			else
				callback(false, params, null, url, xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	try {
		if(window.Components && window.netscape && window.netscape.security
		   && document.location.protocol.indexOf("http") == -1)
			window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	} catch (ex) {
	}
	return jQuery.ajax(options);
}
//--
//-- TiddlyWiki-specific utility functions
//--

// Return TiddlyWiki version string
function formatVersion(v) {
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "") +
		(v.nightly ? " (nightly " + v.nightly + ")" : "");
}

function compareVersions(v1, v2) {
	var x1, x2, i, a = ["major", "minor", "revision"];
	for(i = 0; i < a.length; i++) {
		x1 = v1[a[i]] || 0;
		x2 = v2[a[i]] || 0;
		if(x1 < x2) return +1;
		if(x1 > x2) return -1;
	}
	x1 = v1.beta || Infinity;
	x2 = v2.beta || Infinity;
	return x1 < x2 ? +1 :
	       x1 > x2 ? -1 : 0;
}

function merge(dst, src, preserveExisting) {
	for(var key in src)
		if(!preserveExisting || dst[key] === undefined)
			dst[key] = src[key];

	return dst;
}

// Get the target of an event
function resolveTarget(event) {
	var obj = event.target || event.srcElement;
	// defeat Safari bug
	if(obj.nodeType == 3)
		obj = obj.parentNode;
	return obj;
}

// Return the description of an exception (string)
function exceptionText(ex, prependedMessage) {
	var s = ex.description || ex.toString();
	return prependedMessage ? (prependedMessage + ":\n" + s) : s;
}

// Display an alert of an exception description with optional message
function showException(e, prependedMessage) {
	alert(exceptionText(e, prependedMessage));
}

function alertAndThrow(m) {
	alert(m);
	throw(m);
}

function glyph(name) {
	var g = config.glyphs;
	if(!g.codes[name]) return "";
	if(g.currBrowser == null) {
		var i = 0;
		while(i < g.browsers.length - 1 && !g.browsers[i]())
			i++;
		g.currBrowser = i;
	}
	return g.codes[name][g.currBrowser];
}

function createTiddlyText(parent, text) {
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent, caption, checked, onChange) {
	var cb = document.createElement("input");
	cb.setAttribute("type", "checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption, parent);
	return cb;
}

function createTiddlyElement(parent, element, id, className, text, attribs) {
	var n, e = document.createElement(element);
	if(className != null) e.className = className;
	if(       id != null) e.setAttribute('id', id);
	if(     text != null) createTiddlyText(e, text);
	if(attribs) {
		for(n in attribs) e.setAttribute(n, attribs[n]);
	}
	if(parent != null) parent.appendChild(e);
	return e;
}

function createTiddlyButton(parent, text, tooltip, action, className, id, accessKey, customAttributes) {
	var attributes = { href: 'javascript:;' };
	if(tooltip)   attributes.title = tooltip;
	if(accessKey) attributes.accessKey = accessKey;
	merge(attributes, customAttributes || {});

	var btn = createTiddlyElement(parent, 'a', id || null, className || 'button', text, attributes);
	if(action) btn.onclick = action;
	return btn;
}

function createExternalLink(place, url, label) {
	var tooltip = config.messages.externalLinkTooltip;
	var link = createTiddlyElement(place, 'a', null, 'externalLink', label, {
		href: url,
		title: tooltip ? tooltip.format([url]) : url
	});
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	return link;
}

function getTiddlyLinkInfo(title, currClasses) {
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
	    var f;
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			f = config.messages.shadowedTiddlerToolTip;
			classes.pushUnique("shadow");
		} else {
			f = config.messages.undefinedTiddlerToolTip;
			classes.remove("shadow");
		}
		subTitle = f ? f.format([title]) : "";
	}
	if(typeof config.annotations[title] == "string")
		subTitle = config.annotations[title];
	return { classes: classes.join(" "), subTitle: subTitle };
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev) {
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f, config.defaultCustomFields, true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target, title, null, true, null, fields, toggling);
	}
	clearMessage();
	return false;
}

function getTiddlerLinkHref(title) {
	return window.location.toString().replace(/#.*$/, '') + story.getPermaViewHash([title]);
}

function createTiddlyLink(place, title, includeText, className, isStatic, linkedFromTiddler, noToggle) {
	var title = jQuery.trim(title);
	var text = includeText ? title : null;
	var info = getTiddlyLinkInfo(title, className);
	var btn = isStatic ?
		createExternalLink(place, store.getTiddlerText("SiteUrl", null) + story.getPermaViewHash([title])) :
		createTiddlyButton(place, text, info.subTitle, onClickTiddlerLink, info.classes, '', '', {
			href: getTiddlerLinkHref(title)
		});
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh", "link");
	btn.setAttribute("tiddlyLink", title);
	if(noToggle)
		btn.setAttribute("noToggle", "true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields", fields);
	}
	return btn;
}

function refreshTiddlyLink(e, title) {
	var info = getTiddlyLinkInfo(title, e.className);
	e.className = info.classes;
	e.title = info.subTitle;
}

function createTiddlyDropDown(place, onchange, options, defaultValue) {
	var sel = createTiddlyElement(place, "select");
	sel.onchange = onchange;

	for(var i = 0; i < options.length; i++) {
		var e = createTiddlyElement(sel, "option", null, null, options[i].caption);
		e.value = options[i].name;
		if(e.value == defaultValue)
			e.selected = true;
	}
	return sel;
}

//--
//-- TiddlyWiki-specific popup utility functions
//--

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev) {
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby && sortby.length) {
		store.sortTiddlers(tiddlers, sortby);
	}
	story.displayTiddlers(this, tiddlers);
	return false;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[") == -1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby && sortby.length) {
			store.sortTiddlers(tagged, sortby);
		}
		var titles = [];
		for(var i = 0; i < tagged.length; i++) {
			if(tagged[i].title != title)
				titles.push(tagged[i].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup, "li"),
				lingo.openAllText.format([tag]), lingo.openAllTooltip, onClickTagOpenAll);
			openAll.setAttribute("tag", tag);
			openAll.setAttribute("sortby", sortby);
			createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
			for(i = 0; i < titles.length; i++) {
				createTiddlyLink(createTiddlyElement(popup, "li"), titles[i], true);
			}
		} else {
			createTiddlyElement(popup, "li", null, "disabled", lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
		var link = createTiddlyLink(createTiddlyElement(popup, "li"), tag, false);
		createTiddlyText(link, lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place, tag, excludeTiddler, title, tooltip) {
	var btn = createTiddlyButton(place, title || tag,
		(tooltip || config.views.wikified.tag.tooltip).format([tag]), onClickTag);
	btn.setAttribute("tag", tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler", excludeTiddler);
	return btn;
}

function onClickTiddlyPopup(ev) {
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this, "div", "popupTiddler");
		wikify(tiddler.text, popup, null, tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyPopup(place, caption, tooltip, tiddler) {
	if(tiddler.text) {
		createTiddlyLink(place, caption, true);
		var btn = createTiddlyButton(place, glyph("downArrow"), tooltip, onClickTiddlyPopup, "tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place, caption);
	}
}

function onClickError(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var i = 0; i < lines.length; i++) {
		createTiddlyElement(popup, "li", null, "popupMessage", lines[i]);
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place, title, text) {
	var btn = createTiddlyButton(place, title, null, onClickError, "errorButton");
	if(text) btn.setAttribute("errorText", text);
}
//-
//- Animation engine
//-

function Animator() {
	// Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.running = 0;
	// ID of the timer used for animating
	this.timerID = 0;
	// List of animations in progress
	this.animations = [];
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() { //# Variable number of arguments
	for(var i = 0; i < arguments.length; i++)
		this.animations.push(arguments[i]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() { me.doAnimate(me) }, 10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me) {
	var i = 0;
	while(i < me.animations.length) {
		if(me.animations[i].tick()) {
			i++;
		} else {
			me.animations.splice(i, 1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress) {
	return 1 - ((Math.cos(progress * Math.PI) + 1) / 2);
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element, duration, properties, callback) {
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element, style, value) {
	switch(style) {
		case "-tw-vertScroll":
			window.scrollTo(findScrollX(), value);
			break;
		case "-tw-horizScroll":
			window.scrollTo(value, findScrollY());
			break;
		default:
			element.style[style] = value;
			break;
	}
};

Morpher.prototype.stop = function() {
	for(var i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element, p.style, p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element, this.properties);
};

Morpher.prototype.tick = function() {
	var currTime = Number(new Date());
	var i, progress = Animator.slowInSlowOut(Math.min(1, (currTime - this.startTime) / this.duration));
	for(i = 0; i < this.properties.length; i++) {
		var p = this.properties[i];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
				case undefined:
				case "style":
					var value = p.start + (p.end - p.start) * progress;
					this.assignStyle(this.element, p.style, template.format([value]));
					break;
				case "color":
					break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text, startElement, targetElement, unused) {
	var e = createTiddlyElement(document.body, "div", null, "zoomer");
	createTiddlyElement(e, "div", null, null, text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{ style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px' },
		{ style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px' },
		{ style: 'width', start: Math.min(startElement.scrollWidth, winWidth),
		  end: Math.min(targetElement.scrollWidth, winWidth), template: '%0px', atEnd: 'auto' },
		{ style: 'height', start: Math.min(startElement.scrollHeight, winHeight),
		  end: Math.min(targetElement.scrollHeight, winHeight), template: '%0px', atEnd: 'auto' },
		{ style: 'fontSize', start: 8, end: 24, template: '%0pt' }
	];
	var c = function(element) { jQuery(element).remove() };
	return new Morpher(e, config.animDuration, p, c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement) {
	return new Morpher(targetElement, config.animDuration, [{
		style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)
	}]);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element, opening, unused, deleteMode) {
	element.style.overflow = 'hidden';
	// Workaround a Firefox flashing bug
	if(opening) element.style.height = '0px';
	element.style.display = 'block';
	var height = element.scrollHeight;
	var props = [];
	var callback = null;
	if(opening) {
		props.push({ style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto' });
		props.push({ style: 'opacity', start: 0, end: 1, template: '%0' });
		props.push({ style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)' });
	} else {
		props.push({ style: 'height', start: height, end: 0, template: '%0px' });
		props.push({ style: 'display', atEnd: 'none' });
		props.push({ style: 'opacity', start: 1, end: 0, template: '%0' });
		props.push({ style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)' });
		switch(deleteMode) {
			case "all":
				callback = function(element, properties) { jQuery(element).remove() };
				break;
			case "children":
				callback = function(element, properties) { jQuery(element).empty() };
				break;
		}
	}
	return new Morpher(element, config.animDuration, props, callback);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
};

Popup.create = function(root, elem, className) {
	var stackPosition = this.find(root, "popup");
	Popup.remove(stackPosition + 1);
	var popup = createTiddlyElement(document.body, elem || "ol", "popup", className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({ root: root, popup: popup });
	return popup;
};

Popup.onDocumentClick = function(ev) {
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign, halign, offset) {
	var curr = Popup.stack[Popup.stack.length - 1];
	this.place(curr.root, curr.popup, valign, halign, offset);
	jQuery(curr.root).addClass("highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0, ensureVisible(curr.popup));
};

Popup.place = function(root, popup, valign, halign, offset) {
	if(!offset)
		offset = { x: 0, y: 0 };
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth * 0.75)
		popup.style.width = winWidth * 0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e) {
	var i, pos = -1;
	for(i = this.stack.length - 1; i >= 0; i--) {
		if(isDescendant(e, this.stack[i].popup))
			pos = i;
	}
	return pos;
};

Popup.remove = function(pos) {
	if(!pos) pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from) {
	for(var i = Popup.stack.length - 1; i >= from; i--) {
		var p = Popup.stack[i];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0, from);
};

//--
//-- Wizard support
//--

function Wizard(place) {
	if(place) {
		this.formElem = findRelated(place, "wizard", "className");
		this.bodyElem = findRelated(this.formElem.firstChild, "wizardBody", "className", "nextSibling");
		this.footElem = findRelated(this.formElem.firstChild, "wizardFooter", "className", "nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name, value) {
	jQuery(this.formElem).data(name, value);
};

Wizard.prototype.getValue = function(name) {
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

Wizard.prototype.createWizard = function(place, title) {
	this.formElem = createTiddlyElement(place, "form", null, "wizard");
	createTiddlyElement(this.formElem, "h1", null, "wizard__title", title);
	this.bodyElem = createTiddlyElement(this.formElem, "div", null, "wizardBody");
	this.footElem = createTiddlyElement(this.formElem, "div", null, "wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function() {
	jQuery(this.bodyElem).empty();
};

Wizard.prototype.setButtons = function(buttonInfo, status) {
	jQuery(this.footElem).empty();
	for(var i = 0; i < buttonInfo.length; i++) {
		createTiddlyButton(this.footElem, buttonInfo[i].caption, buttonInfo[i].tooltip, buttonInfo[i].onClick);
		insertSpacer(this.footElem);
	}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem, "span", null, "status").innerHTML = status;
	}
};

Wizard.prototype.addStep = function(stepTitle, htmlString) {
	jQuery(this.bodyElem).empty();
	var wrapper = createTiddlyElement(this.bodyElem, "div");
	createTiddlyElement(wrapper, "h2", null, "wizard__subtitle", stepTitle);
	var step = createTiddlyElement(wrapper, "div", null, "wizardStep");
	step.innerHTML = htmlString;
	applyHtmlMacros(step, tiddler);
};

Wizard.prototype.getElement = function(name) {
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place, listObject, listTemplate, callback, className) {
	var table = createTiddlyElement(place, "table", null, className || "listView twtable");

	var thead = createTiddlyElement(table, "thead");
	var i, row = createTiddlyElement(thead, "tr");
	for(i = 0; i < listTemplate.columns.length; i++) {
		var columnTemplate = listTemplate.columns[i];
		var cell = createTiddlyElement(row, "th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(cell, columnTemplate, i);
			if(columnTemplate.className)
				jQuery(cell).addClass(columnTemplate.className);
		}
	}

	var rc, tbody = createTiddlyElement(table, "tbody");
	for(rc = 0; rc < listObject.length; rc++) {
		var rowObject = listObject[rc];
		row = createTiddlyElement(tbody, "tr");
		for(i = 0; i < listTemplate.rowClasses.length; i++) {
			if(rowObject[listTemplate.rowClasses[i].field])
				jQuery(row).addClass(listTemplate.rowClasses[i].className);
		}
		rowObject.rowElement = row;
		rowObject.colElements = {};
		for(i = 0; i < listTemplate.columns.length; i++) {
			cell = createTiddlyElement(row, "td");
			columnTemplate = listTemplate.columns[i];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(cell, rowObject, field, columnTemplate, i, rc);
				if(columnTemplate.className)
					jQuery(cell).addClass(columnTemplate.className);
			}
			rowObject.colElements[field] = cell;
		}
	}

	if(callback && listTemplate.actions)
		createTiddlyDropDown(place, ListView.getCommandHandler(callback), listTemplate.actions);

	if(callback && listTemplate.buttons) {
		for(i = 0; i < listTemplate.buttons.length; i++) {
			var b = listTemplate.buttons[i];
			if(b && b.name != "") createTiddlyButton(place, b.caption, null,
				ListView.getCommandHandler(callback, b.name, b.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback, name, allowEmptySelection) {
	return function(e) {
		var view = findRelated(this, "TABLE", null, "previousSibling");
		var tiddlers = ListView.getSelectedRows(view);
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view, this.value, tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view, name, tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view, callback) {
	var checkboxes = view.getElementsByTagName("input");
	var i, hadOne = false;
	for(i = 0; i < checkboxes.length; i++) {
		var cb = checkboxes[i];
		var rowName = cb.getAttribute("rowName");
		if(cb.getAttribute("type") != "checkbox" || !rowName) continue;
		callback(cb, rowName);
		hadOne = true;
	}
	return hadOne;
};

ListView.getSelectedRows = function(view) {
	var rowNames = [];
	ListView.forEachSelector(view, function(e, rowName) {
		if(e.checked) rowNames.push(rowName);
	});
	return rowNames;
};

// describes filling cells of a column of each type, a map of typeName => { createHeader, createItem }
ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyText(place, columnTemplate.title);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v);
	}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			wikify(v, place, null, null);
	}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined && v.title)
			createTiddlyPopup(place, v.title, config.messages.listView.tiddlerTooltip, v);
	}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var i = 0, msg = config.messages.sizeTemplates;
		while(i < msg.length - 1 && v < msg[i].unit)
			i++;
		createTiddlyText(place, msg[i].template.format([Math.round(v / msg[i].unit)]));
	}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		var c = columnTemplate.text;
		if(v != undefined) createExternalLink(place, v, c || v);
	}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v != undefined)
			createTiddlyText(place, v.formatString(columnTemplate.dateFormat));
	}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		for(var i = 0; i < v.length; i++) {
			createTiddlyText(place, v[i]);
			createTiddlyElement(place, "br");
		}
	}
};

ListView.columnTypes.Selector = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyCheckbox(place, null, false, this.onHeaderChange);
	},
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], null);
		e.setAttribute("rowName", listObject[columnTemplate.rowName]);
	},
	onHeaderChange: function(e) {
		var state = this.checked;
		var view = findRelated(this, "TABLE");
		if(!view) return;
		ListView.forEachSelector(view, function(e, rowName) {
			e.checked = state;
		});
	}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var tags = listObject[field];
		createTiddlyText(place, String.encodeTiddlyLinkList(tags));
	}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		if(listObject[field] == true)
			createTiddlyText(place, columnTemplate.trueText);
		if(listObject[field] == false)
			createTiddlyText(place, columnTemplate.falseText);
	}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], this.onChange);
		e.setAttribute("tiddler", listObject.title);
		e.setAttribute("tag", columnTemplate.tag);
	},
	onChange: function(e) {
		var tag = this.getAttribute("tag");
		var tiddler = this.getAttribute("tiddler");
		store.setTiddlerTag(tiddler, this.checked, tag);
	}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if(v == undefined) return;
		var link = createTiddlyLink(place, listObject[columnTemplate.tiddlerLink], false, null);
		createTiddlyText(link, listObject[field]);
	}
};

//--
//-- Augmented methods for the JavaScript Array() object
//--

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field, value) {
	for(var i = 0; i < this.length; i++) {
		if(this[i][field] === value) return i;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item) {
	return this.indexOf(item) != -1;
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items) {
	for(var i = 0; i < items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array.
// If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item, unique) {
	if(unique === false || this.indexOf(item) == -1) {
		this.push(item);
	}
};

Array.prototype.remove = function(item) {
	var p = this.indexOf(item);
	if(p != -1) this.splice(p, 1);
};

//--
//-- Augmented methods for the JavaScript String() object
//--

// todo: create functions substituting String augmenting methods, use in the core; deprecate all String augmenting methods

// Trim whitespace from both ends of a string
String.prototype.trim = function() {
	return this.replace(/^\s*|\s*$/g, "");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s) {
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match, r = [];
	while(match = subRegExp.exec(this)) {
		if(!match[1]) continue;
		if(match.index > currPos)
			r.push(this.substring(currPos, match.index));
		r.push(substrings[parseInt(match[1], 10)]);
		currPos = subRegExp.lastIndex;
	}
	if(currPos < this.length)
		r.push(this.substring(currPos, this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function() {
	return this.replace(/[\-\/\\\^\$\*\+\?\.\(\)\|\[\]\{\}]/g, '\\$&'); // #157
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function() {
	return this.replace(/\\/mg, "\\s").replace(/\n/mg, "\\n").replace(/\r/mg, "");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function() {
	return this.replace(/\\n/mg, "\n").replace(/\\b/mg, " ").replace(/\\s/mg, "\\").replace(/\r/mg, "");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function() {
	return this.replace(/&/mg, "&amp;").replace(/</mg, "&lt;").replace(/>/mg, "&gt;").replace(/\"/mg, "&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function() {
	return this.replace(/&lt;/mg, "<").replace(/&gt;/mg, ">").replace(/&quot;/mg, "\"").replace(/&amp;/mg, "&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName, defaultValue, allowEval, noNames, cascadeDefaults) {
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" +
		dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token, "mg") :
		new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?", "mg");

	var parseToken = function(match, p) {
		// Double quoted
		if(match[p])     return match[p].replace(/\\"/g, '"');
		// Single quoted
		if(match[p + 1]) return match[p + 1].replace(/\\'/g, "'");
		// Double-square-bracket quoted
		if(match[p + 2]) return match[p + 2];
		// Double-brace quoted
		if(match[p + 3]) {
			var value = match[p + 3];
			if(allowEval && config.evaluateMacroParameters != "none") {
				try {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) value = window.restrictedEval(value);
					} else {
						value = window.eval(value);
					}
				} catch(ex) {
					throw "Unable to evaluate {{" + value + "}}: " + exceptionText(ex);
				}
			}
			return value;
		}
		// Unquoted
		if(match[p + 4]) return match[p + 4];
		// Empty quote
		if(match[p + 5]) return "";
	};

	var summary = {};
	var results = [summary], match;
	while(match = re.exec(this)) {
		// matched bit is like  firstToken  or  firstToken:tokenAfterColon  (like "param":{{evaluated expression}})
		var firstToken = parseToken(match, 1);
		if(noNames) {
			results.push({ name: "", value: firstToken });
			continue;
		}

		var tokenAfterColon = parseToken(match, 8);
		var newItem = {
			name: firstToken,
			value: tokenAfterColon
		};
		if(newItem.value == null) {
			if(defaultName) {
				newItem.value = firstToken;
				newItem.name = defaultName;
			}
			else if(defaultValue) newItem.value = defaultValue;
		}

		results.push(newItem);
		if(cascadeDefaults) {
			defaultName = newItem.name;
			defaultValue = newItem.value;
		}
	}

	for(var i = 1; i < results.length; i++) {
		var name = results[i].name;
		var value = results[i].value;
		if(!summary[name])
			summary[name] = [value];
		else
			summary[name].push(value);
	}
	return results;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval) {
	var p = this.parseParams("list", null, !notAllowEval, true);
	return p.slice(1).map(function(param) { return param.value });
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique) {
	var p = this.parseParams("list", null, false, true);
	var i, n = [];
	for(i = 1; i < p.length; i++) {
		if(p[i].value)
			n.pushUnique(p[i].value, unique);
	}
	return n;
};

// Get [startIndex, endIndex] of chunk between given startMarker and endMarker inside text, or undefined.
tw.textUtils.getChunkRange = function(text, startMarker, endMarker) {
	var s = text.indexOf(startMarker);
	if(s == -1) return;
	s += startMarker.length;
	var e = text.indexOf(endMarker, s);
	if(e != -1) return [s, e];
};

// Replace a chunk of a string given start and end markers
tw.textUtils.replaceChunk = function(text, startMarker, endMarker, newValue) {
	var r = this.getChunkRange(text, startMarker, endMarker);
	return r ? text.substring(0, r[0]) + newValue + text.substring(r[1]) : text;
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title) {
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list) {
	if(!list) return "";
	return list.map(function(item) { return String.encodeTiddlyLink(item) }).join(" ");
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function() {
	var fields = this.parseParams("anon", "", false);
	var i, hashmap = {};
	for(i = 1; i < fields.length; i++)
		hashmap[fields[i].name] = fields[i].value;
	return hashmap;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap) {
	var name, r = [];
	for(name in hashmap)
		r.push(name + ':"' + hashmap[name] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n, width) {
	var s = n.toString();
	if(s.length >= width) return s;
	return "000000000000000000000000000".substring(0, width - s.length) + s;
};

String.prototype.startsWith = function(prefix) {
	return !prefix || this.substring(0, prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params, name, defaultValue) {
	if(!params) return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params, name, defaultValue) {
	return !!getParam(params, name, defaultValue);
}

//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template) {
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	var t = template
		.replace(/0hh12/g, String.zeroPad(this.getHours12(), 2))
		.replace(/hh12/g, this.getHours12())
		.replace(/0hh/g, String.zeroPad(this.getHours(), 2))
		.replace(/hh/g, this.getHours())
		.replace(/mmm/g, config.messages.dates.shortMonths[this.getMonth()])
		.replace(/0mm/g, String.zeroPad(this.getMinutes(), 2))
		.replace(/mm/g, this.getMinutes())
		.replace(/0ss/g, String.zeroPad(this.getSeconds(), 2))
		.replace(/ss/g, this.getSeconds())
		.replace(/[ap]m/g, this.getAmPm().toLowerCase())
		.replace(/[AP]M/g, this.getAmPm().toUpperCase())
		.replace(/wYYYY/g, this.getYearForWeekNo())
		.replace(/wYY/g, String.zeroPad(this.getYearForWeekNo() - 2000, 2))
		.replace(/YYYY/g, this.getFullYear())
		.replace(/YY/g, String.zeroPad(this.getFullYear() - 2000, 2))
		.replace(/MMM/g, config.messages.dates.months[this.getMonth()])
		.replace(/0MM/g, String.zeroPad(this.getMonth() + 1, 2))
		.replace(/MM/g, this.getMonth() + 1)
		.replace(/0WW/g, String.zeroPad(this.getWeek(), 2))
		.replace(/WW/g, this.getWeek())
		.replace(/DDD/g, config.messages.dates.days[this.getDay()])
		.replace(/ddd/g, config.messages.dates.shortDays[this.getDay()])
		.replace(/0DD/g, String.zeroPad(this.getDate(), 2))
		.replace(/DDth/g, this.getDate() + this.daySuffix())
		.replace(/DD/g, this.getDate())
		.replace(/TZD/g, (tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60), 2) +
			':' + String.zeroPad(atz % 60, 2))
		.replace(/\\/g, "");
	return t;
};

Date.prototype.getWeek = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week to calculate weekNo
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	var n = Math.floor((dt.getTime() - new Date(dt.getFullYear(), 0, 1) + 3600000) / 86400000);
	return Math.floor(n / 7) + 1;
};

Date.prototype.getYearForWeekNo = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	// JavaScript Sun=0, ISO Sun=7
	if(d == 0) d = 7;
	// shift day to Thurs of same week
	dt.setTime(dt.getTime() + (4 - d) * 86400000);
	return dt.getFullYear();
};

Date.prototype.getHours12 = function() {
	var h = this.getHours();
	return h > 12 ? h - 12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function() {
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function() {
	return config.messages.dates.daySuffixes[this.getDate() - 1];
};

// Convert to local YYYYMMDDHHMM format string
Date.prototype.convertToLocalYYYYMMDDHHMM = function() {
	return this.getFullYear() + String.zeroPad(this.getMonth() + 1, 2) + String.zeroPad(this.getDate(), 2) +
		String.zeroPad(this.getHours(), 2) + String.zeroPad(this.getMinutes(), 2);
};

// Convert to UTC YYYYMMDDHHMM format string
Date.prototype.convertToYYYYMMDDHHMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) + String.zeroPad(this.getUTCDate(), 2) +
		String.zeroPad(this.getUTCHours(), 2) + String.zeroPad(this.getUTCMinutes(), 2);
};

// Convert to UTC YYYYMMDD.HHMMSSMMM format string
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth() + 1, 2) +
		String.zeroPad(this.getUTCDate(), 2) + "." + String.zeroPad(this.getUTCHours(), 2) +
		String.zeroPad(this.getUTCMinutes(), 2) + String.zeroPad(this.getUTCSeconds(), 2) +
		String.zeroPad(this.getUTCMilliseconds(), 3) + "0";
};

// Static. Create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 12));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0, 14));
};

// Static. Create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0, 4), 10),
		parseInt(d.substr(4, 2), 10) - 1,
		parseInt(d.substr(6, 2), 10),
		parseInt(d.substr(8, 2) || "00", 10),
		parseInt(d.substr(10, 2) || "00", 10),
		parseInt(d.substr(12, 2) || "00", 10),
		parseInt(d.substr(14, 3) || "000", 10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r, g, b) {
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0, 1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1, 2), 16) / 255;
				this.g = parseInt(r.substr(3, 2), 16) / 255;
				this.b = parseInt(r.substr(5, 2), 16) / 255;
			} else {
				this.r = parseInt(r.substr(1, 1), 16) / 15;
				this.g = parseInt(r.substr(2, 1), 16) / 15;
				this.b = parseInt(r.substr(3, 1), 16) / 15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1], 10) / 255;
				this.g = parseInt(c[2], 10) / 255;
				this.b = parseInt(c[3], 10) / 255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c, f) {
	return new RGB(this.r + (c.r - this.r) * f, this.g + (c.g - this.g) * f, this.b + (c.b - this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function() {
	var to255Range = function(value) {
		var clamped = value < 0 ? 0 : value > 1 ? 1 : value;
		return clamped * 255;
	};

	var to2DigitString = function(value) {
		var s = Math.floor(value).toString(16);
		return ("0" + s).slice(-2);
	};

	return "#" +
		to2DigitString(to255Range(this.r)) +
		to2DigitString(to255Range(this.g)) +
		to2DigitString(to255Range(this.b));
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

tw.assets.icons.closeSvg =
	'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" class="tw-icon">' +
	'	<line x1="1" y1="1" x2="9" y2="9" rx="1" ry="1"/>' +
	'	<line x1="9" y1="1" x2="1" y2="9" rx="1" ry="1"/>' +
	'</svg>';

function drawGradient(place, horiz, loColors, hiColors) {
	if(!hiColors) hiColors = loColors;

	for(var i = 0; i <= 100; i += 2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? i + "%" : 0;
		bar.style.top = horiz ? 0 : i + "%";
		bar.style.width = horiz ? (101 - i) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101 - i) + "%";
		bar.style.zIndex = -1;
		var p = i / 100 * (loColors.length - 1);
		var hc = hiColors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = loColors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc, p - Math.floor(p)).toString();
	}
}

function addEvent(obj, type, fn) {
	if(obj.attachEvent) {
		obj["e" + type + fn] = fn;
		obj[type + fn] = function() { obj["e" + type + fn](window.event) };
		obj.attachEvent("on" + type, obj[type + fn]);
	} else {
		obj.addEventListener(type, fn, false);
	}
}

function removeEvent(obj, type, fn) {
	if(obj.detachEvent) {
		obj.detachEvent("on" + type, obj[type + fn]);
		obj[type + fn] = null;
	} else {
		obj.removeEventListener(type, fn, false);
	}
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e, value, name, relative) {
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !jQuery(e).hasClass(value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e) {
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth() {
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight() {
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
	var d = document;
	return Math.max(
		Math.max(d.body.scrollHeight, d.documentElement.scrollHeight),
		Math.max(d.body.offsetHeight, d.documentElement.offsetHeight),
		Math.max(d.body.clientHeight, d.documentElement.clientHeight)
	);
}

// Get the current horizontal page scroll position
function findScrollX() {
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY() {
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj) {
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj) {
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

function blurElement(e) {
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place) {
	var e = document.createTextNode(String.fromCharCode(160));
	if(place) place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e, text) {
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0, e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length, oldpos + text.length);
		// scroll into view
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0, e.selectionStart).split("\n").length - 1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) { // support IE
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e, pos) {
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) { // support IE
		e.focus();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character', pos);
		sel.moveEnd('character', 0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e) {
	var text = "";
	while(e && e.nodeName == "#text") {
		text += e.nodeValue;
		e = e.nextSibling;
	}
	return text;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e, ancestor) {
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e) {
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e) {
	if(!config.browser.isIE) return;
	var att = e.attributes;
	if(att) {
		for(var i = 0; i < att.length; i++) {
			var n = att[i].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s, id, doc) {
	jQuery.twStylesheet(s, { id: id, doc: doc });
}

function removeStyleSheet(id) {
	jQuery.twStylesheet.remove({ id: id });
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store, node, tiddlers) {
	var title = this.getTitle(store, node);
	if(!title) return;
	if(safeMode && store.isShadowTiddler(title)) return;

	var tiddler = store.createTiddler(title);
	this.internalizeTiddler(store, tiddler, title, node);
	tiddlers.push(tiddler);
};

LoaderBase.prototype.loadTiddlers = function(store, nodes) {
	var i, tiddlers = [];
	for(i = 0; i < nodes.length; i++) {
		try {
			this.loadTiddler(store, nodes[i], tiddlers);
		} catch(ex) {
			showException(ex, config.messages.tiddlerLoadError.format([this.getTitle(store, nodes[i])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store) {
	var results = [];
	var i, tiddlers = store.getTiddlers("title");
	for(i = 0; i < tiddlers.length; i++) {
		if(!tiddlers[i].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[i]));
	}
	return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store, node) {
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title") || node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var prefixLen = store.idPrefix.length;
		if(node.id.substr(0, prefixLen) == store.idPrefix)
			title = node.id.substr(prefixLen);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store, tiddler, title, node) {
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute && node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName != "PRE" && e.nodeName != "pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg, "").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var i, attrs = node.attributes;
	for(i = attrs.length - 1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title, text, modifier, modified, tags, created, fields, creator);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store, tiddler) {
	try {
		var usePre = config.options.chkUsePreForStorage;
		var created = tiddler.created;
		var modified = tiddler.modified;
		var tags = tiddler.getTags();
		var attributes =
			(tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "") +
			(tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "") +
			((usePre && created == version.date) ? "" : ' created="' + created.convertToYYYYMMDDHHMM() + '"') +
			((usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() + '"') +
			((!usePre || tags) ? ' tags="' + tags.htmlEncode() + '"' : "");
		var extendedAttributes = "";
		store.forEachField(tiddler, function(tiddler, fieldName, value) {
			if(typeof value != "string")
				value = "";
			// don't store fields from the temp namespace
			if(!fieldName.match(/^temp\./))
				extendedAttributes += ' %0="%1"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);
		}, true);
		return ('<div %0="%1"%2%3>%4</' + 'div>').format([
			usePre ? "title" : "tiddler",
			tiddler.title.htmlEncode(),
			attributes,
			extendedAttributes,
			usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
		]);
	} catch (ex) {
		throw exceptionText(ex, config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};



//]]>
</script>

<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output, this.element), this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead, "mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE) text = text.replace(/\n/g, "\r");
		createTiddlyElement(w.output, "pre", null, null, text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br = {};
config.macros.br.handler = function(place)
{
	createTiddlyElement(place, "br");
};

// Find an item in an array. If a predicate is provided, use the native Array.find (return the item);
// otherwise (for backwards compatibility) treat the argument as an item to find (return the index or null)
// @Deprecated: Use indexOf instead
Array.prototype.orig_find = Array.prototype.find;
Array.prototype.find = function(itemOrPredicate)
{
	if(itemOrPredicate instanceof Function) return Array.prototype.orig_find.apply(this, arguments);
	var i = this.indexOf(itemOrPredicate);
	return i == -1 ? null : i;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
// @Deprecated: No direct substitution
Array.prototype.setItem = function(value, mode)
{
	var i = this.indexOf(value);
	if(mode == 0) mode = (i == -1) ? +1 : -1;
	if(mode == +1) {
		if(i == -1) this.push(value);
	} else if(mode == -1) {
		if(i != -1) this.splice(i, 1);
	}
};

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.map) {
	Array.prototype.map = function(fn, thisObj)
	{
		var scope = thisObj || window;
		var i, j, a = [];
		for(i = 0, j = this.length; i < j; ++i) {
			a.push(fn.call(scope, this[i], i, this));
		}
		return a;
	};
}

// For IE up to 8 (https://caniuse.com/?search=indexOf)
if(!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(item, from)
	{
		if(!from) from = 0;
		for(var i = from; i < this.length; i++) {
			if(this[i] === item) return i;
		}
		return -1;
	};
}

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef, title)
{
	return store.getLoader().internalizeTiddler(store, this, title, divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated: Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store, this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement, titles, template, unused1, unused2, animate, unused3)
{
	story.displayTiddlers(srcElement, titles, template, animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement, title, template, unused1, unused2, animate, unused3)
{
	story.displayTiddler(srcElement, title, template, animate);
}

// @Deprecated: Java IO is no longer supported;
// these "empty" versions are only left for the tiny chance of backwards
// compatibility issues and will be removed completely in the future
function javaSaveFile(filePath, content)
{
	return null;
}

function javaLoadFile(filePath)
{
	return null;
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n", "mg");
var regexpBackSlash = new RegExp("\\\\", "mg");
var regexpBackSlashEss = new RegExp("\\\\s", "mg");
var regexpNewLine = new RegExp("\n", "mg");
var regexpCarriageReturn = new RegExp("\r", "mg");

//--
//-- Deprecated FileAdaptor functions
//--

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};

//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}

//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"':  '\\"',
		'\\': '\\\\'
	};
	var replaceFn = function(a, b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
	};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g, replaceFn) + '"';
	return '"' + this + '"';
};

// @Deprecated: no direct replacement, since not used in core code
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length - n) : this;
};

// @Deprecated: no direct replacement, since not used in core code (see unDash in inlineCssHelper)
// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var i, words = this.split("-");
	for(i = 1; i < words.length; i++)
		words[i] = words[i].substring(0, 1).toUpperCase() + words[i].substring(1);
	return words.join("");
};

// @Deprecated: use tw.textUtils.getChunkRange instead
String.prototype.getChunkRange = function(startMarker, endMarker)
{
	return tw.textUtils.getChunkRange(this, startMarker, endMarker);
};

// @Deprecated: no direct replacement, since not used in core code
// Get a chunk of a string between startMarker and endMarker, or undefined
String.prototype.getChunk = function(startMarker, endMarker)
{
	var r = tw.textUtils.getChunkRange(this, startMarker, endMarker);
	if(r) return this.substring(r[0], r[1]);
};

// @Deprecated: use tw.textUtils.replaceChunk instead
String.prototype.replaceChunk = function(startMarker, endMarker, newValue)
{
	return tw.textUtils.replaceChunk(this, startMarker, endMarker, newValue);
};

//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};

//--
//-- Deprecated Number functions
//--

// @Deprecated: no direct replacement, since not used in core code
// Clamp a number to a range
Number.prototype.clamp = function(min, max)
{
	var c = this;
	if(c < min) c = min;
	if(c > max) c = max;
	return Number(c);
};

//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Remove a node and all its children
function removeNode(e)
{
	jQuery(e).remove();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

function addClass(e, className)
{
	jQuery(e).addClass(className);
}

function removeClass(e, className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e, className)
{
	return jQuery(e).hasClass(className);
}

//--
//-- Deprecated Wikifier code
//--

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}


//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*! jQuery v1.9.1 | (c) 2005, 2012 jQuery Foundation, Inc. | jquery.org/license
//@ sourceMappingURL=jquery.min.map
*/(function(e,t){var n,r,i=typeof t,o=e.document,a=e.location,s=e.jQuery,u=e.$,l={},c=[],p="1.9.1",f=c.concat,d=c.push,h=c.slice,g=c.indexOf,m=l.toString,y=l.hasOwnProperty,v=p.trim,b=function(e,t){return new b.fn.init(e,t,r)},x=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,w=/\S+/g,T=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,N=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,k=/^[\],:{}\s]*$/,E=/(?:^|:|,)(?:\s*\[)+/g,S=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,A=/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,j=/^-ms-/,D=/-([\da-z])/gi,L=function(e,t){return t.toUpperCase()},H=function(e){(o.addEventListener||"load"===e.type||"complete"===o.readyState)&&(q(),b.ready())},q=function(){o.addEventListener?(o.removeEventListener("DOMContentLoaded",H,!1),e.removeEventListener("load",H,!1)):(o.detachEvent("onreadystatechange",H),e.detachEvent("onload",H))};b.fn=b.prototype={jquery:p,constructor:b,init:function(e,n,r){var i,a;if(!e)return this;if("string"==typeof e){if(i="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:N.exec(e),!i||!i[1]&&n)return!n||n.jquery?(n||r).find(e):this.constructor(n).find(e);if(i[1]){if(n=n instanceof b?n[0]:n,b.merge(this,b.parseHTML(i[1],n&&n.nodeType?n.ownerDocument||n:o,!0)),C.test(i[1])&&b.isPlainObject(n))for(i in n)b.isFunction(this[i])?this[i](n[i]):this.attr(i,n[i]);return this}if(a=o.getElementById(i[2]),a&&a.parentNode){if(a.id!==i[2])return r.find(e);this.length=1,this[0]=a}return this.context=o,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):b.isFunction(e)?r.ready(e):(e.selector!==t&&(this.selector=e.selector,this.context=e.context),b.makeArray(e,this))},selector:"",length:0,size:function(){return this.length},toArray:function(){return h.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=b.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return b.each(this,e,t)},ready:function(e){return b.ready.promise().done(e),this},slice:function(){return this.pushStack(h.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},map:function(e){return this.pushStack(b.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:d,sort:[].sort,splice:[].splice},b.fn.init.prototype=b.fn,b.extend=b.fn.extend=function(){var e,n,r,i,o,a,s=arguments[0]||{},u=1,l=arguments.length,c=!1;for("boolean"==typeof s&&(c=s,s=arguments[1]||{},u=2),"object"==typeof s||b.isFunction(s)||(s={}),l===u&&(s=this,--u);l>u;u++)if(null!=(o=arguments[u]))for(i in o)e=s[i],r=o[i],s!==r&&(c&&r&&(b.isPlainObject(r)||(n=b.isArray(r)))?(n?(n=!1,a=e&&b.isArray(e)?e:[]):a=e&&b.isPlainObject(e)?e:{},s[i]=b.extend(c,a,r)):r!==t&&(s[i]=r));return s},b.extend({noConflict:function(t){return e.$===b&&(e.$=u),t&&e.jQuery===b&&(e.jQuery=s),b},isReady:!1,readyWait:1,holdReady:function(e){e?b.readyWait++:b.ready(!0)},ready:function(e){if(e===!0?!--b.readyWait:!b.isReady){if(!o.body)return setTimeout(b.ready);b.isReady=!0,e!==!0&&--b.readyWait>0||(n.resolveWith(o,[b]),b.fn.trigger&&b(o).trigger("ready").off("ready"))}},isFunction:function(e){return"function"===b.type(e)},isArray:Array.isArray||function(e){return"array"===b.type(e)},isWindow:function(e){return null!=e&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[m.call(e)]||"object":typeof e},isPlainObject:function(e){if(!e||"object"!==b.type(e)||e.nodeType||b.isWindow(e))return!1;try{if(e.constructor&&!y.call(e,"constructor")&&!y.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(n){return!1}var r;for(r in e);return r===t||y.call(e,r)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||o;var r=C.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=b.buildFragment([e],t,i),i&&b(i).remove(),b.merge([],r.childNodes))},parseJSON:function(n){return e.JSON&&e.JSON.parse?e.JSON.parse(n):null===n?n:"string"==typeof n&&(n=b.trim(n),n&&k.test(n.replace(S,"@").replace(A,"]").replace(E,"")))?Function("return "+n)():(b.error("Invalid JSON: "+n),t)},parseXML:function(n){var r,i;if(!n||"string"!=typeof n)return null;try{e.DOMParser?(i=new DOMParser,r=i.parseFromString(n,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(n))}catch(o){r=t}return r&&r.documentElement&&!r.getElementsByTagName("parsererror").length||b.error("Invalid XML: "+n),r},noop:function(){},globalEval:function(t){t&&b.trim(t)&&(e.execScript||function(t){e.eval.call(e,t)})(t)},camelCase:function(e){return e.replace(j,"ms-").replace(D,L)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var r,i=0,o=e.length,a=M(e);if(n){if(a){for(;o>i;i++)if(r=t.apply(e[i],n),r===!1)break}else for(i in e)if(r=t.apply(e[i],n),r===!1)break}else if(a){for(;o>i;i++)if(r=t.call(e[i],i,e[i]),r===!1)break}else for(i in e)if(r=t.call(e[i],i,e[i]),r===!1)break;return e},trim:v&&!v.call("\ufeff\u00a0")?function(e){return null==e?"":v.call(e)}:function(e){return null==e?"":(e+"").replace(T,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(M(Object(e))?b.merge(n,"string"==typeof e?[e]:e):d.call(n,e)),n},inArray:function(e,t,n){var r;if(t){if(g)return g.call(t,e,n);for(r=t.length,n=n?0>n?Math.max(0,r+n):n:0;r>n;n++)if(n in t&&t[n]===e)return n}return-1},merge:function(e,n){var r=n.length,i=e.length,o=0;if("number"==typeof r)for(;r>o;o++)e[i++]=n[o];else while(n[o]!==t)e[i++]=n[o++];return e.length=i,e},grep:function(e,t,n){var r,i=[],o=0,a=e.length;for(n=!!n;a>o;o++)r=!!t(e[o],o),n!==r&&i.push(e[o]);return i},map:function(e,t,n){var r,i=0,o=e.length,a=M(e),s=[];if(a)for(;o>i;i++)r=t(e[i],i,n),null!=r&&(s[s.length]=r);else for(i in e)r=t(e[i],i,n),null!=r&&(s[s.length]=r);return f.apply([],s)},guid:1,proxy:function(e,n){var r,i,o;return"string"==typeof n&&(o=e[n],n=e,e=o),b.isFunction(e)?(r=h.call(arguments,2),i=function(){return e.apply(n||this,r.concat(h.call(arguments)))},i.guid=e.guid=e.guid||b.guid++,i):t},access:function(e,n,r,i,o,a,s){var u=0,l=e.length,c=null==r;if("object"===b.type(r)){o=!0;for(u in r)b.access(e,n,u,r[u],!0,a,s)}else if(i!==t&&(o=!0,b.isFunction(i)||(s=!0),c&&(s?(n.call(e,i),n=null):(c=n,n=function(e,t,n){return c.call(b(e),n)})),n))for(;l>u;u++)n(e[u],r,s?i:i.call(e[u],u,n(e[u],r)));return o?e:c?n.call(e):l?n(e[0],r):a},now:function(){return(new Date).getTime()}}),b.ready.promise=function(t){if(!n)if(n=b.Deferred(),"complete"===o.readyState)setTimeout(b.ready);else if(o.addEventListener)o.addEventListener("DOMContentLoaded",H,!1),e.addEventListener("load",H,!1);else{o.attachEvent("onreadystatechange",H),e.attachEvent("onload",H);var r=!1;try{r=null==e.frameElement&&o.documentElement}catch(i){}r&&r.doScroll&&function a(){if(!b.isReady){try{r.doScroll("left")}catch(e){return setTimeout(a,50)}q(),b.ready()}}()}return n.promise(t)},b.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){l["[object "+t+"]"]=t.toLowerCase()});function M(e){var t=e.length,n=b.type(e);return b.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}r=b(o);var _={};function F(e){var t=_[e]={};return b.each(e.match(w)||[],function(e,n){t[n]=!0}),t}b.Callbacks=function(e){e="string"==typeof e?_[e]||F(e):b.extend({},e);var n,r,i,o,a,s,u=[],l=!e.once&&[],c=function(t){for(r=e.memory&&t,i=!0,a=s||0,s=0,o=u.length,n=!0;u&&o>a;a++)if(u[a].apply(t[0],t[1])===!1&&e.stopOnFalse){r=!1;break}n=!1,u&&(l?l.length&&c(l.shift()):r?u=[]:p.disable())},p={add:function(){if(u){var t=u.length;(function i(t){b.each(t,function(t,n){var r=b.type(n);"function"===r?e.unique&&p.has(n)||u.push(n):n&&n.length&&"string"!==r&&i(n)})})(arguments),n?o=u.length:r&&(s=t,c(r))}return this},remove:function(){return u&&b.each(arguments,function(e,t){var r;while((r=b.inArray(t,u,r))>-1)u.splice(r,1),n&&(o>=r&&o--,a>=r&&a--)}),this},has:function(e){return e?b.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],this},disable:function(){return u=l=r=t,this},disabled:function(){return!u},lock:function(){return l=t,r||p.disable(),this},locked:function(){return!l},fireWith:function(e,t){return t=t||[],t=[e,t.slice?t.slice():t],!u||i&&!l||(n?l.push(t):c(t)),this},fire:function(){return p.fireWith(this,arguments),this},fired:function(){return!!i}};return p},b.extend({Deferred:function(e){var t=[["resolve","done",b.Callbacks("once memory"),"resolved"],["reject","fail",b.Callbacks("once memory"),"rejected"],["notify","progress",b.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return b.Deferred(function(n){b.each(t,function(t,o){var a=o[0],s=b.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&b.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[a+"With"](this===r?n.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?b.extend(e,r):r}},i={};return r.pipe=r.then,b.each(t,function(e,o){var a=o[2],s=o[3];r[o[1]]=a.add,s&&a.add(function(){n=s},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=a.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=h.call(arguments),r=n.length,i=1!==r||e&&b.isFunction(e.promise)?r:0,o=1===i?e:b.Deferred(),a=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?h.call(arguments):r,n===s?o.notifyWith(t,n):--i||o.resolveWith(t,n)}},s,u,l;if(r>1)for(s=Array(r),u=Array(r),l=Array(r);r>t;t++)n[t]&&b.isFunction(n[t].promise)?n[t].promise().done(a(t,l,n)).fail(o.reject).progress(a(t,u,s)):--i;return i||o.resolveWith(l,n),o.promise()}}),b.support=function(){var t,n,r,a,s,u,l,c,p,f,d=o.createElement("div");if(d.setAttribute("className","t"),d.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",n=d.getElementsByTagName("*"),r=d.getElementsByTagName("a")[0],!n||!r||!n.length)return{};s=o.createElement("select"),l=s.appendChild(o.createElement("option")),a=d.getElementsByTagName("input")[0],r.style.cssText="top:1px;float:left;opacity:.5",t={getSetAttribute:"t"!==d.className,leadingWhitespace:3===d.firstChild.nodeType,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/top/.test(r.getAttribute("style")),hrefNormalized:"/a"===r.getAttribute("href"),opacity:/^0.5/.test(r.style.opacity),cssFloat:!!r.style.cssFloat,checkOn:!!a.value,optSelected:l.selected,enctype:!!o.createElement("form").enctype,html5Clone:"<:nav></:nav>"!==o.createElement("nav").cloneNode(!0).outerHTML,boxModel:"CSS1Compat"===o.compatMode,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},a.checked=!0,t.noCloneChecked=a.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!l.disabled;try{delete d.test}catch(h){t.deleteExpando=!1}a=o.createElement("input"),a.setAttribute("value",""),t.input=""===a.getAttribute("value"),a.value="t",a.setAttribute("type","radio"),t.radioValue="t"===a.value,a.setAttribute("checked","t"),a.setAttribute("name","t"),u=o.createDocumentFragment(),u.appendChild(a),t.appendChecked=a.checked,t.checkClone=u.cloneNode(!0).cloneNode(!0).lastChild.checked,d.attachEvent&&(d.attachEvent("onclick",function(){t.noCloneEvent=!1}),d.cloneNode(!0).click());for(f in{submit:!0,change:!0,focusin:!0})d.setAttribute(c="on"+f,"t"),t[f+"Bubbles"]=c in e||d.attributes[c].expando===!1;return d.style.backgroundClip="content-box",d.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===d.style.backgroundClip,b(function(){var n,r,a,s="padding:0;margin:0;border:0;display:block;box-sizing:content-box;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;",u=o.getElementsByTagName("body")[0];u&&(n=o.createElement("div"),n.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",u.appendChild(n).appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",a=d.getElementsByTagName("td"),a[0].style.cssText="padding:0;margin:0;border:0;display:none",p=0===a[0].offsetHeight,a[0].style.display="",a[1].style.display="none",t.reliableHiddenOffsets=p&&0===a[0].offsetHeight,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",t.boxSizing=4===d.offsetWidth,t.doesNotIncludeMarginInBodyOffset=1!==u.offsetTop,e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(d,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(d,null)||{width:"4px"}).width,r=d.appendChild(o.createElement("div")),r.style.cssText=d.style.cssText=s,r.style.marginRight=r.style.width="0",d.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(r,null)||{}).marginRight)),typeof d.style.zoom!==i&&(d.innerHTML="",d.style.cssText=s+"width:1px;padding:1px;display:inline;zoom:1",t.inlineBlockNeedsLayout=3===d.offsetWidth,d.style.display="block",d.innerHTML="<div></div>",d.firstChild.style.width="5px",t.shrinkWrapBlocks=3!==d.offsetWidth,t.inlineBlockNeedsLayout&&(u.style.zoom=1)),u.removeChild(n),n=d=a=r=null)}),n=s=u=l=r=a=null,t}();var O=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,B=/([A-Z])/g;function P(e,n,r,i){if(b.acceptData(e)){var o,a,s=b.expando,u="string"==typeof n,l=e.nodeType,p=l?b.cache:e,f=l?e[s]:e[s]&&s;if(f&&p[f]&&(i||p[f].data)||!u||r!==t)return f||(l?e[s]=f=c.pop()||b.guid++:f=s),p[f]||(p[f]={},l||(p[f].toJSON=b.noop)),("object"==typeof n||"function"==typeof n)&&(i?p[f]=b.extend(p[f],n):p[f].data=b.extend(p[f].data,n)),o=p[f],i||(o.data||(o.data={}),o=o.data),r!==t&&(o[b.camelCase(n)]=r),u?(a=o[n],null==a&&(a=o[b.camelCase(n)])):a=o,a}}function R(e,t,n){if(b.acceptData(e)){var r,i,o,a=e.nodeType,s=a?b.cache:e,u=a?e[b.expando]:b.expando;if(s[u]){if(t&&(o=n?s[u]:s[u].data)){b.isArray(t)?t=t.concat(b.map(t,b.camelCase)):t in o?t=[t]:(t=b.camelCase(t),t=t in o?[t]:t.split(" "));for(r=0,i=t.length;i>r;r++)delete o[t[r]];if(!(n?$:b.isEmptyObject)(o))return}(n||(delete s[u].data,$(s[u])))&&(a?b.cleanData([e],!0):b.support.deleteExpando||s!=s.window?delete s[u]:s[u]=null)}}}b.extend({cache:{},expando:"jQuery"+(p+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(e){return e=e.nodeType?b.cache[e[b.expando]]:e[b.expando],!!e&&!$(e)},data:function(e,t,n){return P(e,t,n)},removeData:function(e,t){return R(e,t)},_data:function(e,t,n){return P(e,t,n,!0)},_removeData:function(e,t){return R(e,t,!0)},acceptData:function(e){if(e.nodeType&&1!==e.nodeType&&9!==e.nodeType)return!1;var t=e.nodeName&&b.noData[e.nodeName.toLowerCase()];return!t||t!==!0&&e.getAttribute("classid")===t}}),b.fn.extend({data:function(e,n){var r,i,o=this[0],a=0,s=null;if(e===t){if(this.length&&(s=b.data(o),1===o.nodeType&&!b._data(o,"parsedAttrs"))){for(r=o.attributes;r.length>a;a++)i=r[a].name,i.indexOf("data-")||(i=b.camelCase(i.slice(5)),W(o,i,s[i]));b._data(o,"parsedAttrs",!0)}return s}return"object"==typeof e?this.each(function(){b.data(this,e)}):b.access(this,function(n){return n===t?o?W(o,e,b.data(o,e)):null:(this.each(function(){b.data(this,e,n)}),t)},null,n,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){b.removeData(this,e)})}});function W(e,n,r){if(r===t&&1===e.nodeType){var i="data-"+n.replace(B,"-$1").toLowerCase();if(r=e.getAttribute(i),"string"==typeof r){try{r="true"===r?!0:"false"===r?!1:"null"===r?null:+r+""===r?+r:O.test(r)?b.parseJSON(r):r}catch(o){}b.data(e,n,r)}else r=t}return r}function $(e){var t;for(t in e)if(("data"!==t||!b.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0}b.extend({queue:function(e,n,r){var i;return e?(n=(n||"fx")+"queue",i=b._data(e,n),r&&(!i||b.isArray(r)?i=b._data(e,n,b.makeArray(r)):i.push(r)),i||[]):t},dequeue:function(e,t){t=t||"fx";var n=b.queue(e,t),r=n.length,i=n.shift(),o=b._queueHooks(e,t),a=function(){b.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),o.cur=i,i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,a,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return b._data(e,n)||b._data(e,n,{empty:b.Callbacks("once memory").add(function(){b._removeData(e,t+"queue"),b._removeData(e,n)})})}}),b.fn.extend({queue:function(e,n){var r=2;return"string"!=typeof e&&(n=e,e="fx",r--),r>arguments.length?b.queue(this[0],e):n===t?this:this.each(function(){var t=b.queue(this,e,n);b._queueHooks(this,e),"fx"===e&&"inprogress"!==t[0]&&b.dequeue(this,e)})},dequeue:function(e){return this.each(function(){b.dequeue(this,e)})},delay:function(e,t){return e=b.fx?b.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,n){var r,i=1,o=b.Deferred(),a=this,s=this.length,u=function(){--i||o.resolveWith(a,[a])};"string"!=typeof e&&(n=e,e=t),e=e||"fx";while(s--)r=b._data(a[s],e+"queueHooks"),r&&r.empty&&(i++,r.empty.add(u));return u(),o.promise(n)}});var I,z,X=/[\t\r\n]/g,U=/\r/g,V=/^(?:input|select|textarea|button|object)$/i,Y=/^(?:a|area)$/i,J=/^(?:checked|selected|autofocus|autoplay|async|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped)$/i,G=/^(?:checked|selected)$/i,Q=b.support.getSetAttribute,K=b.support.input;b.fn.extend({attr:function(e,t){return b.access(this,b.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){b.removeAttr(this,e)})},prop:function(e,t){return b.access(this,b.prop,e,t,arguments.length>1)},removeProp:function(e){return e=b.propFix[e]||e,this.each(function(){try{this[e]=t,delete this[e]}catch(n){}})},addClass:function(e){var t,n,r,i,o,a=0,s=this.length,u="string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).addClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):" ")){o=0;while(i=t[o++])0>r.indexOf(" "+i+" ")&&(r+=i+" ");n.className=b.trim(r)}return this},removeClass:function(e){var t,n,r,i,o,a=0,s=this.length,u=0===arguments.length||"string"==typeof e&&e;if(b.isFunction(e))return this.each(function(t){b(this).removeClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];s>a;a++)if(n=this[a],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(X," "):"")){o=0;while(i=t[o++])while(r.indexOf(" "+i+" ")>=0)r=r.replace(" "+i+" "," ");n.className=e?b.trim(r):""}return this},toggleClass:function(e,t){var n=typeof e,r="boolean"==typeof t;return b.isFunction(e)?this.each(function(n){b(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if("string"===n){var o,a=0,s=b(this),u=t,l=e.match(w)||[];while(o=l[a++])u=r?u:!s.hasClass(o),s[u?"addClass":"removeClass"](o)}else(n===i||"boolean"===n)&&(this.className&&b._data(this,"__className__",this.className),this.className=this.className||e===!1?"":b._data(this,"__className__")||"")})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(X," ").indexOf(t)>=0)return!0;return!1},val:function(e){var n,r,i,o=this[0];{if(arguments.length)return i=b.isFunction(e),this.each(function(n){var o,a=b(this);1===this.nodeType&&(o=i?e.call(this,n,a.val()):e,null==o?o="":"number"==typeof o?o+="":b.isArray(o)&&(o=b.map(o,function(e){return null==e?"":e+""})),r=b.valHooks[this.type]||b.valHooks[this.nodeName.toLowerCase()],r&&"set"in r&&r.set(this,o,"value")!==t||(this.value=o))});if(o)return r=b.valHooks[o.type]||b.valHooks[o.nodeName.toLowerCase()],r&&"get"in r&&(n=r.get(o,"value"))!==t?n:(n=o.value,"string"==typeof n?n.replace(U,""):null==n?"":n)}}}),b.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,a=o?null:[],s=o?i+1:r.length,u=0>i?s:o?i:0;for(;s>u;u++)if(n=r[u],!(!n.selected&&u!==i||(b.support.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&b.nodeName(n.parentNode,"optgroup"))){if(t=b(n).val(),o)return t;a.push(t)}return a},set:function(e,t){var n=b.makeArray(t);return b(e).find("option").each(function(){this.selected=b.inArray(b(this).val(),n)>=0}),n.length||(e.selectedIndex=-1),n}}},attr:function(e,n,r){var o,a,s,u=e.nodeType;if(e&&3!==u&&8!==u&&2!==u)return typeof e.getAttribute===i?b.prop(e,n,r):(a=1!==u||!b.isXMLDoc(e),a&&(n=n.toLowerCase(),o=b.attrHooks[n]||(J.test(n)?z:I)),r===t?o&&a&&"get"in o&&null!==(s=o.get(e,n))?s:(typeof e.getAttribute!==i&&(s=e.getAttribute(n)),null==s?t:s):null!==r?o&&a&&"set"in o&&(s=o.set(e,r,n))!==t?s:(e.setAttribute(n,r+""),r):(b.removeAttr(e,n),t))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(w);if(o&&1===e.nodeType)while(n=o[i++])r=b.propFix[n]||n,J.test(n)?!Q&&G.test(n)?e[b.camelCase("default-"+n)]=e[r]=!1:e[r]=!1:b.attr(e,n,""),e.removeAttribute(Q?n:r)},attrHooks:{type:{set:function(e,t){if(!b.support.radioValue&&"radio"===t&&b.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(e,n,r){var i,o,a,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return a=1!==s||!b.isXMLDoc(e),a&&(n=b.propFix[n]||n,o=b.propHooks[n]),r!==t?o&&"set"in o&&(i=o.set(e,r,n))!==t?i:e[n]=r:o&&"get"in o&&null!==(i=o.get(e,n))?i:e[n]},propHooks:{tabIndex:{get:function(e){var n=e.getAttributeNode("tabindex");return n&&n.specified?parseInt(n.value,10):V.test(e.nodeName)||Y.test(e.nodeName)&&e.href?0:t}}}}),z={get:function(e,n){var r=b.prop(e,n),i="boolean"==typeof r&&e.getAttribute(n),o="boolean"==typeof r?K&&Q?null!=i:G.test(n)?e[b.camelCase("default-"+n)]:!!i:e.getAttributeNode(n);return o&&o.value!==!1?n.toLowerCase():t},set:function(e,t,n){return t===!1?b.removeAttr(e,n):K&&Q||!G.test(n)?e.setAttribute(!Q&&b.propFix[n]||n,n):e[b.camelCase("default-"+n)]=e[n]=!0,n}},K&&Q||(b.attrHooks.value={get:function(e,n){var r=e.getAttributeNode(n);return b.nodeName(e,"input")?e.defaultValue:r&&r.specified?r.value:t},set:function(e,n,r){return b.nodeName(e,"input")?(e.defaultValue=n,t):I&&I.set(e,n,r)}}),Q||(I=b.valHooks.button={get:function(e,n){var r=e.getAttributeNode(n);return r&&("id"===n||"name"===n||"coords"===n?""!==r.value:r.specified)?r.value:t},set:function(e,n,r){var i=e.getAttributeNode(r);return i||e.setAttributeNode(i=e.ownerDocument.createAttribute(r)),i.value=n+="","value"===r||n===e.getAttribute(r)?n:t}},b.attrHooks.contenteditable={get:I.get,set:function(e,t,n){I.set(e,""===t?!1:t,n)}},b.each(["width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{set:function(e,r){return""===r?(e.setAttribute(n,"auto"),r):t}})})),b.support.hrefNormalized||(b.each(["href","src","width","height"],function(e,n){b.attrHooks[n]=b.extend(b.attrHooks[n],{get:function(e){var r=e.getAttribute(n,2);return null==r?t:r}})}),b.each(["href","src"],function(e,t){b.propHooks[t]={get:function(e){return e.getAttribute(t,4)}}})),b.support.style||(b.attrHooks.style={get:function(e){return e.style.cssText||t},set:function(e,t){return e.style.cssText=t+""}}),b.support.optSelected||(b.propHooks.selected=b.extend(b.propHooks.selected,{get:function(e){var t=e.parentNode;return t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex),null}})),b.support.enctype||(b.propFix.enctype="encoding"),b.support.checkOn||b.each(["radio","checkbox"],function(){b.valHooks[this]={get:function(e){return null===e.getAttribute("value")?"on":e.value}}}),b.each(["radio","checkbox"],function(){b.valHooks[this]=b.extend(b.valHooks[this],{set:function(e,n){return b.isArray(n)?e.checked=b.inArray(b(e).val(),n)>=0:t}})});var Z=/^(?:input|select|textarea)$/i,et=/^key/,tt=/^(?:mouse|contextmenu)|click/,nt=/^(?:focusinfocus|focusoutblur)$/,rt=/^([^.]*)(?:\.(.+)|)$/;function it(){return!0}function ot(){return!1}b.event={global:{},add:function(e,n,r,o,a){var s,u,l,c,p,f,d,h,g,m,y,v=b._data(e);if(v){r.handler&&(c=r,r=c.handler,a=c.selector),r.guid||(r.guid=b.guid++),(u=v.events)||(u=v.events={}),(f=v.handle)||(f=v.handle=function(e){return typeof b===i||e&&b.event.triggered===e.type?t:b.event.dispatch.apply(f.elem,arguments)},f.elem=e),n=(n||"").match(w)||[""],l=n.length;while(l--)s=rt.exec(n[l])||[],g=y=s[1],m=(s[2]||"").split(".").sort(),p=b.event.special[g]||{},g=(a?p.delegateType:p.bindType)||g,p=b.event.special[g]||{},d=b.extend({type:g,origType:y,data:o,handler:r,guid:r.guid,selector:a,needsContext:a&&b.expr.match.needsContext.test(a),namespace:m.join(".")},c),(h=u[g])||(h=u[g]=[],h.delegateCount=0,p.setup&&p.setup.call(e,o,m,f)!==!1||(e.addEventListener?e.addEventListener(g,f,!1):e.attachEvent&&e.attachEvent("on"+g,f))),p.add&&(p.add.call(e,d),d.handler.guid||(d.handler.guid=r.guid)),a?h.splice(h.delegateCount++,0,d):h.push(d),b.event.global[g]=!0;e=null}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,p,f,d,h,g,m=b.hasData(e)&&b._data(e);if(m&&(c=m.events)){t=(t||"").match(w)||[""],l=t.length;while(l--)if(s=rt.exec(t[l])||[],d=g=s[1],h=(s[2]||"").split(".").sort(),d){p=b.event.special[d]||{},d=(r?p.delegateType:p.bindType)||d,f=c[d]||[],s=s[2]&&RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),u=o=f.length;while(o--)a=f[o],!i&&g!==a.origType||n&&n.guid!==a.guid||s&&!s.test(a.namespace)||r&&r!==a.selector&&("**"!==r||!a.selector)||(f.splice(o,1),a.selector&&f.delegateCount--,p.remove&&p.remove.call(e,a));u&&!f.length&&(p.teardown&&p.teardown.call(e,h,m.handle)!==!1||b.removeEvent(e,d,m.handle),delete c[d])}else for(d in c)b.event.remove(e,d+t[l],n,r,!0);b.isEmptyObject(c)&&(delete m.handle,b._removeData(e,"events"))}},trigger:function(n,r,i,a){var s,u,l,c,p,f,d,h=[i||o],g=y.call(n,"type")?n.type:n,m=y.call(n,"namespace")?n.namespace.split("."):[];if(l=f=i=i||o,3!==i.nodeType&&8!==i.nodeType&&!nt.test(g+b.event.triggered)&&(g.indexOf(".")>=0&&(m=g.split("."),g=m.shift(),m.sort()),u=0>g.indexOf(":")&&"on"+g,n=n[b.expando]?n:new b.Event(g,"object"==typeof n&&n),n.isTrigger=!0,n.namespace=m.join("."),n.namespace_re=n.namespace?RegExp("(^|\\.)"+m.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,n.result=t,n.target||(n.target=i),r=null==r?[n]:b.makeArray(r,[n]),p=b.event.special[g]||{},a||!p.trigger||p.trigger.apply(i,r)!==!1)){if(!a&&!p.noBubble&&!b.isWindow(i)){for(c=p.delegateType||g,nt.test(c+g)||(l=l.parentNode);l;l=l.parentNode)h.push(l),f=l;f===(i.ownerDocument||o)&&h.push(f.defaultView||f.parentWindow||e)}d=0;while((l=h[d++])&&!n.isPropagationStopped())n.type=d>1?c:p.bindType||g,s=(b._data(l,"events")||{})[n.type]&&b._data(l,"handle"),s&&s.apply(l,r),s=u&&l[u],s&&b.acceptData(l)&&s.apply&&s.apply(l,r)===!1&&n.preventDefault();if(n.type=g,!(a||n.isDefaultPrevented()||p._default&&p._default.apply(i.ownerDocument,r)!==!1||"click"===g&&b.nodeName(i,"a")||!b.acceptData(i)||!u||!i[g]||b.isWindow(i))){f=i[u],f&&(i[u]=null),b.event.triggered=g;try{i[g]()}catch(v){}b.event.triggered=t,f&&(i[u]=f)}return n.result}},dispatch:function(e){e=b.event.fix(e);var n,r,i,o,a,s=[],u=h.call(arguments),l=(b._data(this,"events")||{})[e.type]||[],c=b.event.special[e.type]||{};if(u[0]=e,e.delegateTarget=this,!c.preDispatch||c.preDispatch.call(this,e)!==!1){s=b.event.handlers.call(this,e,l),n=0;while((o=s[n++])&&!e.isPropagationStopped()){e.currentTarget=o.elem,a=0;while((i=o.handlers[a++])&&!e.isImmediatePropagationStopped())(!e.namespace_re||e.namespace_re.test(i.namespace))&&(e.handleObj=i,e.data=i.data,r=((b.event.special[i.origType]||{}).handle||i.handler).apply(o.elem,u),r!==t&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,e),e.result}},handlers:function(e,n){var r,i,o,a,s=[],u=n.delegateCount,l=e.target;if(u&&l.nodeType&&(!e.button||"click"!==e.type))for(;l!=this;l=l.parentNode||this)if(1===l.nodeType&&(l.disabled!==!0||"click"!==e.type)){for(o=[],a=0;u>a;a++)i=n[a],r=i.selector+" ",o[r]===t&&(o[r]=i.needsContext?b(r,this).index(l)>=0:b.find(r,this,null,[l]).length),o[r]&&o.push(i);o.length&&s.push({elem:l,handlers:o})}return n.length>u&&s.push({elem:this,handlers:n.slice(u)}),s},fix:function(e){if(e[b.expando])return e;var t,n,r,i=e.type,a=e,s=this.fixHooks[i];s||(this.fixHooks[i]=s=tt.test(i)?this.mouseHooks:et.test(i)?this.keyHooks:{}),r=s.props?this.props.concat(s.props):this.props,e=new b.Event(a),t=r.length;while(t--)n=r[t],e[n]=a[n];return e.target||(e.target=a.srcElement||o),3===e.target.nodeType&&(e.target=e.target.parentNode),e.metaKey=!!e.metaKey,s.filter?s.filter(e,a):e},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,n){var r,i,a,s=n.button,u=n.fromElement;return null==e.pageX&&null!=n.clientX&&(i=e.target.ownerDocument||o,a=i.documentElement,r=i.body,e.pageX=n.clientX+(a&&a.scrollLeft||r&&r.scrollLeft||0)-(a&&a.clientLeft||r&&r.clientLeft||0),e.pageY=n.clientY+(a&&a.scrollTop||r&&r.scrollTop||0)-(a&&a.clientTop||r&&r.clientTop||0)),!e.relatedTarget&&u&&(e.relatedTarget=u===e.target?n.toElement:u),e.which||s===t||(e.which=1&s?1:2&s?3:4&s?2:0),e}},special:{load:{noBubble:!0},click:{trigger:function(){return b.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):t}},focus:{trigger:function(){if(this!==o.activeElement&&this.focus)try{return this.focus(),!1}catch(e){}},delegateType:"focusin"},blur:{trigger:function(){return this===o.activeElement&&this.blur?(this.blur(),!1):t},delegateType:"focusout"},beforeunload:{postDispatch:function(e){e.result!==t&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=b.extend(new b.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?b.event.trigger(i,null,t):b.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},b.removeEvent=o.removeEventListener?function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}:function(e,t,n){var r="on"+t;e.detachEvent&&(typeof e[r]===i&&(e[r]=null),e.detachEvent(r,n))},b.Event=function(e,n){return this instanceof b.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.returnValue===!1||e.getPreventDefault&&e.getPreventDefault()?it:ot):this.type=e,n&&b.extend(this,n),this.timeStamp=e&&e.timeStamp||b.now(),this[b.expando]=!0,t):new b.Event(e,n)},b.Event.prototype={isDefaultPrevented:ot,isPropagationStopped:ot,isImmediatePropagationStopped:ot,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=it,e&&(e.preventDefault?e.preventDefault():e.returnValue=!1)},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=it,e&&(e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=it,this.stopPropagation()}},b.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){b.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;
return(!i||i!==r&&!b.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),b.support.submitBubbles||(b.event.special.submit={setup:function(){return b.nodeName(this,"form")?!1:(b.event.add(this,"click._submit keypress._submit",function(e){var n=e.target,r=b.nodeName(n,"input")||b.nodeName(n,"button")?n.form:t;r&&!b._data(r,"submitBubbles")&&(b.event.add(r,"submit._submit",function(e){e._submit_bubble=!0}),b._data(r,"submitBubbles",!0))}),t)},postDispatch:function(e){e._submit_bubble&&(delete e._submit_bubble,this.parentNode&&!e.isTrigger&&b.event.simulate("submit",this.parentNode,e,!0))},teardown:function(){return b.nodeName(this,"form")?!1:(b.event.remove(this,"._submit"),t)}}),b.support.changeBubbles||(b.event.special.change={setup:function(){return Z.test(this.nodeName)?(("checkbox"===this.type||"radio"===this.type)&&(b.event.add(this,"propertychange._change",function(e){"checked"===e.originalEvent.propertyName&&(this._just_changed=!0)}),b.event.add(this,"click._change",function(e){this._just_changed&&!e.isTrigger&&(this._just_changed=!1),b.event.simulate("change",this,e,!0)})),!1):(b.event.add(this,"beforeactivate._change",function(e){var t=e.target;Z.test(t.nodeName)&&!b._data(t,"changeBubbles")&&(b.event.add(t,"change._change",function(e){!this.parentNode||e.isSimulated||e.isTrigger||b.event.simulate("change",this.parentNode,e,!0)}),b._data(t,"changeBubbles",!0))}),t)},handle:function(e){var n=e.target;return this!==n||e.isSimulated||e.isTrigger||"radio"!==n.type&&"checkbox"!==n.type?e.handleObj.handler.apply(this,arguments):t},teardown:function(){return b.event.remove(this,"._change"),!Z.test(this.nodeName)}}),b.support.focusinBubbles||b.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){b.event.simulate(t,e.target,b.event.fix(e),!0)};b.event.special[t]={setup:function(){0===n++&&o.addEventListener(e,r,!0)},teardown:function(){0===--n&&o.removeEventListener(e,r,!0)}}}),b.fn.extend({on:function(e,n,r,i,o){var a,s;if("object"==typeof e){"string"!=typeof n&&(r=r||n,n=t);for(a in e)this.on(a,n,r,e[a],o);return this}if(null==r&&null==i?(i=n,r=n=t):null==i&&("string"==typeof n?(i=r,r=t):(i=r,r=n,n=t)),i===!1)i=ot;else if(!i)return this;return 1===o&&(s=i,i=function(e){return b().off(e),s.apply(this,arguments)},i.guid=s.guid||(s.guid=b.guid++)),this.each(function(){b.event.add(this,e,i,r,n)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,n,r){var i,o;if(e&&e.preventDefault&&e.handleObj)return i=e.handleObj,b(e.delegateTarget).off(i.namespace?i.origType+"."+i.namespace:i.origType,i.selector,i.handler),this;if("object"==typeof e){for(o in e)this.off(o,n,e[o]);return this}return(n===!1||"function"==typeof n)&&(r=n,n=t),r===!1&&(r=ot),this.each(function(){b.event.remove(this,e,r,n)})},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},trigger:function(e,t){return this.each(function(){b.event.trigger(e,t,this)})},triggerHandler:function(e,n){var r=this[0];return r?b.event.trigger(e,n,r,!0):t}}),function(e,t){var n,r,i,o,a,s,u,l,c,p,f,d,h,g,m,y,v,x="sizzle"+-new Date,w=e.document,T={},N=0,C=0,k=it(),E=it(),S=it(),A=typeof t,j=1<<31,D=[],L=D.pop,H=D.push,q=D.slice,M=D.indexOf||function(e){var t=0,n=this.length;for(;n>t;t++)if(this[t]===e)return t;return-1},_="[\\x20\\t\\r\\n\\f]",F="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",O=F.replace("w","w#"),B="([*^$|!~]?=)",P="\\["+_+"*("+F+")"+_+"*(?:"+B+_+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+O+")|)|)"+_+"*\\]",R=":("+F+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+P.replace(3,8)+")*)|.*)\\)|)",W=RegExp("^"+_+"+|((?:^|[^\\\\])(?:\\\\.)*)"+_+"+$","g"),$=RegExp("^"+_+"*,"+_+"*"),I=RegExp("^"+_+"*([\\x20\\t\\r\\n\\f>+~])"+_+"*"),z=RegExp(R),X=RegExp("^"+O+"$"),U={ID:RegExp("^#("+F+")"),CLASS:RegExp("^\\.("+F+")"),NAME:RegExp("^\\[name=['\"]?("+F+")['\"]?\\]"),TAG:RegExp("^("+F.replace("w","w*")+")"),ATTR:RegExp("^"+P),PSEUDO:RegExp("^"+R),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+_+"*(even|odd|(([+-]|)(\\d*)n|)"+_+"*(?:([+-]|)"+_+"*(\\d+)|))"+_+"*\\)|)","i"),needsContext:RegExp("^"+_+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+_+"*((?:-\\d)?\\d*)"+_+"*\\)|)(?=[^-]|$)","i")},V=/[\x20\t\r\n\f]*[+~]/,Y=/^[^{]+\{\s*\[native code/,J=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,G=/^(?:input|select|textarea|button)$/i,Q=/^h\d$/i,K=/'|\\/g,Z=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,et=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,tt=function(e,t){var n="0x"+t-65536;return n!==n?t:0>n?String.fromCharCode(n+65536):String.fromCharCode(55296|n>>10,56320|1023&n)};try{q.call(w.documentElement.childNodes,0)[0].nodeType}catch(nt){q=function(e){var t,n=[];while(t=this[e++])n.push(t);return n}}function rt(e){return Y.test(e+"")}function it(){var e,t=[];return e=function(n,r){return t.push(n+=" ")>i.cacheLength&&delete e[t.shift()],e[n]=r}}function ot(e){return e[x]=!0,e}function at(e){var t=p.createElement("div");try{return e(t)}catch(n){return!1}finally{t=null}}function st(e,t,n,r){var i,o,a,s,u,l,f,g,m,v;if((t?t.ownerDocument||t:w)!==p&&c(t),t=t||p,n=n||[],!e||"string"!=typeof e)return n;if(1!==(s=t.nodeType)&&9!==s)return[];if(!d&&!r){if(i=J.exec(e))if(a=i[1]){if(9===s){if(o=t.getElementById(a),!o||!o.parentNode)return n;if(o.id===a)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(a))&&y(t,o)&&o.id===a)return n.push(o),n}else{if(i[2])return H.apply(n,q.call(t.getElementsByTagName(e),0)),n;if((a=i[3])&&T.getByClassName&&t.getElementsByClassName)return H.apply(n,q.call(t.getElementsByClassName(a),0)),n}if(T.qsa&&!h.test(e)){if(f=!0,g=x,m=t,v=9===s&&e,1===s&&"object"!==t.nodeName.toLowerCase()){l=ft(e),(f=t.getAttribute("id"))?g=f.replace(K,"\\$&"):t.setAttribute("id",g),g="[id='"+g+"'] ",u=l.length;while(u--)l[u]=g+dt(l[u]);m=V.test(e)&&t.parentNode||t,v=l.join(",")}if(v)try{return H.apply(n,q.call(m.querySelectorAll(v),0)),n}catch(b){}finally{f||t.removeAttribute("id")}}}return wt(e.replace(W,"$1"),t,n,r)}a=st.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},c=st.setDocument=function(e){var n=e?e.ownerDocument||e:w;return n!==p&&9===n.nodeType&&n.documentElement?(p=n,f=n.documentElement,d=a(n),T.tagNameNoComments=at(function(e){return e.appendChild(n.createComment("")),!e.getElementsByTagName("*").length}),T.attributes=at(function(e){e.innerHTML="<select></select>";var t=typeof e.lastChild.getAttribute("multiple");return"boolean"!==t&&"string"!==t}),T.getByClassName=at(function(e){return e.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",e.getElementsByClassName&&e.getElementsByClassName("e").length?(e.lastChild.className="e",2===e.getElementsByClassName("e").length):!1}),T.getByName=at(function(e){e.id=x+0,e.innerHTML="<a name='"+x+"'></a><div name='"+x+"'></div>",f.insertBefore(e,f.firstChild);var t=n.getElementsByName&&n.getElementsByName(x).length===2+n.getElementsByName(x+0).length;return T.getIdNotName=!n.getElementById(x),f.removeChild(e),t}),i.attrHandle=at(function(e){return e.innerHTML="<a href='#'></a>",e.firstChild&&typeof e.firstChild.getAttribute!==A&&"#"===e.firstChild.getAttribute("href")})?{}:{href:function(e){return e.getAttribute("href",2)},type:function(e){return e.getAttribute("type")}},T.getIdNotName?(i.find.ID=function(e,t){if(typeof t.getElementById!==A&&!d){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){return e.getAttribute("id")===t}}):(i.find.ID=function(e,n){if(typeof n.getElementById!==A&&!d){var r=n.getElementById(e);return r?r.id===e||typeof r.getAttributeNode!==A&&r.getAttributeNode("id").value===e?[r]:t:[]}},i.filter.ID=function(e){var t=e.replace(et,tt);return function(e){var n=typeof e.getAttributeNode!==A&&e.getAttributeNode("id");return n&&n.value===t}}),i.find.TAG=T.tagNameNoComments?function(e,n){return typeof n.getElementsByTagName!==A?n.getElementsByTagName(e):t}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},i.find.NAME=T.getByName&&function(e,n){return typeof n.getElementsByName!==A?n.getElementsByName(name):t},i.find.CLASS=T.getByClassName&&function(e,n){return typeof n.getElementsByClassName===A||d?t:n.getElementsByClassName(e)},g=[],h=[":focus"],(T.qsa=rt(n.querySelectorAll))&&(at(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||h.push("\\["+_+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),e.querySelectorAll(":checked").length||h.push(":checked")}),at(function(e){e.innerHTML="<input type='hidden' i=''/>",e.querySelectorAll("[i^='']").length&&h.push("[*^$]="+_+"*(?:\"\"|'')"),e.querySelectorAll(":enabled").length||h.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),h.push(",.*:")})),(T.matchesSelector=rt(m=f.matchesSelector||f.mozMatchesSelector||f.webkitMatchesSelector||f.oMatchesSelector||f.msMatchesSelector))&&at(function(e){T.disconnectedMatch=m.call(e,"div"),m.call(e,"[s!='']:x"),g.push("!=",R)}),h=RegExp(h.join("|")),g=RegExp(g.join("|")),y=rt(f.contains)||f.compareDocumentPosition?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},v=f.compareDocumentPosition?function(e,t){var r;return e===t?(u=!0,0):(r=t.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(t))?1&r||e.parentNode&&11===e.parentNode.nodeType?e===n||y(w,e)?-1:t===n||y(w,t)?1:0:4&r?-1:1:e.compareDocumentPosition?-1:1}:function(e,t){var r,i=0,o=e.parentNode,a=t.parentNode,s=[e],l=[t];if(e===t)return u=!0,0;if(!o||!a)return e===n?-1:t===n?1:o?-1:a?1:0;if(o===a)return ut(e,t);r=e;while(r=r.parentNode)s.unshift(r);r=t;while(r=r.parentNode)l.unshift(r);while(s[i]===l[i])i++;return i?ut(s[i],l[i]):s[i]===w?-1:l[i]===w?1:0},u=!1,[0,0].sort(v),T.detectDuplicates=u,p):p},st.matches=function(e,t){return st(e,null,null,t)},st.matchesSelector=function(e,t){if((e.ownerDocument||e)!==p&&c(e),t=t.replace(Z,"='$1']"),!(!T.matchesSelector||d||g&&g.test(t)||h.test(t)))try{var n=m.call(e,t);if(n||T.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(r){}return st(t,p,null,[e]).length>0},st.contains=function(e,t){return(e.ownerDocument||e)!==p&&c(e),y(e,t)},st.attr=function(e,t){var n;return(e.ownerDocument||e)!==p&&c(e),d||(t=t.toLowerCase()),(n=i.attrHandle[t])?n(e):d||T.attributes?e.getAttribute(t):((n=e.getAttributeNode(t))||e.getAttribute(t))&&e[t]===!0?t:n&&n.specified?n.value:null},st.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},st.uniqueSort=function(e){var t,n=[],r=1,i=0;if(u=!T.detectDuplicates,e.sort(v),u){for(;t=e[r];r++)t===e[r-1]&&(i=n.push(r));while(i--)e.splice(n[i],1)}return e};function ut(e,t){var n=t&&e,r=n&&(~t.sourceIndex||j)-(~e.sourceIndex||j);if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function lt(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function ct(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function pt(e){return ot(function(t){return t=+t,ot(function(n,r){var i,o=e([],n.length,t),a=o.length;while(a--)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}o=st.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r];r++)n+=o(t);return n},i=st.selectors={cacheLength:50,createPseudo:ot,match:U,find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(et,tt),e[3]=(e[4]||e[5]||"").replace(et,tt),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||st.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&st.error(e[0]),e},PSEUDO:function(e){var t,n=!e[5]&&e[2];return U.CHILD.test(e[0])?null:(e[4]?e[2]=e[4]:n&&z.test(n)&&(t=ft(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){return"*"===e?function(){return!0}:(e=e.replace(et,tt).toLowerCase(),function(t){return t.nodeName&&t.nodeName.toLowerCase()===e})},CLASS:function(e){var t=k[e+" "];return t||(t=RegExp("(^|"+_+")"+e+"("+_+"|$)"))&&k(e,function(e){return t.test(e.className||typeof e.getAttribute!==A&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=st.attr(r,e);return null==i?"!="===t:t?(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i+" ").indexOf(n)>-1:"|="===t?i===n||i.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,p,f,d,h,g=o!==a?"nextSibling":"previousSibling",m=t.parentNode,y=s&&t.nodeName.toLowerCase(),v=!u&&!s;if(m){if(o){while(g){p=t;while(p=p[g])if(s?p.nodeName.toLowerCase()===y:1===p.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?m.firstChild:m.lastChild],a&&v){c=m[x]||(m[x]={}),l=c[e]||[],d=l[0]===N&&l[1],f=l[0]===N&&l[2],p=d&&m.childNodes[d];while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if(1===p.nodeType&&++f&&p===t){c[e]=[N,d,f];break}}else if(v&&(l=(t[x]||(t[x]={}))[e])&&l[0]===N)f=l[1];else while(p=++d&&p&&p[g]||(f=d=0)||h.pop())if((s?p.nodeName.toLowerCase()===y:1===p.nodeType)&&++f&&(v&&((p[x]||(p[x]={}))[e]=[N,f]),p===t))break;return f-=i,f===r||0===f%r&&f/r>=0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||st.error("unsupported pseudo: "+e);return r[x]?r(t):r.length>1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?ot(function(e,n){var i,o=r(e,t),a=o.length;while(a--)i=M.call(e,o[a]),e[i]=!(n[i]=o[a])}):function(e){return r(e,0,n)}):r}},pseudos:{not:ot(function(e){var t=[],n=[],r=s(e.replace(W,"$1"));return r[x]?ot(function(e,t,n,i){var o,a=r(e,null,i,[]),s=e.length;while(s--)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:ot(function(e){return function(t){return st(e,t).length>0}}),contains:ot(function(e){return function(t){return(t.textContent||t.innerText||o(t)).indexOf(e)>-1}}),lang:ot(function(e){return X.test(e||"")||st.error("unsupported lang: "+e),e=e.replace(et,tt).toLowerCase(),function(t){var n;do if(n=d?t.getAttribute("xml:lang")||t.getAttribute("lang"):t.lang)return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===f},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!i.pseudos.empty(e)},header:function(e){return Q.test(e.nodeName)},input:function(e){return G.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:pt(function(){return[0]}),last:pt(function(e,t){return[t-1]}),eq:pt(function(e,t,n){return[0>n?n+t:n]}),even:pt(function(e,t){var n=0;for(;t>n;n+=2)e.push(n);return e}),odd:pt(function(e,t){var n=1;for(;t>n;n+=2)e.push(n);return e}),lt:pt(function(e,t,n){var r=0>n?n+t:n;for(;--r>=0;)e.push(r);return e}),gt:pt(function(e,t,n){var r=0>n?n+t:n;for(;t>++r;)e.push(r);return e})}};for(n in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})i.pseudos[n]=lt(n);for(n in{submit:!0,reset:!0})i.pseudos[n]=ct(n);function ft(e,t){var n,r,o,a,s,u,l,c=E[e+" "];if(c)return t?0:c.slice(0);s=e,u=[],l=i.preFilter;while(s){(!n||(r=$.exec(s)))&&(r&&(s=s.slice(r[0].length)||s),u.push(o=[])),n=!1,(r=I.exec(s))&&(n=r.shift(),o.push({value:n,type:r[0].replace(W," ")}),s=s.slice(n.length));for(a in i.filter)!(r=U[a].exec(s))||l[a]&&!(r=l[a](r))||(n=r.shift(),o.push({value:n,type:a,matches:r}),s=s.slice(n.length));if(!n)break}return t?s.length:s?st.error(e):E(e,u).slice(0)}function dt(e){var t=0,n=e.length,r="";for(;n>t;t++)r+=e[t].value;return r}function ht(e,t,n){var i=t.dir,o=n&&"parentNode"===i,a=C++;return t.first?function(t,n,r){while(t=t[i])if(1===t.nodeType||o)return e(t,n,r)}:function(t,n,s){var u,l,c,p=N+" "+a;if(s){while(t=t[i])if((1===t.nodeType||o)&&e(t,n,s))return!0}else while(t=t[i])if(1===t.nodeType||o)if(c=t[x]||(t[x]={}),(l=c[i])&&l[0]===p){if((u=l[1])===!0||u===r)return u===!0}else if(l=c[i]=[p],l[1]=e(t,n,s)||r,l[1]===!0)return!0}}function gt(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function mt(e,t,n,r,i){var o,a=[],s=0,u=e.length,l=null!=t;for(;u>s;s++)(o=e[s])&&(!n||n(o,r,i))&&(a.push(o),l&&t.push(s));return a}function yt(e,t,n,r,i,o){return r&&!r[x]&&(r=yt(r)),i&&!i[x]&&(i=yt(i,o)),ot(function(o,a,s,u){var l,c,p,f=[],d=[],h=a.length,g=o||xt(t||"*",s.nodeType?[s]:s,[]),m=!e||!o&&t?g:mt(g,f,e,s,u),y=n?i||(o?e:h||r)?[]:a:m;if(n&&n(m,y,s,u),r){l=mt(y,d),r(l,[],s,u),c=l.length;while(c--)(p=l[c])&&(y[d[c]]=!(m[d[c]]=p))}if(o){if(i||e){if(i){l=[],c=y.length;while(c--)(p=y[c])&&l.push(m[c]=p);i(null,y=[],l,u)}c=y.length;while(c--)(p=y[c])&&(l=i?M.call(o,p):f[c])>-1&&(o[l]=!(a[l]=p))}}else y=mt(y===a?y.splice(h,y.length):y),i?i(null,a,y,u):H.apply(a,y)})}function vt(e){var t,n,r,o=e.length,a=i.relative[e[0].type],s=a||i.relative[" "],u=a?1:0,c=ht(function(e){return e===t},s,!0),p=ht(function(e){return M.call(t,e)>-1},s,!0),f=[function(e,n,r){return!a&&(r||n!==l)||((t=n).nodeType?c(e,n,r):p(e,n,r))}];for(;o>u;u++)if(n=i.relative[e[u].type])f=[ht(gt(f),n)];else{if(n=i.filter[e[u].type].apply(null,e[u].matches),n[x]){for(r=++u;o>r;r++)if(i.relative[e[r].type])break;return yt(u>1&&gt(f),u>1&&dt(e.slice(0,u-1)).replace(W,"$1"),n,r>u&&vt(e.slice(u,r)),o>r&&vt(e=e.slice(r)),o>r&&dt(e))}f.push(n)}return gt(f)}function bt(e,t){var n=0,o=t.length>0,a=e.length>0,s=function(s,u,c,f,d){var h,g,m,y=[],v=0,b="0",x=s&&[],w=null!=d,T=l,C=s||a&&i.find.TAG("*",d&&u.parentNode||u),k=N+=null==T?1:Math.random()||.1;for(w&&(l=u!==p&&u,r=n);null!=(h=C[b]);b++){if(a&&h){g=0;while(m=e[g++])if(m(h,u,c)){f.push(h);break}w&&(N=k,r=++n)}o&&((h=!m&&h)&&v--,s&&x.push(h))}if(v+=b,o&&b!==v){g=0;while(m=t[g++])m(x,y,u,c);if(s){if(v>0)while(b--)x[b]||y[b]||(y[b]=L.call(f));y=mt(y)}H.apply(f,y),w&&!s&&y.length>0&&v+t.length>1&&st.uniqueSort(f)}return w&&(N=k,l=T),x};return o?ot(s):s}s=st.compile=function(e,t){var n,r=[],i=[],o=S[e+" "];if(!o){t||(t=ft(e)),n=t.length;while(n--)o=vt(t[n]),o[x]?r.push(o):i.push(o);o=S(e,bt(i,r))}return o};function xt(e,t,n){var r=0,i=t.length;for(;i>r;r++)st(e,t[r],n);return n}function wt(e,t,n,r){var o,a,u,l,c,p=ft(e);if(!r&&1===p.length){if(a=p[0]=p[0].slice(0),a.length>2&&"ID"===(u=a[0]).type&&9===t.nodeType&&!d&&i.relative[a[1].type]){if(t=i.find.ID(u.matches[0].replace(et,tt),t)[0],!t)return n;e=e.slice(a.shift().value.length)}o=U.needsContext.test(e)?0:a.length;while(o--){if(u=a[o],i.relative[l=u.type])break;if((c=i.find[l])&&(r=c(u.matches[0].replace(et,tt),V.test(a[0].type)&&t.parentNode||t))){if(a.splice(o,1),e=r.length&&dt(a),!e)return H.apply(n,q.call(r,0)),n;break}}}return s(e,p)(r,t,d,n,V.test(e)),n}i.pseudos.nth=i.pseudos.eq;function Tt(){}i.filters=Tt.prototype=i.pseudos,i.setFilters=new Tt,c(),st.attr=b.attr,b.find=st,b.expr=st.selectors,b.expr[":"]=b.expr.pseudos,b.unique=st.uniqueSort,b.text=st.getText,b.isXMLDoc=st.isXML,b.contains=st.contains}(e);var at=/Until$/,st=/^(?:parents|prev(?:Until|All))/,ut=/^.[^:#\[\.,]*$/,lt=b.expr.match.needsContext,ct={children:!0,contents:!0,next:!0,prev:!0};b.fn.extend({find:function(e){var t,n,r,i=this.length;if("string"!=typeof e)return r=this,this.pushStack(b(e).filter(function(){for(t=0;i>t;t++)if(b.contains(r[t],this))return!0}));for(n=[],t=0;i>t;t++)b.find(e,this[t],n);return n=this.pushStack(i>1?b.unique(n):n),n.selector=(this.selector?this.selector+" ":"")+e,n},has:function(e){var t,n=b(e,this),r=n.length;return this.filter(function(){for(t=0;r>t;t++)if(b.contains(this,n[t]))return!0})},not:function(e){return this.pushStack(ft(this,e,!1))},filter:function(e){return this.pushStack(ft(this,e,!0))},is:function(e){return!!e&&("string"==typeof e?lt.test(e)?b(e,this.context).index(this[0])>=0:b.filter(e,this).length>0:this.filter(e).length>0)},closest:function(e,t){var n,r=0,i=this.length,o=[],a=lt.test(e)||"string"!=typeof e?b(e,t||this.context):0;for(;i>r;r++){n=this[r];while(n&&n.ownerDocument&&n!==t&&11!==n.nodeType){if(a?a.index(n)>-1:b.find.matchesSelector(n,e)){o.push(n);break}n=n.parentNode}}return this.pushStack(o.length>1?b.unique(o):o)},index:function(e){return e?"string"==typeof e?b.inArray(this[0],b(e)):b.inArray(e.jquery?e[0]:e,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var n="string"==typeof e?b(e,t):b.makeArray(e&&e.nodeType?[e]:e),r=b.merge(this.get(),n);return this.pushStack(b.unique(r))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),b.fn.andSelf=b.fn.addBack;function pt(e,t){do e=e[t];while(e&&1!==e.nodeType);return e}b.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return b.dir(e,"parentNode")},parentsUntil:function(e,t,n){return b.dir(e,"parentNode",n)},next:function(e){return pt(e,"nextSibling")},prev:function(e){return pt(e,"previousSibling")},nextAll:function(e){return b.dir(e,"nextSibling")},prevAll:function(e){return b.dir(e,"previousSibling")},nextUntil:function(e,t,n){return b.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return b.dir(e,"previousSibling",n)},siblings:function(e){return b.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return b.sibling(e.firstChild)},contents:function(e){return b.nodeName(e,"iframe")?e.contentDocument||e.contentWindow.document:b.merge([],e.childNodes)}},function(e,t){b.fn[e]=function(n,r){var i=b.map(this,t,n);return at.test(e)||(r=n),r&&"string"==typeof r&&(i=b.filter(r,i)),i=this.length>1&&!ct[e]?b.unique(i):i,this.length>1&&st.test(e)&&(i=i.reverse()),this.pushStack(i)}}),b.extend({filter:function(e,t,n){return n&&(e=":not("+e+")"),1===t.length?b.find.matchesSelector(t[0],e)?[t[0]]:[]:b.find.matches(e,t)},dir:function(e,n,r){var i=[],o=e[n];while(o&&9!==o.nodeType&&(r===t||1!==o.nodeType||!b(o).is(r)))1===o.nodeType&&i.push(o),o=o[n];return i},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}});function ft(e,t,n){if(t=t||0,b.isFunction(t))return b.grep(e,function(e,r){var i=!!t.call(e,r,e);return i===n});if(t.nodeType)return b.grep(e,function(e){return e===t===n});if("string"==typeof t){var r=b.grep(e,function(e){return 1===e.nodeType});if(ut.test(t))return b.filter(t,r,!n);t=b.filter(t,r)}return b.grep(e,function(e){return b.inArray(e,t)>=0===n})}function dt(e){var t=ht.split("|"),n=e.createDocumentFragment();if(n.createElement)while(t.length)n.createElement(t.pop());return n}var ht="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",gt=/ jQuery\d+="(?:null|\d+)"/g,mt=RegExp("<(?:"+ht+")[\\s/>]","i"),yt=/^\s+/,vt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bt=/<([\w:]+)/,xt=/<tbody/i,wt=/<|&#?\w+;/,Tt=/<(?:script|style|link)/i,Nt=/^(?:checkbox|radio)$/i,Ct=/checked\s*(?:[^=]|=\s*.checked.)/i,kt=/^$|\/(?:java|ecma)script/i,Et=/^true\/(.*)/,St=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,At={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:b.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},jt=dt(o),Dt=jt.appendChild(o.createElement("div"));At.optgroup=At.option,At.tbody=At.tfoot=At.colgroup=At.caption=At.thead,At.th=At.td,b.fn.extend({text:function(e){return b.access(this,function(e){return e===t?b.text(this):this.empty().append((this[0]&&this[0].ownerDocument||o).createTextNode(e))},null,e,arguments.length)},wrapAll:function(e){if(b.isFunction(e))return this.each(function(t){b(this).wrapAll(e.call(this,t))});if(this[0]){var t=b(e,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstChild&&1===e.firstChild.nodeType)e=e.firstChild;return e}).append(this)}return this},wrapInner:function(e){return b.isFunction(e)?this.each(function(t){b(this).wrapInner(e.call(this,t))}):this.each(function(){var t=b(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=b.isFunction(e);return this.each(function(n){b(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){b.nodeName(this,"body")||b(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.appendChild(e)})},prepend:function(){return this.domManip(arguments,!0,function(e){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&this.insertBefore(e,this.firstChild)})},before:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,!1,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){var n,r=0;for(;null!=(n=this[r]);r++)(!e||b.filter(e,[n]).length>0)&&(t||1!==n.nodeType||b.cleanData(Ot(n)),n.parentNode&&(t&&b.contains(n.ownerDocument,n)&&Mt(Ot(n,"script")),n.parentNode.removeChild(n)));return this},empty:function(){var e,t=0;for(;null!=(e=this[t]);t++){1===e.nodeType&&b.cleanData(Ot(e,!1));while(e.firstChild)e.removeChild(e.firstChild);e.options&&b.nodeName(e,"select")&&(e.options.length=0)}return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return b.clone(this,e,t)})},html:function(e){return b.access(this,function(e){var n=this[0]||{},r=0,i=this.length;if(e===t)return 1===n.nodeType?n.innerHTML.replace(gt,""):t;if(!("string"!=typeof e||Tt.test(e)||!b.support.htmlSerialize&&mt.test(e)||!b.support.leadingWhitespace&&yt.test(e)||At[(bt.exec(e)||["",""])[1].toLowerCase()])){e=e.replace(vt,"<$1></$2>");try{for(;i>r;r++)n=this[r]||{},1===n.nodeType&&(b.cleanData(Ot(n,!1)),n.innerHTML=e);n=0}catch(o){}}n&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(e){var t=b.isFunction(e);return t||"string"==typeof e||(e=b(e).not(this).detach()),this.domManip([e],!0,function(e){var t=this.nextSibling,n=this.parentNode;n&&(b(this).remove(),n.insertBefore(e,t))})},detach:function(e){return this.remove(e,!0)},domManip:function(e,n,r){e=f.apply([],e);var i,o,a,s,u,l,c=0,p=this.length,d=this,h=p-1,g=e[0],m=b.isFunction(g);if(m||!(1>=p||"string"!=typeof g||b.support.checkClone)&&Ct.test(g))return this.each(function(i){var o=d.eq(i);m&&(e[0]=g.call(this,i,n?o.html():t)),o.domManip(e,n,r)});if(p&&(l=b.buildFragment(e,this[0].ownerDocument,!1,this),i=l.firstChild,1===l.childNodes.length&&(l=i),i)){for(n=n&&b.nodeName(i,"tr"),s=b.map(Ot(l,"script"),Ht),a=s.length;p>c;c++)o=l,c!==h&&(o=b.clone(o,!0,!0),a&&b.merge(s,Ot(o,"script"))),r.call(n&&b.nodeName(this[c],"table")?Lt(this[c],"tbody"):this[c],o,c);if(a)for(u=s[s.length-1].ownerDocument,b.map(s,qt),c=0;a>c;c++)o=s[c],kt.test(o.type||"")&&!b._data(o,"globalEval")&&b.contains(u,o)&&(o.src?b.ajax({url:o.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):b.globalEval((o.text||o.textContent||o.innerHTML||"").replace(St,"")));l=i=null}return this}});function Lt(e,t){return e.getElementsByTagName(t)[0]||e.appendChild(e.ownerDocument.createElement(t))}function Ht(e){var t=e.getAttributeNode("type");return e.type=(t&&t.specified)+"/"+e.type,e}function qt(e){var t=Et.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function Mt(e,t){var n,r=0;for(;null!=(n=e[r]);r++)b._data(n,"globalEval",!t||b._data(t[r],"globalEval"))}function _t(e,t){if(1===t.nodeType&&b.hasData(e)){var n,r,i,o=b._data(e),a=b._data(t,o),s=o.events;if(s){delete a.handle,a.events={};for(n in s)for(r=0,i=s[n].length;i>r;r++)b.event.add(t,n,s[n][r])}a.data&&(a.data=b.extend({},a.data))}}function Ft(e,t){var n,r,i;if(1===t.nodeType){if(n=t.nodeName.toLowerCase(),!b.support.noCloneEvent&&t[b.expando]){i=b._data(t);for(r in i.events)b.removeEvent(t,r,i.handle);t.removeAttribute(b.expando)}"script"===n&&t.text!==e.text?(Ht(t).text=e.text,qt(t)):"object"===n?(t.parentNode&&(t.outerHTML=e.outerHTML),b.support.html5Clone&&e.innerHTML&&!b.trim(t.innerHTML)&&(t.innerHTML=e.innerHTML)):"input"===n&&Nt.test(e.type)?(t.defaultChecked=t.checked=e.checked,t.value!==e.value&&(t.value=e.value)):"option"===n?t.defaultSelected=t.selected=e.defaultSelected:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}}b.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){b.fn[e]=function(e){var n,r=0,i=[],o=b(e),a=o.length-1;for(;a>=r;r++)n=r===a?this:this.clone(!0),b(o[r])[t](n),d.apply(i,n.get());return this.pushStack(i)}});function Ot(e,n){var r,o,a=0,s=typeof e.getElementsByTagName!==i?e.getElementsByTagName(n||"*"):typeof e.querySelectorAll!==i?e.querySelectorAll(n||"*"):t;if(!s)for(s=[],r=e.childNodes||e;null!=(o=r[a]);a++)!n||b.nodeName(o,n)?s.push(o):b.merge(s,Ot(o,n));return n===t||n&&b.nodeName(e,n)?b.merge([e],s):s}function Bt(e){Nt.test(e.type)&&(e.defaultChecked=e.checked)}b.extend({clone:function(e,t,n){var r,i,o,a,s,u=b.contains(e.ownerDocument,e);if(b.support.html5Clone||b.isXMLDoc(e)||!mt.test("<"+e.nodeName+">")?o=e.cloneNode(!0):(Dt.innerHTML=e.outerHTML,Dt.removeChild(o=Dt.firstChild)),!(b.support.noCloneEvent&&b.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||b.isXMLDoc(e)))for(r=Ot(o),s=Ot(e),a=0;null!=(i=s[a]);++a)r[a]&&Ft(i,r[a]);if(t)if(n)for(s=s||Ot(e),r=r||Ot(o),a=0;null!=(i=s[a]);a++)_t(i,r[a]);else _t(e,o);return r=Ot(o,"script"),r.length>0&&Mt(r,!u&&Ot(e,"script")),r=s=i=null,o},buildFragment:function(e,t,n,r){var i,o,a,s,u,l,c,p=e.length,f=dt(t),d=[],h=0;for(;p>h;h++)if(o=e[h],o||0===o)if("object"===b.type(o))b.merge(d,o.nodeType?[o]:o);else if(wt.test(o)){s=s||f.appendChild(t.createElement("div")),u=(bt.exec(o)||["",""])[1].toLowerCase(),c=At[u]||At._default,s.innerHTML=c[1]+o.replace(vt,"<$1></$2>")+c[2],i=c[0];while(i--)s=s.lastChild;if(!b.support.leadingWhitespace&&yt.test(o)&&d.push(t.createTextNode(yt.exec(o)[0])),!b.support.tbody){o="table"!==u||xt.test(o)?"<table>"!==c[1]||xt.test(o)?0:s:s.firstChild,i=o&&o.childNodes.length;while(i--)b.nodeName(l=o.childNodes[i],"tbody")&&!l.childNodes.length&&o.removeChild(l)
}b.merge(d,s.childNodes),s.textContent="";while(s.firstChild)s.removeChild(s.firstChild);s=f.lastChild}else d.push(t.createTextNode(o));s&&f.removeChild(s),b.support.appendChecked||b.grep(Ot(d,"input"),Bt),h=0;while(o=d[h++])if((!r||-1===b.inArray(o,r))&&(a=b.contains(o.ownerDocument,o),s=Ot(f.appendChild(o),"script"),a&&Mt(s),n)){i=0;while(o=s[i++])kt.test(o.type||"")&&n.push(o)}return s=null,f},cleanData:function(e,t){var n,r,o,a,s=0,u=b.expando,l=b.cache,p=b.support.deleteExpando,f=b.event.special;for(;null!=(n=e[s]);s++)if((t||b.acceptData(n))&&(o=n[u],a=o&&l[o])){if(a.events)for(r in a.events)f[r]?b.event.remove(n,r):b.removeEvent(n,r,a.handle);l[o]&&(delete l[o],p?delete n[u]:typeof n.removeAttribute!==i?n.removeAttribute(u):n[u]=null,c.push(o))}}});var Pt,Rt,Wt,$t=/alpha\([^)]*\)/i,It=/opacity\s*=\s*([^)]*)/,zt=/^(top|right|bottom|left)$/,Xt=/^(none|table(?!-c[ea]).+)/,Ut=/^margin/,Vt=RegExp("^("+x+")(.*)$","i"),Yt=RegExp("^("+x+")(?!px)[a-z%]+$","i"),Jt=RegExp("^([+-])=("+x+")","i"),Gt={BODY:"block"},Qt={position:"absolute",visibility:"hidden",display:"block"},Kt={letterSpacing:0,fontWeight:400},Zt=["Top","Right","Bottom","Left"],en=["Webkit","O","Moz","ms"];function tn(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=en.length;while(i--)if(t=en[i]+n,t in e)return t;return r}function nn(e,t){return e=t||e,"none"===b.css(e,"display")||!b.contains(e.ownerDocument,e)}function rn(e,t){var n,r,i,o=[],a=0,s=e.length;for(;s>a;a++)r=e[a],r.style&&(o[a]=b._data(r,"olddisplay"),n=r.style.display,t?(o[a]||"none"!==n||(r.style.display=""),""===r.style.display&&nn(r)&&(o[a]=b._data(r,"olddisplay",un(r.nodeName)))):o[a]||(i=nn(r),(n&&"none"!==n||!i)&&b._data(r,"olddisplay",i?n:b.css(r,"display"))));for(a=0;s>a;a++)r=e[a],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[a]||"":"none"));return e}b.fn.extend({css:function(e,n){return b.access(this,function(e,n,r){var i,o,a={},s=0;if(b.isArray(n)){for(o=Rt(e),i=n.length;i>s;s++)a[n[s]]=b.css(e,n[s],!1,o);return a}return r!==t?b.style(e,n,r):b.css(e,n)},e,n,arguments.length>1)},show:function(){return rn(this,!0)},hide:function(){return rn(this)},toggle:function(e){var t="boolean"==typeof e;return this.each(function(){(t?e:nn(this))?b(this).show():b(this).hide()})}}),b.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Wt(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":b.support.cssFloat?"cssFloat":"styleFloat"},style:function(e,n,r,i){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var o,a,s,u=b.camelCase(n),l=e.style;if(n=b.cssProps[u]||(b.cssProps[u]=tn(l,u)),s=b.cssHooks[n]||b.cssHooks[u],r===t)return s&&"get"in s&&(o=s.get(e,!1,i))!==t?o:l[n];if(a=typeof r,"string"===a&&(o=Jt.exec(r))&&(r=(o[1]+1)*o[2]+parseFloat(b.css(e,n)),a="number"),!(null==r||"number"===a&&isNaN(r)||("number"!==a||b.cssNumber[u]||(r+="px"),b.support.clearCloneStyle||""!==r||0!==n.indexOf("background")||(l[n]="inherit"),s&&"set"in s&&(r=s.set(e,r,i))===t)))try{l[n]=r}catch(c){}}},css:function(e,n,r,i){var o,a,s,u=b.camelCase(n);return n=b.cssProps[u]||(b.cssProps[u]=tn(e.style,u)),s=b.cssHooks[n]||b.cssHooks[u],s&&"get"in s&&(a=s.get(e,!0,r)),a===t&&(a=Wt(e,n,i)),"normal"===a&&n in Kt&&(a=Kt[n]),""===r||r?(o=parseFloat(a),r===!0||b.isNumeric(o)?o||0:a):a},swap:function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i}}),e.getComputedStyle?(Rt=function(t){return e.getComputedStyle(t,null)},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s.getPropertyValue(n)||s[n]:t,l=e.style;return s&&(""!==u||b.contains(e.ownerDocument,e)||(u=b.style(e,n)),Yt.test(u)&&Ut.test(n)&&(i=l.width,o=l.minWidth,a=l.maxWidth,l.minWidth=l.maxWidth=l.width=u,u=s.width,l.width=i,l.minWidth=o,l.maxWidth=a)),u}):o.documentElement.currentStyle&&(Rt=function(e){return e.currentStyle},Wt=function(e,n,r){var i,o,a,s=r||Rt(e),u=s?s[n]:t,l=e.style;return null==u&&l&&l[n]&&(u=l[n]),Yt.test(u)&&!zt.test(n)&&(i=l.left,o=e.runtimeStyle,a=o&&o.left,a&&(o.left=e.currentStyle.left),l.left="fontSize"===n?"1em":u,u=l.pixelLeft+"px",l.left=i,a&&(o.left=a)),""===u?"auto":u});function on(e,t,n){var r=Vt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function an(e,t,n,r,i){var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;for(;4>o;o+=2)"margin"===n&&(a+=b.css(e,n+Zt[o],!0,i)),r?("content"===n&&(a-=b.css(e,"padding"+Zt[o],!0,i)),"margin"!==n&&(a-=b.css(e,"border"+Zt[o]+"Width",!0,i))):(a+=b.css(e,"padding"+Zt[o],!0,i),"padding"!==n&&(a+=b.css(e,"border"+Zt[o]+"Width",!0,i)));return a}function sn(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=Rt(e),a=b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=Wt(e,t,o),(0>i||null==i)&&(i=e.style[t]),Yt.test(i))return i;r=a&&(b.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+an(e,t,n||(a?"border":"content"),r,o)+"px"}function un(e){var t=o,n=Gt[e];return n||(n=ln(e,t),"none"!==n&&n||(Pt=(Pt||b("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(Pt[0].contentWindow||Pt[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),n=ln(e,t),Pt.detach()),Gt[e]=n),n}function ln(e,t){var n=b(t.createElement(e)).appendTo(t.body),r=b.css(n[0],"display");return n.remove(),r}b.each(["height","width"],function(e,n){b.cssHooks[n]={get:function(e,r,i){return r?0===e.offsetWidth&&Xt.test(b.css(e,"display"))?b.swap(e,Qt,function(){return sn(e,n,i)}):sn(e,n,i):t},set:function(e,t,r){var i=r&&Rt(e);return on(e,t,r?an(e,n,r,b.support.boxSizing&&"border-box"===b.css(e,"boxSizing",!1,i),i):0)}}}),b.support.opacity||(b.cssHooks.opacity={get:function(e,t){return It.test((t&&e.currentStyle?e.currentStyle.filter:e.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":t?"1":""},set:function(e,t){var n=e.style,r=e.currentStyle,i=b.isNumeric(t)?"alpha(opacity="+100*t+")":"",o=r&&r.filter||n.filter||"";n.zoom=1,(t>=1||""===t)&&""===b.trim(o.replace($t,""))&&n.removeAttribute&&(n.removeAttribute("filter"),""===t||r&&!r.filter)||(n.filter=$t.test(o)?o.replace($t,i):o+" "+i)}}),b(function(){b.support.reliableMarginRight||(b.cssHooks.marginRight={get:function(e,n){return n?b.swap(e,{display:"inline-block"},Wt,[e,"marginRight"]):t}}),!b.support.pixelPosition&&b.fn.position&&b.each(["top","left"],function(e,n){b.cssHooks[n]={get:function(e,r){return r?(r=Wt(e,n),Yt.test(r)?b(e).position()[n]+"px":r):t}}})}),b.expr&&b.expr.filters&&(b.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight||!b.support.reliableHiddenOffsets&&"none"===(e.style&&e.style.display||b.css(e,"display"))},b.expr.filters.visible=function(e){return!b.expr.filters.hidden(e)}),b.each({margin:"",padding:"",border:"Width"},function(e,t){b.cssHooks[e+t]={expand:function(n){var r=0,i={},o="string"==typeof n?n.split(" "):[n];for(;4>r;r++)i[e+Zt[r]+t]=o[r]||o[r-2]||o[0];return i}},Ut.test(e)||(b.cssHooks[e+t].set=on)});var cn=/%20/g,pn=/\[\]$/,fn=/\r?\n/g,dn=/^(?:submit|button|image|reset|file)$/i,hn=/^(?:input|select|textarea|keygen)/i;b.fn.extend({serialize:function(){return b.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=b.prop(this,"elements");return e?b.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!b(this).is(":disabled")&&hn.test(this.nodeName)&&!dn.test(e)&&(this.checked||!Nt.test(e))}).map(function(e,t){var n=b(this).val();return null==n?null:b.isArray(n)?b.map(n,function(e){return{name:t.name,value:e.replace(fn,"\r\n")}}):{name:t.name,value:n.replace(fn,"\r\n")}}).get()}}),b.param=function(e,n){var r,i=[],o=function(e,t){t=b.isFunction(t)?t():null==t?"":t,i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(n===t&&(n=b.ajaxSettings&&b.ajaxSettings.traditional),b.isArray(e)||e.jquery&&!b.isPlainObject(e))b.each(e,function(){o(this.name,this.value)});else for(r in e)gn(r,e[r],n,o);return i.join("&").replace(cn,"+")};function gn(e,t,n,r){var i;if(b.isArray(t))b.each(t,function(t,i){n||pn.test(e)?r(e,i):gn(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==b.type(t))r(e,t);else for(i in t)gn(e+"["+i+"]",t[i],n,r)}b.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){b.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),b.fn.hover=function(e,t){return this.mouseenter(e).mouseleave(t||e)};var mn,yn,vn=b.now(),bn=/\?/,xn=/#.*$/,wn=/([?&])_=[^&]*/,Tn=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Nn=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Cn=/^(?:GET|HEAD)$/,kn=/^\/\//,En=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,Sn=b.fn.load,An={},jn={},Dn="*/".concat("*");try{yn=a.href}catch(Ln){yn=o.createElement("a"),yn.href="",yn=yn.href}mn=En.exec(yn.toLowerCase())||[];function Hn(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(w)||[];if(b.isFunction(n))while(r=o[i++])"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function qn(e,n,r,i){var o={},a=e===jn;function s(u){var l;return o[u]=!0,b.each(e[u]||[],function(e,u){var c=u(n,r,i);return"string"!=typeof c||a||o[c]?a?!(l=c):t:(n.dataTypes.unshift(c),s(c),!1)}),l}return s(n.dataTypes[0])||!o["*"]&&s("*")}function Mn(e,n){var r,i,o=b.ajaxSettings.flatOptions||{};for(i in n)n[i]!==t&&((o[i]?e:r||(r={}))[i]=n[i]);return r&&b.extend(!0,e,r),e}b.fn.load=function(e,n,r){if("string"!=typeof e&&Sn)return Sn.apply(this,arguments);var i,o,a,s=this,u=e.indexOf(" ");return u>=0&&(i=e.slice(u,e.length),e=e.slice(0,u)),b.isFunction(n)?(r=n,n=t):n&&"object"==typeof n&&(a="POST"),s.length>0&&b.ajax({url:e,type:a,dataType:"html",data:n}).done(function(e){o=arguments,s.html(i?b("<div>").append(b.parseHTML(e)).find(i):e)}).complete(r&&function(e,t){s.each(r,o||[e.responseText,t,e])}),this},b.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){b.fn[t]=function(e){return this.on(t,e)}}),b.each(["get","post"],function(e,n){b[n]=function(e,r,i,o){return b.isFunction(r)&&(o=o||i,i=r,r=t),b.ajax({url:e,type:n,dataType:o,data:r,success:i})}}),b.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:yn,type:"GET",isLocal:Nn.test(mn[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Dn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":e.String,"text html":!0,"text json":b.parseJSON,"text xml":b.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Mn(Mn(e,b.ajaxSettings),t):Mn(b.ajaxSettings,e)},ajaxPrefilter:Hn(An),ajaxTransport:Hn(jn),ajax:function(e,n){"object"==typeof e&&(n=e,e=t),n=n||{};var r,i,o,a,s,u,l,c,p=b.ajaxSetup({},n),f=p.context||p,d=p.context&&(f.nodeType||f.jquery)?b(f):b.event,h=b.Deferred(),g=b.Callbacks("once memory"),m=p.statusCode||{},y={},v={},x=0,T="canceled",N={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!c){c={};while(t=Tn.exec(a))c[t[1].toLowerCase()]=t[2]}t=c[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?a:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return x||(e=v[n]=v[n]||e,y[e]=t),this},overrideMimeType:function(e){return x||(p.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>x)for(t in e)m[t]=[m[t],e[t]];else N.always(e[N.status]);return this},abort:function(e){var t=e||T;return l&&l.abort(t),k(0,t),this}};if(h.promise(N).complete=g.add,N.success=N.done,N.error=N.fail,p.url=((e||p.url||yn)+"").replace(xn,"").replace(kn,mn[1]+"//"),p.type=n.method||n.type||p.method||p.type,p.dataTypes=b.trim(p.dataType||"*").toLowerCase().match(w)||[""],null==p.crossDomain&&(r=En.exec(p.url.toLowerCase()),p.crossDomain=!(!r||r[1]===mn[1]&&r[2]===mn[2]&&(r[3]||("http:"===r[1]?80:443))==(mn[3]||("http:"===mn[1]?80:443)))),p.data&&p.processData&&"string"!=typeof p.data&&(p.data=b.param(p.data,p.traditional)),qn(An,p,n,N),2===x)return N;u=p.global,u&&0===b.active++&&b.event.trigger("ajaxStart"),p.type=p.type.toUpperCase(),p.hasContent=!Cn.test(p.type),o=p.url,p.hasContent||(p.data&&(o=p.url+=(bn.test(o)?"&":"?")+p.data,delete p.data),p.cache===!1&&(p.url=wn.test(o)?o.replace(wn,"$1_="+vn++):o+(bn.test(o)?"&":"?")+"_="+vn++)),p.ifModified&&(b.lastModified[o]&&N.setRequestHeader("If-Modified-Since",b.lastModified[o]),b.etag[o]&&N.setRequestHeader("If-None-Match",b.etag[o])),(p.data&&p.hasContent&&p.contentType!==!1||n.contentType)&&N.setRequestHeader("Content-Type",p.contentType),N.setRequestHeader("Accept",p.dataTypes[0]&&p.accepts[p.dataTypes[0]]?p.accepts[p.dataTypes[0]]+("*"!==p.dataTypes[0]?", "+Dn+"; q=0.01":""):p.accepts["*"]);for(i in p.headers)N.setRequestHeader(i,p.headers[i]);if(p.beforeSend&&(p.beforeSend.call(f,N,p)===!1||2===x))return N.abort();T="abort";for(i in{success:1,error:1,complete:1})N[i](p[i]);if(l=qn(jn,p,n,N)){N.readyState=1,u&&d.trigger("ajaxSend",[N,p]),p.async&&p.timeout>0&&(s=setTimeout(function(){N.abort("timeout")},p.timeout));try{x=1,l.send(y,k)}catch(C){if(!(2>x))throw C;k(-1,C)}}else k(-1,"No Transport");function k(e,n,r,i){var c,y,v,w,T,C=n;2!==x&&(x=2,s&&clearTimeout(s),l=t,a=i||"",N.readyState=e>0?4:0,r&&(w=_n(p,N,r)),e>=200&&300>e||304===e?(p.ifModified&&(T=N.getResponseHeader("Last-Modified"),T&&(b.lastModified[o]=T),T=N.getResponseHeader("etag"),T&&(b.etag[o]=T)),204===e?(c=!0,C="nocontent"):304===e?(c=!0,C="notmodified"):(c=Fn(p,w),C=c.state,y=c.data,v=c.error,c=!v)):(v=C,(e||!C)&&(C="error",0>e&&(e=0))),N.status=e,N.statusText=(n||C)+"",c?h.resolveWith(f,[y,C,N]):h.rejectWith(f,[N,C,v]),N.statusCode(m),m=t,u&&d.trigger(c?"ajaxSuccess":"ajaxError",[N,p,c?y:v]),g.fireWith(f,[N,C]),u&&(d.trigger("ajaxComplete",[N,p]),--b.active||b.event.trigger("ajaxStop")))}return N},getScript:function(e,n){return b.get(e,t,n,"script")},getJSON:function(e,t,n){return b.get(e,t,n,"json")}});function _n(e,n,r){var i,o,a,s,u=e.contents,l=e.dataTypes,c=e.responseFields;for(s in c)s in r&&(n[c[s]]=r[s]);while("*"===l[0])l.shift(),o===t&&(o=e.mimeType||n.getResponseHeader("Content-Type"));if(o)for(s in u)if(u[s]&&u[s].test(o)){l.unshift(s);break}if(l[0]in r)a=l[0];else{for(s in r){if(!l[0]||e.converters[s+" "+l[0]]){a=s;break}i||(i=s)}a=a||i}return a?(a!==l[0]&&l.unshift(a),r[a]):t}function Fn(e,t){var n,r,i,o,a={},s=0,u=e.dataTypes.slice(),l=u[0];if(e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u[1])for(i in e.converters)a[i.toLowerCase()]=e.converters[i];for(;r=u[++s];)if("*"!==r){if("*"!==l&&l!==r){if(i=a[l+" "+r]||a["* "+r],!i)for(n in a)if(o=n.split(" "),o[1]===r&&(i=a[l+" "+o[0]]||a["* "+o[0]])){i===!0?i=a[n]:a[n]!==!0&&(r=o[0],u.splice(s--,0,r));break}if(i!==!0)if(i&&e["throws"])t=i(t);else try{t=i(t)}catch(c){return{state:"parsererror",error:i?c:"No conversion from "+l+" to "+r}}}l=r}return{state:"success",data:t}}b.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return b.globalEval(e),e}}}),b.ajaxPrefilter("script",function(e){e.cache===t&&(e.cache=!1),e.crossDomain&&(e.type="GET",e.global=!1)}),b.ajaxTransport("script",function(e){if(e.crossDomain){var n,r=o.head||b("head")[0]||o.documentElement;return{send:function(t,i){n=o.createElement("script"),n.async=!0,e.scriptCharset&&(n.charset=e.scriptCharset),n.src=e.url,n.onload=n.onreadystatechange=function(e,t){(t||!n.readyState||/loaded|complete/.test(n.readyState))&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),n=null,t||i(200,"success"))},r.insertBefore(n,r.firstChild)},abort:function(){n&&n.onload(t,!0)}}}});var On=[],Bn=/(=)\?(?=&|$)|\?\?/;b.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=On.pop()||b.expando+"_"+vn++;return this[e]=!0,e}}),b.ajaxPrefilter("json jsonp",function(n,r,i){var o,a,s,u=n.jsonp!==!1&&(Bn.test(n.url)?"url":"string"==typeof n.data&&!(n.contentType||"").indexOf("application/x-www-form-urlencoded")&&Bn.test(n.data)&&"data");return u||"jsonp"===n.dataTypes[0]?(o=n.jsonpCallback=b.isFunction(n.jsonpCallback)?n.jsonpCallback():n.jsonpCallback,u?n[u]=n[u].replace(Bn,"$1"+o):n.jsonp!==!1&&(n.url+=(bn.test(n.url)?"&":"?")+n.jsonp+"="+o),n.converters["script json"]=function(){return s||b.error(o+" was not called"),s[0]},n.dataTypes[0]="json",a=e[o],e[o]=function(){s=arguments},i.always(function(){e[o]=a,n[o]&&(n.jsonpCallback=r.jsonpCallback,On.push(o)),s&&b.isFunction(a)&&a(s[0]),s=a=t}),"script"):t});var Pn,Rn,Wn=0,$n=e.ActiveXObject&&function(){var e;for(e in Pn)Pn[e](t,!0)};function In(){try{return new e.XMLHttpRequest}catch(t){}}function zn(){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}b.ajaxSettings.xhr=e.ActiveXObject?function(){return!this.isLocal&&In()||zn()}:In,Rn=b.ajaxSettings.xhr(),b.support.cors=!!Rn&&"withCredentials"in Rn,Rn=b.support.ajax=!!Rn,Rn&&b.ajaxTransport(function(n){if(!n.crossDomain||b.support.cors){var r;return{send:function(i,o){var a,s,u=n.xhr();if(n.username?u.open(n.type,n.url,n.async,n.username,n.password):u.open(n.type,n.url,n.async),n.xhrFields)for(s in n.xhrFields)u[s]=n.xhrFields[s];n.mimeType&&u.overrideMimeType&&u.overrideMimeType(n.mimeType),n.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");try{for(s in i)u.setRequestHeader(s,i[s])}catch(l){}u.send(n.hasContent&&n.data||null),r=function(e,i){var s,l,c,p;try{if(r&&(i||4===u.readyState))if(r=t,a&&(u.onreadystatechange=b.noop,$n&&delete Pn[a]),i)4!==u.readyState&&u.abort();else{p={},s=u.status,l=u.getAllResponseHeaders(),"string"==typeof u.responseText&&(p.text=u.responseText);try{c=u.statusText}catch(f){c=""}s||!n.isLocal||n.crossDomain?1223===s&&(s=204):s=p.text?200:404}}catch(d){i||o(-1,d)}p&&o(s,c,p,l)},n.async?4===u.readyState?setTimeout(r):(a=++Wn,$n&&(Pn||(Pn={},b(e).unload($n)),Pn[a]=r),u.onreadystatechange=r):r()},abort:function(){r&&r(t,!0)}}}});var Xn,Un,Vn=/^(?:toggle|show|hide)$/,Yn=RegExp("^(?:([+-])=|)("+x+")([a-z%]*)$","i"),Jn=/queueHooks$/,Gn=[nr],Qn={"*":[function(e,t){var n,r,i=this.createTween(e,t),o=Yn.exec(t),a=i.cur(),s=+a||0,u=1,l=20;if(o){if(n=+o[2],r=o[3]||(b.cssNumber[e]?"":"px"),"px"!==r&&s){s=b.css(i.elem,e,!0)||n||1;do u=u||".5",s/=u,b.style(i.elem,e,s+r);while(u!==(u=i.cur()/a)&&1!==u&&--l)}i.unit=r,i.start=s,i.end=o[1]?s+(o[1]+1)*n:n}return i}]};function Kn(){return setTimeout(function(){Xn=t}),Xn=b.now()}function Zn(e,t){b.each(t,function(t,n){var r=(Qn[t]||[]).concat(Qn["*"]),i=0,o=r.length;for(;o>i;i++)if(r[i].call(e,t,n))return})}function er(e,t,n){var r,i,o=0,a=Gn.length,s=b.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;var t=Xn||Kn(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,o=1-r,a=0,u=l.tweens.length;for(;u>a;a++)l.tweens[a].run(o);return s.notifyWith(e,[l,o,n]),1>o&&u?n:(s.resolveWith(e,[l]),!1)},l=s.promise({elem:e,props:b.extend({},t),opts:b.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Xn||Kn(),duration:n.duration,tweens:[],createTween:function(t,n){var r=b.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)l.tweens[n].run(1);return t?s.resolveWith(e,[l,t]):s.rejectWith(e,[l,t]),this}}),c=l.props;for(tr(c,l.opts.specialEasing);a>o;o++)if(r=Gn[o].call(l,e,c,l.opts))return r;return Zn(l,c),b.isFunction(l.opts.start)&&l.opts.start.call(e,l),b.fx.timer(b.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function tr(e,t){var n,r,i,o,a;for(i in e)if(r=b.camelCase(i),o=t[r],n=e[i],b.isArray(n)&&(o=n[1],n=e[i]=n[0]),i!==r&&(e[r]=n,delete e[i]),a=b.cssHooks[r],a&&"expand"in a){n=a.expand(n),delete e[r];for(i in n)i in e||(e[i]=n[i],t[i]=o)}else t[r]=o}b.Animation=b.extend(er,{tweener:function(e,t){b.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;i>r;r++)n=e[r],Qn[n]=Qn[n]||[],Qn[n].unshift(t)},prefilter:function(e,t){t?Gn.unshift(e):Gn.push(e)}});function nr(e,t,n){var r,i,o,a,s,u,l,c,p,f=this,d=e.style,h={},g=[],m=e.nodeType&&nn(e);n.queue||(c=b._queueHooks(e,"fx"),null==c.unqueued&&(c.unqueued=0,p=c.empty.fire,c.empty.fire=function(){c.unqueued||p()}),c.unqueued++,f.always(function(){f.always(function(){c.unqueued--,b.queue(e,"fx").length||c.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[d.overflow,d.overflowX,d.overflowY],"inline"===b.css(e,"display")&&"none"===b.css(e,"float")&&(b.support.inlineBlockNeedsLayout&&"inline"!==un(e.nodeName)?d.zoom=1:d.display="inline-block")),n.overflow&&(d.overflow="hidden",b.support.shrinkWrapBlocks||f.always(function(){d.overflow=n.overflow[0],d.overflowX=n.overflow[1],d.overflowY=n.overflow[2]}));for(i in t)if(a=t[i],Vn.exec(a)){if(delete t[i],u=u||"toggle"===a,a===(m?"hide":"show"))continue;g.push(i)}if(o=g.length){s=b._data(e,"fxshow")||b._data(e,"fxshow",{}),"hidden"in s&&(m=s.hidden),u&&(s.hidden=!m),m?b(e).show():f.done(function(){b(e).hide()}),f.done(function(){var t;b._removeData(e,"fxshow");for(t in h)b.style(e,t,h[t])});for(i=0;o>i;i++)r=g[i],l=f.createTween(r,m?s[r]:0),h[r]=s[r]||b.style(e,r),r in s||(s[r]=l.start,m&&(l.end=l.start,l.start="width"===r||"height"===r?1:0))}}function rr(e,t,n,r,i){return new rr.prototype.init(e,t,n,r,i)}b.Tween=rr,rr.prototype={constructor:rr,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(b.cssNumber[n]?"":"px")},cur:function(){var e=rr.propHooks[this.prop];return e&&e.get?e.get(this):rr.propHooks._default.get(this)},run:function(e){var t,n=rr.propHooks[this.prop];return this.pos=t=this.options.duration?b.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):rr.propHooks._default.set(this),this}},rr.prototype.init.prototype=rr.prototype,rr.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=b.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){b.fx.step[e.prop]?b.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[b.cssProps[e.prop]]||b.cssHooks[e.prop])?b.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},rr.propHooks.scrollTop=rr.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},b.each(["toggle","show","hide"],function(e,t){var n=b.fn[t];b.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(ir(t,!0),e,r,i)}}),b.fn.extend({fadeTo:function(e,t,n,r){return this.filter(nn).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=b.isEmptyObject(e),o=b.speed(t,n,r),a=function(){var t=er(this,b.extend({},e),o);a.finish=function(){t.stop(!0)},(i||b._data(this,"finish"))&&t.stop(!0)};return a.finish=a,i||o.queue===!1?this.each(a):this.queue(o.queue,a)},stop:function(e,n,r){var i=function(e){var t=e.stop;delete e.stop,t(r)};return"string"!=typeof e&&(r=n,n=e,e=t),n&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,n=null!=e&&e+"queueHooks",o=b.timers,a=b._data(this);if(n)a[n]&&a[n].stop&&i(a[n]);else for(n in a)a[n]&&a[n].stop&&Jn.test(n)&&i(a[n]);for(n=o.length;n--;)o[n].elem!==this||null!=e&&o[n].queue!==e||(o[n].anim.stop(r),t=!1,o.splice(n,1));(t||!r)&&b.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=b._data(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=b.timers,a=r?r.length:0;for(n.finish=!0,b.queue(this,e,[]),i&&i.cur&&i.cur.finish&&i.cur.finish.call(this),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;a>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}});function ir(e,t){var n,r={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)n=Zt[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}b.each({slideDown:ir("show"),slideUp:ir("hide"),slideToggle:ir("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){b.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),b.speed=function(e,t,n){var r=e&&"object"==typeof e?b.extend({},e):{complete:n||!n&&t||b.isFunction(e)&&e,duration:e,easing:n&&t||t&&!b.isFunction(t)&&t};return r.duration=b.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in b.fx.speeds?b.fx.speeds[r.duration]:b.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){b.isFunction(r.old)&&r.old.call(this),r.queue&&b.dequeue(this,r.queue)},r},b.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},b.timers=[],b.fx=rr.prototype.init,b.fx.tick=function(){var e,n=b.timers,r=0;for(Xn=b.now();n.length>r;r++)e=n[r],e()||n[r]!==e||n.splice(r--,1);n.length||b.fx.stop(),Xn=t},b.fx.timer=function(e){e()&&b.timers.push(e)&&b.fx.start()},b.fx.interval=13,b.fx.start=function(){Un||(Un=setInterval(b.fx.tick,b.fx.interval))},b.fx.stop=function(){clearInterval(Un),Un=null},b.fx.speeds={slow:600,fast:200,_default:400},b.fx.step={},b.expr&&b.expr.filters&&(b.expr.filters.animated=function(e){return b.grep(b.timers,function(t){return e===t.elem}).length}),b.fn.offset=function(e){if(arguments.length)return e===t?this:this.each(function(t){b.offset.setOffset(this,e,t)});var n,r,o={top:0,left:0},a=this[0],s=a&&a.ownerDocument;if(s)return n=s.documentElement,b.contains(n,a)?(typeof a.getBoundingClientRect!==i&&(o=a.getBoundingClientRect()),r=or(s),{top:o.top+(r.pageYOffset||n.scrollTop)-(n.clientTop||0),left:o.left+(r.pageXOffset||n.scrollLeft)-(n.clientLeft||0)}):o},b.offset={setOffset:function(e,t,n){var r=b.css(e,"position");"static"===r&&(e.style.position="relative");var i=b(e),o=i.offset(),a=b.css(e,"top"),s=b.css(e,"left"),u=("absolute"===r||"fixed"===r)&&b.inArray("auto",[a,s])>-1,l={},c={},p,f;u?(c=i.position(),p=c.top,f=c.left):(p=parseFloat(a)||0,f=parseFloat(s)||0),b.isFunction(t)&&(t=t.call(e,n,o)),null!=t.top&&(l.top=t.top-o.top+p),null!=t.left&&(l.left=t.left-o.left+f),"using"in t?t.using.call(e,l):i.css(l)}},b.fn.extend({position:function(){if(this[0]){var e,t,n={top:0,left:0},r=this[0];return"fixed"===b.css(r,"position")?t=r.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),b.nodeName(e[0],"html")||(n=e.offset()),n.top+=b.css(e[0],"borderTopWidth",!0),n.left+=b.css(e[0],"borderLeftWidth",!0)),{top:t.top-n.top-b.css(r,"marginTop",!0),left:t.left-n.left-b.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||o.documentElement;while(e&&!b.nodeName(e,"html")&&"static"===b.css(e,"position"))e=e.offsetParent;return e||o.documentElement})}}),b.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,n){var r=/Y/.test(n);b.fn[e]=function(i){return b.access(this,function(e,i,o){var a=or(e);return o===t?a?n in a?a[n]:a.document.documentElement[i]:e[i]:(a?a.scrollTo(r?b(a).scrollLeft():o,r?o:b(a).scrollTop()):e[i]=o,t)},e,i,arguments.length,null)}});function or(e){return b.isWindow(e)?e:9===e.nodeType?e.defaultView||e.parentWindow:!1}b.each({Height:"height",Width:"width"},function(e,n){b.each({padding:"inner"+e,content:n,"":"outer"+e},function(r,i){b.fn[i]=function(i,o){var a=arguments.length&&(r||"boolean"!=typeof i),s=r||(i===!0||o===!0?"margin":"border");return b.access(this,function(n,r,i){var o;return b.isWindow(n)?n.document.documentElement["client"+e]:9===n.nodeType?(o=n.documentElement,Math.max(n.body["scroll"+e],o["scroll"+e],n.body["offset"+e],o["offset"+e],o["client"+e])):i===t?b.css(n,r,s):b.style(n,r,i,s)},n,a?i:t,a,null)}})}),e.jQuery=e.$=b,"function"==typeof define&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return b})})(window);
//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);

//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
